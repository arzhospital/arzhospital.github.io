<html><head><script type="text/javascript" src="data:text/javascript;base64,aWYodHlwZW9mKGdsb2JhbCkhPT0idW5kZWZpbmVkIikgZ2xvYmFsLkZsYXR0ZWQgPSByZXF1aXJlKCdmbGF0dGVkJyk7CgpsZXQgX19nID0gdHlwZW9mKGdsb2JhbCk9PT0idW5kZWZpbmVkIj93aW5kb3c6Z2xvYmFsOwoKbGV0IHNhbGVzbm93ID0gewogICAgX19zY3JpcHQ6IHsKICAgICAgICBEYXRlOiBuZXcgRGF0ZSgnMjAyMy0wNy0xOFQwMzozNTo1MC4wMDBaJyksCiAgICB9LAogICAgX19zZWNyZXQ6IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikhPT0idW5kZWZpbmVkIik/dGhpcy5fYXRvYjoodHlwZW9mKF9GckVNRCkhPT0idW5kZWZpbmVkIj9fRnJFTUQuX2F0b2I6YXRvYikpKGBJalJtWW1FMU1UQTVMVEU0WkRBdE5HSXlOaTA0TVRJeUxXTXdaR1EzTkRBeE5UZGtOU0k9YCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSksCiAgICBfX21haW5DbGFzczogJ1VzZXInLAoKICAgIGhyZWZzOiBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShgVzNzaWJHbGlJam9pVTFGTVNsTWlMQ0p6Y21NaU9sc2lhSFIwY0hNNkx5OWpaRzVxY3k1amJHOTFaR1pzWVhKbExtTnZiUzloYW1GNEwyeHBZbk12YzNGc0xtcHpMekV1T0M0d0wzTnhiQzEzWVhOdExtMXBiaTVxY3lKZExDSmpZV05vWlNJNmRISjFaU3dpYkc5aFpDSTZJbUZ6ZVc1aklHMXZaSFZzWlhNZ1BUNGdlMXh5WEc1Y2RGeDBkMmx1Wkc5M0xsTlJUQ0E5SUdGM1lXbDBJR2x1YVhSVGNXeEtjeWg3WEhKY2JseDBYSFJjZEd4dlkyRjBaVVpwYkdVNklHWnBiR1VnUFQ0Z1lHaDBkSEJ6T2k4dlkyUnVhbk11WTJ4dmRXUm1iR0Z5WlM1amIyMHZZV3BoZUM5c2FXSnpMM054YkM1cWN5OHhMamd1TUM4a2UyWnBiR1Y5WUZ4eVhHNWNkRngwZlNrN1hISmNibHgwZlNJc0luUnZiMnh6SWpwYklsTnhiRVJDSWwwc0luSmxjWFZwY21WeklqcGJYWDBzZXlKc2FXSWlPaUprYjNRdGIySnFaV04wSWl3aWMzSmpJam9pYUhSMGNITTZMeTlqWkc0dWFuTmtaV3hwZG5JdWJtVjBMMjV3YlM5a2IzUXRiMkpxWldOMFFESXVNUzQwTDJsdVpHVjRMbTFwYmk1cWN5SXNJbU5oWTJobElqcDBjblZsTENKMGIyOXNjeUk2VzEwc0luSmxjWFZwY21WeklqcGJYWDBzZXlKc2FXSWlPaUpCZUdsdmN5SXNJbk55WXlJNkltaDBkSEJ6T2k4dmRXNXdhMmN1WTI5dEwyRjRhVzl6TDJScGMzUXZZWGhwYjNNdWJXbHVMbXB6SWl3aVkyRmphR1VpT25SeWRXVXNJblJ2YjJ4eklqcGJYU3dpY21WeGRXbHlaWE1pT2x0ZGZWMD1gKSwgKGtleSx2YWx1ZSk9PntpZih0eXBlb2YodmFsdWUpPT09InN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKT4wKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7IHJldHVybiB2YWx1ZTt9KSwKCgogICAgX19Ub29sczogWwogICAgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSE9PSJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSE9PSJ1bmRlZmluZWQiKT90aGlzLl9hdG9iOih0eXBlb2YoX0ZyRU1EKSE9PSJ1bmRlZmluZWQiP19GckVNRC5fYXRvYjphdG9iKSkoYGV5SjBlWEJsSWpwN0ltNWhiV1VpT2lKVGNXeEVRaUlzSW5SNWNHVmZUV0Z3Y0dsdVozTWlPbHQ3SW1GamRHbDJaU0k2Wm1Gc2MyVXNJbU52Ym5SbGVIUWlPaUlvWEZ4aVhGeDNLbHhjWWlraUxDSmpiR0Z6YzA1aGJXVWlPaUlvWEZ4aVhGeDNLbHhjWWlraUxDSnpiM1Z5WTJVaU9pSW9YRnhpWEZ4M0tseGNZaWtpTENKMFlYSm5aWFFpT2lJa01TSXNJbVZ1WVdKc1pXUWlPblJ5ZFdVc0luUjVjR1VpT25zaWJtRnRaU0k2SWxOeGJFUkNJbjE5WFN3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTd2lkRzl2YkY5RGIyNW1hV2R6SWpwYmV5SnVZVzFsSWpvaVpHRjBZV0poYzJVaUxDSjJZV3gxWlNJNklsd2lPbTFsYlc5eWVUcGNJaUlzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaWMyVnlkbVZ5SWl3aWRtRnNkV1VpT2lKY0lteHZZMkZzYUc5emRGd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKMWMyVnlibUZ0WlNJc0luWmhiSFZsSWpvaVhDSnliMjkwWENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbkJoYzNOM2IzSmtJaXdpZG1Gc2RXVWlPaUpjSW5KdmIzUmNJaUlzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaVkzSmxZWFJsSWl3aWRtRnNkV1VpT2lJeUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUpUZVc1alJXNTBhWFI1UVhSMGNtbGlkWFJsY3lJc0luWmhiSFZsSWpvaWRISjFaU0lzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaVUzbHVZMVI1Y0dWa1FYUjBjbWxpZFhSbGN5SXNJblpoYkhWbElqb2lkSEoxWlNJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2lkSGx3WlNJc0luWmhiSFZsSWpvaVhDSnpjV3hwZEdWY0lpSXNJbTV2WkdVaU9uc2lZMjlrWlNJNklqSmxaVGhqT0RnNE0yRmxOQ0lzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZabUZzYzJVc0luUjVjR1VpT25zaWJtRnRaU0k2SWs1dlpHVktVeUo5Zlgwc2V5SnVZVzFsSWpvaWRIbHdaU0lzSW5aaGJIVmxJam9pWENKemNXeHBkR1ZjSWlJc0ltNXZaR1VpT25zaVkyOWtaU0k2SW1VNFpHVXdObVV6WldSak5EUXpZV1U1WkdabE1XUmxOV1ZqTlRKaE5HSm1JaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcG1ZV3h6WlN3aWRIbHdaU0k2ZXlKdVlXMWxJam9pVG05a1pVcFRJbjE5ZlN4N0ltNWhiV1VpT2lKMGVYQmxJaXdpZG1Gc2RXVWlPaUpjSW5OeGJHbDBaVndpSW4xZExDSnVZVzFsSWpvaVUzRnNSRUlpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdVc0luUnZiMnhmVFdGd2NHbHVaM01pT2x0ZGZRPT1gKSwgKGtleSx2YWx1ZSk9PntpZih0eXBlb2YodmFsdWUpPT09InN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKT4wKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7IHJldHVybiB2YWx1ZTt9KSxKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShgZXlKMGVYQmxJanA3SW01aGJXVWlPaUpIYVhSSWRXSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1VzSW5SNWNHVmZUV0Z3Y0dsdVozTWlPbHRkZlN3aWRHOXZiRjlEYjI1bWFXZHpJanBiZXlKdVlXMWxJam9pY21Wd2IzTnBkRzl5ZVNJc0luWmhiSFZsSWpvaVhDSmhjbnBvYjNOd2FYUmhiQzVuYVhSb2RXSXVhVzljSWlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2liM2R1WlhJaUxDSjJZV3gxWlNJNklsd2lZWEo2YUc5emNHbDBZV3hjSWlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2lkWEpzSWl3aWRtRnNkV1VpT2lKY0ltaDBkSEJ6T2k4dllYQnBMbWRwZEdoMVlpNWpiMjB2Y21Wd2IzTXZlM3R2ZDI1bGNuMTlMM3Q3Y21Wd2IzTnBkRzl5ZVgxOUwyTnZiblJsYm5Sekwxd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKdllYVjBhQzVoWTJObGMzTmZkRzlyWlc0aUxDSjJZV3gxWlNJNklsd2laMmwwYUhWaVgzQmhkRjh4TVVGTVJGTlZXbEV3VjAwMlluZDFUa2xPVFVJNFgxcHhURmhHTWxCWk56Rk9ZM0pIV1dsSVpYaFVZVnBTY0hCeE5XcEtla2w0WlhOV2RXbHFaV1pWTm5CTVJGcFhSRlEyUms1c1JFWjJNRGxvWENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbU55WldGMFpTSXNJblpoYkhWbElqb2lNaUlzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaVUzbHVZMFZ1ZEdsMGVVRjBkSEpwWW5WMFpYTWlMQ0oyWVd4MVpTSTZJblJ5ZFdVaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbE41Ym1OVWVYQmxaRUYwZEhKcFluVjBaWE1pTENKMllXeDFaU0k2SW1aaGJITmxJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlYwc0ltNWhiV1VpT2lKSGFYUklkV0lpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdVc0luUnZiMnhmVFdGd2NHbHVaM01pT2x0ZGZRPT1gKSwgKGtleSx2YWx1ZSk9PntpZih0eXBlb2YodmFsdWUpPT09InN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKT4wKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7IHJldHVybiB2YWx1ZTt9KSwKICAgIF0sCgp9OwoKCgpkZWxldGUgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEk7CnNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJID0gY2xhc3MgR2VuZXJpY1NlcnZpY2VBUEkgewoJYXN5bmMgc2V0SW50ZXJ2YWwoZnVuLCBtaW51dGVzLCAuLi5hcmdzKSB7CgkJbGV0IGZOYW1lID0gZnVuLnRvU3RyaW5nKCkuc3BsaXQoJyknKVswXSArICcpJzsKCQl0cnkgewoJCQkvLyB0aGlzLl9fdGltZShgJHtmTmFtZX0uTG9vcGApOwoKCQkJdGhpcy5fX3RpbWUoYCR7Zk5hbWV9LkNhbGxgKTsKCQkJbGV0IHJldCA9IGF3YWl0IGZ1biguLi5hcmdzLmNvbmNhdChbbmV3IERhdGUoKV0pKTsKCgkJCXRoaXMubG9nKGB7Q2FsbDogYCArIHRoaXMuX190aW1lKGAke2ZOYW1lfS5DYWxsYCkgKyBgLCBMb29wOiBgICsgdGhpcy5fX3RpbWUoYCR7Zk5hbWV9Lkxvb3BgKSArICd9JywgJ3NldEludGVydmFsJywgZk5hbWUpOwoJCQlpZiAoIXJldCkgewoJCQkJdGhpcy5sb2coYGRpZCBub3QgcmV0dXJuIHRydWUsIGV4aXRpbmcgbG9vcGVyICgke3RoaXMuX190aW1lKGZOYW1lKX0pYCwgJ3NldEludGVydmFsJywgZk5hbWUpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codGhpcy5fX3RpbWUoZk5hbWUpLCAnc2V0SW50ZXJ2YWwnLCBmTmFtZSwgMiwgZXgpOwoJCQljb25zb2xlLnRyYWNlKCk7CgkJfQoJCWlmICghTnVtYmVyKG1pbnV0ZXMpKSB7CgkJCXRoaXMubG9nKHRoaXMuX190aW1lKGZOYW1lKSwgJ3NldEludGVydmFsJywgZk5hbWUsIDAsICJOb3QgcmVwZWF0aW5nLiBNaW51dGVzIGlzICIgKyBtaW51dGVzKTsKCQkJcmV0dXJuOwoJCX0KCQlhd2FpdCBuZXcgUHJvbWlzZShyID0+IHNldFRpbWVvdXQociwgbWludXRlcyAqIDYwICogMTAwMCkpOwoJCWF3YWl0IHRoaXMuc2V0SW50ZXJ2YWwoZnVuLCBtaW51dGVzLCAuLi5hcmdzKTsKCX0KCglhc3luYyBfZXhlY3V0ZShzY29wZSwgbSwgZlJvdXRlciwgZlNjcmlwdCwgb1BhcmFtcyA9IHt9KSB7CgkJbGV0IF9fYmVmb3JlUnVsZXMgPSBvUGFyYW1zLl9fYmVmb3JlUnVsZXMgfHwgW107CgkJbGV0IF9fYWZ0ZXJSdWxlcyA9IG9QYXJhbXMuX19hZnRlclJ1bGVzIHx8IFtdOwoJCWRlbGV0ZSBvUGFyYW1zLl9fYmVmb3JlUnVsZXM7CgkJZGVsZXRlIG9QYXJhbXMuX19hZnRlclJ1bGVzOwoKCQlfX2JlZm9yZVJ1bGVzLmNvbmNhdChfX2FmdGVyUnVsZXMpLmZvckVhY2gociA9PiByLlNjcmlwdCA9IHRoaXMucnVuU2NyaXB0KGBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgc2NvcGUsIG5vZGUke09iamVjdC5rZXlzKG9QYXJhbXMpLmxlbmd0aD8nLCAnOicnfSR7T2JqZWN0LmtleXMob1BhcmFtcykuam9pbignLCcpfSkgPT4geyR7ci5TY3JpcHR9fWApKTsKCgkJbGV0IGxQYXJhbXMgPSBPYmplY3QuZW50cmllcyhvUGFyYW1zKS5tYXAoeCA9PiB4WzFdKTsKCQlsZXQgcmVzdWx0cyA9IFtdOwoKCQlpZiAodGhpcy5EU0Nvbm5lY3QpIGF3YWl0IHRoaXMuRFNDb25uZWN0KCk7CgoJCWxldCBub2RlcyA9IFtdOwoJCWlmICghc2NvcGUuX25vZGUgfHwgIWZSb3V0ZXIpIHsKCQkJbm9kZXMucHVzaChudWxsKTsKCQl9IGVsc2UgewoJCQlpZiAoc2NvcGUuX25vZGUpIHsKCQkJCWlmIChhd2FpdCB0aGlzLl9TY3JpcHQoZlJvdXRlciwgbSwgJ1JvdXRlcicsIHNjb3BlLCBzY29wZS5fbm9kZSwgLi4ubFBhcmFtcykpIHsKCQkJCQlub2Rlcy5wdXNoKHNjb3BlLl9ub2RlKTsKCQkJCX0KCgkJCQl0aGlzLl9maXhOb2RlKHNjb3BlKTsKCgkJCQlpZiAoc2NvcGUuX25vZGUuX3BhcmVudCAmJiAoYXdhaXQgdGhpcy5fU2NyaXB0KGZSb3V0ZXIsIG0sICdSb3V0ZXInLCBzY29wZSwgc2NvcGUuX25vZGUuX3BhcmVudCwgLi4ubFBhcmFtcykpKSB7CgkJCQkJLy8gdGhpcy5sb2coc2NvcGUuX25vZGUuX3BhcmVudCwgJ19leGVjdXRlJywgJ2FkZGluZyBwYXJlbnQnKTsKCQkJCQlub2Rlcy5wdXNoKHNjb3BlLl9ub2RlLl9wYXJlbnQpOwoJCQkJfSBlbHNlIGlmIChzY29wZS5FdmVudCAmJiB0aGlzLkVudGl0eUNsYXNzLk5hbWUgIT09ICJFdmVudCIpIHsKCQkJCQkvLyBub2Rlcy5wdXNoKG5ldyBzY29wZS5Ob2RlKCkpOwoJCQkJfQoKCQkJCXRoaXMuX2ZpeE5vZGUoc2NvcGUpOwoJCQkJZm9yIGF3YWl0IChjb25zdCBjbiBvZiBzY29wZS5fbm9kZS5wYXJlbnRfTm9kZXMoKSkgewoJCQkJCWlmIChhd2FpdCB0aGlzLl9TY3JpcHQoZlJvdXRlciwgbSwgJ1NjcmlwdCcsIHNjb3BlLCBjbiwgLi4ubFBhcmFtcykpIHsKCQkJCQkJLy8gdGhpcy5sb2coY24sICdfZXhlY3V0ZScsICdhZGRpbmcgY2hpbGQgbm9kZScpOwoJCQkJCQlub2Rlcy5wdXNoKGNuKTsKCQkJCQl9CgkJCQl9CgkJCX0KCgkJCS8vIHJlbW92ZSBhbnkgbnVsbHMKCQkJbm9kZXMgPSBub2Rlcy5mbGF0KCkuZmlsdGVyKG4gPT4gbik7CgoJCQlpZiAoIW5vZGVzLmxlbmd0aCkgewoJCQkJbm9kZXMucHVzaChzY29wZS5fbm9kZSk7CgkJCX0KCgkJCS8vIHRoaXMubG9nKG5vZGVzLmxlbmd0aCwgJ19leGVjdXRlJywgJ25vZGVzLmxlbmd0aCcpOwoJCX0KCgkJZm9yIGF3YWl0IChjb25zdCBuIG9mIG5vZGVzKSB7CgkJCXRoaXMuX2ZpeE5vZGUoc2NvcGUpOwoJCQlsZXQgblJldCA9IG51bGw7CgkJCXRoaXMubG9nKGAke219IEAgJHtuPy5jb2RlKCkgfHwgJ0xPQ0FMJ31gLCAnX2V4ZWN1dGUnLCBgJHt0aGlzLkVudGl0eUNsYXNzLk5hbWV9YCk7CgkJCWlmICghbiB8fCB0aGlzLl9zYW1lTm9kZShzY29wZS5fbm9kZSwgbikpIHsKCQkJCS8vIGxvY2FsIHNjcmlwdAoJCQkJZm9yIGF3YWl0IChjb25zdCByIG9mIF9fYmVmb3JlUnVsZXMpIHsKCQkJCQlhd2FpdCB0aGlzLl9TY3JpcHQoci5TY3JpcHQsIG0sIHIuTmFtZSB8fCAnQmVmb3JlUnVsZScsIHNjb3BlLCBudWxsLCAuLi5sUGFyYW1zKTsKCQkJCX0KCgkJCQluUmV0ID0gYXdhaXQgdGhpcy5fU2NyaXB0KGZTY3JpcHQsIG0sICdTY3JpcHQnLCBzY29wZSwgLi4ubFBhcmFtcyk7CgoJCQkJZm9yIGF3YWl0IChjb25zdCByIG9mIF9fYWZ0ZXJSdWxlcykgewoJCQkJCWF3YWl0IHRoaXMuX1NjcmlwdChyLlNjcmlwdCwgbSwgci5OYW1lIHx8ICdBZnRlclJ1bGUnLCBzY29wZSwgbnVsbCwgLi4ubFBhcmFtcyk7CgkJCQl9CgkJCX0gZWxzZSB7CgkJCQluUmV0ID0gYXdhaXQgdGhpcy5faW52b2tlTm9kZShuLCBtLCBvUGFyYW1zKTsKCQkJfQoKCQkJcmVzdWx0cy5wdXNoKHsKCQkJCW5vZGU6IG4sCgkJCQlyZXQ6IG5SZXQKCQkJfSk7CgkJfQoJCS8vIHRoaXMubG9nKHJlc3VsdHMsICdfZXhlY3V0ZScsICdSZXN1bHRzJyk7CgoJCWxldCBlcnJvcnMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIucmV0ICYmIHIucmV0Ll9fZXhjZXB0aW9uKSAvKi5maWx0ZXIociA9PiAhdGhpcy5fc2FtZU5vZGUoc2NvcGUuX25vZGUsIHIubm9kZSkpKi8gLm1hcChyID0+ICh7CgkJCW5vZGU6IHIubm9kZSA/IHsKCQkJCWNvZGU6IHIubm9kZS5jb2RlKCksCgkJCQlhZGRyZXNzOiByLm5vZGUuYWRkcmVzcygpCgkJCX0gOiBudWxsLAoJCQlfX2V4Y2VwdGlvbjogci5yZXQuX19leGNlcHRpb24KCQl9KSk7CgkJaWYgKGVycm9ycy5sZW5ndGgpIHsKCQkJdGhpcy5sb2coIl9leGVjdXRlIiwgbSwgImVycm9ycyIsIDEsIGVycm9ycyk7CgkJfQoKCQlyZXR1cm4gcmVzdWx0czsKCX0KCglfc2FtZU5vZGUobjEsIG4yKSB7CgkJaWYgKHR5cGVvZihuMikgPT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZihuMSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCW4yID0gbjE7CgkJCW4xID0gdGhpczsKCQl9CgoJCWlmICghbjEgfHwgIW4yKSByZXR1cm4gZmFsc2U7CgoJCWlmICh0eXBlb2YobjEuX2NvZGUpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2YobjIuX2NvZGUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIGZhbHNlOwoKCQlpZiAobjEuY29uc3RydWN0b3IubmFtZSAhPSAiTm9kZSIgfHwgbjIuY29uc3RydWN0b3IubmFtZSAhPSAiTm9kZSIpIHsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJaWYgKG4xLl9jb2RlX2Nvb3AgfHwgbjIuX2NvZGVfY29vcCkgcmV0dXJuIGZhbHNlOwoKCQlpZiAobjEuX2NvZGUgPT0gbjIuX2NvZGUpIHJldHVybiB0cnVlOwoKCQlyZXR1cm4gdGhpcy5FcXVhbHMobjEsIG4yKTsKCX0KCglfZml4Tm9kZShzY29wZSkgewoJCS8vIG9uIE5vZGVKUyBmb3Igc29tZSByZWFzb24sIF9ub2RlIGlzIHNvbWV0aW1lcyBhbiBhcnJheSEKCQl0cnkgewoJCQlzY29wZSA9IHNjb3BlIHx8IHRoaXMuX19zY29wZSgpOwoJCQlpZiAoQXJyYXkuaXNBcnJheShzY29wZS5fbm9kZSkpIHNjb3BlLl9ub2RlID0gc2NvcGUuX25vZGVbMF07CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2coJ19maXhOb2RlJywgdHlwZW9mKHRoaXMpLCAxLCBleCwgdGhpcy5jb25zdHJ1Y3Rvci5uYW1lKTsKCQl9Cgl9CgoJbG9nKG9iaiwgbSwgdHlwZSwgbGV2ZWwsIC4uLm1zZykgewoJCXRyeSB7CgkJCWxldCBkZWJ1ZyA9IHRoaXMuRGVidWc7CgkJCWxldCBsZXZlbHMgPSBbImluZm8iLCAid2FybiIsICJlcnJvciIsICJjcml0aWNhbCJdOwoKCQkJZGVidWcgPSBkZWJ1ZyB8fCBPYmplY3QuZnJvbUVudHJpZXMobmV3IE1hcChsZXZlbHMubWFwKGwgPT4gW2wsICcqJ10pKSk7CgoJCQlsZXQgZnVuY3Rpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgLi4ubGV2ZWxzLm1hcChsID0+ICh7CgkJCQlbbF06IGRlYnVnW2xdID8gZGVidWdbbF0uc3BsaXQoJywnKSA6IFtdCgkJCX0pKSk7CgoJCQlsZXQgY3NzID0gJ2JhY2tncm91bmQ6ICMwMGZmMDA7IGNvbG9yOiAjMDA4MDAwJzsKCQkJbGV0IGZnID0gJ1x4MWJbMzJtJzsKCQkJc3dpdGNoIChOdW1iZXIobGV2ZWwpKSB7CgkJCQljYXNlIDE6CgkJCQkJY3NzID0gJ2JhY2tncm91bmQ6ICNmZmZmMDA7IGNvbG9yOiAjMDAwMDgwJzsKCQkJCQlmZyA9ICdceDFiWzMzbSc7CgkJCQkJYnJlYWs7CgkJCQljYXNlIDI6CgkJCQkJY3NzID0gJ2JhY2tncm91bmQ6ICNiMjIyMjI7IGNvbG9yOiAjZmZmZmZmJzsKCQkJCQlmZyA9ICdceDFiWzMxbSc7CgkJCQkJYnJlYWs7CgkJCQljYXNlIDM6CgkJCQkJY3NzID0gJ2JhY2tncm91bmQ6ICNiMjIyMjI7IGNvbG9yOiAjZmZmZmZmJzsKCQkJCQlmZyA9ICdceDFiWzMxbVtDUklUSUNBTF0nOwoJCQkJCWJyZWFrOwoJCQl9CgoJCQlpZiAoZnVuY3Rpb25zW2xldmVsc1tOdW1iZXIobGV2ZWwpIHx8IDBdXS5ldmVyeShmID0+ICFbJyouKicsICcqLicgKyBtLCAnKicsIG0sIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSArICcuJyArIG0sIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSArICcuKiddLmluY2x1ZGVzKGYpKSkgewoJCQkJLy8gY29uc29sZS5sb2coJ25vIG1ldGhvZCcsIGZ1bmN0aW9ucywgZnVuY3Rpb25zW2xldmVsc1tOdW1iZXIobGV2ZWwpIHx8IDBdXSwgbSwgWycqLionLCAnKi4nICsgbSwgJyonLCBtLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUgKyAnLicgKyBtLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUgKyAnLionXSk7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCWNvbnNvbGUubG9nKGZnICsgIiVzXHgxYlswbSIsIGAke3R5cGUgfHwgJzx0eXBlPid9OiAke3RoaXMuU2NvcGV9LiR7dGhpcy5FbnRpdHlDbGFzcy5OYW1lfS4ke20gfHwgJzxtZXRob2Q+J30oKWAsIC4uLih0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcgPyAobXNnIHx8IFtdKSA6IFtvYmpdLmNvbmNhdChtc2cgfHwgW10pKSk7CgkJCX0gZWxzZSB7CgkJCQljb25zb2xlLmxvZyhgJWMgJHt0eXBlIHx8ICc8dHlwZT4nfTogJHt0aGlzLlNjb3BlfS4ke3RoaXMuRW50aXR5Q2xhc3MuTmFtZX0uJHttIHx8ICc8bWV0aG9kPid9KClgLCBjc3MsIC4uLih0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcgPyAobXNnIHx8IFtdKSA6IFtvYmpdLmNvbmNhdChtc2cgfHwgW10pKSk7CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQljb25zb2xlLmxvZyhleCk7CgkJCS8vdGhpcy5sb2coZXgsIG0sIHR5cGUsIDMpOwoJCX0KCX0KCglhc3luYyBfU2NyaXB0KHNjcmlwdCwgbSwgdHlwZSwgc2NvcGUsIC4uLnNmQXJncykgewoJCWlmICh0eXBlb2Yoc2NyaXB0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCgkJcmV0dXJuIGF3YWl0IChhc3luYyAodHlwZSwgLi4uc0FyZ3MpID0+IHsKCQkJbGV0IGxvZyA9IChvYmosIC4uLm1zZykgPT4gdGhpcy5sb2cob2JqLCBtLCB0eXBlLCAwLCAuLi5tc2cpOwoJCQlsZXQgd2FybiA9IChvYmosIC4uLm1zZykgPT4gdGhpcy5sb2cob2JqLCBtLCB0eXBlLCAxLCAuLi5tc2cpOwoJCQlsZXQgZXJyb3IgPSAob2JqLCAuLi5tc2cpID0+IHRoaXMubG9nKG9iaiwgbSwgdHlwZSwgMiwgLi4ubXNnKTsKCgkJCXRyeSB7CgkJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCQlpZiAodHlwZW9mKHNjcmlwdCkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSBhd2FpdCBzY3JpcHQobG9nLCB3YXJuLCBlcnJvciwgc2NvcGUsIG0sIC4uLnNBcmdzKTsKCQkJCX0KCgkJCQl0aGlzLl9maXhOb2RlKCk7CgkJCQlyZXR1cm4gcmV0OwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCWVycm9yKGV4LCAyLCAuLi5zQXJncywgc2NyaXB0KTsKCQkJCX0gZWxzZSB7CgkJCQkJZXJyb3IoZXgsIDIpOwoJCQkJfQoJCQl9CgkJfSkodHlwZSwgLi4uc2ZBcmdzKTsKCX0KfTsKCgpzYWxlc25vdy5Vc2VyID0gY2xhc3MgVXNlciBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFpZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKZllYVjBhRzl5YVhwbExuVnpaWEp1WVcxbElqb2labUZrYVNJc0lsOWhkWFJvYjNKcGVtVXVjR0Z6YzNkdmNtUWlPaUl4TWpNaUxDSmZZWFYwYUc5eWFYcGxMblJsYzNSVmMyVnlJanA3SW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlN3aVoyVnVaR1Z5SWpwN0ltTnZaR1VpT2lKTklpd2libUZ0WlNJNklrMWhiR1VpZlN3aVkyOWtaU0k2SW1aaFpHa2lMQ0p1WVcxbElqb2lSbUZrYVNKOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzSWtkcGRFaDFZaUpkYCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJ1c2VybmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfdXNlcm5hbWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJwYXNzd29yZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcGFzc3dvcmQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkZXBhcnRtZW50IiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kZXBhcnRtZW50KCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgkJdGhpcy5jbGVhcl9tYW5hZ2VyX0RlcGFydG1lbnRzKCk7CgoJCXRoaXMuY2xlYXJfY2FsbGVyX0luY2lkZW50cygpOwoKCQl0aGlzLmNsZWFyX2NvbnRhY3RfSW5jaWRlbnRzKCk7CgoJCXRoaXMuY2xlYXJfdXNlcl9Hcm91cF9NZW1iZXJzKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiVXNlciIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJcmV0dXJuIHRoaXM7CgoJCWlmICh0aGlzLl9kZXBhcnRtZW50X3NldCAmJiB0aGlzLl9kZXBhcnRtZW50KSB0aGlzLl9kZXBhcnRtZW50LlRvb2wgPSB0b29sOwoKCQkodGhpcy5tYW5hZ2VyX0RlcGFydG1lbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJKHRoaXMuY2FsbGVyX0luY2lkZW50cygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCSh0aGlzLmNvbnRhY3RfSW5jaWRlbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJKHRoaXMudXNlcl9Hcm91cF9NZW1iZXJzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJVEhJUyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsKCQlpZiAoIXYpIHJldHVybiB0aGlzOwoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCQl0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KSA9PT0gJ29iamVjdCcgJiYgX3YuRW50aXR5Q2xhc3MgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSA9PSB0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGUgPT0gdGhpcy5TY29wZSk7CgkJaWYgKGNvKSB0aGlzLl9USElTX2Nvb3AgPSBjbzsKCQlyZXR1cm4gdGhpczsKCX0KCgljbGVhcl9USElTKCkgewoJCXRoaXMuX1RISVMgPSBbXTsKCQl0aGlzLl9USElTX2Nvb3AgPSAnJzsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHVzZXJuYW1lICoqLwoJdXNlcm5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl91c2VybmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInVzZXJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl91c2VybmFtZSAhPSB2KSB7CgkJCQl0aGlzLl91c2VybmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fdXNlcm5hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fdXNlcm5hbWUpOwoJCX0KCX0KCgljbGVhcl91c2VybmFtZSgpIHsKCQl0aGlzLl91c2VybmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX3VzZXJuYW1lID0gbnVsbDsKCQl0aGlzLl91c2VybmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdXNlcm5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBwYXNzd29yZCAqKi8KCXBhc3N3b3JkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcGFzc3dvcmRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJwYXNzd29yZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcGFzc3dvcmQgIT0gdikgewoJCQkJdGhpcy5fcGFzc3dvcmRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3Bhc3N3b3JkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3Bhc3N3b3JkKTsKCQl9Cgl9CgoJY2xlYXJfcGFzc3dvcmQoKSB7CgkJdGhpcy5fcGFzc3dvcmRfc2V0ID0gbnVsbDsKCQl0aGlzLl9wYXNzd29yZCA9IG51bGw7CgkJdGhpcy5fcGFzc3dvcmRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHBhc3N3b3JkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGVwYXJ0bWVudCAqKi8KCWRlcGFydG1lbnQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kZXBhcnRtZW50X2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGVwYXJ0bWVudCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzNjNDZhOTg1LWU1YTQtNGU2ZC1hYjYxLTU1ZTY0NzBkZDUxZicgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0RlcGFydG1lbnQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZGVwYXJ0bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjNjNDZhOTg1LWU1YTQtNGU2ZC1hYjYxLTU1ZTY0NzBkZDUxZiIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJEZXBhcnRtZW50Iik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RlcGFydG1lbnQgIT0gdikgewoJCQkJdGhpcy5fZGVwYXJ0bWVudF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2RlcGFydG1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX2RlcGFydG1lbnQgPyB0aGlzLl9kZXBhcnRtZW50LlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9kZXBhcnRtZW50X3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9kZXBhcnRtZW50ID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RlcGFydG1lbnQpOwoJCX0KCX0KCgljbGVhcl9kZXBhcnRtZW50KCkgewoJCXRoaXMuX2RlcGFydG1lbnRfc2V0ID0gbnVsbDsKCQl0aGlzLl9kZXBhcnRtZW50ID0gbnVsbDsKCQl0aGlzLl9kZXBhcnRtZW50X2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkZXBhcnRtZW50ICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbWFuYWdlcl9EZXBhcnRtZW50cyAqKi8KCW1hbmFnZXJfRGVwYXJ0bWVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzNjNDZhOTg1LWU1YTQtNGU2ZC1hYjYxLTU1ZTY0NzBkZDUxZicgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnRGVwYXJ0bWVudCcpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fbWFuYWdlcl9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdtYW5hZ2VyX0RlcGFydG1lbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJtYW5hZ2VyIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJEZXBhcnRtZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnbWFuYWdlcl9EZXBhcnRtZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAibWFuYWdlciBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkRlcGFydG1lbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YubWFuYWdlcih0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzLnB1c2goLi4udik7CgkJdGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50c19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50c19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfbWFuYWdlcl9EZXBhcnRtZW50cygpIHsKCQl0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX3NldCA9IG51bGw7CgkJdGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50cyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBtYW5hZ2VyX0RlcGFydG1lbnRzICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY2FsbGVyX0luY2lkZW50cyAqKi8KCWNhbGxlcl9JbmNpZGVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX2NhbGxlcl9JbmNpZGVudHM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzc0MDc5MzQ3LWNkYzItNGUwZS04ZGQyLWM5MWU1YzM4ZDAwZCcgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnSW5jaWRlbnQnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX2NhbGxlcl9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjYWxsZXJfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJjYWxsZXIgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkluY2lkZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnY2FsbGVyX0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAiY2FsbGVyIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiSW5jaWRlbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YuY2FsbGVyKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX2NhbGxlcl9JbmNpZGVudHMucHVzaCguLi52KTsKCQl0aGlzLl9jYWxsZXJfSW5jaWRlbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9jYWxsZXJfSW5jaWRlbnRzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9jYWxsZXJfSW5jaWRlbnRzKCkgewoJCXRoaXMuX2NhbGxlcl9JbmNpZGVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9jYWxsZXJfSW5jaWRlbnRzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fY2FsbGVyX0luY2lkZW50c19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNhbGxlcl9JbmNpZGVudHMgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb250YWN0X0luY2lkZW50cyAqKi8KCWNvbnRhY3RfSW5jaWRlbnRzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9jb250YWN0X0luY2lkZW50czsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnNzQwNzkzNDctY2RjMi00ZTBlLThkZDItYzkxZTVjMzhkMDBkJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdJbmNpZGVudCcpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fY29udGFjdF9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjb250YWN0X0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAiY29udGFjdCBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiSW5jaWRlbnQiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjb250YWN0X0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAiY29udGFjdCBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkluY2lkZW50Iik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LmNvbnRhY3QodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fY29udGFjdF9JbmNpZGVudHMucHVzaCguLi52KTsKCQl0aGlzLl9jb250YWN0X0luY2lkZW50c19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fY29udGFjdF9JbmNpZGVudHNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX2NvbnRhY3RfSW5jaWRlbnRzKCkgewoJCXRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX3NldCA9IG51bGw7CgkJdGhpcy5fY29udGFjdF9JbmNpZGVudHMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9jb250YWN0X0luY2lkZW50c19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvbnRhY3RfSW5jaWRlbnRzICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdXNlcl9Hcm91cF9NZW1iZXJzICoqLwoJdXNlcl9Hcm91cF9NZW1iZXJzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl91c2VyX0dyb3VwX01lbWJlcnM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2RmNTkzMzJjLTgxMmUtNDlhOS1hZTQ2LTI5MjI5Y2U0NmIyYicgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnR3JvdXAgTWVtYmVyJykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll91c2VyX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VzZXJfR3JvdXBfTWVtYmVycycsICdFbnRpdHlPYmplY3QnLCAxLCAidXNlciBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiR3JvdXBfTWVtYmVyIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXNlcl9Hcm91cF9NZW1iZXJzJywgJ0VudGl0eU9iamVjdCcsIDEsICJ1c2VyIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiR3JvdXBfTWVtYmVyIik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LnVzZXIodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fdXNlcl9Hcm91cF9NZW1iZXJzLnB1c2goLi4udik7CgkJdGhpcy5fdXNlcl9Hcm91cF9NZW1iZXJzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX3VzZXJfR3JvdXBfTWVtYmVycygpIHsKCQl0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfc2V0ID0gbnVsbDsKCQl0aGlzLl91c2VyX0dyb3VwX01lbWJlcnMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB1c2VyX0dyb3VwX01lbWJlcnMgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl91c2VybmFtZV9zZXQsCgoJCQl0aGlzLl9wYXNzd29yZF9zZXQsCgoJCQl0aGlzLl9kZXBhcnRtZW50X3NldCwKCgkJCXRoaXMuX2FjdGl2ZV9zZXQsCgoJCQl0aGlzLl9lbmFibGVkX3NldCwKCgkJCXRoaXMuX2NvZGVfc2V0LAoKCQkJdGhpcy5fb3JkZXJfc2V0LAoKCQkJdGhpcy5fZGF0ZV9zZXQsCgoJCQl0aGlzLl9uYW1lX3NldCwKCgkJCXRoaXMuX3JlbWFya19zZXQsCgoJCQl0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX3NldCwKCgkJCXRoaXMuX2NhbGxlcl9JbmNpZGVudHNfc2V0LAoKCQkJdGhpcy5fY29udGFjdF9JbmNpZGVudHNfc2V0LAoKCQkJdGhpcy5fdXNlcl9Hcm91cF9NZW1iZXJzX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX3VzZXJuYW1lX3NldCA9IHRoaXMuX3VzZXJuYW1lX3NldDsKCQlyZXQuX3VzZXJuYW1lX2Nvb3AgPSB0aGlzLl91c2VybmFtZV9jb29wOwoJCXJldC51c2VybmFtZSA9IHRoaXMudXNlcm5hbWUoKSA/IHRoaXMudXNlcm5hbWUoKSA6IHRoaXMudXNlcm5hbWUoKTsKCgkJcmV0Ll9wYXNzd29yZF9zZXQgPSB0aGlzLl9wYXNzd29yZF9zZXQ7CgkJcmV0Ll9wYXNzd29yZF9jb29wID0gdGhpcy5fcGFzc3dvcmRfY29vcDsKCQlyZXQucGFzc3dvcmQgPSB0aGlzLnBhc3N3b3JkKCkgPyB0aGlzLnBhc3N3b3JkKCkgOiB0aGlzLnBhc3N3b3JkKCk7CgoJCXJldC5fZGVwYXJ0bWVudF9zZXQgPSB0aGlzLl9kZXBhcnRtZW50X3NldDsKCQlyZXQuX2RlcGFydG1lbnRfY29vcCA9IHRoaXMuX2RlcGFydG1lbnRfY29vcDsKCQlyZXQuZGVwYXJ0bWVudCA9IHRoaXMuZGVwYXJ0bWVudCgpID8gdGhpcy5kZXBhcnRtZW50KCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMuZGVwYXJ0bWVudCgpOwoKCQlyZXQuX2FjdGl2ZV9zZXQgPSB0aGlzLl9hY3RpdmVfc2V0OwoJCXJldC5fYWN0aXZlX2Nvb3AgPSB0aGlzLl9hY3RpdmVfY29vcDsKCQlyZXQuYWN0aXZlID0gdGhpcy5hY3RpdmUoKSA/IHRoaXMuYWN0aXZlKCkgOiB0aGlzLmFjdGl2ZSgpOwoKCQlyZXQuX2VuYWJsZWRfc2V0ID0gdGhpcy5fZW5hYmxlZF9zZXQ7CgkJcmV0Ll9lbmFibGVkX2Nvb3AgPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJcmV0LmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKSA/IHRoaXMuZW5hYmxlZCgpIDogdGhpcy5lbmFibGVkKCk7CgoJCXJldC5fY29kZV9zZXQgPSB0aGlzLl9jb2RlX3NldDsKCQlyZXQuX2NvZGVfY29vcCA9IHRoaXMuX2NvZGVfY29vcDsKCQlyZXQuY29kZSA9IHRoaXMuY29kZSgpID8gdGhpcy5jb2RlKCkgOiB0aGlzLmNvZGUoKTsKCgkJcmV0Ll9vcmRlcl9zZXQgPSB0aGlzLl9vcmRlcl9zZXQ7CgkJcmV0Ll9vcmRlcl9jb29wID0gdGhpcy5fb3JkZXJfY29vcDsKCQlyZXQub3JkZXIgPSB0aGlzLm9yZGVyKCkgPyB0aGlzLm9yZGVyKCkgOiB0aGlzLm9yZGVyKCk7CgoJCXJldC5fZGF0ZV9zZXQgPSB0aGlzLl9kYXRlX3NldDsKCQlyZXQuX2RhdGVfY29vcCA9IHRoaXMuX2RhdGVfY29vcDsKCQlyZXQuZGF0ZSA9IHRoaXMuZGF0ZSgpID8gdGhpcy5kYXRlKCkgOiB0aGlzLmRhdGUoKTsKCgkJcmV0Ll9uYW1lX3NldCA9IHRoaXMuX25hbWVfc2V0OwoJCXJldC5fbmFtZV9jb29wID0gdGhpcy5fbmFtZV9jb29wOwoJCXJldC5uYW1lID0gdGhpcy5uYW1lKCkgPyB0aGlzLm5hbWUoKSA6IHRoaXMubmFtZSgpOwoKCQlyZXQuX3JlbWFya19zZXQgPSB0aGlzLl9yZW1hcmtfc2V0OwoJCXJldC5fcmVtYXJrX2Nvb3AgPSB0aGlzLl9yZW1hcmtfY29vcDsKCQlyZXQucmVtYXJrID0gdGhpcy5yZW1hcmsoKSA/IHRoaXMucmVtYXJrKCkgOiB0aGlzLnJlbWFyaygpOwoKCQlyZXQubWFuYWdlcl9EZXBhcnRtZW50cyA9IHRoaXMubWFuYWdlcl9EZXBhcnRtZW50cygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0LmNhbGxlcl9JbmNpZGVudHMgPSB0aGlzLmNhbGxlcl9JbmNpZGVudHMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldC5jb250YWN0X0luY2lkZW50cyA9IHRoaXMuY29udGFjdF9JbmNpZGVudHMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldC51c2VyX0dyb3VwX01lbWJlcnMgPSB0aGlzLnVzZXJfR3JvdXBfTWVtYmVycygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkidXNlcm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJwYXNzd29yZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwYXNzd29yZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRlcGFydG1lbnQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCW1hbmFnZXJfRGVwYXJ0bWVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdtYW5hZ2VyX1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJY2FsbGVyX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhbGxlcl9Vc2VycycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCWNvbnRhY3RfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGFjdF9Vc2VycycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCXVzZXJfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXJfVXNlcnMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlpZiAoIXVzZXJuYW1lICYmICFwYXNzd29yZCAmJiAhc2FsZXNub3cuX190b2tlbiAmJiB0aGlzLlRlc3RbJ19hdXRob3JpemUudXNlcm5hbWUnXSkgewoJCQl1c2VybmFtZSA9IHRoaXMuVGVzdFsnX2F1dGhvcml6ZS51c2VybmFtZSddOwoJCQlwYXNzd29yZCA9IHRoaXMuVGVzdFsnX2F1dGhvcml6ZS5wYXNzd29yZCddOwoJCX0KCgkJaWYgKGJTZXJ2ZXIpIHsKCQkJaWYgKHVzZXJuYW1lICYmICFzYWxlc25vdy5fdGVzdFVzZXIpIHsKCQkJCXNhbGVzbm93Ll90ZXN0VXNlciA9IGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2Zyb21Eb2N1bWVudCh0aGlzLlRlc3RbJ19hdXRob3JpemUudGVzdFVzZXInXSB8fCB7fSkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkudXNlcm5hbWUodXNlcm5hbWUpLnBhc3N3b3JkKHBhc3N3b3JkKS5zdG9yZSgpOwoJCQl9CgkJCWxldCByZXQgPSBhd2FpdCB0aGlzLnVzZXJuYW1lKHVzZXJuYW1lLCAnPScpLnBhc3N3b3JkKHBhc3N3b3JkLCAnPScpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmZpbmQoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2F1dGhvcml6ZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VydmVyOiAiICsgYlNlcnZlciArICIsIE9iajoiLCByZXQpOwoKCQkJaWYgKHJldCkgewoJCQkJaWYgKHR5cGVvZihqc29ud2VidG9rZW4pICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IGpzb253ZWJ0b2tlbi5zaWduKHJldC5fdG9Eb2N1bWVudCgpLCB0aGlzLl9fY29uZmlnKCdzZWNyZXQnKSwgewoJCQkJCQlleHBpcmVzSW46ICcxODAwcycKCQkJCQl9KTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gdGhpcy5fYnRvYShKU09OLnN0cmluZ2lmeShyZXQuX3RvRG9jdW1lbnQoKSkpOwoJCQkJfQoJCQl9CgoJCQlyZXQgPSB7CgkJCQlhY2Nlc3NfdG9rZW46IHJldCwKCQkJfTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2F1dGhvcml6ZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VydmVyOiAiICsgYlNlcnZlciArICIsIHRva2VuOiAiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gZWxzZSB7CgkJCWxldCBjbGllbnRfaWQgPSB0aGlzLl9fY29uZmlnKCdjbGllbnRfaWQnKTsKCQkJbGV0IGNsaWVudF9zZWNyZXQgPSB0aGlzLl9fY29uZmlnKCdzZWNyZXQnKTsKCgkJCWlmICghdXNlcm5hbWUgJiYgIXBhc3N3b3JkICYmIHNhbGVzbm93Ll9fdG9rZW4pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19hdXRob3JpemUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIHVzZXJuYW1lL3Bhc3N3b3JkIGFuZCB0b2tlbiBhbHJlYWR5IGV4aXN0cyIpOwoJCQkJcmV0dXJuOwoJCQl9CgoJCQlzYWxlc25vdy5fX3Rva2VuID0gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS51c2VybmFtZSh1c2VybmFtZSkucGFzc3dvcmQocGFzc3dvcmQpLmF1dGhvcml6ZSgpOwoKCQl9CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAiZGVwYXJ0bWVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgZGVwYXJ0bWVudCcsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudCgpLmRlcGFydG1lbnRfVXNlcnModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9zZXJ2ZXIoKSB7CgkJLy8gbmV0c3RhdCAtYW5vIHwgZmluZHN0ciA6MzAwMCB8IGZpbmRzdHIgTElTVEVOSU5HCgkJLy8gdHNraWxsIDxwaWQ+CgoJCS8vIGdsb2JhbHMKCQl2YXIgZ2xvYmFsTW9kdWxlcyA9IHsKCQkJZXhwcmVzczogJ2V4cHJlc3MnLAoJCQlodHRwczogJ2h0dHBzJywKCQkJaHR0cDogJ2h0dHAnLAoJCQlzZWxmc2lnbmVkOiAnc2VsZnNpZ25lZCcsCgkJCXV0aWw6ICd1dGlsJywKCQkJY29yczogJ2NvcnMnLAoJCQlib2R5UGFyc2VyOiAnYm9keS1wYXJzZXInLAoJCQlheGlvczogJ2F4aW9zJywKCQkJLy9jcnlwdG86ICdjcnlwdG8nLAoJCQlmczogJ2ZzJywKCQkJb3M6ICdvcycsCgkJCURvdE9iamVjdDogJ2RvdC1vYmplY3QnLAoKCQkJbWluaW1pc3Q6ICdtaW5pbWlzdCcsCgoJCQltYWNoaW5laWQ6ICdub2RlLW1hY2hpbmUtaWQnLAoJCQljaGlsZF9wcm9jZXNzOiAnY2hpbGRfcHJvY2VzcycsCgoJCQlldmVudHM6ICdldmVudHMnLAoJCQlzb2NrZXRpbzogJ3NvY2tldC5pbycsCgkJCW1xdHQ6ICdtcXR0JywKCgkJCWpzb253ZWJ0b2tlbjogJ2pzb253ZWJ0b2tlbicsCgoJCQlzcWxpdGU6ICdzcWxpdGUzJywKCQkJbXlzcWw6ICdteXNxbCcsCgoJCX07CgoJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19zZXJ2ZXInLCAnRW50aXR5T2JqZWN0JywgMCwgIm5wbSBpbnN0YWxsICIgKyBPYmplY3QudmFsdWVzKGdsb2JhbE1vZHVsZXMpLmpvaW4oJyAnKSk7CgkJbGV0IG1pc3NpbmdHbG9iYWxNb2R1bGVzID0gT2JqZWN0LmVudHJpZXMoZ2xvYmFsTW9kdWxlcykubWFwKGUgPT4gewoJCQl0cnkgewoJCQkJZ2xvYmFsW2VbMF1dID0gcmVxdWlyZShlWzFdKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zZXJ2ZXInLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQkJcmV0dXJuIGVbMV07CgkJCX0KCQl9KS5maWx0ZXIoZSA9PiBlKTsKCQlpZiAobWlzc2luZ0dsb2JhbE1vZHVsZXMubGVuZ3RoKSB0aGlzLmxvZyh1bmRlZmluZWQsICdfc2VydmVyJywgJ0VudGl0eU9iamVjdCcsIDEsICJucG0gaW5zdGFsbCAiICsgbWlzc2luZ0dsb2JhbE1vZHVsZXMuam9pbignICcpKTsKCgkJLy8gcmVmcmVzaCBzY3JpcHQKCQl0aGlzLnNldEludGVydmFsKGFzeW5jIChzKSA9PiBhd2FpdCB0aGlzLl9yZWZyZXNoQVBJKHMsICdhcGlzZXJ2ZXIuanMnKSwgMC41LCBwcm9jZXNzLmFyZ3Yuc2xpY2UoMikubGVuZ3RoID8gcHJvY2Vzcy5hcmd2LnNsaWNlKDIpWzBdIDogJ3NhbGVzbm93Jyk7CgoJCWNvbnN0IGFwcCA9IGV4cHJlc3MoKTsKCgkJYXBwLnVzZShjb3JzKCkpOwoKCQlhcHAudXNlKGV4cHJlc3MudXJsZW5jb2RlZCh7CgkJCWV4dGVuZGVkOiB0cnVlLAoJCQlsaW1pdDogJzUwbWInCgkJfSkpOwoJCWFwcC51c2UoYm9keVBhcnNlci5qc29uKHsKCQkJdmVyaWZ5OiAocmVxLCByZXMsIGJ1ZikgPT4gcmVxLnJhd0JvZHkgPSBidWYKCQl9KSk7CgoJCWdsb2JhbC5hdXRoZW50aWNhdGUgPSBhc3luYyAocmVxLCByZXMsIG5leHQpID0+IHsKCQkJY29uc3QgYXV0aEhlYWRlciA9IHJlcS5oZWFkZXJzWydhdXRob3JpemF0aW9uJ107CgkJCWNvbnN0IHRva2VuID0gYXV0aEhlYWRlciAmJiBhdXRoSGVhZGVyLnNwbGl0KCcgJylbMV07CgoJCQlpZiAodG9rZW4gPT0gbnVsbCkgcmV0dXJuIHJlcy5zZW5kU3RhdHVzKDQwMSk7CgoJCQlqc29ud2VidG9rZW4udmVyaWZ5KHRva2VuLCB0aGlzLl9fY29uZmlnKCdzZWNyZXQnKSwgKGVyciwgb2JqKSA9PiB7CgkJCQlpZiAoZXJyKSByZXR1cm4gcmVzLnNlbmRTdGF0dXMoNDAzKTsKCgkJCQlyZXEuX19hdXRob3JpemF0aW9uID0gb2JqOwoJCQkJbmV4dCgpOwoJCQl9KTsKCQl9OwoKCQlhcHAucG9zdCgnL21ldGhvZC9Vc2VyL2F1dGhvcml6ZScsIChyZXEsIHJlcykgPT4gdGhpcy5faW5ib3VuZENhbGwocmVxLCByZXMsICJVc2VyIiwgImF1dGhvcml6ZSIpKTsKCQlhcHAuZ2V0KCcvbWV0aG9kL1VzZXIvYXV0aG9yaXplJywgKHJlcSwgcmVzKSA9PiB0aGlzLl9pbmJvdW5kQ2FsbChyZXEsIHJlcywgIlVzZXIiLCAiYXV0aG9yaXplIikpOwoKCQlhcHAucG9zdCgnL21ldGhvZC86Y2xhc3MvOm1ldGhvZCcsIGdsb2JhbC5hdXRoZW50aWNhdGUsIChyZXEsIHJlcykgPT4gdGhpcy5faW5ib3VuZENhbGwocmVxLCByZXMpKTsKCQlhcHAuZ2V0KCcvbWV0aG9kLzpjbGFzcy86bWV0aG9kJywgZ2xvYmFsLmF1dGhlbnRpY2F0ZSwgKHJlcSwgcmVzKSA9PiB0aGlzLl9pbmJvdW5kQ2FsbChyZXEsIHJlcykpOwoKCQlpZiAodGhpcy5fX2NvbmZpZygnZW1haWwuaG9zdCcpKSB7CgkJCXNhbGVzbm93LnRyYW5zcG9ydGVyID0gbm9kZW1haWxlci5jcmVhdGVUcmFuc3BvcnQoewoJCQkJc2VydmljZTogdGhpcy5fX2NvbmZpZygnZW1haWwuaG9zdCcpLAoJCQkJYXV0aDogdGhpcy5fX2NvbmZpZygnZW1haWwudXNlcicpID8gewoJCQkJCXVzZXI6IHRoaXMuX19jb25maWcoJ2VtYWlsLnVzZXInKSwKCQkJCQlwYXNzOiB0aGlzLl9fY29uZmlnKCdlbWFpbC5wYXNzd29yZCcpLAoJCQkJfSA6IHVuZGVmaW5lZCwKCQkJfSk7CgoJCQkvKgoJCQlhd2FpdCBzYWxlc25vdy50cmFuc3BvcnRlci5zZW5kTWFpbCh7CgkJCSAgICBmcm9tOiB0aGlzLl9fY29uZmlnKCdlbWFpbC5zZW5kZXInKSwKCQkJICAgIHRvLAoJCQkgICAgc3ViamVjdCwKCQkJICAgIHRleHQsCgkJCX0pOwoJCQkqLwoJCX0KCgkJbGV0IHNlY3VyZSA9IHRoaXMuX19jb25maWcoJ3NlY3VyZScpOwoKCQlzYWxlc25vdy5fbm9kZSA9IGF3YWl0IG5ldyBzYWxlc25vdy5Ob2RlKCkuc2VjdXJlKHNlY3VyZSkuaW5pdCh0aGlzLl9fY29uZmlnKCdpbml0Lmxvb3AnKSB8fCAwLjUpOwoKCQlsZXQgcG9ydCA9IHNhbGVzbm93Ll9ub2RlID8gKHNhbGVzbm93Ll9ub2RlLnBvcnQoKSB8fCAzMDAwKSA6IDMwMDA7CgkJbGV0IGFkZHJlc3MgPSAiMC4wLjAuMCI7CgoJCWlmICh0aGlzLl9fY29uZmlnKCdDT1JTUHJveHknKSkgewoJCQljb3JzX3Byb3h5LmNyZWF0ZVNlcnZlcih7CgkJCQlvcmlnaW5XaGl0ZWxpc3Q6IFtdLCAvLyBBbGxvdyBhbGwgb3JpZ2lucwoJCQkJcmVxdWlyZUhlYWRlcjogWydvcmlnaW4nLCAneC1yZXF1ZXN0ZWQtd2l0aCddLAoJCQkJcmVtb3ZlSGVhZGVyczogWydjb29raWUnLCAnY29va2llMiddCgkJCX0pLmxpc3Rlbig4MDAwLCBhZGRyZXNzLCBmdW5jdGlvbigpIHsKCQkJCWNvbnNvbGUubG9nKCdSdW5uaW5nIENPUlMgQW55d2hlcmUgb24gJyArIGFkZHJlc3MgKyAnOicgKyAnODAwMCcpOwoJCQl9KTsKCQl9CgoJCWxldCBsaXN0ZW4gPSBhc3luYyAoKSA9PiB0aGlzLmxvZyh1bmRlZmluZWQsICdfc2VydmVyJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzYWxlc25vd1ske3RoaXMuaXBBZGRyZXNzKCl9XSBsaXN0ZW5pbmcgYXQgaHR0cCR7c2VjdXJlPydzJzonJ306Ly8ke2FkZHJlc3N9OiR7cG9ydH1gKTsKCQlpZiAoc2VjdXJlKSB7CgkJCWxldCBjZXJ0ID0gbnVsbDsKCQkJaWYgKHRoaXMuX19jb25maWcoJ3NlY3VyZS5wcml2YXRlJykpIHsKCQkJCWNlcnQgPSB7CgkJCQkJcHJpdmF0ZTogKGF3YWl0IGZzLnByb21pc2VzLnJlYWRGaWxlKHRoaXMuX19jb25maWcoJ3NlY3VyZS5wcml2YXRlJykpKSwKCQkJCQljZXJ0OiAoYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUodGhpcy5fX2NvbmZpZygnc2VjdXJlLmNlcnQnKSkpLAoJCQkJfTsKCQkJfSBlbHNlIHsKCQkJCWNlcnQgPSBzZWxmc2lnbmVkLmdlbmVyYXRlKFt7CgkJCQkJbmFtZTogJ2NvbW1vbk5hbWUnLAoJCQkJCXZhbHVlOiAnbmFtbW91ci5jb20nCgkJCQl9XSwgewoJCQkJCWRheXM6IDM2NQoJCQkJfSk7CgkJCX0KCQkJZ2xvYmFsLmV4U2VydmVyID0gaHR0cHMuY3JlYXRlU2VydmVyKHsKCQkJCWtleTogY2VydC5wcml2YXRlLAoJCQkJY2VydDogY2VydC5jZXJ0CgkJCX0sIGFwcCkubGlzdGVuKHBvcnQsIGFkZHJlc3MsIGxpc3Rlbik7CgkJfSBlbHNlIHsKCQkJZ2xvYmFsLmV4U2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIoYXBwKS5saXN0ZW4ocG9ydCwgYWRkcmVzcywgbGlzdGVuKTsKCQl9Cgl9CgoJYXN5bmMgX2luYm91bmRDYWxsKHJlcSwgcmVzLCBjTmFtZSwgbU5hbWUpIHsKCQlsZXQgcmV0ID0ge307CgkJdHJ5IHsKCQkJcmV0ID0gYXdhaXQgbmV3IHNhbGVzbm93W3JlcS5wYXJhbXMuY2xhc3MgfHwgY05hbWVdKCkuX2ludm9rZShyZXEucGFyYW1zLm1ldGhvZCB8fCBtTmFtZSwgcmVxLmJvZHksIHJlcS5xdWVyeSwgcmVxLl9fYXV0aG9yaXphdGlvbik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2luYm91bmRDYWxsJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJcmV0ID0gewoJCQkJRXhjZXB0aW9uOiAiRXhjZXB0aW9uOiAiICsgZXgsCgkJCX07CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXEucXVlcnlbImpzb24iXSAhPSAidHJ1ZSIgJiYgcmVxLmJvZHkgJiYgcmVxLmJvZHkuX19mbGF0dGVkKSByZXQgPSB7CgkJCV9fZmxhdHRlZDogRmxhdHRlZC5zdHJpbmdpZnkocmV0KQoJCX07CgoJCWlmIChyZXQgJiYgdHlwZW9mKHJldCkgPT09ICJudW1iZXIiKSByZXQgPSByZXQudG9TdHJpbmcoKTsKCQlyZXMuc2VuZChyZXQpOwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCAmJiBldmVudC5jbGFzc05hbWUoKSAmJiBldmVudC5jbGFzc05hbWUoKSAhPSAnVXNlcicpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCXJldHVybiBuZXcgc2FsZXNub3dbZXZlbnQuY2xhc3NOYW1lKCldKCkuX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdyk7CgkJCX0KCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJCWNhc2UgImluaXQiOiB7CgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCWNhc2UgImF1dGhvcml6ZSI6IHsKCgkJCQkJYnJlYWs7CgkJCQl9CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL1VzZXIvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQkJZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOwoJCQkJZGVsZXRlIGRhdGEuX190aGlzLm9ubGluZTsKCgkJCX0KCgkJCS8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/PwoKCQkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJCXRyeSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0pIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7bWV0aG9kfWApOwoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCWxldCBfaWQgPSBudWxsOwoJCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBkYXRhLCBtZXRob2QsIHt9KTsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRhdGEpID09PSAnc3RyaW5nJykgewoJCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUoZGF0YSk7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IGRhdGEuX190aGlzLmNvZGUgfHwgZGF0YS5pZCB8fCBkYXRhLklEOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJCWlmIChkYXRhLklkICYmIGRhdGEuSWQgPT0gZGF0YS5JZCkgewoJCQkJCQlfaWQgPSBkYXRhLklkOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQkJfSBlbHNlIGlmIChkYXRhLkVudGl0eUNsYXNzKSB7CgkJCQkJCV9pZCA9IGRhdGEuRW50aXR5Q2xhc3MuSWQgfHwgZGF0YS5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgImY1ODdkYmE0LTcxYjUtNDRlMS1hNDJjLTU1N2Y1MGEzNzE1NSIgfHwgIk5VTEwiOwoJCQkJCX0KCQkJCX0KCgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVXNlciA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVXNlciB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVXNlclttZXRob2RdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW21ldGhvZF0gfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW21ldGhvZF1bX2lkXSB8fCB7fTsKCgkJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goe30sIHsKCQkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQkJfSk7CgoJCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVXNlclttZXRob2RdW19pZF1bX2hhc2hdOwoJCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiA1KSkgewoJCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gbWV0aG9kIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJCXYucmV1c2VkKys7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhKTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVXNlclttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnVXNlcicpLnNlbmRlcihzYWxlc25vdy5fbm9kZSkuY2FycmllcihzYWxlc25vdy5fbm9kZSkucGF5bG9hZChkYXRhKTsKCQkJaWYgKGV2ZW50KSB7CgkJCQlpZiAoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7CgkJCQlpZiAoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7CgkJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7CgkJCQlpZiAoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7CgkJCX0KCQkJcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOwoKCQkJaWYgKHR5cGVvZihyZXQpID09PSAic3RyaW5nIikgewoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChleCkge30KCQkJfQoJCQlyZXR1cm4gcmV0OwoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluaXQiOiB7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImF1dGhvcml6ZSI6IHsKCgkJCQlzYWxlc25vdy5fX3Rva2VuID0gewoJCQkJCXRva2VuX3R5cGU6ICJCZWFyZXIiLAoJCQkJCWFjY2Vzc190b2tlbjogcmV0CgkJCQl9OwoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5Vc2VyKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5Vc2VyKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX25vZGUpIHsKCQkJLy8gcHJvYmFibHkgc2hvdWxkIG5vdCBiZSBwcm9jZXNzZWQgaGVyZSwgYnV0IHJhdGhlciBjb25zdW1lZCBhcyBwYXJ0IG9mIHRoZSBleGVjdXRlKCkgbG9naWMsIHB1c2hpbmcgX19ub2RlIHRvIHRoZSBsaXN0IG9mIG15IG5vZGVzIHRvIGRlbGVnYXRlIHRvIT8KCQkJbGV0IHRuID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX19ub2RlKS5fZGVSZWZlcmVuY2UoKTsKCQkJZGVsZXRlIF9wYXJhbXMuX19ub2RlOwoJCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5faW52b2tlTm9kZSh0biwgbWV0aG9kLCBfcGFyYW1zKTsKCQl9CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluaXQiOiB7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImF1dGhvcml6ZSI6IHsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgVXNlci5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYFVzZXIuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuVXNlci5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5Vc2VyLicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlpZiAoc2FsZXNub3cuVG9vbHMgJiYgc2FsZXNub3cuVG9vbHMubGVuZ3RoKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19sb2FkVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMCwgYFske3NvdXJjZX1dOiBUb29scyBhbHJlYWR5IGxvYWRlZGApOwoJCQlyZXR1cm4gc2FsZXNub3cuVG9vbHM7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbG9hZFRvb2xzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBbJHtzb3VyY2V9XTogTG9hZGluZyB0b29scy4uLmApOwoKCQlkZWxldGUgc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3M7CgoJCWlmIChzYWxlc25vdy5fbm9kZSAmJiBzYWxlc25vdy5fbm9kZS5fcGFyZW50X3NldCAmJiBzYWxlc25vdy5fbm9kZS5wYXJlbnQoKS5fc2FtZU5vZGUoc2FsZXNub3cuX25vZGUucGFyZW50KCkpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19sb2FkVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMCwgYFske3NvdXJjZX1dOiBMb2FkaW5nIGZyb20gbm9kZSBwYXJlbnRgKTsKCQkJbGV0IHJldCA9IHNhbGVzbm93LlRvb2wgPyAoYXdhaXQgbmV3IHNhbGVzbm93LlRvb2woKS4gLypub2RlKHNhbGVzbm93Ll9ub2RlKS4qLyBmaW5kQWxsKDIpKS5tYXAodCA9PiB0Ll90b0RvY3VtZW50KCkpIDogbnVsbDsKCQkJaWYgKHJldCAmJiByZXQubGVuZ3RoKSB7CgkJCQlzYWxlc25vdy5Ub29scyA9IHJldDsKCQkJCXJldHVybiByZXQ7CgkJCX0KCQl9CgoJCWxldCB0b29scyA9IHRoaXMucnVuU2NyaXB0KGBbewogICAgICAgIAkJdHlwZTogewogICAgICAgIAkJCW5hbWU6ICJTcWxEQiIsCiAgICAgICAgCQl9LAogICAgICAgIAkJdG9vbF9Db25maWdzOiBbewogICAgICAgIAkJCW5hbWU6ICJjcmVhdGUiLAogICAgICAgIAkJCXZhbHVlOiAzLAogICAgICAgIAkJfSwgewogICAgICAgIAkJCW5hbWU6ICJ0eXBlIiwKICAgICAgICAJCQl2YWx1ZTogInNxbGl0ZSIsCiAgICAgICAgCQl9LCB7CiAgICAgICAgCQkJbmFtZTogIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIiwKICAgICAgICAJCQl2YWx1ZTogdHJ1ZSwKICAgICAgICAJCX0sIHsKICAgICAgICAJCQluYW1lOiAiU3luY1R5cGVkQXR0cmlidXRlcyIsCiAgICAgICAgCQkJdmFsdWU6IHRydWUsCiAgICAgICAgCQl9XQogICAgICAgIAl9XWApOwoKCQl0cnkgewoJCQlsZXQgZk5hbWUgPSAiQVBJU0VSVkVSX19sb2FkVG9vbHMuanNvbiI7CgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgZnMuZXhpc3RzU3luYyhmTmFtZSkpIHRvb2xzID0gdGhpcy5ydW5TY3JpcHQoYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUoZk5hbWUpKSB8fCB0b29sczsKCQkJaWYgKHRoaXMuX19jb25maWcoImdpdGh1Yi50b29scyIpKSB0b29scyA9IHRoaXMucnVuU2NyaXB0KGF3YWl0IGF4aW9zLmdldCh0aGlzLl9fY29uZmlnKCJnaXRodWIudG9vbHMiKSArIGZOYW1lLCB7CgkJCQl2YWxpZGF0ZVN0YXR1czogc3RhdHVzID0+IHN0YXR1cyA8IDUwMAoJCQl9KS5kYXRhKSB8fCB0b29sczsKCgkJCWxldCB0RGF0YSA9IG51bGw7CgkJCWlmICh0aGlzLnNyKCkpIHREYXRhID0gYXdhaXQgdGhpcy5zcigpLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc1N0b3JlZFNjcmlwdEZpbmQiLCBudWxsLCB7CgkJCQlOYW1lOiBmTmFtZSwKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCUVuYWJsZWQ6IHRydWUKCQkJfSk7CgkJCWlmICghdERhdGEpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19sb2FkVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMCwgYFske3NvdXJjZX1dOiBUb29scyBub3QgaW4gQ01TYCk7CgkJCX0gZWxzZSB7CgkJCQl0b29scyA9IHRoaXMucnVuU2NyaXB0KHREYXRhLlNjcmlwdCkgfHwgdG9vbHM7CgkJCX0KCgkJCXRvb2xzID0gc2FsZXNub3cuX19Ub29scyB8fCB0b29sczsKCQkJZGVsZXRlIHNhbGVzbm93Ll9fVG9vbHM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2xvYWRUb29scycsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJfQoKCQl0b29scy5maWx0ZXIodCA9PiB0eXBlb2YodC5hY3RpdmUpID09PSAidW5kZWZpbmVkIiB8fCAodHlwZW9mKHQuYWN0aXZlKSA9PT0gInVuZGVmaW5lZCIgJiYgdC5hY3RpdmUpKS5mb3JFYWNoKHQgPT4gewoJCQl0Lm5hbWUgPSB0Lm5hbWUgfHwgdC50eXBlLm5hbWU7CgoJCQl0LmFjdGl2ZSA9IHR5cGVvZih0LmFjdGl2ZSkgIT09ICd1bmRlZmluZWQnID8gdC5hY3RpdmUgOiB0cnVlOwoJCQl0LmVuYWJsZWQgPSB0eXBlb2YodC5lbmFibGVkKSAhPT0gJ3VuZGVmaW5lZCcgPyB0LmVuYWJsZWQgOiB0cnVlOwoJCQl0LnR5cGUuYWN0aXZlID0gdHlwZW9mKHQudHlwZS5hY3RpdmUpICE9PSAndW5kZWZpbmVkJyA/IHQudHlwZS5hY3RpdmUgOiB0cnVlOwoJCQl0LnR5cGUuZW5hYmxlZCA9IHR5cGVvZih0LnR5cGUuZW5hYmxlZCkgIT09ICd1bmRlZmluZWQnID8gdC50eXBlLmVuYWJsZWQgOiB0cnVlOwoKCQkJdC50b29sX0NvbmZpZ3MgPSB0LnRvb2xfQ29uZmlncyB8fCBbXTsKCQkJdC50b29sX0NvbmZpZ3MuZm9yRWFjaChjID0+IHsKCQkJCWMuYWN0aXZlID0gdHlwZW9mKGMuYWN0aXZlKSAhPT0gJ3VuZGVmaW5lZCcgPyBjLmFjdGl2ZSA6IHRydWU7CgkJCQljLmVuYWJsZWQgPSB0eXBlb2YoYy5lbmFibGVkKSAhPT0gJ3VuZGVmaW5lZCcgPyBjLmVuYWJsZWQgOiB0cnVlOwoJCQl9KTsKCgkJCXQudHlwZS50eXBlX01hcHBpbmdzID0gdC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW107CgkJCXQudHlwZS50eXBlX01hcHBpbmdzLmZvckVhY2gobSA9PiB7CgkJCQltLmFjdGl2ZSA9IHR5cGVvZihtLmFjdGl2ZSkgIT09ICd1bmRlZmluZWQnID8gbS5hY3RpdmUgOiB0cnVlOwoJCQkJbS5lbmFibGVkID0gdHlwZW9mKG0uZW5hYmxlZCkgIT09ICd1bmRlZmluZWQnID8gbS5lbmFibGVkIDogdHJ1ZTsKCQkJCW0udHlwZSA9IHsKCQkJCQluYW1lOiB0LnR5cGUubmFtZQoJCQkJfTsKCQkJfSk7CgoJCQl0LnRvb2xfTWFwcGluZ3MgPSB0LnRvb2xfTWFwcGluZ3MgfHwgW107CgkJCXQudG9vbF9NYXBwaW5ncy5mb3JFYWNoKG0gPT4gewoJCQkJbS5hY3RpdmUgPSB0eXBlb2YobS5hY3RpdmUpICE9PSAndW5kZWZpbmVkJyA/IG0uYWN0aXZlIDogdHJ1ZTsKCQkJCW0uZW5hYmxlZCA9IHR5cGVvZihtLmVuYWJsZWQpICE9PSAndW5kZWZpbmVkJyA/IG0uZW5hYmxlZCA6IHRydWU7CgkJCQltLnRvb2wgPSB7CgkJCQkJbmFtZTogdC5uYW1lCgkJCQl9OwoJCQl9KTsKCQl9KTsKCgkJdG9vbHMuZm9yRWFjaCh0ID0+IHQudG9vbF9Db25maWdzID0gdC50b29sX0NvbmZpZ3MuZmlsdGVyKGMgPT4gdHlwZW9mKGMudmFsdWUpICE9PSAib2JqZWN0IikuY29uY2F0KHQudG9vbF9Db25maWdzLmZpbHRlcihjID0+IHR5cGVvZihjLnZhbHVlKSA9PT0gIm9iamVjdCIpLm1hcChjID0+IE9iamVjdC5rZXlzKGMudmFsdWUpLm1hcChuY29kZSA9PiB7CgkJCWxldCBfYyA9IHsKCQkJCW5hbWU6IGMubmFtZSwKCQkJCXZhbHVlOiBjLnZhbHVlW25jb2RlXSwKCQkJfTsKCQkJaWYgKG5jb2RlICE9ICJkZWZhdWx0IikgewoJCQkJX2Mubm9kZSA9IHsKCQkJCQljb2RlOiBuY29kZSwKCQkJCQlhY3RpdmU6IHRydWUsCgkJCQkJZW5hYmxlZDogZmFsc2UsIC8vIG90aGVyd2lzZSBpdCBzdGFydHMgZ2V0dGluZyBldmVudHMKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6ICJOb2RlSlMiLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJcmV0dXJuIF9jOwoJCX0pLmZsYXQoKSkuZmxhdCgpKSk7CgoJCXRvb2xzLmZvckVhY2godCA9PiB0LnRvb2xfQ29uZmlncy5mb3JFYWNoKGMgPT4gYy52YWx1ZSA9IEpTT04uc3RyaW5naWZ5KGMudmFsdWUpKSk7CgoJCXRvb2xzID0gdG9vbHMuZmlsdGVyKHQgPT4gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzSWtkcGRFaDFZaUpkYCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSkuZmluZChfdCA9PiAodHlwZW9mKF90KSA9PT0gJ3N0cmluZycgPyBfdCA6IF90Lm5hbWUpID09IHQubmFtZSkpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbG9hZFRvb2xzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBbJHtzb3VyY2V9XTogVG9vbHMgYXJlICR7dG9vbHMubGVuZ3RofWApOwoKCQlzYWxlc25vdy5Ub29scyA9IHRvb2xzOwoKCQlpZiAoc2FsZXNub3cuX25vZGUgJiYgYlN0b3JlKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19sb2FkVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNhdmluZyBUb29scyIsIHNhbGVzbm93Ll9ub2RlLmNvZGUoKSwgdGhpcy5fX2NvbmZpZygndHlwZScpKTsKCQkJZm9yIGF3YWl0IChjb25zdCB0IG9mIHRvb2xzKSB7CgkJCQl0LnRvb2xfTWFwcGluZ3MuZm9yRWFjaChtID0+IGRlbGV0ZSBtLnRvb2wpOwoJCQkJdC50eXBlLnR5cGVfTWFwcGluZ3MuZm9yRWFjaChtID0+IGRlbGV0ZSBtLnR5cGUpOwoKCQkJCWF3YWl0IG5ldyBzYWxlc25vdy5Ub29sKCkuX2Zyb21Eb2N1bWVudCh0KS5zdG9yZSgpOwoJCQl9CgkJfQoKCQlzYWxlc25vdy5Ub29scy5maWx0ZXIodCA9PiAhdC5heGlvcykuZm9yRWFjaCh0ID0+IHsKCQkJdC5heGlvcyA9IGF4aW9zLmNyZWF0ZSgpOwoJCQl0LmF4aW9zLmludGVyY2VwdG9ycy5yZXF1ZXN0LnVzZShhc3luYyBjb25maWcgPT4gewoJCQkJdHJ5IHsKCQkJCQlsZXQgdG9rZW5VcmkgPSB0aGlzLl9fY29uZmlnKCJvYXV0aC50b2tlbi51cmkiLCBudWxsLCB7CgkJCQkJCXRvb2w6IHQKCQkJCQl9KTsKCQkJCQlsZXQgcmVmcmVzaFVyaSA9IHRoaXMuX19jb25maWcoIm9hdXRoLnJlZnJlc2gudXJpIiwgbnVsbCwgewoJCQkJCQl0b29sOiB0CgkJCQkJfSk7CgkJCQkJbGV0IHRva2VuID0gdGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3Rva2VuIiwgbnVsbCwgewoJCQkJCQl0b29sOiB0LAoJCQkJCQlub2RlOiBzYWxlc25vdy5fbm9kZQoJCQkJCX0pOwoJCQkJCWlmICghY29uZmlnLmhlYWRlcnMuQXV0aG9yaXphdGlvbiAmJiBbdG9rZW5VcmksIHJlZnJlc2hVcmldLmluZGV4T2YoY29uZmlnLnVybCkgPCAwKSB7CgkJCQkJCWlmICghdG9rZW4gJiYgc2FsZXNub3cuX25vZGUpIHsKCgkJCQkJCQkvLyBjcmVhdGUgb3IgbG9hZCBhIG5ldyBvYXV0aCBzdGF0ZQoJCQkJCQkJdGhpcy5fX2NvbmZpZygib2F1dGguc3RhdGUiLCBudWxsLCB7CgkJCQkJCQkJdG9vbDogdCwKCQkJCQkJCQlub2RlOiBzYWxlc25vdy5fbm9kZSwKCQkJCQkJCQluZXdWYWx1ZTogc2FsZXNub3cuX25vZGUuSWQKCQkJCQkJCX0pOwoJCQkJCQkJbGV0IGF1dGhVcmkgPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hdXRob3JpemUudXJpIiwgbnVsbCwgewoJCQkJCQkJCXRvb2w6IHQKCQkJCQkJCX0pOwoJCQkJCQkJaWYgKGF1dGhVcmkpIHsKCQkJCQkJCQkvLyBhdXRob3JpemUgYW5kIGdldCB0aGUgYXV0aCBjb2RlCgkJCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2xvYWRUb29scycsICdFbnRpdHlPYmplY3QnLCAwLCBhdXRoVXJpKTsKCQkJCQkJCQkvL2xldCBhdXRoUmV0ID0gd2luZG93Lm9wZW4oYXV0aFVyaSk7CgkJCQkJCQl9CgoJCQkJCQkJLy8gZ2V0IHRoZSB0b2tlbgoKCQkJCQkJfQoJCQkJCQljb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gdGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3R5cGUiLCAiQmVhcmVyIiwgewoJCQkJCQkJdG9vbDogdAoJCQkJCQl9KSArICIgIiArIHRva2VuOwoJCQkJCX0KCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2xvYWRUb29scycsICdFbnRpdHlPYmplY3QnLCAyLCAiYXhpb3MucmVxdWVzdCIsIGV4KTsKCQkJCX0KCQkJCXJldHVybiBjb25maWc7CgkJCX0sIGFzeW5jIGVycm9yID0+IHt9KTsKCQkJdC5heGlvcy5pbnRlcmNlcHRvcnMucmVzcG9uc2UudXNlKHJlc3BvbnNlID0+IHsKCQkJCXJldHVybiByZXNwb25zZTsKCQkJfSwgYXN5bmMgZXJyb3IgPT4gewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2xvYWRUb29scycsICdFbnRpdHlPYmplY3QnLCAwLCAiYXhpb3MgcmVzcG9uc2UgZXJyb3IiLCBlcnJvcik7CgkJCQl0cnkgewoJCQkJCWNvbnN0IG9yaWdpbmFsUmVxdWVzdCA9IGVycm9yLmNvbmZpZzsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3Rva2VuIiwgbnVsbCwgewoJCQkJCQkJdG9vbDogdAoJCQkJCQl9KSAmJiBlcnJvci5yZXNwb25zZSAmJiBlcnJvci5yZXNwb25zZS5zdGF0dXMgPT09IDQwMSAmJiAhb3JpZ2luYWxSZXF1ZXN0Ll9yZXRyeSAmJiBvcmlnaW5hbFJlcXVlc3QuaGVhZGVycy5BdXRob3JpemF0aW9uLmluZGV4T2YodGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3Rva2VuIiwgbnVsbCwgewoJCQkJCQkJdG9vbDogdAoJCQkJCQl9KSkgPiAwKSB7CgkJCQkJCW9yaWdpbmFsUmVxdWVzdC5fcmV0cnkgPSB0cnVlOwoJCQkJCQkvLyBhd2FpdCAoZ2V0IHRoZSB0b2tlbiBvciByZWZyZXNoIGl0KQoKCQkJCQkJb3JpZ2luYWxSZXF1ZXN0LmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190eXBlIiwgIkJlYXJlciIsIHsKCQkJCQkJCXRvb2w6IHQKCQkJCQkJfSkgKyAiICIgKyB0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdG9rZW4iLCBudWxsLCB7CgkJCQkJCQl0b29sOiB0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gdC5heGlvcyhvcmlnaW5hbFJlcXVlc3QpOwoJCQkJCX0KCQkJCQlyZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbG9hZFRvb2xzJywgJ0VudGl0eU9iamVjdCcsIDIsICJSZXNwIEludGVyY2VwdG9yIiwgZXgsIGVycm9yKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgoJCXJldHVybiB0b29sczsKCgl9CgoJX19zeW5jX29uKGQpIHsKCQl0aGlzLl9fX3N5bmNfb24gPSB0aGlzLl9fX3N5bmNfb24gfHwge307CgoJCWlmIChkKSB7CgkJCXRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV0gPSBkOwoKCQkJaWYgKHRoaXMuX2RlcGFydG1lbnRfc2V0ICYmIHRoaXMuZGVwYXJ0bWVudCgpKSB0aGlzLmRlcGFydG1lbnQoKS5fX3N5bmNfb24oZCk7CgoJCQkvLyB0aGlzLm1hbmFnZXJfVXNlcnMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJLy8gdGhpcy5jYWxsZXJfVXNlcnMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJLy8gdGhpcy5jb250YWN0X1VzZXJzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCS8vIHRoaXMudXNlcl9Vc2VycygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIodGhpcy5JZCkKCgkJCS51c2VybmFtZSh0aGlzLnVzZXJuYW1lKCksIHRoaXMuX3VzZXJuYW1lX2Nvb3ApCgoJCQkucGFzc3dvcmQodGhpcy5wYXNzd29yZCgpLCB0aGlzLl9wYXNzd29yZF9jb29wKQoKCQkJLmRlcGFydG1lbnQodGhpcy5kZXBhcnRtZW50KCksIHRoaXMuX2RlcGFydG1lbnRfY29vcCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkubWFuYWdlcl9EZXBhcnRtZW50cyh0aGlzLm1hbmFnZXJfRGVwYXJ0bWVudHMoKSwgdGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50c19jb29wKQoKCQkJLmNhbGxlcl9JbmNpZGVudHModGhpcy5jYWxsZXJfSW5jaWRlbnRzKCksIHRoaXMuX2NhbGxlcl9JbmNpZGVudHNfY29vcCkKCgkJCS5jb250YWN0X0luY2lkZW50cyh0aGlzLmNvbnRhY3RfSW5jaWRlbnRzKCksIHRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX2Nvb3ApCgoJCQkudXNlcl9Hcm91cF9NZW1iZXJzKHRoaXMudXNlcl9Hcm91cF9NZW1iZXJzKCksIHRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCW9ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdVc2VyJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgoJCXRyeSB7CgkJCWlmIChBcnJheS5pc0FycmF5KG9iakZyb20pKSByZXR1cm4gb2JqRnJvbS5tYXAobyA9PiB0aGlzLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG8sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpKTsKCgkJCWxldCBzRmllbGQgPSBiUmV2ZXJzZSA/ICd0YXJnZXQnIDogJ3NvdXJjZSc7CgkJCWxldCBzU2NyaXB0ID0gKGJSZXZlcnNlID8gJ291dCcgOiAnaW4nKSArICdTY3JpcHQnOwoJCQlsZXQgdEZpZWxkID0gYlJldmVyc2UgPyAnc291cmNlJyA6ICd0YXJnZXQnOwoJCQlsZXQgdFNjcmlwdCA9IChiUmV2ZXJzZSA/ICdpbicgOiAnb3V0JykgKyAnU2NyaXB0JzsKCgkJCWxldCBfbWF0Y2ggPSAocywgcikgPT4gewoJCQkJbGV0IHNjcmlwdCA9IGBcYCR7c31cYD09XGAke3J9XGAgfHwgXGAke3N9XGAubWF0Y2goLyR7cn0vZylgOwoJCQkJbGV0IGFuc3dlciA9IG51bGw7IC8vdGhpcy5ydW5TY3JpcHQoc2NyaXB0KTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnX21hcCcsICdFbnRpdHlPYmplY3QnLCAwLCBzY3JpcHQsIGFuc3dlcik7CgkJCQlyZXR1cm4gKGFuc3dlciAmJiBhbnN3ZXIubGVuZ3RoKSA/IHRydWUgOiBmYWxzZTsKCQkJfQoKCQkJbGV0IHRlc3QgPSBtID0+ICh7CgkJCQl2YWxpZDogbS5hY3RpdmUgJiYgbS5lbmFibGVkLAoJCQkJY29udGV4dDogX21hdGNoKGNvbnRleHQsIG0uY29udGV4dCksCgkJCQljbGFzczogX21hdGNoKGNsYXNzTmFtZSwgbS5jbGFzc05hbWUpLAoJCQkJc0ZpZWxkOiB0eXBlb2YoY29kZSkgPT09ICd1bmRlZmluZWQnIHx8IF9tYXRjaChjb2RlLCBtW3NGaWVsZF0pLAoJCQkJc1NjcmlwdDogdHlwZW9mKGNvZGUpID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YobVtzU2NyaXB0XSkgIT09ICd1bmRlZmluZWQnLAoJCQkJdGFyZ2V0OiAobVt0RmllbGRdIHx8IG1bdFNjcmlwdF0pICE9IG51bGwsCgkJCQl0ZXh0OiBjb2RlICsgJywnICsgc0ZpZWxkICsgJywnICsgdEZpZWxkLAoJCQl9KTsKCgkJCWxldCBtcyA9ICh0b29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0b29sLnR5cGUudHlwZV9NYXBwaW5ncyB8fCBbXSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWFwJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2NsYXNzTmFtZX0uJHtjb2RlfWAsIHRoaXMuX2JlYXV0aWZ5KG1zLm1hcChtID0+ICh7CgkJCQltLAoJCQkJdGVzdDogdGVzdChtKQoJCQl9KSksICdqYXZhc2NyaXB0JykpOwoJCQltcyA9IG1zLmZpbHRlcihtID0+IHRlc3QobSkudmFsaWQgJiYgdGVzdChtKS5jb250ZXh0ICYmIHRlc3QobSkuY2xhc3MgJiYgKHRlc3QobSkuc0ZpZWxkIHx8IHRlc3QobSkuc1NjcmlwdCkgJiYgdGVzdChtKS50YXJnZXQpLnNvcnQobSA9PiAtbS5vcmRlcik7CgoJCQltcy5maWx0ZXIobSA9PiBtW3NGaWVsZF0gJiYgbVt0RmllbGRdKS5mb3JFYWNoKG0gPT4gewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hcCcsICdFbnRpdHlPYmplY3QnLCAwLCBgWyR7Y29udGV4dH1dLyR7Y2xhc3NOYW1lfS4ke2NvZGV9OiAke21bc0ZpZWxkXX0gPT4gJHttW3RGaWVsZF19YCk7CgkJCQlpZiAobS5jb250ZXh0ID09ICdFbnRpdHlDbGFzcycpIHt9IGVsc2UgewoJCQkJCURvdE9iamVjdC5jb3B5KG1bc0ZpZWxkXSwgbVt0RmllbGRdLCBvYmpGcm9tLCBvYmpUbyk7CgkJCQl9CgkJCX0pOwoJCQltcy5maWx0ZXIobSA9PiBtW3NTY3JpcHRdIHx8IG1bdFNjcmlwdF0pLmZvckVhY2gobSA9PiB7CgkJCQlbJ3NTY3JpcHQnLCAndFNjcmlwdCddLmZvckVhY2goc05hbWUgPT4gdGhpcy5fU2NyaXB0KHRoaXMucnVuU2NyaXB0KGBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgc2NvcGUsIG1ldGhvZCwgX3RoaXMsIG9iakZyb20sIG9ialRvLCBjb2RlKSA9PiB7JHttW3NOYW1lXX19YCksIHNOYW1lLCAnTWFwcGluZycsIHNhbGVzbm93LCBtLCBvYmpGcm9tLCBvYmpUbywgY29kZSkpOwoJCQl9KTsKCgkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnX21hcCcsICdFbnRpdHlPYmplY3QnLCAwLCBgWyR7Y29udGV4dH1dLyR7Y2xhc3NOYW1lfS4ke2NvZGV9OiByZXN1bHRgLCBvYmpGcm9tLCBvYmpUbyk7CgoJCQlpZiAodHlwZW9mKGNvZGUpID09PSAndW5kZWZpbmVkJykgewoJCQkJcmV0dXJuIG9ialRvOwoJCQl9CgoJCQlpZiAobXMubGVuZ3RoICYmIG1zWzBdW3RGaWVsZF0pIHsKCQkJCXJldHVybiB0aGlzLnJ1blNjcmlwdChgXGAke2NvZGV9XGAucmVwbGFjZSgvJHttc1swXVtzRmllbGRdfS9nLCBcYCR7bXNbMF1bdEZpZWxkXX1cYClgKTsKCQkJCS8vcmV0dXJuIG1zWzBdW3RGaWVsZF07CgkJCX0KCQkJcmV0dXJuIGNvZGU7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hcCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiVXNlciI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgkJCQlyZXQgPSByZXQudG9Mb3dlckNhc2UoKTsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucyA9IHt9KSB7CgkJdHJ5IHsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sID8gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IG9wdGlvbnMudG9vbCB8fCB0ID09IG9wdGlvbnMudG9vbCkgOiB0aGlzLlRvb2w7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCB8fCB7fTsKCgkJCWxldCBuSUQgPSBzYWxlc25vdy5fbm9kZSA/IHNhbGVzbm93Ll9ub2RlLmNvZGUoKSA6ICJkZWZhdWx0IjsKCgkJCWxldCByZXQgPSBudWxsVmFsdWU7CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldCA9IG51bGw7CgoJCQkvLyB0b29sX0NvbmZpZ3M6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gZG9uZQoJCQlsZXQgdGNvbmYgPSAob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgYy5ub2RlICYmIGMubm9kZS5jb2RlID09IG5JRCkuY29uY2F0KChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiAhYy5ub2RlKSk7CgkJCWlmICh0Y29uZi5sZW5ndGgpIHsKCQkJCXJldCA9IHRjb25mWzBdLnZhbHVlOwoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChqZXgpIHt9CgkJCX0KCgkJCS8vIG1vZGVsIENvbmZpZzogQ29uZmlnIGlzIGNsYXNzIGxldmVsLCBub2RlIG5vdCBwb3NzaWJsZSAtIHBlbmRpbmcKCQkJbGV0IG1jb25mID0gdGhpcy5Db25maWcgPyB0aGlzLkNvbmZpZ1tuXSA6IHVuZGVmaW5lZDsKCQkJaWYgKHR5cGVvZihtY29uZikgIT09ICJ1bmRlZmluZWQiKSByZXQgPSBtY29uZjsKCgkJCS8vIGNvbW1hbmQgbGluZTogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgZ2xvYmFsLm1pbmltaXN0KSB7CgkJCQlyZXQgPSBnbG9iYWwubWluaW1pc3QocHJvY2Vzcy5hcmd2LnNsaWNlKDIpKVtuXSB8fCByZXQ7CgkJCX0KCgkJCS8vIHJlcXVlc3Q6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlyZXQgPSB0aGlzLiRfUkVRVUVTVChuKSB8fCByZXQ7CgoJCQlpZiAob3B0aW9ucy5uZXdWYWx1ZSkgewoJCQkJbGV0IHRjID0gdGNvbmYubGVuZ3RoID8gdGNvbmZbMF0gOiB7fTsKCQkJCXRjLm5vZGUgPSB7CgkJCQkJY29kZTogb3B0aW9ucy5ub2RlLmNvZGUoKQoJCQkJfTsKCQkJCXRjLnZhbHVlID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJCXRjLm5hbWUgPSBuOwoJCQkJaWYgKCF0Y29uZi5sZW5ndGgpIHsKCQkJCQlvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLnB1c2godGMpOwoJCQkJfQoJCQkJcmV0ID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJfQoKCQkJLy8gY29uZmlnIHJlcGxhY2VtZW50CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3N0cmluZycpKHJldC5tYXRjaChuZXcgUmVnRXhwKGB7eyhbXn1dKyl9fWAsICJnIikpIHx8IFtdKS5mb3JFYWNoKG0gPT4gcmV0ID0gcmV0LnJlcGxhY2UobSwgdGhpcy5fX2NvbmZpZyhtLnJlcGxhY2UoJ3t7JywgJycpLnJlcGxhY2UoJ319JywgJycpLCBudWxsLCBvcHRpb25zKSkpOwoKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2NvbmZpZycsICdFbnRpdHlPYmplY3QnLCAxLCBuLCBudWxsVmFsdWUsIG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MsIGV4KTsKCQl9Cgl9CgoJLyoqCgkgKiBTdW1tYXJ5LiBpbml0LgoJICoKCSAqIERlc2NyaXB0aW9uLiAuCgkgKgoJICogQHNpbmNlICAgICAgeC54LngKCSAqIEBkZXByZWNhdGVkIHgueC54IFVzZSBuZXdfZnVuY3Rpb25fbmFtZSgpIGluc3RlYWQuCgkgKiBAYWNjZXNzICAgICBwdWJsaWMKCSAqCgkgKiBAY2xhc3MKCSAqIEBhdWdtZW50cyBwYXJlbnQKCSAqIEBtaXhlcyAgICBtaXhpbgoJICoKCSAqIEBhbGlhcyAgICByZWFsTmFtZQoJICogQG1lbWJlcm9mIG5hbWVzcGFjZQoJICoKCSAqIEBzZWUgIEZ1bmN0aW9uL2NsYXNzIHJlbGllZCBvbgoJICogQGxpbmsgVVJMCgkgKiBAZ2xvYmFsCgkgKgoJICogQGZpcmVzICAgZXZlbnROYW1lCgkgKiBAZmlyZXMgICBjbGFzc05hbWUjZXZlbnROYW1lCgkgKiBAbGlzdGVucyBldmVudDpldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGNsYXNzTmFtZX5ldmVudDpldmVudE5hbWUKCSAqIEBwYXJhbSB7dHlwZX0gICB2YXIgICAgICAgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXJdICAgICAgICAgRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUuCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcj1kZWZhdWx0XSBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZSB3aXRoIGRlZmF1bHQgdmFyaWFibGUuCgkgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0VmFyICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBvYmplY3RWYXIua2V5IERlc2NyaXB0aW9uIG9mIGEga2V5IGluIHRoZSBvYmplY3RWYXIgcGFyYW1ldGVyLgoJICoKCSAqIEB5aWVsZCB7dHlwZX0gWWllbGRlZCB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqCgkgKiBAcmV0dXJuIHt0eXBlfSBSZXR1cm4gdmFsdWUgZGVzY3JpcHRpb24uCgkgKi8KCWFzeW5jIGluaXQoKSB7CgoJCWxldCBhbnN3ZXIgPSBudWxsOwoKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbml0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluaXQiLCBfbm9kZSwgKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbml0IiwgKSA9PiB7CgoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuVXNlci5pbml0Jyk7CgoJCQl2YXIgZXJyb3JzID0gewoKCQkJCSIwMSI6ICgoKSA9PiB7CgoJCQkJCWxldCBhbnN3ZXIgPQoKCQkJCQkJdHlwZW9mKHdpbmRvdykgPT09ICd1bmRlZmluZWQnCgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnaW5pdCcsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgIjAxIiwgYW5zd2VyKTsKCQkJCQlyZXR1cm4gYW5zd2VyOwoJCQkJfSkoKSA/ICgnTm90IHJ1bm5pbmcgaW4gYSBicm93c2VyJyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luaXQnLCAnRW50aXR5T2JqZWN0JywgMCwgewoJCQkJCQlba106IGVycm9yc1trXQoJCQkJCX0pOwoJCQkJCWRlbGV0ZSBlcnJvcnNba107CgkJCQl9KTsKCQkJCWlmIChPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIHsKCQkJCQkJX19leGNlcHRpb246IGVycm9ycywKCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlsb2coYXdhaXQgbmV3IG9TY29wZS5Vc2VyKCcxMjMnLCAnR2l0SHViJykubmFtZSgic29tZSB1c2VyIikuZGF0ZSh0aGlzLnNyKCkuc2VydmVyRGF0ZSgpKS5zdG9yZSgpKTsKCQkJLy8gbG9nKGF3YWl0IHRoaXMuVG9vbC5heGlvcy5wb3N0KCJodHRwczovL3dlYmhvb2suc2l0ZS82YzYxMjQ5Zi1lNzU1LTQyY2ItYWVjMC03YTI2OTYyODQwYjIiKSkKCQkJLy9hd2FpdCB0aGlzLl9hdXRob3JpemUobnVsbCwgbnVsbCwgdHJ1ZSk7CgoJCQkvKmxvZyhKU09OLnN0cmluZ2lmeShuZXcgb1Njb3BlLk5vZGUobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHtfY29kZV86ICcxMjMnfSwgdHJ1ZSwgdHJ1ZSkuX3RvRG9jdW1lbnQodHJ1ZSksIG51bGwsIDQpKSovCgoJCQkvL2xvZyhhd2FpdCB0aGlzLmJ5Q29kZSh0aGlzLlRlc3RbJ19hdXRob3JpemUudXNlcm5hbWUnXSkpOwoKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdLAoJCX0pOwoKCQkvLyB0YWtlIG91dCB0aGUgaW52YWxpZCBub2RlIHJlc3VsdHMKCQlyZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByICYmIHIucmV0KTsKCgkJLy8gaGFzIGFueSBub2RlIGdlbmVyYXRlZCBhIHZhbGlkYXRpb24gZXhjZXB0aW9uPwoJCWxldCBfX2V4ID0gcmVzdWx0cy5maW5kKHIgPT4gci5yZXQuX19leGNlcHRpb24pOwoJCWlmIChfX2V4KSByZXR1cm4gX19leC5yZXQ7CgoJCXJldHVybiByZXN1bHRzLmxlbmd0aCA/IHJlc3VsdHNbMF0ucmV0IDogbnVsbDsKCgl9CgoJLyoqCgkgKiBTdW1tYXJ5LiBhdXRob3JpemUuCgkgKgoJICogRGVzY3JpcHRpb24uIC4KCSAqCgkgKiBAc2luY2UgICAgICB4LngueAoJICogQGRlcHJlY2F0ZWQgeC54LnggVXNlIG5ld19mdW5jdGlvbl9uYW1lKCkgaW5zdGVhZC4KCSAqIEBhY2Nlc3MgICAgIHB1YmxpYwoJICoKCSAqIEBjbGFzcwoJICogQGF1Z21lbnRzIHBhcmVudAoJICogQG1peGVzICAgIG1peGluCgkgKgoJICogQGFsaWFzICAgIHJlYWxOYW1lCgkgKiBAbWVtYmVyb2YgbmFtZXNwYWNlCgkgKgoJICogQHNlZSAgRnVuY3Rpb24vY2xhc3MgcmVsaWVkIG9uCgkgKiBAbGluayBVUkwKCSAqIEBnbG9iYWwKCSAqCgkgKiBAZmlyZXMgICBldmVudE5hbWUKCSAqIEBmaXJlcyAgIGNsYXNzTmFtZSNldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGV2ZW50OmV2ZW50TmFtZQoJICogQGxpc3RlbnMgY2xhc3NOYW1lfmV2ZW50OmV2ZW50TmFtZQoJICogQHBhcmFtIHt0eXBlfSAgIHZhciAgICAgICAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcl0gICAgICAgICBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyPWRlZmF1bHRdIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlIHdpdGggZGVmYXVsdCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3RWYXIgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIG9iamVjdFZhci5rZXkgRGVzY3JpcHRpb24gb2YgYSBrZXkgaW4gdGhlIG9iamVjdFZhciBwYXJhbWV0ZXIuCgkgKgoJICogQHlpZWxkIHt0eXBlfSBZaWVsZGVkIHZhbHVlIGRlc2NyaXB0aW9uLgoJICoKCSAqIEByZXR1cm4ge3R5cGV9IFJldHVybiB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqLwoJYXN5bmMgYXV0aG9yaXplKCkgewoKCQlsZXQgYW5zd2VyID0gbnVsbDsKCgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiYXV0aG9yaXplIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImF1dGhvcml6ZSIsIF9ub2RlLCApID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiYXV0aG9yaXplIiwgKSA9PiB7CgoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuVXNlci5hdXRob3JpemUnKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQkJIjAxIjogKCgpID0+IHsKCgkJCQkJbGV0IGFuc3dlciA9CgoJCQkJCQkhdGhpcy5fdXNlcm5hbWVfc2V0CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnYXV0aG9yaXplJywgJ0VudGl0eU9iamVjdCcsIDAsICJhbnN3ZXIiLCAiMDEiLCBhbnN3ZXIpOwoJCQkJCXJldHVybiBhbnN3ZXI7CgkJCQl9KSgpID8gKCdVc2VybmFtZSBub3QgU2V0JyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQkJIjAyIjogKCgpID0+IHsKCgkJCQkJbGV0IGFuc3dlciA9CgoJCQkJCQkhdGhpcy5fcGFzc3dvcmRfc2V0CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnYXV0aG9yaXplJywgJ0VudGl0eU9iamVjdCcsIDAsICJhbnN3ZXIiLCAiMDIiLCBhbnN3ZXIpOwoJCQkJCXJldHVybiBhbnN3ZXI7CgkJCQl9KSgpID8gKCdQYXNzd29yZCBub3QgU2V0JyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2F1dGhvcml6ZScsICdFbnRpdHlPYmplY3QnLCAwLCB7CgkJCQkJCVtrXTogZXJyb3JzW2tdCgkJCQkJfSk7CgkJCQkJZGVsZXRlIGVycm9yc1trXTsKCQkJCX0pOwoJCQkJaWYgKE9iamVjdC52YWx1ZXMoZXJyb3JzKS5sZW5ndGgpIHsKCQkJCQlyZXR1cm4gewoJCQkJCQlfX2V4Y2VwdGlvbjogZXJyb3JzLAoJCQkJCX07CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJCXJldHVybiBhd2FpdCB0aGlzLl9hdXRob3JpemUobnVsbCwgbnVsbCwgdHJ1ZSkKCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXSwKCQl9KTsKCgkJLy8gdGFrZSBvdXQgdGhlIGludmFsaWQgbm9kZSByZXN1bHRzCgkJcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gciAmJiByLnJldCk7CgoJCS8vIGhhcyBhbnkgbm9kZSBnZW5lcmF0ZWQgYSB2YWxpZGF0aW9uIGV4Y2VwdGlvbj8KCQlsZXQgX19leCA9IHJlc3VsdHMuZmluZChyID0+IHIucmV0Ll9fZXhjZXB0aW9uKTsKCQlpZiAoX19leCkgcmV0dXJuIF9fZXgucmV0OwoKCQlyZXR1cm4gcmVzdWx0cy5sZW5ndGggPyByZXN1bHRzWzBdLnJldCA6IG51bGw7CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncGFzc3dvcmQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICBgCgkJfTsKCQlyZXQuc3FsICs9ICcvKlVzZXIqLyk7XG4nOwoKCQlyZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiB0cnVlLAoJCQlOdWxsOiB0cnVlLAoJCQkvL0lkOiAob2JqLCB2KSA9PiBvYmouc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWWAsCgoJCQkidXNlcm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkicGFzc3dvcmQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncGFzc3dvcmQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncGFzc3dvcmQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZGVwYXJ0bWVudCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RlcGFydG1lbnQnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCW1hbmFnZXJfRGVwYXJ0bWVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdtYW5hZ2VyX1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJCWNhbGxlcl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYWxsZXJfVXNlcnMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQkJY29udGFjdF9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250YWN0X1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJCXVzZXJfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXJfVXNlcnMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypVc2VyKi8pO1xuJzsKCgkJcmV0LnNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQocmV0LnNxbCkgOiByZXQuc3FsOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TUUxUYWJsZScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQuc3FsKTsKCQlyZXR1cm4gcmV0LnNxbDsKCX0KCglfZnJvbVNRTFRhYmxlKHRhYmxlLCBmaWVsZHMpIHsKCQkvLyB0YWJsZSBpcyBhIGpzb24gYXJyYXkKCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInVzZXJuYW1lIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy51c2VybmFtZSh0YWJsZVsidXNlcm5hbWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicGFzc3dvcmQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnBhc3N3b3JkKHRhYmxlWyJwYXNzd29yZCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkZXBhcnRtZW50IikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5kZXBhcnRtZW50KHRhYmxlWyJkZXBhcnRtZW50Il0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuYWN0aXZlKHRhYmxlWyJhY3RpdmUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZW5hYmxlZCh0YWJsZVsiZW5hYmxlZCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5jb2RlKHRhYmxlWyJjb2RlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5vcmRlcih0YWJsZVsib3JkZXIiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZGF0ZSh0YWJsZVsiZGF0ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5uYW1lKHRhYmxlWyJuYW1lIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucmVtYXJrKHRhYmxlWyJyZW1hcmsiXSk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBfc3FsKHNxbCwgc291cmNlID0gdGhpcykgewoKCQlpZiAoIXRoaXMuVG9vbC5kYiB8fCAhc3FsIHx8ICFzcWwudHJpbSgpKSB7CgkJCWlmICghdGhpcy5Ub29sLmRiKSB0aGlzLmxvZyh1bmRlZmluZWQsICdfc3FsJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCwgIiA8PT1TS0lQUEVEPT0+Iik7CgkJCXJldHVybiBbXTsKCQl9CgoJCWlmIChzcWwuaW5kZXhPZignO1xuJykgPiAwKSB7CgkJCWZvciBhd2FpdCAoY29uc3Qgc3FsUyBvZiBzcWwuc3BsaXQoJztcbicpKSB7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsUy50cmltKCkpOwoJCQl9CgkJCXJldHVybjsKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQl0cnkgewoJCQlyZXQgPSBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CgkJCQlsZXQgX3Jlc29sdmUgPSAoX3JldCwgX3NxbCkgPT4gewoJCQkJCWlmIChfc3FsICYmIF9zcWwuaW5kZXhPZignc2VsZWN0JykgJiYgdGhpcy5Ub29sLl9fZG1sU3RhdGVtZW50cykgdGhpcy5Ub29sLl9fZG1sU3RhdGVtZW50cy5wdXNoKF9zcWwpOwoJCQkJCXJldHVybiByZXNvbHZlKF9yZXQpOwoJCQkJfQoKCQkJCWxldCBkYiA9IHRoaXMuVG9vbC5kYjsKCQkJCWxldCB0eXBlID0gdGhpcy5fX2NvbmZpZygndHlwZScpOwoKCQkJCWxldCBmdW4gPSAiIjsKCgkJCQkvLyBRdWVyeSBsaXN0IG9mIHN0YXRlbWVudCBzdGFydGluZyBrZXl3b3JkcyAgICAgICAgCgkJCQlsZXQgcUxpc3QgPSBbInNlbGVjdCIsICJpbnNlcnQiLCAidXBkYXRlIiwgImRlbGV0ZSJdOwoJCQkJaWYgKHRoaXMuX19jb25maWcoJ2RhdGFiYXNlLnRyYW5zYWN0aW9ucycsIHRydWUpKSB7CgkJCQkJcUxpc3QgPSBxTGlzdC5jb25jYXQoWyJiZWdpbiIsICJzdGFydCIsICJjb21taXQiXSk7CgkJCQl9CgkJCQlsZXQgYlF1ZXJ5ID0gcUxpc3QuaW5kZXhPZihzcWwuc3Vic3RyaW5nKDAsIHNxbC5pbmRleE9mKCcgJykpLnRyaW0oKS50b0xvd2VyQ2FzZSgpKSA+PSAwOwoKCQkJCWlmIChiUXVlcnkpIHsKCQkJCQkvLyBxdWVyeQoJCQkJCWlmICh0eXBlID09ICdteXNxbCcpIGZ1biA9ICdxdWVyeSc7CgkJCQkJaWYgKHR5cGUgPT0gJ3NxbGl0ZScpIGZ1biA9ICdhbGwnOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBETUwKCQkJCQlpZiAodHlwZSA9PSAnbXlzcWwnKSBmdW4gPSAncXVlcnknOwoJCQkJCWlmICh0eXBlID09ICdzcWxpdGUnKSBmdW4gPSAncnVuJzsKCgkJCQkJdGhpcy5Ub29sLmRtbENhY2hlID0gdGhpcy5Ub29sLmRtbENhY2hlIHx8IHt9OwoJCQkJCWlmICh0aGlzLlRvb2wuZG1sQ2FjaGVbdGhpcy5oYXNoQ29kZShzcWwpXSkgcmV0dXJuIF9yZXNvbHZlKDApOwoJCQkJCXRoaXMuVG9vbC5kbWxDYWNoZVt0aGlzLmhhc2hDb2RlKHNxbCldID0gc3FsOwoJCQkJfQoJCQkJaWYgKHR5cGUgPT0gJ3NxbGl0ZScgJiYgdHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnKSBmdW4gPSAiIjsKCQkJCWlmIChmdW4gJiYgIWRiW2Z1bl0pIGZ1biA9ICIiOwoKCQkJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3FsJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke3R5cGV9LiR7ZnVufWAsIHNxbCk7CgkJCQlpZiAoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5zcWxzLnB1c2goc3FsKTsKCgkJCQlpZiAoZnVuKSB7CgkJCQkJbGV0IHJldCA9IGRiW2Z1bl0oc3FsLCBbXSwgKGVycm9yLCByb3dzKSA9PiB7CgkJCQkJCWlmIChlcnJvcikgewoJCQkJCQkJcmVqZWN0KGVycm9yKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCV9yZXNvbHZlKHJvd3MsIHNxbCk7CgkJCQkJCX0KCQkJCQl9KTsKCQkJCX0gZWxzZSBpZiAodHlwZSA9PSAnc25vd2ZsYWtlJykgewoJCQkJCXRoaXMuVG9vbC5kYi5leGVjdXRlKHsKCQkJCQkJc3FsVGV4dDogc3FsLAoJCQkJCQljb21wbGV0ZTogZnVuY3Rpb24oZXJyLCBzdG10LCByb3dzKSB7CgkJCQkJCQlpZiAoZXJyKSB7CgkJCQkJCQkJcmVqZWN0KGVycik7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCV9yZXNvbHZlKHJvd3MsIHNxbCk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQl9KTsKCQkJCX0gZWxzZSBpZiAodHlwZSA9PSAnc3FsaXRlJykgewoJCQkJCS8vIHNxbGl0ZSBpbiB0aGUgYnJvd3NlcgoJCQkJCXRyeSB7CgkJCQkJCWxldCByZXQgPSBudWxsOwoJCQkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnICYmIGJRdWVyeSAmJiBzb3VyY2UgJiYgIXNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChfYyA9PiBfYy5OYW1lID09IHNvdXJjZS5FbnRpdHlDbGFzcy5OYW1lKS5FbnRpdHlNb2R1bGUgJiYgdGhpcy5fX2NvbmZpZygnc3FsTm9kZScpKSB7CgkJCQkJCQl0aGlzLl9pbnZva2VOb2RlKG5ldyBzYWxlc25vdy5Ob2RlKCkuYWRkcmVzcyh0aGlzLl9fY29uZmlnKCdzcWxOb2RlJykpLCAicnVuU1FMIiwgewoJCQkJCQkJCXNxbDogc3FsLAoJCQkJCQkJCWRhdGFiYXNlOiAic2FsZXNub3ciCgkJCQkJCQl9KS50aGVuKHNyZXQgPT4gewoJCQkJCQkJCV9yZXNvbHZlKHNyZXQsIHNxbCk7CgkJCQkJCQl9KTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXJldCA9IGRiLmV4ZWMoc3FsKTsKCQkJCQkJCWlmICghcmV0IHx8ICFyZXQubGVuZ3RoKSByZXR1cm4gX3Jlc29sdmUocmV0LCBzcWwpOwoKCQkJCQkJCXJldCA9IHJldFswXS52YWx1ZXMubWFwKHIgPT4gT2JqZWN0LmZyb21FbnRyaWVzKG5ldyBNYXAocmV0WzBdLmNvbHVtbnMubWFwKChjLCBpKSA9PiBbYywgcltpXV0pKSkpOwoJCQkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX3NxbCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCQkJCQkJX3Jlc29sdmUocmV0LCBzcWwpOwoJCQkJCQl9CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJcmVqZWN0KGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zcWwnLCAnRW50aXR5T2JqZWN0JywgMiwgYApFUlJPUjoKJHtleH0KCldoaWxlIFNlbmRpbmcgUXVlcnkgCiR7c3FsfQpgKTsKCQl9CgoJCS8vdGhpcyBpcyBub3QgZW5vdWdoLiBXZSBzZWxlY3Qgb3V0ZXIgam9pbnMsIHNvIHN1Yi1hdHRyaWJ1dGVzIHdpbGwgYmUgYWxzbyBudWxsLiBFaXRoZXIgcmVjdXJzaXZlIG9yIHRvIGlnbm9yZSB3aGVuIHVzZWQsIGZvciBleGFtcGxlIHRocm91Z2ggX3RvRG9jdW1lbnQKCQlmYWxzZSAmJiByZXQuZm9yRWFjaChyID0+IHsKCQkJT2JqZWN0LmtleXMocikuZm9yRWFjaChrID0+IHsKCQkJCWlmIChyW2tdID09IG51bGwpIGRlbGV0ZSByW2tdOwoJCQl9KTsKCQl9KTsKCgkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0Lm1hcChyID0+IERvdE9iamVjdC5vYmplY3QocikpOwoJCXJldHVybiByZXQ7CgoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQl0cnkgewoJCQlsZXQgY29uZmlnID0gewoJCQkJbWV0aG9kOiBjb250ZW50ID8gJ3B1dCcgOiAnZ2V0JywKCQkJCXVybDogdGhpcy5fX2NvbmZpZygndXJsJykgKyBmaWxlLAoJCQkJaGVhZGVyczogewoJCQkJCSdBY2NlcHQnOiAnYXBwbGljYXRpb24vdm5kLmdpdGh1Yitqc29uJywKCQkJCQknWC1HaXRIdWItQXBpLVZlcnNpb24nOiAnMjAyMi0xMS0yOCcsCgkJCQl9LAoJCQl9OwoJCQlpZiAoY29udGVudCkgewoJCQkJLy8gZmlyc3QgZ2V0IHRoZSBzaGEgb2YgdGhlIGZpbGUKCQkJCWlmICh0eXBlb2YoY29udGVudCkgPT09ICdvYmplY3QnKSBjb250ZW50ID0gSlNPTi5zdHJpbmdpZnkoY29udGVudCwgbnVsbCwgJ1x0Jyk7CgkJCQljb25maWcuZGF0YSA9IHsKCQkJCQltZXNzYWdlOiAiZGVwbG95ZWQgYnkgX2dpdGh1YigpIiwKCQkJCQljb250ZW50OiBgJHt0aGlzLl9idG9hKGNvbnRlbnQpfWAKCQkJCX07CgoJCQkJbGV0IGYgPSBhd2FpdCB0aGlzLl9naXRodWIoZmlsZSk7CgkJCQlpZiAoZikgY29uZmlnLmRhdGEuc2hhID0gZi5zaGE7CgoJCQkJY29uZmlnLmRhdGEgPSBKU09OLnN0cmluZ2lmeShjb25maWcuZGF0YSk7CgkJCX0gZWxzZSB7CgkJCQljb25maWcudmFsaWRhdGVTdGF0dXMgPSBzdGF0dXMgPT4gc3RhdHVzIDwgNTAwOwoJCQl9CgkJCWxldCByZXQgPSBhd2FpdCB0aGlzLlRvb2wuYXhpb3MoY29uZmlnKTsKCQkJcmV0ID0gcmV0ID8gcmV0LmRhdGEgOiBudWxsOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZ2l0aHViJywgJ0VudGl0eU9iamVjdCcsIDAsIGZpbGUsIGNvbmZpZy5tZXRob2QsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2dpdGh1YicsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJCQkvLyBpZih0aGlzWydfJytmaWVsZCsnX3NldCddICYmICh0eXBlb2YodGhpc1snXycrZmllbGRdKT09PSd1bmRlZmluZWQnIHx8IHRoaXNbJ18nK2ZpZWxkXT09bnVsbCkpIHJldHVybjsKCQkJCQkvLyBpZih0eXBlb2YoZWFPYmopPT09J3VuZGVmaW5lZCcpIHJldHVybjsgLy8gd2h5PwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJ1c2VybmFtZSIsIG9iaiwgdGhpcy51c2VybmFtZSgpKTsKCgkJX29wdGlvbnMoInBhc3N3b3JkIiwgb2JqLCB0aGlzLnBhc3N3b3JkKCkpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgImY1ODdkYmE0LTcxYjUtNDRlMS1hNDJjLTU1N2Y1MGEzNzE1NSIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVXNlcltmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiBvYmosCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIG9iaiwgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIl9USElTIiwgb2JqLCB0aGlzLl9USElTKTsKCgkJaWYgKCF0aGlzLmRlcGFydG1lbnQoKSB8fCAodGhpcy5kZXBhcnRtZW50KCkKCgkJCQkmJgoJCQkJIXRoaXMuZGVwYXJ0bWVudCgpLmRlcGFydG1lbnRfVXNlcnMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoImRlcGFydG1lbnQiLCBvYmosIHRoaXMuZGVwYXJ0bWVudCgpKTsKCQl9CgoJCV9vcHRpb25zKCJtYW5hZ2VyX0RlcGFydG1lbnRzIiwgb2JqLCB0aGlzLm1hbmFnZXJfRGVwYXJ0bWVudHMoKSk7CgoJCV9vcHRpb25zKCJjYWxsZXJfSW5jaWRlbnRzIiwgb2JqLCB0aGlzLmNhbGxlcl9JbmNpZGVudHMoKSk7CgoJCV9vcHRpb25zKCJjb250YWN0X0luY2lkZW50cyIsIG9iaiwgdGhpcy5jb250YWN0X0luY2lkZW50cygpKTsKCgkJX29wdGlvbnMoInVzZXJfR3JvdXBfTWVtYmVycyIsIG9iaiwgdGhpcy51c2VyX0dyb3VwX01lbWJlcnMoKSk7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ3VzZXJuYW1lJywgJ3Bhc3N3b3JkJywgJ2RlcGFydG1lbnQnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ21hbmFnZXJfRGVwYXJ0bWVudHMnLCAnY2FsbGVyX0luY2lkZW50cycsICdjb250YWN0X0luY2lkZW50cycsICd1c2VyX0dyb3VwX01lbWJlcnMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIlVzZXIiICYmIChtLnRhcmdldCB8fCBtLm91dFNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSAmJiAoIW0uc291cmNlIHx8IChtLnNvdXJjZSAmJiAvKiFtLm91dFNjcmlwdCAmJiovIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX3NldCddKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5vdXRTY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMsIG9TY29wZSwgbWFwKSA9PiB7JHttLm91dFNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLm91dFNjcmlwdH0pfWApKHRoaXMsIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnNvdXJjZSkgewoJCQkJaWYgKG0uc291cmNlLmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcykgPT4ge3JldHVybiBfdGhpcy4ke20uc291cmNlfTt9YCkodGhpcyk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnNvdXJjZSwgdGhpcyk7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0udGFyZ2V0KSBvYmpbbS50YXJnZXRdID0gcmV0OwoJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQlbbS50YXJnZXQgfHwgbS5zb3VyY2VdOiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10KCQkJfSk7CgkJfSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJLy8gdXNlIHRoaXMuX21hcCgpIHdpdGggcmV2ZXJzZQoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygidXNlcm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicGFzc3dvcmQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJmNTg3ZGJhNC03MWI1LTQ0ZTEtYTQyYy01NTdmNTBhMzcxNTUiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVXNlciA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVXNlciB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVXNlcltmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoImRlcGFydG1lbnQiLCBvYmopOwoKCQlfb3B0aW9ucygibWFuYWdlcl9EZXBhcnRtZW50cyIsIG9iaik7CgoJCV9vcHRpb25zKCJjYWxsZXJfSW5jaWRlbnRzIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvbnRhY3RfSW5jaWRlbnRzIiwgb2JqKTsKCgkJX29wdGlvbnMoInVzZXJfR3JvdXBfTWVtYmVycyIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ3VzZXJuYW1lJywgJ3Bhc3N3b3JkJywgJ2RlcGFydG1lbnQnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ21hbmFnZXJfRGVwYXJ0bWVudHMnLCAnY2FsbGVyX0luY2lkZW50cycsICdjb250YWN0X0luY2lkZW50cycsICd1c2VyX0dyb3VwX01lbWJlcnMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIlVzZXIiICYmIChtLnNvdXJjZSB8fCBtLmluU2NyaXB0KSAmJiBtLmFjdGl2ZSAmJiBtLmVuYWJsZWQgJiYgKChtLnRvb2wgJiYgbS50b29sLm5hbWUgPT0gdGhpcy5Ub29sLm5hbWUpIHx8IChtLnR5cGUgJiYgbS50eXBlLm5hbWUgPT0gdGhpcy5Ub29sLnR5cGUubmFtZSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0uaW5TY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAob2JqLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5pblNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLmluU2NyaXB0fSl9YCkob2JqLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS50YXJnZXQpIHsKCQkJCWlmIChtLnRhcmdldC5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAob2JqKSA9PiB7cmV0dXJuIG9iai4ke20udGFyZ2V0fTt9YCkob2JqKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKG9ialttLnRhcmdldF0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gb2JqW20udGFyZ2V0XSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnRhcmdldCwgb2JqKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gb2JqW20udGFyZ2V0XTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnNvdXJjZSkgewoJCQkJaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQl0aGlzW20uc291cmNlXShyZXQpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzW20uc291cmNlXSA9IHJldDsKCQkJCX0KCQkJfQoJCX0pOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9EQk9iamVjdChmaWVsZHMsIGJOb1JlZikgewoJCWlmICghdGhpcy5JZCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCAiSW52YWxpZCBJRCIsIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSwgdGhpcy5Ub29sKTsKCQl9CgkJbGV0IHJldCA9IHsKCQkJW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddOiAiJyIgKyB0aGlzLklkICsgIiciCgkJfTsKCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJ1c2VybmFtZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl91c2VybmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy51c2VybmFtZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJwYXNzd29yZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9wYXNzd29yZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5wYXNzd29yZCgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgncGFzc3dvcmQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkZXBhcnRtZW50IikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2RlcGFydG1lbnRfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmRlcGFydG1lbnQoKTsKCgkJCWlmICh2ICYmICh2Ll9fc3luY19vbigpIHx8IHYuSWQgPT0gdi5JZCkpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYuSWQgKyAiJyI7CgkJCX0gZWxzZSB7CgkJCQlmVmFsdWUgPSAwOwoJCQl9CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2RlcGFydG1lbnQnLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9hY3RpdmVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYWN0aXZlKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZW5hYmxlZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5lbmFibGVkKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvZGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29kZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2RhdGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZGF0ZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5uYW1lKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3JlbWFya19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5yZW1hcmsoKTsKCgkJCWZWYWx1ZSA9ICInIiArICgodiAmJiB2LnJlcGxhY2UpID8gdi5yZXBsYWNlKC9cJy9nLCAiXCdcJyIpIDogdikgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX1EoKSB7CgkJbGV0IF9vID0gJyInOwoJCWxldCBfcSA9IF9vOwoKCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXRoaXMuX19RID0gdGhpcy5fX1EgPT0gX28gPyBfcSA6IF9vOwoJCXJldHVybiB0aGlzLl9fUTsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcsIHRoaXMuX25Db2RlKCd1c2VybmFtZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdwYXNzd29yZCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKV07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnVzZXJuYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5wYXNzd29yZCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGVwYXJ0bWVudCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2RlcGFydG1lbnQnLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9YCk7CgoJCX0KCQlyZXR1cm4gZmllbGRzOwoJfQoKCV9mcm9tREJPYmplY3QociA9IHt9KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMuX19pbXBvcnQociwgewoJCQkJSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddLAoKCQkJCXVzZXJuYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy51c2VybmFtZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCXBhc3N3b3JkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncGFzc3dvcmQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5wYXNzd29yZChvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWRlcGFydG1lbnQ6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZGVwYXJ0bWVudChvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWFjdGl2ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmFjdGl2ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZW5hYmxlZChvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuY29kZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5vcmRlcihvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZGF0ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMubmFtZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnJlbWFyayhvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJfSwgIl9mcm9tREJPYmplY3QiKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX3RvU2VsZWN0SGVhZGVyKGZpZWxkcykgewoJCWxldCByZXQgPSB7CgkJCXRhYmxlOiB0aGlzLl9uQ29kZSgpLAoJCQlmaWVsZHM6IERvdE9iamVjdC5vYmplY3QoT2JqZWN0LmZyb21FbnRyaWVzKHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLm1hcChmID0+IFtmLCBmXSkpKSwKCQkJam9pbnM6IHt9LAoJCX07CgoJCWlmIChmaWVsZHMpIHJldHVybiByZXQ7CgoJCXJldC5qb2lucyA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJTnVsbDogdHJ1ZSwKCgkJCWRlcGFydG1lbnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSkgPT4gb2JqW2VhQ29kZV0gPSBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudCgpLl90b1NlbGVjdEhlYWRlcigpLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoJCXNxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsKCgkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpIHsKCQkJLy8ge2ZpZWxkOiBmdW5jdGlvbn0KCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnVzZXJuYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy51c2VybmFtZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMucGFzc3dvcmQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnBhc3N3b3JkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdwYXNzd29yZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kZXBhcnRtZW50KSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kZXBhcnRtZW50fSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJfQoKCQlzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7CgoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gYCk7CgoJCXNxbCArPSBgIHdoZXJlIDE9MWA7CgoJCXNxbCA9IHRoaXMuX19leHBvcnQoewoJCQlzcWw6IHNxbAoJCX0sIHsKCQkJX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSA/IFsnSWQnXSA6IHVuZGVmaW5lZCwKCQkJTnVsbDogdHJ1ZSwKCQkJX1RISVM6IG9iaiA9PiB7CgkJCQlpZiAoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKHQuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOwoJCQl9LAoJCQlJZDogb2JqID0+IG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwKCgkJCXVzZXJuYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3VzZXJuYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fdXNlcm5hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX3VzZXJuYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl91c2VybmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX3VzZXJuYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl91c2VybmFtZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJcGFzc3dvcmQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwYXNzd29yZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcGFzc3dvcmRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9wYXNzd29yZF9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fcGFzc3dvcmRfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX3Bhc3N3b3JkX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fcGFzc3dvcmRfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX3Bhc3N3b3JkX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkZXBhcnRtZW50OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGVwYXJ0bWVudF9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX2RlcGFydG1lbnRfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvZGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2RhdGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVtYXJrX3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQltYW5hZ2VyX0RlcGFydG1lbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbWFuYWdlcl9Vc2VycycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50c19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoIm1hbmFnZXIuaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50c19jb29wID09ICc9JyB8fCB0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50c19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLyptYW5hZ2VyX0RlcGFydG1lbnRzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQkJY2FsbGVyX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhbGxlcl9Vc2VycycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY2FsbGVyX0luY2lkZW50c19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoImNhbGxlci5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fY2FsbGVyX0luY2lkZW50c19jb29wID09ICchPScgfHwgdGhpcy5fY2FsbGVyX0luY2lkZW50c19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9jYWxsZXJfSW5jaWRlbnRzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX2NhbGxlcl9JbmNpZGVudHNfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl9jYWxsZXJfSW5jaWRlbnRzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKmNhbGxlcl9JbmNpZGVudHMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCQljb250YWN0X0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRhY3RfVXNlcnMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX3NldCkgcmV0dXJuOwoKCQkJCWxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCgiY29udGFjdC5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fY29udGFjdF9JbmNpZGVudHNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX2Nvb3AgPT0gJ05PVCBJTicpIHsKCQkJCQlpbk9QID0gJ05PVCBJTic7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fY29udGFjdF9JbmNpZGVudHNfY29vcCA9PSAnPT0nKSB7CgkJCQkJak9QID0gJ0lOVEVSU0VDVCc7CgkJCQl9CgoJCQkJb2JqLnNxbCArPSBgYW5kIC8qY29udGFjdF9JbmNpZGVudHMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCQl1c2VyX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VyX1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJ1c2VyLmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfY29vcCA9PSAnPScgfHwgdGhpcy5fdXNlcl9Hcm91cF9NZW1iZXJzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fdXNlcl9Hcm91cF9NZW1iZXJzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKnVzZXJfR3JvdXBfTWVtYmVycyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJfSwgIl90b1NlbGVjdFNRTCIsIGZpZWxkcykuc3FsOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCWlmIChPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMudXNlcm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy51c2VybmFtZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5wYXNzd29yZCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdwYXNzd29yZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnBhc3N3b3JkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRlcGFydG1lbnQpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZGVwYXJ0bWVudH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWR9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuY29kZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMubmFtZX1gOwoKCQl9CgoJCWlmIChzcWwuZW5kc1dpdGgoIndoZXJlIDE9MSIpKSB7CgkJCS8vIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEiLCAid2hlcmUgMT0wIik7CgkJfSBlbHNlIHsKCQkJc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSBhbmQgIiwgIndoZXJlICIpOwoJCX0KCgkJc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpIDogc3FsOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoKCQlyZXR1cm4gc3FsOwoJfQoKCV90b1BhdGhzKCkgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCV9USElTOiBvYmogPT4ge30sCgoJCQlkZXBhcnRtZW50OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkpID0+IG9iai5kZXBhcnRtZW50ID0gdi5fdG9QYXRocygpLAoKCQkJbWFuYWdlcl9EZXBhcnRtZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXJfVXNlcnMnLCB1bmRlZmluZWQpKSA9PiBvYmoubWFuYWdlcl9EZXBhcnRtZW50cyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQkJY2FsbGVyX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhbGxlcl9Vc2VycycsIHVuZGVmaW5lZCkpID0+IG9iai5jYWxsZXJfSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCQljb250YWN0X0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRhY3RfVXNlcnMnLCB1bmRlZmluZWQpKSA9PiBvYmouY29udGFjdF9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJCXVzZXJfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXJfVXNlcnMnLCB1bmRlZmluZWQpKSA9PiBvYmoudXNlcl9Hcm91cF9NZW1iZXJzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuVXNlcikgcmV0dXJuOwoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5Vc2VyID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5Vc2VyKCkKCgkJCQkJLmRlcGFydG1lbnQobmV3IHNhbGVzbm93LkRlcGFydG1lbnQoKSkKCgkJCQkJLm1hbmFnZXJfRGVwYXJ0bWVudHMobmV3IHNhbGVzbm93LkRlcGFydG1lbnQoKSkKCgkJCQkJLmNhbGxlcl9JbmNpZGVudHMobmV3IHNhbGVzbm93LkluY2lkZW50KCkpCgoJCQkJCS5jb250YWN0X0luY2lkZW50cyhuZXcgc2FsZXNub3cuSW5jaWRlbnQoKSkKCgkJCQkJLnVzZXJfR3JvdXBfTWVtYmVycyhuZXcgc2FsZXNub3cuR3JvdXBfTWVtYmVyKCkpCgoJCQkJCS5fdG9TUUxUYWJsZShkZXB0aCk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXRyeSB7CgkJCWlmICghdG9vbCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnRFNDb25uZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJUb29sIGlzIG51bGwiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJCXJldHVybjsKCQkJfSBlbHNlIGlmICghdG9vbC50eXBlKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdEU0Nvbm5lY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIlRvb2wudHlwZSBpcyBudWxsIiwgdG9vbCwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCQlyZXR1cm47CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRvb2wuZGIpICE9PSAidW5kZWZpbmVkIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnRFNDb25uZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsICJUb29sIGFscmVhZHkgY29ubmVjdGVkISIpOwoJCQkJcmV0dXJuOwoJCQl9IGVsc2UgaWYgKHNhbGVzbm93Ll9ub2RlICYmIC8qc2FsZXNub3cuX25vZGUuX3BhcmVudF9zZXQgJiYgKi8gc2FsZXNub3cuX25vZGUucGFyZW50KCkuX3NhbWVOb2RlKHNhbGVzbm93Ll9ub2RlLnBhcmVudCgpKSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnRFNDb25uZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsICJOb2RlIGhhcyBhIHZhbGlkIHBhcmVudCwgbm8gbG9jYWwgU1FMIHBvc3NpYmxlIik7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICh0b29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiBnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHsKCQkJCQkJdG9vbDogdG9vbAoJCQkJCX0pXSkgewoJCQkJCWlmIChnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHsKCQkJCQkJCXRvb2w6IHRvb2wKCQkJCQkJfSldLkRhdGFiYXNlKSB7CgkJCQkJCXRvb2wuZGIgPSBuZXcgZ2xvYmFsW3RoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB0b29sKV0uRGF0YWJhc2UodGhpcy5fX2NvbmZpZygnZGF0YWJhc2UnLCBudWxsLCB7CgkJCQkJCQl0b29sOiB0b29sCgkJCQkJCX0pIHx8ICIuL3NhbGVzbm93LmRiIik7CgkJCQkJfSBlbHNlIGlmIChnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHsKCQkJCQkJCXRvb2w6IHRvb2wKCQkJCQkJfSldLmNyZWF0ZUNvbm5lY3Rpb24pIHsKCQkJCQkJdG9vbC5kYiA9IGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwgewoJCQkJCQkJdG9vbDogdG9vbAoJCQkJCQl9KV0uY3JlYXRlQ29ubmVjdGlvbih7CgkJCQkJCQlob3N0OiB0aGlzLl9fY29uZmlnKCdzZXJ2ZXInLCBudWxsLCB7CgkJCQkJCQkJdG9vbDogdG9vbAoJCQkJCQkJfSksCgkJCQkJCQl1c2VyOiB0aGlzLl9fY29uZmlnKCd1c2VybmFtZScsIG51bGwsIHsKCQkJCQkJCQl0b29sOiB0b29sCgkJCQkJCQl9KSwKCQkJCQkJCXBhc3N3b3JkOiB0aGlzLl9fY29uZmlnKCdwYXNzd29yZCcsIG51bGwsIHsKCQkJCQkJCQl0b29sOiB0b29sCgkJCQkJCQl9KSwKCQkJCQkJCWRhdGFiYXNlOiB0aGlzLl9fY29uZmlnKCdkYXRhYmFzZScsIG51bGwsIHsKCQkJCQkJCQl0b29sOiB0b29sCgkJCQkJCQl9KSB8fCAic2FsZXNub3ciLAoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihnbG9iYWwpID09PSAndW5kZWZpbmVkJyAmJiB0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwgewoJCQkJCQl0b29sOiB0b29sCgkJCQkJfSkgPT09ICdzcWxpdGUnKSB7CgkJCQkJLy8gc3FsaXRlIGluIGJyb3dzZXIKCQkJCQl0b29sLmRiID0gbmV3IFNRTC5EYXRhYmFzZSgpOwoJCQkJCXRvb2wuX19kbWxTdGF0ZW1lbnRzID0gW107CgkJCQl9CgoJCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOwoJCQl9CgoJCQlpZiAodG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7CgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnRFNDb25uZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiVXNlciIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQl1c2VybmFtZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoudXNlcm5hbWUgPSB2ID09IHF1ZXJ5LnVzZXJuYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3VzZXJuYW1lX3NldCAmJiAhcXVlcnkuX3VzZXJuYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai51c2VybmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl91c2VybmFtZV9zZXQgJiYgcXVlcnkuX3VzZXJuYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudXNlcm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcGFzc3dvcmQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnBhc3N3b3JkID0gdiA9PSBxdWVyeS5wYXNzd29yZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9wYXNzd29yZF9zZXQgJiYgIXF1ZXJ5Ll9wYXNzd29yZF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucGFzc3dvcmQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcGFzc3dvcmRfc2V0ICYmIHF1ZXJ5Ll9wYXNzd29yZF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnBhc3N3b3JkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRlcGFydG1lbnQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRlcGFydG1lbnQgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LmRlcGFydG1lbnQoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGVwYXJ0bWVudF9zZXQgJiYgIXF1ZXJ5Ll9kZXBhcnRtZW50X3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kZXBhcnRtZW50ID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RlcGFydG1lbnRfc2V0ICYmIHF1ZXJ5Ll9kZXBhcnRtZW50X3NldCkgfHwKCgkJCQkJCSh0aGlzLmRlcGFydG1lbnQoKSAmJiAhdGhpcy5kZXBhcnRtZW50KCkuX21hdGNoZXMocXVlcnkuZGVwYXJ0bWVudCgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGVwYXJ0bWVudCA9IGZhbHNlOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbWFuYWdlcl9EZXBhcnRtZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5tYW5hZ2VyX0RlcGFydG1lbnRzID0gdi5tYXAoX3YgPT4gcXVlcnkubWFuYWdlcl9EZXBhcnRtZW50cygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJCWNhbGxlcl9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouY2FsbGVyX0luY2lkZW50cyA9IHYubWFwKF92ID0+IHF1ZXJ5LmNhbGxlcl9JbmNpZGVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCQljb250YWN0X0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5jb250YWN0X0luY2lkZW50cyA9IHYubWFwKF92ID0+IHF1ZXJ5LmNvbnRhY3RfSW5jaWRlbnRzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQkJdXNlcl9Hcm91cF9NZW1iZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnVzZXJfR3JvdXBfTWVtYmVycyA9IHYubWFwKF92ID0+IHF1ZXJ5LnVzZXJfR3JvdXBfTWVtYmVycygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJZGVwYXJ0bWVudDogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIGRlcGFydG1lbnQiKTsKCQkJCQlvYmouZGVwYXJ0bWVudCA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCW1hbmFnZXJfRGVwYXJ0bWVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoubWFuYWdlcl9EZXBhcnRtZW50cyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQkJY2FsbGVyX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5jYWxsZXJfSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCQljb250YWN0X0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5jb250YWN0X0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQkJdXNlcl9Hcm91cF9NZW1iZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnVzZXJfR3JvdXBfTWVtYmVycyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fdXNlcm5hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcGFzc3dvcmRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGVwYXJ0bWVudF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWRlcGFydG1lbnQ6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5kZXBhcnRtZW50KHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQltYW5hZ2VyX0RlcGFydG1lbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMubWFuYWdlcl9EZXBhcnRtZW50cygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQljYWxsZXJfSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuY2FsbGVyX0luY2lkZW50cygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQljb250YWN0X0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLmNvbnRhY3RfSW5jaWRlbnRzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCXVzZXJfR3JvdXBfTWVtYmVyczogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLnVzZXJfR3JvdXBfTWVtYmVycygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCXVzZXJuYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpIDogInVzZXJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3VzZXJuYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy51c2VybmFtZShyZWYpOwoKCQkJfSwKCgkJCXBhc3N3b3JkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncGFzc3dvcmQnLCB1bmRlZmluZWQpIDogInBhc3N3b3JkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3Bhc3N3b3JkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5wYXNzd29yZChyZWYpOwoKCQkJfSwKCgkJCWRlcGFydG1lbnQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSA6ICJkZXBhcnRtZW50IikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RlcGFydG1lbnRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMuZGVwYXJ0bWVudCgpIHx8IG5ldyBzYWxlc25vdy5EZXBhcnRtZW50KCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5kZXBhcnRtZW50KG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgZGVwYXJ0bWVudCIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJbWFuYWdlcl9EZXBhcnRtZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ21hbmFnZXJfVXNlcnMnLCB1bmRlZmluZWQpIDogIm1hbmFnZXJfRGVwYXJ0bWVudHMiKSkgPT4gdGhpcy5tYW5hZ2VyX0RlcGFydG1lbnRzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5EZXBhcnRtZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCQljYWxsZXJfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY2FsbGVyX1VzZXJzJywgdW5kZWZpbmVkKSA6ICJjYWxsZXJfSW5jaWRlbnRzIikpID0+IHRoaXMuY2FsbGVyX0luY2lkZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuSW5jaWRlbnQoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJCWNvbnRhY3RfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29udGFjdF9Vc2VycycsIHVuZGVmaW5lZCkgOiAiY29udGFjdF9JbmNpZGVudHMiKSkgPT4gdGhpcy5jb250YWN0X0luY2lkZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuSW5jaWRlbnQoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJCXVzZXJfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3VzZXJfVXNlcnMnLCB1bmRlZmluZWQpIDogInVzZXJfR3JvdXBfTWVtYmVycyIpKSA9PiB0aGlzLnVzZXJfR3JvdXBfTWVtYmVycyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuR3JvdXBfTWVtYmVyKCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddID0gdiwKCgkJCSJ1c2VybmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd1c2VybmFtZScsIHVuZGVmaW5lZCkgOiAidXNlcm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fdXNlcm5hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3VzZXJuYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicGFzc3dvcmQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncGFzc3dvcmQnLCB1bmRlZmluZWQpIDogInBhc3N3b3JkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3Bhc3N3b3JkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9wYXNzd29yZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRlcGFydG1lbnQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkgOiAiZGVwYXJ0bWVudCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX2RlcGFydG1lbnRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RlcGFydG1lbnRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCW1hbmFnZXJfRGVwYXJ0bWVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdtYW5hZ2VyX1VzZXJzJywgdW5kZWZpbmVkKSA6ICJtYW5hZ2VyX0RlcGFydG1lbnRzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJCWNhbGxlcl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjYWxsZXJfVXNlcnMnLCB1bmRlZmluZWQpIDogImNhbGxlcl9JbmNpZGVudHMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fY2FsbGVyX0luY2lkZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY2FsbGVyX0luY2lkZW50c19jb29wOwoJCQkJfQoJCQl9LAoKCQkJY29udGFjdF9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb250YWN0X1VzZXJzJywgdW5kZWZpbmVkKSA6ICJjb250YWN0X0luY2lkZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9jb250YWN0X0luY2lkZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29udGFjdF9JbmNpZGVudHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJCXVzZXJfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3VzZXJfVXNlcnMnLCB1bmRlZmluZWQpIDogInVzZXJfR3JvdXBfTWVtYmVycyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoYXN5bmMgKGZ1biwgY2FsbEJhY2spID0+IHsKCQkJCWlmICh0aGlzLnNfRXJyb3JNZXNzYWdlcyAmJiB0aGlzLnNfRXJyb3JNZXNzYWdlcy5sZW5ndGggPiAwKSB7CgkJCQkJYWxlcnQoCgkJCQkJCSdUaGUgZm9sbG93aW5nIGVycm9ycyB3ZXJlIGZvdW5kIGluIHlvdXIgZGF0YTpcbicgKwoJCQkJCQl0aGlzLnNfRXJyb3JNZXNzYWdlcwoJCQkJCSk7CgkJCQkJdGhpcy5zX0Vycm9yTWVzc2FnZXMgPSAnJzsKCQkJCQlyZXR1cm4gbnVsbDsKCQkJCX0KCgkJCQl0aGlzLmJ1aWxkVVJMKCk7CgoJCQkJaWYgKHR5cGVvZihkb2N1bWVudCkgIT09ICJ1bmRlZmluZWQiKSgKCQkJCQl0aGlzLmZMb2FkaW5nU3RhcnQgfHwKCQkJCQlmdW5jdGlvbigpIHsKCQkJCQkJaWYgKGRvY3VtZW50LmJvZHkpIGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ3dhaXQnOwoJCQkJCX0KCQkJCSkoKTsKCgkJCQl2YXIgYXJncyA9IEFycmF5KCk7CgkJCQlmb3IgKHZhciBpID0gMjsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewoJCQkJCWFyZ3NbaSAtIDJdID0gYXJndW1lbnRzW2ldOwoJCQkJfQoKCQkJCXZhciBwb3N0RGF0YSA9IHRoaXMucGFyYW0oYXJncyk7CgkJCQlpZiAoZnVuLmluZGV4T2YoJy4nKSA8IDApIHsKCQkJCQlmdW4gPSB0aGlzLnN5c3RlbU5hbWUgKyAnLicgKyBmdW47CgkJCQl9IGVsc2UgaWYgKGZ1bi5pbmRleE9mKCcuJykgPT0gMCkgewoJCQkJCS8vIGEgbm9uLWxheWVyIG1ldGhvZAoJCQkJCWZ1biA9IGZ1bi5zdWJzdHJpbmcoMSk7CgkJCQl9CgoJCQkJaWYgKGNhbGxCYWNrICYmIHRoaXMuQWN0aXZlUmVxdWVzdCkgewoJCQkJCXRoaXMuQWN0aXZlUmVxdWVzdCA9IG51bGw7CgkJCQkJLy9yZXR1cm4gZmFsc2U7CgkJCQl9CgoJCQkJdmFyIGhDb2RlID0gdGhpcy5oYXNoQ29kZSgKCQkJCQlmdW4uc3Vic3RyaW5nKGZ1bi5pbmRleE9mKCcuJykgKyAxKSArIHBvc3REYXRhCgkJCQkpOwoKCQkJCXRoaXMuQ1JOTCA9IHRoaXMuQ1JOTCB8fCAiXG4iOwoJCQkJcG9zdERhdGEgKz0KCQkJCQl0aGlzLkNSTkwgKwoJCQkJCXRoaXMuQ1JOTCArCgkJCQkJJzwhLS08cGlkPicgKwoJCQkJCWhDb2RlICsKCQkJCQknPC9waWQ+LS0+JyArCgkJCQkJdGhpcy5DUk5MOwoKCQkJCWlmIChmdW4uaW5kZXhPZignY21zTWV0aG9kUmVzdWx0RmluZCcpIDwgMCkgewoJCQkJCS8vIGF2b2lkIG92ZXJ3cml0ZSBvZiBhc3luYyBjYWxscwoJCQkJCXRoaXMuQWN0aXZlUmVxdWVzdCA9IHsKCQkJCQkJVVJMOiB0aGlzLnNyVVJMICsgJyZuYW1lPScgKyBmdW4sCgkJCQkJCVBvc3REYXRhOiBwb3N0RGF0YSwKCQkJCQkJRGF0ZTogbmV3IERhdGUoKSwKCQkJCQkJQ2FsbEJhY2s6IGNhbGxCYWNrLAoJCQkJCQlDb21wYW55OiB0eXBlb2YgY29tcGFueSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueSA/IHsKCQkJCQkJCUNvZGU6IGNvbXBhbnkuQ29kZSwKCQkJCQkJfSA6IG51bGwsCgkJCQkJCVRleHRSZXNwb25zZTogbnVsbCwKCQkJCQkJaGFzaDogaENvZGUsCgkJCQkJfTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmICF0aGlzLmJMb2NhbCkgewoJCQkJCS8vIGxpdmUKCQkJCQl0cnkgewoJCQkJCQl2YXIgX3RoZVVybCA9CgkJCQkJCQkodGhpcy5TdG9yZSB8fAoJCQkJCQkJCScvc3RvcmUvJyArCgkJCQkJCQkJKHdpbmRvdy5jb21wYW55ICYmIHdpbmRvdy5jb21wYW55LkNvZGUgPwoJCQkJCQkJCQl3aW5kb3cuY29tcGFueS5Db2RlICsgJy8nIDoKCQkJCQkJCQkJJy8nKSkgKwoJCQkJCQkJaENvZGUgKwoJCQkJCQkJJy5qcz9yYW5kPScgKwoJCQkJCQkJTWF0aC5yYW5kb20oKTsKCQkJCQkJbGV0IHJlcXVlc3QgPSBhd2FpdCB0aGlzLmNhY2hlUmVzdWx0KCk7CgkJCQkJCXZhciByZXNwb25zZVRleHQgPSBudWxsOwoJCQkJCQlpZiAoIXJlcXVlc3QpIHsKCQkJCQkJCXRyeSB7CgkJCQkJCQkJcmVzcG9uc2VUZXh0ID0gYXdhaXQgJC5nZXQoX3RoZVVybCk7CgkJCQkJCQl9IGNhdGNoIChleCkge30KCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXJlc3BvbnNlVGV4dCA9IHJlcXVlc3QuVGV4dFJlc3BvbnNlOwoJCQkJCQl9CgkJCQkJCWlmICghcmVzcG9uc2VUZXh0KSB7CgkJCQkJCQljb25zb2xlLmxvZygKCQkJCQkJCQknTGl2ZSBNb2RlLCBubyByZXNwb25zZSB0ZXh0IGZvciAnICsKCQkJCQkJCQl0aGlzLkFjdGl2ZVJlcXVlc3QuaGFzaCArCgkJCQkJCQkJJyAtICcgKwoJCQkJCQkJCXRoaXMuJF9SRVFVRVNUKCduYW1lJywgdGhpcy5BY3RpdmVSZXF1ZXN0LlVSTCkKCQkJCQkJCSk7CgkJCQkJCQlyZXR1cm4gbnVsbDsKCQkJCQkJfQoKCQkJCQkJdmFyIF9yZXQgPSBudWxsOwoJCQkJCQl2YXIgX2V4Y2VwdGlvbiA9IG51bGw7CgkJCQkJCXRyeSB7CgkJCQkJCQlfcmV0ID0gdGhpcy5ydW5TUlNjcmlwdChyZXNwb25zZVRleHQpOwoJCQkJCQkJX2V4Y2VwdGlvbiA9IF9yZXQuX2V4Y2VwdGlvbjsKCQkJCQkJCWlmIChfcmV0LnNlcnZlcl90aW1lKSB7CgkJCQkJCQkJbGV0IHRkID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgLSBfcmV0LnNlcnZlcl90aW1lLmdldFRpbWUoKTsKCQkJCQkJCQl0cnkgewoJCQkJCQkJCQl3aW5kb3cudGltZURpZmZlcmVuY2UgPSB0ZDsKCQkJCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQkJCQlnbG9iYWwudGltZURpZmZlcmVuY2UgPSB0ZDsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJCV9leGNlcHRpb24gPSBlOwoJCQkJCQl9CgoJCQkJCQlpZiAoIV9yZXQgJiYgIV9leGNlcHRpb24pIHsKCQkJCQkJCXJldHVybiBhd2FpdCBudWxsOyAvL3RoaXMuZG9IZWFkbGVzc0NhbGwoY2FsbEJhY2spOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJLy90aGlzLkFjdGl2ZVJlcXVlc3QgPSBudWxsOwoJCQkJCQkJaWYgKGNhbGxCYWNrICE9IG51bGwpIHsKCQkJCQkJCQl0cnkgewoJCQkJCQkJCQljYWxsQmFjaygKCQkJCQkJCQkJCV9yZXQucmV0IHx8IChfZXhjZXB0aW9uID8gcmVzcG9uc2VUZXh0IDogbnVsbCksCgkJCQkJCQkJCQlfZXhjZXB0aW9uCgkJCQkJCQkJCSk7CgkJCQkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkJCQl0aGlzLlNob3dFcnJvcigKCQkJCQkJCQkJCSdFcnJvciBpbiBDYWxsYmFjazpcblxuJyArCgkJCQkJCQkJCQljYWxsQmFjayArCgkJCQkJCQkJCQknXG5cbicgKwoJCQkJCQkJCQkJZS5tZXNzYWdlCgkJCQkJCQkJCSk7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQkJKAoJCQkJCQkJCXdpbmRvdy5zci5mTG9hZGluZ0VuZCB8fAoJCQkJCQkJCSgoKSA9PiB7CgkJCQkJCQkJCXRoaXMucmVzZXRDdXJzb3IoKTsKCQkJCQkJCQl9KQoJCQkJCQkJKSgpOwoJCQkJCQkJcmV0dXJuICgKCQkJCQkJCQkoX3JldCA/IF9yZXQucmV0IDogbnVsbCkgfHwKCQkJCQkJCQkoX2V4Y2VwdGlvbiA/IHJlc3BvbnNlVGV4dCA6IG51bGwpCgkJCQkJCQkpOwoJCQkJCQl9CgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQljb25zb2xlLmxvZyhlKTsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuIChhc3luYyAoKSA9PiB7CgkJCQkJCS8qdHJ5IHsKCQkJCQkJCWxldCBzY29wZSA9IGZ1bi5zcGxpdCgnLicpWzBdLnJlcGxhY2UoLyhbYS16MC05XSkoW0EtWl0pL2csICckMSAkMicpLnJlcGxhY2UoJyAnLCAnJykudG9Mb3dlckNhc2UoKTsKCQkJCQkJCWxldCBhcGkgPSBmdW4uc3BsaXQoJy4nKVsxXS5yZXBsYWNlKC8oW2EtejAtOV0pKFtBLVpdKS9nLCAnJDEgJDInKS5zcGxpdCgnICcpLnNsaWNlKDEsIC0xKS5qb2luKCcnKS5yZXBsYWNlKCcgJywgJycpOwoJCQkJCQkJbGV0IGZOYW1lID0gZnVuLnNwbGl0KCcuJylbMV0ucmVwbGFjZSgvKFthLXowLTldKShbQS1aXSkvZywgJyQxICQyJykuc3BsaXQoJyAnKS5zbGljZSgtMSlbMF0udG9Mb3dlckNhc2UoKS5yZXBsYWNlKCdmaW5kYWxsJywgJ2ZpbmRBbGwnKTsKCQkJCQkJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93W3Njb3BlXSAmJiBbJ2luc2VydCcsICdkZWxldGUnLCAndXBkYXRlJywgJ2ZpbmQnLCAnZmluZEFsbCddLmluZGV4T2YoZk5hbWUpID4gLTEpIHsKCQkJCQkJCQlsZXQgc0NhbGwgPSBgYXdhaXQgbmV3ICR7c2NvcGV9LiR7YXBpfSgpLiR7Zk5hbWV9KC4uLmFyZ3MpYDsKCQkJCQkJCQlsZXQgbyA9IG5ldyB3aW5kb3dbc2NvcGVdW2FwaV0oKTsKCQkJCQkJCQlPYmplY3Qua2V5cyhhcmdzWzBdKS5maWx0ZXIoayA9PiBrICE9PSAiT1BFUkFUT1JTIikuZm9yRWFjaChrID0+IHsKCQkJCQkJCQkJb1trLnJlcGxhY2UoLyg/Ol5cd3xbQS1aXXxcYlx3fFxzKykvZywgKG1hdGNoLCBpbmRleCkgPT4gewoJCQkJCQkJCQkJaWYgKCttYXRjaCA9PT0gMCkgcmV0dXJuICIiOwoJCQkJCQkJCQkJcmV0dXJuIGluZGV4ID09PSAwID8gbWF0Y2gudG9Mb3dlckNhc2UoKSA6IG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJCQkJCQkJCX0pXShhcmdzWzBdW2tdLCBhcmdzWzBdLk9QRVJBVE9SUz8uW2tdKTsKCQkJCQkJCQl9KTsKCQkJCQkJCQljb25zb2xlLmxvZyhzQ2FsbCwgby5fdG9Eb2N1bWVudCgpLCBhcmdzKTsKCQkJCQkJCQkvL3JldHVybiBhd2FpdCBvW2ZOYW1lXSgpOwoJCQkJCQkJfQoJCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQkJY29uc29sZS5sb2coIl8oKSBFeGNlcHRpb246ICIgKyBleCk7CgkJCQkJCX0qLwoKCQkJCQkJcmV0dXJuIGF3YWl0IHRoaXMuc2VuZFhNTCgKCQkJCQkJCXRoaXMuc3JVUkwgKyAnJm5hbWU9JyArIGZ1biwKCQkJCQkJCXBvc3REYXRhLAoJCQkJCQkJY2FsbEJhY2sKCQkJCQkJKTsKCQkJCQl9KSgpOwoJCQkJfQoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoc3JVUkwpID0+IHsKCQkJCWlmICghc3JVUkwpIHsKCQkJCQl0aGlzLnNyVVJMID0gdGhpcy4kX1JFUVVFU1QoJ3NyJyk7CgkJCQkJaWYgKCF0aGlzLnNyVVJMKSB7CgkJCQkJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJCWxldCBpcCA9IHRoaXMuaXBBZGRyZXNzKCk7CgkJCQkJCQlpZiAoaXAgJiYgKGlwLnN0YXJ0c1dpdGgoIjE4Mi4xNjguIikgfHwgaXAgPT0gIjE5Mi4xNjguMS4yNTMiIHx8IGlwID09ICcxOTUuMTEyLjIxNS4yMTgnKSkgewoJCQkJCQkJCXRoaXMuc3JVUkwgPSAiaHR0cDovLzE4Mi4xNjguNzAuODAiOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQl0aGlzLnNyVVJMID0gImh0dHA6Ly9hcnoubmFtbW91ci5jb206NzA4MCI7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJdGhpcy5zclVSTCArPSAnL21ldGhvZC9TZXJ2aWNlUm91dGVyLmFzaHgnOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5zclVSTCA9IHNyVVJMOwoJCQkJfQoJCQkJdGhpcy5zclVSTCArPSAnP3NydmVyc2lvbj0xJzsKCQkJCWlmICh0aGlzLiRfUkVRVUVTVCgnZ3ppcCcpKSB7CgkJCQkJdGhpcy5zclVSTCArPSAnJmd6aXA9JyArIHRoaXMuJF9SRVFVRVNUKCdnemlwJyk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuc3JVUkwgKz0gJyZnemlwPXRydWUnOwoJCQkJfQoJCQkJaWYgKHRoaXMuYkNhY2hlKSB7CgkJCQkJdGhpcy5zclVSTCArPSAnJmNhY2hlPScgKyB0aGlzLmJDYWNoZTsKCQkJCX0KCQkJCWlmICghdGhpcy4kX1JFUVVFU1QoJ3JhbmQnLCB0aGlzLnNyVVJMKSkgewoJCQkJCXRoaXMuc3JVUkwgKz0gJyZyYW5kPScgKyBNYXRoLnJhbmRvbSgpOwoJCQkJfQoKCQkJCWlmICh0aGlzLmJEZWJ1ZykgewoJCQkJCXRoaXMuc3JVUkwgKz0gJyZERUJVRz10cnVlJzsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJdGhpcy5iQXN5bmMgJiYKCQkJCQl0aGlzLmJMb2NhbCAmJgoJCQkJCSF0aGlzLiRfUkVRVUVTVCgnYXN5bmMnLCB0aGlzLnNyVVJMKQoJCQkJKSB7CgkJCQkJdGhpcy5zclVSTCArPSAnJmFzeW5jPXRydWUnOwoJCQkJCWlmICh0aGlzLnJ1bkFmdGVyKSB7CgkJCQkJCXRoaXMuc3JVUkwgKz0gJyZydW5hZnRlcj0nICsgdGhpcy5ydW5BZnRlcjsKCQkJCQl9CgkJCQkJdGhpcy5iQXN5bmMgPSBmYWxzZTsKCQkJCX0KCgkJCQkvL3RoaXMuU2hvd0RlYnVnKCd0aGlzLnNyVVJMPScgKyB0aGlzLnNyVVJMKTsKCgkJCQlyZXR1cm4gdGhpcy5zclVSTDsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChrZXksIHVybCkgPT4gewoJCQkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIG51bGw7CgoJCQkJbGV0IHJldCA9IHVuZGVmaW5lZDsKCQkJCWlmICh1cmwpIHsKCQkJCQl0cnkgewoJCQkJCQlyZXQgPSBuZXcgVVJMKHVybCkuc2VhcmNoUGFyYW1zLmdldChrZXkpOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXZhciByZWdleCA9IG5ldyBSZWdFeHAoJ1tcXD98Jl0nICsga2V5ICsgJz0oW14mI10qKScpOwoJCQkJCQl2YXIgcmVzdWx0cyA9IHJlZ2V4LmV4ZWMoJz8nICsgdXJsLnNwbGl0KCc/JylbMV0pOwoJCQkJCQlyZXQgPSAocmVzdWx0cyA9PT0gbnVsbCkgPyAnJyA6IGRlY29kZVVSSUNvbXBvbmVudChyZXN1bHRzWzFdLnJlcGxhY2UoL1wrL2csICcgJykpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gbmV3IFVSTFNlYXJjaFBhcmFtcyh3aW5kb3cubG9jYXRpb24uc2VhcmNoKS5nZXQoa2V5KTsKCQkJCX0KCgkJCQlyZXR1cm4gcmV0ID09PSBudWxsID8gJycgOiByZXQ7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKGFyZ3MpID0+IHsKCQkJCXRoaXMuQ1JOTCA9IHRoaXMuQ1JOTCB8fCAiXG4iOwoJCQkJdmFyIHJldCA9CgkJCQkJJy8qJyArCgkJCQkJdGhpcy5DUk5MICsKCQkJCQknPCFbQ0RBVEFbJyArCgkJCQkJdGhpcy5DUk5MICsKCQkJCQknUEFSQU1FVEVSUycgKwoJCQkJCXRoaXMuQ1JOTCArCgkJCQkJJ11dPicgKwoJCQkJCXRoaXMuQ1JOTCArCgkJCQkJJyovJyArCgkJCQkJdGhpcy5DUk5MICsKCQkJCQl0aGlzLkNSTkwgKwoJCQkJCSc8cD4nICsKCQkJCQl0aGlzLkNSTkw7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHsKCQkJCQl2YXIgeG1sID0gdGhpcy5fdG9YTUwoYXJnc1tpXSk7CgkJCQkJaWYgKGZhbHNlKSB7CgkJCQkJCS8vIHhtbCBjb250YWlucyBjaGFyYWN0ZXJzIHRoYXQgd291bGQgbm90IGFycml2ZSBwcm9wZXJseSBhbmQgc2hvdWxkIGJlIGNvbnZlcnRlZCB0byBiYXNlNjQKCQkJCQkJeG1sID0gYnRvYSh4bWwpOwoJCQkJCX0KCQkJCQlyZXQgKz0gJzxwJyArIGkgKyAnPicgKyB0aGlzLkNSTkwgKyB4bWwgKyAnJyArIHRoaXMuQ1JOTDsKCQkJCQlyZXQgKz0gJzwvcCcgKyBpICsgJz4nICsgdGhpcy5DUk5MOwoJCQkJfQoJCQkJcmV0ICs9ICc8L3A+JyArIHRoaXMuQ1JOTDsKCQkJCXJldHVybiByZXQ7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgobywgbGV2ZWwpID0+IHsKCQkJCWlmICghbGV2ZWwpIGxldmVsID0gMDsKCQkJCXZhciBzID0gJyc7CgkJCQlpZiAobyA9PSBudWxsKSByZXR1cm4gczsKCQkJCXN3aXRjaCAodHlwZW9mIG8pIHsKCQkJCQljYXNlICdzdHJpbmcnOgoJCQkJCQlzICs9ICc8IVtDREFUQVsnICsgbyArICddXT4nOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICdudW1iZXInOgoJCQkJCWNhc2UgJ2Jvb2xlYW4nOgoJCQkJCQlzICs9IG8udG9TdHJpbmcoKTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAnb2JqZWN0JzoKCQkJCQkJLy8gRGF0ZQoJCQkJCQlpZiAoCgkJCQkJCQlvLmNvbnN0cnVjdG9yICYmCgkJCQkJCQlvLmNvbnN0cnVjdG9yLnRvU3RyaW5nKCkuaW5kZXhPZignZnVuY3Rpb24gRGF0ZSgpJykgPiAtMSAmJgoJCQkJCQkJby5jb25zdHJ1Y3Rvci5uYW1lID09ICJEYXRlIgoJCQkJCQkpIHsKCQkJCQkJCXZhciB5ZWFyID0gby5nZXRVVENGdWxsWWVhcigpLnRvU3RyaW5nKCk7CgkJCQkJCQl2YXIgbW9udGggPSAoby5nZXRVVENNb250aCgpICsgMSkudG9TdHJpbmcoKTsKCQkJCQkJCW1vbnRoID0gbW9udGgubGVuZ3RoID09IDEgPyAnMCcgKyBtb250aCA6IG1vbnRoOwoJCQkJCQkJdmFyIGRhdGUgPSBvLmdldFVUQ0RhdGUoKS50b1N0cmluZygpOwoJCQkJCQkJZGF0ZSA9IGRhdGUubGVuZ3RoID09IDEgPyAnMCcgKyBkYXRlIDogZGF0ZTsKCQkJCQkJCXZhciBob3VycyA9IG8uZ2V0VVRDSG91cnMoKS50b1N0cmluZygpOwoJCQkJCQkJaG91cnMgPSBob3Vycy5sZW5ndGggPT0gMSA/ICcwJyArIGhvdXJzIDogaG91cnM7CgkJCQkJCQl2YXIgbWludXRlcyA9IG8uZ2V0VVRDTWludXRlcygpLnRvU3RyaW5nKCk7CgkJCQkJCQltaW51dGVzID0gbWludXRlcy5sZW5ndGggPT0gMSA/ICcwJyArIG1pbnV0ZXMgOiBtaW51dGVzOwoJCQkJCQkJdmFyIHNlY29uZHMgPSBvLmdldFVUQ1NlY29uZHMoKS50b1N0cmluZygpOwoJCQkJCQkJc2Vjb25kcyA9IHNlY29uZHMubGVuZ3RoID09IDEgPyAnMCcgKyBzZWNvbmRzIDogc2Vjb25kczsKCQkJCQkJCXZhciBtaWxsaXNlY29uZHMgPSBvLmdldFVUQ01pbGxpc2Vjb25kcygpLnRvU3RyaW5nKCk7CgkJCQkJCQl2YXIgdHptaW51dGVzID0gTWF0aC5hYnMoby5nZXRUaW1lem9uZU9mZnNldCgpKTsKCQkJCQkJCXZhciB0emhvdXJzID0gMDsKCQkJCQkJCXdoaWxlICh0em1pbnV0ZXMgPj0gNjApIHsKCQkJCQkJCQl0emhvdXJzKys7CgkJCQkJCQkJdHptaW51dGVzIC09IDYwOwoJCQkJCQkJfQoJCQkJCQkJdHptaW51dGVzID0KCQkJCQkJCQl0em1pbnV0ZXMudG9TdHJpbmcoKS5sZW5ndGggPT0gMSA/CgkJCQkJCQkJJzAnICsgdHptaW51dGVzLnRvU3RyaW5nKCkgOgoJCQkJCQkJCXR6bWludXRlcy50b1N0cmluZygpOwoJCQkJCQkJdHpob3VycyA9CgkJCQkJCQkJdHpob3Vycy50b1N0cmluZygpLmxlbmd0aCA9PSAxID8KCQkJCQkJCQknMCcgKyB0emhvdXJzLnRvU3RyaW5nKCkgOgoJCQkJCQkJCXR6aG91cnMudG9TdHJpbmcoKTsKCQkJCQkJCXZhciB0aW1lem9uZSA9CgkJCQkJCQkJKG8uZ2V0VGltZXpvbmVPZmZzZXQoKSA8IDAgPyAnKycgOiAnLScpICsKCQkJCQkJCQl0emhvdXJzICsKCQkJCQkJCQknOicgKwoJCQkJCQkJCXR6bWludXRlczsKCQkJCQkJCS8vcyArPSB5ZWFyICsgIi0iICsgbW9udGggKyAiLSIgKyBkYXRlICsgIlQiICsgaG91cnMgKyAiOiIgKyBtaW51dGVzICsgIjoiICsgc2Vjb25kcyArICIuIiArIG1pbGxpc2Vjb25kcyArIHRpbWV6b25lOwoJCQkJCQkJcyArPQoJCQkJCQkJCW1vbnRoICsKCQkJCQkJCQknLycgKwoJCQkJCQkJCWRhdGUgKwoJCQkJCQkJCScvJyArCgkJCQkJCQkJeWVhciArCgkJCQkJCQkJJyAnICsKCQkJCQkJCQlob3VycyArCgkJCQkJCQkJJzonICsKCQkJCQkJCQltaW51dGVzICsKCQkJCQkJCQknOicgKwoJCQkJCQkJCXNlY29uZHM7CgkJCQkJCX0KCQkJCQkJLy8gQXJyYXkKCQkJCQkJZWxzZSBpZiAoCgkJCQkJCQlvLmNvbnN0cnVjdG9yICYmCgkJCQkJCQlvLmNvbnN0cnVjdG9yLnRvU3RyaW5nKCkuaW5kZXhPZignQXJyYXkoKScpID4gLTEKCQkJCQkJKSB7CgkJCQkJCQlmb3IgKHZhciBwIGluIG8pIHsKCQkJCQkJCQlpZiAocCA9PSAnT1BFUkFUT1JTJyB8fCBwID09ICdPUlMnKSBjb250aW51ZTsKCQkJCQkJCQlzICs9ICc8T2JqZWN0Pic7CgkJCQkJCQkJaWYgKCFpc05hTihwKSkgewoJCQkJCQkJCQkvLyBsaW5lYXIgYXJyYXkKCQkJCQkJCQkJaWYgKG9bcF0gPT0gbnVsbCkgewoJCQkJCQkJCQkJLy8gbnVsbCBlbnRyeSBpbiB0aGUgYXJyYXkKCQkJCQkJCQkJCXMgKz0gJzxJZD4wPC9JZD4nOwoJCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQkJL2Z1bmN0aW9uXHMrKFx3KilccypcKC9naS5leGVjKAoJCQkJCQkJCQkJCW9bcF0uY29uc3RydWN0b3IudG9TdHJpbmcoKQoJCQkJCQkJCQkJKTsKCQkJCQkJCQkJCXZhciB0eXBlID0gUmVnRXhwLiQxOwoJCQkJCQkJCQkJc3dpdGNoICh0eXBlKSB7CgkJCQkJCQkJCQkJY2FzZSAnJzoKCQkJCQkJCQkJCQkJdHlwZSA9IHR5cGVvZiBvW3BdOwoJCQkJCQkJCQkJCWNhc2UgJ1N0cmluZyc6CgkJCQkJCQkJCQkJCXR5cGUgPSAnc3RyaW5nJzsKCQkJCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJCQkJY2FzZSAnTnVtYmVyJzoKCQkJCQkJCQkJCQkJdHlwZSA9ICdpbnQnOwoJCQkJCQkJCQkJCQlicmVhazsKCQkJCQkJCQkJCQljYXNlICdCb29sZWFuJzoKCQkJCQkJCQkJCQkJdHlwZSA9ICdib29sJzsKCQkJCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJCQkJY2FzZSAnRGF0ZSc6CgkJCQkJCQkJCQkJCXR5cGUgPSAnRGF0ZVRpbWUnOwoJCQkJCQkJCQkJCQlicmVhazsKCQkJCQkJCQkJCX0KCQkJCQkJCQkJCXMgKz0gdGhpcy5fdG9YTUwob1twXSwgbGV2ZWwrKyk7CgkJCQkJCQkJCX0KCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQkvLyBhc3NvY2lhdGl2ZSBhcnJheQoJCQkJCQkJCQlzICs9CgkJCQkJCQkJCQknPCcgKwoJCQkJCQkJCQkJcCArCgkJCQkJCQkJCQl0aGlzLmNvb3AobywgcCkgKwoJCQkJCQkJCQkJJz4nICsKCQkJCQkJCQkJCXRoaXMuX3RvWE1MKG9bcF0sIGxldmVsKyspICsKCQkJCQkJCQkJCSc8LycgKwoJCQkJCQkJCQkJcCArCgkJCQkJCQkJCQknPic7CgkJCQkJCQkJfQoJCQkJCQkJCXMgKz0gJzwvT2JqZWN0PicgKyB0aGlzLkNSTkw7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJLy8gT2JqZWN0IG9yIGN1c3RvbSBmdW5jdGlvbgoJCQkJCQllbHNlIHsKCQkJCQkJCWlmIChvID09IG51bGwgfHwgby5JZCA9PSAwKSB7fSBlbHNlIGlmIChmYWxzZSAmJiBvLklkKSB7CgkJCQkJCQkJLy8gdGhpcyBpcyBjcmVhdGluZyBhIHByb2JsZW0sIGJldHRlciBzZW5kIGFsbCB0aGUgb2JqZWN0CgkJCQkJCQkJLy8gZG8gbm90IHNlbmQgb3RoZXIgZGF0YSBpZiB3ZSBoYXZlIGEgdmFsdWUgZm9yIHRoZSBJZAoJCQkJCQkJCXMgKz0gJzxJZD4nICsgdGhpcy5fdG9YTUwoby5JZCwgbGV2ZWwrKykgKyAnPC9JZD4nOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlmb3IgKHZhciBwIGluIG8pIHsKCQkJCQkJCQkJaWYgKHAgPT0gJ09QRVJBVE9SUycgfHwgcCA9PSAnT1JTJykgY29udGludWU7CgkJCQkJCQkJCXMgKz0KCQkJCQkJCQkJCSc8JyArCgkJCQkJCQkJCQlwICsKCQkJCQkJCQkJCXRoaXMuY29vcChvLCBwKSArCgkJCQkJCQkJCQl0aGlzLk9SKG8sIHApICsKCQkJCQkJCQkJCSc+JyArCgkJCQkJCQkJCQl0aGlzLl90b1hNTChvW3BdLCBsZXZlbCsrKSArCgkJCQkJCQkJCQknPC8nICsKCQkJCQkJCQkJCXAgKwoJCQkJCQkJCQkJJz4nOwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfQoJCQkJCQlicmVhazsKCQkJCX0KCQkJCXJldHVybiBzOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChvLCBwKSA9PiB7CgkJCQlpZiAoIW8uT1BFUkFUT1JTIHx8ICFvLk9QRVJBVE9SU1twXSkgewoJCQkJCXJldHVybiAnJzsKCQkJCX0KCQkJCXJldHVybiAoCgkJCQkJIiBjb29wPSciICsKCQkJCQl0aGlzLm15UmVwbGFjZShvLk9QRVJBVE9SU1twXSwgWyc8JywgJz4nXSwgWycmbHQ7JywgJyZndDsnXSkgKwoJCQkJCSInIgoJCQkJKTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKG8sIHApID0+IHsKCQkJCXJldHVybiBvLk9SUyAmJiBvLk9SU1twXSA/CgkJCQkJIiBPUj0nIiArCgkJCQkJdGhpcy5teVJlcGxhY2Uoby5PUlNbcF0sIFsnPCcsICc+J10sIFsnJmx0OycsICcmZ3Q7J10pICsKCQkJCQkiJyIgOgoJCQkJCScnOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHMsIGZjLCByYykgPT4gewoJCQkJaWYgKHR5cGVvZiBzICE9PSAnc3RyaW5nJykgcmV0dXJuIHM7CgoJCQkJdmFyIHJldCA9ICcnOwoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBzLmxlbmd0aDsgaSsrKSB7CgkJCQkJdmFyIHJzID0gcy5jaGFyQXQoaSk7CgkJCQkJZm9yICh2YXIgaiA9IDA7IGogPCBmYy5sZW5ndGg7IGorKykgewoJCQkJCQlpZiAocy5jaGFyQXQoaSkgPT0gZmNbal0pIHsKCQkJCQkJCXJzID0gcy5jaGFyQXQoaSkucmVwbGFjZShmY1tqXSwgcmNbal0pOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXJldCArPSByczsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoYXN5bmMgKHVybCwgcG9zdERhdGEsIGNhbGxCYWNrKSA9PiB7CgkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmICF3aW5kb3cuU1IpIHdpbmRvdy5TUiA9IHRoaXM7CgoJCQkJaWYgKCh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93LmpRdWVyeSkgfHwgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YoYXhpb3MpICE9PSAidW5kZWZpbmVkIikpIHsKCQkJCQlsZXQgcmVxdWVzdCA9IGF3YWl0IHRoaXMuY2FjaGVSZXN1bHQobnVsbCwgbnVsbCwgY2FsbEJhY2spOwoJCQkJCWlmIChyZXF1ZXN0KSB7CgkJCQkJCWxldCByZXN1bHQgPSBhd2FpdCB0aGlzLnByb2Nlc3NSZXNwb25zZSgKCQkJCQkJCTQ0LAoJCQkJCQkJY2FsbEJhY2ssCgkJCQkJCQlyZXF1ZXN0LlRleHRSZXNwb25zZSwKCQkJCQkJCXVybAoJCQkJCQkpOwoJCQkJCQlyZXR1cm4gYXdhaXQgdGhpcy5wcm9jZXNzUmVzdWx0KHJlc3VsdCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJLy8ganF1ZXJ5IGNhbGwKCQkJCQkJdmFyIGFqYXggPSB7fTsKCQkJCQkJaWYgKHRoaXMuYlBvc3QgfHwgcG9zdERhdGEubGVuZ3RoID4gKHRoaXMubk1heFVSTExlbmd0aCB8fCAxMDApKSB7CgkJCQkJCQlhamF4LnVybCA9IHVybDsKCQkJCQkJCWFqYXgudHlwZSA9ICdQT1NUJzsKCQkJCQkJCWFqYXguYmVmb3JlU2VuZCA9IChyZXF1ZXN0KSA9PiB7CgkJCQkJCQkJcmVxdWVzdC5zZXRSZXF1ZXN0SGVhZGVyKAoJCQkJCQkJCQknQ29udGVudC1UeXBlJywKCQkJCQkJCQkJJ211bHRpcGFydC9mb3JtLWRhdGE7IGJvdW5kYXJ5PS0tLS0tLS0tLS0tLS0tJwoJCQkJCQkJCSk7CgkJCQkJCQl9OwoJCQkJCQkJYWpheC5kYXRhID0KCQkJCQkJCQknUE9TVERBVEE9XHJcbicgLyorICI8P3htbCB2ZXJzaW9uPVwiMS4wXCIgZW5jb2Rpbmc9XCJ1dGYtOFwiIHN0YW5kYWxvbmU9XCJ5ZXNcIj8+XHJcbiIqLyArCgkJCQkJCQkJcG9zdERhdGE7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlhamF4LnVybCA9IHVybCArICcmUE9TVENPREU9JyArIHRoaXMudG9IZXgocG9zdERhdGEpOwoJCQkJCQkJYWpheC50eXBlID0gJ0dFVCc7CgkJCQkJCX0KCgkJCQkJCWxldCByZXQgPSBudWxsOwoJCQkJCQlpZiAodHlwZW9mKGpRdWVyeSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCQlyZXQgPSBhd2FpdCAkLmFqYXgoYWpheCk7CgkJCQkJCX0gZWxzZSBpZiAodHlwZW9mKGF4aW9zKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJCXJldCA9IGF3YWl0IGF4aW9zKGFqYXgpOwoJCQkJCQkJcmV0ID0gcmV0LmRhdGE7CgkJCQkJCX0KCQkJCQkJcmV0ID0gYXdhaXQgdGhpcy5wcm9jZXNzUmVzdWx0KAoJCQkJCQkJdGhpcy5wcm9jZXNzUmVzcG9uc2UoNCwgY2FsbEJhY2ssIHJldCwgdXJsKQoJCQkJCQkpOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJdmFyIHhtbEhUVFAgPSB0aGlzLmdldFhtbEhUVFAoKTsKCQkJCQlpZiAoIXhtbEhUVFApIHJldHVybiBmYWxzZTsKCQkJCQlpZiAoY2FsbEJhY2sgIT0gbnVsbCkgewoJCQkJCQl3aW5kb3cueG1sSFRUUC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKCQkJCQkJCWlmICh3aW5kb3cueG1sSFRUUC5yZWFkeVN0YXRlID09IDQpIHsKCQkJCQkJCQlpZiAoJC53aGVuKSB7CgkJCQkJCQkJCSQud2hlbigKCQkJCQkJCQkJCXdpbmRvdy5TUi5wcm9jZXNzUmVzcG9uc2UoCgkJCQkJCQkJCQkJd2luZG93LnhtbEhUVFAucmVhZHlTdGF0ZSwKCQkJCQkJCQkJCQljYWxsQmFjaywKCQkJCQkJCQkJCQl3aW5kb3cueG1sSFRUUC5yZXNwb25zZVRleHQsCgkJCQkJCQkJCQkJdXJsCgkJCQkJCQkJCQkpCgkJCQkJCQkJCSkudGhlbigocmVzdWx0KSA9PiB3aW5kb3cuU1IucHJvY2Vzc1Jlc3VsdChyZXN1bHQpKTsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQl3aW5kb3cuU1IucHJvY2Vzc1Jlc3VsdCgKCQkJCQkJCQkJCXdpbmRvdy5TUi5wcm9jZXNzUmVzcG9uc2UoCgkJCQkJCQkJCQkJd2luZG93LnhtbEhUVFAucmVhZHlTdGF0ZSwKCQkJCQkJCQkJCQljYWxsQmFjaywKCQkJCQkJCQkJCQl3aW5kb3cueG1sSFRUUC5yZXNwb25zZVRleHQsCgkJCQkJCQkJCQkJdXJsCgkJCQkJCQkJCQkpCgkJCQkJCQkJCSk7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9OwoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuYlBvc3QgfHwgcG9zdERhdGEubGVuZ3RoID4gdGhpcy5uTWF4VVJMTGVuZ3RoKSB7CgkJCQkJCXdpbmRvdy54bWxIVFRQLm9wZW4oJ1BPU1QnLCB1cmwsIGNhbGxCYWNrICE9IG51bGwpOwoJCQkJCQl3aW5kb3cueG1sSFRUUC5zZXRSZXF1ZXN0SGVhZGVyKAoJCQkJCQkJJ0NvbnRlbnQtVHlwZScsCgkJCQkJCQknbXVsdGlwYXJ0L2Zvcm0tZGF0YTsgYm91bmRhcnk9LS0tLS0tLS0tLS0tLS0nCgkJCQkJCSk7IC8vIGZvb2wgY3Jvc3MtZG9tYWluIGNoZWNraW5nIGluIGNocm9tZQoJCQkJCQl3aW5kb3cueG1sSFRUUC5zZW5kKAoJCQkJCQkJJ1BPU1REQVRBPVxyXG4nIC8qKyAiPD94bWwgdmVyc2lvbj1cIjEuMFwiIGVuY29kaW5nPVwidXRmLThcIiBzdGFuZGFsb25lPVwieWVzXCI/PlxyXG4iKi8gKwoJCQkJCQkJcG9zdERhdGEKCQkJCQkJKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl4bWxIVFRQLm9wZW4oCgkJCQkJCQknR0VUJywKCQkJCQkJCXVybCArICcmUE9TVENPREU9JyArIHRoaXMudG9IZXgocG9zdERhdGEpLAoJCQkJCQkJY2FsbEJhY2sgIT0gbnVsbAoJCQkJCQkpOwoJCQkJCQl4bWxIVFRQLnNlbmQobnVsbCk7CgkJCQkJfQoKCQkJCQlpZiAoY2FsbEJhY2sgPT0gbnVsbCAmJiB4bWxIVFRQLnJlYWR5U3RhdGUgPT0gNCkgewoJCQkJCQl2YXIgX3VybCA9IHVybCArICcmUE9TVENPREU9JyArIHRoaXMudG9IZXgocG9zdERhdGEpOwoJCQkJCQlpZiAoJC53aGVuKSB7CgkJCQkJCQlyZXR1cm4gJC53aGVuKAoJCQkJCQkJCXRoaXMucHJvY2Vzc1Jlc3BvbnNlKAoJCQkJCQkJCQl4bWxIVFRQLnJlYWR5U3RhdGUsCgkJCQkJCQkJCWNhbGxCYWNrLAoJCQkJCQkJCQl4bWxIVFRQLnJlc3BvbnNlVGV4dCwKCQkJCQkJCQkJX3VybAoJCQkJCQkJCSkKCQkJCQkJCSkudGhlbigocmVzdWx0KSA9PiB7CgkJCQkJCQkJcmV0dXJuIHRoaXMucHJvY2Vzc1Jlc3VsdChyZXN1bHQpOwoJCQkJCQkJfSk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQl0aGlzLnByb2Nlc3NSZXN1bHQoCgkJCQkJCQkJdGhpcy5wcm9jZXNzUmVzcG9uc2UoCgkJCQkJCQkJCXhtbEhUVFAucmVhZHlTdGF0ZSwKCQkJCQkJCQkJY2FsbEJhY2ssCgkJCQkJCQkJCXhtbEhUVFAucmVzcG9uc2VUZXh0LAoJCQkJCQkJCQlfdXJsCgkJCQkJCQkJKQoJCQkJCQkJKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHJlYWR5U3RhdGUsIGNhbGxCYWNrLCByZXNwb25zZVRleHQsIHVybCkgPT4gewoJCQkJaWYgKFs0LCA0NF0uaW5kZXhPZihyZWFkeVN0YXRlKSA9PSAtMSkgcmV0dXJuOwoKCQkJCXZhciBzTWV0aG9kTmFtZSA9IHRoaXMuJF9SRVFVRVNUKCduYW1lJywgdXJsKTsKCgkJCQl0cnkgewoJCQkJCWlmIChyZWFkeVN0YXRlID09IDQpIHsKCQkJCQkJbGV0IHJlcyA9IChhc3luYyAoKSA9PiB7CgkJCQkJCQlyZXR1cm4gYXdhaXQgdGhpcy5jYWNoZVJlc3VsdChudWxsLCByZXNwb25zZVRleHQpOwoJCQkJCQl9KSgpOwoJCQkJCX0KCgkJCQkJLy9yZXQgPSBudWxsOwoJCQkJCS8vc2VydmVyX3RpbWUgPSBudWxsOwoJCQkJCS8vX2V4Y2VwdGlvbiA9IG51bGw7CgkJCQkJdmFyIGJTY3JpcHRFcnJvciA9IGZhbHNlOwoJCQkJCXZhciBfcmV0ID0gbnVsbDsKCQkJCQl0cnkgewoJCQkJCQlfcmV0ID0gdGhpcy5ydW5TUlNjcmlwdChyZXNwb25zZVRleHQpOwoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIikgdGhyb3cgZTsKCQkJCQkJYlNjcmlwdEVycm9yID0gdHJ1ZTsKCQkJCQl9CgoJCQkJCWlmIChfcmV0ICYmIF9yZXQuc2VydmVyX3RpbWUpIHsKCQkJCQkJbGV0IHRkID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgLSBfcmV0LnNlcnZlcl90aW1lLmdldFRpbWUoKTsKCgkJCQkJCXRyeSB7CgkJCQkJCQl3aW5kb3cudGltZURpZmZlcmVuY2UgPSB0ZDsKCQkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJCWdsb2JhbC50aW1lRGlmZmVyZW5jZSA9IHRkOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAoX3JldCAmJiBfcmV0Ll9leGNlcHRpb24pIHsKCQkJCQkJdGhpcy5TaG93RGVidWcoX2V4Y2VwdGlvbi5NZXNzYWdlKTsKCQkJCQl9CgoJCQkJCWlmIChjYWxsQmFjayAhPSBudWxsKSB7CgkJCQkJCXZhciBjYWxsUmV0ID0gbnVsbDsKCQkJCQkJdHJ5IHsKCQkJCQkJCWNhbGxSZXQgPSBjYWxsQmFjayhfcmV0LnJldCwgX3JldC5fZXhjZXB0aW9uKTsKCQkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkJdGhpcy5TaG93RXJyb3IoCgkJCQkJCQkJJ0Vycm9yIGluIENhbGxiYWNrOlxuXG4nICsgY2FsbEJhY2sgKyAnXG5cbicgKyBlLm1lc3NhZ2UKCQkJCQkJCSk7CgkJCQkJCX0KCQkJCQkJaWYgKAoJCQkJCQkJdHlwZW9mIF9yZXQubWV0aG9kX25hbWUgIT09ICd1bmRlZmluZWQnICYmCgkJCQkJCQl0eXBlb2Ygc01ldGhvZE5hbWUgIT09ICd1bmRlZmluZWQnICYmCgkJCQkJCQlzTWV0aG9kTmFtZSAhPSBfcmV0Lm1ldGhvZF9uYW1lCgkJCQkJCSkgewoJCQkJCQkJdGhpcy5TaG93RXJyb3IoCgkJCQkJCQkJJ01pc21hdGNoIGluIE1ldGhvZCBiZXR3ZWVuIHNlcnZlciBhbmQgY2xpZW50OlxuU2VydmVyIE1ldGhvZCBOYW1lOiAnICsKCQkJCQkJCQlfcmV0Lm1ldGhvZF9uYW1lICsKCQkJCQkJCQknXG5DbGllbnQgTWV0aG9kIE5hbWU6ICcgKwoJCQkJCQkJCXNNZXRob2ROYW1lCgkJCQkJCQkpOwoJCQkJCQl9CgkJCQkJCSgKCQkJCQkJCXRoaXMuZkxvYWRpbmdFbmQgfHwKCQkJCQkJCWZ1bmN0aW9uKCkgewoJCQkJCQkJCXdpbmRvdy5zci5yZXNldEN1cnNvcigpOwoJCQkJCQkJfQoJCQkJCQkpKCk7CgoJCQkJCQlyZXR1cm4gKAoJCQkJCQkJY2FsbFJldCB8fCBfcmV0LnJldCB8fCAoYlNjcmlwdEVycm9yID8gcmVzcG9uc2VUZXh0IDogbnVsbCkKCQkJCQkJKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiKSB0aGlzLnJlc2V0Q3Vyc29yKCk7CgkJCQkJCXJldHVybiAoX3JldCA/IF9yZXQucmV0IDogbnVsbCkgfHwgKGJTY3JpcHRFcnJvciA/IHJlc3BvbnNlVGV4dCA6IG51bGwpOwoJCQkJCX0KCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXRocm93IGU7CgkJCQkJfQoJCQkJCXRoaXMucmVzZXRDdXJzb3IoKTsKCQkJCQl0aGlzLlNob3dFcnJvcignRXJyb3IgaW4gY29kZTogJyArIGUubWVzc2FnZSArICdcbicgKyByZXNwb25zZVRleHQpOwoJCQkJfQoKCQkJCXJldHVybiBudWxsOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKGFzeW5jIChyZXMpID0+IHsKCQkJCWlmICghcmVzIHx8ICFyZXMuQ29kZSB8fCAhcmVzLlN0b3JlZE1ldGhvZCkgewoJCQkJCXRoaXMuQWN0aXZlUmVxdWVzdCA9IG51bGw7CgkJCQkJcmV0dXJuIHJlczsKCQkJCX0KCgkJCQkvLyBmb3Igc3VyZSBhIG1ldGhvZCByZXN1bHQgZnJvbSBhbiBhc3luYyBjYWxsCgkJCQlpZiAocmVzLlJlc3VsdCkgewoJCQkJCS8vIHdlIGdvdCBhIHJlc3VsdAoJCQkJCXZhciBfX3JldCA9IG51bGw7CgkJCQkJdHJ5IHsKCQkJCQkJX19yZXQgPSB0aGlzLnByb2Nlc3NSZXNwb25zZSg0LCBudWxsLCByZXMuUmVzdWx0LCBudWxsKTsKCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCV9fcmV0ID0gcmVzLlJlc3VsdDsKCQkJCQl9CgkJCQkJdGhpcy5BY3RpdmVSZXF1ZXN0ID0gbnVsbDsKCQkJCQlyZXR1cm4gX19yZXQ7CgkJCQl9CgoJCQkJdmFyIHRpbWVvdXQgPSByZXMuUnVuQWZ0ZXIgLSByZXMuRGF0ZTsKCQkJCWlmICh0aW1lb3V0IDw9IDApIHsKCQkJCQkvLyBuZWdhdGl2ZSB0aW1lb3V0IG1lYW5zIHRoYXQgaXQgd2FzIHN1cHBvc2VkIHRvIGJlIHJ1biBidXQgZGlkIG5vdCBmb3Igc29tZSByZWFzb24gKGRlbGF5LCBmYWlsdXJlLCBldGMuLi4pCgkJCQkJLy8gc2FtZSBkYXRlIGFzIHJ1bmFmdGVyIG1lYW5zIHRoYXQgd2UgYXJlIHVzaW5nIHRoZSBpbW1lZGlhdGUgYXN5bmMgZXhlY3V0aW9uLiBpLmUuIHRoZXJlIGlzIG5vIG5lZWQgZm9yIHRoZSBydW5uZXIgdGhyZWFkIHRhc2sKCQkJCQl0aW1lb3V0ID0gMzAwMDA7CgkJCQl9IGVsc2UgaWYgKHRpbWVvdXQgPiA1ICogNjAgKiAxMDAwKSB7CgkJCQkJLy8gbW9yZSB0aGFuIHdlIGNhbiB3YWl0LCB3ZSByZXR1cm4gYSByZWZlcmVuY2UgdG8gdGhlIHJlc3VsdAoJCQkJCWNvbnNvbGUubG9nKAoJCQkJCQknV2UgY2Fubm90IHdhaXQgJyArCgkJCQkJCU1hdGguZmxvb3IodGltZW91dCAvIDEwMDApICsKCQkJCQkJJyBzZWNvbmRzLiBSZXR1cm5pbmcgcmVzdWx0LicKCQkJCQkpOwoJCQkJCXJldHVybiByZXM7CgkJCQl9CgkJCQljb25zb2xlLmxvZygKCQkJCQknTWFraW5nIHRoZSBuZXh0IGNhbGwgaW4gJyArCgkJCQkJTWF0aC5mbG9vcih0aW1lb3V0IC8gMTAwMCkgKwoJCQkJCScgc2Vjb25kcy4nCgkJCQkpOwoKCQkJCWF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIHRpbWVvdXQpKTsKCQkJCWlmICghdGhpcy5BY3RpdmVSZXF1ZXN0KSB7CgkJCQkJY29uc29sZS5sb2coJ05vIEFjdGl2ZVJlcXVlc3QsIGV4aXRpbmcuLi4nKTsKCQkJCQlyZXR1cm4gbnVsbDsKCQkJCX0KCQkJCXRyeSB7CgkJCQkJbGV0IHJldCA9IGF3YWl0ICQuYWpheCh7CgkJCQkJCXVybDogJy9tZXRob2QvYS5hc2h4P25hbWU9Q29udGVudE1hbmFnZXIuY21zTWV0aG9kUmVzdWx0RmluZCZwMD17Q29kZX0nICsKCQkJCQkJCXJlcy5Db2RlICsKCQkJCQkJCSd7L0NvZGV9e0lkfScgKwoJCQkJCQkJcmVzLklkICsKCQkJCQkJCSd7L0lkfSZyYW5kPScgKwoJCQkJCQkJTWF0aC5yYW5kb20oKSwKCQkJCQl9KTsKCQkJCQlyZXQgPSB0aGlzLnByb2Nlc3NSZXNwb25zZSg0LCBudWxsLCByZXQsIHRoaXMuQWN0aXZlUmVxdWVzdC5VUkwpOwoJCQkJCXJldCA9IGF3YWl0IHRoaXMucHJvY2Vzc1Jlc3VsdChyZXQpOwoJCQkJCXJldHVybiByZXQ7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKCdwcm9jZXNzUmVzdWx0JywgZXgpOwoJCQkJCXJldHVybiBhd2FpdCB0aGlzLl8oJ0NvbnRlbnRNYW5hZ2VyLmNtc01ldGhvZFJlc3VsdEZpbmQnLCBudWxsLCB7CgkJCQkJCUNvZGU6IHJlcy5Db2RlLAoJCQkJCQlJZDogcmVzLklkLAoJCQkJCX0pOwoJCQkJfQoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoZCkgPT4gewoJCQkJbGV0IHRkID0gMDsKCQkJCXRyeSB7CgkJCQkJdGQgPSB3aW5kb3cudGltZURpZmZlcmVuY2U7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCXRkID0gZ2xvYmFsLnRpbWVEaWZmZXJlbmNlOwoJCQkJfQoJCQkJcmV0dXJuIHRoaXMuYWRkTVNlY29uZHMoZCB8fCBuZXcgRGF0ZSgpLCAtdGQpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgobywgbXMpID0+IHsKCQkJCXJldHVybiBuZXcgRGF0ZShvLmdldFRpbWUoKSArIG1zKTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChzKSA9PiB7CgkJCQlpZiAoIXMpIHJldHVybiBudWxsOwoKCQkJCWxldCBjTGluZXMgPSBzLnNwbGl0KCdcbicpOwoJCQkJdHJ5IHsKCQkJCQlpZiAodHlwZW9mKGVzcHJpbWEpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQllc3ByaW1hLnBhcnNlKHMsIHsKCQkJCQkJCWVzNjogdHJ1ZQoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWlmIChjTGluZXNbZXgubGluZU51bWJlciAtIDFdLmluZGV4T2YoJ2ZvciBhd2FpdCcpIDwgMCkgewoJCQkJCQljb25zb2xlLmxvZygicnVuU2NyaXB0KCkgIiArIGV4LmRlc2NyaXB0aW9uLCBleC5saW5lTnVtYmVyLCBjTGluZXNbZXgubGluZU51bWJlciAtIDFdKTsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCX0KCgkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJdHJ5IHsKCQkJCQkJaWYgKHdpbmRvdy5fY29udGVudCAmJiB3aW5kb3cuX2NvbnRlbnQuZXZhbCkgewoJCQkJCQkJdmFyIG91dHB1dCA9IHdpbmRvdy5fY29udGVudC5ldmFsKHMpOwoJCQkJCQkJcmV0dXJuIG91dHB1dDsKCQkJCQkJfQoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJdGhpcy5TaG93RXJyb3IoJ0ZGIFNDUklQVDogXG4nICsgZS5tZXNzYWdlICsgJ1xuJyArIHMpOwoJCQkJCX0KCQkJCQl0cnkgewoJCQkJCQlpZiAod2luZG93LmV4ZWNTY3JpcHQpIHsKCQkJCQkJCWlmIChzLmluZGV4T2YoJ1xyXG4nKSA+IDApIHsKCQkJCQkJCQkvLyBhIG11bHRpLWxpbmUgc3RhdGVtZW50CgkJCQkJCQkJd2luZG93LmV4ZWNTY3JpcHQocyk7CgkJCQkJCQkJcmV0dXJuIG51bGw7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCS8vIGEgc2luZ2xlLWxpbmUgc3RhdGVtZW50CgkJCQkJCQkJbmV3ViA9IG51bGw7CgkJCQkJCQkJdmFyIG5ld1MgPSAnbmV3ViA9ICcgKyBzOwoJCQkJCQkJCXdpbmRvdy5leGVjU2NyaXB0KG5ld1MpOwoJCQkJCQkJCXJldHVybiBuZXdWOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQl0aGlzLlNob3dFcnJvcignSUU2IFNDUklQVDogXG4nICsgZS5tZXNzYWdlICsgJ1xuJyArIHMpOwoJCQkJCX0KCgkJCQkJdHJ5IHsKCQkJCQkJaWYgKHdpbmRvdy5leGVjU2NyaXB0KSB7CgkJCQkJCQlpZiAocy5pbmRleE9mKCdcclxuJykgPiAwKSB7CgkJCQkJCQkJLy8gYSBtdWx0aS1saW5lIHN0YXRlbWVudAoJCQkJCQkJCXdpbmRvdy5leGVjU2NyaXB0KHMpOwoJCQkJCQkJCXJldHVybiBudWxsOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkvLyBhIHNpbmdsZS1saW5lIHN0YXRlbWVudAoJCQkJCQkJCW5ld1YgPSBudWxsOwoJCQkJCQkJCXZhciBuZXdTID0gJ25ld1YgPSAnICsgczsKCQkJCQkJCQlldmFsKG5ld1MpOwoJCQkJCQkJCXJldHVybiBuZXdWOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQl0aGlzLlNob3dFcnJvcignSUU3IFNDUklQVDogXG4nICsgZS5tZXNzYWdlICsgJ1xuJyArIHMpOwoJCQkJCX0KCgkJCQkJdHJ5IHsKCQkJCQkJdmFyIGZuID0gZnVuY3Rpb24oKSB7CgkJCQkJCQl2YXIgcmV0ID0gd2luZG93LmV2YWwuY2FsbCh3aW5kb3csIHMpOwoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfTsKCgkJCQkJCXJldHVybiBmbigpOwoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJdGhpcy5TaG93RXJyb3IoJ1RBRyBTQ1JJUFQ6IFxuJyArIGUubWVzc2FnZSArICdcbicgKyBzKTsKCQkJCQl9CgkJCQl9CgoJCQkJdHJ5IHsKCQkJCQlzID0gcy5yZXBsYWNlKC9uZXcgRGF0ZVwoMDAwMS9nLCAnbmV3IERhdGUoMScpOwoJCQkJCXJldHVybiBldmFsKHMpOwoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCXRoaXMuU2hvd0Vycm9yKCdFVkFMIFNDUklQVDogXG4nICsgZS5tZXNzYWdlICsgJ1xuJyArIHMpOwoJCQkJfQoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChzKSA9PiB7CgkJCQlyZXR1cm4gdGhpcy5ydW5TY3JpcHQoCgkJCQkJJygoKSA9PiB7IHZhciByZXQgPSBudWxsOyAnICsKCQkJCQlzICsKCQkJCQknIGlmKHR5cGVvZih3aW5kb3cpIT09InVuZGVmaW5lZCIpe3dpbmRvdy5tZXRob2RfbmFtZSA9IG1ldGhvZF9uYW1lOyB3aW5kb3cuc2VydmVyX3RpbWUgPSBzZXJ2ZXJfdGltZTsgd2luZG93Ll9leGNlcHRpb24gPSB0eXBlb2YoX2V4Y2VwdGlvbik9PT0idW5kZWZpbmVkIj9udWxsOl9leGNlcHRpb247IHdpbmRvdy5leGVjdXRpb25fdGltZSA9IGV4ZWN1dGlvbl90aW1lO30gcmV0dXJuIHtfZXhjZXB0aW9uOiB0eXBlb2YoX2V4Y2VwdGlvbik9PT0idW5kZWZpbmVkIj9udWxsOl9leGNlcHRpb24sIG1ldGhvZF9uYW1lOiBtZXRob2RfbmFtZSwgc2VydmVyX3RpbWU6IHNlcnZlcl90aW1lLCBleGVjdXRpb25fdGltZTogZXhlY3V0aW9uX3RpbWUsIHJldDogcmV0fTt9KSgpOycKCQkJCSk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgocykgPT4gewoJCQkJdmFyIGhhc2ggPSAwLAoJCQkJCWksCgkJCQkJY2hyLAoJCQkJCWxlbjsKCQkJCWlmIChzLmxlbmd0aCA9PSAwKSByZXR1cm4gaGFzaDsKCQkJCWZvciAoaSA9IDAsIGxlbiA9IHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKCQkJCQljaHIgPSBzLmNoYXJDb2RlQXQoaSk7CgkJCQkJaGFzaCA9IChoYXNoIDw8IDUpIC0gaGFzaCArIGNocjsKCQkJCQloYXNoIHw9IDA7IC8vIENvbnZlcnQgdG8gMzJiaXQgaW50ZWdlcgoJCQkJfQoJCQkJcmV0dXJuIGhhc2g7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoYXIsIGZpZWxkKSA9PiB7CgkJCQlpZiAoIWFyIHx8ICFmaWVsZCkgcmV0dXJuIG51bGw7CgoJCQkJdmFyIGtleXMgPSBbXTsKCQkJCWFyLmZvckVhY2goYSA9PiB7CgkJCQkJdmFyIGtleSA9IG51bGw7CgkJCQkJZmllbGQuc3BsaXQoJy4nKS5mb3JFYWNoKGYgPT4ga2V5ID0gKGtleSB8fCBhKVtmXSk7CgkJCQkJbGV0IGsgPSBrZXlzLmZpbmQoayA9PiB0aGlzLkVxdWFscyhrLmtleSwga2V5KSk7CgkJCQkJaWYgKGspIHsKCQkJCQkJay52YWx1ZXMucHVzaChhKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlrZXlzLnB1c2goewoJCQkJCQkJa2V5OiBrZXksCgkJCQkJCQl2YWx1ZXM6IFthXSwKCQkJCQkJfSk7CgkJCQkJfQoJCQkJfSk7CgkJCQlyZXR1cm4ga2V5czsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHMsIGJJZ25vcmVEZWJ1ZykgPT4gewoJCQkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIikgewoJCQkJCWNvbnNvbGUubG9nKCJTaG93RGVidWc6ICIgKyBzKTsKCQkJCX0KCQkJCWlmICh0aGlzLmJEZWJ1ZyB8fCBiSWdub3JlRGVidWcpIHRoaXMuU2hvd01lc3NhZ2Uocyk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoYXN5bmMgKHJlcXVlc3QsIHRleHRyZXNwb25zZSkgPT4gewoJCQkJaWYgKCF0aGlzLmJDYWNoZVJlc3VsdCkgcmV0dXJuOwoJCQkJcmVxdWVzdCA9IHJlcXVlc3QgfHwgdGhpcy5BY3RpdmVSZXF1ZXN0OwoKCQkJCWlmICghcmVxdWVzdCkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJdGV4dHJlc3BvbnNlICYmCgkJCQkJdGV4dHJlc3BvbnNlLmluZGV4T2YoJ3JldC5Db2RlID0gJykgPiAtMSAmJgoJCQkJCXRleHRyZXNwb25zZS5pbmRleE9mKCdyZXQuUnVuQWZ0ZXIgPSAnKSA+IC0xICYmCgkJCQkJdGV4dHJlc3BvbnNlLmluZGV4T2YoJ3JldC5SZXN1bHQgPSAiIicpID4gLTEKCQkJCSkgewoJCQkJCWNvbnNvbGUubG9nKCd0ZXh0cmVzcG9uc2UgY29udGlhbnMgaW5jb21wbGV0ZSBtZXRob2QgcmVzdWx0Jyk7CgkJCQkJcmV0dXJuIG51bGw7CgkJCQl9CgoJCQkJdmFyIHNNZXRob2QgPSB0aGlzLiRfUkVRVUVTVCgnbmFtZScsIHJlcXVlc3QuVVJMKTsKCQkJCXNNZXRob2QgPSBzTWV0aG9kLnN1YnN0cmluZyhzTWV0aG9kLmxhc3RJbmRleE9mKCcuJykgKyAxKTsKCQkJCXRyeSB7CgkJCQkJdmFyIF91c2FibGUgPSAocikgPT4gewoJCQkJCQl2YXIgaXRlbSA9CgkJCQkJCQkociAmJgoJCQkJCQkJCXIuaGFzaCA9PSByZXF1ZXN0Lmhhc2ggJiYKCQkJCQkJCQkoci5VUkwgPT0gcmVxdWVzdC5VUkwgfHwgdGhpcy4kX1JFUVVFU1QoJ25hbWUnLCByLlVSTCkgPT0gc01ldGhvZCkgJiYKCQkJCQkJCQlyLlRleHRSZXNwb25zZSAmJgoJCQkJCQkJCSh0eXBlb2Ygci5FeHBpcmVzID09PSAndW5kZWZpbmVkJyB8fAoJCQkJCQkJCQluZXcgRGF0ZShyLkV4cGlyZXMpID4gbmV3IERhdGUoKSkpID8KCQkJCQkJCXIgOgoJCQkJCQkJbnVsbDsKCQkJCQkJaWYgKHRleHRyZXNwb25zZSkgewoJCQkJCQkJaXRlbSA9IGl0ZW0gfHwgcmVxdWVzdDsKCQkJCQkJCWl0ZW0uVGV4dFJlc3BvbnNlID0gdGV4dHJlc3BvbnNlOwoJCQkJCQkJaXRlbS5FeHBpcmVzID0gbmV3IERhdGUoCgkJCQkJCQkJbmV3IERhdGUoKS5nZXRUaW1lKCkgKwoJCQkJCQkJCXBhcnNlRmxvYXQoCgkJCQkJCQkJCXRoaXMubkNhY2hlRXhwaXJlSG91cnMgfHwgdGhpcy4kX1JFUVVFU1QoJ25DYWNoZUV4cGlyZUhvdXJzJykgfHwgMQoJCQkJCQkJCSkgKgoJCQkJCQkJCTYwICoKCQkJCQkJCQk2MCAqCgkJCQkJCQkJMTAwMAoJCQkJCQkJKTsKCQkJCQkJfQoKCQkJCQkJcmV0dXJuIGl0ZW07CgkJCQkJfTsKCgkJCQkJaWYgKAoJCQkJCQl0aGlzLmJDYWNoZVJlc3VsdCA9PSAna3ZzdG9yZScgJiYKCQkJCQkJdHlwZW9mIHdpbmRvdy5jb21wYW55LnJlc3Rpb2RiU2V0dGluZ3MgIT09ICd1bmRlZmluZWQnCgkJCQkJKSB7CgkJCQkJCXZhciBhamF4ID0gKGtleSwgdmFsdWUsIGlkKSA9PiB7CgkJCQkJCQl2YXIgcmV0ID0gY29tcGFueS5yZXN0aW9kYlNldHRpbmdzKCk7CgkJCQkJCQlyZXQudXJsICs9ICdrdnN0b3JlJzsKCQkJCQkJCWlmICh2YWx1ZSkgewoJCQkJCQkJCWlmIChpZCkgewoJCQkJCQkJCQkvLyB1cGRhdGUgcmVjb3JkCgkJCQkJCQkJCXJldC51cmwgKz0gJy8nICsgaWQ7CgkJCQkJCQkJCXJldC5tZXRob2QgPSAnUFVUJzsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQkvLyBuZXcgcmVjb3JkCgkJCQkJCQkJCXJldC5tZXRob2QgPSAnUE9TVCc7CgkJCQkJCQkJfQoJCQkJCQkJCXJldC5kYXRhID0gSlNPTi5zdHJpbmdpZnkoewoJCQkJCQkJCQlrZXk6IGtleSwKCQkJCQkJCQkJdmFsdWU6IEpTT04uc3RyaW5naWZ5KHZhbHVlLCBudWxsLCA0KSwKCQkJCQkJCQl9KTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJaWYgKGlkKSB7CgkJCQkJCQkJCS8vIGRlbGV0ZSByZWNvcmQKCQkJCQkJCQkJcmV0LnVybCArPSAnLycgKyBpZDsKCQkJCQkJCQkJcmV0Lm1ldGhvZCA9ICdERUxFVEUnOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCXJldC5tZXRob2QgPSAnR0VUJzsKCQkJCQkJCQkJcmV0LnVybCArPSAnP3E9eyJrZXkiOicgKyBrZXkgKyAnfSc7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQkJLy9jb25zb2xlLmxvZygnbWV0aG9kJywgcmV0Lm1ldGhvZCk7CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9OwoKCQkJCQkJbGV0IHJlY29yZCA9IGF3YWl0ICQuYWpheChhamF4KHJlcXVlc3QuaGFzaCkpOwoJCQkJCQlsZXQgciA9CgkJCQkJCQlyZWNvcmQgJiYgcmVjb3JkLmxlbmd0aCA/CgkJCQkJCQlKU09OLnBhcnNlKHJlY29yZFswXS52YWx1ZSkgOgoJCQkJCQkJbnVsbDsKCQkJCQkJbGV0IGl0ZW0gPSBfdXNhYmxlKHIpOwoKCQkJCQkJaWYgKCFpdGVtKSB7CgkJCQkJCQlpZiAocikgewoJCQkJCQkJCWF3YWl0ICQuYWpheChhamF4KHJlcXVlc3QuaGFzaCwgbnVsbCwgcmVjb3JkWzBdLl9pZCkpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIG51bGw7CgkJCQkJCX0KCgkJCQkJCWlmICghciB8fCBpdGVtLkV4cGlyZXMgPiByLkV4cGlyZXMpIHsKCQkJCQkJCWF3YWl0ICQuYWpheCgKCQkJCQkJCQlhamF4KGl0ZW0uaGFzaCwgaXRlbSwgciA/IHJlY29yZFswXS5faWQgOiBudWxsKQoJCQkJCQkJKTsKCQkJCQkJCXJldHVybiBpdGVtOwoJCQkJCQl9CgoJCQkJCQlyZXR1cm4gaXRlbTsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuYkNhY2hlUmVzdWx0ID09ICdzcicpIHsKCQkJCQkJdmFyIGFqYXggPSAoa2V5LCB2YWx1ZSwgaWQpID0+IHsKCQkJCQkJCXZhciBtZXRob2QgPSAnRmluZCc7CgkJCQkJCQl2YXIgcmV0ID0gewoJCQkJCQkJCXVybDogJy9tZXRob2QvYS5hc2h4P25hbWU9Q29udGVudE1hbmFnZXIuY21zTWV0aG9kUmVzdWx0JywKCQkJCQkJCQlwcm9jZXNzRGF0YTogZmFsc2UsCgkJCQkJCQkJdHlwZTogJ1BPU1QnLAoJCQkJCQkJfTsKCQkJCQkJCWlmICh2YWx1ZSkgewoJCQkJCQkJCWlmIChpZCkgewoJCQkJCQkJCQkvLyB1cGRhdGUgcmVjb3JkCgkJCQkJCQkJCW1ldGhvZCA9ICdVcGRhdGUnOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCS8vIG5ldyByZWNvcmQKCQkJCQkJCQkJbWV0aG9kID0gJ0luc2VydCc7CgkJCQkJCQkJfQoJCQkJCQkJCXJldC5iZWZvcmVTZW5kID0gKHJlcXVlc3QpID0+IHsKCQkJCQkJCQkJcmVxdWVzdC5zZXRSZXF1ZXN0SGVhZGVyKAoJCQkJCQkJCQkJJ0NvbnRlbnQtVHlwZScsCgkJCQkJCQkJCQknbXVsdGlwYXJ0L2Zvcm0tZGF0YTsgYm91bmRhcnk9LS0tLS0tLS0tLS0tLS0nCgkJCQkJCQkJCSk7CgkJCQkJCQkJfTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJcmV0LnR5cGUgPSAnR0VUJzsKCQkJCQkJCQlpZiAoaWQpIHsKCQkJCQkJCQkJLy8gZGVsZXRlIHJlY29yZAoJCQkJCQkJCQltZXRob2QgPSAnRGVsZXRlJzsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQkvLyBnZXQgcmVjb3JkCgkJCQkJCQkJCW1ldGhvZCA9ICdGaW5kJzsKCQkJCQkJCQl9CgkJCQkJCQkJbWV0aG9kICs9CgkJCQkJCQkJCScmcDA9e0NvZGV9JyArCgkJCQkJCQkJCShjb21wYW55ID8gY29tcGFueS5Db2RlICsgJy0nIDogJycpICsKCQkJCQkJCQkJa2V5ICsKCQkJCQkJCQkJJ3svQ29kZX0nOwoJCQkJCQkJfQoJCQkJCQkJcmV0LnVybCArPSBtZXRob2Q7CgkJCQkJCQlpZiAocmV0LnR5cGUgIT0gJ0dFVCcpIHsKCQkJCQkJCQlkZWxldGUgaXRlbS5Qb3N0RGF0YTsgLy8gYmVjYXVzZSB3ZSBoYXZlIHRoZSBjYWNoZSBrZXkKCQkJCQkJCQl2YXIgcDAgPSB7CgkJCQkJCQkJCUNvZGU6IChjb21wYW55ID8gY29tcGFueS5Db2RlICsgJy0nIDogJycpICsga2V5LAoJCQkJCQkJCQlDb21wbGV0ZWQ6IG5ldyBEYXRlKCksCgkJCQkJCQkJCURhdGU6IHRoaXMuQWN0aXZlUmVxdWVzdCA/CgkJCQkJCQkJCQl0aGlzLkFjdGl2ZVJlcXVlc3QuRGF0ZSA6IG5ldyBEYXRlKCksCgkJCQkJCQkJCVJlc3VsdDogYnRvYSh1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQoSlNPTi5zdHJpbmdpZnkoaXRlbSkpKSksIC8vaXRlbS5UZXh0UmVzcG9uc2UsCgkJCQkJCQkJCVN0b3JlZE1ldGhvZDogewoJCQkJCQkJCQkJTmFtZTogc01ldGhvZCwKCQkJCQkJCQkJfSwKCQkJCQkJCQl9OwoJCQkJCQkJCWlmIChpZCkgewoJCQkJCQkJCQlwMC5JZCA9IGlkOwoJCQkJCQkJCX0KCQkJCQkJCQlyZXQuZGF0YSA9CgkJCQkJCQkJCSdQT1NUREFUQT1cclxuJyAvKisgIjw/eG1sIHZlcnNpb249XCIxLjBcIiBlbmNvZGluZz1cInV0Zi04XCIgc3RhbmRhbG9uZT1cInllc1wiPz5cclxuIiovICsKCQkJCQkJCQkJdGhpcy5wYXJhbShbcDBdKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX07CgoJCQkJCQlsZXQgcmVjb3JkID0gdGhpcy5ydW5TY3JpcHQgLypydW5TUlNjcmlwdCovKAoJCQkJCQkJJygoKSA9PiB7IHZhciByZXQgPSBudWxsOyAnICsKCQkJCQkJCShhd2FpdCAkLmFqYXgoYWpheChyZXF1ZXN0Lmhhc2gpKSkgKwoJCQkJCQkJJ3JldHVybiByZXQ7fSkoKTsnCgkJCQkJCSk7CgkJCQkJCWxldCByID0gcmVjb3JkID8gSlNPTi5wYXJzZShyZWNvcmQuUmVzdWx0KSA6IG51bGw7CgkJCQkJCWxldCBpdGVtID0gX3VzYWJsZShyKTsKCgkJCQkJCWlmICghaXRlbSkgewoJCQkJCQkJaWYgKHIpIHsKCQkJCQkJCQl0cnkgewoJCQkJCQkJCQlhd2FpdCAkLmFqYXgoYWpheChyZXF1ZXN0Lmhhc2gsIG51bGwsIHJlY29yZC5JZCkpOwoJCQkJCQkJCX0gY2F0Y2ggKGV4KSB7fQoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIG51bGw7CgkJCQkJCX0KCgkJCQkJCWlmICghciB8fCBpdGVtLkV4cGlyZXMgPiByLkV4cGlyZXMpIHsKCQkJCQkJCWF3YWl0ICQuYWpheCgKCQkJCQkJCQlhamF4KGl0ZW0uaGFzaCwgaXRlbSwgciAmJiByZWNvcmQgPyByZWNvcmQuSWQgOiBudWxsKQoJCQkJCQkJKTsKCQkJCQkJCXJldHVybiBpdGVtOwoJCQkJCQl9CgoJCQkJCQlyZXR1cm4gaXRlbTsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuYkNhY2hlUmVzdWx0ID09ICdnaXRodWInKSB7CgkJCQkJCWlmIChyZXF1ZXN0LlVSTC5pbmRleE9mKCdjbXNNZXRob2RSZXN1bHQnKSA+PSAwKSByZXR1cm4gbnVsbDsKCQkJCQkJbGV0IHJlcyA9IG51bGw7CgkJCQkJCXRyeSB7CgkJCQkJCQlyZXMgPSBhd2FpdCAkLmFqYXgoewoJCQkJCQkJCXVybDogJ2h0dHBzOi8vYXJ6aG9zcGl0YWwuZ2l0aHViLmlvLycgKwoJCQkJCQkJCQljb21wYW55LlN0b3JlICsKCQkJCQkJCQkJJy8nICsKCQkJCQkJCQkJcmVxdWVzdC5oYXNoICsKCQkJCQkJCQkJJy5qcycsCgkJCQkJCQkJZGF0YVR5cGU6ICdqc29ucCcsCgkJCQkJCQkJcHJvY2Vzc1Jlc3VsdDogZmFsc2UsCgkJCQkJCQl9KTsKCQkJCQkJCXJldHVybiB7CgkJCQkJCQkJVGV4dFJlc3BvbnNlOiByZXMsCgkJCQkJCQl9OwoJCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQkJY29uc29sZS5sb2coJ0VSUk9SUzonLCBleCk7CgkJCQkJCQlyZXR1cm4gbnVsbDsKCQkJCQkJfQoJCQkJCX0gZWxzZSBpZiAodGhpcy5iQ2FjaGVSZXN1bHQgPT0gJ2xvY2FsJykgewoJCQkJCQl2YXIgc3JDYWNoZSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdzckNhY2hlJyk7CgkJCQkJCWlmIChzckNhY2hlID09IG51bGwpIHsKCQkJCQkJCXNyQ2FjaGUgPSB7CgkJCQkJCQkJUmVxdWVzdHM6IHt9LAoJCQkJCQkJfTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXNyQ2FjaGUgPSBKU09OLnBhcnNlKHNyQ2FjaGUpOwoJCQkJCQl9CgoJCQkJCQl2YXIgciA9IHNyQ2FjaGUuUmVxdWVzdHNbcmVxdWVzdC5oYXNoXTsKCQkJCQkJdmFyIGl0ZW0gPSBfdXNhYmxlKHIpOwoKCQkJCQkJaWYgKCFpdGVtKSB7CgkJCQkJCQlkZWxldGUgc3JDYWNoZS5SZXF1ZXN0c1tyZXF1ZXN0Lmhhc2hdOwoJCQkJCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ3NyQ2FjaGUnLCBKU09OLnN0cmluZ2lmeShzckNhY2hlKSk7CgkJCQkJCQlyZXR1cm4gbnVsbDsKCQkJCQkJfQoKCQkJCQkJaWYgKCFyIHx8IGl0ZW0uRXhwaXJlcyA+IHIuRXhwaXJlcykgewoJCQkJCQkJc3JDYWNoZS5SZXF1ZXN0c1tpdGVtLmhhc2hdID0gaXRlbTsKCQkJCQkJCWxvY2FsU3RvcmFnZS5zZXRJdGVtKCdzckNhY2hlJywgSlNPTi5zdHJpbmdpZnkoc3JDYWNoZSkpOwoJCQkJCQkJcmV0dXJuIGl0ZW07CgkJCQkJCX0KCgkJCQkJCXJldHVybiBpdGVtOwoJCQkJCX0KCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coZXgpOwoJCQkJCXRocm93IGV4OwoJCQkJfQoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHMpID0+IHsKCQkJCWlmICh0eXBlb2YgcyAhPT0gJ3N0cmluZycpIHJldHVybiBzOwoKCQkJCXZhciBhcnIxID0gW107CgkJCQlmb3IgKHZhciBuID0gMCwgbCA9IHMubGVuZ3RoOyBuIDwgbDsgbisrKSB7CgkJCQkJdmFyIGhleCA9IE51bWJlcihzLmNoYXJDb2RlQXQobikpLnRvU3RyaW5nKDE2KTsKCQkJCQlhcnIxLnB1c2goaGV4KTsKCQkJCX0KCQkJCXJldHVybiBhcnIxLmpvaW4oJycpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHMpID0+IHsKCQkJCWNvbnNvbGUubG9nKHMpOwoJCQkJaWYgKHRoaXMuYlNob3dFcnJvcnMpIHRoaXMuU2hvd01lc3NhZ2Uocyk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKG8xLCBvMikgPT4gewoJCQkJaWYgKG8xID09IG8yKSByZXR1cm4gdHJ1ZTsKCgkJCQlpZiAoCgkJCQkJbzEgJiYKCQkJCQlvMS5fX09CSkVDVElEICYmCgkJCQkJbzIgJiYKCQkJCQlvMi5fX09CSkVDVElEICYmCgkJCQkJbzEuX19PQkpFQ1RJRCA9PSBvMi5fX09CSkVDVElECgkJCQkpCgkJCQkJcmV0dXJuIHRydWU7CgkJCQlpZiAobzEgJiYgbzEuX19ST1dJRCAmJiBvMiAmJiBvMi5fX1JPV0lEICYmIG8xLl9fUk9XSUQgPT0gbzIuX19ST1dJRCkKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCWlmIChvMSAmJiBvMS5JZCAmJiBvMiAmJiBvMi5JZCAmJiBvMS5JZCA9PSBvMi5JZCkgcmV0dXJuIHRydWU7CgoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKCgpID0+IHsKCQkJCXRyeSB7CgkJCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIG51bGw7CgkJCQkJaWYgKHR5cGVvZihnbG9iYWwpID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YoZ2xvYmFsLm9zKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkJLy8gY29uc29sZS5sb2coImlwQWRkcmVzcygpOiBJbnZhbGlkIGdsb2JhbCBvciBnbG9iYWwub3Mgbm90IGRlZmluZWQiKTsKCQkJCQkJcmV0dXJuIG51bGw7CgkJCQkJfQoJCQkJCXJldHVybiBbXS5jb25jYXQoLi4uT2JqZWN0LnZhbHVlcyhnbG9iYWwub3MubmV0d29ya0ludGVyZmFjZXMoKSkpLmZpbmQoKGRldGFpbHMpID0+IGRldGFpbHMuZmFtaWx5ID09PSAnSVB2NCcgJiYgIWRldGFpbHMuaW50ZXJuYWwpLmFkZHJlc3M7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKCJpcEFkZHJlc3MoKTogIiArIGV4KTsKCQkJCQlyZXR1cm4gbnVsbDsKCQkJCX0KCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKGVhKSA9PiB7CgkJCQl0cnkgewoJCQkJCWlmIChlYS5FbnRpdHlUeXBlKSByZXR1cm4gIkVudGl0eSI7CgkJCQkJcmV0dXJuIE9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiAhay5pbmRleE9mKCJJcyIpICYmIGsgIT09ICJJc1VuaXF1ZSIpLmZpbmQoayA9PiBlYVtrXSkucmVwbGFjZSgnSXMnLCAnJyk7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCXJldHVybiBudWxsOwoJCQkJfQoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChhKSA9PiB7CgkJCQlyZXR1cm4gYS5maWx0ZXIoKGFnLCBpKSA9PiAhYS5maW5kKChfYWcsIF9pKSA9PiBfYWcuTmFtZSA9PSBhZy5OYW1lICYmIF9pID4gaSAmJiBpID09IF9pKSk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIChhc3luYyAoc2NvcGUsIGZpbGVuYW1lKSA9PiB7CgkJCQlsZXQgb1Njb3BlID0gdGhpcy5fX3Njb3BlKHNjb3BlKTsKCgkJCQlsZXQgcyA9IHsKCQkJCQlFbmFibGVkOiB0cnVlLAoJCQkJCU5hbWU6ICJBUElTRVJWRVI6OiIgKyBzY29wZSwKCQkJCX07CgkJCQlpZiAob1Njb3BlLl9fc2NyaXB0ICYmIG9TY29wZS5fX3NjcmlwdC5EYXRlKSB7CgkJCQkJcy5EYXRlID0gb1Njb3BlLl9fc2NyaXB0LkRhdGU7CgkJCQkJcy5PUEVSQVRPUlMgPSB7CgkJCQkJCURhdGU6ICI+IgoJCQkJCX0KCQkJCX0KCQkJCWxldCBzY3JpcHQgPSBhd2FpdCB0aGlzLnNyKCkuXyhgQ29udGVudE1hbmFnZXIuY21zU3RvcmVkU2NyaXB0RmluZGAsIG51bGwsIHMpOwoJCQkJaWYgKHNjcmlwdCAmJiBzY3JpcHQuU2NyaXB0KSB7CgkJCQkJc2NyaXB0LlNjcmlwdCA9IHRoaXMuX2F0b2Ioc2NyaXB0LlNjcmlwdCk7CgkJCQl9IGVsc2UgewoJCQkJCS8vIGNvbnNvbGUubG9nKCJfcmVmcmVzaEFQSTogc2NyaXB0IGlzIG51bGwiKTsKCQkJCQlyZXR1cm4gMTsKCQkJCX0KCgkJCQlpZiAoIW9TY29wZSB8fCAhb1Njb3BlLl9fc2NyaXB0IHx8IChzY3JpcHQgJiYgc2NyaXB0LlNjcmlwdCAmJiAoKHNjcmlwdC5EYXRlLmdldFRpbWUoKSAtIG9TY29wZS5fX3NjcmlwdC5EYXRlLmdldFRpbWUoKSkgLyAxMDAwKSA+IDUpKSB7CgkJCQkJaWYgKGZpbGVuYW1lKSB7CgkJCQkJCWNvbnNvbGUubG9nKCJbIiArIHNjb3BlICsgIl0gTmV3IFVwZGF0ZWQgVmVyc2lvbiwgb3ZlcndyaXR0aW5nICIgKyBmaWxlbmFtZSwgc2NyaXB0LkRhdGUsIChvU2NvcGUgJiYgb1Njb3BlLl9fc2NyaXB0KSA/IG9TY29wZS5fX3NjcmlwdC5EYXRlIDogbnVsbCk7CgkJCQkJfQoKCQkJCQlpZiAoZmlsZW5hbWUgJiYgdHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJCWF3YWl0IGdsb2JhbC51dGlsLnByb21pc2lmeShnbG9iYWwuZnMud3JpdGVGaWxlKShmaWxlbmFtZSwgc2NyaXB0LlNjcmlwdCk7CgkJCQkJfSBlbHNlIGlmIChmaWxlbmFtZSkgewoJCQkJCQlhd2FpdCB0aGlzLnNyKCkuXygnQ29udGVudE1hbmFnZXIuY21zU2F2ZUZpbGVCb2R5JywgbnVsbCwgZmlsZW5hbWUsIHRoaXMuX2J0b2Eoc2NyaXB0LlNjcmlwdCkpOwoJCQkJCX0KCgkJCQkJaWYgKCFvU2NvcGUpIHJldHVybjsKCQkJCQlvU2NvcGUuX19zY3JpcHQgPSBzY3JpcHQ7CgkJCQl9IGVsc2UgewoJCQkJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcpCgkJCQkJCWNvbnNvbGUubG9nKGBbJHtzY29wZX1dIFNhbWUgb3Igb2xkZXIgdmVyc2lvbiwgc2tpcHBpbmcgdXBkYXRlYCwgc2NyaXB0ID8gc2NyaXB0LkRhdGUgOiBudWxsLCBvU2NvcGUuX19zY3JpcHQgPyBvU2NvcGUuX19zY3JpcHQuRGF0ZSA6IG51bGwpOwoJCQkJfQoKCQkJCWRlbGV0ZSBvU2NvcGUuX19zY3JpcHQuU2NyaXB0OwoJCQkJcmV0dXJuIG9TY29wZS5fX3NjcmlwdDsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoc2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnID8gd2luZG93IDogZ2xvYmFsKTsKCQkJCWlmIChzY29wZSkgcmV0ID0gcmV0W3Njb3BlXTsKCQkJCXJldHVybiByZXQ7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoKSA9PiB7CgkJCQlyZXR1cm4gKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuU1IpID8gd2luZG93LlNSIDogdGhpczsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoYSkgPT4gewoJCQkJcmV0dXJuIHR5cGVvZihhdG9iKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShhLCAnYmFzZTY0JykudG9TdHJpbmcoJ2JpbmFyeScpIDogYXRvYihhKTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoYikgPT4gewoJCQkJcmV0dXJuIHR5cGVvZihidG9hKSA9PT0gInVuZGVmaW5lZCIgPyBCdWZmZXIuZnJvbShiKS50b1N0cmluZygnYmFzZTY0JykgOiBidG9hKHVuZXNjYXBlKGVuY29kZVVSSUNvbXBvbmVudChiKSkpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChuYW1lID0gImdsb2JhbCIpID0+IHsKCQkJCWxldCBkID0gbmV3IERhdGUoKSB8fCB0aGlzLnNyKCkuc2VydmVyRGF0ZSgpOwoJCQkJdGhpcy5fX3Njb3BlKCkuX190aW1lcyA9IHRoaXMuX19zY29wZSgpLl9fdGltZXMgfHwge307CgkJCQl0aGlzLl9fc2NvcGUoKS5fX3RpbWVzW25hbWVdID0gdGhpcy5fX3Njb3BlKCkuX190aW1lc1tuYW1lXSB8fCBkOwoKCQkJCWxldCBzID0gTWF0aC5yb3VuZCgoKGQgLSB0aGlzLl9fc2NvcGUoKS5fX3RpbWVzW25hbWVdKSAvIDEwMDApICogMTAwLCAyKSAvIDEwMDsKCQkJCXRoaXMuX19zY29wZSgpLl9fdGltZXNbbmFtZV0gPSBkOwoJCQkJcmV0dXJuIChzICsgJ3MnKTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoYXN5bmMgKG1zKSA9PiB7CgkJCQlhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgbXMpKTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoZWEsIGRiVHlwZSkgPT4gewoJCQkJbGV0IHR5cGUgPSB0eXBlb2YoZWEpID09PSAic3RyaW5nIiA/IGVhIDogdGhpcy5fYXR0cihlYSk7CgkJCQlzd2l0Y2ggKHR5cGUpIHsKCQkJCQljYXNlICJTdHJpbmciOgoJCQkJCQlyZXR1cm4gIlZBUkNIQVIoMjU1KSI7CgkJCQkJY2FzZSAiVGV4dCI6CgkJCQkJY2FzZSAiT2JqZWN0IjoKCQkJCQkJcmV0dXJuIGAke2RiVHlwZT09J3NxbGl0ZSc/J1ZBUkNIQVInOidURVhUJ30oNDAwMClgOwoJCQkJCWNhc2UgIkJvb2wiOgoJCQkJCQlyZXR1cm4gIlRJTllJTlQiOyAvL0JJVAoJCQkJCWNhc2UgIkRhdGUiOgoJCQkJCQlyZXR1cm4gIkRBVEVUSU1FIjsKCQkJCQljYXNlICJJbnQiOgoJCQkJCQlyZXR1cm4gIklOVEVHRVIiOwoJCQkJCWNhc2UgIkxvbmciOgoJCQkJCQlyZXR1cm4gIkJJR0lOVCI7CgkJCQkJY2FzZSAiRW50aXR5IjoKCQkJCQkJcmV0dXJuICJWQVJDSEFSKDI1NSkiOwoJCQkJCWNhc2UgIkltYWdlIjoKCQkJCQljYXNlICJGaWxlIjoKCQkJCQkJcmV0dXJuICJCTE9CIjsKCQkJCQlkZWZhdWx0OgoJCQkJCQlyZXR1cm4gdHlwZSArICIoNDApIjsKCQkJCX0KCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoaWQsIGxlbikgPT4gewoJCQkJbGV0IHJldCA9IG51bGw7CgoJCQkJaWYgKCFyZXQgJiYgdHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZihjcnlwdG8pICE9PSAndW5kZWZpbmVkJykgcmV0ID0gY3J5cHRvLnJhbmRvbVVVSUQoKTsKCQkJCWlmICghcmV0ICYmIHR5cGVvZih1dWlkdjQpICE9PSAidW5kZWZpbmVkIikgcmV0ID0gdXVpZHY0KCk7CgoJCQkJaWYgKCFyZXQpIHJldCA9ICgoKGlkID8gTnVtYmVyKGlkKSA6IG5ldyBEYXRlKCkuZ2V0VGltZSgpIC8gMTApIHwgMCkudG9TdHJpbmcoMTYpKSArICd4eHh4eHh4eHh4eHh4eHh4Jy5yZXBsYWNlKC9beF0vZywgKCkgPT4gewoJCQkJCXJldHVybiAoKGlkID8gaWQgOiBNYXRoLnJhbmRvbSgpKSAqIDE2IHwgMCkudG9TdHJpbmcoMTYpOwoJCQkJfSkudG9Mb3dlckNhc2UoKS5zdWJzdHJpbmcoMCwgbGVuIHx8IDI0KS5yZXBsYWNlKC9cLS9nLCAnJyk7CgoJCQkJLy9sZXQgcG9vbCA9ICh0aGlzLl9fc2NvcGUoKS5fX3V1aWRQb29sID0gdGhpcy5fX3Njb3BlKCkuX191dWlkUG9vbCB8fCBbXSk7CgkJCQkvL2lmIChwb29sLmZpbmQodSA9PiB1ID09IHJldCkpIHJldHVybiB0aGlzLl91dWlkKGlkLCBsZW4pOwoJCQkJLy9wb29sLnB1c2gocmV0KTsKCgkJCQlyZXR1cm4gcmV0OwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKGFzeW5jIChsaWJOYW1lLCBocmVmcykgPT4gewoJCQkJZm9yIGF3YWl0IChjb25zdCBuIG9mIChocmVmcyB8fCB0aGlzLmhyZWZzKS5maWx0ZXIobCA9PiBsLmxpYiA9PT0gbGliTmFtZSAmJiB0aGlzLl9pbmNsdWRlKGwpKSkgewoJCQkJCW4ucmVxdWlyZXMgPSBuLnJlcXVpcmVzIHx8IFtdOwoJCQkJCWZvciBhd2FpdCAoY29uc3QgciBvZiBuLnJlcXVpcmVzLmZpbHRlcihyID0+IHIgIT0gbGliTmFtZSkpIHsKCQkJCQkJYXdhaXQgdGhpcy5yZXF1aXJlKHIsIGhyZWZzKTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodGhpcy5fY3NzKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkJZm9yIChjb25zdCBjIG9mIEFycmF5LmlzQXJyYXkobi5jc3MpID8gbi5jc3MgOiBbbi5jc3NdKSB7CgkJCQkJCQl0aGlzLl9jc3MoYyk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJdmFyIG1vZHVsZXMgPSBbXTsKCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHMgb2YgQXJyYXkuaXNBcnJheShuLnNyYykgPyBuLnNyYyA6IFtuLnNyY10pIHsKCQkJCQkJdHJ5IHsKCQkJCQkJCWlmIChzLk5hbWUpIHsKCQkJCQkJCQkvLyBzdG9yZWQgc2NyaXB0CgkJCQkJCQkJbGV0IF9zYyA9IGF3YWl0IHNyLl8oIkNvbnRlbnRNYW5hZ2VyLmNtc1N0b3JlZFNjcmlwdEZpbmQiLCBudWxsLCBzKTsKCQkJCQkJCQlhd2FpdCBzci5ydW5TY3JpcHQoX3NjLlNjcmlwdCk7CgkJCQkJCQl9IGVsc2UgaWYgKG4ubW9kdWxlKSB7CgkJCQkJCQkJbW9kdWxlcy5wdXNoKGF3YWl0IGltcG9ydChzKSk7CgkJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZigkKSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKCQuYWpheCkgIT09ICd1bmRlZmluZWQnKSB7CgoJCQkJCQkJCWF3YWl0ICQuYWpheCh7CgkJCQkJCQkJCXVybDogbi5jYWNoZSA/IHMgOiB0aGlzLnJhbmRVUkwocyksCgkJCQkJCQkJCWRhdGFUeXBlOiAic2NyaXB0IiwKCQkJCQkJCQkJY2FjaGU6IG4uY2FjaGUgPyAnZm9yY2UtY2FjaGUnIDogJ2RlZmF1bHQnCgkJCQkJCQkJfSk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWF3YWl0IG5ldyBQcm9taXNlKHIgPT4gewoJCQkJCQkJCQlsZXQgc2NyaXB0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7CgkJCQkJCQkJCXNjcmlwdC5vbmxvYWQgPSAoKSA9PiByKCk7CgkJCQkJCQkJCXNjcmlwdC5zcmMgPSBzOwoJCQkJCQkJCQkoZG9jdW1lbnQuYm9keSB8fCBkb2N1bWVudC5oZWFkKS5hcHBlbmRDaGlsZChzY3JpcHQpOwoJCQkJCQkJCX0pOwoJCQkJCQkJfQoJCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIG4ubGliICsgIl0gRXhjZXB0aW9uOiAiICsgZXgsIHMpOwoJCQkJCQl9CgkJCQkJfQoJCQkJCWlmIChuLmxvYWQpIHsKCQkJCQkJdHJ5IHsKCQkJCQkJCWF3YWl0IG4ubG9hZChtb2R1bGVzKTsKCQkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJCWNvbnNvbGUubG9nKCJFeGNlcHRpb24gaW4gbG9hZCgpIG9mICIgKyBuLmxpYiwgZXgpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfQoJCQkJY29uc29sZS5sb2coInJlcXVpcmVbIiArIGxpYk5hbWUgKyAiXSIpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKF9ocmVmKSA9PiB7CgkJCQlyZXR1cm4gIShfaHJlZi5kaXNhYmxlZCB8fCAoX2hyZWYudHlwZSAmJiB0aGlzLmlzTW9iaWxlKCkgJiYgX2hyZWYudHlwZSAhPSAibW9iaWxlIikgfHwgKF9ocmVmLnR5cGUgJiYgIXRoaXMuaXNNb2JpbGUoKSAmJiBfaHJlZi50eXBlID09ICJtb2JpbGUiKSk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHZhbHVlLCB0eXBlKSA9PiB7CgkJCQl0cnkgewoJCQkJCWlmICh0eXBlb2YoYmVhdXRpZmllcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXZhciBvcHRpb25zID0gewoJCQkJCQkJImluZGVudF9zaXplIjogIjEiLAoJCQkJCQkJImluZGVudF9jaGFyIjogIlx0IiwKCQkJCQkJCSJtYXhfcHJlc2VydmVfbmV3bGluZXMiOiAiMiIsCgkJCQkJCQkicHJlc2VydmVfbmV3bGluZXMiOiB0cnVlLAoJCQkJCQkJImtlZXBfYXJyYXlfaW5kZW50YXRpb24iOiBmYWxzZSwKCQkJCQkJCSJicmVha19jaGFpbmVkX21ldGhvZHMiOiBmYWxzZSwKCQkJCQkJCSJpbmRlbnRfc2NyaXB0cyI6ICJub3JtYWwiLAoJCQkJCQkJImJyYWNlX3N0eWxlIjogImNvbGxhcHNlIiwKCQkJCQkJCSJzcGFjZV9iZWZvcmVfY29uZGl0aW9uYWwiOiB0cnVlLAoJCQkJCQkJInVuZXNjYXBlX3N0cmluZ3MiOiBmYWxzZSwKCQkJCQkJCSJqc2xpbnRfaGFwcHkiOiBmYWxzZSwKCQkJCQkJCSJlbmRfd2l0aF9uZXdsaW5lIjogZmFsc2UsCgkJCQkJCQkid3JhcF9saW5lX2xlbmd0aCI6ICIwIiwKCQkJCQkJCSJpbmRlbnRfaW5uZXJfaHRtbCI6IGZhbHNlLAoJCQkJCQkJImNvbW1hX2ZpcnN0IjogZmFsc2UsCgkJCQkJCQkiZTR4IjogdHJ1ZSwKCQkJCQkJCSJpbmRlbnRfZW1wdHlfbGluZXMiOiBmYWxzZQoJCQkJCQl9OwoJCQkJCQlpZiAoWydjc2hhcnAnLCAnamF2YXNjcmlwdCddLmluZGV4T2YodHlwZSkgPiAtMSkgewoJCQkJCQkJdmFsdWUgPSBiZWF1dGlmaWVyLmpzKHR5cGVvZih2YWx1ZSkgIT09ICdzdHJpbmcnID8gSlNPTi5zdHJpbmdpZnkodmFsdWUpIDogdmFsdWUsIG9wdGlvbnMpOwoJCQkJCQl9IGVsc2UgaWYgKFsnaHRtbCddLmluZGV4T2YodHlwZSkgPiAtMSkgewoJCQkJCQkJdmFsdWUgPSBiZWF1dGlmaWVyLmh0bWwodmFsdWUsIG9wdGlvbnMpOwoJCQkJCQl9CgkJCQkJfQoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCQlyZXR1cm4gdmFsdWU7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCWJ5RGVwYXJ0bWVudChhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfZGVwYXJ0bWVudCJdICYmIChhWyJfZGVwYXJ0bWVudCJdLkVxdWFscyA/IGFbIl9kZXBhcnRtZW50Il0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9kZXBhcnRtZW50Il0sIHIpKSkgewoJCQkJCXIuX2RlcGFydG1lbnRfVXNlcnMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuX25hbWU7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IGZhbHNlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Vc2VyLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5Vc2VyKG51bGwsIHRoaXMuVG9vbCk7CgoJCQkJbGV0IGJGaW5kID0gZmFsc2U7CgkJCQlpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLklkID0gdGhpcy5JZDsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy51c2VybmFtZSh0aGlzLnVzZXJuYW1lKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuY29kZSh0aGlzLmNvZGUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX2RlcGFydG1lbnRfc2V0ICYmIHRoaXMuZGVwYXJ0bWVudCgpICYmICEoYXdhaXQgdGhpcy5kZXBhcnRtZW50KCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfZGVwYXJ0bWVudCgpOwoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMubWFuYWdlcl9EZXBhcnRtZW50cygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAodGhpcy5fY2FsbGVyX0luY2lkZW50c19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLmNhbGxlcl9JbmNpZGVudHMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuY29udGFjdF9JbmNpZGVudHMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLnVzZXJfR3JvdXBfTWVtYmVycygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlVzZXIuaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b0luc2VydFNRTCgpKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luc2VydCcsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuVXNlci51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1VwZGF0ZVNRTCgpKTsKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTCgpKTsKCQkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IHJldFswXTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuVXNlci5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSAoYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgKTsKCQkJCXJldCA9IHJldCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5Vc2VyKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXRyeSB7CgkJCWlmIChkZXB0aCA+IDEpIHsKCQkJCWZvciBhd2FpdCAoY29uc3QgciBvZiByZXQpIHsKCgkJCQkJaWYgKHIuX2RlcGFydG1lbnRfc2V0KSB7CgkJCQkJCXIuZGVwYXJ0bWVudChhd2FpdCByLl9kZXBhcnRtZW50LmZpbmQoZGVwdGggLSAxKSk7CgkJCQkJfQoKCQkJCQlyLm1hbmFnZXJfRGVwYXJ0bWVudHMoYXdhaXQgbmV3IHNhbGVzbm93LkRlcGFydG1lbnQobnVsbCwgci5Ub29sKS5tYW5hZ2VyKHIpLmZpbmRBbGwoZGVwdGggLSAxKSk7CgoJCQkJCXIuY2FsbGVyX0luY2lkZW50cyhhd2FpdCBuZXcgc2FsZXNub3cuSW5jaWRlbnQobnVsbCwgci5Ub29sKS5jYWxsZXIocikuZmluZEFsbChkZXB0aCAtIDEpKTsKCgkJCQkJci5jb250YWN0X0luY2lkZW50cyhhd2FpdCBuZXcgc2FsZXNub3cuSW5jaWRlbnQobnVsbCwgci5Ub29sKS5jb250YWN0KHIpLmZpbmRBbGwoZGVwdGggLSAxKSk7CgoJCQkJCXIudXNlcl9Hcm91cF9NZW1iZXJzKGF3YWl0IG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIobnVsbCwgci5Ub29sKS51c2VyKHIpLmZpbmRBbGwoZGVwdGggLSAxKSk7CgoJCQkJfQoJCQl9CgoJCQlsZXQgcmVmcyA9IFtdOwoJCQlpZiAoIUFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gW3JldF07CgoJCQlyZWZzLnB1c2goLi4ucmV0LmZpbHRlcihyID0+IHIuRW50aXR5Q2xhc3MpKTsKCQkJZm9yIGF3YWl0IChjb25zdCBvIG9mIChvYmpzIHx8IFtdKSkgewoJCQkJbGV0IG9mYSA9IFtdOwoJCQkJaWYgKG8uX3RvRU1TT2JqZWN0KSB7CgkJCQkJb2ZhID0gYXdhaXQgdGhpcy5fZnJvbUVNU1ZhbHVlcyhhd2FpdCBvLl90b0VNU09iamVjdCh0cnVlLCB0cnVlKS5maW5kQWxsKGRlcHRoKSk7CgkJCQl9IGVsc2UgewoJCQkJCW9mYSA9IGF3YWl0IG8uZmluZEFsbChkZXB0aCk7CgkJCQl9CgkJCQlyZWZzLnB1c2goLi4ub2ZhKTsKCQkJfQoJCQlyZWZzID0gcmVmcy5maWx0ZXIociA9PiByKTsKCQkJcmVmcy5mb3JFYWNoKHIgPT4gewoJCQkJZm9yICh2YXIgcCBpbiByKSB7CgkJCQkJaWYgKHAuc3RhcnRzV2l0aCgnXycpICYmIHJbcF0gJiYgcltwICsgIl9zZXQiXSAmJiByW3BdLklkICYmIHJlZnMuZmluZChvID0+IG8uSWQgPT0gcltwXS5JZCkpIHsKCQkJCQkJcltwLnN1YnN0cmluZygxKV0ocmVmcy5maW5kKG8gPT4gby5JZCA9PSByW3BdLklkKSk7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ZpbmRSZWZlcmVuY2VzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgoJfQoKfTsKCnNhbGVzbm93LkRlcGFydG1lbnQgPSBjbGFzcyBEZXBhcnRtZW50IGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUWlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUp6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpWYzJWeUlqcDdJbDloZFhSb2IzSnBlbVV1ZFhObGNtNWhiV1VpT2lKbVlXUnBJaXdpWDJGMWRHaHZjbWw2WlM1d1lYTnpkMjl5WkNJNklqRXlNeUlzSWw5aGRYUm9iM0pwZW1VdWRHVnpkRlZ6WlhJaU9uc2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0puWlc1a1pYSWlPbnNpWTI5a1pTSTZJazBpTENKdVlXMWxJam9pVFdGc1pTSjlMQ0pqYjJSbElqb2labUZrYVNJc0ltNWhiV1VpT2lKR1lXUnBJbjE5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpUY1d4RVFpSXNJa2RwZEVoMVlpSmRgKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLk1hcHBpbmdzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgVzEwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoKCQkvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUKCQl0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307CgkJdGhpcy5Ub29sID0gdG9vbDsKCQl0aGlzLklkID0gaWQ7CgoJCXRoaXMuVmFsdWVFbnRpdGllcyA9IFtdOwoKCQl0aGlzLkRhdGUgPSBudWxsOwoKCQl0aGlzLmNsZWFyX1RISVMoKTsKCQl0aGlzLkVudGl0eVZhbHVlcyA9IFtdOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm1hbmFnZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX21hbmFnZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2FjdGl2ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2VuYWJsZWQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb2RlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb2RlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3JkZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29yZGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZGF0ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZGF0ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm5hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX25hbWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3JlbWFyaygpOwoKCQl0aGlzLmNsZWFyX2RlcGFydG1lbnRfVXNlcnMoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJEZXBhcnRtZW50IiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQlyZXR1cm4gdGhpczsKCgkJaWYgKHRoaXMuX21hbmFnZXJfc2V0ICYmIHRoaXMuX21hbmFnZXIpIHRoaXMuX21hbmFnZXIuVG9vbCA9IHRvb2w7CgoJCSh0aGlzLmRlcGFydG1lbnRfVXNlcnMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbWFuYWdlciAqKi8KCW1hbmFnZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9tYW5hZ2VyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibWFuYWdlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2Y1ODdkYmE0LTcxYjUtNDRlMS1hNDJjLTU1N2Y1MGEzNzE1NScgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ1VzZXInKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnbWFuYWdlcicsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgImY1ODdkYmE0LTcxYjUtNDRlMS1hNDJjLTU1N2Y1MGEzNzE1NSIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJVc2VyIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX21hbmFnZXIgIT0gdikgewoJCQkJdGhpcy5fbWFuYWdlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ21hbmFnZXInLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX21hbmFnZXIgPyB0aGlzLl9tYW5hZ2VyLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9tYW5hZ2VyX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9tYW5hZ2VyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX21hbmFnZXIpOwoJCX0KCX0KCgljbGVhcl9tYW5hZ2VyKCkgewoJCXRoaXMuX21hbmFnZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9tYW5hZ2VyID0gbnVsbDsKCQl0aGlzLl9tYW5hZ2VyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBtYW5hZ2VyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGVwYXJ0bWVudF9Vc2VycyAqKi8KCWRlcGFydG1lbnRfVXNlcnModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX2RlcGFydG1lbnRfVXNlcnM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2Y1ODdkYmE0LTcxYjUtNDRlMS1hNDJjLTU1N2Y1MGEzNzE1NScgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnVXNlcicpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fZGVwYXJ0bWVudF9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdkZXBhcnRtZW50X1VzZXJzJywgJ0VudGl0eU9iamVjdCcsIDEsICJkZXBhcnRtZW50IGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJVc2VyIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZGVwYXJ0bWVudF9Vc2VycycsICdFbnRpdHlPYmplY3QnLCAxLCAiZGVwYXJ0bWVudCBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIlVzZXIiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YuZGVwYXJ0bWVudCh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9kZXBhcnRtZW50X1VzZXJzLnB1c2goLi4udik7CgkJdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfZGVwYXJ0bWVudF9Vc2VycygpIHsKCQl0aGlzLl9kZXBhcnRtZW50X1VzZXJzX3NldCA9IG51bGw7CgkJdGhpcy5fZGVwYXJ0bWVudF9Vc2VycyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX2RlcGFydG1lbnRfVXNlcnNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkZXBhcnRtZW50X1VzZXJzICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fbWFuYWdlcl9zZXQsCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9tYW5hZ2VyX3NldCA9IHRoaXMuX21hbmFnZXJfc2V0OwoJCXJldC5fbWFuYWdlcl9jb29wID0gdGhpcy5fbWFuYWdlcl9jb29wOwoJCXJldC5tYW5hZ2VyID0gdGhpcy5tYW5hZ2VyKCkgPyB0aGlzLm1hbmFnZXIoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5tYW5hZ2VyKCk7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5kZXBhcnRtZW50X1VzZXJzID0gdGhpcy5kZXBhcnRtZW50X1VzZXJzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJtYW5hZ2VyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQlkZXBhcnRtZW50X1VzZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudF9EZXBhcnRtZW50cycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJtYW5hZ2VyIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBtYW5hZ2VyJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Vc2VyKCkubWFuYWdlcl9EZXBhcnRtZW50cyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpICE9ICdEZXBhcnRtZW50JykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL0RlcGFydG1lbnQvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQkJZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOwoJCQkJZGVsZXRlIGRhdGEuX190aGlzLm9ubGluZTsKCgkJCX0KCgkJCS8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/PwoKCQkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJCXRyeSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0pIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7bWV0aG9kfWApOwoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCWxldCBfaWQgPSBudWxsOwoJCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBkYXRhLCBtZXRob2QsIHt9KTsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRhdGEpID09PSAnc3RyaW5nJykgewoJCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUoZGF0YSk7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IGRhdGEuX190aGlzLmNvZGUgfHwgZGF0YS5pZCB8fCBkYXRhLklEOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJCWlmIChkYXRhLklkICYmIGRhdGEuSWQgPT0gZGF0YS5JZCkgewoJCQkJCQlfaWQgPSBkYXRhLklkOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQkJfSBlbHNlIGlmIChkYXRhLkVudGl0eUNsYXNzKSB7CgkJCQkJCV9pZCA9IGRhdGEuRW50aXR5Q2xhc3MuSWQgfHwgZGF0YS5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjNjNDZhOTg1LWU1YTQtNGU2ZC1hYjYxLTU1ZTY0NzBkZDUxZiIgfHwgIk5VTEwiOwoJCQkJCX0KCQkJCX0KCgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudCB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFttZXRob2RdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W21ldGhvZF0gfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnRbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W21ldGhvZF1bX2lkXSB8fCB7fTsKCgkJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goe30sIHsKCQkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQkJfSk7CgoJCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFttZXRob2RdW19pZF1bX2hhc2hdOwoJCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiA1KSkgewoJCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gbWV0aG9kIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJCXYucmV1c2VkKys7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhKTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnRGVwYXJ0bWVudCcpLnNlbmRlcihzYWxlc25vdy5fbm9kZSkuY2FycmllcihzYWxlc25vdy5fbm9kZSkucGF5bG9hZChkYXRhKTsKCQkJaWYgKGV2ZW50KSB7CgkJCQlpZiAoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7CgkJCQlpZiAoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7CgkJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7CgkJCQlpZiAoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7CgkJCX0KCQkJcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOwoKCQkJaWYgKHR5cGVvZihyZXQpID09PSAic3RyaW5nIikgewoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChleCkge30KCQkJfQoJCQlyZXR1cm4gcmV0OwoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LkRlcGFydG1lbnQobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93LkRlcGFydG1lbnQobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudCgpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOwoJCX0KCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgRGVwYXJ0bWVudC5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYERlcGFydG1lbnQuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudC5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5EZXBhcnRtZW50LicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlIHx8ICJEZXBhcnRtZW50Iik7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCWlmICh0aGlzLl9tYW5hZ2VyX3NldCAmJiB0aGlzLm1hbmFnZXIoKSkgdGhpcy5tYW5hZ2VyKCkuX19zeW5jX29uKGQpOwoKCQkJLy8gdGhpcy5kZXBhcnRtZW50X0RlcGFydG1lbnRzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudCh0aGlzLklkKQoKCQkJLm1hbmFnZXIodGhpcy5tYW5hZ2VyKCksIHRoaXMuX21hbmFnZXJfY29vcCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkuZGVwYXJ0bWVudF9Vc2Vycyh0aGlzLmRlcGFydG1lbnRfVXNlcnMoKSwgdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCW9ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdEZXBhcnRtZW50JzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiRGVwYXJ0bWVudCI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgkJCQlyZXQgPSByZXQudG9Mb3dlckNhc2UoKTsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucyA9IHt9KSB7CgkJdHJ5IHsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sID8gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IG9wdGlvbnMudG9vbCB8fCB0ID09IG9wdGlvbnMudG9vbCkgOiB0aGlzLlRvb2w7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCB8fCB7fTsKCgkJCWxldCBuSUQgPSBzYWxlc25vdy5fbm9kZSA/IHNhbGVzbm93Ll9ub2RlLmNvZGUoKSA6ICJkZWZhdWx0IjsKCgkJCWxldCByZXQgPSBudWxsVmFsdWU7CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldCA9IG51bGw7CgoJCQkvLyB0b29sX0NvbmZpZ3M6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gZG9uZQoJCQlsZXQgdGNvbmYgPSAob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgYy5ub2RlICYmIGMubm9kZS5jb2RlID09IG5JRCkuY29uY2F0KChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiAhYy5ub2RlKSk7CgkJCWlmICh0Y29uZi5sZW5ndGgpIHsKCQkJCXJldCA9IHRjb25mWzBdLnZhbHVlOwoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChqZXgpIHt9CgkJCX0KCgkJCS8vIG1vZGVsIENvbmZpZzogQ29uZmlnIGlzIGNsYXNzIGxldmVsLCBub2RlIG5vdCBwb3NzaWJsZSAtIHBlbmRpbmcKCQkJbGV0IG1jb25mID0gdGhpcy5Db25maWcgPyB0aGlzLkNvbmZpZ1tuXSA6IHVuZGVmaW5lZDsKCQkJaWYgKHR5cGVvZihtY29uZikgIT09ICJ1bmRlZmluZWQiKSByZXQgPSBtY29uZjsKCgkJCS8vIGNvbW1hbmQgbGluZTogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgZ2xvYmFsLm1pbmltaXN0KSB7CgkJCQlyZXQgPSBnbG9iYWwubWluaW1pc3QocHJvY2Vzcy5hcmd2LnNsaWNlKDIpKVtuXSB8fCByZXQ7CgkJCX0KCgkJCS8vIHJlcXVlc3Q6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlyZXQgPSB0aGlzLiRfUkVRVUVTVChuKSB8fCByZXQ7CgoJCQlpZiAob3B0aW9ucy5uZXdWYWx1ZSkgewoJCQkJbGV0IHRjID0gdGNvbmYubGVuZ3RoID8gdGNvbmZbMF0gOiB7fTsKCQkJCXRjLm5vZGUgPSB7CgkJCQkJY29kZTogb3B0aW9ucy5ub2RlLmNvZGUoKQoJCQkJfTsKCQkJCXRjLnZhbHVlID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJCXRjLm5hbWUgPSBuOwoJCQkJaWYgKCF0Y29uZi5sZW5ndGgpIHsKCQkJCQlvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLnB1c2godGMpOwoJCQkJfQoJCQkJcmV0ID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJfQoKCQkJLy8gY29uZmlnIHJlcGxhY2VtZW50CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3N0cmluZycpKHJldC5tYXRjaChuZXcgUmVnRXhwKGB7eyhbXn1dKyl9fWAsICJnIikpIHx8IFtdKS5mb3JFYWNoKG0gPT4gcmV0ID0gcmV0LnJlcGxhY2UobSwgdGhpcy5fX2NvbmZpZyhtLnJlcGxhY2UoJ3t7JywgJycpLnJlcGxhY2UoJ319JywgJycpLCBudWxsLCBvcHRpb25zKSkpOwoKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2NvbmZpZycsICdFbnRpdHlPYmplY3QnLCAxLCBuLCBudWxsVmFsdWUsIG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MsIGV4KTsKCQl9Cgl9CgoJX3RvU1FMVGFibGUoKSB7CgkJbGV0IHJldCA9IHsKCQkJc3FsOiBgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoCiAgICAgICAgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVkKICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdtYW5hZ2VyJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qRGVwYXJ0bWVudCovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJtYW5hZ2VyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbWFuYWdlcicsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJZGVwYXJ0bWVudF9Vc2VyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RlcGFydG1lbnRfRGVwYXJ0bWVudHMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypEZXBhcnRtZW50Ki8pO1xuJzsKCgkJcmV0LnNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQocmV0LnNxbCkgOiByZXQuc3FsOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TUUxUYWJsZScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQuc3FsKTsKCQlyZXR1cm4gcmV0LnNxbDsKCX0KCglfZnJvbVNRTFRhYmxlKHRhYmxlLCBmaWVsZHMpIHsKCQkvLyB0YWJsZSBpcyBhIGpzb24gYXJyYXkKCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm1hbmFnZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm1hbmFnZXIodGFibGVbIm1hbmFnZXIiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5hY3RpdmUodGFibGVbImFjdGl2ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5lbmFibGVkKHRhYmxlWyJlbmFibGVkIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvZGUodGFibGVbImNvZGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9yZGVyKHRhYmxlWyJvcmRlciJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5kYXRlKHRhYmxlWyJkYXRlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm5hbWUodGFibGVbIm5hbWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5yZW1hcmsodGFibGVbInJlbWFyayJdKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIF9zcWwoc3FsLCBzb3VyY2UgPSB0aGlzKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWwoc3FsLCB0aGlzKTsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgoJCQkJCS8vIGlmKHRoaXNbJ18nK2ZpZWxkKydfc2V0J10gJiYgKHR5cGVvZih0aGlzWydfJytmaWVsZF0pPT09J3VuZGVmaW5lZCcgfHwgdGhpc1snXycrZmllbGRdPT1udWxsKSkgcmV0dXJuOwoJCQkJCS8vIGlmKHR5cGVvZihlYU9iaik9PT0ndW5kZWZpbmVkJykgcmV0dXJuOyAvLyB3aHk/CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlyZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqLCB0aGlzLmNvZGUoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmosIHRoaXMuZGF0ZSgpKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmosIHRoaXMubmFtZSgpKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaiwgdGhpcy5yZW1hcmsoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICIzYzQ2YTk4NS1lNWE0LTRlNmQtYWI2MS01NWU2NDcwZGQ1MWYiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudCB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnRbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCWlmICghdGhpcy5tYW5hZ2VyKCkgfHwgKHRoaXMubWFuYWdlcigpCgoJCQkJJiYKCQkJCSF0aGlzLm1hbmFnZXIoKS5tYW5hZ2VyX0RlcGFydG1lbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLm1hbmFnZXIoKS5jYWxsZXJfSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLm1hbmFnZXIoKS5jb250YWN0X0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5tYW5hZ2VyKCkudXNlcl9Hcm91cF9NZW1iZXJzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJtYW5hZ2VyIiwgb2JqLCB0aGlzLm1hbmFnZXIoKSk7CgkJfQoKCQlfb3B0aW9ucygiZGVwYXJ0bWVudF9Vc2VycyIsIG9iaiwgdGhpcy5kZXBhcnRtZW50X1VzZXJzKCkpOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydtYW5hZ2VyJywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydkZXBhcnRtZW50X1VzZXJzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJEZXBhcnRtZW50IiAmJiAobS50YXJnZXQgfHwgbS5vdXRTY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkgJiYgKCFtLnNvdXJjZSB8fCAobS5zb3VyY2UgJiYgLyohbS5vdXRTY3JpcHQgJiYqLyB0aGlzWydfJyArIG0uc291cmNlICsgJ19zZXQnXSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0ub3V0U2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5vdXRTY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5vdXRTY3JpcHR9KX1gKSh0aGlzLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS5zb3VyY2UpIHsKCQkJCWlmIChtLnNvdXJjZS5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMpID0+IHtyZXR1cm4gX3RoaXMuJHttLnNvdXJjZX07fWApKHRoaXMpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS5zb3VyY2UsIHRoaXMpOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnRhcmdldCkgb2JqW20udGFyZ2V0XSA9IHJldDsKCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJW20udGFyZ2V0IHx8IG0uc291cmNlXTogdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddCgkJCX0pOwoJCX0pOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCS8vIHVzZSB0aGlzLl9tYXAoKSB3aXRoIHJldmVyc2UKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmopOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiM2M0NmE5ODUtZTVhNC00ZTZkLWFiNjEtNTVlNjQ3MGRkNTFmIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnQgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnQgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnRbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcyk7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJtYW5hZ2VyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRlcGFydG1lbnRfVXNlcnMiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydtYW5hZ2VyJywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydkZXBhcnRtZW50X1VzZXJzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJEZXBhcnRtZW50IiAmJiAobS5zb3VyY2UgfHwgbS5pblNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLmluU2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaiwgb1Njb3BlLCBtYXApID0+IHske20uaW5TY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5pblNjcmlwdH0pfWApKG9iaiwgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0udGFyZ2V0KSB7CgkJCQlpZiAobS50YXJnZXQuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaikgPT4ge3JldHVybiBvYmouJHttLnRhcmdldH07fWApKG9iaik7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmpbbS50YXJnZXRdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS50YXJnZXQsIG9iaik7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS5zb3VyY2UpIHsKCQkJCWlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0ocmV0KTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0gPSByZXQ7CgkJCQl9CgkJCX0KCQl9KTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXTogIiciICsgdGhpcy5JZCArICInIgoJCX07CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibWFuYWdlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9tYW5hZ2VyX3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5tYW5hZ2VyKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdtYW5hZ2VyJywgdW5kZWZpbmVkKSArICJpZCJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fYWN0aXZlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2VuYWJsZWRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9jb2RlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNvZGUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9vcmRlcl9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5vcmRlcigpOwoKCQkJZlZhbHVlID0gdiB8fCAnMCc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9kYXRlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmRhdGUoKTsKCgkJCXRyeSB7CgkJCQlmVmFsdWUgPSAiJyIgKyAodiA/IHYudG9JU09TdHJpbmcoKSA6ICIxOTcwLTEtMSIpICsgIiciOwoJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnKSB7CgkJCQkJZlZhbHVlID0gYFNUUl9UT19EQVRFKCR7ZlZhbHVlfSwgJyVZLSVtLSVkVCVULiVmWicpYDsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gJ2RhdGV0aW1lKCcgKyBmVmFsdWUgKyAnKSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX25hbWVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMubmFtZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9yZW1hcmtfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucmVtYXJrKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9RKCkgewoJCWxldCBfbyA9ICciJzsKCQlsZXQgX3EgPSBfbzsKCgkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgewoJCQlfbyA9IF9xID0gJ2AnOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxzZXJ2ZXInKSB7CgkJCV9vID0gJ1snOwoJCQlfcSA9ICddJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ2FwaUtleScpID09ICdhaXJ0YWJsZScpIHsKCQkJX28gPSAneyc7CgkJCV9xID0gJ30nOwoJCX0KCQl0aGlzLl9fUSA9IHRoaXMuX19RID09IF9vID8gX3EgOiBfbzsKCQlyZXR1cm4gdGhpcy5fX1E7Cgl9CgoJX2ZpZWxkR3JvdXBzKGZncyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOwoJCXJldHVybiB0aGlzOwoJfQoKCV9maWVsZEFnZ3JlZ2F0ZXMoZmFzID0ge30pIHsKCQl0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOwoJCXJldHVybiB0aGlzOwoJfQoKCV90b0ZpZWxkc1NRTChmaWVsZHMpIHsKCgkJZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnLCB0aGlzLl9uQ29kZSgnbWFuYWdlcicsIHVuZGVmaW5lZCkgKyAiLmlkIiwgdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCldOwoJCWZpZWxkcyA9IEFycmF5LmlzQXJyYXkoZmllbGRzKSA/IGZpZWxkcyA6IFtmaWVsZHNdOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCS8vIHtmaWVsZDogb3JkZXJ9CgkJCWZpZWxkcyA9IFtdOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5tYW5hZ2VyKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbWFuYWdlcicsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX1gKTsKCgkJfQoJCXJldHVybiBmaWVsZHM7Cgl9CgoJX2Zyb21EQk9iamVjdChyID0ge30pIHsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5fX2ltcG9ydChyLCB7CgkJCQlJZDogb2JqID0+IHRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ10sCgoJCQkJbWFuYWdlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5tYW5hZ2VyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb2RlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5kYXRlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5uYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucmVtYXJrKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlOdWxsOiB0cnVlLAoKCQkJbWFuYWdlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCX0sICJfdG9TZWxlY3RIZWFkZXIiKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0SGVhZGVyJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU2VsZWN0U1FMKGZpZWxkcykgewoJCWxldCBzcWwgPSAic2VsZWN0ICI7CgoJCWxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9YDsKCgkJbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7CgkJc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOwoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOwoKCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcykgewoJCQkvLyB7ZmllbGQ6IGZ1bmN0aW9ufQoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubWFuYWdlcikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubWFuYWdlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbWFuYWdlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCX0KCgkJc3FsICs9IGAgZnJvbSAke3RQcmVmfSBgOwoKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gYGxlZnQgam9pbiAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX0ke3RoaXMuX1EoKX0gYXMgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0gb24gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtrfWlkJHt0aGlzLl9RKCl9PSR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IGApOwoKCQlzcWwgKz0gYCB3aGVyZSAxPTFgOwoKCQlzcWwgPSB0aGlzLl9fZXhwb3J0KHsKCQkJc3FsOiBzcWwKCQl9LCB7CgkJCV9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgPyBbJ0lkJ10gOiB1bmRlZmluZWQsCgkJCU51bGw6IHRydWUsCgkJCV9USElTOiBvYmogPT4gewoJCQkJaWYgKCF0aGlzLl9USElTIHx8ICF0aGlzLl9USElTLmxlbmd0aCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCh0Ll9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnKSkuam9pbignIFVOSU9OIEFMTCAnKSArICIpIjsKCQkJfSwKCQkJSWQ6IG9iaiA9PiBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2AsCgoJCQltYW5hZ2VyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbWFuYWdlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbWFuYWdlcl9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX21hbmFnZXJfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvZGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2RhdGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVtYXJrX3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkZXBhcnRtZW50X1VzZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudF9EZXBhcnRtZW50cycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoImRlcGFydG1lbnQuaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX2RlcGFydG1lbnRfVXNlcnNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX2RlcGFydG1lbnRfVXNlcnNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19jb29wID09ICc9JyB8fCB0aGlzLl9kZXBhcnRtZW50X1VzZXJzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLypkZXBhcnRtZW50X1VzZXJzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQl9LCAiX3RvU2VsZWN0U1FMIiwgZmllbGRzKS5zcWw7CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJaWYgKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5tYW5hZ2VyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm1hbmFnZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJbWFuYWdlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpKSA9PiBvYmoubWFuYWdlciA9IHYuX3RvUGF0aHMoKSwKCgkJCWRlcGFydG1lbnRfVXNlcnM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50X0RlcGFydG1lbnRzJywgdW5kZWZpbmVkKSkgPT4gb2JqLmRlcGFydG1lbnRfVXNlcnMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJfSwgIl90b1BhdGhzIik7CgkJLy8gcmV0dXJuIHJldDsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5tYXAoayA9PiAoewoJCQlba106IHJldFtrXQoJCX0pKTsKCX0KCglfdG9VcGRhdGVTUUwoZmllbGRzKSB7CgkJbGV0IHJldEZpZWxkcyA9IHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLmpvaW4oJywgJyk7CgkJbGV0IHNxbCA9IGB1cGRhdGUgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSBzZXQgYCArIE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvREJPYmplY3QoZmllbGRzKSkubWFwKHYgPT4gdGhpcy5fUSgpICsgdlswXSArIHRoaXMuX1EoKSArICI9IiArIHZbMV0pICsgYCB3aGVyZSAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgOyAvL2AgcmV0dXJuaW5nICR7cmV0RmllbGRzfWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvVXBkYXRlU1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfdG9JbnNlcnRTUUwoZmllbGRzKSB7CgkJbGV0IG9iaiA9IHRoaXMuX3RvREJPYmplY3QoZmllbGRzKTsKCQlsZXQgc3FsID0gYGluc2VydCBpbnRvICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKGAgKyBPYmplY3Qua2V5cyhvYmopLm1hcChrID0+IHRoaXMuX1EoKSArIGsgKyB0aGlzLl9RKCkpICsgIikgdmFsdWVzICgiICsgT2JqZWN0LnZhbHVlcyhvYmopICsgYClgOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0luc2VydFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5EZXBhcnRtZW50KSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLkRlcGFydG1lbnQgPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgc3FsID0gbmV3IHNhbGVzbm93LkRlcGFydG1lbnQoKQoKCQkJCQkubWFuYWdlcihuZXcgc2FsZXNub3cuVXNlcigpKQoKCQkJCQkuZGVwYXJ0bWVudF9Vc2VycyhuZXcgc2FsZXNub3cuVXNlcigpKQoKCQkJCQkuX3RvU1FMVGFibGUoZGVwdGgpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQkJCWF3YWl0IHRoaXMuX3NxbChzcWwpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiRGVwYXJ0bWVudCIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQltYW5hZ2VyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5tYW5hZ2VyID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5tYW5hZ2VyKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX21hbmFnZXJfc2V0ICYmICFxdWVyeS5fbWFuYWdlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubWFuYWdlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9tYW5hZ2VyX3NldCAmJiBxdWVyeS5fbWFuYWdlcl9zZXQpIHx8CgoJCQkJCQkodGhpcy5tYW5hZ2VyKCkgJiYgIXRoaXMubWFuYWdlcigpLl9tYXRjaGVzKHF1ZXJ5Lm1hbmFnZXIoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm1hbmFnZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRlcGFydG1lbnRfVXNlcnM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouZGVwYXJ0bWVudF9Vc2VycyA9IHYubWFwKF92ID0+IHF1ZXJ5LmRlcGFydG1lbnRfVXNlcnMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCW1hbmFnZXI6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBtYW5hZ2VyIik7CgkJCQkJb2JqLm1hbmFnZXIgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQlkZXBhcnRtZW50X1VzZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmRlcGFydG1lbnRfVXNlcnMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX21hbmFnZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fYWN0aXZlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcmRlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9kYXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX25hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcmVtYXJrX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQltYW5hZ2VyOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMubWFuYWdlcihyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJZGVwYXJ0bWVudF9Vc2VyczogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLmRlcGFydG1lbnRfVXNlcnMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQltYW5hZ2VyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbWFuYWdlcicsIHVuZGVmaW5lZCkgOiAibWFuYWdlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9tYW5hZ2VyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLm1hbmFnZXIoKSB8fCBuZXcgc2FsZXNub3cuVXNlcigpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMubWFuYWdlcihvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIG1hbmFnZXIiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvZGUocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kYXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoJCQkJCWlmICh0eXBlb2YobW9tZW50KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZWYgPSBuZXcgRGF0ZShyZWYpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmVmID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpKTsKCQkJCX0KCQkJCXRoaXMuZGF0ZShyZWYpOwoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm5hbWUocmVmKTsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZW1hcmtfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnJlbWFyayhyZWYpOwoKCQkJfSwKCgkJCWRlcGFydG1lbnRfVXNlcnM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50X0RlcGFydG1lbnRzJywgdW5kZWZpbmVkKSA6ICJkZXBhcnRtZW50X1VzZXJzIikpID0+IHRoaXMuZGVwYXJ0bWVudF9Vc2VycyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuVXNlcigpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQl9LCAiX2Zyb21Eb2N1bWVudCIpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSB7CgkJbGV0IHJldCA9IHt9OwoKCQlpZiAoIWJUb29sKSB7CgkJCXJldC5fX2dlbmVyYXRlZCA9IG5ldyBEYXRlKCk7CgkJCWlmICh0aGlzLlRvb2wubmFtZSkgewoJCQkJcmV0Ll9fdG9vbCA9IHsKCQkJCQluYW1lOiB0aGlzLlRvb2wubmFtZSwKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlpZiAoc2FsZXNub3cuX25vZGUpIHsKCQkJCXJldC5fX25vZGUgPSB7CgkJCQkJY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogYkZ1bGwsCgkJCU51bGw6IGJOdWxsLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXSA9IHYsCgoJCQkibWFuYWdlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdtYW5hZ2VyJywgdW5kZWZpbmVkKSA6ICJtYW5hZ2VyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fbWFuYWdlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbWFuYWdlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQkJZGVwYXJ0bWVudF9Vc2VyczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RlcGFydG1lbnRfRGVwYXJ0bWVudHMnLCB1bmRlZmluZWQpIDogImRlcGFydG1lbnRfVXNlcnMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJYnlVc2VyKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9tYW5hZ2VyIl0gJiYgKGFbIl9tYW5hZ2VyIl0uRXF1YWxzID8gYVsiX21hbmFnZXIiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX21hbmFnZXIiXSwgcikpKSB7CgkJCQkJci5fbWFuYWdlcl9EZXBhcnRtZW50cy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gdHJ1ZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLm5hbWUgPSB7fTsKCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgZXJyb3IubmFtZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IubmFtZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IubmFtZTsKCQl9CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlLl9wYXJlbnQpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuRGVwYXJ0bWVudC5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudChudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMubmFtZSh0aGlzLm5hbWUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX21hbmFnZXJfc2V0ICYmIHRoaXMubWFuYWdlcigpICYmICEoYXdhaXQgdGhpcy5tYW5hZ2VyKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfbWFuYWdlcigpOwoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9kZXBhcnRtZW50X1VzZXJzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuZGVwYXJ0bWVudF9Vc2VycygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkRlcGFydG1lbnQuaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b0luc2VydFNRTCgpKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luc2VydCcsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuRGVwYXJ0bWVudC51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1VwZGF0ZVNRTCgpKTsKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTCgpKTsKCQkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IHJldFswXTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuRGVwYXJ0bWVudC5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSAoYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgKTsKCQkJCXJldCA9IHJldCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5EZXBhcnRtZW50KG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuUHJpb3JpdHkgPSBjbGFzcyBQcmlvcml0eSBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFpZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzSWtkcGRFaDFZaUpkYCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2FjdGl2ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2VuYWJsZWQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb2RlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb2RlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3JkZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29yZGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZGF0ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZGF0ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm5hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX25hbWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3JlbWFyaygpOwoKCQl0aGlzLmNsZWFyX3ByaW9yaXR5X0luY2lkZW50cygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIlByaW9yaXR5IiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQlyZXR1cm4gdGhpczsKCgkJKHRoaXMucHJpb3JpdHlfSW5jaWRlbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJVEhJUyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsKCQlpZiAoIXYpIHJldHVybiB0aGlzOwoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCQl0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KSA9PT0gJ29iamVjdCcgJiYgX3YuRW50aXR5Q2xhc3MgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSA9PSB0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGUgPT0gdGhpcy5TY29wZSk7CgkJaWYgKGNvKSB0aGlzLl9USElTX2Nvb3AgPSBjbzsKCQlyZXR1cm4gdGhpczsKCX0KCgljbGVhcl9USElTKCkgewoJCXRoaXMuX1RISVMgPSBbXTsKCQl0aGlzLl9USElTX2Nvb3AgPSAnJzsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHByaW9yaXR5X0luY2lkZW50cyAqKi8KCXByaW9yaXR5X0luY2lkZW50cyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICc3NDA3OTM0Ny1jZGMyLTRlMGUtOGRkMi1jOTFlNWMzOGQwMGQnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0luY2lkZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9wcmlvcml0eV9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdwcmlvcml0eV9JbmNpZGVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgInByaW9yaXR5IGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJJbmNpZGVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3ByaW9yaXR5X0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAicHJpb3JpdHkgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJJbmNpZGVudCIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5wcmlvcml0eSh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9wcmlvcml0eV9JbmNpZGVudHMucHVzaCguLi52KTsKCQl0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfcHJpb3JpdHlfSW5jaWRlbnRzKCkgewoJCXRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19zZXQgPSBudWxsOwoJCXRoaXMuX3ByaW9yaXR5X0luY2lkZW50cyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHByaW9yaXR5X0luY2lkZW50cyAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX2FjdGl2ZV9zZXQsCgoJCQl0aGlzLl9lbmFibGVkX3NldCwKCgkJCXRoaXMuX2NvZGVfc2V0LAoKCQkJdGhpcy5fb3JkZXJfc2V0LAoKCQkJdGhpcy5fZGF0ZV9zZXQsCgoJCQl0aGlzLl9uYW1lX3NldCwKCgkJCXRoaXMuX3JlbWFya19zZXQsCgoJCQl0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5wcmlvcml0eV9JbmNpZGVudHMgPSB0aGlzLnByaW9yaXR5X0luY2lkZW50cygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJcHJpb3JpdHlfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncHJpb3JpdHlfUHJpb3JpdHlzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX3RvSGFzaCIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMuTm9Db2RlID8gb0hhc2ggOiB0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7Cgl9CgoJYXN5bmMgX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOwoKCX0KCglfcWxTZWxlY3Rpb25zKHNTZXQpIHsKCQlsZXQgcmV0ID0gW107CgkJaWYgKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7CgoJCXNTZXQuc2VsZWN0aW9ucy5maWx0ZXIocyA9PiBzLnNlbGVjdGlvblNldCkuZm9yRWFjaChzID0+IHsKCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpICE9ICdQcmlvcml0eScpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCXJldHVybiBuZXcgc2FsZXNub3dbZXZlbnQuY2xhc3NOYW1lKCldKCkuX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdyk7CgkJCX0KCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9Qcmlvcml0eS8ke21ldGhvZH1gLCBkYXRhLCBjb25maWcpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQl9CgkJfSBlbHNlIHsKCgkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMuX19nZW5lcmF0ZWQ7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMub25saW5lOwoKCQkJfQoKCQkJLy93aHkgZG8gd2UgbmVlZCB0aGlzPz8/CgoJCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQkJdHJ5IHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHttZXRob2R9YCk7CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJbGV0IF9pZCA9IG51bGw7CgkJCQlpZiAodHlwZW9mKGRhdGEpID09PSAndW5kZWZpbmVkJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIGRhdGEsIG1ldGhvZCwge30pOwoJCQkJCXJldHVybiBkYXRhOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoZGF0YSkgPT09ICdzdHJpbmcnKSB7CgkJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShkYXRhKTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gZGF0YS5fX3RoaXMuY29kZSB8fCBkYXRhLmlkIHx8IGRhdGEuSUQ7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQkJaWYgKGRhdGEuSWQgJiYgZGF0YS5JZCA9PSBkYXRhLklkKSB7CgkJCQkJCV9pZCA9IGRhdGEuSWQ7CgkJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCQl9IGVsc2UgaWYgKGRhdGEuRW50aXR5Q2xhc3MpIHsKCQkJCQkJX2lkID0gZGF0YS5FbnRpdHlDbGFzcy5JZCB8fCBkYXRhLkVudGl0eUNsYXNzLk5hbWU7CgkJCQkJfSBlbHNlIHsKCQkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiOTM2MGZhMDYtNmEyZi00MzI2LThkNDgtYzJkNGUxNTNlNTE0IiB8fCAiTlVMTCI7CgkJCQkJfQoJCQkJfQoKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHkgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W21ldGhvZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W21ldGhvZF0gfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W21ldGhvZF1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbbWV0aG9kXVtfaWRdIHx8IHt9OwoKCQkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaCh7fSwgewoJCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCQl9KTsKCgkJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVttZXRob2RdW19pZF1bX2hhc2hdOwoJCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiA1KSkgewoJCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gbWV0aG9kIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJCXYucmV1c2VkKys7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhKTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbbWV0aG9kXVtfaWRdW19oYXNoXSA9IHsKCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeSh7fSksCgkJCQkJb2JqOiBkYXRhLAoJCQkJCXJldXNlZDogMCwKCQkJCX07CgkJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZGF0YSwgbWV0aG9kLCB7fSwgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBUcmlnZ2VycmluZyAke21ldGhvZH0gdG8gJHtuLmNvZGUoKX0gJHtKU09OLnN0cmluZ2lmeShkYXRhLG51bGwsNCl9YCk7CgoJCQlsZXQgZXYgPSBuZXcgc2FsZXNub3cuRXZlbnQoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSh0aGlzLl9fY29uZmlnKCdldmVudCcpIHx8ICdzYWxlc25vdy5FdmVudCcpLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnJlY2lwaWVudChuKS5tZXRob2QobWV0aG9kKS5jbGFzc05hbWUoJ1ByaW9yaXR5Jykuc2VuZGVyKHNhbGVzbm93Ll9ub2RlKS5jYXJyaWVyKHNhbGVzbm93Ll9ub2RlKS5wYXlsb2FkKGRhdGEpOwoJCQlpZiAoZXZlbnQpIHsKCQkJCWlmIChldmVudC5fcmVzcG9uc2VUb19zZXQpIGV2LnJlc3BvbnNlVG8oZXZlbnQucmVzcG9uc2VUbygpKTsKCQkJCWlmIChldmVudC5fc2VuZGVyX3NldCkgZXYuc2VuZGVyKGV2ZW50LnNlbmRlcigpKTsKCQkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCkgZXYuY2xhc3NOYW1lKGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCWlmIChldmVudC5fY2Fycmllcl9zZXQgfHwgZXZlbnQuX3NlbmRlcl9zZXQpIGV2LmNhcnJpZXIoZXZlbnQuY2FycmllcigpIHx8IGV2ZW50LnNlbmRlcigpKTsKCQkJfQoJCQlyZXQgPSBhd2FpdCBldi50cmlnZ2VyKCk7CgoJCQlpZiAodHlwZW9mKHJldCkgPT09ICJzdHJpbmciKSB7CgkJCQl0cnkgewoJCQkJCXJldCA9IEpTT04ucGFyc2UocmV0KTsKCQkJCX0gY2F0Y2ggKGV4KSB7fQoJCQl9CgkJCXJldHVybiByZXQ7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5zZXJ0IjoKCQkJY2FzZSAidXBkYXRlIjoKCQkJY2FzZSAic3RvcmUiOgoJCQljYXNlICJkZWxldGUiOgoJCQljYXNlICJmaW5kIjogewoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuUHJpb3JpdHkobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93LlByaW9yaXR5KG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX25vZGUpIHsKCQkJLy8gcHJvYmFibHkgc2hvdWxkIG5vdCBiZSBwcm9jZXNzZWQgaGVyZSwgYnV0IHJhdGhlciBjb25zdW1lZCBhcyBwYXJ0IG9mIHRoZSBleGVjdXRlKCkgbG9naWMsIHB1c2hpbmcgX19ub2RlIHRvIHRoZSBsaXN0IG9mIG15IG5vZGVzIHRvIGRlbGVnYXRlIHRvIT8KCQkJbGV0IHRuID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX19ub2RlKS5fZGVSZWZlcmVuY2UoKTsKCQkJZGVsZXRlIF9wYXJhbXMuX19ub2RlOwoJCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlByaW9yaXR5KCkuX2ludm9rZU5vZGUodG4sIG1ldGhvZCwgX3BhcmFtcyk7CgkJfQoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBQcmlvcml0eS5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYFByaW9yaXR5Ll9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQlpZiAoZmFsc2UgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCXJldCA9IHsKCQkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCQknLTQnOiAiVW5jb21taXR0ZWQgdHJhbnNhY3Rpb25zOiAiICsgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5zcWxzLmxlbmd0aCwKCQkJCQkJJ29iaic6IG9iagoJCQkJCX0KCQkJCX0KCQkJfQoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5Ll90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93LlByaW9yaXR5LicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlIHx8ICJQcmlvcml0eSIpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQkvLyB0aGlzLnByaW9yaXR5X1ByaW9yaXR5cygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlByaW9yaXR5KHRoaXMuSWQpCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5jb2RlKHRoaXMuY29kZSgpLCB0aGlzLl9jb2RlX2Nvb3ApCgoJCQkub3JkZXIodGhpcy5vcmRlcigpLCB0aGlzLl9vcmRlcl9jb29wKQoKCQkJLmRhdGUodGhpcy5kYXRlKCksIHRoaXMuX2RhdGVfY29vcCkKCgkJCS5uYW1lKHRoaXMubmFtZSgpLCB0aGlzLl9uYW1lX2Nvb3ApCgoJCQkucmVtYXJrKHRoaXMucmVtYXJrKCksIHRoaXMuX3JlbWFya19jb29wKQoKCQkJLnByaW9yaXR5X0luY2lkZW50cyh0aGlzLnByaW9yaXR5X0luY2lkZW50cygpLCB0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCkgewoJCWNvbnRleHQgPSBjb250ZXh0IHx8ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCW9iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQlvYmpUbyA9IG9ialRvIHx8IHt9OwoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAnUHJpb3JpdHknOwoJCXRvb2wgPSB0b29sIHx8IHRoaXMuVG9vbDsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJQcmlvcml0eSI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgkJCQlyZXQgPSByZXQudG9Mb3dlckNhc2UoKTsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucyA9IHt9KSB7CgkJdHJ5IHsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sID8gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IG9wdGlvbnMudG9vbCB8fCB0ID09IG9wdGlvbnMudG9vbCkgOiB0aGlzLlRvb2w7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCB8fCB7fTsKCgkJCWxldCBuSUQgPSBzYWxlc25vdy5fbm9kZSA/IHNhbGVzbm93Ll9ub2RlLmNvZGUoKSA6ICJkZWZhdWx0IjsKCgkJCWxldCByZXQgPSBudWxsVmFsdWU7CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldCA9IG51bGw7CgoJCQkvLyB0b29sX0NvbmZpZ3M6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gZG9uZQoJCQlsZXQgdGNvbmYgPSAob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgYy5ub2RlICYmIGMubm9kZS5jb2RlID09IG5JRCkuY29uY2F0KChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiAhYy5ub2RlKSk7CgkJCWlmICh0Y29uZi5sZW5ndGgpIHsKCQkJCXJldCA9IHRjb25mWzBdLnZhbHVlOwoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChqZXgpIHt9CgkJCX0KCgkJCS8vIG1vZGVsIENvbmZpZzogQ29uZmlnIGlzIGNsYXNzIGxldmVsLCBub2RlIG5vdCBwb3NzaWJsZSAtIHBlbmRpbmcKCQkJbGV0IG1jb25mID0gdGhpcy5Db25maWcgPyB0aGlzLkNvbmZpZ1tuXSA6IHVuZGVmaW5lZDsKCQkJaWYgKHR5cGVvZihtY29uZikgIT09ICJ1bmRlZmluZWQiKSByZXQgPSBtY29uZjsKCgkJCS8vIGNvbW1hbmQgbGluZTogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgZ2xvYmFsLm1pbmltaXN0KSB7CgkJCQlyZXQgPSBnbG9iYWwubWluaW1pc3QocHJvY2Vzcy5hcmd2LnNsaWNlKDIpKVtuXSB8fCByZXQ7CgkJCX0KCgkJCS8vIHJlcXVlc3Q6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlyZXQgPSB0aGlzLiRfUkVRVUVTVChuKSB8fCByZXQ7CgoJCQlpZiAob3B0aW9ucy5uZXdWYWx1ZSkgewoJCQkJbGV0IHRjID0gdGNvbmYubGVuZ3RoID8gdGNvbmZbMF0gOiB7fTsKCQkJCXRjLm5vZGUgPSB7CgkJCQkJY29kZTogb3B0aW9ucy5ub2RlLmNvZGUoKQoJCQkJfTsKCQkJCXRjLnZhbHVlID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJCXRjLm5hbWUgPSBuOwoJCQkJaWYgKCF0Y29uZi5sZW5ndGgpIHsKCQkJCQlvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLnB1c2godGMpOwoJCQkJfQoJCQkJcmV0ID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJfQoKCQkJLy8gY29uZmlnIHJlcGxhY2VtZW50CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3N0cmluZycpKHJldC5tYXRjaChuZXcgUmVnRXhwKGB7eyhbXn1dKyl9fWAsICJnIikpIHx8IFtdKS5mb3JFYWNoKG0gPT4gcmV0ID0gcmV0LnJlcGxhY2UobSwgdGhpcy5fX2NvbmZpZyhtLnJlcGxhY2UoJ3t7JywgJycpLnJlcGxhY2UoJ319JywgJycpLCBudWxsLCBvcHRpb25zKSkpOwoKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2NvbmZpZycsICdFbnRpdHlPYmplY3QnLCAxLCBuLCBudWxsVmFsdWUsIG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MsIGV4KTsKCQl9Cgl9CgoJX3RvU1FMVGFibGUoKSB7CgkJbGV0IHJldCA9IHsKCQkJc3FsOiBgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoCiAgICAgICAgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVkKICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgYAoJCX07CgkJcmV0LnNxbCArPSAnLypQcmlvcml0eSovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQlwcmlvcml0eV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwcmlvcml0eV9Qcmlvcml0eXMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypQcmlvcml0eSovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbChzcWwsIHRoaXMpOwoKCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCgkJCQkJLy8gaWYodGhpc1snXycrZmllbGQrJ19zZXQnXSAmJiAodHlwZW9mKHRoaXNbJ18nK2ZpZWxkXSk9PT0ndW5kZWZpbmVkJyB8fCB0aGlzWydfJytmaWVsZF09PW51bGwpKSByZXR1cm47CgkJCQkJLy8gaWYodHlwZW9mKGVhT2JqKT09PSd1bmRlZmluZWQnKSByZXR1cm47IC8vIHdoeT8KCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCXJldHVybiBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjkzNjBmYTA2LTZhMmYtNDMyNi04ZDQ4LWMyZDRlMTUzZTUxNCIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHkgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlfb3B0aW9ucygicHJpb3JpdHlfSW5jaWRlbnRzIiwgb2JqLCB0aGlzLnByaW9yaXR5X0luY2lkZW50cygpKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3ByaW9yaXR5X0luY2lkZW50cyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlmYWxzZSAmJiBbXS5jb25jYXQodGhpcy5Ub29sLnR5cGUudHlwZV9NYXBwaW5ncyB8fCBbXSkuY29uY2F0KHRoaXMuVG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5maWx0ZXIobSA9PiBtLmNsYXNzTmFtZSA9PSAiUHJpb3JpdHkiICYmIChtLnRhcmdldCB8fCBtLm91dFNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSAmJiAoIW0uc291cmNlIHx8IChtLnNvdXJjZSAmJiAvKiFtLm91dFNjcmlwdCAmJiovIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX3NldCddKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5vdXRTY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMsIG9TY29wZSwgbWFwKSA9PiB7JHttLm91dFNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLm91dFNjcmlwdH0pfWApKHRoaXMsIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnNvdXJjZSkgewoJCQkJaWYgKG0uc291cmNlLmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcykgPT4ge3JldHVybiBfdGhpcy4ke20uc291cmNlfTt9YCkodGhpcyk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnNvdXJjZSwgdGhpcyk7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0udGFyZ2V0KSBvYmpbbS50YXJnZXRdID0gcmV0OwoJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQlbbS50YXJnZXQgfHwgbS5zb3VyY2VdOiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10KCQkJfSk7CgkJfSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJLy8gdXNlIHRoaXMuX21hcCgpIHdpdGggcmV2ZXJzZQoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI5MzYwZmEwNi02YTJmLTQzMjYtOGQ0OC1jMmQ0ZTE1M2U1MTQiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHkgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5IHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcyk7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygicHJpb3JpdHlfSW5jaWRlbnRzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3ByaW9yaXR5X0luY2lkZW50cyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaikpOwoKCQlmYWxzZSAmJiBbXS5jb25jYXQodGhpcy5Ub29sLnR5cGUudHlwZV9NYXBwaW5ncyB8fCBbXSkuY29uY2F0KHRoaXMuVG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5maWx0ZXIobSA9PiBtLmNsYXNzTmFtZSA9PSAiUHJpb3JpdHkiICYmIChtLnNvdXJjZSB8fCBtLmluU2NyaXB0KSAmJiBtLmFjdGl2ZSAmJiBtLmVuYWJsZWQgJiYgKChtLnRvb2wgJiYgbS50b29sLm5hbWUgPT0gdGhpcy5Ub29sLm5hbWUpIHx8IChtLnR5cGUgJiYgbS50eXBlLm5hbWUgPT0gdGhpcy5Ub29sLnR5cGUubmFtZSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0uaW5TY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAob2JqLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5pblNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLmluU2NyaXB0fSl9YCkob2JqLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS50YXJnZXQpIHsKCQkJCWlmIChtLnRhcmdldC5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAob2JqKSA9PiB7cmV0dXJuIG9iai4ke20udGFyZ2V0fTt9YCkob2JqKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKG9ialttLnRhcmdldF0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gb2JqW20udGFyZ2V0XSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnRhcmdldCwgb2JqKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gb2JqW20udGFyZ2V0XTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnNvdXJjZSkgewoJCQkJaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQl0aGlzW20uc291cmNlXShyZXQpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzW20uc291cmNlXSA9IHJldDsKCQkJCX0KCQkJfQoJCX0pOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9EQk9iamVjdChmaWVsZHMsIGJOb1JlZikgewoJCWlmICghdGhpcy5JZCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCAiSW52YWxpZCBJRCIsIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSwgdGhpcy5Ub29sKTsKCQl9CgkJbGV0IHJldCA9IHsKCQkJW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddOiAiJyIgKyB0aGlzLklkICsgIiciCgkJfTsKCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fYWN0aXZlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2VuYWJsZWRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9jb2RlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNvZGUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9vcmRlcl9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5vcmRlcigpOwoKCQkJZlZhbHVlID0gdiB8fCAnMCc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9kYXRlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmRhdGUoKTsKCgkJCXRyeSB7CgkJCQlmVmFsdWUgPSAiJyIgKyAodiA/IHYudG9JU09TdHJpbmcoKSA6ICIxOTcwLTEtMSIpICsgIiciOwoJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnKSB7CgkJCQkJZlZhbHVlID0gYFNUUl9UT19EQVRFKCR7ZlZhbHVlfSwgJyVZLSVtLSVkVCVULiVmWicpYDsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gJ2RhdGV0aW1lKCcgKyBmVmFsdWUgKyAnKSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX25hbWVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMubmFtZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9yZW1hcmtfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucmVtYXJrKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9RKCkgewoJCWxldCBfbyA9ICciJzsKCQlsZXQgX3EgPSBfbzsKCgkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgewoJCQlfbyA9IF9xID0gJ2AnOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxzZXJ2ZXInKSB7CgkJCV9vID0gJ1snOwoJCQlfcSA9ICddJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ2FwaUtleScpID09ICdhaXJ0YWJsZScpIHsKCQkJX28gPSAneyc7CgkJCV9xID0gJ30nOwoJCX0KCQl0aGlzLl9fUSA9IHRoaXMuX19RID09IF9vID8gX3EgOiBfbzsKCQlyZXR1cm4gdGhpcy5fX1E7Cgl9CgoJX2ZpZWxkR3JvdXBzKGZncyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOwoJCXJldHVybiB0aGlzOwoJfQoKCV9maWVsZEFnZ3JlZ2F0ZXMoZmFzID0ge30pIHsKCQl0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOwoJCXJldHVybiB0aGlzOwoJfQoKCV90b0ZpZWxkc1NRTChmaWVsZHMpIHsKCgkJZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKV07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9YCk7CgoJCX0KCQlyZXR1cm4gZmllbGRzOwoJfQoKCV9mcm9tREJPYmplY3QociA9IHt9KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMuX19pbXBvcnQociwgewoJCQkJSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddLAoKCQkJCWFjdGl2ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmFjdGl2ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZW5hYmxlZChvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuY29kZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5vcmRlcihvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZGF0ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMubmFtZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnJlbWFyayhvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJfSwgIl9mcm9tREJPYmplY3QiKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX3RvU2VsZWN0SGVhZGVyKGZpZWxkcykgewoJCWxldCByZXQgPSB7CgkJCXRhYmxlOiB0aGlzLl9uQ29kZSgpLAoJCQlmaWVsZHM6IERvdE9iamVjdC5vYmplY3QoT2JqZWN0LmZyb21FbnRyaWVzKHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLm1hcChmID0+IFtmLCBmXSkpKSwKCQkJam9pbnM6IHt9LAoJCX07CgoJCWlmIChmaWVsZHMpIHJldHVybiByZXQ7CgoJCXJldC5qb2lucyA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJTnVsbDogdHJ1ZSwKCgkJfSwgIl90b1NlbGVjdEhlYWRlciIpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RIZWFkZXInLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9TZWxlY3RTUUwoZmllbGRzKSB7CgkJbGV0IHNxbCA9ICJzZWxlY3QgIjsKCgkJbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX1gOwoKCQlsZXQgaGVhZGVyID0gdGhpcy5fdG9TZWxlY3RIZWFkZXIoZmllbGRzKTsKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCX0KCgkJc3FsICs9IGAgZnJvbSAke3RQcmVmfSBgOwoKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gYGxlZnQgam9pbiAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX0ke3RoaXMuX1EoKX0gYXMgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0gb24gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtrfWlkJHt0aGlzLl9RKCl9PSR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IGApOwoKCQlzcWwgKz0gYCB3aGVyZSAxPTFgOwoKCQlzcWwgPSB0aGlzLl9fZXhwb3J0KHsKCQkJc3FsOiBzcWwKCQl9LCB7CgkJCV9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgPyBbJ0lkJ10gOiB1bmRlZmluZWQsCgkJCU51bGw6IHRydWUsCgkJCV9USElTOiBvYmogPT4gewoJCQkJaWYgKCF0aGlzLl9USElTIHx8ICF0aGlzLl9USElTLmxlbmd0aCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCh0Ll9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnKSkuam9pbignIFVOSU9OIEFMTCAnKSArICIpIjsKCQkJfSwKCQkJSWQ6IG9iaiA9PiBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2AsCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvZGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2RhdGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVtYXJrX3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlwcmlvcml0eV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwcmlvcml0eV9Qcmlvcml0eXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoInByaW9yaXR5LmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfY29vcCA9PSAnPScgfHwgdGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKnByaW9yaXR5X0luY2lkZW50cyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJfSwgIl90b1NlbGVjdFNRTCIsIGZpZWxkcykuc3FsOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCWlmIChPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJcHJpb3JpdHlfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncHJpb3JpdHlfUHJpb3JpdHlzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnByaW9yaXR5X0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQl9LCAiX3RvUGF0aHMiKTsKCQkvLyByZXR1cm4gcmV0OwoJCXJldHVybiBPYmplY3Qua2V5cyhyZXQpLm1hcChrID0+ICh7CgkJCVtrXTogcmV0W2tdCgkJfSkpOwoJfQoKCV90b1VwZGF0ZVNRTChmaWVsZHMpIHsKCQlsZXQgcmV0RmllbGRzID0gdGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkuam9pbignLCAnKTsKCQlsZXQgc3FsID0gYHVwZGF0ZSAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IHNldCBgICsgT2JqZWN0LmVudHJpZXModGhpcy5fdG9EQk9iamVjdChmaWVsZHMpKS5tYXAodiA9PiB0aGlzLl9RKCkgKyB2WzBdICsgdGhpcy5fUSgpICsgIj0iICsgdlsxXSkgKyBgIHdoZXJlICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2A7IC8vYCByZXR1cm5pbmcgJHtyZXRGaWVsZHN9YDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9VcGRhdGVTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV90b0luc2VydFNRTChmaWVsZHMpIHsKCQlsZXQgb2JqID0gdGhpcy5fdG9EQk9iamVjdChmaWVsZHMpOwoJCWxldCBzcWwgPSBgaW5zZXJ0IGludG8gJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoYCArIE9iamVjdC5rZXlzKG9iaikubWFwKGsgPT4gdGhpcy5fUSgpICsgayArIHRoaXMuX1EoKSkgKyAiKSB2YWx1ZXMgKCIgKyBPYmplY3QudmFsdWVzKG9iaikgKyBgKWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvSW5zZXJ0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlByaW9yaXR5KSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlByaW9yaXR5ID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5Qcmlvcml0eSgpCgoJCQkJCS5wcmlvcml0eV9JbmNpZGVudHMobmV3IHNhbGVzbm93LkluY2lkZW50KCkpCgoJCQkJCS5fdG9TUUxUYWJsZShkZXB0aCk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJQcmlvcml0eSIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcHJpb3JpdHlfSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnByaW9yaXR5X0luY2lkZW50cyA9IHYubWFwKF92ID0+IHF1ZXJ5LnByaW9yaXR5X0luY2lkZW50cygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJcHJpb3JpdHlfSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnByaW9yaXR5X0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fYWN0aXZlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcmRlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9kYXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX25hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcmVtYXJrX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlwcmlvcml0eV9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5wcmlvcml0eV9JbmNpZGVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb2RlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jb2RlKHJlZik7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3JkZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9yZGVyKHJlZik7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLmRhdGUocmVmKTsKCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9uYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5uYW1lKHJlZik7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVtYXJrX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5yZW1hcmsocmVmKTsKCgkJCX0sCgoJCQlwcmlvcml0eV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdwcmlvcml0eV9Qcmlvcml0eXMnLCB1bmRlZmluZWQpIDogInByaW9yaXR5X0luY2lkZW50cyIpKSA9PiB0aGlzLnByaW9yaXR5X0luY2lkZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuSW5jaWRlbnQoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX1RISVM6IChvYmosIHYpID0+IHsKCQkJCWlmIChiVG9vbCkgcmV0dXJuOwoJCQkJb2JqLlRISVMgPSB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQlvYmouT1BFUkFUT1JTLlRISVMgPSB0aGlzLl9USElTX2Nvb3A7CgkJCX0sCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ10gPSB2LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQkJcHJpb3JpdHlfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncHJpb3JpdHlfUHJpb3JpdHlzJywgdW5kZWZpbmVkKSA6ICJwcmlvcml0eV9JbmNpZGVudHMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gZmFsc2U7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlByaW9yaXR5LnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5Qcmlvcml0eShudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuY29kZSh0aGlzLmNvZGUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBGaW5pc2hlZCBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0gSWQ9WyR7dGhpcy5JZH1dYCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMucHJpb3JpdHlfSW5jaWRlbnRzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQkJaWYgKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uT3duZXIgPT0gdGhpcykgewoJCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGBDT01NSVQke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/JyBUUkFOU0FDVElPTic6Jyd9YCk7CgkJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCA9IG5ldyBEYXRlKCk7CgkJCQkJCX0KCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuUHJpb3JpdHkuaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b0luc2VydFNRTCgpKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luc2VydCcsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuUHJpb3JpdHkudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlLl9wYXJlbnQpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlByaW9yaXR5LmZpbmRBbGwnKTsKCgkJCS8vIGF2b2lkcyBjeWNsaWMgcXVlcmllcwoJCQlvYmpzID0gKG9ianMgfHwgW10pLm1hcChvID0+IG8uX2Nsb25lKCkpOwoKCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLz8/CgoJCQlsZXQgcmV0ID0gW107IC8vIGEganNvbiBhcnJheQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCXJldCA9IChhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoZmllbGRzLCBvYmpzKSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2ApOwoJCQkJcmV0ID0gcmV0ID8gW0pTT04ucGFyc2UodGhpcy5fYXRvYihyZXQuY29udGVudCkpXSA6IFtdOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiQmVmb3JlIF9mcm9tRG9jdW1lbnQoKSIsIHJldCk7CgoJCQlyZXQgPSByZXQubWFwKHIgPT4gbmV3IHNhbGVzbm93LlByaW9yaXR5KG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuUmVhc29uID0gY2xhc3MgUmVhc29uIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUWlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUp6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpWYzJWeUlqcDdJbDloZFhSb2IzSnBlbVV1ZFhObGNtNWhiV1VpT2lKbVlXUnBJaXdpWDJGMWRHaHZjbWw2WlM1d1lYTnpkMjl5WkNJNklqRXlNeUlzSWw5aGRYUm9iM0pwZW1VdWRHVnpkRlZ6WlhJaU9uc2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0puWlc1a1pYSWlPbnNpWTI5a1pTSTZJazBpTENKdVlXMWxJam9pVFdGc1pTSjlMQ0pqYjJSbElqb2labUZrYVNJc0ltNWhiV1VpT2lKR1lXUnBJbjE5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpUY1d4RVFpSXNJa2RwZEVoMVlpSmRgKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLk1hcHBpbmdzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgVzEwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoKCQkvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUKCQl0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307CgkJdGhpcy5Ub29sID0gdG9vbDsKCQl0aGlzLklkID0gaWQ7CgoJCXRoaXMuVmFsdWVFbnRpdGllcyA9IFtdOwoKCQl0aGlzLkRhdGUgPSBudWxsOwoKCQl0aGlzLmNsZWFyX1RISVMoKTsKCQl0aGlzLkVudGl0eVZhbHVlcyA9IFtdOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfY2xvc2VfcmVhc29uX0luY2lkZW50cygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIlJlYXNvbiIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJcmV0dXJuIHRoaXM7CgoJCSh0aGlzLmNsb3NlX3JlYXNvbl9JbmNpZGVudHMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY2xvc2VfcmVhc29uX0luY2lkZW50cyAqKi8KCWNsb3NlX3JlYXNvbl9JbmNpZGVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzc0MDc5MzQ3LWNkYzItNGUwZS04ZGQyLWM5MWU1YzM4ZDAwZCcgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnSW5jaWRlbnQnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX2Nsb3NlX3JlYXNvbl9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjbG9zZV9yZWFzb25fSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJjbG9zZV9yZWFzb24gaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkluY2lkZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnY2xvc2VfcmVhc29uX0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAiY2xvc2VfcmVhc29uIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiSW5jaWRlbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YuY2xvc2VfcmVhc29uKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHMucHVzaCguLi52KTsKCQl0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzKCkgewoJCXRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNsb3NlX3JlYXNvbl9JbmNpZGVudHMgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0LmNsb3NlX3JlYXNvbl9JbmNpZGVudHMgPSB0aGlzLmNsb3NlX3JlYXNvbl9JbmNpZGVudHMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCWNsb3NlX3JlYXNvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb25fUmVhc29ucycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCAmJiBldmVudC5jbGFzc05hbWUoKSAmJiBldmVudC5jbGFzc05hbWUoKSAhPSAnUmVhc29uJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL1JlYXNvbi8ke21ldGhvZH1gLCBkYXRhLCBjb25maWcpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQl9CgkJfSBlbHNlIHsKCgkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMuX19nZW5lcmF0ZWQ7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMub25saW5lOwoKCQkJfQoKCQkJLy93aHkgZG8gd2UgbmVlZCB0aGlzPz8/CgoJCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQkJdHJ5IHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHttZXRob2R9YCk7CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJbGV0IF9pZCA9IG51bGw7CgkJCQlpZiAodHlwZW9mKGRhdGEpID09PSAndW5kZWZpbmVkJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIGRhdGEsIG1ldGhvZCwge30pOwoJCQkJCXJldHVybiBkYXRhOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoZGF0YSkgPT09ICdzdHJpbmcnKSB7CgkJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShkYXRhKTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gZGF0YS5fX3RoaXMuY29kZSB8fCBkYXRhLmlkIHx8IGRhdGEuSUQ7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQkJaWYgKGRhdGEuSWQgJiYgZGF0YS5JZCA9PSBkYXRhLklkKSB7CgkJCQkJCV9pZCA9IGRhdGEuSWQ7CgkJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCQl9IGVsc2UgaWYgKGRhdGEuRW50aXR5Q2xhc3MpIHsKCQkJCQkJX2lkID0gZGF0YS5FbnRpdHlDbGFzcy5JZCB8fCBkYXRhLkVudGl0eUNsYXNzLk5hbWU7CgkJCQkJfSBlbHNlIHsKCQkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiMjJiMzk3YTMtZjNlMy00NDVjLTkyNGEtNTBjNjAwMDFjYmFhIiB8fCAiTlVMTCI7CgkJCQkJfQoJCQkJfQoKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb24gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbiB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW21ldGhvZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvblttZXRob2RdIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bbWV0aG9kXVtfaWRdIHx8IHt9OwoKCQkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaCh7fSwgewoJCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCQl9KTsKCgkJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bbWV0aG9kXVtfaWRdW19oYXNoXTsKCQkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogNSkpIHsKCQkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIG1ldGhvZCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCQl2LnJldXNlZCsrOwoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0KCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSk7CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvblttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnUmVhc29uJykuc2VuZGVyKHNhbGVzbm93Ll9ub2RlKS5jYXJyaWVyKHNhbGVzbm93Ll9ub2RlKS5wYXlsb2FkKGRhdGEpOwoJCQlpZiAoZXZlbnQpIHsKCQkJCWlmIChldmVudC5fcmVzcG9uc2VUb19zZXQpIGV2LnJlc3BvbnNlVG8oZXZlbnQucmVzcG9uc2VUbygpKTsKCQkJCWlmIChldmVudC5fc2VuZGVyX3NldCkgZXYuc2VuZGVyKGV2ZW50LnNlbmRlcigpKTsKCQkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCkgZXYuY2xhc3NOYW1lKGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCWlmIChldmVudC5fY2Fycmllcl9zZXQgfHwgZXZlbnQuX3NlbmRlcl9zZXQpIGV2LmNhcnJpZXIoZXZlbnQuY2FycmllcigpIHx8IGV2ZW50LnNlbmRlcigpKTsKCQkJfQoJCQlyZXQgPSBhd2FpdCBldi50cmlnZ2VyKCk7CgoJCQlpZiAodHlwZW9mKHJldCkgPT09ICJzdHJpbmciKSB7CgkJCQl0cnkgewoJCQkJCXJldCA9IEpTT04ucGFyc2UocmV0KTsKCQkJCX0gY2F0Y2ggKGV4KSB7fQoJCQl9CgkJCXJldHVybiByZXQ7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5zZXJ0IjoKCQkJY2FzZSAidXBkYXRlIjoKCQkJY2FzZSAic3RvcmUiOgoJCQljYXNlICJkZWxldGUiOgoJCQljYXNlICJmaW5kIjogewoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuUmVhc29uKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5SZWFzb24obnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuUmVhc29uKCkuX2ludm9rZU5vZGUodG4sIG1ldGhvZCwgX3BhcmFtcyk7CgkJfQoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBSZWFzb24uX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBSZWFzb24uX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uLl90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93LlJlYXNvbi4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiUmVhc29uIik7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCS8vIHRoaXMuY2xvc2VfcmVhc29uX1JlYXNvbnMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5SZWFzb24odGhpcy5JZCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkuY2xvc2VfcmVhc29uX0luY2lkZW50cyh0aGlzLmNsb3NlX3JlYXNvbl9JbmNpZGVudHMoKSwgdGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCW9ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdSZWFzb24nOwoJCXRvb2wgPSB0b29sIHx8IHRoaXMuVG9vbDsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJSZWFzb24iOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoJCQkJcmV0ID0gcmV0LnRvTG93ZXJDYXNlKCk7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMgPSB7fSkgewoJCXRyeSB7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCA/IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSBvcHRpb25zLnRvb2wgfHwgdCA9PSBvcHRpb25zLnRvb2wpIDogdGhpcy5Ub29sOwoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgfHwge307CgoJCQlsZXQgbklEID0gc2FsZXNub3cuX25vZGUgPyBzYWxlc25vdy5fbm9kZS5jb2RlKCkgOiAiZGVmYXVsdCI7CgoJCQlsZXQgcmV0ID0gbnVsbFZhbHVlOwoJCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXQgPSBudWxsOwoKCQkJLy8gdG9vbF9Db25maWdzOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIGRvbmUKCQkJbGV0IHRjb25mID0gKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmIGMubm9kZSAmJiBjLm5vZGUuY29kZSA9PSBuSUQpLmNvbmNhdCgob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgIWMubm9kZSkpOwoJCQlpZiAodGNvbmYubGVuZ3RoKSB7CgkJCQlyZXQgPSB0Y29uZlswXS52YWx1ZTsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoamV4KSB7fQoJCQl9CgoJCQkvLyBtb2RlbCBDb25maWc6IENvbmZpZyBpcyBjbGFzcyBsZXZlbCwgbm9kZSBub3QgcG9zc2libGUgLSBwZW5kaW5nCgkJCWxldCBtY29uZiA9IHRoaXMuQ29uZmlnID8gdGhpcy5Db25maWdbbl0gOiB1bmRlZmluZWQ7CgkJCWlmICh0eXBlb2YobWNvbmYpICE9PSAidW5kZWZpbmVkIikgcmV0ID0gbWNvbmY7CgoJCQkvLyBjb21tYW5kIGxpbmU6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnICYmIGdsb2JhbC5taW5pbWlzdCkgewoJCQkJcmV0ID0gZ2xvYmFsLm1pbmltaXN0KHByb2Nlc3MuYXJndi5zbGljZSgyKSlbbl0gfHwgcmV0OwoJCQl9CgoJCQkvLyByZXF1ZXN0OiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJcmV0ID0gdGhpcy4kX1JFUVVFU1QobikgfHwgcmV0OwoKCQkJaWYgKG9wdGlvbnMubmV3VmFsdWUpIHsKCQkJCWxldCB0YyA9IHRjb25mLmxlbmd0aCA/IHRjb25mWzBdIDoge307CgkJCQl0Yy5ub2RlID0gewoJCQkJCWNvZGU6IG9wdGlvbnMubm9kZS5jb2RlKCkKCQkJCX07CgkJCQl0Yy52YWx1ZSA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCQl0Yy5uYW1lID0gbjsKCQkJCWlmICghdGNvbmYubGVuZ3RoKSB7CgkJCQkJb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncy5wdXNoKHRjKTsKCQkJCX0KCQkJCXJldCA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCX0KCgkJCS8vIGNvbmZpZyByZXBsYWNlbWVudAoJCQlpZiAodHlwZW9mKHJldCkgPT09ICdzdHJpbmcnKShyZXQubWF0Y2gobmV3IFJlZ0V4cChge3soW159XSspfX1gLCAiZyIpKSB8fCBbXSkuZm9yRWFjaChtID0+IHJldCA9IHJldC5yZXBsYWNlKG0sIHRoaXMuX19jb25maWcobS5yZXBsYWNlKCd7eycsICcnKS5yZXBsYWNlKCd9fScsICcnKSwgbnVsbCwgb3B0aW9ucykpKTsKCgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19jb25maWcnLCAnRW50aXR5T2JqZWN0JywgMSwgbiwgbnVsbFZhbHVlLCBvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLCBleCk7CgkJfQoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qUmVhc29uKi8pO1xuJzsKCgkJcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogdHJ1ZSwKCQkJTnVsbDogdHJ1ZSwKCQkJLy9JZDogKG9iaiwgdikgPT4gb2JqLnNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVlgLAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCWNsb3NlX3JlYXNvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb25fUmVhc29ucycsIHVuZGVmaW5lZCkpID0+IG9iai5zcWwgPSB2Lm1hcChfdiA9PiBfdi5fdG9TUUxUYWJsZSgpKSArIG9iai5zcWwsCgoJCX0sICJfdG9TUUxUYWJsZSIpOwoKCQkvLyByZXQuc3FsICs9ICcvKlJlYXNvbiovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbChzcWwsIHRoaXMpOwoKCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCgkJCQkJLy8gaWYodGhpc1snXycrZmllbGQrJ19zZXQnXSAmJiAodHlwZW9mKHRoaXNbJ18nK2ZpZWxkXSk9PT0ndW5kZWZpbmVkJyB8fCB0aGlzWydfJytmaWVsZF09PW51bGwpKSByZXR1cm47CgkJCQkJLy8gaWYodHlwZW9mKGVhT2JqKT09PSd1bmRlZmluZWQnKSByZXR1cm47IC8vIHdoeT8KCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCXJldHVybiBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjIyYjM5N2EzLWYzZTMtNDQ1Yy05MjRhLTUwYzYwMDAxY2JhYSIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb24gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbiB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCV9vcHRpb25zKCJjbG9zZV9yZWFzb25fSW5jaWRlbnRzIiwgb2JqLCB0aGlzLmNsb3NlX3JlYXNvbl9JbmNpZGVudHMoKSk7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydjbG9zZV9yZWFzb25fSW5jaWRlbnRzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJSZWFzb24iICYmIChtLnRhcmdldCB8fCBtLm91dFNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSAmJiAoIW0uc291cmNlIHx8IChtLnNvdXJjZSAmJiAvKiFtLm91dFNjcmlwdCAmJiovIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX3NldCddKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5vdXRTY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMsIG9TY29wZSwgbWFwKSA9PiB7JHttLm91dFNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLm91dFNjcmlwdH0pfWApKHRoaXMsIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnNvdXJjZSkgewoJCQkJaWYgKG0uc291cmNlLmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcykgPT4ge3JldHVybiBfdGhpcy4ke20uc291cmNlfTt9YCkodGhpcyk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnNvdXJjZSwgdGhpcyk7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0udGFyZ2V0KSBvYmpbbS50YXJnZXRdID0gcmV0OwoJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQlbbS50YXJnZXQgfHwgbS5zb3VyY2VdOiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10KCQkJfSk7CgkJfSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJLy8gdXNlIHRoaXMuX21hcCgpIHdpdGggcmV2ZXJzZQoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICIyMmIzOTdhMy1mM2UzLTQ0NWMtOTI0YS01MGM2MDAwMWNiYWEiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uID0gc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb24gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJjbG9zZV9yZWFzb25fSW5jaWRlbnRzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ2Nsb3NlX3JlYXNvbl9JbmNpZGVudHMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIlJlYXNvbiIgJiYgKG0uc291cmNlIHx8IG0uaW5TY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5pblNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmosIG9TY29wZSwgbWFwKSA9PiB7JHttLmluU2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20uaW5TY3JpcHR9KX1gKShvYmosIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnRhcmdldCkgewoJCQkJaWYgKG0udGFyZ2V0LmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmopID0+IHtyZXR1cm4gb2JqLiR7bS50YXJnZXR9O31gKShvYmopOwoJCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqW20udGFyZ2V0XSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0udGFyZ2V0LCBvYmopOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0uc291cmNlKSB7CgkJCQlpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXRoaXNbbS5zb3VyY2VdKHJldCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXNbbS5zb3VyY2VdID0gcmV0OwoJCQkJfQoJCQl9CgkJfSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RCT2JqZWN0KGZpZWxkcywgYk5vUmVmKSB7CgkJaWYgKCF0aGlzLklkKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJJbnZhbGlkIElEIiwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lLCB0aGlzLlRvb2wpOwoJCX0KCQlsZXQgcmV0ID0gewoJCQlbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ106ICInIiArIHRoaXMuSWQgKyAiJyIKCQl9OwoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9hY3RpdmVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYWN0aXZlKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZW5hYmxlZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5lbmFibGVkKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvZGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29kZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2RhdGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZGF0ZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5uYW1lKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3JlbWFya19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5yZW1hcmsoKTsKCgkJCWZWYWx1ZSA9ICInIiArICgodiAmJiB2LnJlcGxhY2UpID8gdi5yZXBsYWNlKC9cJy9nLCAiXCdcJyIpIDogdikgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX1EoKSB7CgkJbGV0IF9vID0gJyInOwoJCWxldCBfcSA9IF9vOwoKCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXRoaXMuX19RID0gdGhpcy5fX1EgPT0gX28gPyBfcSA6IF9vOwoJCXJldHVybiB0aGlzLl9fUTsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcsIHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpXTsKCQlmaWVsZHMgPSBBcnJheS5pc0FycmF5KGZpZWxkcykgPyBmaWVsZHMgOiBbZmllbGRzXTsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQkvLyB7ZmllbGQ6IG9yZGVyfQoJCQlmaWVsZHMgPSBbXTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX1gKTsKCgkJfQoJCXJldHVybiBmaWVsZHM7Cgl9CgoJX2Zyb21EQk9iamVjdChyID0ge30pIHsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5fX2ltcG9ydChyLCB7CgkJCQlJZDogb2JqID0+IHRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ10sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb2RlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5kYXRlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5uYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucmVtYXJrKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlOdWxsOiB0cnVlLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoJCXNxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsKCgkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpIHsKCQkJLy8ge2ZpZWxkOiBmdW5jdGlvbn0KCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJfQoKCQlzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7CgoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gYCk7CgoJCXNxbCArPSBgIHdoZXJlIDE9MWA7CgoJCXNxbCA9IHRoaXMuX19leHBvcnQoewoJCQlzcWw6IHNxbAoJCX0sIHsKCQkJX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSA/IFsnSWQnXSA6IHVuZGVmaW5lZCwKCQkJTnVsbDogdHJ1ZSwKCQkJX1RISVM6IG9iaiA9PiB7CgkJCQlpZiAoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKHQuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOwoJCQl9LAoJCQlJZDogb2JqID0+IG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jb2RlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fY29kZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX29yZGVyX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fb3JkZXJfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fZGF0ZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi50b0lTT1N0cmluZykgewoJCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbGl0ZScpIHsKCQkJCQkJb2JqLnNxbCArPSAic3RyZnRpbWUoJyVzJywgJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJykiOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9iai5zcWwgKz0gIiciICsgdi50b0lTT1N0cmluZygpICsgIiciOwoJCQkJCX0KCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9uYW1lX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9yZW1hcmtfc2V0KSByZXR1cm47CgoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNsb3NlX3JlYXNvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb25fUmVhc29ucycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoImNsb3NlX3JlYXNvbi5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19jb29wID09ICchPScgfHwgdGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKmNsb3NlX3JlYXNvbl9JbmNpZGVudHMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCX0sICJfdG9TZWxlY3RTUUwiLCBmaWVsZHMpLnNxbDsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQlpZiAoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jb2RlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMub3JkZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZGF0ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5uYW1lfWA7CgoJCX0KCgkJaWYgKHNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpIHsKCQkJLy8gc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSIsICJ3aGVyZSAxPTAiKTsKCQl9IGVsc2UgewoJCQlzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7CgkJfQoKCQlzcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCkgOiBzcWw7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgoJCXJldHVybiBzcWw7Cgl9CgoJX3RvUGF0aHMoKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJX1RISVM6IG9iaiA9PiB7fSwKCgkJCWNsb3NlX3JlYXNvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb25fUmVhc29ucycsIHVuZGVmaW5lZCkpID0+IG9iai5jbG9zZV9yZWFzb25fSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuUmVhc29uKSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlJlYXNvbiA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCBzcWwgPSBuZXcgc2FsZXNub3cuUmVhc29uKCkKCgkJCQkJLmNsb3NlX3JlYXNvbl9JbmNpZGVudHMobmV3IHNhbGVzbm93LkluY2lkZW50KCkpCgoJCQkJCS5fdG9TUUxUYWJsZShkZXB0aCk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJSZWFzb24iKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNsb3NlX3JlYXNvbl9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouY2xvc2VfcmVhc29uX0luY2lkZW50cyA9IHYubWFwKF92ID0+IHF1ZXJ5LmNsb3NlX3JlYXNvbl9JbmNpZGVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWNsb3NlX3JlYXNvbl9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouY2xvc2VfcmVhc29uX0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fYWN0aXZlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcmRlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9kYXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX25hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcmVtYXJrX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQljbG9zZV9yZWFzb25fSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuY2xvc2VfcmVhc29uX0luY2lkZW50cygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvZGUocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kYXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoJCQkJCWlmICh0eXBlb2YobW9tZW50KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZWYgPSBuZXcgRGF0ZShyZWYpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmVmID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpKTsKCQkJCX0KCQkJCXRoaXMuZGF0ZShyZWYpOwoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm5hbWUocmVmKTsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZW1hcmtfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnJlbWFyayhyZWYpOwoKCQkJfSwKCgkJCWNsb3NlX3JlYXNvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb25fUmVhc29ucycsIHVuZGVmaW5lZCkgOiAiY2xvc2VfcmVhc29uX0luY2lkZW50cyIpKSA9PiB0aGlzLmNsb3NlX3JlYXNvbl9JbmNpZGVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddID0gdiwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCWNsb3NlX3JlYXNvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb25fUmVhc29ucycsIHVuZGVmaW5lZCkgOiAiY2xvc2VfcmVhc29uX0luY2lkZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuX25hbWU7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IGZhbHNlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5SZWFzb24uc3RvcmUnKTsgLy8gb3IgaW5zaWRlIGV4ZWN1dGU/CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJbGV0IGJVcGRhdGUgPSBmYWxzZTsKCQkJbGV0IGJJbnNlcnQgPSBmYWxzZTsKCgkJCWlmICghdGhpcy5fX3N5bmNfb24oKSkgewoJCQkJbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LlJlYXNvbihudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuY29kZSh0aGlzLmNvZGUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBGaW5pc2hlZCBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0gSWQ9WyR7dGhpcy5JZH1dYCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLmNsb3NlX3JlYXNvbl9JbmNpZGVudHMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCQlpZiAoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5Pd25lciA9PSB0aGlzKSB7CgkJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYENPTU1JVCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nIFRSQU5TQUNUSU9OJzonJ31gKTsKCQkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kID0gbmV3IERhdGUoKTsKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlLl9wYXJlbnQpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBpbnNlcnQoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5SZWFzb24uaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b0luc2VydFNRTCgpKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luc2VydCcsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuUmVhc29uLnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvVXBkYXRlU1FMKCkpOwoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKCkpOwoJCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0WzBdOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5SZWFzb24uZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJcmV0ID0gKGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTChmaWVsZHMsIG9ianMpKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCk7CgkJCQlyZXQgPSByZXQgPyBbSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSldIDogW107CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5tYXAociA9PiBuZXcgc2FsZXNub3cuUmVhc29uKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuU3ltcHRvbSA9IGNsYXNzIFN5bXB0b20gZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRaWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc0lrZHBkRWgxWWlKZGApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgkJdGhpcy5jbGVhcl9zeW1wdG9tX0luY2lkZW50cygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIlN5bXB0b20iLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCXJldHVybiB0aGlzOwoKCQkodGhpcy5zeW1wdG9tX0luY2lkZW50cygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoJY29kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb2RlICE9IHYpIHsKCQkJCXRoaXMuX2NvZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29kZSk7CgkJfQoJfQoKCWNsZWFyX2NvZGUoKSB7CgkJdGhpcy5fY29kZV9zZXQgPSBudWxsOwoJCXRoaXMuX2NvZGUgPSBudWxsOwoJCXRoaXMuX2NvZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCglkYXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImRhdGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJyA/IF92IDogKG5ldyBEYXRlKF92KSk7CgkJCQlpZiAoaXNOYU4oX3YuZ2V0VGltZSgpKSkgX3YgPSBudWxsOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuRGF0ZVZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RhdGUgIT0gdikgewoJCQkJdGhpcy5fZGF0ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkRhdGVWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGF0ZSk7CgkJfQoJfQoKCWNsZWFyX2RhdGUoKSB7CgkJdGhpcy5fZGF0ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2RhdGUgPSBudWxsOwoJCXRoaXMuX2RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoJbmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9uYW1lICE9IHYpIHsKCQkJCXRoaXMuX25hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX25hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbmFtZSk7CgkJfQoJfQoKCWNsZWFyX25hbWUoKSB7CgkJdGhpcy5fbmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX25hbWUgPSBudWxsOwoJCXRoaXMuX25hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCglyZW1hcmsodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9yZW1hcmtfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZW1hcmsiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3JlbWFyayAhPSB2KSB7CgkJCQl0aGlzLl9yZW1hcmtfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3JlbWFyayA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcmVtYXJrKTsKCQl9Cgl9CgoJY2xlYXJfcmVtYXJrKCkgewoJCXRoaXMuX3JlbWFya19zZXQgPSBudWxsOwoJCXRoaXMuX3JlbWFyayA9IG51bGw7CgkJdGhpcy5fcmVtYXJrX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBzeW1wdG9tX0luY2lkZW50cyAqKi8KCXN5bXB0b21fSW5jaWRlbnRzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9zeW1wdG9tX0luY2lkZW50czsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnNzQwNzkzNDctY2RjMi00ZTBlLThkZDItYzkxZTVjMzhkMDBkJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdJbmNpZGVudCcpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fc3ltcHRvbV9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzeW1wdG9tX0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAic3ltcHRvbSBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiSW5jaWRlbnQiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzeW1wdG9tX0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAic3ltcHRvbSBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkluY2lkZW50Iik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LnN5bXB0b20odGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fc3ltcHRvbV9JbmNpZGVudHMucHVzaCguLi52KTsKCQl0aGlzLl9zeW1wdG9tX0luY2lkZW50c19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX3N5bXB0b21fSW5jaWRlbnRzKCkgewoJCXRoaXMuX3N5bXB0b21fSW5jaWRlbnRzX3NldCA9IG51bGw7CgkJdGhpcy5fc3ltcHRvbV9JbmNpZGVudHMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9zeW1wdG9tX0luY2lkZW50c19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHN5bXB0b21fSW5jaWRlbnRzICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJCXRoaXMuX3N5bXB0b21fSW5jaWRlbnRzX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX2FjdGl2ZV9zZXQgPSB0aGlzLl9hY3RpdmVfc2V0OwoJCXJldC5fYWN0aXZlX2Nvb3AgPSB0aGlzLl9hY3RpdmVfY29vcDsKCQlyZXQuYWN0aXZlID0gdGhpcy5hY3RpdmUoKSA/IHRoaXMuYWN0aXZlKCkgOiB0aGlzLmFjdGl2ZSgpOwoKCQlyZXQuX2VuYWJsZWRfc2V0ID0gdGhpcy5fZW5hYmxlZF9zZXQ7CgkJcmV0Ll9lbmFibGVkX2Nvb3AgPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJcmV0LmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKSA/IHRoaXMuZW5hYmxlZCgpIDogdGhpcy5lbmFibGVkKCk7CgoJCXJldC5fY29kZV9zZXQgPSB0aGlzLl9jb2RlX3NldDsKCQlyZXQuX2NvZGVfY29vcCA9IHRoaXMuX2NvZGVfY29vcDsKCQlyZXQuY29kZSA9IHRoaXMuY29kZSgpID8gdGhpcy5jb2RlKCkgOiB0aGlzLmNvZGUoKTsKCgkJcmV0Ll9vcmRlcl9zZXQgPSB0aGlzLl9vcmRlcl9zZXQ7CgkJcmV0Ll9vcmRlcl9jb29wID0gdGhpcy5fb3JkZXJfY29vcDsKCQlyZXQub3JkZXIgPSB0aGlzLm9yZGVyKCkgPyB0aGlzLm9yZGVyKCkgOiB0aGlzLm9yZGVyKCk7CgoJCXJldC5fZGF0ZV9zZXQgPSB0aGlzLl9kYXRlX3NldDsKCQlyZXQuX2RhdGVfY29vcCA9IHRoaXMuX2RhdGVfY29vcDsKCQlyZXQuZGF0ZSA9IHRoaXMuZGF0ZSgpID8gdGhpcy5kYXRlKCkgOiB0aGlzLmRhdGUoKTsKCgkJcmV0Ll9uYW1lX3NldCA9IHRoaXMuX25hbWVfc2V0OwoJCXJldC5fbmFtZV9jb29wID0gdGhpcy5fbmFtZV9jb29wOwoJCXJldC5uYW1lID0gdGhpcy5uYW1lKCkgPyB0aGlzLm5hbWUoKSA6IHRoaXMubmFtZSgpOwoKCQlyZXQuX3JlbWFya19zZXQgPSB0aGlzLl9yZW1hcmtfc2V0OwoJCXJldC5fcmVtYXJrX2Nvb3AgPSB0aGlzLl9yZW1hcmtfY29vcDsKCQlyZXQucmVtYXJrID0gdGhpcy5yZW1hcmsoKSA/IHRoaXMucmVtYXJrKCkgOiB0aGlzLnJlbWFyaygpOwoKCQlyZXQuc3ltcHRvbV9JbmNpZGVudHMgPSB0aGlzLnN5bXB0b21fSW5jaWRlbnRzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQlzeW1wdG9tX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N5bXB0b21fU3ltcHRvbXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkgIT0gJ1N5bXB0b20nKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiRGVsZWdhdGluZyBpbnZva2F0aW9uIHRvICIgKyBldmVudC5jbGFzc05hbWUoKSk7CgkJCQlyZXR1cm4gbmV3IHNhbGVzbm93W2V2ZW50LmNsYXNzTmFtZSgpXSgpLl9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpOwoJCQl9CgoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQlkYXRhLl9fdGhpcyA9IGRhdGEuX190aGlzIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkJc3dpdGNoIChtZXRob2QpIHsKCgkJCX0KCQl9CgoJCWlmICghbiB8fCBzYWxlc25vdy5fbm9kZS5fc2FtZU5vZGUobikpIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkNhbGxiYWNrIik7CgkJCXJldCA9IGF3YWl0IHRoaXMuX2ludm9rZShtZXRob2QsIGRhdGEpOwoJCX0gZWxzZSBpZiAobi5hZGRyZXNzKCkgJiYgbi5fc2FtZU5vZGUobikgLyphY3R1YWwgbm9kZSovICkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBuLl9hZGRyZXNzLCBuLl9wb3J0LCBtZXRob2QpOwoJCQl0cnkgewoJCQkJbGV0IGNvbmZpZyA9IHsKCQkJCQloZWFkZXJzOiB7fSwKCQkJCX07CgkJCQlpZiAoc2FsZXNub3cuX190b2tlbikgY29uZmlnLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGAke3NhbGVzbm93Ll9fdG9rZW4udG9rZW5fdHlwZX0gJHtzYWxlc25vdy5fX3Rva2VuLmFjY2Vzc190b2tlbn1gOwoJCQkJcmV0ID0gYXdhaXQgYXhpb3MucG9zdChgaHR0cCR7bi5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHtuLmFkZHJlc3MoKX06JHtuLnBvcnQoKSB8fCAzMDAwfS9tZXRob2QvU3ltcHRvbS8ke21ldGhvZH1gLCBkYXRhLCBjb25maWcpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQl9CgkJfSBlbHNlIHsKCgkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMuX19nZW5lcmF0ZWQ7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMub25saW5lOwoKCQkJfQoKCQkJLy93aHkgZG8gd2UgbmVlZCB0aGlzPz8/CgoJCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQkJdHJ5IHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHttZXRob2R9YCk7CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJbGV0IF9pZCA9IG51bGw7CgkJCQlpZiAodHlwZW9mKGRhdGEpID09PSAndW5kZWZpbmVkJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIGRhdGEsIG1ldGhvZCwge30pOwoJCQkJCXJldHVybiBkYXRhOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoZGF0YSkgPT09ICdzdHJpbmcnKSB7CgkJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShkYXRhKTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gZGF0YS5fX3RoaXMuY29kZSB8fCBkYXRhLmlkIHx8IGRhdGEuSUQ7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQkJaWYgKGRhdGEuSWQgJiYgZGF0YS5JZCA9PSBkYXRhLklkKSB7CgkJCQkJCV9pZCA9IGRhdGEuSWQ7CgkJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCQl9IGVsc2UgaWYgKGRhdGEuRW50aXR5Q2xhc3MpIHsKCQkJCQkJX2lkID0gZGF0YS5FbnRpdHlDbGFzcy5JZCB8fCBkYXRhLkVudGl0eUNsYXNzLk5hbWU7CgkJCQkJfSBlbHNlIHsKCQkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiYmM5MGVmOTQtYWNiMi00MTg5LWI5ZTAtN2VjMTZiMjdjM2FmIiB8fCAiTlVMTCI7CgkJCQkJfQoJCQkJfQoKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW21ldGhvZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVttZXRob2RdW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bbWV0aG9kXVtfaWRdIHx8IHt9OwoKCQkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaCh7fSwgewoJCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCQl9KTsKCgkJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW21ldGhvZF1bX2lkXVtfaGFzaF0gPSB7CgkJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoe30pLAoJCQkJCW9iajogZGF0YSwKCQkJCQlyZXVzZWQ6IDAsCgkJCQl9OwoJCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0gPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGRhdGEsIG1ldGhvZCwge30sIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBgVHJpZ2dlcnJpbmcgJHttZXRob2R9IHRvICR7bi5jb2RlKCl9ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSxudWxsLDQpfWApOwoKCQkJbGV0IGV2ID0gbmV3IHNhbGVzbm93LkV2ZW50KCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuY29kZSh0aGlzLl91dWlkKCkpLm5hbWUodGhpcy5fX2NvbmZpZygnZXZlbnQnKSB8fCAnc2FsZXNub3cuRXZlbnQnKS5kYXRlKHRoaXMuc2VydmVyRGF0ZSgpKS5yZWNpcGllbnQobikubWV0aG9kKG1ldGhvZCkuY2xhc3NOYW1lKCdTeW1wdG9tJykuc2VuZGVyKHNhbGVzbm93Ll9ub2RlKS5jYXJyaWVyKHNhbGVzbm93Ll9ub2RlKS5wYXlsb2FkKGRhdGEpOwoJCQlpZiAoZXZlbnQpIHsKCQkJCWlmIChldmVudC5fcmVzcG9uc2VUb19zZXQpIGV2LnJlc3BvbnNlVG8oZXZlbnQucmVzcG9uc2VUbygpKTsKCQkJCWlmIChldmVudC5fc2VuZGVyX3NldCkgZXYuc2VuZGVyKGV2ZW50LnNlbmRlcigpKTsKCQkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCkgZXYuY2xhc3NOYW1lKGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCWlmIChldmVudC5fY2Fycmllcl9zZXQgfHwgZXZlbnQuX3NlbmRlcl9zZXQpIGV2LmNhcnJpZXIoZXZlbnQuY2FycmllcigpIHx8IGV2ZW50LnNlbmRlcigpKTsKCQkJfQoJCQlyZXQgPSBhd2FpdCBldi50cmlnZ2VyKCk7CgoJCQlpZiAodHlwZW9mKHJldCkgPT09ICJzdHJpbmciKSB7CgkJCQl0cnkgewoJCQkJCXJldCA9IEpTT04ucGFyc2UocmV0KTsKCQkJCX0gY2F0Y2ggKGV4KSB7fQoJCQl9CgkJCXJldHVybiByZXQ7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5zZXJ0IjoKCQkJY2FzZSAidXBkYXRlIjoKCQkJY2FzZSAic3RvcmUiOgoJCQljYXNlICJkZWxldGUiOgoJCQljYXNlICJmaW5kIjogewoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuU3ltcHRvbShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuU3ltcHRvbShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocCkpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHt9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2UobWV0aG9kLCBib2R5LCBxdWVyeSwgYXV0aE9iaikgewoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgbWV0aG9kLCBxdWVyeSwgYm9keSk7CgoJCWlmICh0eXBlb2YoYm9keSkgPT09ICdzdHJpbmcnIHx8ICh0eXBlb2YoQnVmZmVyKSAhPT0gJ3VuZGVmaW5lZCcgJiYgQnVmZmVyLmlzQnVmZmVyKGJvZHkpKSkgewoJCQl0cnkgewoJCQkJYm9keSA9IEpTT04ucGFyc2UoYm9keS50b1N0cmluZygpKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJvZHkgaXMgbm90IGEgdmFsaWQgSlNPTiIsIGJvZHkpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoKCQlsZXQgX3BhcmFtcyA9IHF1ZXJ5ID8gT2JqZWN0LmFzc2lnbihxdWVyeSwgYm9keSkgOiBib2R5OwoJCWlmICh0eXBlb2YoX3BhcmFtcykgPT09ICdzdHJpbmcnKSBfcGFyYW1zID0gSlNPTi5wYXJzZShfcGFyYW1zKTsKCgkJaWYgKF9wYXJhbXMpIHsKCQkJX3BhcmFtcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcyk7CgkJfSBlbHNlIHsKCQkJX3BhcmFtcyA9IHt9OwoJCX0KCgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgX3BhcmFtcy5fX2ZsYXR0ZWQpIF9wYXJhbXMgPSBGbGF0dGVkLnBhcnNlKF9wYXJhbXMuX19mbGF0dGVkKTsKCgkJaWYgKF9wYXJhbXMuX19ub2RlKSB7CgkJCS8vIHByb2JhYmx5IHNob3VsZCBub3QgYmUgcHJvY2Vzc2VkIGhlcmUsIGJ1dCByYXRoZXIgY29uc3VtZWQgYXMgcGFydCBvZiB0aGUgZXhlY3V0ZSgpIGxvZ2ljLCBwdXNoaW5nIF9fbm9kZSB0byB0aGUgbGlzdCBvZiBteSBub2RlcyB0byBkZWxlZ2F0ZSB0byE/CgkJCWxldCB0biA9IG5ldyBzYWxlc25vdy5Ob2RlKCkuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fbm9kZSkuX2RlUmVmZXJlbmNlKCk7CgkJCWRlbGV0ZSBfcGFyYW1zLl9fbm9kZTsKCQkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5TeW1wdG9tKCkuX2ludm9rZU5vZGUodG4sIG1ldGhvZCwgX3BhcmFtcyk7CgkJfQoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBTeW1wdG9tLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgU3ltcHRvbS5faW52b2tlOiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLAoJCQkJCSdvYmonOiBvYmoKCQkJCX0KCQkJfTsKCQl9IGVsc2UgewoJCQlyZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOwoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJaWYgKGZhbHNlICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQlyZXQgPSB7CgkJCQkJX19leGNlcHRpb246IHsKCQkJCQkJJy00JzogIlVuY29tbWl0dGVkIHRyYW5zYWN0aW9uczogIiArIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uc3Fscy5sZW5ndGgsCgkJCQkJCSdvYmonOiBvYmoKCQkJCQl9CgkJCQl9CgkJCX0KCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQl9CgoJCWlmIChyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbikgewoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0ge307CgkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCXJldCA9IHJldC5tYXAociA9PiB7CgkJCQkJaWYgKHIgJiYgci5fdG9Eb2N1bWVudCkgewoJCQkJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tLl90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93LlN5bXB0b20uJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIlN5bXB0b20iKTsKCgl9CgoJX19zeW5jX29uKGQpIHsKCQl0aGlzLl9fX3N5bmNfb24gPSB0aGlzLl9fX3N5bmNfb24gfHwge307CgoJCWlmIChkKSB7CgkJCXRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV0gPSBkOwoKCQkJLy8gdGhpcy5zeW1wdG9tX1N5bXB0b21zKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuU3ltcHRvbSh0aGlzLklkKQoKCQkJLmFjdGl2ZSh0aGlzLmFjdGl2ZSgpLCB0aGlzLl9hY3RpdmVfY29vcCkKCgkJCS5lbmFibGVkKHRoaXMuZW5hYmxlZCgpLCB0aGlzLl9lbmFibGVkX2Nvb3ApCgoJCQkuY29kZSh0aGlzLmNvZGUoKSwgdGhpcy5fY29kZV9jb29wKQoKCQkJLm9yZGVyKHRoaXMub3JkZXIoKSwgdGhpcy5fb3JkZXJfY29vcCkKCgkJCS5kYXRlKHRoaXMuZGF0ZSgpLCB0aGlzLl9kYXRlX2Nvb3ApCgoJCQkubmFtZSh0aGlzLm5hbWUoKSwgdGhpcy5fbmFtZV9jb29wKQoKCQkJLnJlbWFyayh0aGlzLnJlbWFyaygpLCB0aGlzLl9yZW1hcmtfY29vcCkKCgkJCS5zeW1wdG9tX0luY2lkZW50cyh0aGlzLnN5bXB0b21fSW5jaWRlbnRzKCksIHRoaXMuX3N5bXB0b21fSW5jaWRlbnRzX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQlvYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ1N5bXB0b20nOwoJCXRvb2wgPSB0b29sIHx8IHRoaXMuVG9vbDsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJTeW1wdG9tIjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCQkJCXJldCA9IHJldC50b0xvd2VyQ2FzZSgpOwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCQl0cnkgewoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgPyAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gb3B0aW9ucy50b29sIHx8IHQgPT0gb3B0aW9ucy50b29sKSA6IHRoaXMuVG9vbDsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sIHx8IHt9OwoKCQkJbGV0IG5JRCA9IHNhbGVzbm93Ll9ub2RlID8gc2FsZXNub3cuX25vZGUuY29kZSgpIDogImRlZmF1bHQiOwoKCQkJbGV0IHJldCA9IG51bGxWYWx1ZTsKCQkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0ID0gbnVsbDsKCgkJCS8vIHRvb2xfQ29uZmlnczogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBkb25lCgkJCWxldCB0Y29uZiA9IChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiBjLm5vZGUgJiYgYy5ub2RlLmNvZGUgPT0gbklEKS5jb25jYXQoKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmICFjLm5vZGUpKTsKCQkJaWYgKHRjb25mLmxlbmd0aCkgewoJCQkJcmV0ID0gdGNvbmZbMF0udmFsdWU7CgkJCQl0cnkgewoJCQkJCXJldCA9IEpTT04ucGFyc2UocmV0KTsKCQkJCX0gY2F0Y2ggKGpleCkge30KCQkJfQoKCQkJLy8gbW9kZWwgQ29uZmlnOiBDb25maWcgaXMgY2xhc3MgbGV2ZWwsIG5vZGUgbm90IHBvc3NpYmxlIC0gcGVuZGluZwoJCQlsZXQgbWNvbmYgPSB0aGlzLkNvbmZpZyA/IHRoaXMuQ29uZmlnW25dIDogdW5kZWZpbmVkOwoJCQlpZiAodHlwZW9mKG1jb25mKSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IG1jb25mOwoKCQkJLy8gY29tbWFuZCBsaW5lOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiBnbG9iYWwubWluaW1pc3QpIHsKCQkJCXJldCA9IGdsb2JhbC5taW5pbWlzdChwcm9jZXNzLmFyZ3Yuc2xpY2UoMikpW25dIHx8IHJldDsKCQkJfQoKCQkJLy8gcmVxdWVzdDogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCXJldCA9IHRoaXMuJF9SRVFVRVNUKG4pIHx8IHJldDsKCgkJCWlmIChvcHRpb25zLm5ld1ZhbHVlKSB7CgkJCQlsZXQgdGMgPSB0Y29uZi5sZW5ndGggPyB0Y29uZlswXSA6IHt9OwoJCQkJdGMubm9kZSA9IHsKCQkJCQljb2RlOiBvcHRpb25zLm5vZGUuY29kZSgpCgkJCQl9OwoJCQkJdGMudmFsdWUgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQkJdGMubmFtZSA9IG47CgkJCQlpZiAoIXRjb25mLmxlbmd0aCkgewoJCQkJCW9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MucHVzaCh0Yyk7CgkJCQl9CgkJCQlyZXQgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQl9CgoJCQkvLyBjb25maWcgcmVwbGFjZW1lbnQKCQkJaWYgKHR5cGVvZihyZXQpID09PSAnc3RyaW5nJykocmV0Lm1hdGNoKG5ldyBSZWdFeHAoYHt7KFtefV0rKX19YCwgImciKSkgfHwgW10pLmZvckVhY2gobSA9PiByZXQgPSByZXQucmVwbGFjZShtLCB0aGlzLl9fY29uZmlnKG0ucmVwbGFjZSgne3snLCAnJykucmVwbGFjZSgnfX0nLCAnJyksIG51bGwsIG9wdGlvbnMpKSk7CgoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fY29uZmlnJywgJ0VudGl0eU9iamVjdCcsIDEsIG4sIG51bGxWYWx1ZSwgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncywgZXgpOwoJCX0KCX0KCglfdG9TUUxUYWJsZSgpIHsKCQlsZXQgcmV0ID0gewoJCQlzcWw6IGBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9ICgKICAgICAgICAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICBgCgkJfTsKCQlyZXQuc3FsICs9ICcvKlN5bXB0b20qLyk7XG4nOwoKCQlyZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiB0cnVlLAoJCQlOdWxsOiB0cnVlLAoJCQkvL0lkOiAob2JqLCB2KSA9PiBvYmouc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWWAsCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJc3ltcHRvbV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzeW1wdG9tX1N5bXB0b21zJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJfSwgIl90b1NRTFRhYmxlIik7CgoJCS8vIHJldC5zcWwgKz0gJy8qU3ltcHRvbSovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbChzcWwsIHRoaXMpOwoKCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCgkJCQkJLy8gaWYodGhpc1snXycrZmllbGQrJ19zZXQnXSAmJiAodHlwZW9mKHRoaXNbJ18nK2ZpZWxkXSk9PT0ndW5kZWZpbmVkJyB8fCB0aGlzWydfJytmaWVsZF09PW51bGwpKSByZXR1cm47CgkJCQkJLy8gaWYodHlwZW9mKGVhT2JqKT09PSd1bmRlZmluZWQnKSByZXR1cm47IC8vIHdoeT8KCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCXJldHVybiBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgImJjOTBlZjk0LWFjYjItNDE4OS1iOWUwLTdlYzE2YjI3YzNhZiIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiBvYmosCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIG9iaiwgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIl9USElTIiwgb2JqLCB0aGlzLl9USElTKTsKCgkJX29wdGlvbnMoInN5bXB0b21fSW5jaWRlbnRzIiwgb2JqLCB0aGlzLnN5bXB0b21fSW5jaWRlbnRzKCkpOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnc3ltcHRvbV9JbmNpZGVudHMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIlN5bXB0b20iICYmIChtLnRhcmdldCB8fCBtLm91dFNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSAmJiAoIW0uc291cmNlIHx8IChtLnNvdXJjZSAmJiAvKiFtLm91dFNjcmlwdCAmJiovIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX3NldCddKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5vdXRTY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMsIG9TY29wZSwgbWFwKSA9PiB7JHttLm91dFNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLm91dFNjcmlwdH0pfWApKHRoaXMsIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnNvdXJjZSkgewoJCQkJaWYgKG0uc291cmNlLmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcykgPT4ge3JldHVybiBfdGhpcy4ke20uc291cmNlfTt9YCkodGhpcyk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnNvdXJjZSwgdGhpcyk7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0udGFyZ2V0KSBvYmpbbS50YXJnZXRdID0gcmV0OwoJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQlbbS50YXJnZXQgfHwgbS5zb3VyY2VdOiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10KCQkJfSk7CgkJfSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJLy8gdXNlIHRoaXMuX21hcCgpIHdpdGggcmV2ZXJzZQoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJiYzkwZWY5NC1hY2IyLTQxODktYjllMC03ZWMxNmIyN2MzYWYiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoInN5bXB0b21fSW5jaWRlbnRzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3N5bXB0b21fSW5jaWRlbnRzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJTeW1wdG9tIiAmJiAobS5zb3VyY2UgfHwgbS5pblNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLmluU2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaiwgb1Njb3BlLCBtYXApID0+IHske20uaW5TY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5pblNjcmlwdH0pfWApKG9iaiwgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0udGFyZ2V0KSB7CgkJCQlpZiAobS50YXJnZXQuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaikgPT4ge3JldHVybiBvYmouJHttLnRhcmdldH07fWApKG9iaik7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmpbbS50YXJnZXRdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS50YXJnZXQsIG9iaik7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS5zb3VyY2UpIHsKCQkJCWlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0ocmV0KTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0gPSByZXQ7CgkJCQl9CgkJCX0KCQl9KTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXTogIiciICsgdGhpcy5JZCArICInIgoJCX07CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2FjdGl2ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hY3RpdmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9lbmFibGVkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY29kZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jb2RlKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fb3JkZXJfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMub3JkZXIoKTsKCgkJCWZWYWx1ZSA9IHYgfHwgJzAnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZGF0ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5kYXRlKCk7CgoJCQl0cnkgewoJCQkJZlZhbHVlID0gIiciICsgKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiAiMTk3MC0xLTEiKSArICInIjsKCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJykgewoJCQkJCWZWYWx1ZSA9IGBTVFJfVE9fREFURSgke2ZWYWx1ZX0sICclWS0lbS0lZFQlVC4lZlonKWA7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9ICdkYXRldGltZSgnICsgZlZhbHVlICsgJyknOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9uYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm5hbWUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcmVtYXJrX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnJlbWFyaygpOwoKCQkJZlZhbHVlID0gIiciICsgKCh2ICYmIHYucmVwbGFjZSkgPyB2LnJlcGxhY2UoL1wnL2csICJcJ1wnIikgOiB2KSArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJyB8fCB0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIHsKCQkJX28gPSBfcSA9ICdgJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3Fsc2VydmVyJykgewoJCQlfbyA9ICdbJzsKCQkJX3EgPSAnXSc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCdhcGlLZXknKSA9PSAnYWlydGFibGUnKSB7CgkJCV9vID0gJ3snOwoJCQlfcSA9ICd9JzsKCQl9CgkJdGhpcy5fX1EgPSB0aGlzLl9fUSA9PSBfbyA/IF9xIDogX287CgkJcmV0dXJuIHRoaXMuX19ROwoJfQoKCV9maWVsZEdyb3VwcyhmZ3MgPSB7fSkgewoJCXRoaXMuX19maWVsZEdyb3VwcyA9IGZnczsKCQlyZXR1cm4gdGhpczsKCX0KCglfZmllbGRBZ2dyZWdhdGVzKGZhcyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkQWdncmVnYXRlcyA9IGZhczsKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9GaWVsZHNTUUwoZmllbGRzKSB7CgoJCWZpZWxkcyA9IGZpZWxkcyB8fCBbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJywgdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCldOwoJCWZpZWxkcyA9IEFycmF5LmlzQXJyYXkoZmllbGRzKSA/IGZpZWxkcyA6IFtmaWVsZHNdOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCS8vIHtmaWVsZDogb3JkZXJ9CgkJCWZpZWxkcyA9IFtdOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU51bGw6IHRydWUsCgoJCX0sICJfdG9TZWxlY3RIZWFkZXIiKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0SGVhZGVyJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU2VsZWN0U1FMKGZpZWxkcykgewoJCWxldCBzcWwgPSAic2VsZWN0ICI7CgoJCWxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9YDsKCgkJbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7CgkJc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOwoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOwoKCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcykgewoJCQkvLyB7ZmllbGQ6IGZ1bmN0aW9ufQoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jb2RlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fb3JkZXJfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vcmRlcl9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9kYXRlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LnRvSVNPU3RyaW5nKSB7CgkJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3FsaXRlJykgewoJCQkJCQlvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbmFtZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX25hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3JlbWFya19zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJc3ltcHRvbV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzeW1wdG9tX1N5bXB0b21zJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9zeW1wdG9tX0luY2lkZW50c19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoInN5bXB0b20uaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX3N5bXB0b21fSW5jaWRlbnRzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl9zeW1wdG9tX0luY2lkZW50c19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9zeW1wdG9tX0luY2lkZW50c19jb29wID09ICc9JyB8fCB0aGlzLl9zeW1wdG9tX0luY2lkZW50c19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX3N5bXB0b21fSW5jaWRlbnRzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKnN5bXB0b21fSW5jaWRlbnRzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQl9LCAiX3RvU2VsZWN0U1FMIiwgZmllbGRzKS5zcWw7CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJaWYgKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWR9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuY29kZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMubmFtZX1gOwoKCQl9CgoJCWlmIChzcWwuZW5kc1dpdGgoIndoZXJlIDE9MSIpKSB7CgkJCS8vIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEiLCAid2hlcmUgMT0wIik7CgkJfSBlbHNlIHsKCQkJc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSBhbmQgIiwgIndoZXJlICIpOwoJCX0KCgkJc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpIDogc3FsOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoKCQlyZXR1cm4gc3FsOwoJfQoKCV90b1BhdGhzKCkgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCV9USElTOiBvYmogPT4ge30sCgoJCQlzeW1wdG9tX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N5bXB0b21fU3ltcHRvbXMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3ltcHRvbV9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJfSwgIl90b1BhdGhzIik7CgkJLy8gcmV0dXJuIHJldDsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5tYXAoayA9PiAoewoJCQlba106IHJldFtrXQoJCX0pKTsKCX0KCglfdG9VcGRhdGVTUUwoZmllbGRzKSB7CgkJbGV0IHJldEZpZWxkcyA9IHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLmpvaW4oJywgJyk7CgkJbGV0IHNxbCA9IGB1cGRhdGUgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSBzZXQgYCArIE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvREJPYmplY3QoZmllbGRzKSkubWFwKHYgPT4gdGhpcy5fUSgpICsgdlswXSArIHRoaXMuX1EoKSArICI9IiArIHZbMV0pICsgYCB3aGVyZSAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgOyAvL2AgcmV0dXJuaW5nICR7cmV0RmllbGRzfWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvVXBkYXRlU1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfdG9JbnNlcnRTUUwoZmllbGRzKSB7CgkJbGV0IG9iaiA9IHRoaXMuX3RvREJPYmplY3QoZmllbGRzKTsKCQlsZXQgc3FsID0gYGluc2VydCBpbnRvICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKGAgKyBPYmplY3Qua2V5cyhvYmopLm1hcChrID0+IHRoaXMuX1EoKSArIGsgKyB0aGlzLl9RKCkpICsgIikgdmFsdWVzICgiICsgT2JqZWN0LnZhbHVlcyhvYmopICsgYClgOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0luc2VydFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5TeW1wdG9tKSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlN5bXB0b20gPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgc3FsID0gbmV3IHNhbGVzbm93LlN5bXB0b20oKQoKCQkJCQkuc3ltcHRvbV9JbmNpZGVudHMobmV3IHNhbGVzbm93LkluY2lkZW50KCkpCgoJCQkJCS5fdG9TUUxUYWJsZShkZXB0aCk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJTeW1wdG9tIikgcmV0dXJuIGZhbHNlOwoKCQkJbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJCUZ1bGw6IHRydWUsCgkJCQlOdWxsOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5faWQgPSB0aGlzLklkID09IHF1ZXJ5LklkLAoKCQkJCWFjdGl2ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouYWN0aXZlID0gdiA9PSBxdWVyeS5hY3RpdmUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fYWN0aXZlX3NldCAmJiAhcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2FjdGl2ZV9zZXQgJiYgcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5lbmFibGVkID0gdiA9PSBxdWVyeS5lbmFibGVkKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ICYmICFxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9lbmFibGVkX3NldCAmJiBxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY29kZSA9IHYgPT0gcXVlcnkuY29kZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jb2RlX3NldCAmJiAhcXVlcnkuX2NvZGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY29kZV9zZXQgJiYgcXVlcnkuX2NvZGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vcmRlciA9IHYgPT0gcXVlcnkub3JkZXIoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fb3JkZXJfc2V0ICYmICFxdWVyeS5fb3JkZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX29yZGVyX3NldCAmJiBxdWVyeS5fb3JkZXJfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5kYXRlID0gdiA9PSBxdWVyeS5kYXRlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2RhdGVfc2V0ICYmICFxdWVyeS5fZGF0ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9kYXRlX3NldCAmJiBxdWVyeS5fZGF0ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubmFtZSA9IHYgPT0gcXVlcnkubmFtZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9uYW1lX3NldCAmJiAhcXVlcnkuX25hbWVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbmFtZV9zZXQgJiYgcXVlcnkuX25hbWVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gZmFsc2U7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucmVtYXJrID0gdiA9PSBxdWVyeS5yZW1hcmsoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcmVtYXJrX3NldCAmJiAhcXVlcnkuX3JlbWFya19zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3JlbWFya19zZXQgJiYgcXVlcnkuX3JlbWFya19zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IGZhbHNlOwoJCQkJfSwKCgkJCQlzeW1wdG9tX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5zeW1wdG9tX0luY2lkZW50cyA9IHYubWFwKF92ID0+IHF1ZXJ5LnN5bXB0b21fSW5jaWRlbnRzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoZXMiKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDAsIG9NYXRjaCk7CgoJCQlyZXR1cm4gT2JqZWN0LmtleXMob01hdGNoKS5ldmVyeShrID0+IG9NYXRjaFtrXSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfbWF0Y2hpbmcocXVlcnkpIHsKCQl0cnkgewoJCQlsZXQgcmV0ID0gW107CgoJCQlsZXQgbWF0Y2hlcyA9IHRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlzeW1wdG9tX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5zeW1wdG9tX0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fYWN0aXZlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcmRlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9kYXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX25hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcmVtYXJrX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlzeW1wdG9tX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLnN5bXB0b21fSW5jaWRlbnRzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ107CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJc3ltcHRvbV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzeW1wdG9tX1N5bXB0b21zJywgdW5kZWZpbmVkKSA6ICJzeW1wdG9tX0luY2lkZW50cyIpKSA9PiB0aGlzLnN5bXB0b21fSW5jaWRlbnRzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5JbmNpZGVudCgpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQl9LCAiX2Zyb21Eb2N1bWVudCIpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSB7CgkJbGV0IHJldCA9IHt9OwoKCQlpZiAoIWJUb29sKSB7CgkJCXJldC5fX2dlbmVyYXRlZCA9IG5ldyBEYXRlKCk7CgkJCWlmICh0aGlzLlRvb2wubmFtZSkgewoJCQkJcmV0Ll9fdG9vbCA9IHsKCQkJCQluYW1lOiB0aGlzLlRvb2wubmFtZSwKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlpZiAoc2FsZXNub3cuX25vZGUpIHsKCQkJCXJldC5fX25vZGUgPSB7CgkJCQkJY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogYkZ1bGwsCgkJCU51bGw6IGJOdWxsLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXSA9IHYsCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3JkZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGw7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIG9ialtlYUNvZGVdID0gb2JqW2VhQ29kZV0ucmVwbGFjZSgvXC5bMC05XSpaL2csICcnKTsKCgkJCQlpZiAodGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGF0ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9uYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9uYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3JlbWFya19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQlzeW1wdG9tX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3N5bXB0b21fU3ltcHRvbXMnLCB1bmRlZmluZWQpIDogInN5bXB0b21fSW5jaWRlbnRzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX3N5bXB0b21fSW5jaWRlbnRzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9zeW1wdG9tX0luY2lkZW50c19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSBmYWxzZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLm5hbWUgPSB7fTsKCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgZXJyb3IubmFtZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IubmFtZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IubmFtZTsKCQl9CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlLl9wYXJlbnQpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuU3ltcHRvbS5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuU3ltcHRvbShudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuY29kZSh0aGlzLmNvZGUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBGaW5pc2hlZCBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0gSWQ9WyR7dGhpcy5JZH1dYCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5zeW1wdG9tX0luY2lkZW50cygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlN5bXB0b20uaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b0luc2VydFNRTCgpKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luc2VydCcsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuU3ltcHRvbS51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1VwZGF0ZVNRTCgpKTsKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTCgpKTsKCQkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IHJldFswXTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuU3ltcHRvbS5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSAoYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgKTsKCQkJCXJldCA9IHJldCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5TeW1wdG9tKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuSW5jaWRlbnQgPSBjbGFzcyBJbmNpZGVudCBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFpZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzSWtkcGRFaDFZaUpkYCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJudW1iZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX251bWJlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInRpdGxlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl90aXRsZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRlc2NyaXB0aW9uIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kZXNjcmlwdGlvbigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImxvY2F0aW9uIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9sb2NhdGlvbigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImdyb3VwIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9ncm91cCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInN0YXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9zdGF0ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInN5bXB0b20iLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3N5bXB0b20oKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjbG9zZV9yZWFzb24iLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2Nsb3NlX3JlYXNvbigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInByaW9yaXR5IiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9wcmlvcml0eSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNhbGxlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY2FsbGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29udGFjdCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29udGFjdCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiSW5jaWRlbnQiLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCXJldHVybiB0aGlzOwoKCQlpZiAodGhpcy5fbG9jYXRpb25fc2V0ICYmIHRoaXMuX2xvY2F0aW9uKSB0aGlzLl9sb2NhdGlvbi5Ub29sID0gdG9vbDsKCgkJaWYgKHRoaXMuX2dyb3VwX3NldCAmJiB0aGlzLl9ncm91cCkgdGhpcy5fZ3JvdXAuVG9vbCA9IHRvb2w7CgoJCWlmICh0aGlzLl9zdGF0ZV9zZXQgJiYgdGhpcy5fc3RhdGUpIHRoaXMuX3N0YXRlLlRvb2wgPSB0b29sOwoKCQlpZiAodGhpcy5fc3ltcHRvbV9zZXQgJiYgdGhpcy5fc3ltcHRvbSkgdGhpcy5fc3ltcHRvbS5Ub29sID0gdG9vbDsKCgkJaWYgKHRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQgJiYgdGhpcy5fY2xvc2VfcmVhc29uKSB0aGlzLl9jbG9zZV9yZWFzb24uVG9vbCA9IHRvb2w7CgoJCWlmICh0aGlzLl9wcmlvcml0eV9zZXQgJiYgdGhpcy5fcHJpb3JpdHkpIHRoaXMuX3ByaW9yaXR5LlRvb2wgPSB0b29sOwoKCQlpZiAodGhpcy5fY2FsbGVyX3NldCAmJiB0aGlzLl9jYWxsZXIpIHRoaXMuX2NhbGxlci5Ub29sID0gdG9vbDsKCgkJaWYgKHRoaXMuX2NvbnRhY3Rfc2V0ICYmIHRoaXMuX2NvbnRhY3QpIHRoaXMuX2NvbnRhY3QuVG9vbCA9IHRvb2w7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBudW1iZXIgKiovCgludW1iZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9udW1iZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJudW1iZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX251bWJlciAhPSB2KSB7CgkJCQl0aGlzLl9udW1iZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX251bWJlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9udW1iZXIpOwoJCX0KCX0KCgljbGVhcl9udW1iZXIoKSB7CgkJdGhpcy5fbnVtYmVyX3NldCA9IG51bGw7CgkJdGhpcy5fbnVtYmVyID0gbnVsbDsKCQl0aGlzLl9udW1iZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG51bWJlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHRpdGxlICoqLwoJdGl0bGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl90aXRsZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInRpdGxlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl90aXRsZSAhPSB2KSB7CgkJCQl0aGlzLl90aXRsZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fdGl0bGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fdGl0bGUpOwoJCX0KCX0KCgljbGVhcl90aXRsZSgpIHsKCQl0aGlzLl90aXRsZV9zZXQgPSBudWxsOwoJCXRoaXMuX3RpdGxlID0gbnVsbDsKCQl0aGlzLl90aXRsZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdGl0bGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkZXNjcmlwdGlvbiAqKi8KCWRlc2NyaXB0aW9uKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGVzY3JpcHRpb25fY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkZXNjcmlwdGlvbiIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGVzY3JpcHRpb24gIT0gdikgewoJCQkJdGhpcy5fZGVzY3JpcHRpb25fc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2Rlc2NyaXB0aW9uID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2Rlc2NyaXB0aW9uKTsKCQl9Cgl9CgoJY2xlYXJfZGVzY3JpcHRpb24oKSB7CgkJdGhpcy5fZGVzY3JpcHRpb25fc2V0ID0gbnVsbDsKCQl0aGlzLl9kZXNjcmlwdGlvbiA9IG51bGw7CgkJdGhpcy5fZGVzY3JpcHRpb25fY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRlc2NyaXB0aW9uICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbG9jYXRpb24gKiovCglsb2NhdGlvbih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2xvY2F0aW9uX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibG9jYXRpb24iKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc1NmZmZmMzNi1lMzBhLTRjYTEtYjM1My1kNGVjMTVkZWFhYTQnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdMb2NhdGlvbicpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdsb2NhdGlvbicsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjU2ZmZmYzM2LWUzMGEtNGNhMS1iMzUzLWQ0ZWMxNWRlYWFhNCIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJMb2NhdGlvbiIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9sb2NhdGlvbiAhPSB2KSB7CgkJCQl0aGlzLl9sb2NhdGlvbl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2xvY2F0aW9uJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9sb2NhdGlvbiA/IHRoaXMuX2xvY2F0aW9uLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9sb2NhdGlvbl9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fbG9jYXRpb24gPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbG9jYXRpb24pOwoJCX0KCX0KCgljbGVhcl9sb2NhdGlvbigpIHsKCQl0aGlzLl9sb2NhdGlvbl9zZXQgPSBudWxsOwoJCXRoaXMuX2xvY2F0aW9uID0gbnVsbDsKCQl0aGlzLl9sb2NhdGlvbl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbG9jYXRpb24gKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBncm91cCAqKi8KCWdyb3VwKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZ3JvdXBfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJncm91cCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzUzMWQzNzU2LWY2MmEtNDIzNC1iOTZkLTgwNDgzNjIyYjIyMScgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0dyb3VwJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dyb3VwJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiNTMxZDM3NTYtZjYyYS00MjM0LWI5NmQtODA0ODM2MjJiMjIxIiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIkdyb3VwIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2dyb3VwICE9IHYpIHsKCQkJCXRoaXMuX2dyb3VwX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ3JvdXAnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX2dyb3VwID8gdGhpcy5fZ3JvdXAuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX2dyb3VwX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9ncm91cCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9ncm91cCk7CgkJfQoJfQoKCWNsZWFyX2dyb3VwKCkgewoJCXRoaXMuX2dyb3VwX3NldCA9IG51bGw7CgkJdGhpcy5fZ3JvdXAgPSBudWxsOwoJCXRoaXMuX2dyb3VwX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBncm91cCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHN0YXRlICoqLwoJc3RhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9zdGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInN0YXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnYTdhNDk3NWItYzI3YS00YzZlLWJhN2QtNjQ0NzRhNGExNmI4JyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnU3RhdGUnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RhdGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICJhN2E0OTc1Yi1jMjdhLTRjNmUtYmE3ZC02NDQ3NGE0YTE2YjgiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiU3RhdGUiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fc3RhdGUgIT0gdikgewoJCQkJdGhpcy5fc3RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fc3RhdGUgPyB0aGlzLl9zdGF0ZS5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fc3RhdGVfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX3N0YXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3N0YXRlKTsKCQl9Cgl9CgoJY2xlYXJfc3RhdGUoKSB7CgkJdGhpcy5fc3RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9zdGF0ZSA9IG51bGw7CgkJdGhpcy5fc3RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHN0YXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc3ltcHRvbSAqKi8KCXN5bXB0b20odiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9zeW1wdG9tX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgic3ltcHRvbSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2JjOTBlZjk0LWFjYjItNDE4OS1iOWUwLTdlYzE2YjI3YzNhZicgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ1N5bXB0b20nKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3ltcHRvbScsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgImJjOTBlZjk0LWFjYjItNDE4OS1iOWUwLTdlYzE2YjI3YzNhZiIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJTeW1wdG9tIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3N5bXB0b20gIT0gdikgewoJCQkJdGhpcy5fc3ltcHRvbV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N5bXB0b20nLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX3N5bXB0b20gPyB0aGlzLl9zeW1wdG9tLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9zeW1wdG9tX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9zeW1wdG9tID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3N5bXB0b20pOwoJCX0KCX0KCgljbGVhcl9zeW1wdG9tKCkgewoJCXRoaXMuX3N5bXB0b21fc2V0ID0gbnVsbDsKCQl0aGlzLl9zeW1wdG9tID0gbnVsbDsKCQl0aGlzLl9zeW1wdG9tX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBzeW1wdG9tICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY2xvc2VfcmVhc29uICoqLwoJY2xvc2VfcmVhc29uKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY2xvc2VfcmVhc29uX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY2xvc2VfcmVhc29uIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnMjJiMzk3YTMtZjNlMy00NDVjLTkyNGEtNTBjNjAwMDFjYmFhJyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnUmVhc29uJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2Nsb3NlX3JlYXNvbicsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjIyYjM5N2EzLWYzZTMtNDQ1Yy05MjRhLTUwYzYwMDAxY2JhYSIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJSZWFzb24iKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY2xvc2VfcmVhc29uICE9IHYpIHsKCQkJCXRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2Nsb3NlX3JlYXNvbicsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fY2xvc2VfcmVhc29uID8gdGhpcy5fY2xvc2VfcmVhc29uLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9jbG9zZV9yZWFzb25fc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX2Nsb3NlX3JlYXNvbiA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jbG9zZV9yZWFzb24pOwoJCX0KCX0KCgljbGVhcl9jbG9zZV9yZWFzb24oKSB7CgkJdGhpcy5fY2xvc2VfcmVhc29uX3NldCA9IG51bGw7CgkJdGhpcy5fY2xvc2VfcmVhc29uID0gbnVsbDsKCQl0aGlzLl9jbG9zZV9yZWFzb25fY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNsb3NlX3JlYXNvbiAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHByaW9yaXR5ICoqLwoJcHJpb3JpdHkodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9wcmlvcml0eV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInByaW9yaXR5Iik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnOTM2MGZhMDYtNmEyZi00MzI2LThkNDgtYzJkNGUxNTNlNTE0JyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnUHJpb3JpdHknKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAncHJpb3JpdHknLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICI5MzYwZmEwNi02YTJmLTQzMjYtOGQ0OC1jMmQ0ZTE1M2U1MTQiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiUHJpb3JpdHkiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcHJpb3JpdHkgIT0gdikgewoJCQkJdGhpcy5fcHJpb3JpdHlfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdwcmlvcml0eScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fcHJpb3JpdHkgPyB0aGlzLl9wcmlvcml0eS5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fcHJpb3JpdHlfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX3ByaW9yaXR5ID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3ByaW9yaXR5KTsKCQl9Cgl9CgoJY2xlYXJfcHJpb3JpdHkoKSB7CgkJdGhpcy5fcHJpb3JpdHlfc2V0ID0gbnVsbDsKCQl0aGlzLl9wcmlvcml0eSA9IG51bGw7CgkJdGhpcy5fcHJpb3JpdHlfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHByaW9yaXR5ICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY2FsbGVyICoqLwoJY2FsbGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY2FsbGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY2FsbGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnZjU4N2RiYTQtNzFiNS00NGUxLWE0MmMtNTU3ZjUwYTM3MTU1JyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnVXNlcicpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjYWxsZXInLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICJmNTg3ZGJhNC03MWI1LTQ0ZTEtYTQyYy01NTdmNTBhMzcxNTUiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiVXNlciIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jYWxsZXIgIT0gdikgewoJCQkJdGhpcy5fY2FsbGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnY2FsbGVyJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9jYWxsZXIgPyB0aGlzLl9jYWxsZXIuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX2NhbGxlcl9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fY2FsbGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NhbGxlcik7CgkJfQoJfQoKCWNsZWFyX2NhbGxlcigpIHsKCQl0aGlzLl9jYWxsZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9jYWxsZXIgPSBudWxsOwoJCXRoaXMuX2NhbGxlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY2FsbGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29udGFjdCAqKi8KCWNvbnRhY3QodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb250YWN0X2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29udGFjdCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2Y1ODdkYmE0LTcxYjUtNDRlMS1hNDJjLTU1N2Y1MGEzNzE1NScgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ1VzZXInKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnY29udGFjdCcsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgImY1ODdkYmE0LTcxYjUtNDRlMS1hNDJjLTU1N2Y1MGEzNzE1NSIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJVc2VyIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvbnRhY3QgIT0gdikgewoJCQkJdGhpcy5fY29udGFjdF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NvbnRhY3QnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX2NvbnRhY3QgPyB0aGlzLl9jb250YWN0LlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9jb250YWN0X3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9jb250YWN0ID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvbnRhY3QpOwoJCX0KCX0KCgljbGVhcl9jb250YWN0KCkgewoJCXRoaXMuX2NvbnRhY3Rfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb250YWN0ID0gbnVsbDsKCQl0aGlzLl9jb250YWN0X2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb250YWN0ICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fbnVtYmVyX3NldCwKCgkJCXRoaXMuX3RpdGxlX3NldCwKCgkJCXRoaXMuX2Rlc2NyaXB0aW9uX3NldCwKCgkJCXRoaXMuX2xvY2F0aW9uX3NldCwKCgkJCXRoaXMuX2dyb3VwX3NldCwKCgkJCXRoaXMuX3N0YXRlX3NldCwKCgkJCXRoaXMuX3N5bXB0b21fc2V0LAoKCQkJdGhpcy5fY2xvc2VfcmVhc29uX3NldCwKCgkJCXRoaXMuX3ByaW9yaXR5X3NldCwKCgkJCXRoaXMuX2NhbGxlcl9zZXQsCgoJCQl0aGlzLl9jb250YWN0X3NldCwKCgkJCXRoaXMuX2FjdGl2ZV9zZXQsCgoJCQl0aGlzLl9lbmFibGVkX3NldCwKCgkJCXRoaXMuX2NvZGVfc2V0LAoKCQkJdGhpcy5fb3JkZXJfc2V0LAoKCQkJdGhpcy5fZGF0ZV9zZXQsCgoJCQl0aGlzLl9uYW1lX3NldCwKCgkJCXRoaXMuX3JlbWFya19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9udW1iZXJfc2V0ID0gdGhpcy5fbnVtYmVyX3NldDsKCQlyZXQuX251bWJlcl9jb29wID0gdGhpcy5fbnVtYmVyX2Nvb3A7CgkJcmV0Lm51bWJlciA9IHRoaXMubnVtYmVyKCkgPyB0aGlzLm51bWJlcigpIDogdGhpcy5udW1iZXIoKTsKCgkJcmV0Ll90aXRsZV9zZXQgPSB0aGlzLl90aXRsZV9zZXQ7CgkJcmV0Ll90aXRsZV9jb29wID0gdGhpcy5fdGl0bGVfY29vcDsKCQlyZXQudGl0bGUgPSB0aGlzLnRpdGxlKCkgPyB0aGlzLnRpdGxlKCkgOiB0aGlzLnRpdGxlKCk7CgoJCXJldC5fZGVzY3JpcHRpb25fc2V0ID0gdGhpcy5fZGVzY3JpcHRpb25fc2V0OwoJCXJldC5fZGVzY3JpcHRpb25fY29vcCA9IHRoaXMuX2Rlc2NyaXB0aW9uX2Nvb3A7CgkJcmV0LmRlc2NyaXB0aW9uID0gdGhpcy5kZXNjcmlwdGlvbigpID8gdGhpcy5kZXNjcmlwdGlvbigpIDogdGhpcy5kZXNjcmlwdGlvbigpOwoKCQlyZXQuX2xvY2F0aW9uX3NldCA9IHRoaXMuX2xvY2F0aW9uX3NldDsKCQlyZXQuX2xvY2F0aW9uX2Nvb3AgPSB0aGlzLl9sb2NhdGlvbl9jb29wOwoJCXJldC5sb2NhdGlvbiA9IHRoaXMubG9jYXRpb24oKSA/IHRoaXMubG9jYXRpb24oKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5sb2NhdGlvbigpOwoKCQlyZXQuX2dyb3VwX3NldCA9IHRoaXMuX2dyb3VwX3NldDsKCQlyZXQuX2dyb3VwX2Nvb3AgPSB0aGlzLl9ncm91cF9jb29wOwoJCXJldC5ncm91cCA9IHRoaXMuZ3JvdXAoKSA/IHRoaXMuZ3JvdXAoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5ncm91cCgpOwoKCQlyZXQuX3N0YXRlX3NldCA9IHRoaXMuX3N0YXRlX3NldDsKCQlyZXQuX3N0YXRlX2Nvb3AgPSB0aGlzLl9zdGF0ZV9jb29wOwoJCXJldC5zdGF0ZSA9IHRoaXMuc3RhdGUoKSA/IHRoaXMuc3RhdGUoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5zdGF0ZSgpOwoKCQlyZXQuX3N5bXB0b21fc2V0ID0gdGhpcy5fc3ltcHRvbV9zZXQ7CgkJcmV0Ll9zeW1wdG9tX2Nvb3AgPSB0aGlzLl9zeW1wdG9tX2Nvb3A7CgkJcmV0LnN5bXB0b20gPSB0aGlzLnN5bXB0b20oKSA/IHRoaXMuc3ltcHRvbSgpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLnN5bXB0b20oKTsKCgkJcmV0Ll9jbG9zZV9yZWFzb25fc2V0ID0gdGhpcy5fY2xvc2VfcmVhc29uX3NldDsKCQlyZXQuX2Nsb3NlX3JlYXNvbl9jb29wID0gdGhpcy5fY2xvc2VfcmVhc29uX2Nvb3A7CgkJcmV0LmNsb3NlX3JlYXNvbiA9IHRoaXMuY2xvc2VfcmVhc29uKCkgPyB0aGlzLmNsb3NlX3JlYXNvbigpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLmNsb3NlX3JlYXNvbigpOwoKCQlyZXQuX3ByaW9yaXR5X3NldCA9IHRoaXMuX3ByaW9yaXR5X3NldDsKCQlyZXQuX3ByaW9yaXR5X2Nvb3AgPSB0aGlzLl9wcmlvcml0eV9jb29wOwoJCXJldC5wcmlvcml0eSA9IHRoaXMucHJpb3JpdHkoKSA/IHRoaXMucHJpb3JpdHkoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5wcmlvcml0eSgpOwoKCQlyZXQuX2NhbGxlcl9zZXQgPSB0aGlzLl9jYWxsZXJfc2V0OwoJCXJldC5fY2FsbGVyX2Nvb3AgPSB0aGlzLl9jYWxsZXJfY29vcDsKCQlyZXQuY2FsbGVyID0gdGhpcy5jYWxsZXIoKSA/IHRoaXMuY2FsbGVyKCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMuY2FsbGVyKCk7CgoJCXJldC5fY29udGFjdF9zZXQgPSB0aGlzLl9jb250YWN0X3NldDsKCQlyZXQuX2NvbnRhY3RfY29vcCA9IHRoaXMuX2NvbnRhY3RfY29vcDsKCQlyZXQuY29udGFjdCA9IHRoaXMuY29udGFjdCgpID8gdGhpcy5jb250YWN0KCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMuY29udGFjdCgpOwoKCQlyZXQuX2FjdGl2ZV9zZXQgPSB0aGlzLl9hY3RpdmVfc2V0OwoJCXJldC5fYWN0aXZlX2Nvb3AgPSB0aGlzLl9hY3RpdmVfY29vcDsKCQlyZXQuYWN0aXZlID0gdGhpcy5hY3RpdmUoKSA/IHRoaXMuYWN0aXZlKCkgOiB0aGlzLmFjdGl2ZSgpOwoKCQlyZXQuX2VuYWJsZWRfc2V0ID0gdGhpcy5fZW5hYmxlZF9zZXQ7CgkJcmV0Ll9lbmFibGVkX2Nvb3AgPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJcmV0LmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKSA/IHRoaXMuZW5hYmxlZCgpIDogdGhpcy5lbmFibGVkKCk7CgoJCXJldC5fY29kZV9zZXQgPSB0aGlzLl9jb2RlX3NldDsKCQlyZXQuX2NvZGVfY29vcCA9IHRoaXMuX2NvZGVfY29vcDsKCQlyZXQuY29kZSA9IHRoaXMuY29kZSgpID8gdGhpcy5jb2RlKCkgOiB0aGlzLmNvZGUoKTsKCgkJcmV0Ll9vcmRlcl9zZXQgPSB0aGlzLl9vcmRlcl9zZXQ7CgkJcmV0Ll9vcmRlcl9jb29wID0gdGhpcy5fb3JkZXJfY29vcDsKCQlyZXQub3JkZXIgPSB0aGlzLm9yZGVyKCkgPyB0aGlzLm9yZGVyKCkgOiB0aGlzLm9yZGVyKCk7CgoJCXJldC5fZGF0ZV9zZXQgPSB0aGlzLl9kYXRlX3NldDsKCQlyZXQuX2RhdGVfY29vcCA9IHRoaXMuX2RhdGVfY29vcDsKCQlyZXQuZGF0ZSA9IHRoaXMuZGF0ZSgpID8gdGhpcy5kYXRlKCkgOiB0aGlzLmRhdGUoKTsKCgkJcmV0Ll9uYW1lX3NldCA9IHRoaXMuX25hbWVfc2V0OwoJCXJldC5fbmFtZV9jb29wID0gdGhpcy5fbmFtZV9jb29wOwoJCXJldC5uYW1lID0gdGhpcy5uYW1lKCkgPyB0aGlzLm5hbWUoKSA6IHRoaXMubmFtZSgpOwoKCQlyZXQuX3JlbWFya19zZXQgPSB0aGlzLl9yZW1hcmtfc2V0OwoJCXJldC5fcmVtYXJrX2Nvb3AgPSB0aGlzLl9yZW1hcmtfY29vcDsKCQlyZXQucmVtYXJrID0gdGhpcy5yZW1hcmsoKSA/IHRoaXMucmVtYXJrKCkgOiB0aGlzLnJlbWFyaygpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJudW1iZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbnVtYmVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkidGl0bGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndGl0bGUnLCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpUWlhKMmFXTmxUbTkzSWpvaWMyaHZjblJmWkdWelkzSnBjSFJwYjI0aWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQl9KSkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRlc2NyaXB0aW9uIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2Rlc2NyaXB0aW9uJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkibG9jYXRpb24iOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJncm91cCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJInN0YXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N0YXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkic3ltcHRvbSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkiY2xvc2VfcmVhc29uIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJInByaW9yaXR5IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3ByaW9yaXR5JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkiY2FsbGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJImNvbnRhY3QiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJsb2NhdGlvbiIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgbG9jYXRpb24nLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93LkxvY2F0aW9uKCkubG9jYXRpb25fSW5jaWRlbnRzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAiZ3JvdXAiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIGdyb3VwJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Hcm91cCgpLmdyb3VwX0luY2lkZW50cyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInN0YXRlIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBzdGF0ZScsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuU3RhdGUoKS5zdGF0ZV9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJzeW1wdG9tIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBzeW1wdG9tJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5TeW1wdG9tKCkuc3ltcHRvbV9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJjbG9zZV9yZWFzb24iKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIGNsb3NlX3JlYXNvbicsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuUmVhc29uKCkuY2xvc2VfcmVhc29uX0luY2lkZW50cyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInByaW9yaXR5IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBwcmlvcml0eScsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuUHJpb3JpdHkoKS5wcmlvcml0eV9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJjYWxsZXIiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIGNhbGxlcicsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuVXNlcigpLmNhbGxlcl9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJjb250YWN0IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBjb250YWN0Jywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Vc2VyKCkuY29udGFjdF9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCAmJiBldmVudC5jbGFzc05hbWUoKSAmJiBldmVudC5jbGFzc05hbWUoKSAhPSAnSW5jaWRlbnQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiRGVsZWdhdGluZyBpbnZva2F0aW9uIHRvICIgKyBldmVudC5jbGFzc05hbWUoKSk7CgkJCQlyZXR1cm4gbmV3IHNhbGVzbm93W2V2ZW50LmNsYXNzTmFtZSgpXSgpLl9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpOwoJCQl9CgoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQlkYXRhLl9fdGhpcyA9IGRhdGEuX190aGlzIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkJc3dpdGNoIChtZXRob2QpIHsKCgkJCQljYXNlICJ0ZXN0U3luYyI6IHsKCgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJY2FzZSAiaW5Qcm9ncmVzcyI6IHsKCgkJCQkJZGF0YS5yZWFzb24gPSBkYXRhLnJlYXNvbiA/IGRhdGEucmVhc29uCgoJCQkJCQk6CgkJCQkJCXVuZGVmaW5lZDsKCgkJCQkJYnJlYWs7CgkJCQl9CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL0luY2lkZW50LyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7CgoJCQl9CgoJCQkvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8KCgkJCWxldCB2ID0gdW5kZWZpbmVkOwoJCQl0cnkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke21ldGhvZH1gKTsKCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQlsZXQgX2lkID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgZGF0YSwgbWV0aG9kLCB7fSk7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIHsKCQkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKGRhdGEpOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSBkYXRhLl9fdGhpcy5jb2RlIHx8IGRhdGEuaWQgfHwgZGF0YS5JRDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCQlpZiAoZGF0YS5JZCAmJiBkYXRhLklkID09IGRhdGEuSWQpIHsKCQkJCQkJX2lkID0gZGF0YS5JZDsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5FbnRpdHlDbGFzcykgewoJCQkJCQlfaWQgPSBkYXRhLkVudGl0eUNsYXNzLklkIHx8IGRhdGEuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI3NDA3OTM0Ny1jZGMyLTRlMGUtOGRkMi1jOTFlNWMzOGQwMGQiIHx8ICJOVUxMIjsKCQkJCQl9CgkJCQl9CgoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudCB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbbWV0aG9kXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFttZXRob2RdW19pZF0gfHwge307CgoJCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKHt9LCB7CgkJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJCX0pOwoKCQkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnSW5jaWRlbnQnKS5zZW5kZXIoc2FsZXNub3cuX25vZGUpLmNhcnJpZXIoc2FsZXNub3cuX25vZGUpLnBheWxvYWQoZGF0YSk7CgkJCWlmIChldmVudCkgewoJCQkJaWYgKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOwoJCQkJaWYgKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOwoJCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJaWYgKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOwoJCQl9CgkJCXJldCA9IGF3YWl0IGV2LnRyaWdnZXIoKTsKCgkJCWlmICh0eXBlb2YocmV0KSA9PT0gInN0cmluZyIpIHsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCX0KCQkJcmV0dXJuIHJldDsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJ0ZXN0U3luYyI6IHsKCgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5JbmNpZGVudChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiaW5Qcm9ncmVzcyI6IHsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiaW5zZXJ0IjoKCQkJY2FzZSAidXBkYXRlIjoKCQkJY2FzZSAic3RvcmUiOgoJCQljYXNlICJkZWxldGUiOgoJCQljYXNlICJmaW5kIjogewoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuSW5jaWRlbnQobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX25vZGUpIHsKCQkJLy8gcHJvYmFibHkgc2hvdWxkIG5vdCBiZSBwcm9jZXNzZWQgaGVyZSwgYnV0IHJhdGhlciBjb25zdW1lZCBhcyBwYXJ0IG9mIHRoZSBleGVjdXRlKCkgbG9naWMsIHB1c2hpbmcgX19ub2RlIHRvIHRoZSBsaXN0IG9mIG15IG5vZGVzIHRvIGRlbGVnYXRlIHRvIT8KCQkJbGV0IHRuID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX19ub2RlKS5fZGVSZWZlcmVuY2UoKTsKCQkJZGVsZXRlIF9wYXJhbXMuX19ub2RlOwoJCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2ludm9rZU5vZGUodG4sIG1ldGhvZCwgX3BhcmFtcyk7CgkJfQoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJ0ZXN0U3luYyI6IHsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiaW5Qcm9ncmVzcyI6IHsKCgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnJlYXNvbik7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYEluY2lkZW50Ll9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgSW5jaWRlbnQuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnQuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuSW5jaWRlbnQuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIkluY2lkZW50Iik7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCWlmICh0aGlzLl9sb2NhdGlvbl9zZXQgJiYgdGhpcy5sb2NhdGlvbigpKSB0aGlzLmxvY2F0aW9uKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX2dyb3VwX3NldCAmJiB0aGlzLmdyb3VwKCkpIHRoaXMuZ3JvdXAoKS5fX3N5bmNfb24oZCk7CgoJCQlpZiAodGhpcy5fc3RhdGVfc2V0ICYmIHRoaXMuc3RhdGUoKSkgdGhpcy5zdGF0ZSgpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl9zeW1wdG9tX3NldCAmJiB0aGlzLnN5bXB0b20oKSkgdGhpcy5zeW1wdG9tKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQgJiYgdGhpcy5jbG9zZV9yZWFzb24oKSkgdGhpcy5jbG9zZV9yZWFzb24oKS5fX3N5bmNfb24oZCk7CgoJCQlpZiAodGhpcy5fcHJpb3JpdHlfc2V0ICYmIHRoaXMucHJpb3JpdHkoKSkgdGhpcy5wcmlvcml0eSgpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl9jYWxsZXJfc2V0ICYmIHRoaXMuY2FsbGVyKCkpIHRoaXMuY2FsbGVyKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX2NvbnRhY3Rfc2V0ICYmIHRoaXMuY29udGFjdCgpKSB0aGlzLmNvbnRhY3QoKS5fX3N5bmNfb24oZCk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93LkluY2lkZW50KHRoaXMuSWQpCgoJCQkubnVtYmVyKHRoaXMubnVtYmVyKCksIHRoaXMuX251bWJlcl9jb29wKQoKCQkJLnRpdGxlKHRoaXMudGl0bGUoKSwgdGhpcy5fdGl0bGVfY29vcCkKCgkJCS5kZXNjcmlwdGlvbih0aGlzLmRlc2NyaXB0aW9uKCksIHRoaXMuX2Rlc2NyaXB0aW9uX2Nvb3ApCgoJCQkubG9jYXRpb24odGhpcy5sb2NhdGlvbigpLCB0aGlzLl9sb2NhdGlvbl9jb29wKQoKCQkJLmdyb3VwKHRoaXMuZ3JvdXAoKSwgdGhpcy5fZ3JvdXBfY29vcCkKCgkJCS5zdGF0ZSh0aGlzLnN0YXRlKCksIHRoaXMuX3N0YXRlX2Nvb3ApCgoJCQkuc3ltcHRvbSh0aGlzLnN5bXB0b20oKSwgdGhpcy5fc3ltcHRvbV9jb29wKQoKCQkJLmNsb3NlX3JlYXNvbih0aGlzLmNsb3NlX3JlYXNvbigpLCB0aGlzLl9jbG9zZV9yZWFzb25fY29vcCkKCgkJCS5wcmlvcml0eSh0aGlzLnByaW9yaXR5KCksIHRoaXMuX3ByaW9yaXR5X2Nvb3ApCgoJCQkuY2FsbGVyKHRoaXMuY2FsbGVyKCksIHRoaXMuX2NhbGxlcl9jb29wKQoKCQkJLmNvbnRhY3QodGhpcy5jb250YWN0KCksIHRoaXMuX2NvbnRhY3RfY29vcCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQlvYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ0luY2lkZW50JzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiSW5jaWRlbnQiOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoJCQkJcmV0ID0gcmV0LnRvTG93ZXJDYXNlKCk7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMgPSB7fSkgewoJCXRyeSB7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCA/IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSBvcHRpb25zLnRvb2wgfHwgdCA9PSBvcHRpb25zLnRvb2wpIDogdGhpcy5Ub29sOwoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgfHwge307CgoJCQlsZXQgbklEID0gc2FsZXNub3cuX25vZGUgPyBzYWxlc25vdy5fbm9kZS5jb2RlKCkgOiAiZGVmYXVsdCI7CgoJCQlsZXQgcmV0ID0gbnVsbFZhbHVlOwoJCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXQgPSBudWxsOwoKCQkJLy8gdG9vbF9Db25maWdzOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIGRvbmUKCQkJbGV0IHRjb25mID0gKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmIGMubm9kZSAmJiBjLm5vZGUuY29kZSA9PSBuSUQpLmNvbmNhdCgob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgIWMubm9kZSkpOwoJCQlpZiAodGNvbmYubGVuZ3RoKSB7CgkJCQlyZXQgPSB0Y29uZlswXS52YWx1ZTsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoamV4KSB7fQoJCQl9CgoJCQkvLyBtb2RlbCBDb25maWc6IENvbmZpZyBpcyBjbGFzcyBsZXZlbCwgbm9kZSBub3QgcG9zc2libGUgLSBwZW5kaW5nCgkJCWxldCBtY29uZiA9IHRoaXMuQ29uZmlnID8gdGhpcy5Db25maWdbbl0gOiB1bmRlZmluZWQ7CgkJCWlmICh0eXBlb2YobWNvbmYpICE9PSAidW5kZWZpbmVkIikgcmV0ID0gbWNvbmY7CgoJCQkvLyBjb21tYW5kIGxpbmU6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnICYmIGdsb2JhbC5taW5pbWlzdCkgewoJCQkJcmV0ID0gZ2xvYmFsLm1pbmltaXN0KHByb2Nlc3MuYXJndi5zbGljZSgyKSlbbl0gfHwgcmV0OwoJCQl9CgoJCQkvLyByZXF1ZXN0OiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJcmV0ID0gdGhpcy4kX1JFUVVFU1QobikgfHwgcmV0OwoKCQkJaWYgKG9wdGlvbnMubmV3VmFsdWUpIHsKCQkJCWxldCB0YyA9IHRjb25mLmxlbmd0aCA/IHRjb25mWzBdIDoge307CgkJCQl0Yy5ub2RlID0gewoJCQkJCWNvZGU6IG9wdGlvbnMubm9kZS5jb2RlKCkKCQkJCX07CgkJCQl0Yy52YWx1ZSA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCQl0Yy5uYW1lID0gbjsKCQkJCWlmICghdGNvbmYubGVuZ3RoKSB7CgkJCQkJb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncy5wdXNoKHRjKTsKCQkJCX0KCQkJCXJldCA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCX0KCgkJCS8vIGNvbmZpZyByZXBsYWNlbWVudAoJCQlpZiAodHlwZW9mKHJldCkgPT09ICdzdHJpbmcnKShyZXQubWF0Y2gobmV3IFJlZ0V4cChge3soW159XSspfX1gLCAiZyIpKSB8fCBbXSkuZm9yRWFjaChtID0+IHJldCA9IHJldC5yZXBsYWNlKG0sIHRoaXMuX19jb25maWcobS5yZXBsYWNlKCd7eycsICcnKS5yZXBsYWNlKCd9fScsICcnKSwgbnVsbCwgb3B0aW9ucykpKTsKCgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19jb25maWcnLCAnRW50aXR5T2JqZWN0JywgMSwgbiwgbnVsbFZhbHVlLCBvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLCBleCk7CgkJfQoJfQoKCS8qKgoJICogU3VtbWFyeS4gdGVzdFN5bmMuCgkgKgoJICogRGVzY3JpcHRpb24uIC4KCSAqCgkgKiBAc2luY2UgICAgICB4LngueAoJICogQGRlcHJlY2F0ZWQgeC54LnggVXNlIG5ld19mdW5jdGlvbl9uYW1lKCkgaW5zdGVhZC4KCSAqIEBhY2Nlc3MgICAgIHB1YmxpYwoJICoKCSAqIEBjbGFzcwoJICogQGF1Z21lbnRzIHBhcmVudAoJICogQG1peGVzICAgIG1peGluCgkgKgoJICogQGFsaWFzICAgIHJlYWxOYW1lCgkgKiBAbWVtYmVyb2YgbmFtZXNwYWNlCgkgKgoJICogQHNlZSAgRnVuY3Rpb24vY2xhc3MgcmVsaWVkIG9uCgkgKiBAbGluayBVUkwKCSAqIEBnbG9iYWwKCSAqCgkgKiBAZmlyZXMgICBldmVudE5hbWUKCSAqIEBmaXJlcyAgIGNsYXNzTmFtZSNldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGV2ZW50OmV2ZW50TmFtZQoJICogQGxpc3RlbnMgY2xhc3NOYW1lfmV2ZW50OmV2ZW50TmFtZQoJICogQHBhcmFtIHt0eXBlfSAgIHZhciAgICAgICAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcl0gICAgICAgICBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyPWRlZmF1bHRdIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlIHdpdGggZGVmYXVsdCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3RWYXIgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIG9iamVjdFZhci5rZXkgRGVzY3JpcHRpb24gb2YgYSBrZXkgaW4gdGhlIG9iamVjdFZhciBwYXJhbWV0ZXIuCgkgKgoJICogQHlpZWxkIHt0eXBlfSBZaWVsZGVkIHZhbHVlIGRlc2NyaXB0aW9uLgoJICoKCSAqIEByZXR1cm4ge3R5cGV9IFJldHVybiB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqLwoJYXN5bmMgdGVzdFN5bmMoKSB7CgoJCWxldCBhbnN3ZXIgPSBuZXcgc2FsZXNub3cuSW5jaWRlbnQoKTsKCgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidGVzdFN5bmMiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidGVzdFN5bmMiLCBfbm9kZSwgKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlLl9wYXJlbnQpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInRlc3RTeW5jIiwgKSA9PiB7CgoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuSW5jaWRlbnQudGVzdFN5bmMnKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3Rlc3RTeW5jJywgJ0VudGl0eU9iamVjdCcsIDAsIHsKCQkJCQkJW2tdOiBlcnJvcnNba10KCQkJCQl9KTsKCQkJCQlkZWxldGUgZXJyb3JzW2tdOwoJCQkJfSk7CgkJCQlpZiAoT2JqZWN0LnZhbHVlcyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJCXJldHVybiB7CgkJCQkJCV9fZXhjZXB0aW9uOiBlcnJvcnMsCgkJCQkJfTsKCQkJCX0KCQkJCXJldHVybjsKCQkJfQoKCQkJbGV0IGluYyA9IGF3YWl0IG5ldyBvU2NvcGUuSW5jaWRlbnQoKS5udW1iZXIoIklOQzEyMzQiKS50aXRsZSgiVGVzdGluZyIpLmdyb3VwKG5ldyBvU2NvcGUuR3JvdXAoKS5uYW1lKCJHcm91cDEiKSkuc3RhdGUobmV3IG9TY29wZS5TdGF0ZSgpLm5hbWUoIkFzc2lnbmVkIikpLnByaW9yaXR5KG5ldyBvU2NvcGUuUHJpb3JpdHkoKS5uYW1lKCJIaWdoIikuY29kZSgiUDEiKSkuY2FsbGVyKG5ldyBvU2NvcGUuVXNlcigpLnVzZXJuYW1lKCJmYWRpIikubmFtZSgiRmFkaSIpKS5zdG9yZSgpOwoJCQlpbmMuVG9vbCA9ICJNb25nb0RCIjsKCQkJcmV0dXJuIGF3YWl0IGluYy5zdG9yZSgpOwoKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdLAoJCX0pOwoKCQkvLyB0YWtlIG91dCB0aGUgaW52YWxpZCBub2RlIHJlc3VsdHMKCQlyZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByICYmIHIucmV0KTsKCgkJLy8gaGFzIGFueSBub2RlIGdlbmVyYXRlZCBhIHZhbGlkYXRpb24gZXhjZXB0aW9uPwoJCWxldCBfX2V4ID0gcmVzdWx0cy5maW5kKHIgPT4gci5yZXQuX19leGNlcHRpb24pOwoJCWlmIChfX2V4KSByZXR1cm4gX19leC5yZXQ7CgoJCXJldHVybiByZXN1bHRzLmxlbmd0aCA/IHJlc3VsdHNbMF0ucmV0IDogbnVsbDsKCgl9CgoJLyoqCgkgKiBTdW1tYXJ5LiBpblByb2dyZXNzLgoJICoKCSAqIERlc2NyaXB0aW9uLiAuCgkgKgoJICogQHNpbmNlICAgICAgeC54LngKCSAqIEBkZXByZWNhdGVkIHgueC54IFVzZSBuZXdfZnVuY3Rpb25fbmFtZSgpIGluc3RlYWQuCgkgKiBAYWNjZXNzICAgICBwdWJsaWMKCSAqCgkgKiBAY2xhc3MKCSAqIEBhdWdtZW50cyBwYXJlbnQKCSAqIEBtaXhlcyAgICBtaXhpbgoJICoKCSAqIEBhbGlhcyAgICByZWFsTmFtZQoJICogQG1lbWJlcm9mIG5hbWVzcGFjZQoJICoKCSAqIEBzZWUgIEZ1bmN0aW9uL2NsYXNzIHJlbGllZCBvbgoJICogQGxpbmsgVVJMCgkgKiBAZ2xvYmFsCgkgKgoJICogQGZpcmVzICAgZXZlbnROYW1lCgkgKiBAZmlyZXMgICBjbGFzc05hbWUjZXZlbnROYW1lCgkgKiBAbGlzdGVucyBldmVudDpldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGNsYXNzTmFtZX5ldmVudDpldmVudE5hbWUKCSAqIEBwYXJhbSB7dHlwZX0gICB2YXIgICAgICAgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXJdICAgICAgICAgRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUuCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcj1kZWZhdWx0XSBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZSB3aXRoIGRlZmF1bHQgdmFyaWFibGUuCgkgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0VmFyICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBvYmplY3RWYXIua2V5IERlc2NyaXB0aW9uIG9mIGEga2V5IGluIHRoZSBvYmplY3RWYXIgcGFyYW1ldGVyLgoJICoKCSAqIEB5aWVsZCB7dHlwZX0gWWllbGRlZCB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqCgkgKiBAcmV0dXJuIHt0eXBlfSBSZXR1cm4gdmFsdWUgZGVzY3JpcHRpb24uCgkgKi8KCWFzeW5jIGluUHJvZ3Jlc3MocmVhc29uKSB7CgoJCWxldCBhbnN3ZXIgPSBmYWxzZTsKCgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5Qcm9ncmVzcyIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpblByb2dyZXNzIiwgX25vZGUsIHJlYXNvbikgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpblByb2dyZXNzIiwgcmVhc29uKSA9PiB7CgoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuSW5jaWRlbnQuaW5Qcm9ncmVzcycpOwoKCQkJdmFyIGVycm9ycyA9IHsKCgkJCX07CgkJCU9iamVjdC5rZXlzKGVycm9ycykuZmlsdGVyKGsgPT4gIWVycm9yc1trXSkuZm9yRWFjaChrID0+IGRlbGV0ZSBlcnJvcnNba10pOwoJCQlpZiAoT2JqZWN0LmtleXMoZXJyb3JzKS5sZW5ndGgpIHsKCQkJCU9iamVjdC5rZXlzKGVycm9ycykuZmlsdGVyKGsgPT4gay5zdGFydHNXaXRoKCctJykpLmZvckVhY2goayA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnaW5Qcm9ncmVzcycsICdFbnRpdHlPYmplY3QnLCAwLCB7CgkJCQkJCVtrXTogZXJyb3JzW2tdCgkJCQkJfSk7CgkJCQkJZGVsZXRlIGVycm9yc1trXTsKCQkJCX0pOwoJCQkJaWYgKE9iamVjdC52YWx1ZXMoZXJyb3JzKS5sZW5ndGgpIHsKCQkJCQlyZXR1cm4gewoJCQkJCQlfX2V4Y2VwdGlvbjogZXJyb3JzLAoJCQkJCX07CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXSwKCQkJcmVhc29uOiByZWFzb24KCQl9KTsKCgkJLy8gdGFrZSBvdXQgdGhlIGludmFsaWQgbm9kZSByZXN1bHRzCgkJcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gciAmJiByLnJldCk7CgoJCS8vIGhhcyBhbnkgbm9kZSBnZW5lcmF0ZWQgYSB2YWxpZGF0aW9uIGV4Y2VwdGlvbj8KCQlsZXQgX19leCA9IHJlc3VsdHMuZmluZChyID0+IHIucmV0Ll9fZXhjZXB0aW9uKTsKCQlpZiAoX19leCkgcmV0dXJuIF9fZXgucmV0OwoKCQlyZXR1cm4gcmVzdWx0cy5sZW5ndGggPyByZXN1bHRzWzBdLnJldCA6IG51bGw7CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbnVtYmVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3RpdGxlJywgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSE9PSJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSE9PSJ1bmRlZmluZWQiKT90aGlzLl9hdG9iOih0eXBlb2YoX0ZyRU1EKSE9PSJ1bmRlZmluZWQiP19GckVNRC5fYXRvYjphdG9iKSkoYGV5SlRaWEoyYVdObFRtOTNJam9pYzJodmNuUmZaR1Z6WTNKcGNIUnBiMjRpZlE9PWApLCAoa2V5LHZhbHVlKT0+e2lmKHR5cGVvZih2YWx1ZSk9PT0ic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpPjApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsgcmV0dXJuIHZhbHVlO30pKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2Rlc2NyaXB0aW9uJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3N5bXB0b20nLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgYAoJCX07CgkJcmV0LnNxbCArPSAnLypJbmNpZGVudCovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJudW1iZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbnVtYmVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ251bWJlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJ0aXRsZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0aXRsZScsIEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlRaWEoyYVdObFRtOTNJam9pYzJodmNuUmZaR1Z6WTNKcGNIUnBiMjRpZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCQlyZXR1cm4gdmFsdWU7CgkJCX0pKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3RpdGxlJywgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSE9PSJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSE9PSJ1bmRlZmluZWQiKT90aGlzLl9hdG9iOih0eXBlb2YoX0ZyRU1EKSE9PSJ1bmRlZmluZWQiP19GckVNRC5fYXRvYjphdG9iKSkoYGV5SlRaWEoyYVdObFRtOTNJam9pYzJodmNuUmZaR1Z6WTNKcGNIUnBiMjRpZlE9PWApLCAoa2V5LHZhbHVlKT0+e2lmKHR5cGVvZih2YWx1ZSk9PT0ic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpPjApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsgcmV0dXJuIHZhbHVlO30pKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRlc2NyaXB0aW9uIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2Rlc2NyaXB0aW9uJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2Rlc2NyaXB0aW9uJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImxvY2F0aW9uIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJncm91cCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkic3RhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJInN5bXB0b20iOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJjbG9zZV9yZWFzb24iOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkicHJpb3JpdHkiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJImNhbGxlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJjb250YWN0IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypJbmNpZGVudCovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJudW1iZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm51bWJlcih0YWJsZVsibnVtYmVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInRpdGxlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy50aXRsZSh0YWJsZVsidGl0bGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGVzY3JpcHRpb24iKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRlc2NyaXB0aW9uKHRhYmxlWyJkZXNjcmlwdGlvbiJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJsb2NhdGlvbiIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubG9jYXRpb24odGFibGVbImxvY2F0aW9uIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImdyb3VwIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5ncm91cCh0YWJsZVsiZ3JvdXAiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigic3RhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnN0YXRlKHRhYmxlWyJzdGF0ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJzeW1wdG9tIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5zeW1wdG9tKHRhYmxlWyJzeW1wdG9tIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNsb3NlX3JlYXNvbiIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY2xvc2VfcmVhc29uKHRhYmxlWyJjbG9zZV9yZWFzb24iXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicHJpb3JpdHkiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnByaW9yaXR5KHRhYmxlWyJwcmlvcml0eSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjYWxsZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNhbGxlcih0YWJsZVsiY2FsbGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvbnRhY3QiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvbnRhY3QodGFibGVbImNvbnRhY3QiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5hY3RpdmUodGFibGVbImFjdGl2ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5lbmFibGVkKHRhYmxlWyJlbmFibGVkIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvZGUodGFibGVbImNvZGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9yZGVyKHRhYmxlWyJvcmRlciJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5kYXRlKHRhYmxlWyJkYXRlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm5hbWUodGFibGVbIm5hbWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5yZW1hcmsodGFibGVbInJlbWFyayJdKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIF9zcWwoc3FsLCBzb3VyY2UgPSB0aGlzKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWwoc3FsLCB0aGlzKTsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgoJCQkJCS8vIGlmKHRoaXNbJ18nK2ZpZWxkKydfc2V0J10gJiYgKHR5cGVvZih0aGlzWydfJytmaWVsZF0pPT09J3VuZGVmaW5lZCcgfHwgdGhpc1snXycrZmllbGRdPT1udWxsKSkgcmV0dXJuOwoJCQkJCS8vIGlmKHR5cGVvZihlYU9iaik9PT0ndW5kZWZpbmVkJykgcmV0dXJuOyAvLyB3aHk/CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlyZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoIm51bWJlciIsIG9iaiwgdGhpcy5udW1iZXIoKSk7CgoJCV9vcHRpb25zKCJ0aXRsZSIsIG9iaiwgdGhpcy50aXRsZSgpKTsKCgkJX29wdGlvbnMoImRlc2NyaXB0aW9uIiwgb2JqLCB0aGlzLmRlc2NyaXB0aW9uKCkpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjc0MDc5MzQ3LWNkYzItNGUwZS04ZGQyLWM5MWU1YzM4ZDAwZCIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnQgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlpZiAoIXRoaXMubG9jYXRpb24oKSB8fCAodGhpcy5sb2NhdGlvbigpCgoJCQkJJiYKCQkJCSF0aGlzLmxvY2F0aW9uKCkubG9jYXRpb25fSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJsb2NhdGlvbiIsIG9iaiwgdGhpcy5sb2NhdGlvbigpKTsKCQl9CgoJCWlmICghdGhpcy5ncm91cCgpIHx8ICh0aGlzLmdyb3VwKCkKCgkJCQkmJgoJCQkJIXRoaXMuZ3JvdXAoKS5ncm91cF9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuZ3JvdXAoKS5ncm91cF9Hcm91cF9NZW1iZXJzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJncm91cCIsIG9iaiwgdGhpcy5ncm91cCgpKTsKCQl9CgoJCWlmICghdGhpcy5zdGF0ZSgpIHx8ICh0aGlzLnN0YXRlKCkKCgkJCQkmJgoJCQkJIXRoaXMuc3RhdGUoKS5zdGF0ZV9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoInN0YXRlIiwgb2JqLCB0aGlzLnN0YXRlKCkpOwoJCX0KCgkJaWYgKCF0aGlzLnN5bXB0b20oKSB8fCAodGhpcy5zeW1wdG9tKCkKCgkJCQkmJgoJCQkJIXRoaXMuc3ltcHRvbSgpLnN5bXB0b21fSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJzeW1wdG9tIiwgb2JqLCB0aGlzLnN5bXB0b20oKSk7CgkJfQoKCQlpZiAoIXRoaXMuY2xvc2VfcmVhc29uKCkgfHwgKHRoaXMuY2xvc2VfcmVhc29uKCkKCgkJCQkmJgoJCQkJIXRoaXMuY2xvc2VfcmVhc29uKCkuY2xvc2VfcmVhc29uX0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygiY2xvc2VfcmVhc29uIiwgb2JqLCB0aGlzLmNsb3NlX3JlYXNvbigpKTsKCQl9CgoJCWlmICghdGhpcy5wcmlvcml0eSgpIHx8ICh0aGlzLnByaW9yaXR5KCkKCgkJCQkmJgoJCQkJIXRoaXMucHJpb3JpdHkoKS5wcmlvcml0eV9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoInByaW9yaXR5Iiwgb2JqLCB0aGlzLnByaW9yaXR5KCkpOwoJCX0KCgkJaWYgKCF0aGlzLmNhbGxlcigpIHx8ICh0aGlzLmNhbGxlcigpCgoJCQkJJiYKCQkJCSF0aGlzLmNhbGxlcigpLm1hbmFnZXJfRGVwYXJ0bWVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuY2FsbGVyKCkuY2FsbGVyX0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jYWxsZXIoKS5jb250YWN0X0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jYWxsZXIoKS51c2VyX0dyb3VwX01lbWJlcnMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoImNhbGxlciIsIG9iaiwgdGhpcy5jYWxsZXIoKSk7CgkJfQoKCQlpZiAoIXRoaXMuY29udGFjdCgpIHx8ICh0aGlzLmNvbnRhY3QoKQoKCQkJCSYmCgkJCQkhdGhpcy5jb250YWN0KCkubWFuYWdlcl9EZXBhcnRtZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jb250YWN0KCkuY2FsbGVyX0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jb250YWN0KCkuY29udGFjdF9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuY29udGFjdCgpLnVzZXJfR3JvdXBfTWVtYmVycygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygiY29udGFjdCIsIG9iaiwgdGhpcy5jb250YWN0KCkpOwoJCX0KCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnbnVtYmVyJywgJ3RpdGxlJywgJ2Rlc2NyaXB0aW9uJywgJ2xvY2F0aW9uJywgJ2dyb3VwJywgJ3N0YXRlJywgJ3N5bXB0b20nLCAnY2xvc2VfcmVhc29uJywgJ3ByaW9yaXR5JywgJ2NhbGxlcicsICdjb250YWN0JywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWycnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIkluY2lkZW50IiAmJiAobS50YXJnZXQgfHwgbS5vdXRTY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkgJiYgKCFtLnNvdXJjZSB8fCAobS5zb3VyY2UgJiYgLyohbS5vdXRTY3JpcHQgJiYqLyB0aGlzWydfJyArIG0uc291cmNlICsgJ19zZXQnXSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0ub3V0U2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5vdXRTY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5vdXRTY3JpcHR9KX1gKSh0aGlzLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS5zb3VyY2UpIHsKCQkJCWlmIChtLnNvdXJjZS5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMpID0+IHtyZXR1cm4gX3RoaXMuJHttLnNvdXJjZX07fWApKHRoaXMpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS5zb3VyY2UsIHRoaXMpOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnRhcmdldCkgb2JqW20udGFyZ2V0XSA9IHJldDsKCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJW20udGFyZ2V0IHx8IG0uc291cmNlXTogdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddCgkJCX0pOwoJCX0pOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCS8vIHVzZSB0aGlzLl9tYXAoKSB3aXRoIHJldmVyc2UKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoIm51bWJlciIsIG9iaik7CgoJCV9vcHRpb25zKCJ0aXRsZSIsIG9iaik7CgoJCV9vcHRpb25zKCJkZXNjcmlwdGlvbiIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjc0MDc5MzQ3LWNkYzItNGUwZS04ZGQyLWM5MWU1YzM4ZDAwZCIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnQgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJsb2NhdGlvbiIsIG9iaik7CgoJCV9vcHRpb25zKCJncm91cCIsIG9iaik7CgoJCV9vcHRpb25zKCJzdGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJzeW1wdG9tIiwgb2JqKTsKCgkJX29wdGlvbnMoImNsb3NlX3JlYXNvbiIsIG9iaik7CgoJCV9vcHRpb25zKCJwcmlvcml0eSIsIG9iaik7CgoJCV9vcHRpb25zKCJjYWxsZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiY29udGFjdCIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ251bWJlcicsICd0aXRsZScsICdkZXNjcmlwdGlvbicsICdsb2NhdGlvbicsICdncm91cCcsICdzdGF0ZScsICdzeW1wdG9tJywgJ2Nsb3NlX3JlYXNvbicsICdwcmlvcml0eScsICdjYWxsZXInLCAnY29udGFjdCcsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJJbmNpZGVudCIgJiYgKG0uc291cmNlIHx8IG0uaW5TY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5pblNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmosIG9TY29wZSwgbWFwKSA9PiB7JHttLmluU2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20uaW5TY3JpcHR9KX1gKShvYmosIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnRhcmdldCkgewoJCQkJaWYgKG0udGFyZ2V0LmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmopID0+IHtyZXR1cm4gb2JqLiR7bS50YXJnZXR9O31gKShvYmopOwoJCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqW20udGFyZ2V0XSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0udGFyZ2V0LCBvYmopOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0uc291cmNlKSB7CgkJCQlpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXRoaXNbbS5zb3VyY2VdKHJldCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXNbbS5zb3VyY2VdID0gcmV0OwoJCQkJfQoJCQl9CgkJfSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RCT2JqZWN0KGZpZWxkcywgYk5vUmVmKSB7CgkJaWYgKCF0aGlzLklkKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJJbnZhbGlkIElEIiwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lLCB0aGlzLlRvb2wpOwoJCX0KCQlsZXQgcmV0ID0gewoJCQlbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ106ICInIiArIHRoaXMuSWQgKyAiJyIKCQl9OwoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm51bWJlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9udW1iZXJfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMubnVtYmVyKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdudW1iZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJ0aXRsZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl90aXRsZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy50aXRsZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgndGl0bGUnLCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpUWlhKMmFXTmxUbTkzSWpvaWMyaHZjblJmWkdWelkzSnBjSFJwYjI0aWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQkJcmV0dXJuIHZhbHVlOwoJCQl9KSkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRlc2NyaXB0aW9uIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2Rlc2NyaXB0aW9uX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmRlc2NyaXB0aW9uKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdkZXNjcmlwdGlvbicsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImxvY2F0aW9uIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2xvY2F0aW9uX3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5sb2NhdGlvbigpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImdyb3VwIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2dyb3VwX3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5ncm91cCgpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInN0YXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3N0YXRlX3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5zdGF0ZSgpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInN5bXB0b20iKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fc3ltcHRvbV9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuc3ltcHRvbSgpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY2xvc2VfcmVhc29uIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY2xvc2VfcmVhc29uKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInByaW9yaXR5IikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3ByaW9yaXR5X3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5wcmlvcml0eSgpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNhbGxlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9jYWxsZXJfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNhbGxlcigpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKSArICJpZCJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb250YWN0IikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvbnRhY3Rfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNvbnRhY3QoKTsKCgkJCWlmICh2ICYmICh2Ll9fc3luY19vbigpIHx8IHYuSWQgPT0gdi5JZCkpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYuSWQgKyAiJyI7CgkJCX0gZWxzZSB7CgkJCQlmVmFsdWUgPSAwOwoJCQl9CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9hY3RpdmVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYWN0aXZlKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZW5hYmxlZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5lbmFibGVkKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvZGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29kZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2RhdGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZGF0ZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5uYW1lKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3JlbWFya19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5yZW1hcmsoKTsKCgkJCWZWYWx1ZSA9ICInIiArICgodiAmJiB2LnJlcGxhY2UpID8gdi5yZXBsYWNlKC9cJy9nLCAiXCdcJyIpIDogdikgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX1EoKSB7CgkJbGV0IF9vID0gJyInOwoJCWxldCBfcSA9IF9vOwoKCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXRoaXMuX19RID0gdGhpcy5fX1EgPT0gX28gPyBfcSA6IF9vOwoJCXJldHVybiB0aGlzLl9fUTsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcsIHRoaXMuX25Db2RlKCdudW1iZXInLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgndGl0bGUnLCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpUWlhKMmFXTmxUbTkzSWpvaWMyaHZjblJmWkdWelkzSnBjSFJwYjI0aWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KSksIHRoaXMuX25Db2RlKCdkZXNjcmlwdGlvbicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdsb2NhdGlvbicsIHVuZGVmaW5lZCkgKyAiLmlkIiwgdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uJywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdjb250YWN0JywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKV07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm51bWJlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ251bWJlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnRpdGxlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgndGl0bGUnLCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShgZXlKVFpYSjJhV05sVG05M0lqb2ljMmh2Y25SZlpHVnpZM0pwY0hScGIyNGlmUT09YCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSkpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kZXNjcmlwdGlvbikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2Rlc2NyaXB0aW9uJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubG9jYXRpb24pIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdsb2NhdGlvbicsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZ3JvdXApIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuc3RhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuc3ltcHRvbSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ3N5bXB0b20nLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNsb3NlX3JlYXNvbikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMucHJpb3JpdHkpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY2FsbGVyKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb250YWN0KSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX1gKTsKCgkJfQoJCXJldHVybiBmaWVsZHM7Cgl9CgoJX2Zyb21EQk9iamVjdChyID0ge30pIHsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5fX2ltcG9ydChyLCB7CgkJCQlJZDogb2JqID0+IHRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ10sCgoJCQkJbnVtYmVyOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbnVtYmVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMubnVtYmVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJdGl0bGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0aXRsZScsIEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlRaWEoyYVdObFRtOTNJam9pYzJodmNuUmZaR1Z6WTNKcGNIUnBiMjRpZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQkJCXJldHVybiB2YWx1ZTsKCQkJCX0pKSkgPT4gewoJCQkJCXRoaXMudGl0bGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkZXNjcmlwdGlvbjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2Rlc2NyaXB0aW9uJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZGVzY3JpcHRpb24ob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlsb2NhdGlvbjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMubG9jYXRpb24ob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlncm91cDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZ3JvdXAob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlzdGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N0YXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuc3RhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlzeW1wdG9tOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnN5bXB0b20ob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljbG9zZV9yZWFzb246IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jbG9zZV9yZWFzb24ob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlwcmlvcml0eTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3ByaW9yaXR5JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucHJpb3JpdHkob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljYWxsZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jYWxsZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb250YWN0OiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvbnRhY3Qob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU51bGw6IHRydWUsCgoJCQlsb2NhdGlvbjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKSkgPT4gb2JqW2VhQ29kZV0gPSBuZXcgc2FsZXNub3cuTG9jYXRpb24oKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJCWdyb3VwOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Hcm91cCgpLl90b1NlbGVjdEhlYWRlcigpLAoKCQkJc3RhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LlN0YXRlKCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQlzeW1wdG9tOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LlN5bXB0b20oKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJCWNsb3NlX3JlYXNvbjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LlJlYXNvbigpLl90b1NlbGVjdEhlYWRlcigpLAoKCQkJcHJpb3JpdHk6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LlByaW9yaXR5KCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQljYWxsZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQljb250YWN0OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJfSwgIl90b1NlbGVjdEhlYWRlciIpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RIZWFkZXInLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9TZWxlY3RTUUwoZmllbGRzKSB7CgkJbGV0IHNxbCA9ICJzZWxlY3QgIjsKCgkJbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX1gOwoKCQlsZXQgaGVhZGVyID0gdGhpcy5fdG9TZWxlY3RIZWFkZXIoZmllbGRzKTsKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5udW1iZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm51bWJlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbnVtYmVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnRpdGxlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy50aXRsZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndGl0bGUnLCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShgZXlKVFpYSjJhV05sVG05M0lqb2ljMmh2Y25SZlpHVnpZM0pwY0hScGIyNGlmUT09YCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSkpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGVzY3JpcHRpb24pIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRlc2NyaXB0aW9ufSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkZXNjcmlwdGlvbicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5sb2NhdGlvbikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubG9jYXRpb259KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmdyb3VwKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5ncm91cH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuc3RhdGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnN0YXRlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5zeW1wdG9tKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5zeW1wdG9tfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNsb3NlX3JlYXNvbikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY2xvc2VfcmVhc29ufSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMucHJpb3JpdHkpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnByaW9yaXR5fSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jYWxsZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNhbGxlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvbnRhY3QpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvbnRhY3R9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJbnVtYmVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbnVtYmVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9udW1iZXJfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9udW1iZXJfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX251bWJlcl9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbnVtYmVyX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fbnVtYmVyX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9udW1iZXJfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXRpdGxlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndGl0bGUnLCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpUWlhKMmFXTmxUbTkzSWpvaWMyaHZjblJmWkdWelkzSnBjSFJwYjI0aWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQkJcmV0dXJuIHZhbHVlOwoJCQl9KSkpID0+IHsKCQkJCWlmICghdGhpcy5fdGl0bGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl90aXRsZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fdGl0bGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX3RpdGxlX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fdGl0bGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX3RpdGxlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkZXNjcmlwdGlvbjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2Rlc2NyaXB0aW9uJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9kZXNjcmlwdGlvbl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2Rlc2NyaXB0aW9uX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9kZXNjcmlwdGlvbl9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fZGVzY3JpcHRpb25fY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9kZXNjcmlwdGlvbl9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fZGVzY3JpcHRpb25fY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWxvY2F0aW9uOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2xvY2F0aW9uX3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fbG9jYXRpb25fY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlncm91cDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9ncm91cF9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX2dyb3VwX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJc3RhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fc3RhdGVfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9zdGF0ZV9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXN5bXB0b206IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9zeW1wdG9tX3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fc3ltcHRvbV9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNsb3NlX3JlYXNvbjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY2xvc2VfcmVhc29uX3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fY2xvc2VfcmVhc29uX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJcHJpb3JpdHk6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcHJpb3JpdHlfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9wcmlvcml0eV9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNhbGxlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY2FsbGVyX3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fY2FsbGVyX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY29udGFjdDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvbnRhY3Rfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9jb250YWN0X2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jb2RlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fb3JkZXJfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vcmRlcl9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9kYXRlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LnRvSVNPU3RyaW5nKSB7CgkJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3FsaXRlJykgewoJCQkJCQlvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbmFtZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX25hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3JlbWFya19zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvU2VsZWN0U1FMIiwgZmllbGRzKS5zcWw7CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJaWYgKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5udW1iZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbnVtYmVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMubnVtYmVyfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnRpdGxlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3RpdGxlJywgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSE9PSJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSE9PSJ1bmRlZmluZWQiKT90aGlzLl9hdG9iOih0eXBlb2YoX0ZyRU1EKSE9PSJ1bmRlZmluZWQiP19GckVNRC5fYXRvYjphdG9iKSkoYGV5SlRaWEoyYVdObFRtOTNJam9pYzJodmNuUmZaR1Z6WTNKcGNIUnBiMjRpZlE9PWApLCAoa2V5LHZhbHVlKT0+e2lmKHR5cGVvZih2YWx1ZSk9PT0ic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpPjApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsgcmV0dXJuIHZhbHVlO30pKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMudGl0bGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGVzY3JpcHRpb24pIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGVzY3JpcHRpb24nLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kZXNjcmlwdGlvbn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5sb2NhdGlvbikgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdsb2NhdGlvbicsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMubG9jYXRpb259YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZ3JvdXApIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmdyb3VwfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnN0YXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3N0YXRlJywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5zdGF0ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5zeW1wdG9tKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3N5bXB0b20nLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnN5bXB0b219YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY2xvc2VfcmVhc29uKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuY2xvc2VfcmVhc29ufWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnByaW9yaXR5KSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3ByaW9yaXR5JywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5wcmlvcml0eX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jYWxsZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jYWxsZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29udGFjdCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb250YWN0JywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jb250YWN0fWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jb2RlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMub3JkZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZGF0ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5uYW1lfWA7CgoJCX0KCgkJaWYgKHNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpIHsKCQkJLy8gc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSIsICJ3aGVyZSAxPTAiKTsKCQl9IGVsc2UgewoJCQlzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7CgkJfQoKCQlzcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCkgOiBzcWw7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgoJCXJldHVybiBzcWw7Cgl9CgoJX3RvUGF0aHMoKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJX1RISVM6IG9iaiA9PiB7fSwKCgkJCWxvY2F0aW9uOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpKSA9PiBvYmoubG9jYXRpb24gPSB2Ll90b1BhdGhzKCksCgoJCQlncm91cDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gb2JqLmdyb3VwID0gdi5fdG9QYXRocygpLAoKCQkJc3RhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCkpID0+IG9iai5zdGF0ZSA9IHYuX3RvUGF0aHMoKSwKCgkJCXN5bXB0b206IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSkgPT4gb2JqLnN5bXB0b20gPSB2Ll90b1BhdGhzKCksCgoJCQljbG9zZV9yZWFzb246IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpKSA9PiBvYmouY2xvc2VfcmVhc29uID0gdi5fdG9QYXRocygpLAoKCQkJcHJpb3JpdHk6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCkpID0+IG9iai5wcmlvcml0eSA9IHYuX3RvUGF0aHMoKSwKCgkJCWNhbGxlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCkpID0+IG9iai5jYWxsZXIgPSB2Ll90b1BhdGhzKCksCgoJCQljb250YWN0OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkpID0+IG9iai5jb250YWN0ID0gdi5fdG9QYXRocygpLAoKCQl9LCAiX3RvUGF0aHMiKTsKCQkvLyByZXR1cm4gcmV0OwoJCXJldHVybiBPYmplY3Qua2V5cyhyZXQpLm1hcChrID0+ICh7CgkJCVtrXTogcmV0W2tdCgkJfSkpOwoJfQoKCV90b1VwZGF0ZVNRTChmaWVsZHMpIHsKCQlsZXQgcmV0RmllbGRzID0gdGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkuam9pbignLCAnKTsKCQlsZXQgc3FsID0gYHVwZGF0ZSAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IHNldCBgICsgT2JqZWN0LmVudHJpZXModGhpcy5fdG9EQk9iamVjdChmaWVsZHMpKS5tYXAodiA9PiB0aGlzLl9RKCkgKyB2WzBdICsgdGhpcy5fUSgpICsgIj0iICsgdlsxXSkgKyBgIHdoZXJlICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2A7IC8vYCByZXR1cm5pbmcgJHtyZXRGaWVsZHN9YDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9VcGRhdGVTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV90b0luc2VydFNRTChmaWVsZHMpIHsKCQlsZXQgb2JqID0gdGhpcy5fdG9EQk9iamVjdChmaWVsZHMpOwoJCWxldCBzcWwgPSBgaW5zZXJ0IGludG8gJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoYCArIE9iamVjdC5rZXlzKG9iaikubWFwKGsgPT4gdGhpcy5fUSgpICsgayArIHRoaXMuX1EoKSkgKyAiKSB2YWx1ZXMgKCIgKyBPYmplY3QudmFsdWVzKG9iaikgKyBgKWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvSW5zZXJ0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLkluY2lkZW50KSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLkluY2lkZW50ID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5JbmNpZGVudCgpCgoJCQkJCS5sb2NhdGlvbihuZXcgc2FsZXNub3cuTG9jYXRpb24oKSkKCgkJCQkJLmdyb3VwKG5ldyBzYWxlc25vdy5Hcm91cCgpKQoKCQkJCQkuc3RhdGUobmV3IHNhbGVzbm93LlN0YXRlKCkpCgoJCQkJCS5zeW1wdG9tKG5ldyBzYWxlc25vdy5TeW1wdG9tKCkpCgoJCQkJCS5jbG9zZV9yZWFzb24obmV3IHNhbGVzbm93LlJlYXNvbigpKQoKCQkJCQkucHJpb3JpdHkobmV3IHNhbGVzbm93LlByaW9yaXR5KCkpCgoJCQkJCS5jYWxsZXIobmV3IHNhbGVzbm93LlVzZXIoKSkKCgkJCQkJLmNvbnRhY3QobmV3IHNhbGVzbm93LlVzZXIoKSkKCgkJCQkJLl90b1NRTFRhYmxlKGRlcHRoKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIkluY2lkZW50IikgcmV0dXJuIGZhbHNlOwoKCQkJbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJCUZ1bGw6IHRydWUsCgkJCQlOdWxsOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5faWQgPSB0aGlzLklkID09IHF1ZXJ5LklkLAoKCQkJCW51bWJlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubnVtYmVyID0gdiA9PSBxdWVyeS5udW1iZXIoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbnVtYmVyX3NldCAmJiAhcXVlcnkuX251bWJlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubnVtYmVyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX251bWJlcl9zZXQgJiYgcXVlcnkuX251bWJlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm51bWJlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQl0aXRsZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoudGl0bGUgPSB2ID09IHF1ZXJ5LnRpdGxlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3RpdGxlX3NldCAmJiAhcXVlcnkuX3RpdGxlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai50aXRsZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl90aXRsZV9zZXQgJiYgcXVlcnkuX3RpdGxlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudGl0bGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGVzY3JpcHRpb246IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRlc2NyaXB0aW9uID0gdiA9PSBxdWVyeS5kZXNjcmlwdGlvbigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kZXNjcmlwdGlvbl9zZXQgJiYgIXF1ZXJ5Ll9kZXNjcmlwdGlvbl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGVzY3JpcHRpb24gPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGVzY3JpcHRpb25fc2V0ICYmIHF1ZXJ5Ll9kZXNjcmlwdGlvbl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRlc2NyaXB0aW9uID0gZmFsc2U7CgkJCQl9LAoKCQkJCWxvY2F0aW9uOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5sb2NhdGlvbiA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkubG9jYXRpb24oKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbG9jYXRpb25fc2V0ICYmICFxdWVyeS5fbG9jYXRpb25fc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmxvY2F0aW9uID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2xvY2F0aW9uX3NldCAmJiBxdWVyeS5fbG9jYXRpb25fc2V0KSB8fAoKCQkJCQkJKHRoaXMubG9jYXRpb24oKSAmJiAhdGhpcy5sb2NhdGlvbigpLl9tYXRjaGVzKHF1ZXJ5LmxvY2F0aW9uKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5sb2NhdGlvbiA9IGZhbHNlOwoJCQkJfSwKCgkJCQlncm91cDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZ3JvdXAgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5Lmdyb3VwKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2dyb3VwX3NldCAmJiAhcXVlcnkuX2dyb3VwX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5ncm91cCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9ncm91cF9zZXQgJiYgcXVlcnkuX2dyb3VwX3NldCkgfHwKCgkJCQkJCSh0aGlzLmdyb3VwKCkgJiYgIXRoaXMuZ3JvdXAoKS5fbWF0Y2hlcyhxdWVyeS5ncm91cCgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZ3JvdXAgPSBmYWxzZTsKCQkJCX0sCgoJCQkJc3RhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnN0YXRlID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5zdGF0ZSgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9zdGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9zdGF0ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouc3RhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fc3RhdGVfc2V0ICYmIHF1ZXJ5Ll9zdGF0ZV9zZXQpIHx8CgoJCQkJCQkodGhpcy5zdGF0ZSgpICYmICF0aGlzLnN0YXRlKCkuX21hdGNoZXMocXVlcnkuc3RhdGUoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnN0YXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCXN5bXB0b206IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnN5bXB0b20gPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LnN5bXB0b20oKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fc3ltcHRvbV9zZXQgJiYgIXF1ZXJ5Ll9zeW1wdG9tX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5zeW1wdG9tID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3N5bXB0b21fc2V0ICYmIHF1ZXJ5Ll9zeW1wdG9tX3NldCkgfHwKCgkJCQkJCSh0aGlzLnN5bXB0b20oKSAmJiAhdGhpcy5zeW1wdG9tKCkuX21hdGNoZXMocXVlcnkuc3ltcHRvbSgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouc3ltcHRvbSA9IGZhbHNlOwoJCQkJfSwKCgkJCQljbG9zZV9yZWFzb246IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNsb3NlX3JlYXNvbiA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkuY2xvc2VfcmVhc29uKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQgJiYgIXF1ZXJ5Ll9jbG9zZV9yZWFzb25fc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNsb3NlX3JlYXNvbiA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jbG9zZV9yZWFzb25fc2V0ICYmIHF1ZXJ5Ll9jbG9zZV9yZWFzb25fc2V0KSB8fAoKCQkJCQkJKHRoaXMuY2xvc2VfcmVhc29uKCkgJiYgIXRoaXMuY2xvc2VfcmVhc29uKCkuX21hdGNoZXMocXVlcnkuY2xvc2VfcmVhc29uKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jbG9zZV9yZWFzb24gPSBmYWxzZTsKCQkJCX0sCgoJCQkJcHJpb3JpdHk6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnByaW9yaXR5ID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5wcmlvcml0eSgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9wcmlvcml0eV9zZXQgJiYgIXF1ZXJ5Ll9wcmlvcml0eV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucHJpb3JpdHkgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcHJpb3JpdHlfc2V0ICYmIHF1ZXJ5Ll9wcmlvcml0eV9zZXQpIHx8CgoJCQkJCQkodGhpcy5wcmlvcml0eSgpICYmICF0aGlzLnByaW9yaXR5KCkuX21hdGNoZXMocXVlcnkucHJpb3JpdHkoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnByaW9yaXR5ID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNhbGxlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY2FsbGVyID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5jYWxsZXIoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY2FsbGVyX3NldCAmJiAhcXVlcnkuX2NhbGxlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY2FsbGVyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NhbGxlcl9zZXQgJiYgcXVlcnkuX2NhbGxlcl9zZXQpIHx8CgoJCQkJCQkodGhpcy5jYWxsZXIoKSAmJiAhdGhpcy5jYWxsZXIoKS5fbWF0Y2hlcyhxdWVyeS5jYWxsZXIoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNhbGxlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb250YWN0OiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb250YWN0ID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5jb250YWN0KCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvbnRhY3Rfc2V0ICYmICFxdWVyeS5fY29udGFjdF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29udGFjdCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb250YWN0X3NldCAmJiBxdWVyeS5fY29udGFjdF9zZXQpIHx8CgoJCQkJCQkodGhpcy5jb250YWN0KCkgJiYgIXRoaXMuY29udGFjdCgpLl9tYXRjaGVzKHF1ZXJ5LmNvbnRhY3QoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvbnRhY3QgPSBmYWxzZTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJbG9jYXRpb246IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBsb2NhdGlvbiIpOwoJCQkJCW9iai5sb2NhdGlvbiA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCWdyb3VwOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgZ3JvdXAiKTsKCQkJCQlvYmouZ3JvdXAgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQlzdGF0ZTogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIHN0YXRlIik7CgkJCQkJb2JqLnN0YXRlID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJc3ltcHRvbTogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIHN5bXB0b20iKTsKCQkJCQlvYmouc3ltcHRvbSA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCWNsb3NlX3JlYXNvbjogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIGNsb3NlX3JlYXNvbiIpOwoJCQkJCW9iai5jbG9zZV9yZWFzb24gPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQlwcmlvcml0eTogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIHByaW9yaXR5Iik7CgkJCQkJb2JqLnByaW9yaXR5ID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJY2FsbGVyOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgY2FsbGVyIik7CgkJCQkJb2JqLmNhbGxlciA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCWNvbnRhY3Q6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBjb250YWN0Iik7CgkJCQkJb2JqLmNvbnRhY3QgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl9udW1iZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fdGl0bGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGVzY3JpcHRpb25fc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbG9jYXRpb25fc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZ3JvdXBfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fc3RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fc3ltcHRvbV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jbG9zZV9yZWFzb25fc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcHJpb3JpdHlfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY2FsbGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvbnRhY3Rfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fYWN0aXZlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcmRlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9kYXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX25hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcmVtYXJrX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlsb2NhdGlvbjogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLmxvY2F0aW9uKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlncm91cDogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLmdyb3VwKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlzdGF0ZTogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLnN0YXRlKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlzeW1wdG9tOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMuc3ltcHRvbShyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJY2xvc2VfcmVhc29uOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMuY2xvc2VfcmVhc29uKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlwcmlvcml0eTogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLnByaW9yaXR5KHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQljYWxsZXI6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5jYWxsZXIocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCWNvbnRhY3Q6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5jb250YWN0KHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCW51bWJlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ251bWJlcicsIHVuZGVmaW5lZCkgOiAibnVtYmVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX251bWJlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubnVtYmVyKHJlZik7CgoJCQl9LAoKCQkJdGl0bGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0aXRsZScsIEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlRaWEoyYVdObFRtOTNJam9pYzJodmNuUmZaR1Z6WTNKcGNIUnBiMjRpZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCQlyZXR1cm4gdmFsdWU7CgkJCX0pKSA6ICJ0aXRsZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl90aXRsZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMudGl0bGUocmVmKTsKCgkJCX0sCgoJCQlkZXNjcmlwdGlvbjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2Rlc2NyaXB0aW9uJywgdW5kZWZpbmVkKSA6ICJkZXNjcmlwdGlvbiIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kZXNjcmlwdGlvbl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZGVzY3JpcHRpb24ocmVmKTsKCgkJCX0sCgoJCQlsb2NhdGlvbjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKSA6ICJsb2NhdGlvbiIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9sb2NhdGlvbl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5sb2NhdGlvbigpIHx8IG5ldyBzYWxlc25vdy5Mb2NhdGlvbigpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMubG9jYXRpb24ob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSBsb2NhdGlvbiIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJZ3JvdXA6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkgOiAiZ3JvdXAiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZ3JvdXBfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMuZ3JvdXAoKSB8fCBuZXcgc2FsZXNub3cuR3JvdXAoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLmdyb3VwKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgZ3JvdXAiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCXN0YXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpIDogInN0YXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3N0YXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLnN0YXRlKCkgfHwgbmV3IHNhbGVzbm93LlN0YXRlKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5zdGF0ZShvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIHN0YXRlIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQlzeW1wdG9tOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCkgOiAic3ltcHRvbSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9zeW1wdG9tX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLnN5bXB0b20oKSB8fCBuZXcgc2FsZXNub3cuU3ltcHRvbSgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuc3ltcHRvbShvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIHN5bXB0b20iLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCWNsb3NlX3JlYXNvbjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCkgOiAiY2xvc2VfcmVhc29uIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2Nsb3NlX3JlYXNvbl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5jbG9zZV9yZWFzb24oKSB8fCBuZXcgc2FsZXNub3cuUmVhc29uKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5jbG9zZV9yZWFzb24ob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSBjbG9zZV9yZWFzb24iLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCXByaW9yaXR5OiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpIDogInByaW9yaXR5IikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3ByaW9yaXR5X2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLnByaW9yaXR5KCkgfHwgbmV3IHNhbGVzbm93LlByaW9yaXR5KCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5wcmlvcml0eShvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIHByaW9yaXR5Iiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQljYWxsZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpIDogImNhbGxlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jYWxsZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMuY2FsbGVyKCkgfHwgbmV3IHNhbGVzbm93LlVzZXIoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLmNhbGxlcihvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIGNhbGxlciIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJY29udGFjdDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpIDogImNvbnRhY3QiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29udGFjdF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5jb250YWN0KCkgfHwgbmV3IHNhbGVzbm93LlVzZXIoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLmNvbnRhY3Qob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSBjb250YWN0Iiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb2RlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jb2RlKHJlZik7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3JkZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9yZGVyKHJlZik7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLmRhdGUocmVmKTsKCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9uYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5uYW1lKHJlZik7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVtYXJrX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5yZW1hcmsocmVmKTsKCgkJCX0sCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddID0gdiwKCgkJCSJudW1iZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbnVtYmVyJywgdW5kZWZpbmVkKSA6ICJudW1iZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbnVtYmVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9udW1iZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJ0aXRsZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0aXRsZScsIEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlRaWEoyYVdObFRtOTNJam9pYzJodmNuUmZaR1Z6WTNKcGNIUnBiMjRpZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCQlyZXR1cm4gdmFsdWU7CgkJCX0pKSA6ICJ0aXRsZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl90aXRsZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fdGl0bGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkZXNjcmlwdGlvbiI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkZXNjcmlwdGlvbicsIHVuZGVmaW5lZCkgOiAiZGVzY3JpcHRpb24iKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZGVzY3JpcHRpb25fY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2Rlc2NyaXB0aW9uX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibG9jYXRpb24iOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpIDogImxvY2F0aW9uIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fbG9jYXRpb25fY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2xvY2F0aW9uX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZ3JvdXAiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpIDogImdyb3VwIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fZ3JvdXBfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2dyb3VwX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkic3RhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpIDogInN0YXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fc3RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3N0YXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkic3ltcHRvbSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSA6ICJzeW1wdG9tIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fc3ltcHRvbV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fc3ltcHRvbV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNsb3NlX3JlYXNvbiI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpIDogImNsb3NlX3JlYXNvbiIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX2Nsb3NlX3JlYXNvbl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY2xvc2VfcmVhc29uX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicHJpb3JpdHkiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpIDogInByaW9yaXR5IikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fcHJpb3JpdHlfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3ByaW9yaXR5X2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY2FsbGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCkgOiAiY2FsbGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fY2FsbGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jYWxsZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb250YWN0IjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpIDogImNvbnRhY3QiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl9jb250YWN0X2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb250YWN0X2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3JkZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGw7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIG9ialtlYUNvZGVdID0gb2JqW2VhQ29kZV0ucmVwbGFjZSgvXC5bMC05XSpaL2csICcnKTsKCgkJCQlpZiAodGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGF0ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9uYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9uYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3JlbWFya19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCglieUxvY2F0aW9uKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9sb2NhdGlvbiJdICYmIChhWyJfbG9jYXRpb24iXS5FcXVhbHMgPyBhWyJfbG9jYXRpb24iXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX2xvY2F0aW9uIl0sIHIpKSkgewoJCQkJCXIuX2xvY2F0aW9uX0luY2lkZW50cy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5R3JvdXAoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX2dyb3VwIl0gJiYgKGFbIl9ncm91cCJdLkVxdWFscyA/IGFbIl9ncm91cCJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfZ3JvdXAiXSwgcikpKSB7CgkJCQkJci5fZ3JvdXBfSW5jaWRlbnRzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlTdGF0ZShhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfc3RhdGUiXSAmJiAoYVsiX3N0YXRlIl0uRXF1YWxzID8gYVsiX3N0YXRlIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9zdGF0ZSJdLCByKSkpIHsKCQkJCQlyLl9zdGF0ZV9JbmNpZGVudHMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglieVN5bXB0b20oYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX3N5bXB0b20iXSAmJiAoYVsiX3N5bXB0b20iXS5FcXVhbHMgPyBhWyJfc3ltcHRvbSJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfc3ltcHRvbSJdLCByKSkpIHsKCQkJCQlyLl9zeW1wdG9tX0luY2lkZW50cy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5UmVhc29uKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9jbG9zZV9yZWFzb24iXSAmJiAoYVsiX2Nsb3NlX3JlYXNvbiJdLkVxdWFscyA/IGFbIl9jbG9zZV9yZWFzb24iXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX2Nsb3NlX3JlYXNvbiJdLCByKSkpIHsKCQkJCQlyLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlQcmlvcml0eShhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfcHJpb3JpdHkiXSAmJiAoYVsiX3ByaW9yaXR5Il0uRXF1YWxzID8gYVsiX3ByaW9yaXR5Il0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9wcmlvcml0eSJdLCByKSkpIHsKCQkJCQlyLl9wcmlvcml0eV9JbmNpZGVudHMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglieVVzZXIoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX2NhbGxlciJdICYmIChhWyJfY2FsbGVyIl0uRXF1YWxzID8gYVsiX2NhbGxlciJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfY2FsbGVyIl0sIHIpKSkgewoJCQkJCXIuX2NhbGxlcl9JbmNpZGVudHMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglieVVzZXIoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX2NvbnRhY3QiXSAmJiAoYVsiX2NvbnRhY3QiXS5FcXVhbHMgPyBhWyJfY29udGFjdCJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfY29udGFjdCJdLCByKSkpIHsKCQkJCQlyLl9jb250YWN0X0luY2lkZW50cy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gZmFsc2U7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkluY2lkZW50LnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5JbmNpZGVudChudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMubnVtYmVyKHRoaXMubnVtYmVyKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuY29kZSh0aGlzLmNvZGUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX2xvY2F0aW9uX3NldCAmJiB0aGlzLmxvY2F0aW9uKCkgJiYgIShhd2FpdCB0aGlzLmxvY2F0aW9uKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfbG9jYXRpb24oKTsKCgkJCQkJaWYgKHRoaXMuX2dyb3VwX3NldCAmJiB0aGlzLmdyb3VwKCkgJiYgIShhd2FpdCB0aGlzLmdyb3VwKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfZ3JvdXAoKTsKCgkJCQkJaWYgKHRoaXMuX3N0YXRlX3NldCAmJiB0aGlzLnN0YXRlKCkgJiYgIShhd2FpdCB0aGlzLnN0YXRlKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfc3RhdGUoKTsKCgkJCQkJaWYgKHRoaXMuX3N5bXB0b21fc2V0ICYmIHRoaXMuc3ltcHRvbSgpICYmICEoYXdhaXQgdGhpcy5zeW1wdG9tKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfc3ltcHRvbSgpOwoKCQkJCQlpZiAodGhpcy5fY2xvc2VfcmVhc29uX3NldCAmJiB0aGlzLmNsb3NlX3JlYXNvbigpICYmICEoYXdhaXQgdGhpcy5jbG9zZV9yZWFzb24oKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9jbG9zZV9yZWFzb24oKTsKCgkJCQkJaWYgKHRoaXMuX3ByaW9yaXR5X3NldCAmJiB0aGlzLnByaW9yaXR5KCkgJiYgIShhd2FpdCB0aGlzLnByaW9yaXR5KCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfcHJpb3JpdHkoKTsKCgkJCQkJaWYgKHRoaXMuX2NhbGxlcl9zZXQgJiYgdGhpcy5jYWxsZXIoKSAmJiAhKGF3YWl0IHRoaXMuY2FsbGVyKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfY2FsbGVyKCk7CgoJCQkJCWlmICh0aGlzLl9jb250YWN0X3NldCAmJiB0aGlzLmNvbnRhY3QoKSAmJiAhKGF3YWl0IHRoaXMuY29udGFjdCgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX2NvbnRhY3QoKTsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBGaW5pc2hlZCBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0gSWQ9WyR7dGhpcy5JZH1dYCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkluY2lkZW50Lmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkluY2lkZW50LnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvVXBkYXRlU1FMKCkpOwoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKCkpOwoJCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0WzBdOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5JbmNpZGVudC5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSAoYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgKTsKCQkJCXJldCA9IHJldCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5JbmNpZGVudChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93LlN0YXRlID0gY2xhc3MgU3RhdGUgZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRaWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc0lrZHBkRWgxWWlKZGApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgkJdGhpcy5jbGVhcl9zdGF0ZV9JbmNpZGVudHMoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJTdGF0ZSIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJcmV0dXJuIHRoaXM7CgoJCSh0aGlzLnN0YXRlX0luY2lkZW50cygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoJY29kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb2RlICE9IHYpIHsKCQkJCXRoaXMuX2NvZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29kZSk7CgkJfQoJfQoKCWNsZWFyX2NvZGUoKSB7CgkJdGhpcy5fY29kZV9zZXQgPSBudWxsOwoJCXRoaXMuX2NvZGUgPSBudWxsOwoJCXRoaXMuX2NvZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCglkYXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImRhdGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJyA/IF92IDogKG5ldyBEYXRlKF92KSk7CgkJCQlpZiAoaXNOYU4oX3YuZ2V0VGltZSgpKSkgX3YgPSBudWxsOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuRGF0ZVZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RhdGUgIT0gdikgewoJCQkJdGhpcy5fZGF0ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkRhdGVWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGF0ZSk7CgkJfQoJfQoKCWNsZWFyX2RhdGUoKSB7CgkJdGhpcy5fZGF0ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2RhdGUgPSBudWxsOwoJCXRoaXMuX2RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoJbmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9uYW1lICE9IHYpIHsKCQkJCXRoaXMuX25hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX25hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbmFtZSk7CgkJfQoJfQoKCWNsZWFyX25hbWUoKSB7CgkJdGhpcy5fbmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX25hbWUgPSBudWxsOwoJCXRoaXMuX25hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCglyZW1hcmsodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9yZW1hcmtfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZW1hcmsiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3JlbWFyayAhPSB2KSB7CgkJCQl0aGlzLl9yZW1hcmtfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3JlbWFyayA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcmVtYXJrKTsKCQl9Cgl9CgoJY2xlYXJfcmVtYXJrKCkgewoJCXRoaXMuX3JlbWFya19zZXQgPSBudWxsOwoJCXRoaXMuX3JlbWFyayA9IG51bGw7CgkJdGhpcy5fcmVtYXJrX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBzdGF0ZV9JbmNpZGVudHMgKiovCglzdGF0ZV9JbmNpZGVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX3N0YXRlX0luY2lkZW50czsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnNzQwNzkzNDctY2RjMi00ZTBlLThkZDItYzkxZTVjMzhkMDBkJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdJbmNpZGVudCcpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fc3RhdGVfc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RhdGVfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJzdGF0ZSBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiSW5jaWRlbnQiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdGF0ZV9JbmNpZGVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgInN0YXRlIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiSW5jaWRlbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3Yuc3RhdGUodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fc3RhdGVfSW5jaWRlbnRzLnB1c2goLi4udik7CgkJdGhpcy5fc3RhdGVfSW5jaWRlbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9zdGF0ZV9JbmNpZGVudHNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX3N0YXRlX0luY2lkZW50cygpIHsKCQl0aGlzLl9zdGF0ZV9JbmNpZGVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9zdGF0ZV9JbmNpZGVudHMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9zdGF0ZV9JbmNpZGVudHNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBzdGF0ZV9JbmNpZGVudHMgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fc3RhdGVfSW5jaWRlbnRzX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX2FjdGl2ZV9zZXQgPSB0aGlzLl9hY3RpdmVfc2V0OwoJCXJldC5fYWN0aXZlX2Nvb3AgPSB0aGlzLl9hY3RpdmVfY29vcDsKCQlyZXQuYWN0aXZlID0gdGhpcy5hY3RpdmUoKSA/IHRoaXMuYWN0aXZlKCkgOiB0aGlzLmFjdGl2ZSgpOwoKCQlyZXQuX2VuYWJsZWRfc2V0ID0gdGhpcy5fZW5hYmxlZF9zZXQ7CgkJcmV0Ll9lbmFibGVkX2Nvb3AgPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJcmV0LmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKSA/IHRoaXMuZW5hYmxlZCgpIDogdGhpcy5lbmFibGVkKCk7CgoJCXJldC5fY29kZV9zZXQgPSB0aGlzLl9jb2RlX3NldDsKCQlyZXQuX2NvZGVfY29vcCA9IHRoaXMuX2NvZGVfY29vcDsKCQlyZXQuY29kZSA9IHRoaXMuY29kZSgpID8gdGhpcy5jb2RlKCkgOiB0aGlzLmNvZGUoKTsKCgkJcmV0Ll9vcmRlcl9zZXQgPSB0aGlzLl9vcmRlcl9zZXQ7CgkJcmV0Ll9vcmRlcl9jb29wID0gdGhpcy5fb3JkZXJfY29vcDsKCQlyZXQub3JkZXIgPSB0aGlzLm9yZGVyKCkgPyB0aGlzLm9yZGVyKCkgOiB0aGlzLm9yZGVyKCk7CgoJCXJldC5fZGF0ZV9zZXQgPSB0aGlzLl9kYXRlX3NldDsKCQlyZXQuX2RhdGVfY29vcCA9IHRoaXMuX2RhdGVfY29vcDsKCQlyZXQuZGF0ZSA9IHRoaXMuZGF0ZSgpID8gdGhpcy5kYXRlKCkgOiB0aGlzLmRhdGUoKTsKCgkJcmV0Ll9uYW1lX3NldCA9IHRoaXMuX25hbWVfc2V0OwoJCXJldC5fbmFtZV9jb29wID0gdGhpcy5fbmFtZV9jb29wOwoJCXJldC5uYW1lID0gdGhpcy5uYW1lKCkgPyB0aGlzLm5hbWUoKSA6IHRoaXMubmFtZSgpOwoKCQlyZXQuX3JlbWFya19zZXQgPSB0aGlzLl9yZW1hcmtfc2V0OwoJCXJldC5fcmVtYXJrX2Nvb3AgPSB0aGlzLl9yZW1hcmtfY29vcDsKCQlyZXQucmVtYXJrID0gdGhpcy5yZW1hcmsoKSA/IHRoaXMucmVtYXJrKCkgOiB0aGlzLnJlbWFyaygpOwoKCQlyZXQuc3RhdGVfSW5jaWRlbnRzID0gdGhpcy5zdGF0ZV9JbmNpZGVudHMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCXN0YXRlX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N0YXRlX1N0YXRlcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCAmJiBldmVudC5jbGFzc05hbWUoKSAmJiBldmVudC5jbGFzc05hbWUoKSAhPSAnU3RhdGUnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiRGVsZWdhdGluZyBpbnZva2F0aW9uIHRvICIgKyBldmVudC5jbGFzc05hbWUoKSk7CgkJCQlyZXR1cm4gbmV3IHNhbGVzbm93W2V2ZW50LmNsYXNzTmFtZSgpXSgpLl9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpOwoJCQl9CgoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQlkYXRhLl9fdGhpcyA9IGRhdGEuX190aGlzIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkJc3dpdGNoIChtZXRob2QpIHsKCgkJCX0KCQl9CgoJCWlmICghbiB8fCBzYWxlc25vdy5fbm9kZS5fc2FtZU5vZGUobikpIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkNhbGxiYWNrIik7CgkJCXJldCA9IGF3YWl0IHRoaXMuX2ludm9rZShtZXRob2QsIGRhdGEpOwoJCX0gZWxzZSBpZiAobi5hZGRyZXNzKCkgJiYgbi5fc2FtZU5vZGUobikgLyphY3R1YWwgbm9kZSovICkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBuLl9hZGRyZXNzLCBuLl9wb3J0LCBtZXRob2QpOwoJCQl0cnkgewoJCQkJbGV0IGNvbmZpZyA9IHsKCQkJCQloZWFkZXJzOiB7fSwKCQkJCX07CgkJCQlpZiAoc2FsZXNub3cuX190b2tlbikgY29uZmlnLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGAke3NhbGVzbm93Ll9fdG9rZW4udG9rZW5fdHlwZX0gJHtzYWxlc25vdy5fX3Rva2VuLmFjY2Vzc190b2tlbn1gOwoJCQkJcmV0ID0gYXdhaXQgYXhpb3MucG9zdChgaHR0cCR7bi5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHtuLmFkZHJlc3MoKX06JHtuLnBvcnQoKSB8fCAzMDAwfS9tZXRob2QvU3RhdGUvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQkJZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOwoJCQkJZGVsZXRlIGRhdGEuX190aGlzLm9ubGluZTsKCgkJCX0KCgkJCS8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/PwoKCQkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJCXRyeSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0pIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7bWV0aG9kfWApOwoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCWxldCBfaWQgPSBudWxsOwoJCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBkYXRhLCBtZXRob2QsIHt9KTsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRhdGEpID09PSAnc3RyaW5nJykgewoJCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUoZGF0YSk7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IGRhdGEuX190aGlzLmNvZGUgfHwgZGF0YS5pZCB8fCBkYXRhLklEOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJCWlmIChkYXRhLklkICYmIGRhdGEuSWQgPT0gZGF0YS5JZCkgewoJCQkJCQlfaWQgPSBkYXRhLklkOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQkJfSBlbHNlIGlmIChkYXRhLkVudGl0eUNsYXNzKSB7CgkJCQkJCV9pZCA9IGRhdGEuRW50aXR5Q2xhc3MuSWQgfHwgZGF0YS5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgImE3YTQ5NzViLWMyN2EtNGM2ZS1iYTdkLTY0NDc0YTRhMTZiOCIgfHwgIk5VTEwiOwoJCQkJCX0KCQkJCX0KCgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGUgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVttZXRob2RdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVttZXRob2RdIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVttZXRob2RdW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW21ldGhvZF1bX2lkXSB8fCB7fTsKCgkJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goe30sIHsKCQkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQkJfSk7CgoJCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbbWV0aG9kXVtfaWRdW19oYXNoXTsKCQkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogNSkpIHsKCQkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIG1ldGhvZCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCQl2LnJldXNlZCsrOwoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0KCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSk7CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW21ldGhvZF1bX2lkXVtfaGFzaF0gPSB7CgkJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoe30pLAoJCQkJCW9iajogZGF0YSwKCQkJCQlyZXVzZWQ6IDAsCgkJCQl9OwoJCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0gPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGRhdGEsIG1ldGhvZCwge30sIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBgVHJpZ2dlcnJpbmcgJHttZXRob2R9IHRvICR7bi5jb2RlKCl9ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSxudWxsLDQpfWApOwoKCQkJbGV0IGV2ID0gbmV3IHNhbGVzbm93LkV2ZW50KCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuY29kZSh0aGlzLl91dWlkKCkpLm5hbWUodGhpcy5fX2NvbmZpZygnZXZlbnQnKSB8fCAnc2FsZXNub3cuRXZlbnQnKS5kYXRlKHRoaXMuc2VydmVyRGF0ZSgpKS5yZWNpcGllbnQobikubWV0aG9kKG1ldGhvZCkuY2xhc3NOYW1lKCdTdGF0ZScpLnNlbmRlcihzYWxlc25vdy5fbm9kZSkuY2FycmllcihzYWxlc25vdy5fbm9kZSkucGF5bG9hZChkYXRhKTsKCQkJaWYgKGV2ZW50KSB7CgkJCQlpZiAoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7CgkJCQlpZiAoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7CgkJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7CgkJCQlpZiAoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7CgkJCX0KCQkJcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOwoKCQkJaWYgKHR5cGVvZihyZXQpID09PSAic3RyaW5nIikgewoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChleCkge30KCQkJfQoJCQlyZXR1cm4gcmV0OwoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LlN0YXRlKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5TdGF0ZShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocCkpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHt9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2UobWV0aG9kLCBib2R5LCBxdWVyeSwgYXV0aE9iaikgewoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgbWV0aG9kLCBxdWVyeSwgYm9keSk7CgoJCWlmICh0eXBlb2YoYm9keSkgPT09ICdzdHJpbmcnIHx8ICh0eXBlb2YoQnVmZmVyKSAhPT0gJ3VuZGVmaW5lZCcgJiYgQnVmZmVyLmlzQnVmZmVyKGJvZHkpKSkgewoJCQl0cnkgewoJCQkJYm9keSA9IEpTT04ucGFyc2UoYm9keS50b1N0cmluZygpKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJvZHkgaXMgbm90IGEgdmFsaWQgSlNPTiIsIGJvZHkpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoKCQlsZXQgX3BhcmFtcyA9IHF1ZXJ5ID8gT2JqZWN0LmFzc2lnbihxdWVyeSwgYm9keSkgOiBib2R5OwoJCWlmICh0eXBlb2YoX3BhcmFtcykgPT09ICdzdHJpbmcnKSBfcGFyYW1zID0gSlNPTi5wYXJzZShfcGFyYW1zKTsKCgkJaWYgKF9wYXJhbXMpIHsKCQkJX3BhcmFtcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcyk7CgkJfSBlbHNlIHsKCQkJX3BhcmFtcyA9IHt9OwoJCX0KCgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgX3BhcmFtcy5fX2ZsYXR0ZWQpIF9wYXJhbXMgPSBGbGF0dGVkLnBhcnNlKF9wYXJhbXMuX19mbGF0dGVkKTsKCgkJaWYgKF9wYXJhbXMuX19ub2RlKSB7CgkJCS8vIHByb2JhYmx5IHNob3VsZCBub3QgYmUgcHJvY2Vzc2VkIGhlcmUsIGJ1dCByYXRoZXIgY29uc3VtZWQgYXMgcGFydCBvZiB0aGUgZXhlY3V0ZSgpIGxvZ2ljLCBwdXNoaW5nIF9fbm9kZSB0byB0aGUgbGlzdCBvZiBteSBub2RlcyB0byBkZWxlZ2F0ZSB0byE/CgkJCWxldCB0biA9IG5ldyBzYWxlc25vdy5Ob2RlKCkuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fbm9kZSkuX2RlUmVmZXJlbmNlKCk7CgkJCWRlbGV0ZSBfcGFyYW1zLl9fbm9kZTsKCQkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5TdGF0ZSgpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOwoJCX0KCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgU3RhdGUuX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBTdGF0ZS5faW52b2tlOiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLAoJCQkJCSdvYmonOiBvYmoKCQkJCX0KCQkJfTsKCQl9IGVsc2UgewoJCQlyZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOwoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJaWYgKGZhbHNlICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQlyZXQgPSB7CgkJCQkJX19leGNlcHRpb246IHsKCQkJCQkJJy00JzogIlVuY29tbWl0dGVkIHRyYW5zYWN0aW9uczogIiArIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uc3Fscy5sZW5ndGgsCgkJCQkJCSdvYmonOiBvYmoKCQkJCQl9CgkJCQl9CgkJCX0KCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQl9CgoJCWlmIChyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbikgewoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0ge307CgkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCXJldCA9IHJldC5tYXAociA9PiB7CgkJCQkJaWYgKHIgJiYgci5fdG9Eb2N1bWVudCkgewoJCQkJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZS5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5TdGF0ZS4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiU3RhdGUiKTsKCgl9CgoJX19zeW5jX29uKGQpIHsKCQl0aGlzLl9fX3N5bmNfb24gPSB0aGlzLl9fX3N5bmNfb24gfHwge307CgoJCWlmIChkKSB7CgkJCXRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV0gPSBkOwoKCQkJLy8gdGhpcy5zdGF0ZV9TdGF0ZXMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5TdGF0ZSh0aGlzLklkKQoKCQkJLmFjdGl2ZSh0aGlzLmFjdGl2ZSgpLCB0aGlzLl9hY3RpdmVfY29vcCkKCgkJCS5lbmFibGVkKHRoaXMuZW5hYmxlZCgpLCB0aGlzLl9lbmFibGVkX2Nvb3ApCgoJCQkuY29kZSh0aGlzLmNvZGUoKSwgdGhpcy5fY29kZV9jb29wKQoKCQkJLm9yZGVyKHRoaXMub3JkZXIoKSwgdGhpcy5fb3JkZXJfY29vcCkKCgkJCS5kYXRlKHRoaXMuZGF0ZSgpLCB0aGlzLl9kYXRlX2Nvb3ApCgoJCQkubmFtZSh0aGlzLm5hbWUoKSwgdGhpcy5fbmFtZV9jb29wKQoKCQkJLnJlbWFyayh0aGlzLnJlbWFyaygpLCB0aGlzLl9yZW1hcmtfY29vcCkKCgkJCS5zdGF0ZV9JbmNpZGVudHModGhpcy5zdGF0ZV9JbmNpZGVudHMoKSwgdGhpcy5fc3RhdGVfSW5jaWRlbnRzX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQlvYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ1N0YXRlJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiU3RhdGUiOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoJCQkJcmV0ID0gcmV0LnRvTG93ZXJDYXNlKCk7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMgPSB7fSkgewoJCXRyeSB7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCA/IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSBvcHRpb25zLnRvb2wgfHwgdCA9PSBvcHRpb25zLnRvb2wpIDogdGhpcy5Ub29sOwoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgfHwge307CgoJCQlsZXQgbklEID0gc2FsZXNub3cuX25vZGUgPyBzYWxlc25vdy5fbm9kZS5jb2RlKCkgOiAiZGVmYXVsdCI7CgoJCQlsZXQgcmV0ID0gbnVsbFZhbHVlOwoJCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXQgPSBudWxsOwoKCQkJLy8gdG9vbF9Db25maWdzOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIGRvbmUKCQkJbGV0IHRjb25mID0gKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmIGMubm9kZSAmJiBjLm5vZGUuY29kZSA9PSBuSUQpLmNvbmNhdCgob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgIWMubm9kZSkpOwoJCQlpZiAodGNvbmYubGVuZ3RoKSB7CgkJCQlyZXQgPSB0Y29uZlswXS52YWx1ZTsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoamV4KSB7fQoJCQl9CgoJCQkvLyBtb2RlbCBDb25maWc6IENvbmZpZyBpcyBjbGFzcyBsZXZlbCwgbm9kZSBub3QgcG9zc2libGUgLSBwZW5kaW5nCgkJCWxldCBtY29uZiA9IHRoaXMuQ29uZmlnID8gdGhpcy5Db25maWdbbl0gOiB1bmRlZmluZWQ7CgkJCWlmICh0eXBlb2YobWNvbmYpICE9PSAidW5kZWZpbmVkIikgcmV0ID0gbWNvbmY7CgoJCQkvLyBjb21tYW5kIGxpbmU6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnICYmIGdsb2JhbC5taW5pbWlzdCkgewoJCQkJcmV0ID0gZ2xvYmFsLm1pbmltaXN0KHByb2Nlc3MuYXJndi5zbGljZSgyKSlbbl0gfHwgcmV0OwoJCQl9CgoJCQkvLyByZXF1ZXN0OiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJcmV0ID0gdGhpcy4kX1JFUVVFU1QobikgfHwgcmV0OwoKCQkJaWYgKG9wdGlvbnMubmV3VmFsdWUpIHsKCQkJCWxldCB0YyA9IHRjb25mLmxlbmd0aCA/IHRjb25mWzBdIDoge307CgkJCQl0Yy5ub2RlID0gewoJCQkJCWNvZGU6IG9wdGlvbnMubm9kZS5jb2RlKCkKCQkJCX07CgkJCQl0Yy52YWx1ZSA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCQl0Yy5uYW1lID0gbjsKCQkJCWlmICghdGNvbmYubGVuZ3RoKSB7CgkJCQkJb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncy5wdXNoKHRjKTsKCQkJCX0KCQkJCXJldCA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCX0KCgkJCS8vIGNvbmZpZyByZXBsYWNlbWVudAoJCQlpZiAodHlwZW9mKHJldCkgPT09ICdzdHJpbmcnKShyZXQubWF0Y2gobmV3IFJlZ0V4cChge3soW159XSspfX1gLCAiZyIpKSB8fCBbXSkuZm9yRWFjaChtID0+IHJldCA9IHJldC5yZXBsYWNlKG0sIHRoaXMuX19jb25maWcobS5yZXBsYWNlKCd7eycsICcnKS5yZXBsYWNlKCd9fScsICcnKSwgbnVsbCwgb3B0aW9ucykpKTsKCgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19jb25maWcnLCAnRW50aXR5T2JqZWN0JywgMSwgbiwgbnVsbFZhbHVlLCBvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLCBleCk7CgkJfQoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qU3RhdGUqLyk7XG4nOwoKCQlyZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiB0cnVlLAoJCQlOdWxsOiB0cnVlLAoJCQkvL0lkOiAob2JqLCB2KSA9PiBvYmouc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWWAsCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJc3RhdGVfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3RhdGVfU3RhdGVzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJfSwgIl90b1NRTFRhYmxlIik7CgoJCS8vIHJldC5zcWwgKz0gJy8qU3RhdGUqLyk7XG4nOwoKCQlyZXQuc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChyZXQuc3FsKSA6IHJldC5zcWw7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NRTFRhYmxlJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldC5zcWwpOwoJCXJldHVybiByZXQuc3FsOwoJfQoKCV9mcm9tU1FMVGFibGUodGFibGUsIGZpZWxkcykgewoJCS8vIHRhYmxlIGlzIGEganNvbiBhcnJheQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5hY3RpdmUodGFibGVbImFjdGl2ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5lbmFibGVkKHRhYmxlWyJlbmFibGVkIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvZGUodGFibGVbImNvZGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9yZGVyKHRhYmxlWyJvcmRlciJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5kYXRlKHRhYmxlWyJkYXRlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm5hbWUodGFibGVbIm5hbWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5yZW1hcmsodGFibGVbInJlbWFyayJdKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIF9zcWwoc3FsLCBzb3VyY2UgPSB0aGlzKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWwoc3FsLCB0aGlzKTsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgoJCQkJCS8vIGlmKHRoaXNbJ18nK2ZpZWxkKydfc2V0J10gJiYgKHR5cGVvZih0aGlzWydfJytmaWVsZF0pPT09J3VuZGVmaW5lZCcgfHwgdGhpc1snXycrZmllbGRdPT1udWxsKSkgcmV0dXJuOwoJCQkJCS8vIGlmKHR5cGVvZihlYU9iaik9PT0ndW5kZWZpbmVkJykgcmV0dXJuOyAvLyB3aHk/CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlyZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqLCB0aGlzLmNvZGUoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmosIHRoaXMuZGF0ZSgpKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmosIHRoaXMubmFtZSgpKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaiwgdGhpcy5yZW1hcmsoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJhN2E0OTc1Yi1jMjdhLTRjNmUtYmE3ZC02NDQ3NGE0YTE2YjgiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGUgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiBvYmosCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIG9iaiwgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIl9USElTIiwgb2JqLCB0aGlzLl9USElTKTsKCgkJX29wdGlvbnMoInN0YXRlX0luY2lkZW50cyIsIG9iaiwgdGhpcy5zdGF0ZV9JbmNpZGVudHMoKSk7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydzdGF0ZV9JbmNpZGVudHMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIlN0YXRlIiAmJiAobS50YXJnZXQgfHwgbS5vdXRTY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkgJiYgKCFtLnNvdXJjZSB8fCAobS5zb3VyY2UgJiYgLyohbS5vdXRTY3JpcHQgJiYqLyB0aGlzWydfJyArIG0uc291cmNlICsgJ19zZXQnXSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0ub3V0U2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5vdXRTY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5vdXRTY3JpcHR9KX1gKSh0aGlzLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS5zb3VyY2UpIHsKCQkJCWlmIChtLnNvdXJjZS5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMpID0+IHtyZXR1cm4gX3RoaXMuJHttLnNvdXJjZX07fWApKHRoaXMpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS5zb3VyY2UsIHRoaXMpOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnRhcmdldCkgb2JqW20udGFyZ2V0XSA9IHJldDsKCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJW20udGFyZ2V0IHx8IG0uc291cmNlXTogdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddCgkJCX0pOwoJCX0pOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCS8vIHVzZSB0aGlzLl9tYXAoKSB3aXRoIHJldmVyc2UKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmopOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiYTdhNDk3NWItYzI3YS00YzZlLWJhN2QtNjQ0NzRhNGExNmI4IiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoInN0YXRlX0luY2lkZW50cyIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydzdGF0ZV9JbmNpZGVudHMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIlN0YXRlIiAmJiAobS5zb3VyY2UgfHwgbS5pblNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLmluU2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaiwgb1Njb3BlLCBtYXApID0+IHske20uaW5TY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5pblNjcmlwdH0pfWApKG9iaiwgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0udGFyZ2V0KSB7CgkJCQlpZiAobS50YXJnZXQuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaikgPT4ge3JldHVybiBvYmouJHttLnRhcmdldH07fWApKG9iaik7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmpbbS50YXJnZXRdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS50YXJnZXQsIG9iaik7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS5zb3VyY2UpIHsKCQkJCWlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0ocmV0KTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0gPSByZXQ7CgkJCQl9CgkJCX0KCQl9KTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXTogIiciICsgdGhpcy5JZCArICInIgoJCX07CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2FjdGl2ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hY3RpdmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9lbmFibGVkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY29kZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jb2RlKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fb3JkZXJfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMub3JkZXIoKTsKCgkJCWZWYWx1ZSA9IHYgfHwgJzAnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZGF0ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5kYXRlKCk7CgoJCQl0cnkgewoJCQkJZlZhbHVlID0gIiciICsgKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiAiMTk3MC0xLTEiKSArICInIjsKCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJykgewoJCQkJCWZWYWx1ZSA9IGBTVFJfVE9fREFURSgke2ZWYWx1ZX0sICclWS0lbS0lZFQlVC4lZlonKWA7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9ICdkYXRldGltZSgnICsgZlZhbHVlICsgJyknOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9uYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm5hbWUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcmVtYXJrX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnJlbWFyaygpOwoKCQkJZlZhbHVlID0gIiciICsgKCh2ICYmIHYucmVwbGFjZSkgPyB2LnJlcGxhY2UoL1wnL2csICJcJ1wnIikgOiB2KSArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJyB8fCB0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIHsKCQkJX28gPSBfcSA9ICdgJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3Fsc2VydmVyJykgewoJCQlfbyA9ICdbJzsKCQkJX3EgPSAnXSc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCdhcGlLZXknKSA9PSAnYWlydGFibGUnKSB7CgkJCV9vID0gJ3snOwoJCQlfcSA9ICd9JzsKCQl9CgkJdGhpcy5fX1EgPSB0aGlzLl9fUSA9PSBfbyA/IF9xIDogX287CgkJcmV0dXJuIHRoaXMuX19ROwoJfQoKCV9maWVsZEdyb3VwcyhmZ3MgPSB7fSkgewoJCXRoaXMuX19maWVsZEdyb3VwcyA9IGZnczsKCQlyZXR1cm4gdGhpczsKCX0KCglfZmllbGRBZ2dyZWdhdGVzKGZhcyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkQWdncmVnYXRlcyA9IGZhczsKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9GaWVsZHNTUUwoZmllbGRzKSB7CgoJCWZpZWxkcyA9IGZpZWxkcyB8fCBbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJywgdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCldOwoJCWZpZWxkcyA9IEFycmF5LmlzQXJyYXkoZmllbGRzKSA/IGZpZWxkcyA6IFtmaWVsZHNdOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCS8vIHtmaWVsZDogb3JkZXJ9CgkJCWZpZWxkcyA9IFtdOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU51bGw6IHRydWUsCgoJCX0sICJfdG9TZWxlY3RIZWFkZXIiKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0SGVhZGVyJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU2VsZWN0U1FMKGZpZWxkcykgewoJCWxldCBzcWwgPSAic2VsZWN0ICI7CgoJCWxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9YDsKCgkJbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7CgkJc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOwoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOwoKCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcykgewoJCQkvLyB7ZmllbGQ6IGZ1bmN0aW9ufQoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jb2RlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fb3JkZXJfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vcmRlcl9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9kYXRlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LnRvSVNPU3RyaW5nKSB7CgkJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3FsaXRlJykgewoJCQkJCQlvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbmFtZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX25hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3JlbWFya19zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJc3RhdGVfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3RhdGVfU3RhdGVzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9zdGF0ZV9JbmNpZGVudHNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJzdGF0ZS5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fc3RhdGVfSW5jaWRlbnRzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl9zdGF0ZV9JbmNpZGVudHNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fc3RhdGVfSW5jaWRlbnRzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX3N0YXRlX0luY2lkZW50c19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX3N0YXRlX0luY2lkZW50c19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLypzdGF0ZV9JbmNpZGVudHMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCX0sICJfdG9TZWxlY3RTUUwiLCBmaWVsZHMpLnNxbDsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQlpZiAoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jb2RlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMub3JkZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZGF0ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5uYW1lfWA7CgoJCX0KCgkJaWYgKHNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpIHsKCQkJLy8gc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSIsICJ3aGVyZSAxPTAiKTsKCQl9IGVsc2UgewoJCQlzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7CgkJfQoKCQlzcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCkgOiBzcWw7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgoJCXJldHVybiBzcWw7Cgl9CgoJX3RvUGF0aHMoKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJX1RISVM6IG9iaiA9PiB7fSwKCgkJCXN0YXRlX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N0YXRlX1N0YXRlcycsIHVuZGVmaW5lZCkpID0+IG9iai5zdGF0ZV9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJfSwgIl90b1BhdGhzIik7CgkJLy8gcmV0dXJuIHJldDsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5tYXAoayA9PiAoewoJCQlba106IHJldFtrXQoJCX0pKTsKCX0KCglfdG9VcGRhdGVTUUwoZmllbGRzKSB7CgkJbGV0IHJldEZpZWxkcyA9IHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLmpvaW4oJywgJyk7CgkJbGV0IHNxbCA9IGB1cGRhdGUgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSBzZXQgYCArIE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvREJPYmplY3QoZmllbGRzKSkubWFwKHYgPT4gdGhpcy5fUSgpICsgdlswXSArIHRoaXMuX1EoKSArICI9IiArIHZbMV0pICsgYCB3aGVyZSAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgOyAvL2AgcmV0dXJuaW5nICR7cmV0RmllbGRzfWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvVXBkYXRlU1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfdG9JbnNlcnRTUUwoZmllbGRzKSB7CgkJbGV0IG9iaiA9IHRoaXMuX3RvREJPYmplY3QoZmllbGRzKTsKCQlsZXQgc3FsID0gYGluc2VydCBpbnRvICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKGAgKyBPYmplY3Qua2V5cyhvYmopLm1hcChrID0+IHRoaXMuX1EoKSArIGsgKyB0aGlzLl9RKCkpICsgIikgdmFsdWVzICgiICsgT2JqZWN0LnZhbHVlcyhvYmopICsgYClgOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0luc2VydFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5TdGF0ZSkgcmV0dXJuOwoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5TdGF0ZSA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCBzcWwgPSBuZXcgc2FsZXNub3cuU3RhdGUoKQoKCQkJCQkuc3RhdGVfSW5jaWRlbnRzKG5ldyBzYWxlc25vdy5JbmNpZGVudCgpKQoKCQkJCQkuX3RvU1FMVGFibGUoZGVwdGgpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQkJCWF3YWl0IHRoaXMuX3NxbChzcWwpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiU3RhdGUiKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCXN0YXRlX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5zdGF0ZV9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBxdWVyeS5zdGF0ZV9JbmNpZGVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXN0YXRlX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5zdGF0ZV9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJc3RhdGVfSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuc3RhdGVfSW5jaWRlbnRzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ107CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJc3RhdGVfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnc3RhdGVfU3RhdGVzJywgdW5kZWZpbmVkKSA6ICJzdGF0ZV9JbmNpZGVudHMiKSkgPT4gdGhpcy5zdGF0ZV9JbmNpZGVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddID0gdiwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCXN0YXRlX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3N0YXRlX1N0YXRlcycsIHVuZGVmaW5lZCkgOiAic3RhdGVfSW5jaWRlbnRzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX3N0YXRlX0luY2lkZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fc3RhdGVfSW5jaWRlbnRzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuX25hbWU7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IGZhbHNlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5TdGF0ZS5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuU3RhdGUobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLmNvZGUodGhpcy5jb2RlKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCWlmICh0eXBlb2Yoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgPT09ICJ1bmRlZmluZWQiIHx8IHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQkJCWF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsKCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiA9IHsKCQkJCQkJCU93bmVyOiB0aGlzLAoJCQkJCQkJc3FsczogW10sCgkJCQkJCQlzdGFydDogbmV3IERhdGUoKSwKCQkJCQkJCWVuZDogbnVsbAoJCQkJCQl9OwoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSB7CgkJCQkJdGhpcy5hY3RpdmUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSB7CgkJCQkJdGhpcy5lbmFibGVkKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgewoJCQkJCXRoaXMuZGF0ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSBuZXcgRGF0ZSgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fX2Fzc2VydFZhbGlkKHRydWUpKSByZXR1cm4gbnVsbDsKCgkJCQkvL2F3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8gaW4gY2FzZSBUb29sIGNoYW5nZXMKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgQWJvdXQgdG8gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9YCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgRmluaXNoZWQgSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9IElkPVske3RoaXMuSWR9XWApOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX3N0YXRlX0luY2lkZW50c19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLnN0YXRlX0luY2lkZW50cygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlN0YXRlLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlN0YXRlLnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvVXBkYXRlU1FMKCkpOwoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKCkpOwoJCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0WzBdOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5TdGF0ZS5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSAoYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgKTsKCQkJCXJldCA9IHJldCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5TdGF0ZShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93Lkdyb3VwID0gY2xhc3MgR3JvdXAgZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRaWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc0lrZHBkRWgxWWlKZGApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3BlbkluY2lkZW50VGhyZWFzaG9sZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3BlbkluY2lkZW50VGhyZWFzaG9sZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfZ3JvdXBfSW5jaWRlbnRzKCk7CgoJCXRoaXMuY2xlYXJfZ3JvdXBfR3JvdXBfTWVtYmVycygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIkdyb3VwIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQlyZXR1cm4gdGhpczsKCgkJKHRoaXMuZ3JvdXBfSW5jaWRlbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJKHRoaXMuZ3JvdXBfR3JvdXBfTWVtYmVycygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcGVuSW5jaWRlbnRUaHJlYXNob2xkICoqLwoJb3BlbkluY2lkZW50VGhyZWFzaG9sZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcGVuSW5jaWRlbnRUaHJlYXNob2xkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZCAhPSB2KSB7CgkJCQl0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGQpOwoJCX0KCX0KCgljbGVhcl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkKCkgewoJCXRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkID0gbnVsbDsKCQl0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcGVuSW5jaWRlbnRUaHJlYXNob2xkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXBfSW5jaWRlbnRzICoqLwoJZ3JvdXBfSW5jaWRlbnRzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9ncm91cF9JbmNpZGVudHM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzc0MDc5MzQ3LWNkYzItNGUwZS04ZGQyLWM5MWU1YzM4ZDAwZCcgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnSW5jaWRlbnQnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX2dyb3VwX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dyb3VwX0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAiZ3JvdXAgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkluY2lkZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ3JvdXBfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJncm91cCBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkluY2lkZW50Iik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92Lmdyb3VwKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX2dyb3VwX0luY2lkZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX2dyb3VwX0luY2lkZW50c19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fZ3JvdXBfSW5jaWRlbnRzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9ncm91cF9JbmNpZGVudHMoKSB7CgkJdGhpcy5fZ3JvdXBfSW5jaWRlbnRzX3NldCA9IG51bGw7CgkJdGhpcy5fZ3JvdXBfSW5jaWRlbnRzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fZ3JvdXBfSW5jaWRlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXBfSW5jaWRlbnRzICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXBfR3JvdXBfTWVtYmVycyAqKi8KCWdyb3VwX0dyb3VwX01lbWJlcnModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2RmNTkzMzJjLTgxMmUtNDlhOS1hZTQ2LTI5MjI5Y2U0NmIyYicgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnR3JvdXAgTWVtYmVyJykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9ncm91cF9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdncm91cF9Hcm91cF9NZW1iZXJzJywgJ0VudGl0eU9iamVjdCcsIDEsICJncm91cCBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiR3JvdXBfTWVtYmVyIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ3JvdXBfR3JvdXBfTWVtYmVycycsICdFbnRpdHlPYmplY3QnLCAxLCAiZ3JvdXAgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJHcm91cF9NZW1iZXIiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YuZ3JvdXAodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVycy5wdXNoKC4uLnYpOwoJCXRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX2dyb3VwX0dyb3VwX01lbWJlcnMoKSB7CgkJdGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVyc19zZXQgPSBudWxsOwoJCXRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXBfR3JvdXBfTWVtYmVycyAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0LAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJCXRoaXMuX2dyb3VwX0luY2lkZW50c19zZXQsCgoJCQl0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0ID0gdGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9zZXQ7CgkJcmV0Ll9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX2Nvb3AgPSB0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX2Nvb3A7CgkJcmV0Lm9wZW5JbmNpZGVudFRocmVhc2hvbGQgPSB0aGlzLm9wZW5JbmNpZGVudFRocmVhc2hvbGQoKSA/IHRoaXMub3BlbkluY2lkZW50VGhyZWFzaG9sZCgpIDogdGhpcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKCk7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5ncm91cF9JbmNpZGVudHMgPSB0aGlzLmdyb3VwX0luY2lkZW50cygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0Lmdyb3VwX0dyb3VwX01lbWJlcnMgPSB0aGlzLmdyb3VwX0dyb3VwX01lbWJlcnMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJIm9wZW5JbmNpZGVudFRocmVhc2hvbGQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCWdyb3VwX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwX0dyb3VwcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCWdyb3VwX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cF9Hcm91cHMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkgIT0gJ0dyb3VwJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL0dyb3VwLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7CgoJCQl9CgoJCQkvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8KCgkJCWxldCB2ID0gdW5kZWZpbmVkOwoJCQl0cnkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke21ldGhvZH1gKTsKCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQlsZXQgX2lkID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgZGF0YSwgbWV0aG9kLCB7fSk7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIHsKCQkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKGRhdGEpOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSBkYXRhLl9fdGhpcy5jb2RlIHx8IGRhdGEuaWQgfHwgZGF0YS5JRDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCQlpZiAoZGF0YS5JZCAmJiBkYXRhLklkID09IGRhdGEuSWQpIHsKCQkJCQkJX2lkID0gZGF0YS5JZDsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5FbnRpdHlDbGFzcykgewoJCQkJCQlfaWQgPSBkYXRhLkVudGl0eUNsYXNzLklkIHx8IGRhdGEuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI1MzFkMzc1Ni1mNjJhLTQyMzQtYjk2ZC04MDQ4MzYyMmIyMjEiIHx8ICJOVUxMIjsKCQkJCQl9CgkJCQl9CgoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cCB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbbWV0aG9kXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFttZXRob2RdW19pZF0gfHwge307CgoJCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKHt9LCB7CgkJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJCX0pOwoKCQkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnR3JvdXAnKS5zZW5kZXIoc2FsZXNub3cuX25vZGUpLmNhcnJpZXIoc2FsZXNub3cuX25vZGUpLnBheWxvYWQoZGF0YSk7CgkJCWlmIChldmVudCkgewoJCQkJaWYgKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOwoJCQkJaWYgKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOwoJCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJaWYgKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOwoJCQl9CgkJCXJldCA9IGF3YWl0IGV2LnRyaWdnZXIoKTsKCgkJCWlmICh0eXBlb2YocmV0KSA9PT0gInN0cmluZyIpIHsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCX0KCQkJcmV0dXJuIHJldDsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5Hcm91cChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuR3JvdXAobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuR3JvdXAoKS5faW52b2tlTm9kZSh0biwgbWV0aG9kLCBfcGFyYW1zKTsKCQl9CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYEdyb3VwLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgR3JvdXAuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXAuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuR3JvdXAuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIkdyb3VwIik7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCS8vIHRoaXMuZ3JvdXBfR3JvdXBzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCS8vIHRoaXMuZ3JvdXBfR3JvdXBzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuR3JvdXAodGhpcy5JZCkKCgkJCS5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKHRoaXMub3BlbkluY2lkZW50VGhyZWFzaG9sZCgpLCB0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX2Nvb3ApCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5jb2RlKHRoaXMuY29kZSgpLCB0aGlzLl9jb2RlX2Nvb3ApCgoJCQkub3JkZXIodGhpcy5vcmRlcigpLCB0aGlzLl9vcmRlcl9jb29wKQoKCQkJLmRhdGUodGhpcy5kYXRlKCksIHRoaXMuX2RhdGVfY29vcCkKCgkJCS5uYW1lKHRoaXMubmFtZSgpLCB0aGlzLl9uYW1lX2Nvb3ApCgoJCQkucmVtYXJrKHRoaXMucmVtYXJrKCksIHRoaXMuX3JlbWFya19jb29wKQoKCQkJLmdyb3VwX0luY2lkZW50cyh0aGlzLmdyb3VwX0luY2lkZW50cygpLCB0aGlzLl9ncm91cF9JbmNpZGVudHNfY29vcCkKCgkJCS5ncm91cF9Hcm91cF9NZW1iZXJzKHRoaXMuZ3JvdXBfR3JvdXBfTWVtYmVycygpLCB0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQlvYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ0dyb3VwJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiR3JvdXAiOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoJCQkJcmV0ID0gcmV0LnRvTG93ZXJDYXNlKCk7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMgPSB7fSkgewoJCXRyeSB7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCA/IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSBvcHRpb25zLnRvb2wgfHwgdCA9PSBvcHRpb25zLnRvb2wpIDogdGhpcy5Ub29sOwoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgfHwge307CgoJCQlsZXQgbklEID0gc2FsZXNub3cuX25vZGUgPyBzYWxlc25vdy5fbm9kZS5jb2RlKCkgOiAiZGVmYXVsdCI7CgoJCQlsZXQgcmV0ID0gbnVsbFZhbHVlOwoJCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXQgPSBudWxsOwoKCQkJLy8gdG9vbF9Db25maWdzOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIGRvbmUKCQkJbGV0IHRjb25mID0gKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmIGMubm9kZSAmJiBjLm5vZGUuY29kZSA9PSBuSUQpLmNvbmNhdCgob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgIWMubm9kZSkpOwoJCQlpZiAodGNvbmYubGVuZ3RoKSB7CgkJCQlyZXQgPSB0Y29uZlswXS52YWx1ZTsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoamV4KSB7fQoJCQl9CgoJCQkvLyBtb2RlbCBDb25maWc6IENvbmZpZyBpcyBjbGFzcyBsZXZlbCwgbm9kZSBub3QgcG9zc2libGUgLSBwZW5kaW5nCgkJCWxldCBtY29uZiA9IHRoaXMuQ29uZmlnID8gdGhpcy5Db25maWdbbl0gOiB1bmRlZmluZWQ7CgkJCWlmICh0eXBlb2YobWNvbmYpICE9PSAidW5kZWZpbmVkIikgcmV0ID0gbWNvbmY7CgoJCQkvLyBjb21tYW5kIGxpbmU6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnICYmIGdsb2JhbC5taW5pbWlzdCkgewoJCQkJcmV0ID0gZ2xvYmFsLm1pbmltaXN0KHByb2Nlc3MuYXJndi5zbGljZSgyKSlbbl0gfHwgcmV0OwoJCQl9CgoJCQkvLyByZXF1ZXN0OiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJcmV0ID0gdGhpcy4kX1JFUVVFU1QobikgfHwgcmV0OwoKCQkJaWYgKG9wdGlvbnMubmV3VmFsdWUpIHsKCQkJCWxldCB0YyA9IHRjb25mLmxlbmd0aCA/IHRjb25mWzBdIDoge307CgkJCQl0Yy5ub2RlID0gewoJCQkJCWNvZGU6IG9wdGlvbnMubm9kZS5jb2RlKCkKCQkJCX07CgkJCQl0Yy52YWx1ZSA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCQl0Yy5uYW1lID0gbjsKCQkJCWlmICghdGNvbmYubGVuZ3RoKSB7CgkJCQkJb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncy5wdXNoKHRjKTsKCQkJCX0KCQkJCXJldCA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCX0KCgkJCS8vIGNvbmZpZyByZXBsYWNlbWVudAoJCQlpZiAodHlwZW9mKHJldCkgPT09ICdzdHJpbmcnKShyZXQubWF0Y2gobmV3IFJlZ0V4cChge3soW159XSspfX1gLCAiZyIpKSB8fCBbXSkuZm9yRWFjaChtID0+IHJldCA9IHJldC5yZXBsYWNlKG0sIHRoaXMuX19jb25maWcobS5yZXBsYWNlKCd7eycsICcnKS5yZXBsYWNlKCd9fScsICcnKSwgbnVsbCwgb3B0aW9ucykpKTsKCgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19jb25maWcnLCAnRW50aXR5T2JqZWN0JywgMSwgbiwgbnVsbFZhbHVlLCBvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLCBleCk7CgkJfQoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgYAoJCX07CgkJcmV0LnNxbCArPSAnLypHcm91cCovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJvcGVuSW5jaWRlbnRUaHJlYXNob2xkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQlncm91cF9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cF9Hcm91cHMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQkJZ3JvdXBfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwX0dyb3VwcycsIHVuZGVmaW5lZCkpID0+IG9iai5zcWwgPSB2Lm1hcChfdiA9PiBfdi5fdG9TUUxUYWJsZSgpKSArIG9iai5zcWwsCgoJCX0sICJfdG9TUUxUYWJsZSIpOwoKCQkvLyByZXQuc3FsICs9ICcvKkdyb3VwKi8pO1xuJzsKCgkJcmV0LnNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQocmV0LnNxbCkgOiByZXQuc3FsOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TUUxUYWJsZScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQuc3FsKTsKCQlyZXR1cm4gcmV0LnNxbDsKCX0KCglfZnJvbVNRTFRhYmxlKHRhYmxlLCBmaWVsZHMpIHsKCQkvLyB0YWJsZSBpcyBhIGpzb24gYXJyYXkKCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9wZW5JbmNpZGVudFRocmVhc2hvbGQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9wZW5JbmNpZGVudFRocmVhc2hvbGQodGFibGVbIm9wZW5JbmNpZGVudFRocmVhc2hvbGQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5hY3RpdmUodGFibGVbImFjdGl2ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5lbmFibGVkKHRhYmxlWyJlbmFibGVkIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvZGUodGFibGVbImNvZGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9yZGVyKHRhYmxlWyJvcmRlciJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5kYXRlKHRhYmxlWyJkYXRlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm5hbWUodGFibGVbIm5hbWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5yZW1hcmsodGFibGVbInJlbWFyayJdKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIF9zcWwoc3FsLCBzb3VyY2UgPSB0aGlzKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWwoc3FsLCB0aGlzKTsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgoJCQkJCS8vIGlmKHRoaXNbJ18nK2ZpZWxkKydfc2V0J10gJiYgKHR5cGVvZih0aGlzWydfJytmaWVsZF0pPT09J3VuZGVmaW5lZCcgfHwgdGhpc1snXycrZmllbGRdPT1udWxsKSkgcmV0dXJuOwoJCQkJCS8vIGlmKHR5cGVvZihlYU9iaik9PT0ndW5kZWZpbmVkJykgcmV0dXJuOyAvLyB3aHk/CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlyZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoIm9wZW5JbmNpZGVudFRocmVhc2hvbGQiLCBvYmosIHRoaXMub3BlbkluY2lkZW50VGhyZWFzaG9sZCgpKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqLCB0aGlzLmNvZGUoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmosIHRoaXMuZGF0ZSgpKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmosIHRoaXMubmFtZSgpKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaiwgdGhpcy5yZW1hcmsoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI1MzFkMzc1Ni1mNjJhLTQyMzQtYjk2ZC04MDQ4MzYyMmIyMjEiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXAgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiBvYmosCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIG9iaiwgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIl9USElTIiwgb2JqLCB0aGlzLl9USElTKTsKCgkJX29wdGlvbnMoImdyb3VwX0luY2lkZW50cyIsIG9iaiwgdGhpcy5ncm91cF9JbmNpZGVudHMoKSk7CgoJCV9vcHRpb25zKCJncm91cF9Hcm91cF9NZW1iZXJzIiwgb2JqLCB0aGlzLmdyb3VwX0dyb3VwX01lbWJlcnMoKSk7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ2dyb3VwX0luY2lkZW50cycsICdncm91cF9Hcm91cF9NZW1iZXJzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJHcm91cCIgJiYgKG0udGFyZ2V0IHx8IG0ub3V0U2NyaXB0KSAmJiBtLmFjdGl2ZSAmJiBtLmVuYWJsZWQgJiYgKChtLnRvb2wgJiYgbS50b29sLm5hbWUgPT0gdGhpcy5Ub29sLm5hbWUpIHx8IChtLnR5cGUgJiYgbS50eXBlLm5hbWUgPT0gdGhpcy5Ub29sLnR5cGUubmFtZSkpICYmICghbS5zb3VyY2UgfHwgKG0uc291cmNlICYmIC8qIW0ub3V0U2NyaXB0ICYmKi8gdGhpc1snXycgKyBtLnNvdXJjZSArICdfc2V0J10pKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLm91dFNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcywgb1Njb3BlLCBtYXApID0+IHske20ub3V0U2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20ub3V0U2NyaXB0fSl9YCkodGhpcywgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0uc291cmNlKSB7CgkJCQlpZiAobS5zb3VyY2UuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzKSA9PiB7cmV0dXJuIF90aGlzLiR7bS5zb3VyY2V9O31gKSh0aGlzKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0uc291cmNlLCB0aGlzKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS50YXJnZXQpIG9ialttLnRhcmdldF0gPSByZXQ7CgkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCVttLnRhcmdldCB8fCBtLnNvdXJjZV06IHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXQoJCQl9KTsKCQl9KTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQkvLyB1c2UgdGhpcy5fbWFwKCkgd2l0aCByZXZlcnNlCgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJvcGVuSW5jaWRlbnRUaHJlYXNob2xkIiwgb2JqKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmopOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiNTMxZDM3NTYtZjYyYS00MjM0LWI5NmQtODA0ODM2MjJiMjIxIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cCB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoImdyb3VwX0luY2lkZW50cyIsIG9iaik7CgoJCV9vcHRpb25zKCJncm91cF9Hcm91cF9NZW1iZXJzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnZ3JvdXBfSW5jaWRlbnRzJywgJ2dyb3VwX0dyb3VwX01lbWJlcnMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIkdyb3VwIiAmJiAobS5zb3VyY2UgfHwgbS5pblNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLmluU2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaiwgb1Njb3BlLCBtYXApID0+IHske20uaW5TY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5pblNjcmlwdH0pfWApKG9iaiwgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0udGFyZ2V0KSB7CgkJCQlpZiAobS50YXJnZXQuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaikgPT4ge3JldHVybiBvYmouJHttLnRhcmdldH07fWApKG9iaik7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmpbbS50YXJnZXRdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS50YXJnZXQsIG9iaik7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS5zb3VyY2UpIHsKCQkJCWlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0ocmV0KTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0gPSByZXQ7CgkJCQl9CgkJCX0KCQl9KTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXTogIiciICsgdGhpcy5JZCArICInIgoJCX07CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3BlbkluY2lkZW50VGhyZWFzaG9sZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9wZW5JbmNpZGVudFRocmVhc2hvbGQoKTsKCgkJCWZWYWx1ZSA9IHYgfHwgJzAnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcGVuSW5jaWRlbnRUaHJlYXNob2xkJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2FjdGl2ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hY3RpdmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9lbmFibGVkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY29kZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jb2RlKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fb3JkZXJfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMub3JkZXIoKTsKCgkJCWZWYWx1ZSA9IHYgfHwgJzAnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZGF0ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5kYXRlKCk7CgoJCQl0cnkgewoJCQkJZlZhbHVlID0gIiciICsgKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiAiMTk3MC0xLTEiKSArICInIjsKCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJykgewoJCQkJCWZWYWx1ZSA9IGBTVFJfVE9fREFURSgke2ZWYWx1ZX0sICclWS0lbS0lZFQlVC4lZlonKWA7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9ICdkYXRldGltZSgnICsgZlZhbHVlICsgJyknOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9uYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm5hbWUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcmVtYXJrX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnJlbWFyaygpOwoKCQkJZlZhbHVlID0gIiciICsgKCh2ICYmIHYucmVwbGFjZSkgPyB2LnJlcGxhY2UoL1wnL2csICJcJ1wnIikgOiB2KSArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJyB8fCB0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIHsKCQkJX28gPSBfcSA9ICdgJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3Fsc2VydmVyJykgewoJCQlfbyA9ICdbJzsKCQkJX3EgPSAnXSc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCdhcGlLZXknKSA9PSAnYWlydGFibGUnKSB7CgkJCV9vID0gJ3snOwoJCQlfcSA9ICd9JzsKCQl9CgkJdGhpcy5fX1EgPSB0aGlzLl9fUSA9PSBfbyA/IF9xIDogX287CgkJcmV0dXJuIHRoaXMuX19ROwoJfQoKCV9maWVsZEdyb3VwcyhmZ3MgPSB7fSkgewoJCXRoaXMuX19maWVsZEdyb3VwcyA9IGZnczsKCQlyZXR1cm4gdGhpczsKCX0KCglfZmllbGRBZ2dyZWdhdGVzKGZhcyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkQWdncmVnYXRlcyA9IGZhczsKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9GaWVsZHNTUUwoZmllbGRzKSB7CgoJCWZpZWxkcyA9IGZpZWxkcyB8fCBbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJywgdGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKV07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9wZW5JbmNpZGVudFRocmVhc2hvbGQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcGVuSW5jaWRlbnRUaHJlYXNob2xkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX1gKTsKCgkJfQoJCXJldHVybiBmaWVsZHM7Cgl9CgoJX2Zyb21EQk9iamVjdChyID0ge30pIHsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5fX2ltcG9ydChyLCB7CgkJCQlJZDogb2JqID0+IHRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ10sCgoJCQkJb3BlbkluY2lkZW50VGhyZWFzaG9sZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb2RlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5kYXRlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5uYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucmVtYXJrKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlOdWxsOiB0cnVlLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoJCXNxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsKCgkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpIHsKCQkJLy8ge2ZpZWxkOiBmdW5jdGlvbn0KCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9wZW5JbmNpZGVudFRocmVhc2hvbGQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9wZW5JbmNpZGVudFRocmVhc2hvbGR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJb3BlbkluY2lkZW50VGhyZWFzaG9sZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvZGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2RhdGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVtYXJrX3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlncm91cF9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cF9Hcm91cHMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2dyb3VwX0luY2lkZW50c19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoImdyb3VwLmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9ncm91cF9JbmNpZGVudHNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX2dyb3VwX0luY2lkZW50c19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9ncm91cF9JbmNpZGVudHNfY29vcCA9PSAnPScgfHwgdGhpcy5fZ3JvdXBfSW5jaWRlbnRzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fZ3JvdXBfSW5jaWRlbnRzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKmdyb3VwX0luY2lkZW50cyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJCWdyb3VwX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cF9Hcm91cHMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJncm91cC5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVyc19jb29wID09ICchPScgfHwgdGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVyc19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKmdyb3VwX0dyb3VwX01lbWJlcnMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCX0sICJfdG9TZWxlY3RTUUwiLCBmaWVsZHMpLnNxbDsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQlpZiAoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9wZW5JbmNpZGVudFRocmVhc2hvbGQpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm9wZW5JbmNpZGVudFRocmVhc2hvbGR9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJZ3JvdXBfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXBfR3JvdXBzJywgdW5kZWZpbmVkKSkgPT4gb2JqLmdyb3VwX0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQkJZ3JvdXBfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwX0dyb3VwcycsIHVuZGVmaW5lZCkpID0+IG9iai5ncm91cF9Hcm91cF9NZW1iZXJzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuR3JvdXApIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuR3JvdXAgPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgc3FsID0gbmV3IHNhbGVzbm93Lkdyb3VwKCkKCgkJCQkJLmdyb3VwX0luY2lkZW50cyhuZXcgc2FsZXNub3cuSW5jaWRlbnQoKSkKCgkJCQkJLmdyb3VwX0dyb3VwX01lbWJlcnMobmV3IHNhbGVzbm93Lkdyb3VwX01lbWJlcigpKQoKCQkJCQkuX3RvU1FMVGFibGUoZGVwdGgpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQkJCWF3YWl0IHRoaXMuX3NxbChzcWwpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiR3JvdXAiKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJb3BlbkluY2lkZW50VGhyZWFzaG9sZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3BlbkluY2lkZW50VGhyZWFzaG9sZCA9IHYgPT0gcXVlcnkub3BlbkluY2lkZW50VGhyZWFzaG9sZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX3NldCAmJiAhcXVlcnkuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9wZW5JbmNpZGVudFRocmVhc2hvbGQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9zZXQgJiYgcXVlcnkuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcGVuSW5jaWRlbnRUaHJlYXNob2xkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWFjdGl2ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouYWN0aXZlID0gdiA9PSBxdWVyeS5hY3RpdmUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fYWN0aXZlX3NldCAmJiAhcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2FjdGl2ZV9zZXQgJiYgcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5lbmFibGVkID0gdiA9PSBxdWVyeS5lbmFibGVkKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ICYmICFxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9lbmFibGVkX3NldCAmJiBxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY29kZSA9IHYgPT0gcXVlcnkuY29kZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jb2RlX3NldCAmJiAhcXVlcnkuX2NvZGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY29kZV9zZXQgJiYgcXVlcnkuX2NvZGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vcmRlciA9IHYgPT0gcXVlcnkub3JkZXIoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fb3JkZXJfc2V0ICYmICFxdWVyeS5fb3JkZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX29yZGVyX3NldCAmJiBxdWVyeS5fb3JkZXJfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5kYXRlID0gdiA9PSBxdWVyeS5kYXRlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2RhdGVfc2V0ICYmICFxdWVyeS5fZGF0ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9kYXRlX3NldCAmJiBxdWVyeS5fZGF0ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubmFtZSA9IHYgPT0gcXVlcnkubmFtZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9uYW1lX3NldCAmJiAhcXVlcnkuX25hbWVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbmFtZV9zZXQgJiYgcXVlcnkuX25hbWVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gZmFsc2U7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucmVtYXJrID0gdiA9PSBxdWVyeS5yZW1hcmsoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcmVtYXJrX3NldCAmJiAhcXVlcnkuX3JlbWFya19zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3JlbWFya19zZXQgJiYgcXVlcnkuX3JlbWFya19zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IGZhbHNlOwoJCQkJfSwKCgkJCQlncm91cF9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouZ3JvdXBfSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gcXVlcnkuZ3JvdXBfSW5jaWRlbnRzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQkJZ3JvdXBfR3JvdXBfTWVtYmVyczogKG9iaiwgdikgPT4gewoJCQkJCW9iai5ncm91cF9Hcm91cF9NZW1iZXJzID0gdi5tYXAoX3YgPT4gcXVlcnkuZ3JvdXBfR3JvdXBfTWVtYmVycygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJZ3JvdXBfSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmdyb3VwX0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQkJZ3JvdXBfR3JvdXBfTWVtYmVyczogKG9iaiwgdikgPT4gewoJCQkJCW9iai5ncm91cF9Hcm91cF9NZW1iZXJzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJZ3JvdXBfSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuZ3JvdXBfSW5jaWRlbnRzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCWdyb3VwX0dyb3VwX01lbWJlcnM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5ncm91cF9Hcm91cF9NZW1iZXJzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ107CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJb3BlbkluY2lkZW50VGhyZWFzaG9sZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpIDogIm9wZW5JbmNpZGVudFRocmVhc2hvbGQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3BlbkluY2lkZW50VGhyZWFzaG9sZChyZWYpOwoKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvZGUocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kYXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoJCQkJCWlmICh0eXBlb2YobW9tZW50KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZWYgPSBuZXcgRGF0ZShyZWYpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmVmID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpKTsKCQkJCX0KCQkJCXRoaXMuZGF0ZShyZWYpOwoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm5hbWUocmVmKTsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZW1hcmtfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnJlbWFyayhyZWYpOwoKCQkJfSwKCgkJCWdyb3VwX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2dyb3VwX0dyb3VwcycsIHVuZGVmaW5lZCkgOiAiZ3JvdXBfSW5jaWRlbnRzIikpID0+IHRoaXMuZ3JvdXBfSW5jaWRlbnRzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5JbmNpZGVudCgpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQkJZ3JvdXBfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2dyb3VwX0dyb3VwcycsIHVuZGVmaW5lZCkgOiAiZ3JvdXBfR3JvdXBfTWVtYmVycyIpKSA9PiB0aGlzLmdyb3VwX0dyb3VwX01lbWJlcnMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93Lkdyb3VwX01lbWJlcigpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQl9LCAiX2Zyb21Eb2N1bWVudCIpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSB7CgkJbGV0IHJldCA9IHt9OwoKCQlpZiAoIWJUb29sKSB7CgkJCXJldC5fX2dlbmVyYXRlZCA9IG5ldyBEYXRlKCk7CgkJCWlmICh0aGlzLlRvb2wubmFtZSkgewoJCQkJcmV0Ll9fdG9vbCA9IHsKCQkJCQluYW1lOiB0aGlzLlRvb2wubmFtZSwKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlpZiAoc2FsZXNub3cuX25vZGUpIHsKCQkJCXJldC5fX25vZGUgPSB7CgkJCQkJY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogYkZ1bGwsCgkJCU51bGw6IGJOdWxsLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXSA9IHYsCgoJCQkib3BlbkluY2lkZW50VGhyZWFzaG9sZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcGVuSW5jaWRlbnRUaHJlYXNob2xkJywgdW5kZWZpbmVkKSA6ICJvcGVuSW5jaWRlbnRUaHJlYXNob2xkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCWdyb3VwX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2dyb3VwX0dyb3VwcycsIHVuZGVmaW5lZCkgOiAiZ3JvdXBfSW5jaWRlbnRzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX2dyb3VwX0luY2lkZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZ3JvdXBfSW5jaWRlbnRzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQlncm91cF9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXBfR3JvdXBzJywgdW5kZWZpbmVkKSA6ICJncm91cF9Hcm91cF9NZW1iZXJzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gZmFsc2U7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lkdyb3VwLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5Hcm91cChudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuY29kZSh0aGlzLmNvZGUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBGaW5pc2hlZCBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0gSWQ9WyR7dGhpcy5JZH1dYCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fZ3JvdXBfSW5jaWRlbnRzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuZ3JvdXBfSW5jaWRlbnRzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICh0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuZ3JvdXBfR3JvdXBfTWVtYmVycygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lkdyb3VwLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lkdyb3VwLnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvVXBkYXRlU1FMKCkpOwoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKCkpOwoJCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0WzBdOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Hcm91cC5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSAoYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgKTsKCQkJCXJldCA9IHJldCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5Hcm91cChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93Lkdyb3VwX01lbWJlciA9IGNsYXNzIEdyb3VwX01lbWJlciBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFpZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzSWtkcGRFaDFZaUpkYCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJncm91cCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZ3JvdXAoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJ1c2VyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl91c2VyKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiR3JvdXAgTWVtYmVyIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQlyZXR1cm4gdGhpczsKCgkJaWYgKHRoaXMuX2dyb3VwX3NldCAmJiB0aGlzLl9ncm91cCkgdGhpcy5fZ3JvdXAuVG9vbCA9IHRvb2w7CgoJCWlmICh0aGlzLl91c2VyX3NldCAmJiB0aGlzLl91c2VyKSB0aGlzLl91c2VyLlRvb2wgPSB0b29sOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXAgKiovCglncm91cCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2dyb3VwX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZ3JvdXAiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc1MzFkMzc1Ni1mNjJhLTQyMzQtYjk2ZC04MDQ4MzYyMmIyMjEnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdHcm91cCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdncm91cCcsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjUzMWQzNzU2LWY2MmEtNDIzNC1iOTZkLTgwNDgzNjIyYjIyMSIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJHcm91cCIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9ncm91cCAhPSB2KSB7CgkJCQl0aGlzLl9ncm91cF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dyb3VwJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9ncm91cCA/IHRoaXMuX2dyb3VwLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9ncm91cF9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fZ3JvdXAgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZ3JvdXApOwoJCX0KCX0KCgljbGVhcl9ncm91cCgpIHsKCQl0aGlzLl9ncm91cF9zZXQgPSBudWxsOwoJCXRoaXMuX2dyb3VwID0gbnVsbDsKCQl0aGlzLl9ncm91cF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXAgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB1c2VyICoqLwoJdXNlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3VzZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJ1c2VyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnZjU4N2RiYTQtNzFiNS00NGUxLWE0MmMtNTU3ZjUwYTM3MTU1JyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnVXNlcicpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1c2VyJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiZjU4N2RiYTQtNzFiNS00NGUxLWE0MmMtNTU3ZjUwYTM3MTU1IiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIlVzZXIiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fdXNlciAhPSB2KSB7CgkJCQl0aGlzLl91c2VyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXNlcicsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fdXNlciA/IHRoaXMuX3VzZXIuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX3VzZXJfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX3VzZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fdXNlcik7CgkJfQoJfQoKCWNsZWFyX3VzZXIoKSB7CgkJdGhpcy5fdXNlcl9zZXQgPSBudWxsOwoJCXRoaXMuX3VzZXIgPSBudWxsOwoJCXRoaXMuX3VzZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHVzZXIgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9ncm91cF9zZXQsCgoJCQl0aGlzLl91c2VyX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX2dyb3VwX3NldCA9IHRoaXMuX2dyb3VwX3NldDsKCQlyZXQuX2dyb3VwX2Nvb3AgPSB0aGlzLl9ncm91cF9jb29wOwoJCXJldC5ncm91cCA9IHRoaXMuZ3JvdXAoKSA/IHRoaXMuZ3JvdXAoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5ncm91cCgpOwoKCQlyZXQuX3VzZXJfc2V0ID0gdGhpcy5fdXNlcl9zZXQ7CgkJcmV0Ll91c2VyX2Nvb3AgPSB0aGlzLl91c2VyX2Nvb3A7CgkJcmV0LnVzZXIgPSB0aGlzLnVzZXIoKSA/IHRoaXMudXNlcigpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLnVzZXIoKTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkiZ3JvdXAiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJ1c2VyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJncm91cCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgZ3JvdXAnLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93Lkdyb3VwKCkuZ3JvdXBfR3JvdXBfTWVtYmVycyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInVzZXIiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIHVzZXInLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93LlVzZXIoKS51c2VyX0dyb3VwX01lbWJlcnModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCAmJiBldmVudC5jbGFzc05hbWUoKSAmJiBldmVudC5jbGFzc05hbWUoKSAhPSAnR3JvdXBfTWVtYmVyJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL0dyb3VwX01lbWJlci8ke21ldGhvZH1gLCBkYXRhLCBjb25maWcpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQl9CgkJfSBlbHNlIHsKCgkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMuX19nZW5lcmF0ZWQ7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMub25saW5lOwoKCQkJfQoKCQkJLy93aHkgZG8gd2UgbmVlZCB0aGlzPz8/CgoJCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQkJdHJ5IHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHttZXRob2R9YCk7CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJbGV0IF9pZCA9IG51bGw7CgkJCQlpZiAodHlwZW9mKGRhdGEpID09PSAndW5kZWZpbmVkJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIGRhdGEsIG1ldGhvZCwge30pOwoJCQkJCXJldHVybiBkYXRhOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoZGF0YSkgPT09ICdzdHJpbmcnKSB7CgkJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShkYXRhKTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gZGF0YS5fX3RoaXMuY29kZSB8fCBkYXRhLmlkIHx8IGRhdGEuSUQ7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQkJaWYgKGRhdGEuSWQgJiYgZGF0YS5JZCA9PSBkYXRhLklkKSB7CgkJCQkJCV9pZCA9IGRhdGEuSWQ7CgkJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCQl9IGVsc2UgaWYgKGRhdGEuRW50aXR5Q2xhc3MpIHsKCQkJCQkJX2lkID0gZGF0YS5FbnRpdHlDbGFzcy5JZCB8fCBkYXRhLkVudGl0eUNsYXNzLk5hbWU7CgkJCQkJfSBlbHNlIHsKCQkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiZGY1OTMzMmMtODEyZS00OWE5LWFlNDYtMjkyMjljZTQ2YjJiIiB8fCAiTlVMTCI7CgkJCQkJfQoJCQkJfQoKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXIgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlciB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyW21ldGhvZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlclttZXRob2RdIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbbWV0aG9kXVtfaWRdIHx8IHt9OwoKCQkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaCh7fSwgewoJCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCQl9KTsKCgkJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbbWV0aG9kXVtfaWRdW19oYXNoXTsKCQkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogNSkpIHsKCQkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIG1ldGhvZCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCQl2LnJldXNlZCsrOwoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0KCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSk7CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlclttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnR3JvdXBfTWVtYmVyJykuc2VuZGVyKHNhbGVzbm93Ll9ub2RlKS5jYXJyaWVyKHNhbGVzbm93Ll9ub2RlKS5wYXlsb2FkKGRhdGEpOwoJCQlpZiAoZXZlbnQpIHsKCQkJCWlmIChldmVudC5fcmVzcG9uc2VUb19zZXQpIGV2LnJlc3BvbnNlVG8oZXZlbnQucmVzcG9uc2VUbygpKTsKCQkJCWlmIChldmVudC5fc2VuZGVyX3NldCkgZXYuc2VuZGVyKGV2ZW50LnNlbmRlcigpKTsKCQkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCkgZXYuY2xhc3NOYW1lKGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCWlmIChldmVudC5fY2Fycmllcl9zZXQgfHwgZXZlbnQuX3NlbmRlcl9zZXQpIGV2LmNhcnJpZXIoZXZlbnQuY2FycmllcigpIHx8IGV2ZW50LnNlbmRlcigpKTsKCQkJfQoJCQlyZXQgPSBhd2FpdCBldi50cmlnZ2VyKCk7CgoJCQlpZiAodHlwZW9mKHJldCkgPT09ICJzdHJpbmciKSB7CgkJCQl0cnkgewoJCQkJCXJldCA9IEpTT04ucGFyc2UocmV0KTsKCQkJCX0gY2F0Y2ggKGV4KSB7fQoJCQl9CgkJCXJldHVybiByZXQ7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5zZXJ0IjoKCQkJY2FzZSAidXBkYXRlIjoKCQkJY2FzZSAic3RvcmUiOgoJCQljYXNlICJkZWxldGUiOgoJCQljYXNlICJmaW5kIjogewoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuR3JvdXBfTWVtYmVyKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuR3JvdXBfTWVtYmVyKCkuX2ludm9rZU5vZGUodG4sIG1ldGhvZCwgX3BhcmFtcyk7CgkJfQoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBHcm91cF9NZW1iZXIuX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBHcm91cF9NZW1iZXIuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyLl90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93Lkdyb3VwX01lbWJlci4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiR3JvdXAgTWVtYmVyIik7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCWlmICh0aGlzLl9ncm91cF9zZXQgJiYgdGhpcy5ncm91cCgpKSB0aGlzLmdyb3VwKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX3VzZXJfc2V0ICYmIHRoaXMudXNlcigpKSB0aGlzLnVzZXIoKS5fX3N5bmNfb24oZCk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93Lkdyb3VwX01lbWJlcih0aGlzLklkKQoKCQkJLmdyb3VwKHRoaXMuZ3JvdXAoKSwgdGhpcy5fZ3JvdXBfY29vcCkKCgkJCS51c2VyKHRoaXMudXNlcigpLCB0aGlzLl91c2VyX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQlvYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ0dyb3VwX01lbWJlcic7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIkdyb3VwX01lbWJlciI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgkJCQlyZXQgPSByZXQudG9Mb3dlckNhc2UoKTsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucyA9IHt9KSB7CgkJdHJ5IHsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sID8gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IG9wdGlvbnMudG9vbCB8fCB0ID09IG9wdGlvbnMudG9vbCkgOiB0aGlzLlRvb2w7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCB8fCB7fTsKCgkJCWxldCBuSUQgPSBzYWxlc25vdy5fbm9kZSA/IHNhbGVzbm93Ll9ub2RlLmNvZGUoKSA6ICJkZWZhdWx0IjsKCgkJCWxldCByZXQgPSBudWxsVmFsdWU7CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldCA9IG51bGw7CgoJCQkvLyB0b29sX0NvbmZpZ3M6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gZG9uZQoJCQlsZXQgdGNvbmYgPSAob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgYy5ub2RlICYmIGMubm9kZS5jb2RlID09IG5JRCkuY29uY2F0KChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiAhYy5ub2RlKSk7CgkJCWlmICh0Y29uZi5sZW5ndGgpIHsKCQkJCXJldCA9IHRjb25mWzBdLnZhbHVlOwoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChqZXgpIHt9CgkJCX0KCgkJCS8vIG1vZGVsIENvbmZpZzogQ29uZmlnIGlzIGNsYXNzIGxldmVsLCBub2RlIG5vdCBwb3NzaWJsZSAtIHBlbmRpbmcKCQkJbGV0IG1jb25mID0gdGhpcy5Db25maWcgPyB0aGlzLkNvbmZpZ1tuXSA6IHVuZGVmaW5lZDsKCQkJaWYgKHR5cGVvZihtY29uZikgIT09ICJ1bmRlZmluZWQiKSByZXQgPSBtY29uZjsKCgkJCS8vIGNvbW1hbmQgbGluZTogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgZ2xvYmFsLm1pbmltaXN0KSB7CgkJCQlyZXQgPSBnbG9iYWwubWluaW1pc3QocHJvY2Vzcy5hcmd2LnNsaWNlKDIpKVtuXSB8fCByZXQ7CgkJCX0KCgkJCS8vIHJlcXVlc3Q6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlyZXQgPSB0aGlzLiRfUkVRVUVTVChuKSB8fCByZXQ7CgoJCQlpZiAob3B0aW9ucy5uZXdWYWx1ZSkgewoJCQkJbGV0IHRjID0gdGNvbmYubGVuZ3RoID8gdGNvbmZbMF0gOiB7fTsKCQkJCXRjLm5vZGUgPSB7CgkJCQkJY29kZTogb3B0aW9ucy5ub2RlLmNvZGUoKQoJCQkJfTsKCQkJCXRjLnZhbHVlID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJCXRjLm5hbWUgPSBuOwoJCQkJaWYgKCF0Y29uZi5sZW5ndGgpIHsKCQkJCQlvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLnB1c2godGMpOwoJCQkJfQoJCQkJcmV0ID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJfQoKCQkJLy8gY29uZmlnIHJlcGxhY2VtZW50CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3N0cmluZycpKHJldC5tYXRjaChuZXcgUmVnRXhwKGB7eyhbXn1dKyl9fWAsICJnIikpIHx8IFtdKS5mb3JFYWNoKG0gPT4gcmV0ID0gcmV0LnJlcGxhY2UobSwgdGhpcy5fX2NvbmZpZyhtLnJlcGxhY2UoJ3t7JywgJycpLnJlcGxhY2UoJ319JywgJycpLCBudWxsLCBvcHRpb25zKSkpOwoKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2NvbmZpZycsICdFbnRpdHlPYmplY3QnLCAxLCBuLCBudWxsVmFsdWUsIG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MsIGV4KTsKCQl9Cgl9CgoJX3RvU1FMVGFibGUoKSB7CgkJbGV0IHJldCA9IHsKCQkJc3FsOiBgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoCiAgICAgICAgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVkKICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qR3JvdXBfTWVtYmVyKi8pO1xuJzsKCgkJcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogdHJ1ZSwKCQkJTnVsbDogdHJ1ZSwKCQkJLy9JZDogKG9iaiwgdikgPT4gb2JqLnNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVlgLAoKCQkJImdyb3VwIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJ1c2VyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndXNlcicsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCX0sICJfdG9TUUxUYWJsZSIpOwoKCQkvLyByZXQuc3FsICs9ICcvKkdyb3VwX01lbWJlciovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJncm91cCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZ3JvdXAodGFibGVbImdyb3VwIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInVzZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnVzZXIodGFibGVbInVzZXIiXSk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBfc3FsKHNxbCwgc291cmNlID0gdGhpcykgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsKHNxbCwgdGhpcyk7CgoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJCQkvLyBpZih0aGlzWydfJytmaWVsZCsnX3NldCddICYmICh0eXBlb2YodGhpc1snXycrZmllbGRdKT09PSd1bmRlZmluZWQnIHx8IHRoaXNbJ18nK2ZpZWxkXT09bnVsbCkpIHJldHVybjsKCQkJCQkvLyBpZih0eXBlb2YoZWFPYmopPT09J3VuZGVmaW5lZCcpIHJldHVybjsgLy8gd2h5PwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJkZjU5MzMyYy04MTJlLTQ5YTktYWU0Ni0yOTIyOWNlNDZiMmIiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXIgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlpZiAoIXRoaXMuZ3JvdXAoKSB8fCAodGhpcy5ncm91cCgpCgoJCQkJJiYKCQkJCSF0aGlzLmdyb3VwKCkuZ3JvdXBfSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmdyb3VwKCkuZ3JvdXBfR3JvdXBfTWVtYmVycygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygiZ3JvdXAiLCBvYmosIHRoaXMuZ3JvdXAoKSk7CgkJfQoKCQlpZiAoIXRoaXMudXNlcigpIHx8ICh0aGlzLnVzZXIoKQoKCQkJCSYmCgkJCQkhdGhpcy51c2VyKCkubWFuYWdlcl9EZXBhcnRtZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy51c2VyKCkuY2FsbGVyX0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy51c2VyKCkuY29udGFjdF9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMudXNlcigpLnVzZXJfR3JvdXBfTWVtYmVycygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygidXNlciIsIG9iaiwgdGhpcy51c2VyKCkpOwoJCX0KCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnZ3JvdXAnLCAndXNlciddKS5jb25jYXQoWycnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIkdyb3VwX01lbWJlciIgJiYgKG0udGFyZ2V0IHx8IG0ub3V0U2NyaXB0KSAmJiBtLmFjdGl2ZSAmJiBtLmVuYWJsZWQgJiYgKChtLnRvb2wgJiYgbS50b29sLm5hbWUgPT0gdGhpcy5Ub29sLm5hbWUpIHx8IChtLnR5cGUgJiYgbS50eXBlLm5hbWUgPT0gdGhpcy5Ub29sLnR5cGUubmFtZSkpICYmICghbS5zb3VyY2UgfHwgKG0uc291cmNlICYmIC8qIW0ub3V0U2NyaXB0ICYmKi8gdGhpc1snXycgKyBtLnNvdXJjZSArICdfc2V0J10pKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLm91dFNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcywgb1Njb3BlLCBtYXApID0+IHske20ub3V0U2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20ub3V0U2NyaXB0fSl9YCkodGhpcywgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0uc291cmNlKSB7CgkJCQlpZiAobS5zb3VyY2UuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzKSA9PiB7cmV0dXJuIF90aGlzLiR7bS5zb3VyY2V9O31gKSh0aGlzKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0uc291cmNlLCB0aGlzKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS50YXJnZXQpIG9ialttLnRhcmdldF0gPSByZXQ7CgkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCVttLnRhcmdldCB8fCBtLnNvdXJjZV06IHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXQoJCQl9KTsKCQl9KTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQkvLyB1c2UgdGhpcy5fbWFwKCkgd2l0aCByZXZlcnNlCgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiZGY1OTMzMmMtODEyZS00OWE5LWFlNDYtMjkyMjljZTQ2YjJiIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlciA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiZ3JvdXAiLCBvYmopOwoKCQlfb3B0aW9ucygidXNlciIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2dyb3VwJywgJ3VzZXInXSkuY29uY2F0KFsnJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJHcm91cF9NZW1iZXIiICYmIChtLnNvdXJjZSB8fCBtLmluU2NyaXB0KSAmJiBtLmFjdGl2ZSAmJiBtLmVuYWJsZWQgJiYgKChtLnRvb2wgJiYgbS50b29sLm5hbWUgPT0gdGhpcy5Ub29sLm5hbWUpIHx8IChtLnR5cGUgJiYgbS50eXBlLm5hbWUgPT0gdGhpcy5Ub29sLnR5cGUubmFtZSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0uaW5TY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAob2JqLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5pblNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLmluU2NyaXB0fSl9YCkob2JqLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS50YXJnZXQpIHsKCQkJCWlmIChtLnRhcmdldC5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAob2JqKSA9PiB7cmV0dXJuIG9iai4ke20udGFyZ2V0fTt9YCkob2JqKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKG9ialttLnRhcmdldF0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gb2JqW20udGFyZ2V0XSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnRhcmdldCwgb2JqKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gb2JqW20udGFyZ2V0XTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnNvdXJjZSkgewoJCQkJaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQl0aGlzW20uc291cmNlXShyZXQpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzW20uc291cmNlXSA9IHJldDsKCQkJCX0KCQkJfQoJCX0pOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9EQk9iamVjdChmaWVsZHMsIGJOb1JlZikgewoJCWlmICghdGhpcy5JZCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCAiSW52YWxpZCBJRCIsIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSwgdGhpcy5Ub29sKTsKCQl9CgkJbGV0IHJldCA9IHsKCQkJW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddOiAiJyIgKyB0aGlzLklkICsgIiciCgkJfTsKCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJncm91cCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9ncm91cF9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZ3JvdXAoKTsKCgkJCWlmICh2ICYmICh2Ll9fc3luY19vbigpIHx8IHYuSWQgPT0gdi5JZCkpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYuSWQgKyAiJyI7CgkJCX0gZWxzZSB7CgkJCQlmVmFsdWUgPSAwOwoJCQl9CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSArICJpZCJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJ1c2VyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3VzZXJfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnVzZXIoKTsKCgkJCWlmICh2ICYmICh2Ll9fc3luY19vbigpIHx8IHYuSWQgPT0gdi5JZCkpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYuSWQgKyAiJyI7CgkJCX0gZWxzZSB7CgkJCQlmVmFsdWUgPSAwOwoJCQl9CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX1EoKSB7CgkJbGV0IF9vID0gJyInOwoJCWxldCBfcSA9IF9vOwoKCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXRoaXMuX19RID0gdGhpcy5fX1EgPT0gX28gPyBfcSA6IF9vOwoJCXJldHVybiB0aGlzLl9fUTsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcsIHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkgKyAiLmlkIiwgdGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpICsgIi5pZCJdOwoJCWZpZWxkcyA9IEFycmF5LmlzQXJyYXkoZmllbGRzKSA/IGZpZWxkcyA6IFtmaWVsZHNdOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCS8vIHtmaWVsZDogb3JkZXJ9CgkJCWZpZWxkcyA9IFtdOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5ncm91cCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy51c2VyKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgndXNlcicsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJfQoJCXJldHVybiBmaWVsZHM7Cgl9CgoJX2Zyb21EQk9iamVjdChyID0ge30pIHsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5fX2ltcG9ydChyLCB7CgkJCQlJZDogb2JqID0+IHRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ10sCgoJCQkJZ3JvdXA6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmdyb3VwKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJdXNlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy51c2VyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlOdWxsOiB0cnVlLAoKCQkJZ3JvdXA6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93Lkdyb3VwKCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQl1c2VyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcicsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJfSwgIl90b1NlbGVjdEhlYWRlciIpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RIZWFkZXInLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9TZWxlY3RTUUwoZmllbGRzKSB7CgkJbGV0IHNxbCA9ICJzZWxlY3QgIjsKCgkJbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX1gOwoKCQlsZXQgaGVhZGVyID0gdGhpcy5fdG9TZWxlY3RIZWFkZXIoZmllbGRzKTsKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5ncm91cCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZ3JvdXB9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnVzZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnVzZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJZ3JvdXA6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZ3JvdXBfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9ncm91cF9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXVzZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl91c2VyX3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fdXNlcl9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b1NlbGVjdFNRTCIsIGZpZWxkcykuc3FsOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCWlmIChPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZ3JvdXApIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmdyb3VwfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnVzZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndXNlcicsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMudXNlcn1gOwoKCQl9CgoJCWlmIChzcWwuZW5kc1dpdGgoIndoZXJlIDE9MSIpKSB7CgkJCS8vIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEiLCAid2hlcmUgMT0wIik7CgkJfSBlbHNlIHsKCQkJc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSBhbmQgIiwgIndoZXJlICIpOwoJCX0KCgkJc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpIDogc3FsOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoKCQlyZXR1cm4gc3FsOwoJfQoKCV90b1BhdGhzKCkgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCV9USElTOiBvYmogPT4ge30sCgoJCQlncm91cDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gb2JqLmdyb3VwID0gdi5fdG9QYXRocygpLAoKCQkJdXNlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpKSA9PiBvYmoudXNlciA9IHYuX3RvUGF0aHMoKSwKCgkJfSwgIl90b1BhdGhzIik7CgkJLy8gcmV0dXJuIHJldDsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5tYXAoayA9PiAoewoJCQlba106IHJldFtrXQoJCX0pKTsKCX0KCglfdG9VcGRhdGVTUUwoZmllbGRzKSB7CgkJbGV0IHJldEZpZWxkcyA9IHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLmpvaW4oJywgJyk7CgkJbGV0IHNxbCA9IGB1cGRhdGUgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSBzZXQgYCArIE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvREJPYmplY3QoZmllbGRzKSkubWFwKHYgPT4gdGhpcy5fUSgpICsgdlswXSArIHRoaXMuX1EoKSArICI9IiArIHZbMV0pICsgYCB3aGVyZSAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgOyAvL2AgcmV0dXJuaW5nICR7cmV0RmllbGRzfWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvVXBkYXRlU1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfdG9JbnNlcnRTUUwoZmllbGRzKSB7CgkJbGV0IG9iaiA9IHRoaXMuX3RvREJPYmplY3QoZmllbGRzKTsKCQlsZXQgc3FsID0gYGluc2VydCBpbnRvICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKGAgKyBPYmplY3Qua2V5cyhvYmopLm1hcChrID0+IHRoaXMuX1EoKSArIGsgKyB0aGlzLl9RKCkpICsgIikgdmFsdWVzICgiICsgT2JqZWN0LnZhbHVlcyhvYmopICsgYClgOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0luc2VydFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5Hcm91cF9NZW1iZXIpIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuR3JvdXBfTWVtYmVyID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIoKQoKCQkJCQkuZ3JvdXAobmV3IHNhbGVzbm93Lkdyb3VwKCkpCgoJCQkJCS51c2VyKG5ldyBzYWxlc25vdy5Vc2VyKCkpCgoJCQkJCS5fdG9TUUxUYWJsZShkZXB0aCk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJHcm91cCBNZW1iZXIiKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJZ3JvdXA6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmdyb3VwID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5ncm91cCgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9ncm91cF9zZXQgJiYgIXF1ZXJ5Ll9ncm91cF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZ3JvdXAgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZ3JvdXBfc2V0ICYmIHF1ZXJ5Ll9ncm91cF9zZXQpIHx8CgoJCQkJCQkodGhpcy5ncm91cCgpICYmICF0aGlzLmdyb3VwKCkuX21hdGNoZXMocXVlcnkuZ3JvdXAoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmdyb3VwID0gZmFsc2U7CgkJCQl9LAoKCQkJCXVzZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnVzZXIgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LnVzZXIoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fdXNlcl9zZXQgJiYgIXF1ZXJ5Ll91c2VyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai51c2VyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3VzZXJfc2V0ICYmIHF1ZXJ5Ll91c2VyX3NldCkgfHwKCgkJCQkJCSh0aGlzLnVzZXIoKSAmJiAhdGhpcy51c2VyKCkuX21hdGNoZXMocXVlcnkudXNlcigpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudXNlciA9IGZhbHNlOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWdyb3VwOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgZ3JvdXAiKTsKCQkJCQlvYmouZ3JvdXAgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQl1c2VyOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgdXNlciIpOwoJCQkJCW9iai51c2VyID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fZ3JvdXBfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fdXNlcl9zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJZ3JvdXA6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5ncm91cChyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJdXNlcjogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLnVzZXIocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ107CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJZ3JvdXA6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkgOiAiZ3JvdXAiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZ3JvdXBfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMuZ3JvdXAoKSB8fCBuZXcgc2FsZXNub3cuR3JvdXAoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLmdyb3VwKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgZ3JvdXAiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCXVzZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd1c2VyJywgdW5kZWZpbmVkKSA6ICJ1c2VyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3VzZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMudXNlcigpIHx8IG5ldyBzYWxlc25vdy5Vc2VyKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy51c2VyKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgdXNlciIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQl9LCAiX2Zyb21Eb2N1bWVudCIpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSB7CgkJbGV0IHJldCA9IHt9OwoKCQlpZiAoIWJUb29sKSB7CgkJCXJldC5fX2dlbmVyYXRlZCA9IG5ldyBEYXRlKCk7CgkJCWlmICh0aGlzLlRvb2wubmFtZSkgewoJCQkJcmV0Ll9fdG9vbCA9IHsKCQkJCQluYW1lOiB0aGlzLlRvb2wubmFtZSwKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlpZiAoc2FsZXNub3cuX25vZGUpIHsKCQkJCXJldC5fX25vZGUgPSB7CgkJCQkJY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogYkZ1bGwsCgkJCU51bGw6IGJOdWxsLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXSA9IHYsCgoJCQkiZ3JvdXAiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpIDogImdyb3VwIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fZ3JvdXBfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2dyb3VwX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkidXNlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd1c2VyJywgdW5kZWZpbmVkKSA6ICJ1c2VyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fdXNlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fdXNlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJYnlHcm91cChhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfZ3JvdXAiXSAmJiAoYVsiX2dyb3VwIl0uRXF1YWxzID8gYVsiX2dyb3VwIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9ncm91cCJdLCByKSkpIHsKCQkJCQlyLl9ncm91cF9Hcm91cF9NZW1iZXJzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlVc2VyKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl91c2VyIl0gJiYgKGFbIl91c2VyIl0uRXF1YWxzID8gYVsiX3VzZXIiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX3VzZXIiXSwgcikpKSB7CgkJCQkJci5fdXNlcl9Hcm91cF9NZW1iZXJzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLklkOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlLl9wYXJlbnQpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuR3JvdXBfTWVtYmVyLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLmdyb3VwKHRoaXMuZ3JvdXAoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy51c2VyKHRoaXMudXNlcigpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24pID09PSAidW5kZWZpbmVkIiB8fCBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nQkVHSU4nOidTVEFSVCd9IFRSQU5TQUNUSU9OYCk7CgkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gPSB7CgkJCQkJCQlPd25lcjogdGhpcywKCQkJCQkJCXNxbHM6IFtdLAoJCQkJCQkJc3RhcnQ6IG5ldyBEYXRlKCksCgkJCQkJCQllbmQ6IG51bGwKCQkJCQkJfTsKCQkJCQl9CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9ncm91cF9zZXQgJiYgdGhpcy5ncm91cCgpICYmICEoYXdhaXQgdGhpcy5ncm91cCgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX2dyb3VwKCk7CgoJCQkJCWlmICh0aGlzLl91c2VyX3NldCAmJiB0aGlzLnVzZXIoKSAmJiAhKGF3YWl0IHRoaXMudXNlcigpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX3VzZXIoKTsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBGaW5pc2hlZCBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0gSWQ9WyR7dGhpcy5JZH1dYCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lkdyb3VwX01lbWJlci5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvSW5zZXJ0U1FMKCkpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnaW5zZXJ0JywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlLl9wYXJlbnQpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Hcm91cF9NZW1iZXIudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlLl9wYXJlbnQpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lkdyb3VwX01lbWJlci5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSAoYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgKTsKCQkJCXJldCA9IHJldCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoKCX0KCn07CgpzYWxlc25vdy5Mb2NhdGlvbiA9IGNsYXNzIExvY2F0aW9uIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUWlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUp6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpWYzJWeUlqcDdJbDloZFhSb2IzSnBlbVV1ZFhObGNtNWhiV1VpT2lKbVlXUnBJaXdpWDJGMWRHaHZjbWw2WlM1d1lYTnpkMjl5WkNJNklqRXlNeUlzSWw5aGRYUm9iM0pwZW1VdWRHVnpkRlZ6WlhJaU9uc2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0puWlc1a1pYSWlPbnNpWTI5a1pTSTZJazBpTENKdVlXMWxJam9pVFdGc1pTSjlMQ0pqYjJSbElqb2labUZrYVNJc0ltNWhiV1VpT2lKR1lXUnBJbjE5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpUY1d4RVFpSXNJa2RwZEVoMVlpSmRgKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLk1hcHBpbmdzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgVzEwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoKCQkvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUKCQl0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307CgkJdGhpcy5Ub29sID0gdG9vbDsKCQl0aGlzLklkID0gaWQ7CgoJCXRoaXMuVmFsdWVFbnRpdGllcyA9IFtdOwoKCQl0aGlzLkRhdGUgPSBudWxsOwoKCQl0aGlzLmNsZWFyX1RISVMoKTsKCQl0aGlzLkVudGl0eVZhbHVlcyA9IFtdOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfbG9jYXRpb25fSW5jaWRlbnRzKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiTG9jYXRpb24iLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCXJldHVybiB0aGlzOwoKCQkodGhpcy5sb2NhdGlvbl9JbmNpZGVudHMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbG9jYXRpb25fSW5jaWRlbnRzICoqLwoJbG9jYXRpb25fSW5jaWRlbnRzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzc0MDc5MzQ3LWNkYzItNGUwZS04ZGQyLWM5MWU1YzM4ZDAwZCcgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnSW5jaWRlbnQnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX2xvY2F0aW9uX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2xvY2F0aW9uX0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAibG9jYXRpb24gaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkluY2lkZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnbG9jYXRpb25fSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJsb2NhdGlvbiBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkluY2lkZW50Iik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LmxvY2F0aW9uKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX2xvY2F0aW9uX0luY2lkZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9sb2NhdGlvbl9JbmNpZGVudHMoKSB7CgkJdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX3NldCA9IG51bGw7CgkJdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbG9jYXRpb25fSW5jaWRlbnRzICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJCXRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0LmxvY2F0aW9uX0luY2lkZW50cyA9IHRoaXMubG9jYXRpb25fSW5jaWRlbnRzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQlsb2NhdGlvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdsb2NhdGlvbl9Mb2NhdGlvbnMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkgIT0gJ0xvY2F0aW9uJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL0xvY2F0aW9uLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7CgoJCQl9CgoJCQkvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8KCgkJCWxldCB2ID0gdW5kZWZpbmVkOwoJCQl0cnkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke21ldGhvZH1gKTsKCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQlsZXQgX2lkID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgZGF0YSwgbWV0aG9kLCB7fSk7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIHsKCQkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKGRhdGEpOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSBkYXRhLl9fdGhpcy5jb2RlIHx8IGRhdGEuaWQgfHwgZGF0YS5JRDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCQlpZiAoZGF0YS5JZCAmJiBkYXRhLklkID09IGRhdGEuSWQpIHsKCQkJCQkJX2lkID0gZGF0YS5JZDsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5FbnRpdHlDbGFzcykgewoJCQkJCQlfaWQgPSBkYXRhLkVudGl0eUNsYXNzLklkIHx8IGRhdGEuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI1NmZmZmMzNi1lMzBhLTRjYTEtYjM1My1kNGVjMTVkZWFhYTQiIHx8ICJOVUxMIjsKCQkJCQl9CgkJCQl9CgoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbiB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bbWV0aG9kXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvblttZXRob2RdW19pZF0gfHwge307CgoJCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKHt9LCB7CgkJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJCX0pOwoKCQkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvblttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnTG9jYXRpb24nKS5zZW5kZXIoc2FsZXNub3cuX25vZGUpLmNhcnJpZXIoc2FsZXNub3cuX25vZGUpLnBheWxvYWQoZGF0YSk7CgkJCWlmIChldmVudCkgewoJCQkJaWYgKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOwoJCQkJaWYgKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOwoJCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJaWYgKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOwoJCQl9CgkJCXJldCA9IGF3YWl0IGV2LnRyaWdnZXIoKTsKCgkJCWlmICh0eXBlb2YocmV0KSA9PT0gInN0cmluZyIpIHsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCX0KCQkJcmV0dXJuIHJldDsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5Mb2NhdGlvbihudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuTG9jYXRpb24obnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuTG9jYXRpb24oKS5faW52b2tlTm9kZSh0biwgbWV0aG9kLCBfcGFyYW1zKTsKCQl9CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYExvY2F0aW9uLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgTG9jYXRpb24uX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb24uX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuTG9jYXRpb24uJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIkxvY2F0aW9uIik7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCS8vIHRoaXMubG9jYXRpb25fTG9jYXRpb25zKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuTG9jYXRpb24odGhpcy5JZCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkubG9jYXRpb25fSW5jaWRlbnRzKHRoaXMubG9jYXRpb25fSW5jaWRlbnRzKCksIHRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCW9ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdMb2NhdGlvbic7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIkxvY2F0aW9uIjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCQkJCXJldCA9IHJldC50b0xvd2VyQ2FzZSgpOwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCQl0cnkgewoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgPyAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gb3B0aW9ucy50b29sIHx8IHQgPT0gb3B0aW9ucy50b29sKSA6IHRoaXMuVG9vbDsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sIHx8IHt9OwoKCQkJbGV0IG5JRCA9IHNhbGVzbm93Ll9ub2RlID8gc2FsZXNub3cuX25vZGUuY29kZSgpIDogImRlZmF1bHQiOwoKCQkJbGV0IHJldCA9IG51bGxWYWx1ZTsKCQkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0ID0gbnVsbDsKCgkJCS8vIHRvb2xfQ29uZmlnczogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBkb25lCgkJCWxldCB0Y29uZiA9IChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiBjLm5vZGUgJiYgYy5ub2RlLmNvZGUgPT0gbklEKS5jb25jYXQoKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmICFjLm5vZGUpKTsKCQkJaWYgKHRjb25mLmxlbmd0aCkgewoJCQkJcmV0ID0gdGNvbmZbMF0udmFsdWU7CgkJCQl0cnkgewoJCQkJCXJldCA9IEpTT04ucGFyc2UocmV0KTsKCQkJCX0gY2F0Y2ggKGpleCkge30KCQkJfQoKCQkJLy8gbW9kZWwgQ29uZmlnOiBDb25maWcgaXMgY2xhc3MgbGV2ZWwsIG5vZGUgbm90IHBvc3NpYmxlIC0gcGVuZGluZwoJCQlsZXQgbWNvbmYgPSB0aGlzLkNvbmZpZyA/IHRoaXMuQ29uZmlnW25dIDogdW5kZWZpbmVkOwoJCQlpZiAodHlwZW9mKG1jb25mKSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IG1jb25mOwoKCQkJLy8gY29tbWFuZCBsaW5lOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiBnbG9iYWwubWluaW1pc3QpIHsKCQkJCXJldCA9IGdsb2JhbC5taW5pbWlzdChwcm9jZXNzLmFyZ3Yuc2xpY2UoMikpW25dIHx8IHJldDsKCQkJfQoKCQkJLy8gcmVxdWVzdDogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCXJldCA9IHRoaXMuJF9SRVFVRVNUKG4pIHx8IHJldDsKCgkJCWlmIChvcHRpb25zLm5ld1ZhbHVlKSB7CgkJCQlsZXQgdGMgPSB0Y29uZi5sZW5ndGggPyB0Y29uZlswXSA6IHt9OwoJCQkJdGMubm9kZSA9IHsKCQkJCQljb2RlOiBvcHRpb25zLm5vZGUuY29kZSgpCgkJCQl9OwoJCQkJdGMudmFsdWUgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQkJdGMubmFtZSA9IG47CgkJCQlpZiAoIXRjb25mLmxlbmd0aCkgewoJCQkJCW9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MucHVzaCh0Yyk7CgkJCQl9CgkJCQlyZXQgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQl9CgoJCQkvLyBjb25maWcgcmVwbGFjZW1lbnQKCQkJaWYgKHR5cGVvZihyZXQpID09PSAnc3RyaW5nJykocmV0Lm1hdGNoKG5ldyBSZWdFeHAoYHt7KFtefV0rKX19YCwgImciKSkgfHwgW10pLmZvckVhY2gobSA9PiByZXQgPSByZXQucmVwbGFjZShtLCB0aGlzLl9fY29uZmlnKG0ucmVwbGFjZSgne3snLCAnJykucmVwbGFjZSgnfX0nLCAnJyksIG51bGwsIG9wdGlvbnMpKSk7CgoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fY29uZmlnJywgJ0VudGl0eU9iamVjdCcsIDEsIG4sIG51bGxWYWx1ZSwgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncywgZXgpOwoJCX0KCX0KCglfdG9TUUxUYWJsZSgpIHsKCQlsZXQgcmV0ID0gewoJCQlzcWw6IGBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9ICgKICAgICAgICAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICBgCgkJfTsKCQlyZXQuc3FsICs9ICcvKkxvY2F0aW9uKi8pO1xuJzsKCgkJcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogdHJ1ZSwKCQkJTnVsbDogdHJ1ZSwKCQkJLy9JZDogKG9iaiwgdikgPT4gb2JqLnNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVlgLAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCWxvY2F0aW9uX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2xvY2F0aW9uX0xvY2F0aW9ucycsIHVuZGVmaW5lZCkpID0+IG9iai5zcWwgPSB2Lm1hcChfdiA9PiBfdi5fdG9TUUxUYWJsZSgpKSArIG9iai5zcWwsCgoJCX0sICJfdG9TUUxUYWJsZSIpOwoKCQkvLyByZXQuc3FsICs9ICcvKkxvY2F0aW9uKi8pO1xuJzsKCgkJcmV0LnNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQocmV0LnNxbCkgOiByZXQuc3FsOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TUUxUYWJsZScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQuc3FsKTsKCQlyZXR1cm4gcmV0LnNxbDsKCX0KCglfZnJvbVNRTFRhYmxlKHRhYmxlLCBmaWVsZHMpIHsKCQkvLyB0YWJsZSBpcyBhIGpzb24gYXJyYXkKCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuYWN0aXZlKHRhYmxlWyJhY3RpdmUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZW5hYmxlZCh0YWJsZVsiZW5hYmxlZCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5jb2RlKHRhYmxlWyJjb2RlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5vcmRlcih0YWJsZVsib3JkZXIiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZGF0ZSh0YWJsZVsiZGF0ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5uYW1lKHRhYmxlWyJuYW1lIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucmVtYXJrKHRhYmxlWyJyZW1hcmsiXSk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBfc3FsKHNxbCwgc291cmNlID0gdGhpcykgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsKHNxbCwgdGhpcyk7CgoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJCQkvLyBpZih0aGlzWydfJytmaWVsZCsnX3NldCddICYmICh0eXBlb2YodGhpc1snXycrZmllbGRdKT09PSd1bmRlZmluZWQnIHx8IHRoaXNbJ18nK2ZpZWxkXT09bnVsbCkpIHJldHVybjsKCQkJCQkvLyBpZih0eXBlb2YoZWFPYmopPT09J3VuZGVmaW5lZCcpIHJldHVybjsgLy8gd2h5PwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiNTZmZmZjMzYtZTMwYS00Y2ExLWIzNTMtZDRlYzE1ZGVhYWE0IiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbiB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbltmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbltmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCV9vcHRpb25zKCJsb2NhdGlvbl9JbmNpZGVudHMiLCBvYmosIHRoaXMubG9jYXRpb25fSW5jaWRlbnRzKCkpOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnbG9jYXRpb25fSW5jaWRlbnRzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJMb2NhdGlvbiIgJiYgKG0udGFyZ2V0IHx8IG0ub3V0U2NyaXB0KSAmJiBtLmFjdGl2ZSAmJiBtLmVuYWJsZWQgJiYgKChtLnRvb2wgJiYgbS50b29sLm5hbWUgPT0gdGhpcy5Ub29sLm5hbWUpIHx8IChtLnR5cGUgJiYgbS50eXBlLm5hbWUgPT0gdGhpcy5Ub29sLnR5cGUubmFtZSkpICYmICghbS5zb3VyY2UgfHwgKG0uc291cmNlICYmIC8qIW0ub3V0U2NyaXB0ICYmKi8gdGhpc1snXycgKyBtLnNvdXJjZSArICdfc2V0J10pKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLm91dFNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcywgb1Njb3BlLCBtYXApID0+IHske20ub3V0U2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20ub3V0U2NyaXB0fSl9YCkodGhpcywgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0uc291cmNlKSB7CgkJCQlpZiAobS5zb3VyY2UuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzKSA9PiB7cmV0dXJuIF90aGlzLiR7bS5zb3VyY2V9O31gKSh0aGlzKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0uc291cmNlLCB0aGlzKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS50YXJnZXQpIG9ialttLnRhcmdldF0gPSByZXQ7CgkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCVttLnRhcmdldCB8fCBtLnNvdXJjZV06IHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXQoJCQl9KTsKCQl9KTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQkvLyB1c2UgdGhpcy5fbWFwKCkgd2l0aCByZXZlcnNlCgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjU2ZmZmYzM2LWUzMGEtNGNhMS1iMzUzLWQ0ZWMxNWRlYWFhNCIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb24gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbltmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbltmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJsb2NhdGlvbl9JbmNpZGVudHMiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnbG9jYXRpb25fSW5jaWRlbnRzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJMb2NhdGlvbiIgJiYgKG0uc291cmNlIHx8IG0uaW5TY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5pblNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmosIG9TY29wZSwgbWFwKSA9PiB7JHttLmluU2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20uaW5TY3JpcHR9KX1gKShvYmosIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnRhcmdldCkgewoJCQkJaWYgKG0udGFyZ2V0LmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmopID0+IHtyZXR1cm4gb2JqLiR7bS50YXJnZXR9O31gKShvYmopOwoJCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqW20udGFyZ2V0XSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0udGFyZ2V0LCBvYmopOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0uc291cmNlKSB7CgkJCQlpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXRoaXNbbS5zb3VyY2VdKHJldCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXNbbS5zb3VyY2VdID0gcmV0OwoJCQkJfQoJCQl9CgkJfSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RCT2JqZWN0KGZpZWxkcywgYk5vUmVmKSB7CgkJaWYgKCF0aGlzLklkKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJJbnZhbGlkIElEIiwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lLCB0aGlzLlRvb2wpOwoJCX0KCQlsZXQgcmV0ID0gewoJCQlbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ106ICInIiArIHRoaXMuSWQgKyAiJyIKCQl9OwoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9hY3RpdmVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYWN0aXZlKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZW5hYmxlZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5lbmFibGVkKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvZGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29kZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2RhdGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZGF0ZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5uYW1lKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3JlbWFya19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5yZW1hcmsoKTsKCgkJCWZWYWx1ZSA9ICInIiArICgodiAmJiB2LnJlcGxhY2UpID8gdi5yZXBsYWNlKC9cJy9nLCAiXCdcJyIpIDogdikgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX1EoKSB7CgkJbGV0IF9vID0gJyInOwoJCWxldCBfcSA9IF9vOwoKCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXRoaXMuX19RID0gdGhpcy5fX1EgPT0gX28gPyBfcSA6IF9vOwoJCXJldHVybiB0aGlzLl9fUTsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcsIHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpXTsKCQlmaWVsZHMgPSBBcnJheS5pc0FycmF5KGZpZWxkcykgPyBmaWVsZHMgOiBbZmllbGRzXTsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQkvLyB7ZmllbGQ6IG9yZGVyfQoJCQlmaWVsZHMgPSBbXTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX1gKTsKCgkJfQoJCXJldHVybiBmaWVsZHM7Cgl9CgoJX2Zyb21EQk9iamVjdChyID0ge30pIHsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5fX2ltcG9ydChyLCB7CgkJCQlJZDogb2JqID0+IHRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ10sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb2RlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5kYXRlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5uYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucmVtYXJrKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlOdWxsOiB0cnVlLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoJCXNxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsKCgkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpIHsKCQkJLy8ge2ZpZWxkOiBmdW5jdGlvbn0KCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJfQoKCQlzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7CgoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gYCk7CgoJCXNxbCArPSBgIHdoZXJlIDE9MWA7CgoJCXNxbCA9IHRoaXMuX19leHBvcnQoewoJCQlzcWw6IHNxbAoJCX0sIHsKCQkJX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSA/IFsnSWQnXSA6IHVuZGVmaW5lZCwKCQkJTnVsbDogdHJ1ZSwKCQkJX1RISVM6IG9iaiA9PiB7CgkJCQlpZiAoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKHQuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOwoJCQl9LAoJCQlJZDogb2JqID0+IG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jb2RlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fY29kZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX29yZGVyX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fb3JkZXJfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fZGF0ZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi50b0lTT1N0cmluZykgewoJCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbGl0ZScpIHsKCQkJCQkJb2JqLnNxbCArPSAic3RyZnRpbWUoJyVzJywgJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJykiOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9iai5zcWwgKz0gIiciICsgdi50b0lTT1N0cmluZygpICsgIiciOwoJCQkJCX0KCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9uYW1lX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9yZW1hcmtfc2V0KSByZXR1cm47CgoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWxvY2F0aW9uX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2xvY2F0aW9uX0xvY2F0aW9ucycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX3NldCkgcmV0dXJuOwoKCQkJCWxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCgibG9jYXRpb24uaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19jb29wID09ICchPScgfHwgdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX2Nvb3AgPT0gJ05PVCBJTicpIHsKCQkJCQlpbk9QID0gJ05PVCBJTic7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19jb29wID09ICc9JyB8fCB0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfY29vcCA9PSAnPT0nKSB7CgkJCQkJak9QID0gJ0lOVEVSU0VDVCc7CgkJCQl9CgoJCQkJb2JqLnNxbCArPSBgYW5kIC8qbG9jYXRpb25fSW5jaWRlbnRzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQl9LCAiX3RvU2VsZWN0U1FMIiwgZmllbGRzKS5zcWw7CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJaWYgKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWR9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuY29kZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMubmFtZX1gOwoKCQl9CgoJCWlmIChzcWwuZW5kc1dpdGgoIndoZXJlIDE9MSIpKSB7CgkJCS8vIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEiLCAid2hlcmUgMT0wIik7CgkJfSBlbHNlIHsKCQkJc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSBhbmQgIiwgIndoZXJlICIpOwoJCX0KCgkJc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpIDogc3FsOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoKCQlyZXR1cm4gc3FsOwoJfQoKCV90b1BhdGhzKCkgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCV9USElTOiBvYmogPT4ge30sCgoJCQlsb2NhdGlvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdsb2NhdGlvbl9Mb2NhdGlvbnMnLCB1bmRlZmluZWQpKSA9PiBvYmoubG9jYXRpb25fSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTG9jYXRpb24pIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTG9jYXRpb24gPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgc3FsID0gbmV3IHNhbGVzbm93LkxvY2F0aW9uKCkKCgkJCQkJLmxvY2F0aW9uX0luY2lkZW50cyhuZXcgc2FsZXNub3cuSW5jaWRlbnQoKSkKCgkJCQkJLl90b1NRTFRhYmxlKGRlcHRoKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIkxvY2F0aW9uIikgcmV0dXJuIGZhbHNlOwoKCQkJbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJCUZ1bGw6IHRydWUsCgkJCQlOdWxsOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5faWQgPSB0aGlzLklkID09IHF1ZXJ5LklkLAoKCQkJCWFjdGl2ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouYWN0aXZlID0gdiA9PSBxdWVyeS5hY3RpdmUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fYWN0aXZlX3NldCAmJiAhcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2FjdGl2ZV9zZXQgJiYgcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5lbmFibGVkID0gdiA9PSBxdWVyeS5lbmFibGVkKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ICYmICFxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9lbmFibGVkX3NldCAmJiBxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY29kZSA9IHYgPT0gcXVlcnkuY29kZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jb2RlX3NldCAmJiAhcXVlcnkuX2NvZGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY29kZV9zZXQgJiYgcXVlcnkuX2NvZGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vcmRlciA9IHYgPT0gcXVlcnkub3JkZXIoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fb3JkZXJfc2V0ICYmICFxdWVyeS5fb3JkZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX29yZGVyX3NldCAmJiBxdWVyeS5fb3JkZXJfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5kYXRlID0gdiA9PSBxdWVyeS5kYXRlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2RhdGVfc2V0ICYmICFxdWVyeS5fZGF0ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9kYXRlX3NldCAmJiBxdWVyeS5fZGF0ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubmFtZSA9IHYgPT0gcXVlcnkubmFtZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9uYW1lX3NldCAmJiAhcXVlcnkuX25hbWVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbmFtZV9zZXQgJiYgcXVlcnkuX25hbWVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gZmFsc2U7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucmVtYXJrID0gdiA9PSBxdWVyeS5yZW1hcmsoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcmVtYXJrX3NldCAmJiAhcXVlcnkuX3JlbWFya19zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3JlbWFya19zZXQgJiYgcXVlcnkuX3JlbWFya19zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IGZhbHNlOwoJCQkJfSwKCgkJCQlsb2NhdGlvbl9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoubG9jYXRpb25fSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gcXVlcnkubG9jYXRpb25fSW5jaWRlbnRzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoZXMiKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDAsIG9NYXRjaCk7CgoJCQlyZXR1cm4gT2JqZWN0LmtleXMob01hdGNoKS5ldmVyeShrID0+IG9NYXRjaFtrXSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfbWF0Y2hpbmcocXVlcnkpIHsKCQl0cnkgewoJCQlsZXQgcmV0ID0gW107CgoJCQlsZXQgbWF0Y2hlcyA9IHRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlsb2NhdGlvbl9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoubG9jYXRpb25fSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWxvY2F0aW9uX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLmxvY2F0aW9uX0luY2lkZW50cygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvZGUocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kYXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoJCQkJCWlmICh0eXBlb2YobW9tZW50KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZWYgPSBuZXcgRGF0ZShyZWYpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmVmID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpKTsKCQkJCX0KCQkJCXRoaXMuZGF0ZShyZWYpOwoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm5hbWUocmVmKTsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZW1hcmtfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnJlbWFyayhyZWYpOwoKCQkJfSwKCgkJCWxvY2F0aW9uX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2xvY2F0aW9uX0xvY2F0aW9ucycsIHVuZGVmaW5lZCkgOiAibG9jYXRpb25fSW5jaWRlbnRzIikpID0+IHRoaXMubG9jYXRpb25fSW5jaWRlbnRzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5JbmNpZGVudCgpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQl9LCAiX2Zyb21Eb2N1bWVudCIpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSB7CgkJbGV0IHJldCA9IHt9OwoKCQlpZiAoIWJUb29sKSB7CgkJCXJldC5fX2dlbmVyYXRlZCA9IG5ldyBEYXRlKCk7CgkJCWlmICh0aGlzLlRvb2wubmFtZSkgewoJCQkJcmV0Ll9fdG9vbCA9IHsKCQkJCQluYW1lOiB0aGlzLlRvb2wubmFtZSwKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlpZiAoc2FsZXNub3cuX25vZGUpIHsKCQkJCXJldC5fX25vZGUgPSB7CgkJCQkJY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogYkZ1bGwsCgkJCU51bGw6IGJOdWxsLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXSA9IHYsCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3JkZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGw7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIG9ialtlYUNvZGVdID0gb2JqW2VhQ29kZV0ucmVwbGFjZSgvXC5bMC05XSpaL2csICcnKTsKCgkJCQlpZiAodGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGF0ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9uYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9uYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3JlbWFya19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQlsb2NhdGlvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdsb2NhdGlvbl9Mb2NhdGlvbnMnLCB1bmRlZmluZWQpIDogImxvY2F0aW9uX0luY2lkZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSB0cnVlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Mb2NhdGlvbi5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuTG9jYXRpb24obnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLm5hbWUodGhpcy5uYW1lKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCWlmICh0eXBlb2Yoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgPT09ICJ1bmRlZmluZWQiIHx8IHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQkJCWF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsKCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiA9IHsKCQkJCQkJCU93bmVyOiB0aGlzLAoJCQkJCQkJc3FsczogW10sCgkJCQkJCQlzdGFydDogbmV3IERhdGUoKSwKCQkJCQkJCWVuZDogbnVsbAoJCQkJCQl9OwoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSB7CgkJCQkJdGhpcy5hY3RpdmUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSB7CgkJCQkJdGhpcy5lbmFibGVkKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgewoJCQkJCXRoaXMuZGF0ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSBuZXcgRGF0ZSgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fX2Fzc2VydFZhbGlkKHRydWUpKSByZXR1cm4gbnVsbDsKCgkJCQkvL2F3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8gaW4gY2FzZSBUb29sIGNoYW5nZXMKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgQWJvdXQgdG8gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9YCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgRmluaXNoZWQgSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9IElkPVske3RoaXMuSWR9XWApOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLmxvY2F0aW9uX0luY2lkZW50cygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkxvY2F0aW9uLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkxvY2F0aW9uLnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvVXBkYXRlU1FMKCkpOwoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKCkpOwoJCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0WzBdOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Mb2NhdGlvbi5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSAoYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgKTsKCQkJCXJldCA9IHJldCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5Mb2NhdGlvbihudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93LkNvbmZpZyA9IGNsYXNzIENvbmZpZyBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFpZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKT2IyUmxJanA3SW01dlJHVjBaV04wSWpwMGNuVmxMQ0pwYm1sMExtVnVaSE1pT2pJc0ltbHVhWFF1Ykc5dmNDSTZNQzQxTENKMGIyOXNjeTV6ZEc5eVpTSTZabUZzYzJVc0ltUmxkR1ZqZEZCaGNtVnVkQzVKVUNJNklqRTVOUzR4TVRJdU1qRTJMakUzTXlJc0ltUmxkR1ZqZEZCaGNtVnVkQzVqYjJSbElqb2laVGhrWlRBMlpUTmxaR00wTkROaFpUbGtabVV4WkdVMVpXTTFNbUUwWW1ZaUxDSnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wc0lsUnZiMndpT25zaVoybDBhSFZpTG5SdmIyeHpJam9pYUhSMGNITTZMeTl5WVhjdVoybDBhSFZpZFhObGNtTnZiblJsYm5RdVkyOXRMMlpoWkdsdUwyWmhaR2x1TG1kcGRHaDFZaTVwYnk5dFlYTjBaWEl2SWl3aWMyVmpjbVYwSWpvaWIxTkxkMmRhTW5OTFJrOVVTVXBqWWtGbVZVbFJORU5xT1hGelNEUTRibXdpTENKd2JHRjVaM0p2ZFc1a0lqcDBjblZsTENKblVsQkRJanAwY25WbExDSnpkRzl5WlM1elpXNXphWFJwZG1sMGVTSTZNU3dpWTI5dGNHRnVlU0k2SW5KbGMzVnRaU0o5TENKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzSWtkcGRFaDFZaUpkYCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJ2YWx1ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfdmFsdWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJ0b29sIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl90b29sKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibm9kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbm9kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiQ29uZmlnIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQlyZXR1cm4gdGhpczsKCgkJaWYgKHRoaXMuX3Rvb2xfc2V0ICYmIHRoaXMuX3Rvb2wpIHRoaXMuX3Rvb2wuVG9vbCA9IHRvb2w7CgoJCWlmICh0aGlzLl9ub2RlX3NldCAmJiB0aGlzLl9ub2RlKSB0aGlzLl9ub2RlLlRvb2wgPSB0b29sOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdmFsdWUgKiovCgl2YWx1ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3ZhbHVlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgidmFsdWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3ZhbHVlICE9IHYpIHsKCQkJCXRoaXMuX3ZhbHVlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl92YWx1ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLk9iamVjdFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl92YWx1ZSk7CgkJfQoJfQoKCWNsZWFyX3ZhbHVlKCkgewoJCXRoaXMuX3ZhbHVlX3NldCA9IG51bGw7CgkJdGhpcy5fdmFsdWUgPSBudWxsOwoJCXRoaXMuX3ZhbHVlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB2YWx1ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHRvb2wgKiovCgl0b29sKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fdG9vbF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInRvb2wiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICczMmU4MTE3My0yYWIyLTQ2NjItYTcwNi0xYzM4ZTM1OTI0ZGUnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdUb29sJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3Rvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICIzMmU4MTE3My0yYWIyLTQ2NjItYTcwNi0xYzM4ZTM1OTI0ZGUiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiVG9vbCIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl90b29sICE9IHYpIHsKCQkJCXRoaXMuX3Rvb2xfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0b29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl90b29sID8gdGhpcy5fdG9vbC5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fdG9vbF9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fdG9vbCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl90b29sKTsKCQl9Cgl9CgoJY2xlYXJfdG9vbCgpIHsKCQl0aGlzLl90b29sX3NldCA9IG51bGw7CgkJdGhpcy5fdG9vbCA9IG51bGw7CgkJdGhpcy5fdG9vbF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdG9vbCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5vZGUgKiovCglub2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbm9kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5vZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICdjNmIxNGI0ZS1lNTFkLTRkYmEtYWZiOC1hYzQ3OGY0YjRlNzYnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdOb2RlJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ25vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICJjNmIxNGI0ZS1lNTFkLTRkYmEtYWZiOC1hYzQ3OGY0YjRlNzYiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiTm9kZSIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9ub2RlICE9IHYpIHsKCQkJCXRoaXMuX25vZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdub2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9ub2RlID8gdGhpcy5fbm9kZS5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fbm9kZV9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fbm9kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9ub2RlKTsKCQl9Cgl9CgoJY2xlYXJfbm9kZSgpIHsKCQl0aGlzLl9ub2RlX3NldCA9IG51bGw7CgkJdGhpcy5fbm9kZSA9IG51bGw7CgkJdGhpcy5fbm9kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igbm9kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX3ZhbHVlX3NldCwKCgkJCXRoaXMuX3Rvb2xfc2V0LAoKCQkJdGhpcy5fbm9kZV9zZXQsCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fdmFsdWVfc2V0ID0gdGhpcy5fdmFsdWVfc2V0OwoJCXJldC5fdmFsdWVfY29vcCA9IHRoaXMuX3ZhbHVlX2Nvb3A7CgkJcmV0LnZhbHVlID0gdGhpcy52YWx1ZSgpID8gdGhpcy52YWx1ZSgpIDogdGhpcy52YWx1ZSgpOwoKCQlyZXQuX3Rvb2xfc2V0ID0gdGhpcy5fdG9vbF9zZXQ7CgkJcmV0Ll90b29sX2Nvb3AgPSB0aGlzLl90b29sX2Nvb3A7CgkJcmV0LnRvb2wgPSB0aGlzLnRvb2woKSA/IHRoaXMudG9vbCgpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLnRvb2woKTsKCgkJcmV0Ll9ub2RlX3NldCA9IHRoaXMuX25vZGVfc2V0OwoJCXJldC5fbm9kZV9jb29wID0gdGhpcy5fbm9kZV9jb29wOwoJCXJldC5ub2RlID0gdGhpcy5ub2RlKCkgPyB0aGlzLm5vZGUoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5ub2RlKCk7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJInZhbHVlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3ZhbHVlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkidG9vbCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkibm9kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQl9LCAiX3RvSGFzaCIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMuTm9Db2RlID8gb0hhc2ggOiB0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7Cgl9CgoJYXN5bmMgX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOwoKCX0KCglfcWxTZWxlY3Rpb25zKHNTZXQpIHsKCQlsZXQgcmV0ID0gW107CgkJaWYgKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7CgoJCXNTZXQuc2VsZWN0aW9ucy5maWx0ZXIocyA9PiBzLnNlbGVjdGlvblNldCkuZm9yRWFjaChzID0+IHsKCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInRvb2wiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIHRvb2wnLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93LlRvb2woKS50b29sX0NvbmZpZ3ModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJub2RlIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBub2RlJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Ob2RlKCkubm9kZV9Db25maWdzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkgIT0gJ0NvbmZpZycpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCXJldHVybiBuZXcgc2FsZXNub3dbZXZlbnQuY2xhc3NOYW1lKCldKCkuX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdyk7CgkJCX0KCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9Db25maWcvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQkJZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOwoJCQkJZGVsZXRlIGRhdGEuX190aGlzLm9ubGluZTsKCgkJCX0KCgkJCS8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/PwoKCQkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJCXRyeSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0pIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7bWV0aG9kfWApOwoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCWxldCBfaWQgPSBudWxsOwoJCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBkYXRhLCBtZXRob2QsIHt9KTsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRhdGEpID09PSAnc3RyaW5nJykgewoJCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUoZGF0YSk7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IGRhdGEuX190aGlzLmNvZGUgfHwgZGF0YS5pZCB8fCBkYXRhLklEOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJCWlmIChkYXRhLklkICYmIGRhdGEuSWQgPT0gZGF0YS5JZCkgewoJCQkJCQlfaWQgPSBkYXRhLklkOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQkJfSBlbHNlIGlmIChkYXRhLkVudGl0eUNsYXNzKSB7CgkJCQkJCV9pZCA9IGRhdGEuRW50aXR5Q2xhc3MuSWQgfHwgZGF0YS5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgImJhZGFkNDA0LTBhM2QtNGM4NC1iZDVmLTk1OGIwODNlMzRkOSIgfHwgIk5VTEwiOwoJCQkJCX0KCQkJCX0KCgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWcgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZ1ttZXRob2RdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWdbbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnW21ldGhvZF1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnW21ldGhvZF1bX2lkXSB8fCB7fTsKCgkJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goe30sIHsKCQkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQkJfSk7CgoJCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnW21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWdbbWV0aG9kXVtfaWRdW19oYXNoXSA9IHsKCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeSh7fSksCgkJCQkJb2JqOiBkYXRhLAoJCQkJCXJldXNlZDogMCwKCQkJCX07CgkJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZGF0YSwgbWV0aG9kLCB7fSwgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBUcmlnZ2VycmluZyAke21ldGhvZH0gdG8gJHtuLmNvZGUoKX0gJHtKU09OLnN0cmluZ2lmeShkYXRhLG51bGwsNCl9YCk7CgoJCQlsZXQgZXYgPSBuZXcgc2FsZXNub3cuRXZlbnQoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSh0aGlzLl9fY29uZmlnKCdldmVudCcpIHx8ICdzYWxlc25vdy5FdmVudCcpLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnJlY2lwaWVudChuKS5tZXRob2QobWV0aG9kKS5jbGFzc05hbWUoJ0NvbmZpZycpLnNlbmRlcihzYWxlc25vdy5fbm9kZSkuY2FycmllcihzYWxlc25vdy5fbm9kZSkucGF5bG9hZChkYXRhKTsKCQkJaWYgKGV2ZW50KSB7CgkJCQlpZiAoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7CgkJCQlpZiAoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7CgkJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7CgkJCQlpZiAoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7CgkJCX0KCQkJcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOwoKCQkJaWYgKHR5cGVvZihyZXQpID09PSAic3RyaW5nIikgewoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChleCkge30KCQkJfQoJCQlyZXR1cm4gcmV0OwoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LkNvbmZpZyhudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuQ29uZmlnKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX25vZGUpIHsKCQkJLy8gcHJvYmFibHkgc2hvdWxkIG5vdCBiZSBwcm9jZXNzZWQgaGVyZSwgYnV0IHJhdGhlciBjb25zdW1lZCBhcyBwYXJ0IG9mIHRoZSBleGVjdXRlKCkgbG9naWMsIHB1c2hpbmcgX19ub2RlIHRvIHRoZSBsaXN0IG9mIG15IG5vZGVzIHRvIGRlbGVnYXRlIHRvIT8KCQkJbGV0IHRuID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX19ub2RlKS5fZGVSZWZlcmVuY2UoKTsKCQkJZGVsZXRlIF9wYXJhbXMuX19ub2RlOwoJCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LkNvbmZpZygpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOwoJCX0KCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgQ29uZmlnLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgQ29uZmlnLl9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQlpZiAoZmFsc2UgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCXJldCA9IHsKCQkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCQknLTQnOiAiVW5jb21taXR0ZWQgdHJhbnNhY3Rpb25zOiAiICsgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5zcWxzLmxlbmd0aCwKCQkJCQkJJ29iaic6IG9iagoJCQkJCX0KCQkJCX0KCQkJfQoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZy5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5Db25maWcuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIkNvbmZpZyIpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQlpZiAodGhpcy5fdG9vbF9zZXQgJiYgdGhpcy50b29sKCkpIHRoaXMudG9vbCgpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl9ub2RlX3NldCAmJiB0aGlzLm5vZGUoKSkgdGhpcy5ub2RlKCkuX19zeW5jX29uKGQpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Db25maWcodGhpcy5JZCkKCgkJCS52YWx1ZSh0aGlzLnZhbHVlKCksIHRoaXMuX3ZhbHVlX2Nvb3ApCgoJCQkudG9vbCh0aGlzLnRvb2woKSwgdGhpcy5fdG9vbF9jb29wKQoKCQkJLm5vZGUodGhpcy5ub2RlKCksIHRoaXMuX25vZGVfY29vcCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQlvYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ0NvbmZpZyc7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIkNvbmZpZyI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgkJCQlyZXQgPSByZXQudG9Mb3dlckNhc2UoKTsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucyA9IHt9KSB7CgkJdHJ5IHsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sID8gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IG9wdGlvbnMudG9vbCB8fCB0ID09IG9wdGlvbnMudG9vbCkgOiB0aGlzLlRvb2w7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCB8fCB7fTsKCgkJCWxldCBuSUQgPSBzYWxlc25vdy5fbm9kZSA/IHNhbGVzbm93Ll9ub2RlLmNvZGUoKSA6ICJkZWZhdWx0IjsKCgkJCWxldCByZXQgPSBudWxsVmFsdWU7CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldCA9IG51bGw7CgoJCQkvLyB0b29sX0NvbmZpZ3M6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gZG9uZQoJCQlsZXQgdGNvbmYgPSAob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgYy5ub2RlICYmIGMubm9kZS5jb2RlID09IG5JRCkuY29uY2F0KChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiAhYy5ub2RlKSk7CgkJCWlmICh0Y29uZi5sZW5ndGgpIHsKCQkJCXJldCA9IHRjb25mWzBdLnZhbHVlOwoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChqZXgpIHt9CgkJCX0KCgkJCS8vIG1vZGVsIENvbmZpZzogQ29uZmlnIGlzIGNsYXNzIGxldmVsLCBub2RlIG5vdCBwb3NzaWJsZSAtIHBlbmRpbmcKCQkJbGV0IG1jb25mID0gdGhpcy5Db25maWcgPyB0aGlzLkNvbmZpZ1tuXSA6IHVuZGVmaW5lZDsKCQkJaWYgKHR5cGVvZihtY29uZikgIT09ICJ1bmRlZmluZWQiKSByZXQgPSBtY29uZjsKCgkJCS8vIGNvbW1hbmQgbGluZTogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgZ2xvYmFsLm1pbmltaXN0KSB7CgkJCQlyZXQgPSBnbG9iYWwubWluaW1pc3QocHJvY2Vzcy5hcmd2LnNsaWNlKDIpKVtuXSB8fCByZXQ7CgkJCX0KCgkJCS8vIHJlcXVlc3Q6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlyZXQgPSB0aGlzLiRfUkVRVUVTVChuKSB8fCByZXQ7CgoJCQlpZiAob3B0aW9ucy5uZXdWYWx1ZSkgewoJCQkJbGV0IHRjID0gdGNvbmYubGVuZ3RoID8gdGNvbmZbMF0gOiB7fTsKCQkJCXRjLm5vZGUgPSB7CgkJCQkJY29kZTogb3B0aW9ucy5ub2RlLmNvZGUoKQoJCQkJfTsKCQkJCXRjLnZhbHVlID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJCXRjLm5hbWUgPSBuOwoJCQkJaWYgKCF0Y29uZi5sZW5ndGgpIHsKCQkJCQlvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLnB1c2godGMpOwoJCQkJfQoJCQkJcmV0ID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJfQoKCQkJLy8gY29uZmlnIHJlcGxhY2VtZW50CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3N0cmluZycpKHJldC5tYXRjaChuZXcgUmVnRXhwKGB7eyhbXn1dKyl9fWAsICJnIikpIHx8IFtdKS5mb3JFYWNoKG0gPT4gcmV0ID0gcmV0LnJlcGxhY2UobSwgdGhpcy5fX2NvbmZpZyhtLnJlcGxhY2UoJ3t7JywgJycpLnJlcGxhY2UoJ319JywgJycpLCBudWxsLCBvcHRpb25zKSkpOwoKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2NvbmZpZycsICdFbnRpdHlPYmplY3QnLCAxLCBuLCBudWxsVmFsdWUsIG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MsIGV4KTsKCQl9Cgl9CgoJX3RvU1FMVGFibGUoKSB7CgkJbGV0IHJldCA9IHsKCQkJc3FsOiBgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoCiAgICAgICAgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVkKICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd2YWx1ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiT2JqZWN0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbm9kZScsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICBgCgkJfTsKCQlyZXQuc3FsICs9ICcvKkNvbmZpZyovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJ2YWx1ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd2YWx1ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd2YWx1ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiT2JqZWN0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJ0b29sIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndG9vbCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkibm9kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJfSwgIl90b1NRTFRhYmxlIik7CgoJCS8vIHJldC5zcWwgKz0gJy8qQ29uZmlnKi8pO1xuJzsKCgkJcmV0LnNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQocmV0LnNxbCkgOiByZXQuc3FsOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TUUxUYWJsZScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQuc3FsKTsKCQlyZXR1cm4gcmV0LnNxbDsKCX0KCglfZnJvbVNRTFRhYmxlKHRhYmxlLCBmaWVsZHMpIHsKCQkvLyB0YWJsZSBpcyBhIGpzb24gYXJyYXkKCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInZhbHVlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy52YWx1ZSh0YWJsZVsidmFsdWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigidG9vbCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMudG9vbCh0YWJsZVsidG9vbCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJub2RlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5ub2RlKHRhYmxlWyJub2RlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuYWN0aXZlKHRhYmxlWyJhY3RpdmUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZW5hYmxlZCh0YWJsZVsiZW5hYmxlZCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5jb2RlKHRhYmxlWyJjb2RlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5vcmRlcih0YWJsZVsib3JkZXIiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZGF0ZSh0YWJsZVsiZGF0ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5uYW1lKHRhYmxlWyJuYW1lIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucmVtYXJrKHRhYmxlWyJyZW1hcmsiXSk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBfc3FsKHNxbCwgc291cmNlID0gdGhpcykgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsKHNxbCwgdGhpcyk7CgoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJCQkvLyBpZih0aGlzWydfJytmaWVsZCsnX3NldCddICYmICh0eXBlb2YodGhpc1snXycrZmllbGRdKT09PSd1bmRlZmluZWQnIHx8IHRoaXNbJ18nK2ZpZWxkXT09bnVsbCkpIHJldHVybjsKCQkJCQkvLyBpZih0eXBlb2YoZWFPYmopPT09J3VuZGVmaW5lZCcpIHJldHVybjsgLy8gd2h5PwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJ2YWx1ZSIsIG9iaiwgdGhpcy52YWx1ZSgpKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqLCB0aGlzLmNvZGUoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmosIHRoaXMuZGF0ZSgpKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmosIHRoaXMubmFtZSgpKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaiwgdGhpcy5yZW1hcmsoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJiYWRhZDQwNC0wYTNkLTRjODQtYmQ1Zi05NThiMDgzZTM0ZDkiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWcgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZ1tmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZ1tmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZ1tmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWdbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZ1tmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlpZiAoIXRoaXMudG9vbCgpIHx8ICh0aGlzLnRvb2woKQoKCQkJCSYmCgkJCQkhdGhpcy50b29sKCkudG9vbF9Db25maWdzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnRvb2woKS50b29sX01hcHBpbmdzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJ0b29sIiwgb2JqLCB0aGlzLnRvb2woKSk7CgkJfQoKCQlpZiAoIXRoaXMubm9kZSgpIHx8ICh0aGlzLm5vZGUoKQoKCQkJCSYmCgkJCQkhdGhpcy5ub2RlKCkubm9kZV9Db25maWdzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLm5vZGUoKS5jYXJyaWVyX0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5ub2RlKCkuc2VuZGVyX0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5ub2RlKCkucmVjaXBpZW50X0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5ub2RlKCkuYmFja3VwX05vZGVzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLm5vZGUoKS5wYXJlbnRfTm9kZXMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMubm9kZSgpLm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJub2RlIiwgb2JqLCB0aGlzLm5vZGUoKSk7CgkJfQoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWyd2YWx1ZScsICd0b29sJywgJ25vZGUnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlmYWxzZSAmJiBbXS5jb25jYXQodGhpcy5Ub29sLnR5cGUudHlwZV9NYXBwaW5ncyB8fCBbXSkuY29uY2F0KHRoaXMuVG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5maWx0ZXIobSA9PiBtLmNsYXNzTmFtZSA9PSAiQ29uZmlnIiAmJiAobS50YXJnZXQgfHwgbS5vdXRTY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkgJiYgKCFtLnNvdXJjZSB8fCAobS5zb3VyY2UgJiYgLyohbS5vdXRTY3JpcHQgJiYqLyB0aGlzWydfJyArIG0uc291cmNlICsgJ19zZXQnXSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0ub3V0U2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5vdXRTY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5vdXRTY3JpcHR9KX1gKSh0aGlzLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS5zb3VyY2UpIHsKCQkJCWlmIChtLnNvdXJjZS5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMpID0+IHtyZXR1cm4gX3RoaXMuJHttLnNvdXJjZX07fWApKHRoaXMpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS5zb3VyY2UsIHRoaXMpOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnRhcmdldCkgb2JqW20udGFyZ2V0XSA9IHJldDsKCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJW20udGFyZ2V0IHx8IG0uc291cmNlXTogdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddCgkJCX0pOwoJCX0pOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCS8vIHVzZSB0aGlzLl9tYXAoKSB3aXRoIHJldmVyc2UKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoInZhbHVlIiwgb2JqKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmopOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiYmFkYWQ0MDQtMGEzZC00Yzg0LWJkNWYtOTU4YjA4M2UzNGQ5IiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZyA9IHNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZ1tmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWdbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWdbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWdbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWdbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygidG9vbCIsIG9iaik7CgoJCV9vcHRpb25zKCJub2RlIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsndmFsdWUnLCAndG9vbCcsICdub2RlJywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWycnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIkNvbmZpZyIgJiYgKG0uc291cmNlIHx8IG0uaW5TY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5pblNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmosIG9TY29wZSwgbWFwKSA9PiB7JHttLmluU2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20uaW5TY3JpcHR9KX1gKShvYmosIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnRhcmdldCkgewoJCQkJaWYgKG0udGFyZ2V0LmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmopID0+IHtyZXR1cm4gb2JqLiR7bS50YXJnZXR9O31gKShvYmopOwoJCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqW20udGFyZ2V0XSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0udGFyZ2V0LCBvYmopOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0uc291cmNlKSB7CgkJCQlpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXRoaXNbbS5zb3VyY2VdKHJldCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXNbbS5zb3VyY2VdID0gcmV0OwoJCQkJfQoJCQl9CgkJfSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RCT2JqZWN0KGZpZWxkcywgYk5vUmVmKSB7CgkJaWYgKCF0aGlzLklkKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJJbnZhbGlkIElEIiwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lLCB0aGlzLlRvb2wpOwoJCX0KCQlsZXQgcmV0ID0gewoJCQlbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ106ICInIiArIHRoaXMuSWQgKyAiJyIKCQl9OwoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInZhbHVlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3ZhbHVlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnZhbHVlKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyBKU09OLnN0cmluZ2lmeSh2LCBudWxsLCAnXHQnKSArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgndmFsdWUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJ0b29sIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3Rvb2xfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnRvb2woKTsKCgkJCWlmICh2ICYmICh2Ll9fc3luY19vbigpIHx8IHYuSWQgPT0gdi5JZCkpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYuSWQgKyAiJyI7CgkJCX0gZWxzZSB7CgkJCQlmVmFsdWUgPSAwOwoJCQl9CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5vZGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbm9kZV9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMubm9kZSgpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgnbm9kZScsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2FjdGl2ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hY3RpdmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9lbmFibGVkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY29kZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jb2RlKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fb3JkZXJfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMub3JkZXIoKTsKCgkJCWZWYWx1ZSA9IHYgfHwgJzAnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZGF0ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5kYXRlKCk7CgoJCQl0cnkgewoJCQkJZlZhbHVlID0gIiciICsgKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiAiMTk3MC0xLTEiKSArICInIjsKCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJykgewoJCQkJCWZWYWx1ZSA9IGBTVFJfVE9fREFURSgke2ZWYWx1ZX0sICclWS0lbS0lZFQlVC4lZlonKWA7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9ICdkYXRldGltZSgnICsgZlZhbHVlICsgJyknOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9uYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm5hbWUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcmVtYXJrX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnJlbWFyaygpOwoKCQkJZlZhbHVlID0gIiciICsgKCh2ICYmIHYucmVwbGFjZSkgPyB2LnJlcGxhY2UoL1wnL2csICJcJ1wnIikgOiB2KSArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJyB8fCB0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIHsKCQkJX28gPSBfcSA9ICdgJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3Fsc2VydmVyJykgewoJCQlfbyA9ICdbJzsKCQkJX3EgPSAnXSc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCdhcGlLZXknKSA9PSAnYWlydGFibGUnKSB7CgkJCV9vID0gJ3snOwoJCQlfcSA9ICd9JzsKCQl9CgkJdGhpcy5fX1EgPSB0aGlzLl9fUSA9PSBfbyA/IF9xIDogX287CgkJcmV0dXJuIHRoaXMuX19ROwoJfQoKCV9maWVsZEdyb3VwcyhmZ3MgPSB7fSkgewoJCXRoaXMuX19maWVsZEdyb3VwcyA9IGZnczsKCQlyZXR1cm4gdGhpczsKCX0KCglfZmllbGRBZ2dyZWdhdGVzKGZhcyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkQWdncmVnYXRlcyA9IGZhczsKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9GaWVsZHNTUUwoZmllbGRzKSB7CgoJCWZpZWxkcyA9IGZpZWxkcyB8fCBbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJywgdGhpcy5fbkNvZGUoJ3ZhbHVlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKV07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnZhbHVlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgndmFsdWUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy50b29sKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgndG9vbCcsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubm9kZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9YCk7CgoJCX0KCQlyZXR1cm4gZmllbGRzOwoJfQoKCV9mcm9tREJPYmplY3QociA9IHt9KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMuX19pbXBvcnQociwgewoJCQkJSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddLAoKCQkJCXZhbHVlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndmFsdWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy52YWx1ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCXRvb2w6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMudG9vbChvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW5vZGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMubm9kZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWFjdGl2ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmFjdGl2ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZW5hYmxlZChvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuY29kZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5vcmRlcihvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZGF0ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMubmFtZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnJlbWFyayhvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJfSwgIl9mcm9tREJPYmplY3QiKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX3RvU2VsZWN0SGVhZGVyKGZpZWxkcykgewoJCWxldCByZXQgPSB7CgkJCXRhYmxlOiB0aGlzLl9uQ29kZSgpLAoJCQlmaWVsZHM6IERvdE9iamVjdC5vYmplY3QoT2JqZWN0LmZyb21FbnRyaWVzKHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLm1hcChmID0+IFtmLCBmXSkpKSwKCQkJam9pbnM6IHt9LAoJCX07CgoJCWlmIChmaWVsZHMpIHJldHVybiByZXQ7CgoJCXJldC5qb2lucyA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJTnVsbDogdHJ1ZSwKCgkJCXRvb2w6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKSkgPT4gb2JqW2VhQ29kZV0gPSBuZXcgc2FsZXNub3cuVG9vbCgpLl90b1NlbGVjdEhlYWRlcigpLAoKCQkJbm9kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Ob2RlKCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCX0sICJfdG9TZWxlY3RIZWFkZXIiKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0SGVhZGVyJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU2VsZWN0U1FMKGZpZWxkcykgewoJCWxldCBzcWwgPSAic2VsZWN0ICI7CgoJCWxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9YDsKCgkJbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7CgkJc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOwoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOwoKCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcykgewoJCQkvLyB7ZmllbGQ6IGZ1bmN0aW9ufQoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMudmFsdWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnZhbHVlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd2YWx1ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy50b29sKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy50b29sfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5vZGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5vZGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJdmFsdWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd2YWx1ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fdmFsdWVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl92YWx1ZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJdG9vbDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3Rvb2xfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl90b29sX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJbm9kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX25vZGVfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9ub2RlX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jb2RlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fb3JkZXJfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vcmRlcl9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9kYXRlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LnRvSVNPU3RyaW5nKSB7CgkJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3FsaXRlJykgewoJCQkJCQlvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbmFtZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX25hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3JlbWFya19zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvU2VsZWN0U1FMIiwgZmllbGRzKS5zcWw7CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJaWYgKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy52YWx1ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd2YWx1ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnZhbHVlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnRvb2wpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndG9vbCcsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMudG9vbH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5ub2RlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5vZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJdG9vbDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpKSA9PiBvYmoudG9vbCA9IHYuX3RvUGF0aHMoKSwKCgkJCW5vZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKSkgPT4gb2JqLm5vZGUgPSB2Ll90b1BhdGhzKCksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuQ29uZmlnKSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLkNvbmZpZyA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCBzcWwgPSBuZXcgc2FsZXNub3cuQ29uZmlnKCkKCgkJCQkJLnRvb2wobmV3IHNhbGVzbm93LlRvb2woKSkKCgkJCQkJLm5vZGUobmV3IHNhbGVzbm93Lk5vZGUoKSkKCgkJCQkJLl90b1NRTFRhYmxlKGRlcHRoKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIkNvbmZpZyIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQl2YWx1ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoudmFsdWUgPSB2ID09IHF1ZXJ5LnZhbHVlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3ZhbHVlX3NldCAmJiAhcXVlcnkuX3ZhbHVlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai52YWx1ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl92YWx1ZV9zZXQgJiYgcXVlcnkuX3ZhbHVlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudmFsdWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJdG9vbDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoudG9vbCA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkudG9vbCgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl90b29sX3NldCAmJiAhcXVlcnkuX3Rvb2xfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnRvb2wgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fdG9vbF9zZXQgJiYgcXVlcnkuX3Rvb2xfc2V0KSB8fAoKCQkJCQkJKHRoaXMudG9vbCgpICYmICF0aGlzLnRvb2woKS5fbWF0Y2hlcyhxdWVyeS50b29sKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai50b29sID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5vZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5vZGUgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5Lm5vZGUoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbm9kZV9zZXQgJiYgIXF1ZXJ5Ll9ub2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5ub2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25vZGVfc2V0ICYmIHF1ZXJ5Ll9ub2RlX3NldCkgfHwKCgkJCQkJCSh0aGlzLm5vZGUoKSAmJiAhdGhpcy5ub2RlKCkuX21hdGNoZXMocXVlcnkubm9kZSgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubm9kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoZXMiKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDAsIG9NYXRjaCk7CgoJCQlyZXR1cm4gT2JqZWN0LmtleXMob01hdGNoKS5ldmVyeShrID0+IG9NYXRjaFtrXSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfbWF0Y2hpbmcocXVlcnkpIHsKCQl0cnkgewoJCQlsZXQgcmV0ID0gW107CgoJCQlsZXQgbWF0Y2hlcyA9IHRoaXMuX19leHBvcnQoe30sIHsKCgkJCQl0b29sOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgdG9vbCIpOwoJCQkJCW9iai50b29sID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJbm9kZTogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIG5vZGUiKTsKCQkJCQlvYmoubm9kZSA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX3ZhbHVlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3Rvb2xfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbm9kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXRvb2w6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy50b29sKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlub2RlOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMubm9kZShyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQl2YWx1ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3ZhbHVlJywgdW5kZWZpbmVkKSA6ICJ2YWx1ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl92YWx1ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMudmFsdWUocmVmKTsKCgkJCX0sCgoJCQl0b29sOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndG9vbCcsIHVuZGVmaW5lZCkgOiAidG9vbCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl90b29sX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLnRvb2woKSB8fCBuZXcgc2FsZXNub3cuVG9vbCgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMudG9vbChvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIHRvb2wiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCW5vZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKSA6ICJub2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25vZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMubm9kZSgpIHx8IG5ldyBzYWxlc25vdy5Ob2RlKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5ub2RlKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2Ugbm9kZSIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQl9LCAiX2Zyb21Eb2N1bWVudCIpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSB7CgkJbGV0IHJldCA9IHt9OwoKCQlpZiAoIWJUb29sKSB7CgkJCXJldC5fX2dlbmVyYXRlZCA9IG5ldyBEYXRlKCk7CgkJCWlmICh0aGlzLlRvb2wubmFtZSkgewoJCQkJcmV0Ll9fdG9vbCA9IHsKCQkJCQluYW1lOiB0aGlzLlRvb2wubmFtZSwKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlpZiAoc2FsZXNub3cuX25vZGUpIHsKCQkJCXJldC5fX25vZGUgPSB7CgkJCQkJY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogYkZ1bGwsCgkJCU51bGw6IGJOdWxsLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXSA9IHYsCgoJCQkidmFsdWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndmFsdWUnLCB1bmRlZmluZWQpIDogInZhbHVlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3ZhbHVlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl92YWx1ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInRvb2wiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndG9vbCcsIHVuZGVmaW5lZCkgOiAidG9vbCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX3Rvb2xfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3Rvb2xfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJub2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpIDogIm5vZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl9ub2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9ub2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3JkZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGw7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIG9ialtlYUNvZGVdID0gb2JqW2VhQ29kZV0ucmVwbGFjZSgvXC5bMC05XSpaL2csICcnKTsKCgkJCQlpZiAodGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGF0ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9uYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9uYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3JlbWFya19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCglieVRvb2woYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX3Rvb2wiXSAmJiAoYVsiX3Rvb2wiXS5FcXVhbHMgPyBhWyJfdG9vbCJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfdG9vbCJdLCByKSkpIHsKCQkJCQlyLl90b29sX0NvbmZpZ3MucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglieU5vZGUoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX25vZGUiXSAmJiAoYVsiX25vZGUiXS5FcXVhbHMgPyBhWyJfbm9kZSJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfbm9kZSJdLCByKSkpIHsKCQkJCQlyLl9ub2RlX0NvbmZpZ3MucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuX25hbWU7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IHRydWU7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkNvbmZpZy5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuQ29uZmlnKG51bGwsIHRoaXMuVG9vbCk7CgoJCQkJbGV0IGJGaW5kID0gZmFsc2U7CgkJCQlpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLklkID0gdGhpcy5JZDsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy50b29sKHRoaXMudG9vbCgpLCAnPScpOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLm5hbWUodGhpcy5uYW1lKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCWlmICh0eXBlb2Yoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgPT09ICJ1bmRlZmluZWQiIHx8IHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQkJCWF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsKCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiA9IHsKCQkJCQkJCU93bmVyOiB0aGlzLAoJCQkJCQkJc3FsczogW10sCgkJCQkJCQlzdGFydDogbmV3IERhdGUoKSwKCQkJCQkJCWVuZDogbnVsbAoJCQkJCQl9OwoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSB7CgkJCQkJdGhpcy5hY3RpdmUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSB7CgkJCQkJdGhpcy5lbmFibGVkKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgewoJCQkJCXRoaXMuZGF0ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSBuZXcgRGF0ZSgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl90b29sX3NldCAmJiB0aGlzLnRvb2woKSAmJiAhKGF3YWl0IHRoaXMudG9vbCgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX3Rvb2woKTsKCgkJCQkJaWYgKHRoaXMuX25vZGVfc2V0ICYmIHRoaXMubm9kZSgpICYmICEoYXdhaXQgdGhpcy5ub2RlKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfbm9kZSgpOwoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQkJaWYgKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uT3duZXIgPT0gdGhpcykgewoJCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGBDT01NSVQke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/JyBUUkFOU0FDVElPTic6Jyd9YCk7CgkJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCA9IG5ldyBEYXRlKCk7CgkJCQkJCX0KCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuQ29uZmlnLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkNvbmZpZy51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1VwZGF0ZVNRTCgpKTsKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTCgpKTsKCQkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IHJldFswXTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuQ29uZmlnLmZpbmRBbGwnKTsKCgkJCS8vIGF2b2lkcyBjeWNsaWMgcXVlcmllcwoJCQlvYmpzID0gKG9ianMgfHwgW10pLm1hcChvID0+IG8uX2Nsb25lKCkpOwoKCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLz8/CgoJCQlsZXQgcmV0ID0gW107IC8vIGEganNvbiBhcnJheQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCXJldCA9IChhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoZmllbGRzLCBvYmpzKSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2ApOwoJCQkJcmV0ID0gcmV0ID8gW0pTT04ucGFyc2UodGhpcy5fYXRvYihyZXQuY29udGVudCkpXSA6IFtdOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiQmVmb3JlIF9mcm9tRG9jdW1lbnQoKSIsIHJldCk7CgoJCQlyZXQgPSByZXQubWFwKHIgPT4gbmV3IHNhbGVzbm93LkNvbmZpZyhudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93LlRvb2wgPSBjbGFzcyBUb29sIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUWlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpuYVhSb2RXSXVkRzl2YkhNaU9pSm9kSFJ3Y3pvdkwzSmhkeTVuYVhSb2RXSjFjMlZ5WTI5dWRHVnVkQzVqYjIwdlptRmthVzR2Wm1Ga2FXNHVaMmwwYUhWaUxtbHZMMjFoYzNSbGNpOGlMQ0p6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpWYzJWeUlqcDdJbDloZFhSb2IzSnBlbVV1ZFhObGNtNWhiV1VpT2lKbVlXUnBJaXdpWDJGMWRHaHZjbWw2WlM1d1lYTnpkMjl5WkNJNklqRXlNeUlzSWw5aGRYUm9iM0pwZW1VdWRHVnpkRlZ6WlhJaU9uc2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0puWlc1a1pYSWlPbnNpWTI5a1pTSTZJazBpTENKdVlXMWxJam9pVFdGc1pTSjlMQ0pqYjJSbElqb2labUZrYVNJc0ltNWhiV1VpT2lKR1lXUnBJbjE5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpUY1d4RVFpSXNJa2RwZEVoMVlpSmRgKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLk1hcHBpbmdzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgVzEwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoKCQkvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUKCQl0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307CgkJdGhpcy5Ub29sID0gdG9vbDsKCQl0aGlzLklkID0gaWQ7CgoJCXRoaXMuVmFsdWVFbnRpdGllcyA9IFtdOwoKCQl0aGlzLkRhdGUgPSBudWxsOwoKCQl0aGlzLmNsZWFyX1RISVMoKTsKCQl0aGlzLkVudGl0eVZhbHVlcyA9IFtdOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInR5cGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3R5cGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2FjdGl2ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2VuYWJsZWQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb2RlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb2RlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3JkZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29yZGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZGF0ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZGF0ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm5hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX25hbWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3JlbWFyaygpOwoKCQl0aGlzLmNsZWFyX3Rvb2xfQ29uZmlncygpOwoKCQl0aGlzLmNsZWFyX3Rvb2xfTWFwcGluZ3MoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJUb29sIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQlyZXR1cm4gdGhpczsKCgkJaWYgKHRoaXMuX3R5cGVfc2V0ICYmIHRoaXMuX3R5cGUpIHRoaXMuX3R5cGUuVG9vbCA9IHRvb2w7CgoJCSh0aGlzLnRvb2xfQ29uZmlncygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCSh0aGlzLnRvb2xfTWFwcGluZ3MoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdHlwZSAqKi8KCXR5cGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl90eXBlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgidHlwZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2QwNzkwODNhLWYwYzAtNDdmYS1hMzk3LTliNWI4NjRlZDU3MicgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ1Rvb2wgVHlwZScpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0eXBlJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiZDA3OTA4M2EtZjBjMC00N2ZhLWEzOTctOWI1Yjg2NGVkNTcyIiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIlRvb2wgVHlwZSIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl90eXBlICE9IHYpIHsKCQkJCXRoaXMuX3R5cGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0eXBlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl90eXBlID8gdGhpcy5fdHlwZS5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fdHlwZV9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fdHlwZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl90eXBlKTsKCQl9Cgl9CgoJY2xlYXJfdHlwZSgpIHsKCQl0aGlzLl90eXBlX3NldCA9IG51bGw7CgkJdGhpcy5fdHlwZSA9IG51bGw7CgkJdGhpcy5fdHlwZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdHlwZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHRvb2xfQ29uZmlncyAqKi8KCXRvb2xfQ29uZmlncyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fdG9vbF9Db25maWdzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICdiYWRhZDQwNC0wYTNkLTRjODQtYmQ1Zi05NThiMDgzZTM0ZDknICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0NvbmZpZycpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fdG9vbF9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0b29sX0NvbmZpZ3MnLCAnRW50aXR5T2JqZWN0JywgMSwgInRvb2wgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkNvbmZpZyIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3Rvb2xfQ29uZmlncycsICdFbnRpdHlPYmplY3QnLCAxLCAidG9vbCBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkNvbmZpZyIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi50b29sKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX3Rvb2xfQ29uZmlncy5wdXNoKC4uLnYpOwoJCXRoaXMuX3Rvb2xfQ29uZmlnc19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fdG9vbF9Db25maWdzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl90b29sX0NvbmZpZ3MoKSB7CgkJdGhpcy5fdG9vbF9Db25maWdzX3NldCA9IG51bGw7CgkJdGhpcy5fdG9vbF9Db25maWdzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fdG9vbF9Db25maWdzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdG9vbF9Db25maWdzICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdG9vbF9NYXBwaW5ncyAqKi8KCXRvb2xfTWFwcGluZ3ModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX3Rvb2xfTWFwcGluZ3M7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzU0YzIxZmFhLTIzMDctNGIyYy04YWY0LTE3YWExZDhjNTUwYScgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnTWFwcGluZycpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fdG9vbF9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0b29sX01hcHBpbmdzJywgJ0VudGl0eU9iamVjdCcsIDEsICJ0b29sIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJNYXBwaW5nIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndG9vbF9NYXBwaW5ncycsICdFbnRpdHlPYmplY3QnLCAxLCAidG9vbCBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIk1hcHBpbmciKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YudG9vbCh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl90b29sX01hcHBpbmdzLnB1c2goLi4udik7CgkJdGhpcy5fdG9vbF9NYXBwaW5nc19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fdG9vbF9NYXBwaW5nc19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfdG9vbF9NYXBwaW5ncygpIHsKCQl0aGlzLl90b29sX01hcHBpbmdzX3NldCA9IG51bGw7CgkJdGhpcy5fdG9vbF9NYXBwaW5ncyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX3Rvb2xfTWFwcGluZ3NfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0b29sX01hcHBpbmdzICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fdHlwZV9zZXQsCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fdG9vbF9Db25maWdzX3NldCwKCgkJCXRoaXMuX3Rvb2xfTWFwcGluZ3Nfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fdHlwZV9zZXQgPSB0aGlzLl90eXBlX3NldDsKCQlyZXQuX3R5cGVfY29vcCA9IHRoaXMuX3R5cGVfY29vcDsKCQlyZXQudHlwZSA9IHRoaXMudHlwZSgpID8gdGhpcy50eXBlKCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMudHlwZSgpOwoKCQlyZXQuX2FjdGl2ZV9zZXQgPSB0aGlzLl9hY3RpdmVfc2V0OwoJCXJldC5fYWN0aXZlX2Nvb3AgPSB0aGlzLl9hY3RpdmVfY29vcDsKCQlyZXQuYWN0aXZlID0gdGhpcy5hY3RpdmUoKSA/IHRoaXMuYWN0aXZlKCkgOiB0aGlzLmFjdGl2ZSgpOwoKCQlyZXQuX2VuYWJsZWRfc2V0ID0gdGhpcy5fZW5hYmxlZF9zZXQ7CgkJcmV0Ll9lbmFibGVkX2Nvb3AgPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJcmV0LmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKSA/IHRoaXMuZW5hYmxlZCgpIDogdGhpcy5lbmFibGVkKCk7CgoJCXJldC5fY29kZV9zZXQgPSB0aGlzLl9jb2RlX3NldDsKCQlyZXQuX2NvZGVfY29vcCA9IHRoaXMuX2NvZGVfY29vcDsKCQlyZXQuY29kZSA9IHRoaXMuY29kZSgpID8gdGhpcy5jb2RlKCkgOiB0aGlzLmNvZGUoKTsKCgkJcmV0Ll9vcmRlcl9zZXQgPSB0aGlzLl9vcmRlcl9zZXQ7CgkJcmV0Ll9vcmRlcl9jb29wID0gdGhpcy5fb3JkZXJfY29vcDsKCQlyZXQub3JkZXIgPSB0aGlzLm9yZGVyKCkgPyB0aGlzLm9yZGVyKCkgOiB0aGlzLm9yZGVyKCk7CgoJCXJldC5fZGF0ZV9zZXQgPSB0aGlzLl9kYXRlX3NldDsKCQlyZXQuX2RhdGVfY29vcCA9IHRoaXMuX2RhdGVfY29vcDsKCQlyZXQuZGF0ZSA9IHRoaXMuZGF0ZSgpID8gdGhpcy5kYXRlKCkgOiB0aGlzLmRhdGUoKTsKCgkJcmV0Ll9uYW1lX3NldCA9IHRoaXMuX25hbWVfc2V0OwoJCXJldC5fbmFtZV9jb29wID0gdGhpcy5fbmFtZV9jb29wOwoJCXJldC5uYW1lID0gdGhpcy5uYW1lKCkgPyB0aGlzLm5hbWUoKSA6IHRoaXMubmFtZSgpOwoKCQlyZXQuX3JlbWFya19zZXQgPSB0aGlzLl9yZW1hcmtfc2V0OwoJCXJldC5fcmVtYXJrX2Nvb3AgPSB0aGlzLl9yZW1hcmtfY29vcDsKCQlyZXQucmVtYXJrID0gdGhpcy5yZW1hcmsoKSA/IHRoaXMucmVtYXJrKCkgOiB0aGlzLnJlbWFyaygpOwoKCQlyZXQudG9vbF9Db25maWdzID0gdGhpcy50b29sX0NvbmZpZ3MoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldC50b29sX01hcHBpbmdzID0gdGhpcy50b29sX01hcHBpbmdzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJ0eXBlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQl0b29sX0NvbmZpZ3M6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0b29sX1Rvb2xzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJdG9vbF9NYXBwaW5nczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Rvb2xfVG9vbHMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAidHlwZSIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgdHlwZScsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuVG9vbF9UeXBlKCkudHlwZV9Ub29scyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpICE9ICdUb29sJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL1Rvb2wvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQkJZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOwoJCQkJZGVsZXRlIGRhdGEuX190aGlzLm9ubGluZTsKCgkJCX0KCgkJCS8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/PwoKCQkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJCXRyeSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0pIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7bWV0aG9kfWApOwoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCWxldCBfaWQgPSBudWxsOwoJCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBkYXRhLCBtZXRob2QsIHt9KTsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRhdGEpID09PSAnc3RyaW5nJykgewoJCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUoZGF0YSk7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IGRhdGEuX190aGlzLmNvZGUgfHwgZGF0YS5pZCB8fCBkYXRhLklEOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJCWlmIChkYXRhLklkICYmIGRhdGEuSWQgPT0gZGF0YS5JZCkgewoJCQkJCQlfaWQgPSBkYXRhLklkOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQkJfSBlbHNlIGlmIChkYXRhLkVudGl0eUNsYXNzKSB7CgkJCQkJCV9pZCA9IGRhdGEuRW50aXR5Q2xhc3MuSWQgfHwgZGF0YS5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjMyZTgxMTczLTJhYjItNDY2Mi1hNzA2LTFjMzhlMzU5MjRkZSIgfHwgIk5VTEwiOwoJCQkJCX0KCQkJCX0KCgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbCB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbFttZXRob2RdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sW21ldGhvZF0gfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sW21ldGhvZF1bX2lkXSB8fCB7fTsKCgkJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goe30sIHsKCQkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQkJfSk7CgoJCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbFttZXRob2RdW19pZF1bX2hhc2hdOwoJCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiA1KSkgewoJCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gbWV0aG9kIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJCXYucmV1c2VkKys7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhKTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbFttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnVG9vbCcpLnNlbmRlcihzYWxlc25vdy5fbm9kZSkuY2FycmllcihzYWxlc25vdy5fbm9kZSkucGF5bG9hZChkYXRhKTsKCQkJaWYgKGV2ZW50KSB7CgkJCQlpZiAoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7CgkJCQlpZiAoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7CgkJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7CgkJCQlpZiAoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7CgkJCX0KCQkJcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOwoKCQkJaWYgKHR5cGVvZihyZXQpID09PSAic3RyaW5nIikgewoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChleCkge30KCQkJfQoJCQlyZXR1cm4gcmV0OwoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LlRvb2wobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93LlRvb2wobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVG9vbCgpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOwoJCX0KCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgVG9vbC5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYFRvb2wuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbC5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5Ub29sLicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlIHx8ICJUb29sIik7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCWlmICh0aGlzLl90eXBlX3NldCAmJiB0aGlzLnR5cGUoKSkgdGhpcy50eXBlKCkuX19zeW5jX29uKGQpOwoKCQkJLy8gdGhpcy50b29sX1Rvb2xzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCS8vIHRoaXMudG9vbF9Ub29scygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlRvb2wodGhpcy5JZCkKCgkJCS50eXBlKHRoaXMudHlwZSgpLCB0aGlzLl90eXBlX2Nvb3ApCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5jb2RlKHRoaXMuY29kZSgpLCB0aGlzLl9jb2RlX2Nvb3ApCgoJCQkub3JkZXIodGhpcy5vcmRlcigpLCB0aGlzLl9vcmRlcl9jb29wKQoKCQkJLmRhdGUodGhpcy5kYXRlKCksIHRoaXMuX2RhdGVfY29vcCkKCgkJCS5uYW1lKHRoaXMubmFtZSgpLCB0aGlzLl9uYW1lX2Nvb3ApCgoJCQkucmVtYXJrKHRoaXMucmVtYXJrKCksIHRoaXMuX3JlbWFya19jb29wKQoKCQkJLnRvb2xfQ29uZmlncyh0aGlzLnRvb2xfQ29uZmlncygpLCB0aGlzLl90b29sX0NvbmZpZ3NfY29vcCkKCgkJCS50b29sX01hcHBpbmdzKHRoaXMudG9vbF9NYXBwaW5ncygpLCB0aGlzLl90b29sX01hcHBpbmdzX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQlvYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ1Rvb2wnOwoJCXRvb2wgPSB0b29sIHx8IHRoaXMuVG9vbDsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJUb29sIjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCQkJCXJldCA9IHJldC50b0xvd2VyQ2FzZSgpOwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCQl0cnkgewoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgPyAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gb3B0aW9ucy50b29sIHx8IHQgPT0gb3B0aW9ucy50b29sKSA6IHRoaXMuVG9vbDsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sIHx8IHt9OwoKCQkJbGV0IG5JRCA9IHNhbGVzbm93Ll9ub2RlID8gc2FsZXNub3cuX25vZGUuY29kZSgpIDogImRlZmF1bHQiOwoKCQkJbGV0IHJldCA9IG51bGxWYWx1ZTsKCQkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0ID0gbnVsbDsKCgkJCS8vIHRvb2xfQ29uZmlnczogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBkb25lCgkJCWxldCB0Y29uZiA9IChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiBjLm5vZGUgJiYgYy5ub2RlLmNvZGUgPT0gbklEKS5jb25jYXQoKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmICFjLm5vZGUpKTsKCQkJaWYgKHRjb25mLmxlbmd0aCkgewoJCQkJcmV0ID0gdGNvbmZbMF0udmFsdWU7CgkJCQl0cnkgewoJCQkJCXJldCA9IEpTT04ucGFyc2UocmV0KTsKCQkJCX0gY2F0Y2ggKGpleCkge30KCQkJfQoKCQkJLy8gbW9kZWwgQ29uZmlnOiBDb25maWcgaXMgY2xhc3MgbGV2ZWwsIG5vZGUgbm90IHBvc3NpYmxlIC0gcGVuZGluZwoJCQlsZXQgbWNvbmYgPSB0aGlzLkNvbmZpZyA/IHRoaXMuQ29uZmlnW25dIDogdW5kZWZpbmVkOwoJCQlpZiAodHlwZW9mKG1jb25mKSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IG1jb25mOwoKCQkJLy8gY29tbWFuZCBsaW5lOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiBnbG9iYWwubWluaW1pc3QpIHsKCQkJCXJldCA9IGdsb2JhbC5taW5pbWlzdChwcm9jZXNzLmFyZ3Yuc2xpY2UoMikpW25dIHx8IHJldDsKCQkJfQoKCQkJLy8gcmVxdWVzdDogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCXJldCA9IHRoaXMuJF9SRVFVRVNUKG4pIHx8IHJldDsKCgkJCWlmIChvcHRpb25zLm5ld1ZhbHVlKSB7CgkJCQlsZXQgdGMgPSB0Y29uZi5sZW5ndGggPyB0Y29uZlswXSA6IHt9OwoJCQkJdGMubm9kZSA9IHsKCQkJCQljb2RlOiBvcHRpb25zLm5vZGUuY29kZSgpCgkJCQl9OwoJCQkJdGMudmFsdWUgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQkJdGMubmFtZSA9IG47CgkJCQlpZiAoIXRjb25mLmxlbmd0aCkgewoJCQkJCW9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MucHVzaCh0Yyk7CgkJCQl9CgkJCQlyZXQgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQl9CgoJCQkvLyBjb25maWcgcmVwbGFjZW1lbnQKCQkJaWYgKHR5cGVvZihyZXQpID09PSAnc3RyaW5nJykocmV0Lm1hdGNoKG5ldyBSZWdFeHAoYHt7KFtefV0rKX19YCwgImciKSkgfHwgW10pLmZvckVhY2gobSA9PiByZXQgPSByZXQucmVwbGFjZShtLCB0aGlzLl9fY29uZmlnKG0ucmVwbGFjZSgne3snLCAnJykucmVwbGFjZSgnfX0nLCAnJyksIG51bGwsIG9wdGlvbnMpKSk7CgoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fY29uZmlnJywgJ0VudGl0eU9iamVjdCcsIDEsIG4sIG51bGxWYWx1ZSwgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncywgZXgpOwoJCX0KCX0KCglfdG9TUUxUYWJsZSgpIHsKCQlsZXQgcmV0ID0gewoJCQlzcWw6IGBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9ICgKICAgICAgICAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgYAoJCX07CgkJcmV0LnNxbCArPSAnLypUb29sKi8pO1xuJzsKCgkJcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogdHJ1ZSwKCQkJTnVsbDogdHJ1ZSwKCQkJLy9JZDogKG9iaiwgdikgPT4gb2JqLnNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVlgLAoKCQkJInR5cGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQl0b29sX0NvbmZpZ3M6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0b29sX1Rvb2xzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJCXRvb2xfTWFwcGluZ3M6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0b29sX1Rvb2xzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJfSwgIl90b1NRTFRhYmxlIik7CgoJCS8vIHJldC5zcWwgKz0gJy8qVG9vbCovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJ0eXBlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy50eXBlKHRhYmxlWyJ0eXBlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuYWN0aXZlKHRhYmxlWyJhY3RpdmUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZW5hYmxlZCh0YWJsZVsiZW5hYmxlZCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5jb2RlKHRhYmxlWyJjb2RlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5vcmRlcih0YWJsZVsib3JkZXIiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZGF0ZSh0YWJsZVsiZGF0ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5uYW1lKHRhYmxlWyJuYW1lIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucmVtYXJrKHRhYmxlWyJyZW1hcmsiXSk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBfc3FsKHNxbCwgc291cmNlID0gdGhpcykgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsKHNxbCwgdGhpcyk7CgoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJCQkvLyBpZih0aGlzWydfJytmaWVsZCsnX3NldCddICYmICh0eXBlb2YodGhpc1snXycrZmllbGRdKT09PSd1bmRlZmluZWQnIHx8IHRoaXNbJ18nK2ZpZWxkXT09bnVsbCkpIHJldHVybjsKCQkJCQkvLyBpZih0eXBlb2YoZWFPYmopPT09J3VuZGVmaW5lZCcpIHJldHVybjsgLy8gd2h5PwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiMzJlODExNzMtMmFiMi00NjYyLWE3MDYtMWMzOGUzNTkyNGRlIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2wgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2wgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbFtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbFtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbFtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbFtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlpZiAoIXRoaXMudHlwZSgpIHx8ICh0aGlzLnR5cGUoKQoKCQkJCSYmCgkJCQkhdGhpcy50eXBlKCkudHlwZV9Ub29scygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy50eXBlKCkudHlwZV9NYXBwaW5ncygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygidHlwZSIsIG9iaiwgdGhpcy50eXBlKCkpOwoJCX0KCgkJX29wdGlvbnMoInRvb2xfQ29uZmlncyIsIG9iaiwgdGhpcy50b29sX0NvbmZpZ3MoKSk7CgoJCV9vcHRpb25zKCJ0b29sX01hcHBpbmdzIiwgb2JqLCB0aGlzLnRvb2xfTWFwcGluZ3MoKSk7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ3R5cGUnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3Rvb2xfQ29uZmlncycsICd0b29sX01hcHBpbmdzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJUb29sIiAmJiAobS50YXJnZXQgfHwgbS5vdXRTY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkgJiYgKCFtLnNvdXJjZSB8fCAobS5zb3VyY2UgJiYgLyohbS5vdXRTY3JpcHQgJiYqLyB0aGlzWydfJyArIG0uc291cmNlICsgJ19zZXQnXSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0ub3V0U2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5vdXRTY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5vdXRTY3JpcHR9KX1gKSh0aGlzLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS5zb3VyY2UpIHsKCQkJCWlmIChtLnNvdXJjZS5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMpID0+IHtyZXR1cm4gX3RoaXMuJHttLnNvdXJjZX07fWApKHRoaXMpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS5zb3VyY2UsIHRoaXMpOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnRhcmdldCkgb2JqW20udGFyZ2V0XSA9IHJldDsKCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJW20udGFyZ2V0IHx8IG0uc291cmNlXTogdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddCgkJCX0pOwoJCX0pOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCS8vIHVzZSB0aGlzLl9tYXAoKSB3aXRoIHJldmVyc2UKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmopOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiMzJlODExNzMtMmFiMi00NjYyLWE3MDYtMWMzOGUzNTkyNGRlIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2wgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2wgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbFtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbFtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbFtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcyk7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbFtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJ0eXBlIiwgb2JqKTsKCgkJX29wdGlvbnMoInRvb2xfQ29uZmlncyIsIG9iaik7CgoJCV9vcHRpb25zKCJ0b29sX01hcHBpbmdzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsndHlwZScsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsndG9vbF9Db25maWdzJywgJ3Rvb2xfTWFwcGluZ3MnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIlRvb2wiICYmIChtLnNvdXJjZSB8fCBtLmluU2NyaXB0KSAmJiBtLmFjdGl2ZSAmJiBtLmVuYWJsZWQgJiYgKChtLnRvb2wgJiYgbS50b29sLm5hbWUgPT0gdGhpcy5Ub29sLm5hbWUpIHx8IChtLnR5cGUgJiYgbS50eXBlLm5hbWUgPT0gdGhpcy5Ub29sLnR5cGUubmFtZSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0uaW5TY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAob2JqLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5pblNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLmluU2NyaXB0fSl9YCkob2JqLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS50YXJnZXQpIHsKCQkJCWlmIChtLnRhcmdldC5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAob2JqKSA9PiB7cmV0dXJuIG9iai4ke20udGFyZ2V0fTt9YCkob2JqKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKG9ialttLnRhcmdldF0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gb2JqW20udGFyZ2V0XSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnRhcmdldCwgb2JqKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gb2JqW20udGFyZ2V0XTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnNvdXJjZSkgewoJCQkJaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQl0aGlzW20uc291cmNlXShyZXQpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzW20uc291cmNlXSA9IHJldDsKCQkJCX0KCQkJfQoJCX0pOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9EQk9iamVjdChmaWVsZHMsIGJOb1JlZikgewoJCWlmICghdGhpcy5JZCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCAiSW52YWxpZCBJRCIsIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSwgdGhpcy5Ub29sKTsKCQl9CgkJbGV0IHJldCA9IHsKCQkJW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddOiAiJyIgKyB0aGlzLklkICsgIiciCgkJfTsKCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJ0eXBlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3R5cGVfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnR5cGUoKTsKCgkJCWlmICh2ICYmICh2Ll9fc3luY19vbigpIHx8IHYuSWQgPT0gdi5JZCkpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYuSWQgKyAiJyI7CgkJCX0gZWxzZSB7CgkJCQlmVmFsdWUgPSAwOwoJCQl9CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9hY3RpdmVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYWN0aXZlKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZW5hYmxlZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5lbmFibGVkKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvZGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29kZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2RhdGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZGF0ZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5uYW1lKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3JlbWFya19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5yZW1hcmsoKTsKCgkJCWZWYWx1ZSA9ICInIiArICgodiAmJiB2LnJlcGxhY2UpID8gdi5yZXBsYWNlKC9cJy9nLCAiXCdcJyIpIDogdikgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX1EoKSB7CgkJbGV0IF9vID0gJyInOwoJCWxldCBfcSA9IF9vOwoKCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXRoaXMuX19RID0gdGhpcy5fX1EgPT0gX28gPyBfcSA6IF9vOwoJCXJldHVybiB0aGlzLl9fUTsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcsIHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKV07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnR5cGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXSwKCgkJCQl0eXBlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnR5cGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU51bGw6IHRydWUsCgoJCQl0eXBlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LlRvb2xfVHlwZSgpLl90b1NlbGVjdEhlYWRlcigpLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoJCXNxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsKCgkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpIHsKCQkJLy8ge2ZpZWxkOiBmdW5jdGlvbn0KCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnR5cGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnR5cGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJdHlwZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3R5cGVfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl90eXBlX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jb2RlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fb3JkZXJfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vcmRlcl9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9kYXRlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LnRvSVNPU3RyaW5nKSB7CgkJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3FsaXRlJykgewoJCQkJCQlvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbmFtZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX25hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3JlbWFya19zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJdG9vbF9Db25maWdzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndG9vbF9Ub29scycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fdG9vbF9Db25maWdzX3NldCkgcmV0dXJuOwoKCQkJCWxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCgidG9vbC5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fdG9vbF9Db25maWdzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl90b29sX0NvbmZpZ3NfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fdG9vbF9Db25maWdzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX3Rvb2xfQ29uZmlnc19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX3Rvb2xfQ29uZmlnc19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLyp0b29sX0NvbmZpZ3MqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCQl0b29sX01hcHBpbmdzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndG9vbF9Ub29scycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fdG9vbF9NYXBwaW5nc19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoInRvb2wuaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX3Rvb2xfTWFwcGluZ3NfY29vcCA9PSAnIT0nIHx8IHRoaXMuX3Rvb2xfTWFwcGluZ3NfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fdG9vbF9NYXBwaW5nc19jb29wID09ICc9JyB8fCB0aGlzLl90b29sX01hcHBpbmdzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fdG9vbF9NYXBwaW5nc19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLyp0b29sX01hcHBpbmdzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQl9LCAiX3RvU2VsZWN0U1FMIiwgZmllbGRzKS5zcWw7CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJaWYgKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy50eXBlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnR5cGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJdHlwZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKSA9PiBvYmoudHlwZSA9IHYuX3RvUGF0aHMoKSwKCgkJCXRvb2xfQ29uZmlnczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Rvb2xfVG9vbHMnLCB1bmRlZmluZWQpKSA9PiBvYmoudG9vbF9Db25maWdzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCQl0b29sX01hcHBpbmdzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndG9vbF9Ub29scycsIHVuZGVmaW5lZCkpID0+IG9iai50b29sX01hcHBpbmdzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuVG9vbCkgcmV0dXJuOwoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5Ub29sID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5Ub29sKCkKCgkJCQkJLnR5cGUobmV3IHNhbGVzbm93LlRvb2xfVHlwZSgpKQoKCQkJCQkudG9vbF9Db25maWdzKG5ldyBzYWxlc25vdy5Db25maWcoKSkKCgkJCQkJLnRvb2xfTWFwcGluZ3MobmV3IHNhbGVzbm93Lk1hcHBpbmcoKSkKCgkJCQkJLl90b1NRTFRhYmxlKGRlcHRoKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIlRvb2wiKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJdHlwZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoudHlwZSA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkudHlwZSgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl90eXBlX3NldCAmJiAhcXVlcnkuX3R5cGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnR5cGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fdHlwZV9zZXQgJiYgcXVlcnkuX3R5cGVfc2V0KSB8fAoKCQkJCQkJKHRoaXMudHlwZSgpICYmICF0aGlzLnR5cGUoKS5fbWF0Y2hlcyhxdWVyeS50eXBlKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai50eXBlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWFjdGl2ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouYWN0aXZlID0gdiA9PSBxdWVyeS5hY3RpdmUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fYWN0aXZlX3NldCAmJiAhcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2FjdGl2ZV9zZXQgJiYgcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5lbmFibGVkID0gdiA9PSBxdWVyeS5lbmFibGVkKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ICYmICFxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9lbmFibGVkX3NldCAmJiBxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY29kZSA9IHYgPT0gcXVlcnkuY29kZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jb2RlX3NldCAmJiAhcXVlcnkuX2NvZGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY29kZV9zZXQgJiYgcXVlcnkuX2NvZGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vcmRlciA9IHYgPT0gcXVlcnkub3JkZXIoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fb3JkZXJfc2V0ICYmICFxdWVyeS5fb3JkZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX29yZGVyX3NldCAmJiBxdWVyeS5fb3JkZXJfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5kYXRlID0gdiA9PSBxdWVyeS5kYXRlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2RhdGVfc2V0ICYmICFxdWVyeS5fZGF0ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9kYXRlX3NldCAmJiBxdWVyeS5fZGF0ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubmFtZSA9IHYgPT0gcXVlcnkubmFtZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9uYW1lX3NldCAmJiAhcXVlcnkuX25hbWVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbmFtZV9zZXQgJiYgcXVlcnkuX25hbWVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gZmFsc2U7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucmVtYXJrID0gdiA9PSBxdWVyeS5yZW1hcmsoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcmVtYXJrX3NldCAmJiAhcXVlcnkuX3JlbWFya19zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3JlbWFya19zZXQgJiYgcXVlcnkuX3JlbWFya19zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IGZhbHNlOwoJCQkJfSwKCgkJCQl0b29sX0NvbmZpZ3M6IChvYmosIHYpID0+IHsKCQkJCQlvYmoudG9vbF9Db25maWdzID0gdi5tYXAoX3YgPT4gcXVlcnkudG9vbF9Db25maWdzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQkJdG9vbF9NYXBwaW5nczogKG9iaiwgdikgPT4gewoJCQkJCW9iai50b29sX01hcHBpbmdzID0gdi5tYXAoX3YgPT4gcXVlcnkudG9vbF9NYXBwaW5ncygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJdHlwZTogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIHR5cGUiKTsKCQkJCQlvYmoudHlwZSA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCXRvb2xfQ29uZmlnczogKG9iaiwgdikgPT4gewoJCQkJCW9iai50b29sX0NvbmZpZ3MgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJCXRvb2xfTWFwcGluZ3M6IChvYmosIHYpID0+IHsKCQkJCQlvYmoudG9vbF9NYXBwaW5ncyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fdHlwZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXR5cGU6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy50eXBlKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQl0b29sX0NvbmZpZ3M6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy50b29sX0NvbmZpZ3MoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJdG9vbF9NYXBwaW5nczogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLnRvb2xfTWFwcGluZ3MoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQl0eXBlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkgOiAidHlwZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl90eXBlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLnR5cGUoKSB8fCBuZXcgc2FsZXNub3cuVG9vbF9UeXBlKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy50eXBlKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgdHlwZSIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJdG9vbF9Db25maWdzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndG9vbF9Ub29scycsIHVuZGVmaW5lZCkgOiAidG9vbF9Db25maWdzIikpID0+IHRoaXMudG9vbF9Db25maWdzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5Db25maWcoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJCXRvb2xfTWFwcGluZ3M6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0b29sX1Rvb2xzJywgdW5kZWZpbmVkKSA6ICJ0b29sX01hcHBpbmdzIikpID0+IHRoaXMudG9vbF9NYXBwaW5ncyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuTWFwcGluZygpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQl9LCAiX2Zyb21Eb2N1bWVudCIpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSB7CgkJbGV0IHJldCA9IHt9OwoKCQlpZiAoIWJUb29sKSB7CgkJCXJldC5fX2dlbmVyYXRlZCA9IG5ldyBEYXRlKCk7CgkJCWlmICh0aGlzLlRvb2wubmFtZSkgewoJCQkJcmV0Ll9fdG9vbCA9IHsKCQkJCQluYW1lOiB0aGlzLlRvb2wubmFtZSwKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlpZiAoc2FsZXNub3cuX25vZGUpIHsKCQkJCXJldC5fX25vZGUgPSB7CgkJCQkJY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogYkZ1bGwsCgkJCU51bGw6IGJOdWxsLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXSA9IHYsCgoJCQkidHlwZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSA6ICJ0eXBlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fdHlwZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fdHlwZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQkJdG9vbF9Db25maWdzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndG9vbF9Ub29scycsIHVuZGVmaW5lZCkgOiAidG9vbF9Db25maWdzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX3Rvb2xfQ29uZmlnc19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fdG9vbF9Db25maWdzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQl0b29sX01hcHBpbmdzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndG9vbF9Ub29scycsIHVuZGVmaW5lZCkgOiAidG9vbF9NYXBwaW5ncyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl90b29sX01hcHBpbmdzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl90b29sX01hcHBpbmdzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCglieVRvb2xfVHlwZShhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfdHlwZSJdICYmIChhWyJfdHlwZSJdLkVxdWFscyA/IGFbIl90eXBlIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl90eXBlIl0sIHIpKSkgewoJCQkJCXIuX3R5cGVfVG9vbHMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuX25hbWU7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IHRydWU7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlRvb2wuc3RvcmUnKTsgLy8gb3IgaW5zaWRlIGV4ZWN1dGU/CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJbGV0IGJVcGRhdGUgPSBmYWxzZTsKCQkJbGV0IGJJbnNlcnQgPSBmYWxzZTsKCgkJCWlmICghdGhpcy5fX3N5bmNfb24oKSkgewoJCQkJbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LlRvb2wobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLm5hbWUodGhpcy5uYW1lKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCWlmICh0eXBlb2Yoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgPT09ICJ1bmRlZmluZWQiIHx8IHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQkJCWF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsKCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiA9IHsKCQkJCQkJCU93bmVyOiB0aGlzLAoJCQkJCQkJc3FsczogW10sCgkJCQkJCQlzdGFydDogbmV3IERhdGUoKSwKCQkJCQkJCWVuZDogbnVsbAoJCQkJCQl9OwoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSB7CgkJCQkJdGhpcy5hY3RpdmUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSB7CgkJCQkJdGhpcy5lbmFibGVkKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgewoJCQkJCXRoaXMuZGF0ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSBuZXcgRGF0ZSgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl90eXBlX3NldCAmJiB0aGlzLnR5cGUoKSAmJiAhKGF3YWl0IHRoaXMudHlwZSgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX3R5cGUoKTsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBGaW5pc2hlZCBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0gSWQ9WyR7dGhpcy5JZH1dYCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fdG9vbF9Db25maWdzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMudG9vbF9Db25maWdzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICh0aGlzLl90b29sX01hcHBpbmdzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMudG9vbF9NYXBwaW5ncygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlRvb2wuaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b0luc2VydFNRTCgpKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luc2VydCcsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuVG9vbC51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1VwZGF0ZVNRTCgpKTsKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTCgpKTsKCQkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IHJldFswXTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuVG9vbC5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSAoYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgKTsKCQkJCXJldCA9IHJldCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5Ub29sKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuVG9vbF9UeXBlID0gY2xhc3MgVG9vbF9UeXBlIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUWlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpPYjJSbElqcDdJbTV2UkdWMFpXTjBJanAwY25WbExDSnBibWwwTG1WdVpITWlPaklzSW1sdWFYUXViRzl2Y0NJNk1DNDFMQ0owYjI5c2N5NXpkRzl5WlNJNlptRnNjMlVzSW1SbGRHVmpkRkJoY21WdWRDNUpVQ0k2SWpFNU5TNHhNVEl1TWpFMkxqRTNNeUlzSW1SbGRHVmpkRkJoY21WdWRDNWpiMlJsSWpvaVpUaGtaVEEyWlRObFpHTTBORE5oWlRsa1ptVXhaR1UxWldNMU1tRTBZbVlpTENKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjBzSWxSdmIyd2lPbnNpWjJsMGFIVmlMblJ2YjJ4eklqb2lhSFIwY0hNNkx5OXlZWGN1WjJsMGFIVmlkWE5sY21OdmJuUmxiblF1WTI5dEwyWmhaR2x1TDJaaFpHbHVMbWRwZEdoMVlpNXBieTl0WVhOMFpYSXZJaXdpYzJWamNtVjBJam9pYjFOTGQyZGFNbk5MUms5VVNVcGpZa0ZtVlVsUk5FTnFPWEZ6U0RRNGJtd2lMQ0p3YkdGNVozSnZkVzVrSWpwMGNuVmxMQ0puVWxCRElqcDBjblZsTENKemRHOXlaUzV6Wlc1emFYUnBkbWwwZVNJNk1Td2lZMjl0Y0dGdWVTSTZJbkpsYzNWdFpTSjlMQ0p6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpWYzJWeUlqcDdJbDloZFhSb2IzSnBlbVV1ZFhObGNtNWhiV1VpT2lKbVlXUnBJaXdpWDJGMWRHaHZjbWw2WlM1d1lYTnpkMjl5WkNJNklqRXlNeUlzSWw5aGRYUm9iM0pwZW1VdWRHVnpkRlZ6WlhJaU9uc2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0puWlc1a1pYSWlPbnNpWTI5a1pTSTZJazBpTENKdVlXMWxJam9pVFdGc1pTSjlMQ0pqYjJSbElqb2labUZrYVNJc0ltNWhiV1VpT2lKR1lXUnBJbjE5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpUY1d4RVFpSXNJa2RwZEVoMVlpSmRgKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLk1hcHBpbmdzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgVzEwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoKCQkvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUKCQl0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307CgkJdGhpcy5Ub29sID0gdG9vbDsKCQl0aGlzLklkID0gaWQ7CgoJCXRoaXMuVmFsdWVFbnRpdGllcyA9IFtdOwoKCQl0aGlzLkRhdGUgPSBudWxsOwoKCQl0aGlzLmNsZWFyX1RISVMoKTsKCQl0aGlzLkVudGl0eVZhbHVlcyA9IFtdOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfdHlwZV9Ub29scygpOwoKCQl0aGlzLmNsZWFyX3R5cGVfTWFwcGluZ3MoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJUb29sIFR5cGUiLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCXJldHVybiB0aGlzOwoKCQkodGhpcy50eXBlX1Rvb2xzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJKHRoaXMudHlwZV9NYXBwaW5ncygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoJY29kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb2RlICE9IHYpIHsKCQkJCXRoaXMuX2NvZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29kZSk7CgkJfQoJfQoKCWNsZWFyX2NvZGUoKSB7CgkJdGhpcy5fY29kZV9zZXQgPSBudWxsOwoJCXRoaXMuX2NvZGUgPSBudWxsOwoJCXRoaXMuX2NvZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCglkYXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImRhdGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJyA/IF92IDogKG5ldyBEYXRlKF92KSk7CgkJCQlpZiAoaXNOYU4oX3YuZ2V0VGltZSgpKSkgX3YgPSBudWxsOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuRGF0ZVZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RhdGUgIT0gdikgewoJCQkJdGhpcy5fZGF0ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkRhdGVWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGF0ZSk7CgkJfQoJfQoKCWNsZWFyX2RhdGUoKSB7CgkJdGhpcy5fZGF0ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2RhdGUgPSBudWxsOwoJCXRoaXMuX2RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoJbmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9uYW1lICE9IHYpIHsKCQkJCXRoaXMuX25hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX25hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbmFtZSk7CgkJfQoJfQoKCWNsZWFyX25hbWUoKSB7CgkJdGhpcy5fbmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX25hbWUgPSBudWxsOwoJCXRoaXMuX25hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCglyZW1hcmsodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9yZW1hcmtfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZW1hcmsiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3JlbWFyayAhPSB2KSB7CgkJCQl0aGlzLl9yZW1hcmtfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3JlbWFyayA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcmVtYXJrKTsKCQl9Cgl9CgoJY2xlYXJfcmVtYXJrKCkgewoJCXRoaXMuX3JlbWFya19zZXQgPSBudWxsOwoJCXRoaXMuX3JlbWFyayA9IG51bGw7CgkJdGhpcy5fcmVtYXJrX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0eXBlX1Rvb2xzICoqLwoJdHlwZV9Ub29scyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fdHlwZV9Ub29sczsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnMzJlODExNzMtMmFiMi00NjYyLWE3MDYtMWMzOGUzNTkyNGRlJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdUb29sJykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll90eXBlX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3R5cGVfVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMSwgInR5cGUgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIlRvb2wiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0eXBlX1Rvb2xzJywgJ0VudGl0eU9iamVjdCcsIDEsICJ0eXBlIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiVG9vbCIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi50eXBlKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX3R5cGVfVG9vbHMucHVzaCguLi52KTsKCQl0aGlzLl90eXBlX1Rvb2xzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl90eXBlX1Rvb2xzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl90eXBlX1Rvb2xzKCkgewoJCXRoaXMuX3R5cGVfVG9vbHNfc2V0ID0gbnVsbDsKCQl0aGlzLl90eXBlX1Rvb2xzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fdHlwZV9Ub29sc19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHR5cGVfVG9vbHMgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0eXBlX01hcHBpbmdzICoqLwoJdHlwZV9NYXBwaW5ncyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fdHlwZV9NYXBwaW5nczsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnNTRjMjFmYWEtMjMwNy00YjJjLThhZjQtMTdhYTFkOGM1NTBhJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdNYXBwaW5nJykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll90eXBlX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3R5cGVfTWFwcGluZ3MnLCAnRW50aXR5T2JqZWN0JywgMSwgInR5cGUgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIk1hcHBpbmciKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0eXBlX01hcHBpbmdzJywgJ0VudGl0eU9iamVjdCcsIDEsICJ0eXBlIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiTWFwcGluZyIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi50eXBlKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX3R5cGVfTWFwcGluZ3MucHVzaCguLi52KTsKCQl0aGlzLl90eXBlX01hcHBpbmdzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl90eXBlX01hcHBpbmdzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl90eXBlX01hcHBpbmdzKCkgewoJCXRoaXMuX3R5cGVfTWFwcGluZ3Nfc2V0ID0gbnVsbDsKCQl0aGlzLl90eXBlX01hcHBpbmdzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fdHlwZV9NYXBwaW5nc19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHR5cGVfTWFwcGluZ3MgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fdHlwZV9Ub29sc19zZXQsCgoJCQl0aGlzLl90eXBlX01hcHBpbmdzX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX2FjdGl2ZV9zZXQgPSB0aGlzLl9hY3RpdmVfc2V0OwoJCXJldC5fYWN0aXZlX2Nvb3AgPSB0aGlzLl9hY3RpdmVfY29vcDsKCQlyZXQuYWN0aXZlID0gdGhpcy5hY3RpdmUoKSA/IHRoaXMuYWN0aXZlKCkgOiB0aGlzLmFjdGl2ZSgpOwoKCQlyZXQuX2VuYWJsZWRfc2V0ID0gdGhpcy5fZW5hYmxlZF9zZXQ7CgkJcmV0Ll9lbmFibGVkX2Nvb3AgPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJcmV0LmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKSA/IHRoaXMuZW5hYmxlZCgpIDogdGhpcy5lbmFibGVkKCk7CgoJCXJldC5fY29kZV9zZXQgPSB0aGlzLl9jb2RlX3NldDsKCQlyZXQuX2NvZGVfY29vcCA9IHRoaXMuX2NvZGVfY29vcDsKCQlyZXQuY29kZSA9IHRoaXMuY29kZSgpID8gdGhpcy5jb2RlKCkgOiB0aGlzLmNvZGUoKTsKCgkJcmV0Ll9vcmRlcl9zZXQgPSB0aGlzLl9vcmRlcl9zZXQ7CgkJcmV0Ll9vcmRlcl9jb29wID0gdGhpcy5fb3JkZXJfY29vcDsKCQlyZXQub3JkZXIgPSB0aGlzLm9yZGVyKCkgPyB0aGlzLm9yZGVyKCkgOiB0aGlzLm9yZGVyKCk7CgoJCXJldC5fZGF0ZV9zZXQgPSB0aGlzLl9kYXRlX3NldDsKCQlyZXQuX2RhdGVfY29vcCA9IHRoaXMuX2RhdGVfY29vcDsKCQlyZXQuZGF0ZSA9IHRoaXMuZGF0ZSgpID8gdGhpcy5kYXRlKCkgOiB0aGlzLmRhdGUoKTsKCgkJcmV0Ll9uYW1lX3NldCA9IHRoaXMuX25hbWVfc2V0OwoJCXJldC5fbmFtZV9jb29wID0gdGhpcy5fbmFtZV9jb29wOwoJCXJldC5uYW1lID0gdGhpcy5uYW1lKCkgPyB0aGlzLm5hbWUoKSA6IHRoaXMubmFtZSgpOwoKCQlyZXQuX3JlbWFya19zZXQgPSB0aGlzLl9yZW1hcmtfc2V0OwoJCXJldC5fcmVtYXJrX2Nvb3AgPSB0aGlzLl9yZW1hcmtfY29vcDsKCQlyZXQucmVtYXJrID0gdGhpcy5yZW1hcmsoKSA/IHRoaXMucmVtYXJrKCkgOiB0aGlzLnJlbWFyaygpOwoKCQlyZXQudHlwZV9Ub29scyA9IHRoaXMudHlwZV9Ub29scygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0LnR5cGVfTWFwcGluZ3MgPSB0aGlzLnR5cGVfTWFwcGluZ3MoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCXR5cGVfVG9vbHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlX1Rvb2xfVHlwZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQl0eXBlX01hcHBpbmdzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZV9Ub29sX1R5cGVzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX3RvSGFzaCIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMuTm9Db2RlID8gb0hhc2ggOiB0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7Cgl9CgoJYXN5bmMgX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOwoKCX0KCglfcWxTZWxlY3Rpb25zKHNTZXQpIHsKCQlsZXQgcmV0ID0gW107CgkJaWYgKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7CgoJCXNTZXQuc2VsZWN0aW9ucy5maWx0ZXIocyA9PiBzLnNlbGVjdGlvblNldCkuZm9yRWFjaChzID0+IHsKCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpICE9ICdUb29sX1R5cGUnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiRGVsZWdhdGluZyBpbnZva2F0aW9uIHRvICIgKyBldmVudC5jbGFzc05hbWUoKSk7CgkJCQlyZXR1cm4gbmV3IHNhbGVzbm93W2V2ZW50LmNsYXNzTmFtZSgpXSgpLl9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpOwoJCQl9CgoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQlkYXRhLl9fdGhpcyA9IGRhdGEuX190aGlzIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkJc3dpdGNoIChtZXRob2QpIHsKCgkJCX0KCQl9CgoJCWlmICghbiB8fCBzYWxlc25vdy5fbm9kZS5fc2FtZU5vZGUobikpIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkNhbGxiYWNrIik7CgkJCXJldCA9IGF3YWl0IHRoaXMuX2ludm9rZShtZXRob2QsIGRhdGEpOwoJCX0gZWxzZSBpZiAobi5hZGRyZXNzKCkgJiYgbi5fc2FtZU5vZGUobikgLyphY3R1YWwgbm9kZSovICkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBuLl9hZGRyZXNzLCBuLl9wb3J0LCBtZXRob2QpOwoJCQl0cnkgewoJCQkJbGV0IGNvbmZpZyA9IHsKCQkJCQloZWFkZXJzOiB7fSwKCQkJCX07CgkJCQlpZiAoc2FsZXNub3cuX190b2tlbikgY29uZmlnLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGAke3NhbGVzbm93Ll9fdG9rZW4udG9rZW5fdHlwZX0gJHtzYWxlc25vdy5fX3Rva2VuLmFjY2Vzc190b2tlbn1gOwoJCQkJcmV0ID0gYXdhaXQgYXhpb3MucG9zdChgaHR0cCR7bi5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHtuLmFkZHJlc3MoKX06JHtuLnBvcnQoKSB8fCAzMDAwfS9tZXRob2QvVG9vbF9UeXBlLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7CgoJCQl9CgoJCQkvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8KCgkJCWxldCB2ID0gdW5kZWZpbmVkOwoJCQl0cnkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke21ldGhvZH1gKTsKCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQlsZXQgX2lkID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgZGF0YSwgbWV0aG9kLCB7fSk7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIHsKCQkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKGRhdGEpOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSBkYXRhLl9fdGhpcy5jb2RlIHx8IGRhdGEuaWQgfHwgZGF0YS5JRDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCQlpZiAoZGF0YS5JZCAmJiBkYXRhLklkID09IGRhdGEuSWQpIHsKCQkJCQkJX2lkID0gZGF0YS5JZDsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5FbnRpdHlDbGFzcykgewoJCQkJCQlfaWQgPSBkYXRhLkVudGl0eUNsYXNzLklkIHx8IGRhdGEuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJkMDc5MDgzYS1mMGMwLTQ3ZmEtYTM5Ny05YjViODY0ZWQ1NzIiIHx8ICJOVUxMIjsKCQkJCQl9CgkJCQl9CgoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sX1R5cGVbbWV0aG9kXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlW21ldGhvZF0gfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVttZXRob2RdW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVttZXRob2RdW19pZF0gfHwge307CgoJCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKHt9LCB7CgkJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJCX0pOwoKCQkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVttZXRob2RdW19pZF1bX2hhc2hdOwoJCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiA1KSkgewoJCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gbWV0aG9kIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJCXYucmV1c2VkKys7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhKTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlW21ldGhvZF1bX2lkXVtfaGFzaF0gPSB7CgkJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoe30pLAoJCQkJCW9iajogZGF0YSwKCQkJCQlyZXVzZWQ6IDAsCgkJCQl9OwoJCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0gPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGRhdGEsIG1ldGhvZCwge30sIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBgVHJpZ2dlcnJpbmcgJHttZXRob2R9IHRvICR7bi5jb2RlKCl9ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSxudWxsLDQpfWApOwoKCQkJbGV0IGV2ID0gbmV3IHNhbGVzbm93LkV2ZW50KCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuY29kZSh0aGlzLl91dWlkKCkpLm5hbWUodGhpcy5fX2NvbmZpZygnZXZlbnQnKSB8fCAnc2FsZXNub3cuRXZlbnQnKS5kYXRlKHRoaXMuc2VydmVyRGF0ZSgpKS5yZWNpcGllbnQobikubWV0aG9kKG1ldGhvZCkuY2xhc3NOYW1lKCdUb29sX1R5cGUnKS5zZW5kZXIoc2FsZXNub3cuX25vZGUpLmNhcnJpZXIoc2FsZXNub3cuX25vZGUpLnBheWxvYWQoZGF0YSk7CgkJCWlmIChldmVudCkgewoJCQkJaWYgKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOwoJCQkJaWYgKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOwoJCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJaWYgKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOwoJCQl9CgkJCXJldCA9IGF3YWl0IGV2LnRyaWdnZXIoKTsKCgkJCWlmICh0eXBlb2YocmV0KSA9PT0gInN0cmluZyIpIHsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCX0KCQkJcmV0dXJuIHJldDsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5Ub29sX1R5cGUobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93LlRvb2xfVHlwZShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocCkpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHt9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2UobWV0aG9kLCBib2R5LCBxdWVyeSwgYXV0aE9iaikgewoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgbWV0aG9kLCBxdWVyeSwgYm9keSk7CgoJCWlmICh0eXBlb2YoYm9keSkgPT09ICdzdHJpbmcnIHx8ICh0eXBlb2YoQnVmZmVyKSAhPT0gJ3VuZGVmaW5lZCcgJiYgQnVmZmVyLmlzQnVmZmVyKGJvZHkpKSkgewoJCQl0cnkgewoJCQkJYm9keSA9IEpTT04ucGFyc2UoYm9keS50b1N0cmluZygpKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJvZHkgaXMgbm90IGEgdmFsaWQgSlNPTiIsIGJvZHkpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoKCQlsZXQgX3BhcmFtcyA9IHF1ZXJ5ID8gT2JqZWN0LmFzc2lnbihxdWVyeSwgYm9keSkgOiBib2R5OwoJCWlmICh0eXBlb2YoX3BhcmFtcykgPT09ICdzdHJpbmcnKSBfcGFyYW1zID0gSlNPTi5wYXJzZShfcGFyYW1zKTsKCgkJaWYgKF9wYXJhbXMpIHsKCQkJX3BhcmFtcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcyk7CgkJfSBlbHNlIHsKCQkJX3BhcmFtcyA9IHt9OwoJCX0KCgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgX3BhcmFtcy5fX2ZsYXR0ZWQpIF9wYXJhbXMgPSBGbGF0dGVkLnBhcnNlKF9wYXJhbXMuX19mbGF0dGVkKTsKCgkJaWYgKF9wYXJhbXMuX19ub2RlKSB7CgkJCS8vIHByb2JhYmx5IHNob3VsZCBub3QgYmUgcHJvY2Vzc2VkIGhlcmUsIGJ1dCByYXRoZXIgY29uc3VtZWQgYXMgcGFydCBvZiB0aGUgZXhlY3V0ZSgpIGxvZ2ljLCBwdXNoaW5nIF9fbm9kZSB0byB0aGUgbGlzdCBvZiBteSBub2RlcyB0byBkZWxlZ2F0ZSB0byE/CgkJCWxldCB0biA9IG5ldyBzYWxlc25vdy5Ob2RlKCkuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fbm9kZSkuX2RlUmVmZXJlbmNlKCk7CgkJCWRlbGV0ZSBfcGFyYW1zLl9fbm9kZTsKCQkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Ub29sX1R5cGUoKS5faW52b2tlTm9kZSh0biwgbWV0aG9kLCBfcGFyYW1zKTsKCQl9CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYFRvb2xfVHlwZS5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYFRvb2xfVHlwZS5faW52b2tlOiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLAoJCQkJCSdvYmonOiBvYmoKCQkJCX0KCQkJfTsKCQl9IGVsc2UgewoJCQlyZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOwoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJaWYgKGZhbHNlICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQlyZXQgPSB7CgkJCQkJX19leGNlcHRpb246IHsKCQkJCQkJJy00JzogIlVuY29tbWl0dGVkIHRyYW5zYWN0aW9uczogIiArIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uc3Fscy5sZW5ndGgsCgkJCQkJCSdvYmonOiBvYmoKCQkJCQl9CgkJCQl9CgkJCX0KCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQl9CgoJCWlmIChyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbikgewoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0ge307CgkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCXJldCA9IHJldC5tYXAociA9PiB7CgkJCQkJaWYgKHIgJiYgci5fdG9Eb2N1bWVudCkgewoJCQkJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sX1R5cGUuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuVG9vbF9UeXBlLicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlIHx8ICJUb29sIFR5cGUiKTsKCgl9CgoJX19zeW5jX29uKGQpIHsKCQl0aGlzLl9fX3N5bmNfb24gPSB0aGlzLl9fX3N5bmNfb24gfHwge307CgoJCWlmIChkKSB7CgkJCXRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV0gPSBkOwoKCQkJLy8gdGhpcy50eXBlX1Rvb2xfVHlwZXMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJLy8gdGhpcy50eXBlX1Rvb2xfVHlwZXMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Ub29sX1R5cGUodGhpcy5JZCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkudHlwZV9Ub29scyh0aGlzLnR5cGVfVG9vbHMoKSwgdGhpcy5fdHlwZV9Ub29sc19jb29wKQoKCQkJLnR5cGVfTWFwcGluZ3ModGhpcy50eXBlX01hcHBpbmdzKCksIHRoaXMuX3R5cGVfTWFwcGluZ3NfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCkgewoJCWNvbnRleHQgPSBjb250ZXh0IHx8ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCW9iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQlvYmpUbyA9IG9ialRvIHx8IHt9OwoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAnVG9vbF9UeXBlJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiVG9vbF9UeXBlIjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCQkJCXJldCA9IHJldC50b0xvd2VyQ2FzZSgpOwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCQl0cnkgewoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgPyAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gb3B0aW9ucy50b29sIHx8IHQgPT0gb3B0aW9ucy50b29sKSA6IHRoaXMuVG9vbDsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sIHx8IHt9OwoKCQkJbGV0IG5JRCA9IHNhbGVzbm93Ll9ub2RlID8gc2FsZXNub3cuX25vZGUuY29kZSgpIDogImRlZmF1bHQiOwoKCQkJbGV0IHJldCA9IG51bGxWYWx1ZTsKCQkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0ID0gbnVsbDsKCgkJCS8vIHRvb2xfQ29uZmlnczogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBkb25lCgkJCWxldCB0Y29uZiA9IChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiBjLm5vZGUgJiYgYy5ub2RlLmNvZGUgPT0gbklEKS5jb25jYXQoKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmICFjLm5vZGUpKTsKCQkJaWYgKHRjb25mLmxlbmd0aCkgewoJCQkJcmV0ID0gdGNvbmZbMF0udmFsdWU7CgkJCQl0cnkgewoJCQkJCXJldCA9IEpTT04ucGFyc2UocmV0KTsKCQkJCX0gY2F0Y2ggKGpleCkge30KCQkJfQoKCQkJLy8gbW9kZWwgQ29uZmlnOiBDb25maWcgaXMgY2xhc3MgbGV2ZWwsIG5vZGUgbm90IHBvc3NpYmxlIC0gcGVuZGluZwoJCQlsZXQgbWNvbmYgPSB0aGlzLkNvbmZpZyA/IHRoaXMuQ29uZmlnW25dIDogdW5kZWZpbmVkOwoJCQlpZiAodHlwZW9mKG1jb25mKSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IG1jb25mOwoKCQkJLy8gY29tbWFuZCBsaW5lOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiBnbG9iYWwubWluaW1pc3QpIHsKCQkJCXJldCA9IGdsb2JhbC5taW5pbWlzdChwcm9jZXNzLmFyZ3Yuc2xpY2UoMikpW25dIHx8IHJldDsKCQkJfQoKCQkJLy8gcmVxdWVzdDogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCXJldCA9IHRoaXMuJF9SRVFVRVNUKG4pIHx8IHJldDsKCgkJCWlmIChvcHRpb25zLm5ld1ZhbHVlKSB7CgkJCQlsZXQgdGMgPSB0Y29uZi5sZW5ndGggPyB0Y29uZlswXSA6IHt9OwoJCQkJdGMubm9kZSA9IHsKCQkJCQljb2RlOiBvcHRpb25zLm5vZGUuY29kZSgpCgkJCQl9OwoJCQkJdGMudmFsdWUgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQkJdGMubmFtZSA9IG47CgkJCQlpZiAoIXRjb25mLmxlbmd0aCkgewoJCQkJCW9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MucHVzaCh0Yyk7CgkJCQl9CgkJCQlyZXQgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQl9CgoJCQkvLyBjb25maWcgcmVwbGFjZW1lbnQKCQkJaWYgKHR5cGVvZihyZXQpID09PSAnc3RyaW5nJykocmV0Lm1hdGNoKG5ldyBSZWdFeHAoYHt7KFtefV0rKX19YCwgImciKSkgfHwgW10pLmZvckVhY2gobSA9PiByZXQgPSByZXQucmVwbGFjZShtLCB0aGlzLl9fY29uZmlnKG0ucmVwbGFjZSgne3snLCAnJykucmVwbGFjZSgnfX0nLCAnJyksIG51bGwsIG9wdGlvbnMpKSk7CgoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fY29uZmlnJywgJ0VudGl0eU9iamVjdCcsIDEsIG4sIG51bGxWYWx1ZSwgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncywgZXgpOwoJCX0KCX0KCglfdG9TUUxUYWJsZSgpIHsKCQlsZXQgcmV0ID0gewoJCQlzcWw6IGBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9ICgKICAgICAgICAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICBgCgkJfTsKCQlyZXQuc3FsICs9ICcvKlRvb2xfVHlwZSovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQl0eXBlX1Rvb2xzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZV9Ub29sX1R5cGVzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJCXR5cGVfTWFwcGluZ3M6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlX1Rvb2xfVHlwZXMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypUb29sX1R5cGUqLyk7XG4nOwoKCQlyZXQuc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChyZXQuc3FsKSA6IHJldC5zcWw7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NRTFRhYmxlJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldC5zcWwpOwoJCXJldHVybiByZXQuc3FsOwoJfQoKCV9mcm9tU1FMVGFibGUodGFibGUsIGZpZWxkcykgewoJCS8vIHRhYmxlIGlzIGEganNvbiBhcnJheQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5hY3RpdmUodGFibGVbImFjdGl2ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5lbmFibGVkKHRhYmxlWyJlbmFibGVkIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvZGUodGFibGVbImNvZGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9yZGVyKHRhYmxlWyJvcmRlciJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5kYXRlKHRhYmxlWyJkYXRlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm5hbWUodGFibGVbIm5hbWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5yZW1hcmsodGFibGVbInJlbWFyayJdKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIF9zcWwoc3FsLCBzb3VyY2UgPSB0aGlzKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWwoc3FsLCB0aGlzKTsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgoJCQkJCS8vIGlmKHRoaXNbJ18nK2ZpZWxkKydfc2V0J10gJiYgKHR5cGVvZih0aGlzWydfJytmaWVsZF0pPT09J3VuZGVmaW5lZCcgfHwgdGhpc1snXycrZmllbGRdPT1udWxsKSkgcmV0dXJuOwoJCQkJCS8vIGlmKHR5cGVvZihlYU9iaik9PT0ndW5kZWZpbmVkJykgcmV0dXJuOyAvLyB3aHk/CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlyZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqLCB0aGlzLmNvZGUoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmosIHRoaXMuZGF0ZSgpKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmosIHRoaXMubmFtZSgpKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaiwgdGhpcy5yZW1hcmsoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJkMDc5MDgzYS1mMGMwLTQ3ZmEtYTM5Ny05YjViODY0ZWQ1NzIiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sX1R5cGUgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sX1R5cGVbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlfb3B0aW9ucygidHlwZV9Ub29scyIsIG9iaiwgdGhpcy50eXBlX1Rvb2xzKCkpOwoKCQlfb3B0aW9ucygidHlwZV9NYXBwaW5ncyIsIG9iaiwgdGhpcy50eXBlX01hcHBpbmdzKCkpOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsndHlwZV9Ub29scycsICd0eXBlX01hcHBpbmdzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJUb29sX1R5cGUiICYmIChtLnRhcmdldCB8fCBtLm91dFNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSAmJiAoIW0uc291cmNlIHx8IChtLnNvdXJjZSAmJiAvKiFtLm91dFNjcmlwdCAmJiovIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX3NldCddKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5vdXRTY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMsIG9TY29wZSwgbWFwKSA9PiB7JHttLm91dFNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLm91dFNjcmlwdH0pfWApKHRoaXMsIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnNvdXJjZSkgewoJCQkJaWYgKG0uc291cmNlLmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcykgPT4ge3JldHVybiBfdGhpcy4ke20uc291cmNlfTt9YCkodGhpcyk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnNvdXJjZSwgdGhpcyk7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0udGFyZ2V0KSBvYmpbbS50YXJnZXRdID0gcmV0OwoJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQlbbS50YXJnZXQgfHwgbS5zb3VyY2VdOiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10KCQkJfSk7CgkJfSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJLy8gdXNlIHRoaXMuX21hcCgpIHdpdGggcmV2ZXJzZQoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJkMDc5MDgzYS1mMGMwLTQ3ZmEtYTM5Ny05YjViODY0ZWQ1NzIiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sX1R5cGUgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sX1R5cGVbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJ0eXBlX1Rvb2xzIiwgb2JqKTsKCgkJX29wdGlvbnMoInR5cGVfTWFwcGluZ3MiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsndHlwZV9Ub29scycsICd0eXBlX01hcHBpbmdzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJUb29sX1R5cGUiICYmIChtLnNvdXJjZSB8fCBtLmluU2NyaXB0KSAmJiBtLmFjdGl2ZSAmJiBtLmVuYWJsZWQgJiYgKChtLnRvb2wgJiYgbS50b29sLm5hbWUgPT0gdGhpcy5Ub29sLm5hbWUpIHx8IChtLnR5cGUgJiYgbS50eXBlLm5hbWUgPT0gdGhpcy5Ub29sLnR5cGUubmFtZSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0uaW5TY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAob2JqLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5pblNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLmluU2NyaXB0fSl9YCkob2JqLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS50YXJnZXQpIHsKCQkJCWlmIChtLnRhcmdldC5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAob2JqKSA9PiB7cmV0dXJuIG9iai4ke20udGFyZ2V0fTt9YCkob2JqKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKG9ialttLnRhcmdldF0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gb2JqW20udGFyZ2V0XSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnRhcmdldCwgb2JqKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gb2JqW20udGFyZ2V0XTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnNvdXJjZSkgewoJCQkJaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQl0aGlzW20uc291cmNlXShyZXQpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzW20uc291cmNlXSA9IHJldDsKCQkJCX0KCQkJfQoJCX0pOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9EQk9iamVjdChmaWVsZHMsIGJOb1JlZikgewoJCWlmICghdGhpcy5JZCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCAiSW52YWxpZCBJRCIsIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSwgdGhpcy5Ub29sKTsKCQl9CgkJbGV0IHJldCA9IHsKCQkJW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddOiAiJyIgKyB0aGlzLklkICsgIiciCgkJfTsKCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fYWN0aXZlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2VuYWJsZWRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9jb2RlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNvZGUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9vcmRlcl9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5vcmRlcigpOwoKCQkJZlZhbHVlID0gdiB8fCAnMCc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9kYXRlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmRhdGUoKTsKCgkJCXRyeSB7CgkJCQlmVmFsdWUgPSAiJyIgKyAodiA/IHYudG9JU09TdHJpbmcoKSA6ICIxOTcwLTEtMSIpICsgIiciOwoJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnKSB7CgkJCQkJZlZhbHVlID0gYFNUUl9UT19EQVRFKCR7ZlZhbHVlfSwgJyVZLSVtLSVkVCVULiVmWicpYDsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gJ2RhdGV0aW1lKCcgKyBmVmFsdWUgKyAnKSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX25hbWVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMubmFtZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9yZW1hcmtfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucmVtYXJrKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9RKCkgewoJCWxldCBfbyA9ICciJzsKCQlsZXQgX3EgPSBfbzsKCgkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgewoJCQlfbyA9IF9xID0gJ2AnOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxzZXJ2ZXInKSB7CgkJCV9vID0gJ1snOwoJCQlfcSA9ICddJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ2FwaUtleScpID09ICdhaXJ0YWJsZScpIHsKCQkJX28gPSAneyc7CgkJCV9xID0gJ30nOwoJCX0KCQl0aGlzLl9fUSA9IHRoaXMuX19RID09IF9vID8gX3EgOiBfbzsKCQlyZXR1cm4gdGhpcy5fX1E7Cgl9CgoJX2ZpZWxkR3JvdXBzKGZncyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOwoJCXJldHVybiB0aGlzOwoJfQoKCV9maWVsZEFnZ3JlZ2F0ZXMoZmFzID0ge30pIHsKCQl0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOwoJCXJldHVybiB0aGlzOwoJfQoKCV90b0ZpZWxkc1NRTChmaWVsZHMpIHsKCgkJZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKV07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9YCk7CgoJCX0KCQlyZXR1cm4gZmllbGRzOwoJfQoKCV9mcm9tREJPYmplY3QociA9IHt9KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMuX19pbXBvcnQociwgewoJCQkJSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddLAoKCQkJCWFjdGl2ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmFjdGl2ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZW5hYmxlZChvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuY29kZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5vcmRlcihvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZGF0ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMubmFtZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnJlbWFyayhvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJfSwgIl9mcm9tREJPYmplY3QiKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX3RvU2VsZWN0SGVhZGVyKGZpZWxkcykgewoJCWxldCByZXQgPSB7CgkJCXRhYmxlOiB0aGlzLl9uQ29kZSgpLAoJCQlmaWVsZHM6IERvdE9iamVjdC5vYmplY3QoT2JqZWN0LmZyb21FbnRyaWVzKHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLm1hcChmID0+IFtmLCBmXSkpKSwKCQkJam9pbnM6IHt9LAoJCX07CgoJCWlmIChmaWVsZHMpIHJldHVybiByZXQ7CgoJCXJldC5qb2lucyA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJTnVsbDogdHJ1ZSwKCgkJfSwgIl90b1NlbGVjdEhlYWRlciIpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RIZWFkZXInLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9TZWxlY3RTUUwoZmllbGRzKSB7CgkJbGV0IHNxbCA9ICJzZWxlY3QgIjsKCgkJbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX1gOwoKCQlsZXQgaGVhZGVyID0gdGhpcy5fdG9TZWxlY3RIZWFkZXIoZmllbGRzKTsKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCX0KCgkJc3FsICs9IGAgZnJvbSAke3RQcmVmfSBgOwoKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gYGxlZnQgam9pbiAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX0ke3RoaXMuX1EoKX0gYXMgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0gb24gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtrfWlkJHt0aGlzLl9RKCl9PSR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IGApOwoKCQlzcWwgKz0gYCB3aGVyZSAxPTFgOwoKCQlzcWwgPSB0aGlzLl9fZXhwb3J0KHsKCQkJc3FsOiBzcWwKCQl9LCB7CgkJCV9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgPyBbJ0lkJ10gOiB1bmRlZmluZWQsCgkJCU51bGw6IHRydWUsCgkJCV9USElTOiBvYmogPT4gewoJCQkJaWYgKCF0aGlzLl9USElTIHx8ICF0aGlzLl9USElTLmxlbmd0aCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCh0Ll9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnKSkuam9pbignIFVOSU9OIEFMTCAnKSArICIpIjsKCQkJfSwKCQkJSWQ6IG9iaiA9PiBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2AsCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvZGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2RhdGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVtYXJrX3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQl0eXBlX1Rvb2xzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZV9Ub29sX1R5cGVzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl90eXBlX1Rvb2xzX3NldCkgcmV0dXJuOwoKCQkJCWxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCgidHlwZS5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fdHlwZV9Ub29sc19jb29wID09ICchPScgfHwgdGhpcy5fdHlwZV9Ub29sc19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl90eXBlX1Rvb2xzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX3R5cGVfVG9vbHNfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl90eXBlX1Rvb2xzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKnR5cGVfVG9vbHMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCQl0eXBlX01hcHBpbmdzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZV9Ub29sX1R5cGVzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl90eXBlX01hcHBpbmdzX3NldCkgcmV0dXJuOwoKCQkJCWxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCgidHlwZS5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fdHlwZV9NYXBwaW5nc19jb29wID09ICchPScgfHwgdGhpcy5fdHlwZV9NYXBwaW5nc19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl90eXBlX01hcHBpbmdzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX3R5cGVfTWFwcGluZ3NfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl90eXBlX01hcHBpbmdzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKnR5cGVfTWFwcGluZ3MqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCX0sICJfdG9TZWxlY3RTUUwiLCBmaWVsZHMpLnNxbDsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQlpZiAoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jb2RlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMub3JkZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZGF0ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5uYW1lfWA7CgoJCX0KCgkJaWYgKHNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpIHsKCQkJLy8gc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSIsICJ3aGVyZSAxPTAiKTsKCQl9IGVsc2UgewoJCQlzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7CgkJfQoKCQlzcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCkgOiBzcWw7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgoJCXJldHVybiBzcWw7Cgl9CgoJX3RvUGF0aHMoKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJX1RISVM6IG9iaiA9PiB7fSwKCgkJCXR5cGVfVG9vbHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlX1Rvb2xfVHlwZXMnLCB1bmRlZmluZWQpKSA9PiBvYmoudHlwZV9Ub29scyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQkJdHlwZV9NYXBwaW5nczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGVfVG9vbF9UeXBlcycsIHVuZGVmaW5lZCkpID0+IG9iai50eXBlX01hcHBpbmdzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuVG9vbF9UeXBlKSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlRvb2xfVHlwZSA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCBzcWwgPSBuZXcgc2FsZXNub3cuVG9vbF9UeXBlKCkKCgkJCQkJLnR5cGVfVG9vbHMobmV3IHNhbGVzbm93LlRvb2woKSkKCgkJCQkJLnR5cGVfTWFwcGluZ3MobmV3IHNhbGVzbm93Lk1hcHBpbmcoKSkKCgkJCQkJLl90b1NRTFRhYmxlKGRlcHRoKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIlRvb2wgVHlwZSIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQkJdHlwZV9Ub29sczogKG9iaiwgdikgPT4gewoJCQkJCW9iai50eXBlX1Rvb2xzID0gdi5tYXAoX3YgPT4gcXVlcnkudHlwZV9Ub29scygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJCXR5cGVfTWFwcGluZ3M6IChvYmosIHYpID0+IHsKCQkJCQlvYmoudHlwZV9NYXBwaW5ncyA9IHYubWFwKF92ID0+IHF1ZXJ5LnR5cGVfTWFwcGluZ3MoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXR5cGVfVG9vbHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoudHlwZV9Ub29scyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQkJdHlwZV9NYXBwaW5nczogKG9iaiwgdikgPT4gewoJCQkJCW9iai50eXBlX01hcHBpbmdzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXR5cGVfVG9vbHM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy50eXBlX1Rvb2xzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCXR5cGVfTWFwcGluZ3M6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy50eXBlX01hcHBpbmdzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ107CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJdHlwZV9Ub29sczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3R5cGVfVG9vbF9UeXBlcycsIHVuZGVmaW5lZCkgOiAidHlwZV9Ub29scyIpKSA9PiB0aGlzLnR5cGVfVG9vbHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LlRvb2woKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJCXR5cGVfTWFwcGluZ3M6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0eXBlX1Rvb2xfVHlwZXMnLCB1bmRlZmluZWQpIDogInR5cGVfTWFwcGluZ3MiKSkgPT4gdGhpcy50eXBlX01hcHBpbmdzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5NYXBwaW5nKCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddID0gdiwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCXR5cGVfVG9vbHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0eXBlX1Rvb2xfVHlwZXMnLCB1bmRlZmluZWQpIDogInR5cGVfVG9vbHMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fdHlwZV9Ub29sc19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fdHlwZV9Ub29sc19jb29wOwoJCQkJfQoJCQl9LAoKCQkJdHlwZV9NYXBwaW5nczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3R5cGVfVG9vbF9UeXBlcycsIHVuZGVmaW5lZCkgOiAidHlwZV9NYXBwaW5ncyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl90eXBlX01hcHBpbmdzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl90eXBlX01hcHBpbmdzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuX25hbWU7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IHRydWU7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlRvb2xfVHlwZS5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuVG9vbF9UeXBlKG51bGwsIHRoaXMuVG9vbCk7CgoJCQkJbGV0IGJGaW5kID0gZmFsc2U7CgkJCQlpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLklkID0gdGhpcy5JZDsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5uYW1lKHRoaXMubmFtZSgpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24pID09PSAidW5kZWZpbmVkIiB8fCBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nQkVHSU4nOidTVEFSVCd9IFRSQU5TQUNUSU9OYCk7CgkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gPSB7CgkJCQkJCQlPd25lcjogdGhpcywKCQkJCQkJCXNxbHM6IFtdLAoJCQkJCQkJc3RhcnQ6IG5ldyBEYXRlKCksCgkJCQkJCQllbmQ6IG51bGwKCQkJCQkJfTsKCQkJCQl9CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl90eXBlX1Rvb2xzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMudHlwZV9Ub29scygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAodGhpcy5fdHlwZV9NYXBwaW5nc19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLnR5cGVfTWFwcGluZ3MoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCQlpZiAoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5Pd25lciA9PSB0aGlzKSB7CgkJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYENPTU1JVCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nIFRSQU5TQUNUSU9OJzonJ31gKTsKCQkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kID0gbmV3IERhdGUoKTsKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlLl9wYXJlbnQpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBpbnNlcnQoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ub29sX1R5cGUuaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b0luc2VydFNRTCgpKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luc2VydCcsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuVG9vbF9UeXBlLnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvVXBkYXRlU1FMKCkpOwoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKCkpOwoJCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0WzBdOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ub29sX1R5cGUuZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJcmV0ID0gKGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTChmaWVsZHMsIG9ianMpKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCk7CgkJCQlyZXQgPSByZXQgPyBbSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSldIDogW107CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5tYXAociA9PiBuZXcgc2FsZXNub3cuVG9vbF9UeXBlKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuRXZlbnQgPSBjbGFzcyBFdmVudCBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFpZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKT2IyUmxJanA3SW01dlJHVjBaV04wSWpwMGNuVmxMQ0pwYm1sMExtVnVaSE1pT2pJc0ltbHVhWFF1Ykc5dmNDSTZNQzQxTENKMGIyOXNjeTV6ZEc5eVpTSTZabUZzYzJVc0ltUmxkR1ZqZEZCaGNtVnVkQzVKVUNJNklqRTVOUzR4TVRJdU1qRTJMakUzTXlJc0ltUmxkR1ZqZEZCaGNtVnVkQzVqYjJSbElqb2laVGhrWlRBMlpUTmxaR00wTkROaFpUbGtabVV4WkdVMVpXTTFNbUUwWW1ZaUxDSnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wc0lsUnZiMndpT25zaVoybDBhSFZpTG5SdmIyeHpJam9pYUhSMGNITTZMeTl5WVhjdVoybDBhSFZpZFhObGNtTnZiblJsYm5RdVkyOXRMMlpoWkdsdUwyWmhaR2x1TG1kcGRHaDFZaTVwYnk5dFlYTjBaWEl2SWl3aWMyVmpjbVYwSWpvaWIxTkxkMmRhTW5OTFJrOVVTVXBqWWtGbVZVbFJORU5xT1hGelNEUTRibXdpTENKd2JHRjVaM0p2ZFc1a0lqcDBjblZsTENKblVsQkRJanAwY25WbExDSnpkRzl5WlM1elpXNXphWFJwZG1sMGVTSTZNU3dpWTI5dGNHRnVlU0k2SW5KbGMzVnRaU0o5TENKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzSWtkcGRFaDFZaUpkYCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjbGFzc05hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NsYXNzTmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm1ldGhvZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbWV0aG9kKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicGF5bG9hZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcGF5bG9hZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNhcnJpZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NhcnJpZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJzZW5kZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3NlbmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlY2lwaWVudCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVjaXBpZW50KCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVzcG9uc2VUbyIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVzcG9uc2VUbygpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfcmVzcG9uc2VUb19FdmVudHMoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJFdmVudCIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJcmV0dXJuIHRoaXM7CgoJCWlmICh0aGlzLl9jYXJyaWVyX3NldCAmJiB0aGlzLl9jYXJyaWVyKSB0aGlzLl9jYXJyaWVyLlRvb2wgPSB0b29sOwoKCQlpZiAodGhpcy5fc2VuZGVyX3NldCAmJiB0aGlzLl9zZW5kZXIpIHRoaXMuX3NlbmRlci5Ub29sID0gdG9vbDsKCgkJaWYgKHRoaXMuX3JlY2lwaWVudF9zZXQgJiYgdGhpcy5fcmVjaXBpZW50KSB0aGlzLl9yZWNpcGllbnQuVG9vbCA9IHRvb2w7CgoJCWlmICh0aGlzLl9yZXNwb25zZVRvX3NldCAmJiB0aGlzLl9yZXNwb25zZVRvKSB0aGlzLl9yZXNwb25zZVRvLlRvb2wgPSB0b29sOwoKCQkodGhpcy5yZXNwb25zZVRvX0V2ZW50cygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjbGFzc05hbWUgKiovCgljbGFzc05hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jbGFzc05hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjbGFzc05hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NsYXNzTmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9jbGFzc05hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NsYXNzTmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jbGFzc05hbWUpOwoJCX0KCX0KCgljbGVhcl9jbGFzc05hbWUoKSB7CgkJdGhpcy5fY2xhc3NOYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fY2xhc3NOYW1lID0gbnVsbDsKCQl0aGlzLl9jbGFzc05hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNsYXNzTmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG1ldGhvZCAqKi8KCW1ldGhvZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX21ldGhvZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm1ldGhvZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbWV0aG9kICE9IHYpIHsKCQkJCXRoaXMuX21ldGhvZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbWV0aG9kID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX21ldGhvZCk7CgkJfQoJfQoKCWNsZWFyX21ldGhvZCgpIHsKCQl0aGlzLl9tZXRob2Rfc2V0ID0gbnVsbDsKCQl0aGlzLl9tZXRob2QgPSBudWxsOwoJCXRoaXMuX21ldGhvZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbWV0aG9kICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcGF5bG9hZCAqKi8KCXBheWxvYWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9wYXlsb2FkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicGF5bG9hZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcGF5bG9hZCAhPSB2KSB7CgkJCQl0aGlzLl9wYXlsb2FkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9wYXlsb2FkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9wYXlsb2FkKTsKCQl9Cgl9CgoJY2xlYXJfcGF5bG9hZCgpIHsKCQl0aGlzLl9wYXlsb2FkX3NldCA9IG51bGw7CgkJdGhpcy5fcGF5bG9hZCA9IG51bGw7CgkJdGhpcy5fcGF5bG9hZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcGF5bG9hZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNhcnJpZXIgKiovCgljYXJyaWVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY2Fycmllcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNhcnJpZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICdjNmIxNGI0ZS1lNTFkLTRkYmEtYWZiOC1hYzQ3OGY0YjRlNzYnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdOb2RlJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NhcnJpZXInLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICJjNmIxNGI0ZS1lNTFkLTRkYmEtYWZiOC1hYzQ3OGY0YjRlNzYiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiTm9kZSIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jYXJyaWVyICE9IHYpIHsKCQkJCXRoaXMuX2NhcnJpZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjYXJyaWVyJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9jYXJyaWVyID8gdGhpcy5fY2Fycmllci5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fY2Fycmllcl9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fY2FycmllciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jYXJyaWVyKTsKCQl9Cgl9CgoJY2xlYXJfY2FycmllcigpIHsKCQl0aGlzLl9jYXJyaWVyX3NldCA9IG51bGw7CgkJdGhpcy5fY2FycmllciA9IG51bGw7CgkJdGhpcy5fY2Fycmllcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY2FycmllciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHNlbmRlciAqKi8KCXNlbmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3NlbmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInNlbmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2M2YjE0YjRlLWU1MWQtNGRiYS1hZmI4LWFjNDc4ZjRiNGU3NicgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ05vZGUnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2VuZGVyJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiYzZiMTRiNGUtZTUxZC00ZGJhLWFmYjgtYWM0NzhmNGI0ZTc2IiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIk5vZGUiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fc2VuZGVyICE9IHYpIHsKCQkJCXRoaXMuX3NlbmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NlbmRlcicsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fc2VuZGVyID8gdGhpcy5fc2VuZGVyLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9zZW5kZXJfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX3NlbmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9zZW5kZXIpOwoJCX0KCX0KCgljbGVhcl9zZW5kZXIoKSB7CgkJdGhpcy5fc2VuZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fc2VuZGVyID0gbnVsbDsKCQl0aGlzLl9zZW5kZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHNlbmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlY2lwaWVudCAqKi8KCXJlY2lwaWVudCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlY2lwaWVudF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlY2lwaWVudCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2M2YjE0YjRlLWU1MWQtNGRiYS1hZmI4LWFjNDc4ZjRiNGU3NicgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ05vZGUnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAncmVjaXBpZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiYzZiMTRiNGUtZTUxZC00ZGJhLWFmYjgtYWM0NzhmNGI0ZTc2IiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIk5vZGUiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVjaXBpZW50ICE9IHYpIHsKCQkJCXRoaXMuX3JlY2lwaWVudF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3JlY2lwaWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fcmVjaXBpZW50ID8gdGhpcy5fcmVjaXBpZW50LlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9yZWNpcGllbnRfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX3JlY2lwaWVudCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZWNpcGllbnQpOwoJCX0KCX0KCgljbGVhcl9yZWNpcGllbnQoKSB7CgkJdGhpcy5fcmVjaXBpZW50X3NldCA9IG51bGw7CgkJdGhpcy5fcmVjaXBpZW50ID0gbnVsbDsKCQl0aGlzLl9yZWNpcGllbnRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlY2lwaWVudCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlc3BvbnNlVG8gKiovCglyZXNwb25zZVRvKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVzcG9uc2VUb19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlc3BvbnNlVG8iKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICczNjllNDljMS1kYzc3LTRhMTktOWE5Mi1hNzU4ZDYxM2E3NWEnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdFdmVudCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdyZXNwb25zZVRvJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiMzY5ZTQ5YzEtZGM3Ny00YTE5LTlhOTItYTc1OGQ2MTNhNzVhIiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIkV2ZW50Iik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3Jlc3BvbnNlVG8gIT0gdikgewoJCQkJdGhpcy5fcmVzcG9uc2VUb19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3Jlc3BvbnNlVG8nLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX3Jlc3BvbnNlVG8gPyB0aGlzLl9yZXNwb25zZVRvLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9yZXNwb25zZVRvX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9yZXNwb25zZVRvID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3Jlc3BvbnNlVG8pOwoJCX0KCX0KCgljbGVhcl9yZXNwb25zZVRvKCkgewoJCXRoaXMuX3Jlc3BvbnNlVG9fc2V0ID0gbnVsbDsKCQl0aGlzLl9yZXNwb25zZVRvID0gbnVsbDsKCQl0aGlzLl9yZXNwb25zZVRvX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZXNwb25zZVRvICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVzcG9uc2VUb19FdmVudHMgKiovCglyZXNwb25zZVRvX0V2ZW50cyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fcmVzcG9uc2VUb19FdmVudHM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzM2OWU0OWMxLWRjNzctNGExOS05YTkyLWE3NThkNjEzYTc1YScgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnRXZlbnQnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX3Jlc3BvbnNlVG9fc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAncmVzcG9uc2VUb19FdmVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgInJlc3BvbnNlVG8gaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkV2ZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAncmVzcG9uc2VUb19FdmVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgInJlc3BvbnNlVG8gbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJFdmVudCIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5yZXNwb25zZVRvKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzLnB1c2goLi4udik7CgkJdGhpcy5fcmVzcG9uc2VUb19FdmVudHNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9yZXNwb25zZVRvX0V2ZW50cygpIHsKCQl0aGlzLl9yZXNwb25zZVRvX0V2ZW50c19zZXQgPSBudWxsOwoJCXRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fcmVzcG9uc2VUb19FdmVudHNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZXNwb25zZVRvX0V2ZW50cyAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX2NsYXNzTmFtZV9zZXQsCgoJCQl0aGlzLl9tZXRob2Rfc2V0LAoKCQkJdGhpcy5fcGF5bG9hZF9zZXQsCgoJCQl0aGlzLl9jYXJyaWVyX3NldCwKCgkJCXRoaXMuX3NlbmRlcl9zZXQsCgoJCQl0aGlzLl9yZWNpcGllbnRfc2V0LAoKCQkJdGhpcy5fcmVzcG9uc2VUb19zZXQsCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fcmVzcG9uc2VUb19FdmVudHNfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fY2xhc3NOYW1lX3NldCA9IHRoaXMuX2NsYXNzTmFtZV9zZXQ7CgkJcmV0Ll9jbGFzc05hbWVfY29vcCA9IHRoaXMuX2NsYXNzTmFtZV9jb29wOwoJCXJldC5jbGFzc05hbWUgPSB0aGlzLmNsYXNzTmFtZSgpID8gdGhpcy5jbGFzc05hbWUoKSA6IHRoaXMuY2xhc3NOYW1lKCk7CgoJCXJldC5fbWV0aG9kX3NldCA9IHRoaXMuX21ldGhvZF9zZXQ7CgkJcmV0Ll9tZXRob2RfY29vcCA9IHRoaXMuX21ldGhvZF9jb29wOwoJCXJldC5tZXRob2QgPSB0aGlzLm1ldGhvZCgpID8gdGhpcy5tZXRob2QoKSA6IHRoaXMubWV0aG9kKCk7CgoJCXJldC5fcGF5bG9hZF9zZXQgPSB0aGlzLl9wYXlsb2FkX3NldDsKCQlyZXQuX3BheWxvYWRfY29vcCA9IHRoaXMuX3BheWxvYWRfY29vcDsKCQlyZXQucGF5bG9hZCA9IHRoaXMucGF5bG9hZCgpID8gdGhpcy5wYXlsb2FkKCkgOiB0aGlzLnBheWxvYWQoKTsKCgkJcmV0Ll9jYXJyaWVyX3NldCA9IHRoaXMuX2NhcnJpZXJfc2V0OwoJCXJldC5fY2Fycmllcl9jb29wID0gdGhpcy5fY2Fycmllcl9jb29wOwoJCXJldC5jYXJyaWVyID0gdGhpcy5jYXJyaWVyKCkgPyB0aGlzLmNhcnJpZXIoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5jYXJyaWVyKCk7CgoJCXJldC5fc2VuZGVyX3NldCA9IHRoaXMuX3NlbmRlcl9zZXQ7CgkJcmV0Ll9zZW5kZXJfY29vcCA9IHRoaXMuX3NlbmRlcl9jb29wOwoJCXJldC5zZW5kZXIgPSB0aGlzLnNlbmRlcigpID8gdGhpcy5zZW5kZXIoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5zZW5kZXIoKTsKCgkJcmV0Ll9yZWNpcGllbnRfc2V0ID0gdGhpcy5fcmVjaXBpZW50X3NldDsKCQlyZXQuX3JlY2lwaWVudF9jb29wID0gdGhpcy5fcmVjaXBpZW50X2Nvb3A7CgkJcmV0LnJlY2lwaWVudCA9IHRoaXMucmVjaXBpZW50KCkgPyB0aGlzLnJlY2lwaWVudCgpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLnJlY2lwaWVudCgpOwoKCQlyZXQuX3Jlc3BvbnNlVG9fc2V0ID0gdGhpcy5fcmVzcG9uc2VUb19zZXQ7CgkJcmV0Ll9yZXNwb25zZVRvX2Nvb3AgPSB0aGlzLl9yZXNwb25zZVRvX2Nvb3A7CgkJcmV0LnJlc3BvbnNlVG8gPSB0aGlzLnJlc3BvbnNlVG8oKSA/IHRoaXMucmVzcG9uc2VUbygpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLnJlc3BvbnNlVG8oKTsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0LnJlc3BvbnNlVG9fRXZlbnRzID0gdGhpcy5yZXNwb25zZVRvX0V2ZW50cygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkiY2xhc3NOYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NsYXNzTmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm1ldGhvZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdtZXRob2QnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJwYXlsb2FkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3BheWxvYWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjYXJyaWVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhcnJpZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJzZW5kZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc2VuZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkicmVjaXBpZW50IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlY2lwaWVudCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJInJlc3BvbnNlVG8iOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVzcG9uc2VUbycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCXJlc3BvbnNlVG9fRXZlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVzcG9uc2VUb19FdmVudHMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAiY2FycmllciIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgY2FycmllcicsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuTm9kZSgpLmNhcnJpZXJfRXZlbnRzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAic2VuZGVyIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBzZW5kZXInLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5zZW5kZXJfRXZlbnRzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAicmVjaXBpZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciByZWNpcGllbnQnLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5yZWNpcGllbnRfRXZlbnRzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAicmVzcG9uc2VUbyIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgcmVzcG9uc2VUbycsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuRXZlbnQoKS5yZXNwb25zZVRvX0V2ZW50cyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpICE9ICdFdmVudCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCXJldHVybiBuZXcgc2FsZXNub3dbZXZlbnQuY2xhc3NOYW1lKCldKCkuX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdyk7CgkJCX0KCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJCWNhc2UgImxpc3RlbiI6IHsKCgkJCQkJZGF0YS5ub2RlID0gZGF0YS5ub2RlID8gZGF0YS5ub2RlCgoJCQkJCQkuX3RvRG9jdW1lbnQoKQoKCQkJCQkJOgoJCQkJCQl1bmRlZmluZWQ7CgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCWNhc2UgInRyaWdnZXIiOiB7CgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCWNhc2UgInByb2Nlc3MiOiB7CgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9FdmVudC8ke21ldGhvZH1gLCBkYXRhLCBjb25maWcpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQl9CgkJfSBlbHNlIHsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJsaXN0ZW4iOiB7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgInRyaWdnZXIiOiB7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgInByb2Nlc3MiOiB7CgoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuRXZlbnQobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LkV2ZW50KG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5FdmVudChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocCkpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHt9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2UobWV0aG9kLCBib2R5LCBxdWVyeSwgYXV0aE9iaikgewoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgbWV0aG9kLCBxdWVyeSwgYm9keSk7CgoJCWlmICh0eXBlb2YoYm9keSkgPT09ICdzdHJpbmcnIHx8ICh0eXBlb2YoQnVmZmVyKSAhPT0gJ3VuZGVmaW5lZCcgJiYgQnVmZmVyLmlzQnVmZmVyKGJvZHkpKSkgewoJCQl0cnkgewoJCQkJYm9keSA9IEpTT04ucGFyc2UoYm9keS50b1N0cmluZygpKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJvZHkgaXMgbm90IGEgdmFsaWQgSlNPTiIsIGJvZHkpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoKCQlsZXQgX3BhcmFtcyA9IHF1ZXJ5ID8gT2JqZWN0LmFzc2lnbihxdWVyeSwgYm9keSkgOiBib2R5OwoJCWlmICh0eXBlb2YoX3BhcmFtcykgPT09ICdzdHJpbmcnKSBfcGFyYW1zID0gSlNPTi5wYXJzZShfcGFyYW1zKTsKCgkJaWYgKF9wYXJhbXMpIHsKCQkJX3BhcmFtcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcyk7CgkJfSBlbHNlIHsKCQkJX3BhcmFtcyA9IHt9OwoJCX0KCgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgX3BhcmFtcy5fX2ZsYXR0ZWQpIF9wYXJhbXMgPSBGbGF0dGVkLnBhcnNlKF9wYXJhbXMuX19mbGF0dGVkKTsKCgkJaWYgKF9wYXJhbXMuX19ub2RlKSB7CgkJCS8vIHByb2JhYmx5IHNob3VsZCBub3QgYmUgcHJvY2Vzc2VkIGhlcmUsIGJ1dCByYXRoZXIgY29uc3VtZWQgYXMgcGFydCBvZiB0aGUgZXhlY3V0ZSgpIGxvZ2ljLCBwdXNoaW5nIF9fbm9kZSB0byB0aGUgbGlzdCBvZiBteSBub2RlcyB0byBkZWxlZ2F0ZSB0byE/CgkJCWxldCB0biA9IG5ldyBzYWxlc25vdy5Ob2RlKCkuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fbm9kZSkuX2RlUmVmZXJlbmNlKCk7CgkJCWRlbGV0ZSBfcGFyYW1zLl9fbm9kZTsKCQkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5FdmVudCgpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOwoJCX0KCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAibGlzdGVuIjogewoKCQkJCV9wYXJhbXMubm9kZSA9IG5ldyBzYWxlc25vdy5Ob2RlKCkuX2Zyb21Eb2N1bWVudChfcGFyYW1zLm5vZGUpLl9kZVJlZmVyZW5jZSgpOwoKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMubm9kZSk7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgInRyaWdnZXIiOiB7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgInByb2Nlc3MiOiB7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYEV2ZW50Ll9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgRXZlbnQuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuRXZlbnQuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuRXZlbnQuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIkV2ZW50Iik7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCWlmICh0aGlzLl9jYXJyaWVyX3NldCAmJiB0aGlzLmNhcnJpZXIoKSkgdGhpcy5jYXJyaWVyKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX3NlbmRlcl9zZXQgJiYgdGhpcy5zZW5kZXIoKSkgdGhpcy5zZW5kZXIoKS5fX3N5bmNfb24oZCk7CgoJCQlpZiAodGhpcy5fcmVjaXBpZW50X3NldCAmJiB0aGlzLnJlY2lwaWVudCgpKSB0aGlzLnJlY2lwaWVudCgpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl9yZXNwb25zZVRvX3NldCAmJiB0aGlzLnJlc3BvbnNlVG8oKSkgdGhpcy5yZXNwb25zZVRvKCkuX19zeW5jX29uKGQpOwoKCQkJLy8gdGhpcy5yZXNwb25zZVRvX0V2ZW50cygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93LkV2ZW50KHRoaXMuSWQpCgoJCQkuY2xhc3NOYW1lKHRoaXMuY2xhc3NOYW1lKCksIHRoaXMuX2NsYXNzTmFtZV9jb29wKQoKCQkJLm1ldGhvZCh0aGlzLm1ldGhvZCgpLCB0aGlzLl9tZXRob2RfY29vcCkKCgkJCS5wYXlsb2FkKHRoaXMucGF5bG9hZCgpLCB0aGlzLl9wYXlsb2FkX2Nvb3ApCgoJCQkuY2Fycmllcih0aGlzLmNhcnJpZXIoKSwgdGhpcy5fY2Fycmllcl9jb29wKQoKCQkJLnNlbmRlcih0aGlzLnNlbmRlcigpLCB0aGlzLl9zZW5kZXJfY29vcCkKCgkJCS5yZWNpcGllbnQodGhpcy5yZWNpcGllbnQoKSwgdGhpcy5fcmVjaXBpZW50X2Nvb3ApCgoJCQkucmVzcG9uc2VUbyh0aGlzLnJlc3BvbnNlVG8oKSwgdGhpcy5fcmVzcG9uc2VUb19jb29wKQoKCQkJLmFjdGl2ZSh0aGlzLmFjdGl2ZSgpLCB0aGlzLl9hY3RpdmVfY29vcCkKCgkJCS5lbmFibGVkKHRoaXMuZW5hYmxlZCgpLCB0aGlzLl9lbmFibGVkX2Nvb3ApCgoJCQkuY29kZSh0aGlzLmNvZGUoKSwgdGhpcy5fY29kZV9jb29wKQoKCQkJLm9yZGVyKHRoaXMub3JkZXIoKSwgdGhpcy5fb3JkZXJfY29vcCkKCgkJCS5kYXRlKHRoaXMuZGF0ZSgpLCB0aGlzLl9kYXRlX2Nvb3ApCgoJCQkubmFtZSh0aGlzLm5hbWUoKSwgdGhpcy5fbmFtZV9jb29wKQoKCQkJLnJlbWFyayh0aGlzLnJlbWFyaygpLCB0aGlzLl9yZW1hcmtfY29vcCkKCgkJCS5yZXNwb25zZVRvX0V2ZW50cyh0aGlzLnJlc3BvbnNlVG9fRXZlbnRzKCksIHRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQlvYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ0V2ZW50JzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiRXZlbnQiOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlRaWEoyYVdObFRtOTNJam9pWlcxZlpYWmxiblFpZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQkJCXJldHVybiB2YWx1ZTsKCQkJCX0pOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgkJCQlyZXQgPSByZXQudG9Mb3dlckNhc2UoKTsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucyA9IHt9KSB7CgkJdHJ5IHsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sID8gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IG9wdGlvbnMudG9vbCB8fCB0ID09IG9wdGlvbnMudG9vbCkgOiB0aGlzLlRvb2w7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCB8fCB7fTsKCgkJCWxldCBuSUQgPSBzYWxlc25vdy5fbm9kZSA/IHNhbGVzbm93Ll9ub2RlLmNvZGUoKSA6ICJkZWZhdWx0IjsKCgkJCWxldCByZXQgPSBudWxsVmFsdWU7CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldCA9IG51bGw7CgoJCQkvLyB0b29sX0NvbmZpZ3M6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gZG9uZQoJCQlsZXQgdGNvbmYgPSAob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgYy5ub2RlICYmIGMubm9kZS5jb2RlID09IG5JRCkuY29uY2F0KChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiAhYy5ub2RlKSk7CgkJCWlmICh0Y29uZi5sZW5ndGgpIHsKCQkJCXJldCA9IHRjb25mWzBdLnZhbHVlOwoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChqZXgpIHt9CgkJCX0KCgkJCS8vIG1vZGVsIENvbmZpZzogQ29uZmlnIGlzIGNsYXNzIGxldmVsLCBub2RlIG5vdCBwb3NzaWJsZSAtIHBlbmRpbmcKCQkJbGV0IG1jb25mID0gdGhpcy5Db25maWcgPyB0aGlzLkNvbmZpZ1tuXSA6IHVuZGVmaW5lZDsKCQkJaWYgKHR5cGVvZihtY29uZikgIT09ICJ1bmRlZmluZWQiKSByZXQgPSBtY29uZjsKCgkJCS8vIGNvbW1hbmQgbGluZTogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgZ2xvYmFsLm1pbmltaXN0KSB7CgkJCQlyZXQgPSBnbG9iYWwubWluaW1pc3QocHJvY2Vzcy5hcmd2LnNsaWNlKDIpKVtuXSB8fCByZXQ7CgkJCX0KCgkJCS8vIHJlcXVlc3Q6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlyZXQgPSB0aGlzLiRfUkVRVUVTVChuKSB8fCByZXQ7CgoJCQlpZiAob3B0aW9ucy5uZXdWYWx1ZSkgewoJCQkJbGV0IHRjID0gdGNvbmYubGVuZ3RoID8gdGNvbmZbMF0gOiB7fTsKCQkJCXRjLm5vZGUgPSB7CgkJCQkJY29kZTogb3B0aW9ucy5ub2RlLmNvZGUoKQoJCQkJfTsKCQkJCXRjLnZhbHVlID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJCXRjLm5hbWUgPSBuOwoJCQkJaWYgKCF0Y29uZi5sZW5ndGgpIHsKCQkJCQlvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLnB1c2godGMpOwoJCQkJfQoJCQkJcmV0ID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJfQoKCQkJLy8gY29uZmlnIHJlcGxhY2VtZW50CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3N0cmluZycpKHJldC5tYXRjaChuZXcgUmVnRXhwKGB7eyhbXn1dKyl9fWAsICJnIikpIHx8IFtdKS5mb3JFYWNoKG0gPT4gcmV0ID0gcmV0LnJlcGxhY2UobSwgdGhpcy5fX2NvbmZpZyhtLnJlcGxhY2UoJ3t7JywgJycpLnJlcGxhY2UoJ319JywgJycpLCBudWxsLCBvcHRpb25zKSkpOwoKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2NvbmZpZycsICdFbnRpdHlPYmplY3QnLCAxLCBuLCBudWxsVmFsdWUsIG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MsIGV4KTsKCQl9Cgl9CgoJLyoqCgkgKiBTdW1tYXJ5LiBsaXN0ZW4uCgkgKgoJICogRGVzY3JpcHRpb24uIC4KCSAqCgkgKiBAc2luY2UgICAgICB4LngueAoJICogQGRlcHJlY2F0ZWQgeC54LnggVXNlIG5ld19mdW5jdGlvbl9uYW1lKCkgaW5zdGVhZC4KCSAqIEBhY2Nlc3MgICAgIHB1YmxpYwoJICoKCSAqIEBjbGFzcwoJICogQGF1Z21lbnRzIHBhcmVudAoJICogQG1peGVzICAgIG1peGluCgkgKgoJICogQGFsaWFzICAgIHJlYWxOYW1lCgkgKiBAbWVtYmVyb2YgbmFtZXNwYWNlCgkgKgoJICogQHNlZSAgRnVuY3Rpb24vY2xhc3MgcmVsaWVkIG9uCgkgKiBAbGluayBVUkwKCSAqIEBnbG9iYWwKCSAqCgkgKiBAZmlyZXMgICBldmVudE5hbWUKCSAqIEBmaXJlcyAgIGNsYXNzTmFtZSNldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGV2ZW50OmV2ZW50TmFtZQoJICogQGxpc3RlbnMgY2xhc3NOYW1lfmV2ZW50OmV2ZW50TmFtZQoJICogQHBhcmFtIHt0eXBlfSAgIHZhciAgICAgICAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcl0gICAgICAgICBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyPWRlZmF1bHRdIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlIHdpdGggZGVmYXVsdCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3RWYXIgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIG9iamVjdFZhci5rZXkgRGVzY3JpcHRpb24gb2YgYSBrZXkgaW4gdGhlIG9iamVjdFZhciBwYXJhbWV0ZXIuCgkgKgoJICogQHlpZWxkIHt0eXBlfSBZaWVsZGVkIHZhbHVlIGRlc2NyaXB0aW9uLgoJICoKCSAqIEByZXR1cm4ge3R5cGV9IFJldHVybiB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqLwoJYXN5bmMgbGlzdGVuKG5vZGUpIHsKCgkJbGV0IGFuc3dlciA9IG51bGw7CgoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImxpc3RlbiIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJsaXN0ZW4iLCBfbm9kZSwgbm9kZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAibGlzdGVuIiwgbm9kZSkgPT4gewoKCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkV2ZW50Lmxpc3RlbicpOwoKCQkJdmFyIGVycm9ycyA9IHsKCgkJCQkibm9kZSI6ICgobm9kZSkgPT4gewoKCQkJCQlsZXQgYW5zd2VyID0KCgkJCQkJCSghbm9kZSAmJiBmYWxzZSkgfHwgKG5vZGUgJiYgKG5vZGUuY29uc3RydWN0b3IubmFtZSAhPSAnTm9kZScgfHwgbm9kZS5FbnRpdHlDbGFzcy5OYW1lICE9ICdOb2RlJykpCgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnbGlzdGVuJywgJ0VudGl0eU9iamVjdCcsIDAsICJhbnN3ZXIiLCAibm9kZSIsIGFuc3dlcik7CgkJCQkJcmV0dXJuIGFuc3dlcjsKCQkJCX0pKG5vZGUpID8gKCdub2RlIGlzIG5vdCBvZiB0eXBlIE5vZGUnIHx8ICdWYWxpZGF0aW9uIEVycm9yJykgOiAnJywKCgkJCQkiMDEiOiAoKG5vZGUpID0+IHsKCgkJCQkJbGV0IGFuc3dlciA9CgoJCQkJCQl0eXBlb2Yobm9kZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZihvU2NvcGUuX25vZGUpID09PSAndW5kZWZpbmVkJwoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ2xpc3RlbicsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgIjAxIiwgYW5zd2VyKTsKCQkJCQlyZXR1cm4gYW5zd2VyOwoJCQkJfSkobm9kZSkgPyAoJ29TY29wZS5fbm9kZSBub3QgZGVmaW5lZCcgfHwgJ1ZhbGlkYXRpb24gRXJyb3InKSA6ICcnLAoKCQkJCSItMDIiOiAoKG5vZGUpID0+IHsKCgkJCQkJbGV0IGFuc3dlciA9CgoJCQkJCQl0eXBlb2Yob1Njb3BlLl9fYnJva2VyKSAhPT0gJ3VuZGVmaW5lZCcKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdsaXN0ZW4nLCAnRW50aXR5T2JqZWN0JywgMCwgImFuc3dlciIsICItMDIiLCBhbnN3ZXIpOwoJCQkJCXJldHVybiBhbnN3ZXI7CgkJCQl9KShub2RlKSA/ICgnb1Njb3BlLl9fYnJva2VyIGFscmVhZHkgZGVmaW5lZCcgfHwgJ1ZhbGlkYXRpb24gRXJyb3InKSA6ICcnLAoKCQkJfTsKCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiAhZXJyb3JzW2tdKS5mb3JFYWNoKGsgPT4gZGVsZXRlIGVycm9yc1trXSk7CgkJCWlmIChPYmplY3Qua2V5cyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJy0nKSkuZm9yRWFjaChrID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdsaXN0ZW4nLCAnRW50aXR5T2JqZWN0JywgMCwgewoJCQkJCQlba106IGVycm9yc1trXQoJCQkJCX0pOwoJCQkJCWRlbGV0ZSBlcnJvcnNba107CgkJCQl9KTsKCQkJCWlmIChPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIHsKCQkJCQkJX19leGNlcHRpb246IGVycm9ycywKCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlub2RlID0gbm9kZSB8fCBvU2NvcGUuX25vZGU7CgoJCQlpZiAodHlwZW9mKG1xdHQpICE9PSAndW5kZWZpbmVkJyAmJiBub2RlLl9fY29uZmlnKCdtcXR0LnNlcnZlcicpKSB7CgkJCQlsb2coYEVzdGFibGlzaGluZyBjb25uZWN0aW9uIHdpdGggTVFUVCBzZXJ2ZXIgQCR7bm9kZS5jb2RlKCl9ICR7bm9kZS5fX2NvbmZpZygnbXF0dC5zZXJ2ZXInKX06JHtub2RlLl9fY29uZmlnKCdtcXR0LnBvcnQnKXx8ODA4MH1gKTsKCQkJCW9TY29wZS5fX2Jyb2tlciA9IG1xdHQuY29ubmVjdChgd3M6Ly8ke25vZGUuX19jb25maWcoJ21xdHQuc2VydmVyJyl9OiR7bm9kZS5fX2NvbmZpZygnbXF0dC5wb3J0Jyl8fDgwODB9L21xdHRgLCB7CgkJCQkJLy8gQ2xlYW4gc2Vzc2lvbgoJCQkJCWNsZWFuOiB0eXBlb2Yobm9kZS5fX2NvbmZpZygnbXF0dC5jbGVhbicpKSAhPT0gJ3VuZGVmaW5lZCcgPyBub2RlLl9fY29uZmlnKCdtcXR0LmNsZWFuJykgOiB0cnVlLAoJCQkJCWNvbm5lY3RUaW1lb3V0OiBub2RlLl9fY29uZmlnKCdtcXR0LmNvbm5lY3RUaW1lb3V0JykgfHwgNDAwMCwKCQkJCQkvLyBBdXRoZW50aWNhdGlvbgoJCQkJCWNsaWVudElkOiBub2RlLl9fY29uZmlnKCdtcXR0LmNsaWVudElkJykgfHwgbm9kZS5jb2RlKCksCgkJCQkJLy9yZWNvbm5lY3RQZXJpb2Q6IG5vZGUuX19jb25maWcoJ21xdHQudXNlcm5hbWUnKSwKCQkJCQl1c2VybmFtZTogbm9kZS5fX2NvbmZpZygnbXF0dC51c2VybmFtZScpLAoJCQkJCXBhc3N3b3JkOiBub2RlLl9fY29uZmlnKCdtcXR0LnBhc3N3b3JkJyksCgkJCQl9KTsKCQkJCW9TY29wZS5fX2Jyb2tlci5vbignY29ubmVjdCcsICgpID0+IG9TY29wZS5fX2Jyb2tlci5zdWJzY3JpYmUodGhpcy5TY29wZSkpOwoJCQkJb1Njb3BlLl9fYnJva2VyLnN0cmVhbS5vbignZXJyb3InLCBlciA9PiBvU2NvcGUuX19icm9rZXIuZW5kKCkpOwoJCQkJb1Njb3BlLl9fYnJva2VyLm9uKCdtZXNzYWdlJywgKHRvcGljLCBtZXNzYWdlKSA9PiB7CgkJCQkJbGV0IG1zZyA9IEpTT04ucGFyc2UobWVzc2FnZS50b1N0cmluZygpKTsKCQkJCQkvL2xvZygiTVFUVCBNZXNzYWdlIiwgbXNnKTsKCQkJCQluZXcgb1Njb3BlLkV2ZW50KCkuX2Zyb21Eb2N1bWVudChtc2cpLl9kZVJlZmVyZW5jZSgpLnByb2Nlc3MoKTsKCQkJCX0pOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihnbG9iYWwpID09PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YoaW8pICE9PSAidW5kZWZpbmVkIiAmJiBub2RlLnBhcmVudCgpLmFkZHJlc3MoKSkgewoJCQkJbG9nKGBFc3RhYmxpc2hpbmcgU29ja2V0LklPIHdpdGggbmV3IFBhcmVudCAke25vZGUuX3BhcmVudC5fYWRkcmVzc306JHtub2RlLl9wYXJlbnQuX3BvcnR8fDMwMDB9YCk7CgkJCQlvU2NvcGUuX19icm9rZXIgPSBpbyhgJHtub2RlLl9wYXJlbnQuX2FkZHJlc3N9OiR7bm9kZS5fcGFyZW50Ll9wb3J0fHwzMDAwfWAsIHsKCQkJCQl0cmFuc3BvcnRzOiBbJ3dlYnNvY2tldCddLAoJCQkJCXJlY29ubmVjdGlvbjogZmFsc2UsCgkJCQkJcXVlcnk6IGBfbm9kZT0ke25vZGUuX2NvZGV9Jl9kYXRlPSR7c3Iuc2VydmVyRGF0ZSgpLnRvVVRDU3RyaW5nKCl9YAoJCQkJfSk7CgkJCQlvU2NvcGUuX19icm9rZXIub24odGhpcy5uYW1lKCksIGUgPT4gbmV3IG9TY29wZS5FdmVudCgpLl9mcm9tRG9jdW1lbnQoZSkuX2RlUmVmZXJlbmNlKCkucHJvY2VzcygpKTsKCQkJCW9TY29wZS5fX2Jyb2tlci5vbigiZGlzY29ubmVjdCIsIHJlYXNvbiA9PiB7CgkJCQkJbG9nKCJEaXNjb25uZWN0ZWQgd2l0aCByZWFzb246ICIgKyByZWFzb24pOwoJCQkJfSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mKGdsb2JhbCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZihzb2NrZXRpbykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQlvU2NvcGUuX19icm9rZXIgPSBuZXcgc29ja2V0aW8uU2VydmVyKGdsb2JhbC5leFNlcnZlcik7CgoJCQkJb1Njb3BlLmV2ZW50RW1pdHRlciA9IG5ldyBldmVudHMuRXZlbnRFbWl0dGVyKCk7CgoJCQkJbG9nKCJTdGFydGluZyBTb2NrZXRJTyBzZXJ2ZXIiKTsKCQkJCW9TY29wZS5fX2Jyb2tlci5vbignY29ubmVjdGlvbicsIHNvY2tldCA9PiB7CgkJCQkJbGV0IHBhcmFtID0gc29ja2V0LmhhbmRzaGFrZS5xdWVyeTsKCQkJCQlpZiAoIXBhcmFtLl9ub2RlIHx8ICFwYXJhbS5fZGF0ZSkgcmV0dXJuOwoKCQkJCQlvU2NvcGUuX19zb2NrZXRzID0gb1Njb3BlLl9fc29ja2V0cyB8fCB7fTsKCQkJCQlvU2NvcGUuX19zb2NrZXRzW3NvY2tldC5oYW5kc2hha2UucXVlcnkuX25vZGVdID0gc29ja2V0OwoJCQkJCU9iamVjdC5rZXlzKG9TY29wZS5fX3NvY2tldHMpLmZvckVhY2gobiA9PiB7CgkJCQkJCWlmICghb1Njb3BlLl9fc29ja2V0c1tuXS5jb25uZWN0ZWQpIGRlbGV0ZSBvU2NvcGUuX19zb2NrZXRzW25dOwoJCQkJCX0pOwoJCQkJCWxvZygnU29ja2V0cyBjb25uZWN0ZWQgWycgKyBPYmplY3Qua2V5cyhvU2NvcGUuX19zb2NrZXRzKS5sZW5ndGggKyAnXSwgTGFzdGVzdDogJyArIHNvY2tldC5oYW5kc2hha2UucXVlcnkuX25vZGUgKyAnKCcgKyBzb2NrZXQuaWQgKyAnKScpOwoJCQkJCW9TY29wZS5fX3NvY2tldHNbc29ja2V0LmhhbmRzaGFrZS5xdWVyeS5fbm9kZV0ub24odGhpcy5uYW1lKCksIGUgPT4gbmV3IG9TY29wZS5FdmVudCgpLl9mcm9tRG9jdW1lbnQoZSkuX2RlUmVmZXJlbmNlKCkucHJvY2VzcygpKTsKCQkJCX0sIHsKCQkJCQljb3JzOiB7CgkJCQkJCW9yaWdpbjogIioiLAoJCQkJCQltZXRob2RzOiBbIkdFVCIsICJQT1NUIl0sCgkJCQkJfQoJCQkJfSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG5hdmlnYXRvci5zZXJ2aWNlV29ya2VyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCWxvZygiV29ya2VyIEV2ZW50IFByb2Nlc3NpbmciKTsKCQkJCW9TY29wZS5fX2Jyb2tlciA9IG5hdmlnYXRvci5zZXJ2aWNlV29ya2VyLmNvbnRyb2xsZXI7CgkJCQlhZGRFdmVudExpc3RlbmVyKHRoaXMubmFtZSgpLCBlID0+IG5ldyBvU2NvcGUuRXZlbnQoKS5fZnJvbURvY3VtZW50KGUpLl9kZVJlZmVyZW5jZSgpLnByb2Nlc3MoKSk7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfSBlbHNlIGlmICh0eXBlb2YoQnJvYWRjYXN0Q2hhbm5lbCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQlsb2coIlN0YXJ0aW5nIEJyb2FkY2FzdENoYW5uZWwiKTsKCQkJCW9TY29wZS5fX2Jyb2tlciA9IG5ldyBCcm9hZGNhc3RDaGFubmVsKHRoaXMuU2NvcGUpOwoJCQkJb1Njb3BlLl9fYnJva2VyLm9ubWVzc2FnZSA9IGUgPT4gbmV3IG9TY29wZS5FdmVudCgpLl9mcm9tRG9jdW1lbnQoZS5kYXRhKS5fZGVSZWZlcmVuY2UoKS5wcm9jZXNzKCk7CgkJCX0gZWxzZSB7CgkJCQlsb2coIk5vIEV2ZW50IEJyaWRnZSBhdmFpbGFibGUiLCB0aGlzLlRvb2wubmFtZSk7CgkJCX0KCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXSwKCQkJbm9kZTogbm9kZQoJCX0pOwoKCQkvLyB0YWtlIG91dCB0aGUgaW52YWxpZCBub2RlIHJlc3VsdHMKCQlyZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByICYmIHIucmV0KTsKCgkJLy8gaGFzIGFueSBub2RlIGdlbmVyYXRlZCBhIHZhbGlkYXRpb24gZXhjZXB0aW9uPwoJCWxldCBfX2V4ID0gcmVzdWx0cy5maW5kKHIgPT4gci5yZXQuX19leGNlcHRpb24pOwoJCWlmIChfX2V4KSByZXR1cm4gX19leC5yZXQ7CgoJCXJldHVybiByZXN1bHRzLmxlbmd0aCA/IHJlc3VsdHNbMF0ucmV0IDogbnVsbDsKCgl9CgoJLyoqCgkgKiBTdW1tYXJ5LiB0cmlnZ2VyLgoJICoKCSAqIERlc2NyaXB0aW9uLiAuCgkgKgoJICogQHNpbmNlICAgICAgeC54LngKCSAqIEBkZXByZWNhdGVkIHgueC54IFVzZSBuZXdfZnVuY3Rpb25fbmFtZSgpIGluc3RlYWQuCgkgKiBAYWNjZXNzICAgICBwdWJsaWMKCSAqCgkgKiBAY2xhc3MKCSAqIEBhdWdtZW50cyBwYXJlbnQKCSAqIEBtaXhlcyAgICBtaXhpbgoJICoKCSAqIEBhbGlhcyAgICByZWFsTmFtZQoJICogQG1lbWJlcm9mIG5hbWVzcGFjZQoJICoKCSAqIEBzZWUgIEZ1bmN0aW9uL2NsYXNzIHJlbGllZCBvbgoJICogQGxpbmsgVVJMCgkgKiBAZ2xvYmFsCgkgKgoJICogQGZpcmVzICAgZXZlbnROYW1lCgkgKiBAZmlyZXMgICBjbGFzc05hbWUjZXZlbnROYW1lCgkgKiBAbGlzdGVucyBldmVudDpldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGNsYXNzTmFtZX5ldmVudDpldmVudE5hbWUKCSAqIEBwYXJhbSB7dHlwZX0gICB2YXIgICAgICAgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXJdICAgICAgICAgRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUuCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcj1kZWZhdWx0XSBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZSB3aXRoIGRlZmF1bHQgdmFyaWFibGUuCgkgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0VmFyICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBvYmplY3RWYXIua2V5IERlc2NyaXB0aW9uIG9mIGEga2V5IGluIHRoZSBvYmplY3RWYXIgcGFyYW1ldGVyLgoJICoKCSAqIEB5aWVsZCB7dHlwZX0gWWllbGRlZCB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqCgkgKiBAcmV0dXJuIHt0eXBlfSBSZXR1cm4gdmFsdWUgZGVzY3JpcHRpb24uCgkgKi8KCWFzeW5jIHRyaWdnZXIoKSB7CgoJCWxldCBhbnN3ZXIgPSBudWxsOwoKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ0cmlnZ2VyIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInRyaWdnZXIiLCBfbm9kZSwgKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ0cmlnZ2VyIiwgKSA9PiB7CgoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuRXZlbnQudHJpZ2dlcicpOwoKCQkJdmFyIGVycm9ycyA9IHsKCgkJCQkiMDEiOiAoKCkgPT4gewoKCQkJCQlsZXQgYW5zd2VyID0KCgkJCQkJCSF0aGlzLl9zZW5kZXJfc2V0IHx8ICF0aGlzLnNlbmRlcigpCgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAndHJpZ2dlcicsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgIjAxIiwgYW5zd2VyKTsKCQkJCQlyZXR1cm4gYW5zd2VyOwoJCQkJfSkoKSA/ICgnTm8gU2VuZGVyJyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQkJIjAyIjogKCgpID0+IHsKCgkJCQkJbGV0IGFuc3dlciA9CgoJCQkJCQkhdGhpcy5fcmVjaXBpZW50X3NldCB8fCAhdGhpcy5yZWNpcGllbnQoKQoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ3RyaWdnZXInLCAnRW50aXR5T2JqZWN0JywgMCwgImFuc3dlciIsICIwMiIsIGFuc3dlcik7CgkJCQkJcmV0dXJuIGFuc3dlcjsKCQkJCX0pKCkgPyAoJ05vIHByb2Nlc3Npbmcgb2YgRXZlbnRzIHdpdGhvdXQgcmVjaXBpZW50JyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3RyaWdnZXInLCAnRW50aXR5T2JqZWN0JywgMCwgewoJCQkJCQlba106IGVycm9yc1trXQoJCQkJCX0pOwoJCQkJCWRlbGV0ZSBlcnJvcnNba107CgkJCQl9KTsKCQkJCWlmIChPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIHsKCQkJCQkJX19leGNlcHRpb246IGVycm9ycywKCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlsZXQgcGF5bG9hZCA9IG51bGw7CgoJCQlsZXQgZG9jID0gdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlpZiAodHlwZW9mKGdsb2JhbCkgIT09ICJ1bmRlZmluZWQiICYmIG9TY29wZS5fX3NvY2tldHMpIHsKCQkJCWlmIChvU2NvcGUuX19zb2NrZXRzW3RoaXMucmVjaXBpZW50KCkuY29kZSgpXSkgewoJCQkJCW9TY29wZS5fX3NvY2tldHNbdGhpcy5yZWNpcGllbnQoKS5jb2RlKCldLmVtaXQodGhpcy5uYW1lKCksIGRvYyk7CgkJCQl9IGVsc2UgewoJCQkJCXdhcm4oIlVua25vd24gbm9kZSBpbiBzb2NrZXRzIGxpc3QgIiArIHRoaXMucmVjaXBpZW50KCkuX2NvZGUpOwoJCQkJfQoJCQl9IGVsc2UgaWYgKG9TY29wZS5fX2Jyb2tlcikgewoJCQkJLy9sb2coSlNPTi5zdHJpbmdpZnkoZG9jLCBudWxsLCA0KSkKCQkJCWlmIChvU2NvcGUuX19icm9rZXIuZW1pdCkgb1Njb3BlLl9fYnJva2VyLmVtaXQodGhpcy5uYW1lKCksIGRvYyk7CgkJCQlpZiAob1Njb3BlLl9fYnJva2VyLnBvc3RNZXNzYWdlKSBvU2NvcGUuX19icm9rZXIucG9zdE1lc3NhZ2UoSlNPTi5zdHJpbmdpZnkoZG9jKSk7CgkJCQlpZiAob1Njb3BlLl9fYnJva2VyLnB1Ymxpc2gpIG9TY29wZS5fX2Jyb2tlci5wdWJsaXNoKHRoaXMuU2NvcGUsIEpTT04uc3RyaW5naWZ5KGRvYyksIHsKCQkJCQlxb3M6IDAsCgkJCQkJcmV0YWluOiBmYWxzZQoJCQkJfSwgZXJyID0+IGVyciA/IGVycm9yKGVycikgOiBudWxsKTsKCQkJfSBlbHNlIHsKCQkJCWF3YWl0IHRoaXMuY2FycmllcihvU2NvcGUuX25vZGUpLnN0b3JlKCk7CgkJCQlsb2coIkNhbm5vdCB0cmlnZ2VyIGRpcmVjdGx5LCBpbnNlcnRlZCB0byBUb29sOiAiICsgdGhpcy5Ub29sLnR5cGUubmFtZSArICIvIiArIHRoaXMuY29kZSgpKTsKCgkJCQkvLyB3YWl0IHVudGlsIHRoZSBldmVudCBpcyBwcm9jZXNzZWQgd2l0aCBhbm90aGVyIGV2ZW50CgkJCQlpZiAoIXRoaXMucmVzcG9uc2VUbygpKSBhd2FpdCB0aGlzLnNldEludGVydmFsKGFzeW5jICggLypyZXNwb25zZSBwb2xsaW5nKi8gKSA9PiB7CgkJCQkJaWYgKCFvU2NvcGUuX25vZGUpIHJldHVybjsKCgkJCQkJbG9nKCJQb2xsaW5nICIgKyB0aGlzLlRvb2wudHlwZS5uYW1lICsgIiBmb3IgcmVzcG9uc2UgZXZlbnQgdG8gIiArIHRoaXMuY29kZSgpKTsKCQkJCQl0cnkgewoJCQkJCQlwYXlsb2FkID0gKGF3YWl0IG5ldyBvU2NvcGUuRXZlbnQoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5yZXNwb25zZVRvKHRoaXMpCgkJCQkJCQkvKi5zZW5kZXIob1Njb3BlLl9ub2RlLCAnIT0nKS5yZWNpcGllbnQob1Njb3BlLl9ub2RlKSovCgkJCQkJCQkuZmluZCgpKS5wYXlsb2FkKCk7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJLy8gd2FybihleCk7CgkJCQkJCXJldHVybiB0cnVlOyAvLyBrZWVwIGxvb3BpbmcKCQkJCQl9CgkJCQl9LCAwLjMpOwoJCQl9CgoJCQlpZiAodGhpcy5yZXNwb25zZVRvKCkpIHsKCQkJCWxvZygicmVzcG9uc2VUbyBpcyBzZXQgZm9yICIgKyB0aGlzLmNvZGUoKSArICI6ICIgKyB0aGlzLnJlc3BvbnNlVG8oKS5jb2RlKCkgKyAiLCByZXR1cm5pbmciKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKCFwYXlsb2FkKSBwYXlsb2FkID0gYXdhaXQgbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4gewoJCQkJaWYgKCFvU2NvcGUuX25vZGUpIHJlc29sdmUobnVsbCk7CgkJCQlsb2coIldhaXRpbmcgZm9yIHByb2Nlc3Npbmcgb2YgIiArIHRoaXMuY29kZSgpKTsKCgkJCQlsZXQgYk9uY2UgPSB0aGlzLnJlY2lwaWVudCgpLl9jb2RlX3NldCA/IHRydWUgOiBmYWxzZTsKCQkJCWlmICghYk9uY2UpIHsKCQkJCQl0aGlzLmFyUmVzcG9uc2VzID0gdGhpcy5hclJlc3BvbnNlcyB8fCBbXTsKCQkJCQl0aGlzLl93YWl0KDMwMDApLnRoZW4oKCkgPT4gewoJCQkJCQlsb2coIlRpbWVvdXQgLSBjYW5ub3Qgd2FpdCBubyBtb3JlIG9uICIgKyB0aGlzLmNvZGUoKSk7CgkJCQkJCXJlc29sdmUodGhpcy5hclJlc3BvbnNlcyk7CgkJCQkJfSk7CgkJCQl9CgoJCQkJbGV0IGhhbmRsZXIgPSAoZXYsIHJlc29sdmUsIHJlamVjdCkgPT4gewoJCQkJCWxvZygiR290IHJlc3BvbnNlIGZyb20gcHJvY2VzcygiICsgdGhpcy5jb2RlKCkgKyAiKSIsIGV2LnBheWxvYWQpOwoJCQkJCWlmICh0aGlzLnJlY2lwaWVudCgpLl9jb2RlX3NldCAvKmJPbmNlKi8gfHwgIW9TY29wZS5fbm9kZSkgcmV0dXJuIHJlc29sdmUoZXYucGF5bG9hZCk7CgoJCQkJCXRoaXMuYXJSZXNwb25zZXMucHVzaChuZXcgb1Njb3BlLkV2ZW50KCkuX2Zyb21Eb2N1bWVudChldikpOwoJCQkJfTsKCgkJCQlpZiAodHlwZW9mKG9TY29wZS5ldmVudEVtaXR0ZXIpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCW9TY29wZS5ldmVudEVtaXR0ZXJbIm9uIiArIChiT25jZSA/ICJjZSIgOiAiIildKHRoaXMubmFtZSgpICsgIi4iICsgdGhpcy5jb2RlKCksIGUgPT4gaGFuZGxlcihlLCByZXNvbHZlLCByZWplY3QpKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKGFkZEV2ZW50TGlzdGVuZXIpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCWFkZEV2ZW50TGlzdGVuZXIodGhpcy5uYW1lKCkgKyAiLiIgKyB0aGlzLmNvZGUoKSwgZSA9PiBoYW5kbGVyKGUuZGV0YWlsLCByZXNvbHZlLCByZWplY3QpLCB7CgkJCQkJCW9uY2U6IGJPbmNlCgkJCQkJfSk7CgkJCQl9CgkJCX0pOwoKCQkJcmV0dXJuIHBheWxvYWQ7CgoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10sCgkJfSk7CgoJCS8vIHRha2Ugb3V0IHRoZSBpbnZhbGlkIG5vZGUgcmVzdWx0cwoJCXJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIgJiYgci5yZXQpOwoKCQkvLyBoYXMgYW55IG5vZGUgZ2VuZXJhdGVkIGEgdmFsaWRhdGlvbiBleGNlcHRpb24/CgkJbGV0IF9fZXggPSByZXN1bHRzLmZpbmQociA9PiByLnJldC5fX2V4Y2VwdGlvbik7CgkJaWYgKF9fZXgpIHJldHVybiBfX2V4LnJldDsKCgkJcmV0dXJuIHJlc3VsdHMubGVuZ3RoID8gcmVzdWx0c1swXS5yZXQgOiBudWxsOwoKCX0KCgkvKioKCSAqIFN1bW1hcnkuIHByb2Nlc3MuCgkgKgoJICogRGVzY3JpcHRpb24uIC4KCSAqCgkgKiBAc2luY2UgICAgICB4LngueAoJICogQGRlcHJlY2F0ZWQgeC54LnggVXNlIG5ld19mdW5jdGlvbl9uYW1lKCkgaW5zdGVhZC4KCSAqIEBhY2Nlc3MgICAgIHB1YmxpYwoJICoKCSAqIEBjbGFzcwoJICogQGF1Z21lbnRzIHBhcmVudAoJICogQG1peGVzICAgIG1peGluCgkgKgoJICogQGFsaWFzICAgIHJlYWxOYW1lCgkgKiBAbWVtYmVyb2YgbmFtZXNwYWNlCgkgKgoJICogQHNlZSAgRnVuY3Rpb24vY2xhc3MgcmVsaWVkIG9uCgkgKiBAbGluayBVUkwKCSAqIEBnbG9iYWwKCSAqCgkgKiBAZmlyZXMgICBldmVudE5hbWUKCSAqIEBmaXJlcyAgIGNsYXNzTmFtZSNldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGV2ZW50OmV2ZW50TmFtZQoJICogQGxpc3RlbnMgY2xhc3NOYW1lfmV2ZW50OmV2ZW50TmFtZQoJICogQHBhcmFtIHt0eXBlfSAgIHZhciAgICAgICAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcl0gICAgICAgICBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyPWRlZmF1bHRdIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlIHdpdGggZGVmYXVsdCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3RWYXIgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIG9iamVjdFZhci5rZXkgRGVzY3JpcHRpb24gb2YgYSBrZXkgaW4gdGhlIG9iamVjdFZhciBwYXJhbWV0ZXIuCgkgKgoJICogQHlpZWxkIHt0eXBlfSBZaWVsZGVkIHZhbHVlIGRlc2NyaXB0aW9uLgoJICoKCSAqIEByZXR1cm4ge3R5cGV9IFJldHVybiB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqLwoJYXN5bmMgcHJvY2VzcygpIHsKCgkJbGV0IGFuc3dlciA9IG5ldyBzYWxlc25vdy5FdmVudCgpOwoKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJwcm9jZXNzIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInByb2Nlc3MiLCBfbm9kZSwgKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJwcm9jZXNzIiwgKSA9PiB7CgoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuRXZlbnQucHJvY2VzcycpOwoKCQkJdmFyIGVycm9ycyA9IHsKCgkJCQkiMDEiOiAoKCkgPT4gewoKCQkJCQlsZXQgYW5zd2VyID0KCgkJCQkJCSF0aGlzLl9zZW5kZXJfc2V0IHx8ICF0aGlzLnNlbmRlcigpCgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAncHJvY2VzcycsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgIjAxIiwgYW5zd2VyKTsKCQkJCQlyZXR1cm4gYW5zd2VyOwoJCQkJfSkoKSA/ICgnTm8gU2VuZGVyJyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQkJIjAyIjogKCgpID0+IHsKCgkJCQkJbGV0IGFuc3dlciA9CgoJCQkJCQkhdGhpcy5fcmVjaXBpZW50X3NldCB8fCAhdGhpcy5yZWNpcGllbnQoKQoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ3Byb2Nlc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgImFuc3dlciIsICIwMiIsIGFuc3dlcik7CgkJCQkJcmV0dXJuIGFuc3dlcjsKCQkJCX0pKCkgPyAoJ05vIFJlY2lwaWVudCcgfHwgJ1ZhbGlkYXRpb24gRXJyb3InKSA6ICcnLAoKCQkJCSIwNCI6ICgoKSA9PiB7CgoJCQkJCWxldCBhbnN3ZXIgPQoKCQkJCQkJb1Njb3BlLl9ub2RlLl9zYW1lTm9kZSh0aGlzLnNlbmRlcigpKQoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ3Byb2Nlc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgImFuc3dlciIsICIwNCIsIGFuc3dlcik7CgkJCQkJcmV0dXJuIGFuc3dlcjsKCQkJCX0pKCkgPyAoJ1NlbnQgYnkgTWUnIHx8ICdWYWxpZGF0aW9uIEVycm9yJykgOiAnJywKCgkJCQkiMDUiOiAoKCkgPT4gewoKCQkJCQlsZXQgYW5zd2VyID0KCgkJCQkJCXRoaXMucmVjaXBpZW50KCkuX2NvZGVfc2V0ICYmICFvU2NvcGUuX25vZGUuX3NhbWVOb2RlKHRoaXMucmVjaXBpZW50KCkpICYmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgfHwgKG9TY29wZS5fX3NvY2tldHMgJiYgIW9TY29wZS5fX3NvY2tldHNbdGhpcy5yZWNpcGllbnQoKS5jb2RlKCldKSkKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdwcm9jZXNzJywgJ0VudGl0eU9iamVjdCcsIDAsICJhbnN3ZXIiLCAiMDUiLCBhbnN3ZXIpOwoJCQkJCXJldHVybiBhbnN3ZXI7CgkJCQl9KSgpID8gKCdJZ25vcm5pbmcgcmVjaXBpZW50JyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3Byb2Nlc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgewoJCQkJCQlba106IGVycm9yc1trXQoJCQkJCX0pOwoJCQkJCWRlbGV0ZSBlcnJvcnNba107CgkJCQl9KTsKCQkJCWlmIChPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIHsKCQkJCQkJX19leGNlcHRpb246IGVycm9ycywKCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIW9TY29wZS5fbm9kZS5wYXJlbnQoKS5hZGRyZXNzKCkpIHRoaXMuc2VuZGVyKCkuc3RvcmUoKTsKCgkJCWlmICh0aGlzLnJlc3BvbnNlVG8oKSkgewoJCQkJLy8gcmVzcG9uZGluZyB0byBhIHByZXZpb3VzIGV2ZW50CgkJCQlsb2coIkRpc3BhdGNoaW5nIGZvciAiICsgdGhpcy5yZXNwb25zZVRvKCkuY29kZSgpKTsKCQkJCWlmICh0eXBlb2YoZGlzcGF0Y2hFdmVudCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQodGhpcy5uYW1lKCkgKyAiLiIgKyB0aGlzLnJlc3BvbnNlVG8oKS5jb2RlKCksIHsKCQkJCQkJZGV0YWlsOiB0aGlzLl90b0RvY3VtZW50KHRydWUsIHRydWUpCgkJCQkJfSkpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2Yob1Njb3BlLmV2ZW50RW1pdHRlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJbG9nKCJEaXNwYXRjaGVkIHRocm91Z2ggZXZlbnRFbWl0dGVyIikKCQkJCQlvU2NvcGUuZXZlbnRFbWl0dGVyLmVtaXQodGhpcy5uYW1lKCkgKyAiLiIgKyB0aGlzLnJlc3BvbnNlVG8oKS5jb2RlKCksIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSwgdHJ1ZSkpOwoJCQkJfQoJCQl9IGVsc2UgaWYgKCFvU2NvcGUuX25vZGUuX3NhbWVOb2RlKHRoaXMucmVjaXBpZW50KCkpKSB7CgkJCQlsb2coIkV2ZW50IG5vdCBhZGRyZXNzZWQgdG8gbWUsIGNoZWNraW5nLi4uIiwgdGhpcy5yZWNpcGllbnQoKS5jb2RlKCkpOwoJCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAidW5kZWZpbmVkIiAmJiBvU2NvcGUuX19zb2NrZXRzICYmIG9TY29wZS5fX3NvY2tldHNbdGhpcy5yZWNpcGllbnQoKS5jb2RlKCldKSB7CgkJCQkJbG9nKCJGb3J3YXJkaW5nIHRvIHRoZSByZWdpc3RlcmVkIG5vZGUiLCB0aGlzLnJlY2lwaWVudCgpLmNvZGUoKSk7CgkJCQkJcmV0dXJuIGF3YWl0IHRoaXMuZm9yd2FyZCgpOwoJCQkJfSBlbHNlIGlmICghdGhpcy5yZWNpcGllbnQoKS5fY29kZV9zZXQpIHsKCQkJCQkvLyByZWNpcGllbnQgaXMgYSBxdWVyeSB0byBtYXRjaCBub2RlcwoJCQkJCWxvZygiUXVlcnk6IFdobyBzaG91bGQgcGljayB0aGlzIHVwPyIpOwoJCQkJCWxldCBxTm9kZXMgPSBhd2FpdCB0aGlzLnJlY2lwaWVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmZpbmRBbGwoKTsKCQkJCQlsZXQgbXlOb2RlcyA9IFtvU2NvcGUuX25vZGVdOwoJCQkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gInVuZGVmaW5lZCIgJiYgb1Njb3BlLl9fc29ja2V0cykgbXlOb2RlcyA9IG15Tm9kZXMuY29uY2F0KE9iamVjdC5rZXlzKG9TY29wZS5fX3NvY2tldHMpLm1hcChzID0+IG5ldyBvU2NvcGUuTm9kZSgpLmNvZGUocykpKTsKCQkJCQlxTm9kZXMgPSBxTm9kZXMuZmlsdGVyKHIgPT4gbXlOb2Rlcy5maW5kKG4gPT4gbi5fc2FtZU5vZGUocikpKS5maWx0ZXIobiA9PiAhbi5fc2FtZU5vZGUodGhpcy5zZW5kZXIoKSkpOwoJCQkJCWlmICghcU5vZGVzLmxlbmd0aCkgewoJCQkJCQlsb2coIlF1ZXJ5OiBObyBtYXRjaGVzIGZvdW5kLCBpZ25vcmluZy4uLiIpOwoJCQkJCQlpZiAodHlwZW9mKHJlamVjdCkgIT09ICJ1bmRlZmluZWQiKSByZWplY3QoKTsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJZm9yIGF3YWl0IChjb25zdCByIG9mIHFOb2RlcykgewoJCQkJCQlsZXQgZXZGcm9tID0gbmV3IG9TY29wZS5FdmVudCgpLmNhcnJpZXIob1Njb3BlLl9ub2RlKS5zZW5kZXIocikucmVzcG9uc2VUbyh0aGlzKTsKCQkJCQkJaWYgKHRoaXMuX2NsYXNzTmFtZV9zZXQpIGV2RnJvbS5jbGFzc05hbWUodGhpcy5jbGFzc05hbWUoKSk7CgoJCQkJCQlsb2coImludm9raW5nICIgKyByLmNvZGUoKSArICIgYW5kIHJlcGx5aW5nIHRvICIgKyB0aGlzLnNlbmRlcigpLmNvZGUoKSk7CgkJCQkJCWxldCBwYXlsb2FkID0gYXdhaXQgb1Njb3BlLl9ub2RlLl9pbnZva2VOb2RlKHIsIHRoaXMubWV0aG9kKCksIHRoaXMucGF5bG9hZCgpLCB0aGlzLl9jbGFzc05hbWVfc2V0ID8gbmV3IG9TY29wZS5FdmVudCgpLmNsYXNzTmFtZSh0aGlzLmNsYXNzTmFtZSgpKSA6IHVuZGVmaW5lZCwgdHJ1ZSk7CgkJCQkJCS8vIGxvZygiUGF5bG9hZCBbIiArIHIuY29kZSgpICsgIl0iLCBwYXlsb2FkKTsKCQkJCQkJYXdhaXQgdGhpcy5faW52b2tlTm9kZSh0aGlzLnNlbmRlcigpLCB0aGlzLm1ldGhvZCgpLCBwYXlsb2FkLCBldkZyb20pOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJd2FybigiTm8ga25vd24gbm9kZSB0byBmb3J3YXJkIHRvIiwgb1Njb3BlLl9ub2RlLmNvZGUoKSwgdGhpcy5yZWNpcGllbnQoKS5jb2RlKCkpOwoJCQkJCXJldHVybiBudWxsOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJbG9nKCJFeGVjdXRpbmcgRXZlbnQgbG9jYWxseTogIiArIHRoaXMuY2xhc3NOYW1lKCkgKyAiLiIgKyB0aGlzLm1ldGhvZCgpICsgIigpIC0gIiArIHRoaXMuY29kZSgpKTsKCgkJCQlsZXQgZXZUbyA9IHRoaXMuX2NsYXNzTmFtZV9zZXQgPyBuZXcgb1Njb3BlLkV2ZW50KCkuY2xhc3NOYW1lKHRoaXMuY2xhc3NOYW1lKCkpIDogdW5kZWZpbmVkOwoJCQkJcmV0dXJuIGF3YWl0IHRoaXMuX2ludm9rZU5vZGUodGhpcy5zZW5kZXIoKSwgdGhpcy5tZXRob2QoKSwgYXdhaXQgdGhpcy5faW52b2tlTm9kZShvU2NvcGUuX25vZGUsIHRoaXMubWV0aG9kKCksIHRoaXMucGF5bG9hZCgpLCBldlRvLCB0cnVlKSwgZXZUby5yZXNwb25zZVRvKHRoaXMpKTsKCQkJfQoKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdLAoJCX0pOwoKCQkvLyB0YWtlIG91dCB0aGUgaW52YWxpZCBub2RlIHJlc3VsdHMKCQlyZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByICYmIHIucmV0KTsKCgkJLy8gaGFzIGFueSBub2RlIGdlbmVyYXRlZCBhIHZhbGlkYXRpb24gZXhjZXB0aW9uPwoJCWxldCBfX2V4ID0gcmVzdWx0cy5maW5kKHIgPT4gci5yZXQuX19leGNlcHRpb24pOwoJCWlmIChfX2V4KSByZXR1cm4gX19leC5yZXQ7CgoJCXJldHVybiByZXN1bHRzLmxlbmd0aCA/IHJlc3VsdHNbMF0ucmV0IDogbnVsbDsKCgl9CgoJX3RvU1FMVGFibGUoKSB7CgkJbGV0IHJldCA9IHsKCQkJc3FsOiBgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoCiAgICAgICAgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVkKICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjbGFzc05hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbWV0aG9kJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3BheWxvYWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NhcnJpZXInLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdzZW5kZXInLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZWNpcGllbnQnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZXNwb25zZVRvJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qRXZlbnQqLyk7XG4nOwoKCQlyZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiB0cnVlLAoJCQlOdWxsOiB0cnVlLAoJCQkvL0lkOiAob2JqLCB2KSA9PiBvYmouc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWWAsCgoJCQkiY2xhc3NOYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NsYXNzTmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjbGFzc05hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkibWV0aG9kIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21ldGhvZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdtZXRob2QnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkicGF5bG9hZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwYXlsb2FkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3BheWxvYWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNhcnJpZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2FycmllcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjYXJyaWVyJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJzZW5kZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc2VuZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3NlbmRlcicsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkicmVjaXBpZW50IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlY2lwaWVudCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZWNpcGllbnQnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJInJlc3BvbnNlVG8iOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVzcG9uc2VUbycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZXNwb25zZVRvJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQlyZXNwb25zZVRvX0V2ZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Jlc3BvbnNlVG9fRXZlbnRzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJfSwgIl90b1NRTFRhYmxlIik7CgoJCS8vIHJldC5zcWwgKz0gJy8qRXZlbnQqLyk7XG4nOwoKCQlyZXQuc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChyZXQuc3FsKSA6IHJldC5zcWw7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NRTFRhYmxlJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldC5zcWwpOwoJCXJldHVybiByZXQuc3FsOwoJfQoKCV9mcm9tU1FMVGFibGUodGFibGUsIGZpZWxkcykgewoJCS8vIHRhYmxlIGlzIGEganNvbiBhcnJheQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY2xhc3NOYW1lIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5jbGFzc05hbWUodGFibGVbImNsYXNzTmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJtZXRob2QiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm1ldGhvZCh0YWJsZVsibWV0aG9kIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInBheWxvYWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnBheWxvYWQodGFibGVbInBheWxvYWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY2FycmllciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY2Fycmllcih0YWJsZVsiY2FycmllciJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJzZW5kZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnNlbmRlcih0YWJsZVsic2VuZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlY2lwaWVudCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucmVjaXBpZW50KHRhYmxlWyJyZWNpcGllbnQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVzcG9uc2VUbyIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucmVzcG9uc2VUbyh0YWJsZVsicmVzcG9uc2VUbyJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbChzcWwsIHRoaXMpOwoKCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCgkJCQkJLy8gaWYodGhpc1snXycrZmllbGQrJ19zZXQnXSAmJiAodHlwZW9mKHRoaXNbJ18nK2ZpZWxkXSk9PT0ndW5kZWZpbmVkJyB8fCB0aGlzWydfJytmaWVsZF09PW51bGwpKSByZXR1cm47CgkJCQkJLy8gaWYodHlwZW9mKGVhT2JqKT09PSd1bmRlZmluZWQnKSByZXR1cm47IC8vIHdoeT8KCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCXJldHVybiBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiY2xhc3NOYW1lIiwgb2JqLCB0aGlzLmNsYXNzTmFtZSgpKTsKCgkJX29wdGlvbnMoIm1ldGhvZCIsIG9iaiwgdGhpcy5tZXRob2QoKSk7CgoJCV9vcHRpb25zKCJwYXlsb2FkIiwgb2JqLCB0aGlzLnBheWxvYWQoKSk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiMzY5ZTQ5YzEtZGM3Ny00YTE5LTlhOTItYTc1OGQ2MTNhNzVhIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkV2ZW50ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5FdmVudCB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5FdmVudFtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5FdmVudFtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkV2ZW50W2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRXZlbnRbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRXZlbnRbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkV2ZW50W2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCWlmICghdGhpcy5jYXJyaWVyKCkgfHwgKHRoaXMuY2FycmllcigpCgoJCQkJJiYKCQkJCSF0aGlzLmNhcnJpZXIoKS5ub2RlX0NvbmZpZ3MoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuY2FycmllcigpLmNhcnJpZXJfRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmNhcnJpZXIoKS5zZW5kZXJfRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmNhcnJpZXIoKS5yZWNpcGllbnRfRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmNhcnJpZXIoKS5iYWNrdXBfTm9kZXMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuY2FycmllcigpLnBhcmVudF9Ob2RlcygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jYXJyaWVyKCkubm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoImNhcnJpZXIiLCBvYmosIHRoaXMuY2FycmllcigpKTsKCQl9CgoJCWlmICghdGhpcy5zZW5kZXIoKSB8fCAodGhpcy5zZW5kZXIoKQoKCQkJCSYmCgkJCQkhdGhpcy5zZW5kZXIoKS5ub2RlX0NvbmZpZ3MoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuc2VuZGVyKCkuY2Fycmllcl9FdmVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuc2VuZGVyKCkuc2VuZGVyX0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5zZW5kZXIoKS5yZWNpcGllbnRfRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnNlbmRlcigpLmJhY2t1cF9Ob2RlcygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5zZW5kZXIoKS5wYXJlbnRfTm9kZXMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuc2VuZGVyKCkubm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoInNlbmRlciIsIG9iaiwgdGhpcy5zZW5kZXIoKSk7CgkJfQoKCQlpZiAoIXRoaXMucmVjaXBpZW50KCkgfHwgKHRoaXMucmVjaXBpZW50KCkKCgkJCQkmJgoJCQkJIXRoaXMucmVjaXBpZW50KCkubm9kZV9Db25maWdzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnJlY2lwaWVudCgpLmNhcnJpZXJfRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnJlY2lwaWVudCgpLnNlbmRlcl9FdmVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMucmVjaXBpZW50KCkucmVjaXBpZW50X0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5yZWNpcGllbnQoKS5iYWNrdXBfTm9kZXMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMucmVjaXBpZW50KCkucGFyZW50X05vZGVzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnJlY2lwaWVudCgpLm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJyZWNpcGllbnQiLCBvYmosIHRoaXMucmVjaXBpZW50KCkpOwoJCX0KCgkJaWYgKCF0aGlzLnJlc3BvbnNlVG8oKSB8fCAodGhpcy5yZXNwb25zZVRvKCkKCgkJCQkmJgoJCQkJIXRoaXMucmVzcG9uc2VUbygpLnJlc3BvbnNlVG9fRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJyZXNwb25zZVRvIiwgb2JqLCB0aGlzLnJlc3BvbnNlVG8oKSk7CgkJfQoKCQlfb3B0aW9ucygicmVzcG9uc2VUb19FdmVudHMiLCBvYmosIHRoaXMucmVzcG9uc2VUb19FdmVudHMoKSk7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2NsYXNzTmFtZScsICdtZXRob2QnLCAncGF5bG9hZCcsICdjYXJyaWVyJywgJ3NlbmRlcicsICdyZWNpcGllbnQnLCAncmVzcG9uc2VUbycsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsncmVzcG9uc2VUb19FdmVudHMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIkV2ZW50IiAmJiAobS50YXJnZXQgfHwgbS5vdXRTY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkgJiYgKCFtLnNvdXJjZSB8fCAobS5zb3VyY2UgJiYgLyohbS5vdXRTY3JpcHQgJiYqLyB0aGlzWydfJyArIG0uc291cmNlICsgJ19zZXQnXSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0ub3V0U2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5vdXRTY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5vdXRTY3JpcHR9KX1gKSh0aGlzLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS5zb3VyY2UpIHsKCQkJCWlmIChtLnNvdXJjZS5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMpID0+IHtyZXR1cm4gX3RoaXMuJHttLnNvdXJjZX07fWApKHRoaXMpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS5zb3VyY2UsIHRoaXMpOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnRhcmdldCkgb2JqW20udGFyZ2V0XSA9IHJldDsKCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJW20udGFyZ2V0IHx8IG0uc291cmNlXTogdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddCgkJCX0pOwoJCX0pOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCS8vIHVzZSB0aGlzLl9tYXAoKSB3aXRoIHJldmVyc2UKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNsYXNzTmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJtZXRob2QiLCBvYmopOwoKCQlfb3B0aW9ucygicGF5bG9hZCIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjM2OWU0OWMxLWRjNzctNGExOS05YTkyLWE3NThkNjEzYTc1YSIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5FdmVudCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRXZlbnQgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRXZlbnRbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRXZlbnRbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5FdmVudFtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkV2ZW50W2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkV2ZW50W2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5FdmVudFtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJjYXJyaWVyIiwgb2JqKTsKCgkJX29wdGlvbnMoInNlbmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJyZWNpcGllbnQiLCBvYmopOwoKCQlfb3B0aW9ucygicmVzcG9uc2VUbyIsIG9iaik7CgoJCV9vcHRpb25zKCJyZXNwb25zZVRvX0V2ZW50cyIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2NsYXNzTmFtZScsICdtZXRob2QnLCAncGF5bG9hZCcsICdjYXJyaWVyJywgJ3NlbmRlcicsICdyZWNpcGllbnQnLCAncmVzcG9uc2VUbycsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsncmVzcG9uc2VUb19FdmVudHMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIkV2ZW50IiAmJiAobS5zb3VyY2UgfHwgbS5pblNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLmluU2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaiwgb1Njb3BlLCBtYXApID0+IHske20uaW5TY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5pblNjcmlwdH0pfWApKG9iaiwgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0udGFyZ2V0KSB7CgkJCQlpZiAobS50YXJnZXQuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaikgPT4ge3JldHVybiBvYmouJHttLnRhcmdldH07fWApKG9iaik7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmpbbS50YXJnZXRdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS50YXJnZXQsIG9iaik7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS5zb3VyY2UpIHsKCQkJCWlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0ocmV0KTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0gPSByZXQ7CgkJCQl9CgkJCX0KCQl9KTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXTogIiciICsgdGhpcy5JZCArICInIgoJCX07CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY2xhc3NOYW1lIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NsYXNzTmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jbGFzc05hbWUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2NsYXNzTmFtZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm1ldGhvZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9tZXRob2Rfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMubWV0aG9kKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdtZXRob2QnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJwYXlsb2FkIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3BheWxvYWRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucGF5bG9hZCgpOwoKCQkJZlZhbHVlID0gIiciICsgKCh2ICYmIHYucmVwbGFjZSkgPyB2LnJlcGxhY2UoL1wnL2csICJcJ1wnIikgOiB2KSArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgncGF5bG9hZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNhcnJpZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY2Fycmllcl9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY2FycmllcigpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgnY2FycmllcicsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigic2VuZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3NlbmRlcl9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuc2VuZGVyKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdzZW5kZXInLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlY2lwaWVudCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9yZWNpcGllbnRfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnJlY2lwaWVudCgpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgncmVjaXBpZW50JywgdW5kZWZpbmVkKSArICJpZCJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZXNwb25zZVRvIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3Jlc3BvbnNlVG9fc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnJlc3BvbnNlVG8oKTsKCgkJCWlmICh2ICYmICh2Ll9fc3luY19vbigpIHx8IHYuSWQgPT0gdi5JZCkpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYuSWQgKyAiJyI7CgkJCX0gZWxzZSB7CgkJCQlmVmFsdWUgPSAwOwoJCQl9CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3Jlc3BvbnNlVG8nLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9hY3RpdmVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYWN0aXZlKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZW5hYmxlZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5lbmFibGVkKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvZGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29kZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2RhdGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZGF0ZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5uYW1lKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3JlbWFya19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5yZW1hcmsoKTsKCgkJCWZWYWx1ZSA9ICInIiArICgodiAmJiB2LnJlcGxhY2UpID8gdi5yZXBsYWNlKC9cJy9nLCAiXCdcJyIpIDogdikgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX1EoKSB7CgkJbGV0IF9vID0gJyInOwoJCWxldCBfcSA9IF9vOwoKCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXRoaXMuX19RID0gdGhpcy5fX1EgPT0gX28gPyBfcSA6IF9vOwoJCXJldHVybiB0aGlzLl9fUTsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcsIHRoaXMuX25Db2RlKCdjbGFzc05hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnbWV0aG9kJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3BheWxvYWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY2FycmllcicsIHVuZGVmaW5lZCkgKyAiLmlkIiwgdGhpcy5fbkNvZGUoJ3NlbmRlcicsIHVuZGVmaW5lZCkgKyAiLmlkIiwgdGhpcy5fbkNvZGUoJ3JlY2lwaWVudCcsIHVuZGVmaW5lZCkgKyAiLmlkIiwgdGhpcy5fbkNvZGUoJ3Jlc3BvbnNlVG8nLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpXTsKCQlmaWVsZHMgPSBBcnJheS5pc0FycmF5KGZpZWxkcykgPyBmaWVsZHMgOiBbZmllbGRzXTsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQkvLyB7ZmllbGQ6IG9yZGVyfQoJCQlmaWVsZHMgPSBbXTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY2xhc3NOYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubWV0aG9kKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbWV0aG9kJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY2FycmllcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NhcnJpZXInLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnNlbmRlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ3NlbmRlcicsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMucmVjaXBpZW50KSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgncmVjaXBpZW50JywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5yZXNwb25zZVRvKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgncmVzcG9uc2VUbycsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX1gKTsKCgkJfQoJCXJldHVybiBmaWVsZHM7Cgl9CgoJX2Zyb21EQk9iamVjdChyID0ge30pIHsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5fX2ltcG9ydChyLCB7CgkJCQlJZDogb2JqID0+IHRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ10sCgoJCQkJY2xhc3NOYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuY2xhc3NOYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJbWV0aG9kOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbWV0aG9kJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMubWV0aG9kKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcGF5bG9hZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3BheWxvYWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5wYXlsb2FkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY2FycmllcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhcnJpZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jYXJyaWVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJc2VuZGVyOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc2VuZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuc2VuZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVjaXBpZW50OiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVjaXBpZW50JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucmVjaXBpZW50KG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVzcG9uc2VUbzogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Jlc3BvbnNlVG8nLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZXNwb25zZVRvKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb2RlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5kYXRlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5uYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucmVtYXJrKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlOdWxsOiB0cnVlLAoKCQkJY2FycmllcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhcnJpZXInLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Ob2RlKCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQlzZW5kZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzZW5kZXInLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Ob2RlKCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQlyZWNpcGllbnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZWNpcGllbnQnLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Ob2RlKCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQlyZXNwb25zZVRvOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVzcG9uc2VUbycsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LkV2ZW50KCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCX0sICJfdG9TZWxlY3RIZWFkZXIiKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0SGVhZGVyJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU2VsZWN0U1FMKGZpZWxkcykgewoJCWxldCBzcWwgPSAic2VsZWN0ICI7CgoJCWxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9YDsKCgkJbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7CgkJc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOwoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOwoKCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcykgewoJCQkvLyB7ZmllbGQ6IGZ1bmN0aW9ufQoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY2xhc3NOYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jbGFzc05hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NsYXNzTmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5tZXRob2QpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm1ldGhvZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbWV0aG9kJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNhcnJpZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNhcnJpZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NhcnJpZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuc2VuZGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5zZW5kZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3NlbmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5yZWNpcGllbnQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnJlY2lwaWVudH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVjaXBpZW50JywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnJlc3BvbnNlVG8pIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnJlc3BvbnNlVG99KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3Jlc3BvbnNlVG8nLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJY2xhc3NOYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jbGFzc05hbWVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jbGFzc05hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NsYXNzTmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY2xhc3NOYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY2xhc3NOYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jbGFzc05hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW1ldGhvZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21ldGhvZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbWV0aG9kX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbWV0aG9kX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9tZXRob2RfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX21ldGhvZF9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX21ldGhvZF9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbWV0aG9kX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlwYXlsb2FkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncGF5bG9hZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcGF5bG9hZF9zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY2FycmllcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhcnJpZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NhcnJpZXJfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9jYXJyaWVyX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJc2VuZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc2VuZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9zZW5kZXJfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9zZW5kZXJfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlyZWNpcGllbnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZWNpcGllbnQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3JlY2lwaWVudF9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX3JlY2lwaWVudF9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlc3BvbnNlVG86IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZXNwb25zZVRvJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9yZXNwb25zZVRvX3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fcmVzcG9uc2VUb19jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jb2RlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fY29kZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX29yZGVyX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fb3JkZXJfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fZGF0ZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi50b0lTT1N0cmluZykgewoJCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbGl0ZScpIHsKCQkJCQkJb2JqLnNxbCArPSAic3RyZnRpbWUoJyVzJywgJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJykiOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9iai5zcWwgKz0gIiciICsgdi50b0lTT1N0cmluZygpICsgIiciOwoJCQkJCX0KCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9uYW1lX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9yZW1hcmtfc2V0KSByZXR1cm47CgoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlc3BvbnNlVG9fRXZlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVzcG9uc2VUb19FdmVudHMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzX3NldCkgcmV0dXJuOwoKCQkJCWxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCgicmVzcG9uc2VUby5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fcmVzcG9uc2VUb19FdmVudHNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzX2Nvb3AgPT0gJ05PVCBJTicpIHsKCQkJCQlpbk9QID0gJ05PVCBJTic7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fcmVzcG9uc2VUb19FdmVudHNfY29vcCA9PSAnPT0nKSB7CgkJCQkJak9QID0gJ0lOVEVSU0VDVCc7CgkJCQl9CgoJCQkJb2JqLnNxbCArPSBgYW5kIC8qcmVzcG9uc2VUb19FdmVudHMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCX0sICJfdG9TZWxlY3RTUUwiLCBmaWVsZHMpLnNxbDsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQlpZiAoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNsYXNzTmFtZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjbGFzc05hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jbGFzc05hbWV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubWV0aG9kKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ21ldGhvZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm1ldGhvZH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jYXJyaWVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NhcnJpZXInLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNhcnJpZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuc2VuZGVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3NlbmRlcicsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuc2VuZGVyfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnJlY2lwaWVudCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZWNpcGllbnQnLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnJlY2lwaWVudH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5yZXNwb25zZVRvKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3Jlc3BvbnNlVG8nLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnJlc3BvbnNlVG99YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJY2FycmllcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhcnJpZXInLCB1bmRlZmluZWQpKSA9PiBvYmouY2FycmllciA9IHYuX3RvUGF0aHMoKSwKCgkJCXNlbmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3NlbmRlcicsIHVuZGVmaW5lZCkpID0+IG9iai5zZW5kZXIgPSB2Ll90b1BhdGhzKCksCgoJCQlyZWNpcGllbnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZWNpcGllbnQnLCB1bmRlZmluZWQpKSA9PiBvYmoucmVjaXBpZW50ID0gdi5fdG9QYXRocygpLAoKCQkJcmVzcG9uc2VUbzogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Jlc3BvbnNlVG8nLCB1bmRlZmluZWQpKSA9PiBvYmoucmVzcG9uc2VUbyA9IHYuX3RvUGF0aHMoKSwKCgkJCXJlc3BvbnNlVG9fRXZlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVzcG9uc2VUb19FdmVudHMnLCB1bmRlZmluZWQpKSA9PiBvYmoucmVzcG9uc2VUb19FdmVudHMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJfSwgIl90b1BhdGhzIik7CgkJLy8gcmV0dXJuIHJldDsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5tYXAoayA9PiAoewoJCQlba106IHJldFtrXQoJCX0pKTsKCX0KCglfdG9VcGRhdGVTUUwoZmllbGRzKSB7CgkJbGV0IHJldEZpZWxkcyA9IHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLmpvaW4oJywgJyk7CgkJbGV0IHNxbCA9IGB1cGRhdGUgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSBzZXQgYCArIE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvREJPYmplY3QoZmllbGRzKSkubWFwKHYgPT4gdGhpcy5fUSgpICsgdlswXSArIHRoaXMuX1EoKSArICI9IiArIHZbMV0pICsgYCB3aGVyZSAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgOyAvL2AgcmV0dXJuaW5nICR7cmV0RmllbGRzfWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvVXBkYXRlU1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfdG9JbnNlcnRTUUwoZmllbGRzKSB7CgkJbGV0IG9iaiA9IHRoaXMuX3RvREJPYmplY3QoZmllbGRzKTsKCQlsZXQgc3FsID0gYGluc2VydCBpbnRvICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKGAgKyBPYmplY3Qua2V5cyhvYmopLm1hcChrID0+IHRoaXMuX1EoKSArIGsgKyB0aGlzLl9RKCkpICsgIikgdmFsdWVzICgiICsgT2JqZWN0LnZhbHVlcyhvYmopICsgYClgOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0luc2VydFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5FdmVudCkgcmV0dXJuOwoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5FdmVudCA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCBzcWwgPSBuZXcgc2FsZXNub3cuRXZlbnQoKQoKCQkJCQkuY2FycmllcihuZXcgc2FsZXNub3cuTm9kZSgpKQoKCQkJCQkuc2VuZGVyKG5ldyBzYWxlc25vdy5Ob2RlKCkpCgoJCQkJCS5yZWNpcGllbnQobmV3IHNhbGVzbm93Lk5vZGUoKSkKCgkJCQkJLnJlc3BvbnNlVG8obmV3IHNhbGVzbm93LkV2ZW50KCkpCgoJCQkJCS5yZXNwb25zZVRvX0V2ZW50cyhuZXcgc2FsZXNub3cuRXZlbnQoKSkKCgkJCQkJLl90b1NRTFRhYmxlKGRlcHRoKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIkV2ZW50IikgcmV0dXJuIGZhbHNlOwoKCQkJbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJCUZ1bGw6IHRydWUsCgkJCQlOdWxsOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5faWQgPSB0aGlzLklkID09IHF1ZXJ5LklkLAoKCQkJCWNsYXNzTmFtZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY2xhc3NOYW1lID0gdiA9PSBxdWVyeS5jbGFzc05hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY2xhc3NOYW1lX3NldCAmJiAhcXVlcnkuX2NsYXNzTmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY2xhc3NOYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NsYXNzTmFtZV9zZXQgJiYgcXVlcnkuX2NsYXNzTmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNsYXNzTmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQltZXRob2Q6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm1ldGhvZCA9IHYgPT0gcXVlcnkubWV0aG9kKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX21ldGhvZF9zZXQgJiYgIXF1ZXJ5Ll9tZXRob2Rfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm1ldGhvZCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9tZXRob2Rfc2V0ICYmIHF1ZXJ5Ll9tZXRob2Rfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5tZXRob2QgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcGF5bG9hZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucGF5bG9hZCA9IHYgPT0gcXVlcnkucGF5bG9hZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9wYXlsb2FkX3NldCAmJiAhcXVlcnkuX3BheWxvYWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnBheWxvYWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcGF5bG9hZF9zZXQgJiYgcXVlcnkuX3BheWxvYWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5wYXlsb2FkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNhcnJpZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNhcnJpZXIgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LmNhcnJpZXIoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY2Fycmllcl9zZXQgJiYgIXF1ZXJ5Ll9jYXJyaWVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jYXJyaWVyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NhcnJpZXJfc2V0ICYmIHF1ZXJ5Ll9jYXJyaWVyX3NldCkgfHwKCgkJCQkJCSh0aGlzLmNhcnJpZXIoKSAmJiAhdGhpcy5jYXJyaWVyKCkuX21hdGNoZXMocXVlcnkuY2FycmllcigpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY2FycmllciA9IGZhbHNlOwoJCQkJfSwKCgkJCQlzZW5kZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnNlbmRlciA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkuc2VuZGVyKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3NlbmRlcl9zZXQgJiYgIXF1ZXJ5Ll9zZW5kZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnNlbmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9zZW5kZXJfc2V0ICYmIHF1ZXJ5Ll9zZW5kZXJfc2V0KSB8fAoKCQkJCQkJKHRoaXMuc2VuZGVyKCkgJiYgIXRoaXMuc2VuZGVyKCkuX21hdGNoZXMocXVlcnkuc2VuZGVyKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5zZW5kZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVjaXBpZW50OiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZWNpcGllbnQgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LnJlY2lwaWVudCgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZWNpcGllbnRfc2V0ICYmICFxdWVyeS5fcmVjaXBpZW50X3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZWNpcGllbnQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVjaXBpZW50X3NldCAmJiBxdWVyeS5fcmVjaXBpZW50X3NldCkgfHwKCgkJCQkJCSh0aGlzLnJlY2lwaWVudCgpICYmICF0aGlzLnJlY2lwaWVudCgpLl9tYXRjaGVzKHF1ZXJ5LnJlY2lwaWVudCgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVjaXBpZW50ID0gZmFsc2U7CgkJCQl9LAoKCQkJCXJlc3BvbnNlVG86IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlc3BvbnNlVG8gPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LnJlc3BvbnNlVG8oKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcmVzcG9uc2VUb19zZXQgJiYgIXF1ZXJ5Ll9yZXNwb25zZVRvX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZXNwb25zZVRvID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3Jlc3BvbnNlVG9fc2V0ICYmIHF1ZXJ5Ll9yZXNwb25zZVRvX3NldCkgfHwKCgkJCQkJCSh0aGlzLnJlc3BvbnNlVG8oKSAmJiAhdGhpcy5yZXNwb25zZVRvKCkuX21hdGNoZXMocXVlcnkucmVzcG9uc2VUbygpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVzcG9uc2VUbyA9IGZhbHNlOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVzcG9uc2VUb19FdmVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoucmVzcG9uc2VUb19FdmVudHMgPSB2Lm1hcChfdiA9PiBxdWVyeS5yZXNwb25zZVRvX0V2ZW50cygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJY2FycmllcjogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIGNhcnJpZXIiKTsKCQkJCQlvYmouY2FycmllciA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCXNlbmRlcjogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIHNlbmRlciIpOwoJCQkJCW9iai5zZW5kZXIgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQlyZWNpcGllbnQ6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciByZWNpcGllbnQiKTsKCQkJCQlvYmoucmVjaXBpZW50ID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJcmVzcG9uc2VUbzogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIHJlc3BvbnNlVG8iKTsKCQkJCQlvYmoucmVzcG9uc2VUbyA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCXJlc3BvbnNlVG9fRXZlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnJlc3BvbnNlVG9fRXZlbnRzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl9jbGFzc05hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbWV0aG9kX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3BheWxvYWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY2Fycmllcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9zZW5kZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcmVjaXBpZW50X3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3Jlc3BvbnNlVG9fc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fYWN0aXZlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcmRlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9kYXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX25hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcmVtYXJrX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQljYXJyaWVyOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMuY2FycmllcihyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJc2VuZGVyOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMuc2VuZGVyKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlyZWNpcGllbnQ6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5yZWNpcGllbnQocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCXJlc3BvbnNlVG86IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5yZXNwb25zZVRvKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlyZXNwb25zZVRvX0V2ZW50czogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLnJlc3BvbnNlVG9fRXZlbnRzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ107CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJY2xhc3NOYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKSA6ICJjbGFzc05hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY2xhc3NOYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jbGFzc05hbWUocmVmKTsKCgkJCX0sCgoJCQltZXRob2Q6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdtZXRob2QnLCB1bmRlZmluZWQpIDogIm1ldGhvZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9tZXRob2RfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm1ldGhvZChyZWYpOwoKCQkJfSwKCgkJCXBheWxvYWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdwYXlsb2FkJywgdW5kZWZpbmVkKSA6ICJwYXlsb2FkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3BheWxvYWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnBheWxvYWQocmVmKTsKCgkJCX0sCgoJCQljYXJyaWVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY2FycmllcicsIHVuZGVmaW5lZCkgOiAiY2FycmllciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jYXJyaWVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLmNhcnJpZXIoKSB8fCBuZXcgc2FsZXNub3cuTm9kZSgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuY2FycmllcihvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIGNhcnJpZXIiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCXNlbmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3NlbmRlcicsIHVuZGVmaW5lZCkgOiAic2VuZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3NlbmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5zZW5kZXIoKSB8fCBuZXcgc2FsZXNub3cuTm9kZSgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuc2VuZGVyKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2Ugc2VuZGVyIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQlyZWNpcGllbnQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZWNpcGllbnQnLCB1bmRlZmluZWQpIDogInJlY2lwaWVudCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZWNpcGllbnRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMucmVjaXBpZW50KCkgfHwgbmV3IHNhbGVzbm93Lk5vZGUoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLnJlY2lwaWVudChvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIHJlY2lwaWVudCIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJcmVzcG9uc2VUbzogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3Jlc3BvbnNlVG8nLCB1bmRlZmluZWQpIDogInJlc3BvbnNlVG8iKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVzcG9uc2VUb19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5yZXNwb25zZVRvKCkgfHwgbmV3IHNhbGVzbm93LkV2ZW50KCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5yZXNwb25zZVRvKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgcmVzcG9uc2VUbyIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJcmVzcG9uc2VUb19FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZXNwb25zZVRvX0V2ZW50cycsIHVuZGVmaW5lZCkgOiAicmVzcG9uc2VUb19FdmVudHMiKSkgPT4gdGhpcy5yZXNwb25zZVRvX0V2ZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuRXZlbnQoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX1RISVM6IChvYmosIHYpID0+IHsKCQkJCWlmIChiVG9vbCkgcmV0dXJuOwoJCQkJb2JqLlRISVMgPSB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQlvYmouT1BFUkFUT1JTLlRISVMgPSB0aGlzLl9USElTX2Nvb3A7CgkJCX0sCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ10gPSB2LAoKCQkJImNsYXNzTmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjbGFzc05hbWUnLCB1bmRlZmluZWQpIDogImNsYXNzTmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jbGFzc05hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NsYXNzTmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm1ldGhvZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdtZXRob2QnLCB1bmRlZmluZWQpIDogIm1ldGhvZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9tZXRob2RfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX21ldGhvZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInBheWxvYWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncGF5bG9hZCcsIHVuZGVmaW5lZCkgOiAicGF5bG9hZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9wYXlsb2FkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9wYXlsb2FkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY2FycmllciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjYXJyaWVyJywgdW5kZWZpbmVkKSA6ICJjYXJyaWVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fY2Fycmllcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY2Fycmllcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInNlbmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzZW5kZXInLCB1bmRlZmluZWQpIDogInNlbmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX3NlbmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fc2VuZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVjaXBpZW50IjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlY2lwaWVudCcsIHVuZGVmaW5lZCkgOiAicmVjaXBpZW50IikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fcmVjaXBpZW50X2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZWNpcGllbnRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZXNwb25zZVRvIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3Jlc3BvbnNlVG8nLCB1bmRlZmluZWQpIDogInJlc3BvbnNlVG8iKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl9yZXNwb25zZVRvX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZXNwb25zZVRvX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3JkZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGw7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIG9ialtlYUNvZGVdID0gb2JqW2VhQ29kZV0ucmVwbGFjZSgvXC5bMC05XSpaL2csICcnKTsKCgkJCQlpZiAodGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGF0ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9uYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9uYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3JlbWFya19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQlyZXNwb25zZVRvX0V2ZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3Jlc3BvbnNlVG9fRXZlbnRzJywgdW5kZWZpbmVkKSA6ICJyZXNwb25zZVRvX0V2ZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9yZXNwb25zZVRvX0V2ZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVzcG9uc2VUb19FdmVudHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCWJ5Tm9kZShhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfY2FycmllciJdICYmIChhWyJfY2FycmllciJdLkVxdWFscyA/IGFbIl9jYXJyaWVyIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9jYXJyaWVyIl0sIHIpKSkgewoJCQkJCXIuX2NhcnJpZXJfRXZlbnRzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlOb2RlKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9zZW5kZXIiXSAmJiAoYVsiX3NlbmRlciJdLkVxdWFscyA/IGFbIl9zZW5kZXIiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX3NlbmRlciJdLCByKSkpIHsKCQkJCQlyLl9zZW5kZXJfRXZlbnRzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlOb2RlKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9yZWNpcGllbnQiXSAmJiAoYVsiX3JlY2lwaWVudCJdLkVxdWFscyA/IGFbIl9yZWNpcGllbnQiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX3JlY2lwaWVudCJdLCByKSkpIHsKCQkJCQlyLl9yZWNpcGllbnRfRXZlbnRzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlFdmVudChhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfcmVzcG9uc2VUbyJdICYmIChhWyJfcmVzcG9uc2VUbyJdLkVxdWFscyA/IGFbIl9yZXNwb25zZVRvIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9yZXNwb25zZVRvIl0sIHIpKSkgewoJCQkJCXIuX3Jlc3BvbnNlVG9fRXZlbnRzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSBmYWxzZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLnBheWxvYWQgPSB7fTsKCQkJaWYgKCF0aGlzLl9wYXlsb2FkX3NldCkgZXJyb3IucGF5bG9hZFsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IucGF5bG9hZCkubGVuZ3RoKSBkZWxldGUgZXJyb3IucGF5bG9hZDsKCQl9CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSBmYWxzZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLnNlbmRlciA9IHt9OwoJCQlpZiAoIXRoaXMuX3NlbmRlcl9zZXQpIGVycm9yLnNlbmRlclsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghdGhpcy5zZW5kZXIoKSkgZXJyb3Iuc2VuZGVyWyIwMiJdID0gIkVtcHR5IFZhbHVlIjsKCQkJaWYgKHRoaXMuc2VuZGVyKCkgJiYgYlN5bmMgJiYgIXRoaXMuc2VuZGVyKCkuX19zeW5jX29uKCkpIGVycm9yLnNlbmRlclsiMDMiXSA9ICJOb3QgaW4gU3luYyI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLnNlbmRlcikubGVuZ3RoKSBkZWxldGUgZXJyb3Iuc2VuZGVyOwoJCX0KCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IGZhbHNlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5FdmVudC5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuRXZlbnQobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLmNvZGUodGhpcy5jb2RlKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCWlmICh0eXBlb2Yoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgPT09ICJ1bmRlZmluZWQiIHx8IHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQkJCWF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsKCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiA9IHsKCQkJCQkJCU93bmVyOiB0aGlzLAoJCQkJCQkJc3FsczogW10sCgkJCQkJCQlzdGFydDogbmV3IERhdGUoKSwKCQkJCQkJCWVuZDogbnVsbAoJCQkJCQl9OwoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9jb2RlX3NldCkgewoJCQkJCXRoaXMuY29kZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSAoKSA9PiB0aGlzLl91dWlkKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX2NhcnJpZXJfc2V0ICYmIHRoaXMuY2FycmllcigpICYmICEoYXdhaXQgdGhpcy5jYXJyaWVyKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfY2FycmllcigpOwoKCQkJCQlpZiAodGhpcy5fc2VuZGVyX3NldCAmJiB0aGlzLnNlbmRlcigpICYmICEoYXdhaXQgdGhpcy5zZW5kZXIoKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9zZW5kZXIoKTsKCgkJCQkJaWYgKHRoaXMuX3JlY2lwaWVudF9zZXQgJiYgdGhpcy5yZWNpcGllbnQoKSAmJiAhKGF3YWl0IHRoaXMucmVjaXBpZW50KCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfcmVjaXBpZW50KCk7CgoJCQkJCWlmICh0aGlzLl9yZXNwb25zZVRvX3NldCAmJiB0aGlzLnJlc3BvbnNlVG8oKSAmJiAhKGF3YWl0IHRoaXMucmVzcG9uc2VUbygpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX3Jlc3BvbnNlVG8oKTsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBGaW5pc2hlZCBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0gSWQ9WyR7dGhpcy5JZH1dYCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fcmVzcG9uc2VUb19FdmVudHNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5yZXNwb25zZVRvX0V2ZW50cygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkV2ZW50Lmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkV2ZW50LnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvVXBkYXRlU1FMKCkpOwoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKCkpOwoJCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0WzBdOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5FdmVudC5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSAoYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgKTsKCQkJCXJldCA9IHJldCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5FdmVudChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93Lk5vZGUgPSBjbGFzcyBOb2RlIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUWlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUp1YjBSbGRHVmpkQ0k2ZEhKMVpTd2lhVzVwZEM1bGJtUnpJam95TENKcGJtbDBMbXh2YjNBaU9qQXVOU3dpZEc5dmJITXVjM1J2Y21VaU9tWmhiSE5sTENKa1pYUmxZM1JRWVhKbGJuUXVTVkFpT2lJeE9UVXVNVEV5TGpJeE5pNHhOek1pTENKa1pYUmxZM1JRWVhKbGJuUXVZMjlrWlNJNkltVTRaR1V3Tm1VelpXUmpORFF6WVdVNVpHWmxNV1JsTldWak5USmhOR0ptSWl3aWMyVmpjbVYwSWpvaWIxTkxkMmRhTW5OTFJrOVVTVXBqWWtGbVZVbFJORU5xT1hGelNEUTRibXdpTENKd2JHRjVaM0p2ZFc1a0lqcDBjblZsTENKblVsQkRJanAwY25WbExDSnpkRzl5WlM1elpXNXphWFJwZG1sMGVTSTZNU3dpWTI5dGNHRnVlU0k2SW5KbGMzVnRaU0o5YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzSWtkcGRFaDFZaUpkYCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJhZGRyZXNzIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hZGRyZXNzKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYmFja3VwIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9iYWNrdXAoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJwYXJlbnQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3BhcmVudCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInBvcnQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3BvcnQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvbmxpbmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29ubGluZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInNlY3VyZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfc2VjdXJlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAidHlwZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfdHlwZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfbm9kZV9Db25maWdzKCk7CgoJCXRoaXMuY2xlYXJfY2Fycmllcl9FdmVudHMoKTsKCgkJdGhpcy5jbGVhcl9zZW5kZXJfRXZlbnRzKCk7CgoJCXRoaXMuY2xlYXJfcmVjaXBpZW50X0V2ZW50cygpOwoKCQl0aGlzLmNsZWFyX2JhY2t1cF9Ob2RlcygpOwoKCQl0aGlzLmNsZWFyX3BhcmVudF9Ob2RlcygpOwoKCQl0aGlzLmNsZWFyX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiTm9kZSIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJcmV0dXJuIHRoaXM7CgoJCWlmICh0aGlzLl9iYWNrdXBfc2V0ICYmIHRoaXMuX2JhY2t1cCkgdGhpcy5fYmFja3VwLlRvb2wgPSB0b29sOwoKCQlpZiAodGhpcy5fcGFyZW50X3NldCAmJiB0aGlzLl9wYXJlbnQpIHRoaXMuX3BhcmVudC5Ub29sID0gdG9vbDsKCgkJaWYgKHRoaXMuX3R5cGVfc2V0ICYmIHRoaXMuX3R5cGUpIHRoaXMuX3R5cGUuVG9vbCA9IHRvb2w7CgoJCSh0aGlzLm5vZGVfQ29uZmlncygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCSh0aGlzLmNhcnJpZXJfRXZlbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJKHRoaXMuc2VuZGVyX0V2ZW50cygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCSh0aGlzLnJlY2lwaWVudF9FdmVudHMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQkodGhpcy5iYWNrdXBfTm9kZXMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQkodGhpcy5wYXJlbnRfTm9kZXMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQkodGhpcy5ub2RlX05vZGVfR3JvdXBfTWVtYmVycygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhZGRyZXNzICoqLwoJYWRkcmVzcyh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FkZHJlc3NfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhZGRyZXNzIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hZGRyZXNzICE9IHYpIHsKCQkJCXRoaXMuX2FkZHJlc3Nfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FkZHJlc3MgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWRkcmVzcyk7CgkJfQoJfQoKCWNsZWFyX2FkZHJlc3MoKSB7CgkJdGhpcy5fYWRkcmVzc19zZXQgPSBudWxsOwoJCXRoaXMuX2FkZHJlc3MgPSBudWxsOwoJCXRoaXMuX2FkZHJlc3NfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFkZHJlc3MgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBiYWNrdXAgKiovCgliYWNrdXAodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9iYWNrdXBfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJiYWNrdXAiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICdjNmIxNGI0ZS1lNTFkLTRkYmEtYWZiOC1hYzQ3OGY0YjRlNzYnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdOb2RlJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2JhY2t1cCcsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgImM2YjE0YjRlLWU1MWQtNGRiYS1hZmI4LWFjNDc4ZjRiNGU3NiIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJOb2RlIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2JhY2t1cCAhPSB2KSB7CgkJCQl0aGlzLl9iYWNrdXBfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdiYWNrdXAnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX2JhY2t1cCA/IHRoaXMuX2JhY2t1cC5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fYmFja3VwX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9iYWNrdXAgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYmFja3VwKTsKCQl9Cgl9CgoJY2xlYXJfYmFja3VwKCkgewoJCXRoaXMuX2JhY2t1cF9zZXQgPSBudWxsOwoJCXRoaXMuX2JhY2t1cCA9IG51bGw7CgkJdGhpcy5fYmFja3VwX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBiYWNrdXAgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBwYXJlbnQgKiovCglwYXJlbnQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9wYXJlbnRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJwYXJlbnQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICdjNmIxNGI0ZS1lNTFkLTRkYmEtYWZiOC1hYzQ3OGY0YjRlNzYnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdOb2RlJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3BhcmVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgImM2YjE0YjRlLWU1MWQtNGRiYS1hZmI4LWFjNDc4ZjRiNGU3NiIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJOb2RlIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3BhcmVudCAhPSB2KSB7CgkJCQl0aGlzLl9wYXJlbnRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdwYXJlbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX3BhcmVudCA/IHRoaXMuX3BhcmVudC5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fcGFyZW50X3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9wYXJlbnQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcGFyZW50KTsKCQl9Cgl9CgoJY2xlYXJfcGFyZW50KCkgewoJCXRoaXMuX3BhcmVudF9zZXQgPSBudWxsOwoJCXRoaXMuX3BhcmVudCA9IG51bGw7CgkJdGhpcy5fcGFyZW50X2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBwYXJlbnQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBwb3J0ICoqLwoJcG9ydCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3BvcnRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJwb3J0Iik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcG9ydCAhPSB2KSB7CgkJCQl0aGlzLl9wb3J0X3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9wb3J0ID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3BvcnQpOwoJCX0KCX0KCgljbGVhcl9wb3J0KCkgewoJCXRoaXMuX3BvcnRfc2V0ID0gbnVsbDsKCQl0aGlzLl9wb3J0ID0gbnVsbDsKCQl0aGlzLl9wb3J0X2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBwb3J0ICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb25saW5lICoqLwoJb25saW5lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb25saW5lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib25saW5lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vbmxpbmUgIT0gdikgewoJCQkJdGhpcy5fb25saW5lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vbmxpbmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29ubGluZSk7CgkJfQoJfQoKCWNsZWFyX29ubGluZSgpIHsKCQl0aGlzLl9vbmxpbmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9vbmxpbmUgPSBudWxsOwoJCXRoaXMuX29ubGluZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb25saW5lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc2VjdXJlICoqLwoJc2VjdXJlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fc2VjdXJlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgic2VjdXJlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fc2VjdXJlICE9IHYpIHsKCQkJCXRoaXMuX3NlY3VyZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fc2VjdXJlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9zZWN1cmUpOwoJCX0KCX0KCgljbGVhcl9zZWN1cmUoKSB7CgkJdGhpcy5fc2VjdXJlX3NldCA9IG51bGw7CgkJdGhpcy5fc2VjdXJlID0gbnVsbDsKCQl0aGlzLl9zZWN1cmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHNlY3VyZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHR5cGUgKiovCgl0eXBlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fdHlwZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInR5cGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc4ZjA1N2RjZS1iMjg2LTQ4YjctYTVlNy00ODVmN2JiZWY5ZDcnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdOb2RlIFR5cGUnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndHlwZScsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjhmMDU3ZGNlLWIyODYtNDhiNy1hNWU3LTQ4NWY3YmJlZjlkNyIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJOb2RlIFR5cGUiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fdHlwZSAhPSB2KSB7CgkJCQl0aGlzLl90eXBlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndHlwZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fdHlwZSA/IHRoaXMuX3R5cGUuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX3R5cGVfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX3R5cGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fdHlwZSk7CgkJfQoJfQoKCWNsZWFyX3R5cGUoKSB7CgkJdGhpcy5fdHlwZV9zZXQgPSBudWxsOwoJCXRoaXMuX3R5cGUgPSBudWxsOwoJCXRoaXMuX3R5cGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHR5cGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoJY29kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb2RlICE9IHYpIHsKCQkJCXRoaXMuX2NvZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29kZSk7CgkJfQoJfQoKCWNsZWFyX2NvZGUoKSB7CgkJdGhpcy5fY29kZV9zZXQgPSBudWxsOwoJCXRoaXMuX2NvZGUgPSBudWxsOwoJCXRoaXMuX2NvZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCglkYXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImRhdGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJyA/IF92IDogKG5ldyBEYXRlKF92KSk7CgkJCQlpZiAoaXNOYU4oX3YuZ2V0VGltZSgpKSkgX3YgPSBudWxsOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuRGF0ZVZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RhdGUgIT0gdikgewoJCQkJdGhpcy5fZGF0ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkRhdGVWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGF0ZSk7CgkJfQoJfQoKCWNsZWFyX2RhdGUoKSB7CgkJdGhpcy5fZGF0ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2RhdGUgPSBudWxsOwoJCXRoaXMuX2RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoJbmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9uYW1lICE9IHYpIHsKCQkJCXRoaXMuX25hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX25hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbmFtZSk7CgkJfQoJfQoKCWNsZWFyX25hbWUoKSB7CgkJdGhpcy5fbmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX25hbWUgPSBudWxsOwoJCXRoaXMuX25hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCglyZW1hcmsodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9yZW1hcmtfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZW1hcmsiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3JlbWFyayAhPSB2KSB7CgkJCQl0aGlzLl9yZW1hcmtfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3JlbWFyayA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcmVtYXJrKTsKCQl9Cgl9CgoJY2xlYXJfcmVtYXJrKCkgewoJCXRoaXMuX3JlbWFya19zZXQgPSBudWxsOwoJCXRoaXMuX3JlbWFyayA9IG51bGw7CgkJdGhpcy5fcmVtYXJrX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBub2RlX0NvbmZpZ3MgKiovCglub2RlX0NvbmZpZ3ModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX25vZGVfQ29uZmlnczsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnYmFkYWQ0MDQtMGEzZC00Yzg0LWJkNWYtOTU4YjA4M2UzNGQ5JyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdDb25maWcnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX25vZGVfc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnbm9kZV9Db25maWdzJywgJ0VudGl0eU9iamVjdCcsIDEsICJub2RlIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJDb25maWciKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdub2RlX0NvbmZpZ3MnLCAnRW50aXR5T2JqZWN0JywgMSwgIm5vZGUgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJDb25maWciKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3Yubm9kZSh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9ub2RlX0NvbmZpZ3MucHVzaCguLi52KTsKCQl0aGlzLl9ub2RlX0NvbmZpZ3Nfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX25vZGVfQ29uZmlnc19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfbm9kZV9Db25maWdzKCkgewoJCXRoaXMuX25vZGVfQ29uZmlnc19zZXQgPSBudWxsOwoJCXRoaXMuX25vZGVfQ29uZmlncyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX25vZGVfQ29uZmlnc19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5vZGVfQ29uZmlncyAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNhcnJpZXJfRXZlbnRzICoqLwoJY2Fycmllcl9FdmVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX2NhcnJpZXJfRXZlbnRzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICczNjllNDljMS1kYzc3LTRhMTktOWE5Mi1hNzU4ZDYxM2E3NWEnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0V2ZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9jYXJyaWVyX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NhcnJpZXJfRXZlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJjYXJyaWVyIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJFdmVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NhcnJpZXJfRXZlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJjYXJyaWVyIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiRXZlbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YuY2Fycmllcih0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9jYXJyaWVyX0V2ZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX2NhcnJpZXJfRXZlbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9jYXJyaWVyX0V2ZW50c19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfY2Fycmllcl9FdmVudHMoKSB7CgkJdGhpcy5fY2Fycmllcl9FdmVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9jYXJyaWVyX0V2ZW50cyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX2NhcnJpZXJfRXZlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY2Fycmllcl9FdmVudHMgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBzZW5kZXJfRXZlbnRzICoqLwoJc2VuZGVyX0V2ZW50cyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fc2VuZGVyX0V2ZW50czsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnMzY5ZTQ5YzEtZGM3Ny00YTE5LTlhOTItYTc1OGQ2MTNhNzVhJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdFdmVudCcpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fc2VuZGVyX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NlbmRlcl9FdmVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgInNlbmRlciBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiRXZlbnQiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZW5kZXJfRXZlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJzZW5kZXIgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJFdmVudCIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5zZW5kZXIodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fc2VuZGVyX0V2ZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX3NlbmRlcl9FdmVudHNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX3NlbmRlcl9FdmVudHNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX3NlbmRlcl9FdmVudHMoKSB7CgkJdGhpcy5fc2VuZGVyX0V2ZW50c19zZXQgPSBudWxsOwoJCXRoaXMuX3NlbmRlcl9FdmVudHMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9zZW5kZXJfRXZlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc2VuZGVyX0V2ZW50cyAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlY2lwaWVudF9FdmVudHMgKiovCglyZWNpcGllbnRfRXZlbnRzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9yZWNpcGllbnRfRXZlbnRzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICczNjllNDljMS1kYzc3LTRhMTktOWE5Mi1hNzU4ZDYxM2E3NWEnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0V2ZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9yZWNpcGllbnRfc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAncmVjaXBpZW50X0V2ZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAicmVjaXBpZW50IGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJFdmVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3JlY2lwaWVudF9FdmVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgInJlY2lwaWVudCBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkV2ZW50Iik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LnJlY2lwaWVudCh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9yZWNpcGllbnRfRXZlbnRzLnB1c2goLi4udik7CgkJdGhpcy5fcmVjaXBpZW50X0V2ZW50c19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fcmVjaXBpZW50X0V2ZW50c19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfcmVjaXBpZW50X0V2ZW50cygpIHsKCQl0aGlzLl9yZWNpcGllbnRfRXZlbnRzX3NldCA9IG51bGw7CgkJdGhpcy5fcmVjaXBpZW50X0V2ZW50cyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX3JlY2lwaWVudF9FdmVudHNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZWNpcGllbnRfRXZlbnRzICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYmFja3VwX05vZGVzICoqLwoJYmFja3VwX05vZGVzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9iYWNrdXBfTm9kZXM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2M2YjE0YjRlLWU1MWQtNGRiYS1hZmI4LWFjNDc4ZjRiNGU3NicgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnTm9kZScpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fYmFja3VwX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2JhY2t1cF9Ob2RlcycsICdFbnRpdHlPYmplY3QnLCAxLCAiYmFja3VwIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJOb2RlIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnYmFja3VwX05vZGVzJywgJ0VudGl0eU9iamVjdCcsIDEsICJiYWNrdXAgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJOb2RlIik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LmJhY2t1cCh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9iYWNrdXBfTm9kZXMucHVzaCguLi52KTsKCQl0aGlzLl9iYWNrdXBfTm9kZXNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX2JhY2t1cF9Ob2Rlc19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfYmFja3VwX05vZGVzKCkgewoJCXRoaXMuX2JhY2t1cF9Ob2Rlc19zZXQgPSBudWxsOwoJCXRoaXMuX2JhY2t1cF9Ob2RlcyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX2JhY2t1cF9Ob2Rlc19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGJhY2t1cF9Ob2RlcyAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHBhcmVudF9Ob2RlcyAqKi8KCXBhcmVudF9Ob2Rlcyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fcGFyZW50X05vZGVzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICdjNmIxNGI0ZS1lNTFkLTRkYmEtYWZiOC1hYzQ3OGY0YjRlNzYnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ05vZGUnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX3BhcmVudF9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdwYXJlbnRfTm9kZXMnLCAnRW50aXR5T2JqZWN0JywgMSwgInBhcmVudCBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiTm9kZSIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3BhcmVudF9Ob2RlcycsICdFbnRpdHlPYmplY3QnLCAxLCAicGFyZW50IG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiTm9kZSIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5wYXJlbnQodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fcGFyZW50X05vZGVzLnB1c2goLi4udik7CgkJdGhpcy5fcGFyZW50X05vZGVzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9wYXJlbnRfTm9kZXNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX3BhcmVudF9Ob2RlcygpIHsKCQl0aGlzLl9wYXJlbnRfTm9kZXNfc2V0ID0gbnVsbDsKCQl0aGlzLl9wYXJlbnRfTm9kZXMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9wYXJlbnRfTm9kZXNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBwYXJlbnRfTm9kZXMgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBub2RlX05vZGVfR3JvdXBfTWVtYmVycyAqKi8KCW5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9ub2RlX05vZGVfR3JvdXBfTWVtYmVyczsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnMjlmZjA1NzYtMTNmYS00Nzg0LTkxMGEtNGM1OWI0ODIxYzY4JyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdOb2RlIEdyb3VwIE1lbWJlcicpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fbm9kZV9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdub2RlX05vZGVfR3JvdXBfTWVtYmVycycsICdFbnRpdHlPYmplY3QnLCAxLCAibm9kZSBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiTm9kZV9Hcm91cF9NZW1iZXIiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdub2RlX05vZGVfR3JvdXBfTWVtYmVycycsICdFbnRpdHlPYmplY3QnLCAxLCAibm9kZSBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIk5vZGVfR3JvdXBfTWVtYmVyIik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92Lm5vZGUodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMucHVzaCguLi52KTsKCQl0aGlzLl9ub2RlX05vZGVfR3JvdXBfTWVtYmVyc19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKCkgewoJCXRoaXMuX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzX3NldCA9IG51bGw7CgkJdGhpcy5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9ub2RlX05vZGVfR3JvdXBfTWVtYmVyc19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fYWRkcmVzc19zZXQsCgoJCQl0aGlzLl9iYWNrdXBfc2V0LAoKCQkJdGhpcy5fcGFyZW50X3NldCwKCgkJCXRoaXMuX3BvcnRfc2V0LAoKCQkJdGhpcy5fb25saW5lX3NldCwKCgkJCXRoaXMuX3NlY3VyZV9zZXQsCgoJCQl0aGlzLl90eXBlX3NldCwKCgkJCXRoaXMuX2FjdGl2ZV9zZXQsCgoJCQl0aGlzLl9lbmFibGVkX3NldCwKCgkJCXRoaXMuX2NvZGVfc2V0LAoKCQkJdGhpcy5fb3JkZXJfc2V0LAoKCQkJdGhpcy5fZGF0ZV9zZXQsCgoJCQl0aGlzLl9uYW1lX3NldCwKCgkJCXRoaXMuX3JlbWFya19zZXQsCgoJCQl0aGlzLl9ub2RlX0NvbmZpZ3Nfc2V0LAoKCQkJdGhpcy5fY2Fycmllcl9FdmVudHNfc2V0LAoKCQkJdGhpcy5fc2VuZGVyX0V2ZW50c19zZXQsCgoJCQl0aGlzLl9yZWNpcGllbnRfRXZlbnRzX3NldCwKCgkJCXRoaXMuX2JhY2t1cF9Ob2Rlc19zZXQsCgoJCQl0aGlzLl9wYXJlbnRfTm9kZXNfc2V0LAoKCQkJdGhpcy5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnNfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fYWRkcmVzc19zZXQgPSB0aGlzLl9hZGRyZXNzX3NldDsKCQlyZXQuX2FkZHJlc3NfY29vcCA9IHRoaXMuX2FkZHJlc3NfY29vcDsKCQlyZXQuYWRkcmVzcyA9IHRoaXMuYWRkcmVzcygpID8gdGhpcy5hZGRyZXNzKCkgOiB0aGlzLmFkZHJlc3MoKTsKCgkJcmV0Ll9iYWNrdXBfc2V0ID0gdGhpcy5fYmFja3VwX3NldDsKCQlyZXQuX2JhY2t1cF9jb29wID0gdGhpcy5fYmFja3VwX2Nvb3A7CgkJcmV0LmJhY2t1cCA9IHRoaXMuYmFja3VwKCkgPyB0aGlzLmJhY2t1cCgpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLmJhY2t1cCgpOwoKCQlyZXQuX3BhcmVudF9zZXQgPSB0aGlzLl9wYXJlbnRfc2V0OwoJCXJldC5fcGFyZW50X2Nvb3AgPSB0aGlzLl9wYXJlbnRfY29vcDsKCQlyZXQucGFyZW50ID0gdGhpcy5wYXJlbnQoKSA/IHRoaXMucGFyZW50KCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMucGFyZW50KCk7CgoJCXJldC5fcG9ydF9zZXQgPSB0aGlzLl9wb3J0X3NldDsKCQlyZXQuX3BvcnRfY29vcCA9IHRoaXMuX3BvcnRfY29vcDsKCQlyZXQucG9ydCA9IHRoaXMucG9ydCgpID8gdGhpcy5wb3J0KCkgOiB0aGlzLnBvcnQoKTsKCgkJcmV0Ll9vbmxpbmVfc2V0ID0gdGhpcy5fb25saW5lX3NldDsKCQlyZXQuX29ubGluZV9jb29wID0gdGhpcy5fb25saW5lX2Nvb3A7CgkJcmV0Lm9ubGluZSA9IHRoaXMub25saW5lKCkgPyB0aGlzLm9ubGluZSgpIDogdGhpcy5vbmxpbmUoKTsKCgkJcmV0Ll9zZWN1cmVfc2V0ID0gdGhpcy5fc2VjdXJlX3NldDsKCQlyZXQuX3NlY3VyZV9jb29wID0gdGhpcy5fc2VjdXJlX2Nvb3A7CgkJcmV0LnNlY3VyZSA9IHRoaXMuc2VjdXJlKCkgPyB0aGlzLnNlY3VyZSgpIDogdGhpcy5zZWN1cmUoKTsKCgkJcmV0Ll90eXBlX3NldCA9IHRoaXMuX3R5cGVfc2V0OwoJCXJldC5fdHlwZV9jb29wID0gdGhpcy5fdHlwZV9jb29wOwoJCXJldC50eXBlID0gdGhpcy50eXBlKCkgPyB0aGlzLnR5cGUoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy50eXBlKCk7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5ub2RlX0NvbmZpZ3MgPSB0aGlzLm5vZGVfQ29uZmlncygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0LmNhcnJpZXJfRXZlbnRzID0gdGhpcy5jYXJyaWVyX0V2ZW50cygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0LnNlbmRlcl9FdmVudHMgPSB0aGlzLnNlbmRlcl9FdmVudHMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldC5yZWNpcGllbnRfRXZlbnRzID0gdGhpcy5yZWNpcGllbnRfRXZlbnRzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXQuYmFja3VwX05vZGVzID0gdGhpcy5iYWNrdXBfTm9kZXMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldC5wYXJlbnRfTm9kZXMgPSB0aGlzLnBhcmVudF9Ob2RlcygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0Lm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzID0gdGhpcy5ub2RlX05vZGVfR3JvdXBfTWVtYmVycygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkiYWRkcmVzcyI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhZGRyZXNzJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiYmFja3VwIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2JhY2t1cCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJInBhcmVudCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwYXJlbnQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJwb3J0IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3BvcnQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvbmxpbmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb25saW5lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkic2VjdXJlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3NlY3VyZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInR5cGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCW5vZGVfQ29uZmlnczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25vZGVfTm9kZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQljYXJyaWVyX0V2ZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhcnJpZXJfTm9kZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQlzZW5kZXJfRXZlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc2VuZGVyX05vZGVzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJcmVjaXBpZW50X0V2ZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlY2lwaWVudF9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCWJhY2t1cF9Ob2RlczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2JhY2t1cF9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCXBhcmVudF9Ob2RlczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3BhcmVudF9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCW5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbm9kZV9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJiYWNrdXAiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIGJhY2t1cCcsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuTm9kZSgpLmJhY2t1cF9Ob2Rlcyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInBhcmVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgcGFyZW50Jywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Ob2RlKCkucGFyZW50X05vZGVzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAidHlwZSIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgdHlwZScsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuTm9kZV9UeXBlKCkudHlwZV9Ob2Rlcyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpICE9ICdOb2RlJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQkJY2FzZSAidXBkYXRlQVBJIjogewoKCQkJCQlkYXRhLnNjcmlwdCA9IGRhdGEuc2NyaXB0ID8gZGF0YS5zY3JpcHQKCgkJCQkJCToKCQkJCQkJdW5kZWZpbmVkOwoKCQkJCQlkYXRhLmZpbGVuYW1lID0gZGF0YS5maWxlbmFtZSA/IGRhdGEuZmlsZW5hbWUKCgkJCQkJCToKCQkJCQkJdW5kZWZpbmVkOwoKCQkJCQlicmVhazsKCQkJCX0KCgkJCQljYXNlICJpbml0IjogewoKCQkJCQlkYXRhLm9ubGluZSA9IGRhdGEub25saW5lID8gZGF0YS5vbmxpbmUKCgkJCQkJCToKCQkJCQkJdW5kZWZpbmVkOwoKCQkJCQlkYXRhLmNvZGUgPSBkYXRhLmNvZGUgPyBkYXRhLmNvZGUKCgkJCQkJCToKCQkJCQkJdW5kZWZpbmVkOwoKCQkJCQlkYXRhLnVpZCA9IGRhdGEudWlkID8gZGF0YS51aWQKCgkJCQkJCToKCQkJCQkJdW5kZWZpbmVkOwoKCQkJCQlicmVhazsKCQkJCX0KCgkJCQljYXNlICJkYXJ0QVBJIjogewoKCQkJCQlkYXRhLnNjb3BlID0gZGF0YS5zY29wZSA/IGRhdGEuc2NvcGUKCgkJCQkJCToKCQkJCQkJdW5kZWZpbmVkOwoKCQkJCQlicmVhazsKCQkJCX0KCgkJCQljYXNlICJyZXN0YXJ0IjogewoKCQkJCQlicmVhazsKCQkJCX0KCgkJCQljYXNlICJzdGF0dXMiOiB7CgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9Ob2RlLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7CgoJCQl9CgoJCQkvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8KCgkJCWxldCB2ID0gdW5kZWZpbmVkOwoJCQl0cnkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke21ldGhvZH1gKTsKCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQlsZXQgX2lkID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgZGF0YSwgbWV0aG9kLCB7fSk7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIHsKCQkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKGRhdGEpOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSBkYXRhLl9fdGhpcy5jb2RlIHx8IGRhdGEuaWQgfHwgZGF0YS5JRDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCQlpZiAoZGF0YS5JZCAmJiBkYXRhLklkID09IGRhdGEuSWQpIHsKCQkJCQkJX2lkID0gZGF0YS5JZDsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5FbnRpdHlDbGFzcykgewoJCQkJCQlfaWQgPSBkYXRhLkVudGl0eUNsYXNzLklkIHx8IGRhdGEuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJjNmIxNGI0ZS1lNTFkLTRkYmEtYWZiOC1hYzQ3OGY0YjRlNzYiIHx8ICJOVUxMIjsKCQkJCQl9CgkJCQl9CgoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGUgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGUgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVbbWV0aG9kXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVttZXRob2RdIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlW21ldGhvZF1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVttZXRob2RdW19pZF0gfHwge307CgoJCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKHt9LCB7CgkJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJCX0pOwoKCQkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVbbWV0aG9kXVtfaWRdW19oYXNoXTsKCQkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogNSkpIHsKCQkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIG1ldGhvZCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCQl2LnJldXNlZCsrOwoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0KCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSk7CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVbbWV0aG9kXVtfaWRdW19oYXNoXSA9IHsKCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeSh7fSksCgkJCQkJb2JqOiBkYXRhLAoJCQkJCXJldXNlZDogMCwKCQkJCX07CgkJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZGF0YSwgbWV0aG9kLCB7fSwgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBUcmlnZ2VycmluZyAke21ldGhvZH0gdG8gJHtuLmNvZGUoKX0gJHtKU09OLnN0cmluZ2lmeShkYXRhLG51bGwsNCl9YCk7CgoJCQlsZXQgZXYgPSBuZXcgc2FsZXNub3cuRXZlbnQoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSh0aGlzLl9fY29uZmlnKCdldmVudCcpIHx8ICdzYWxlc25vdy5FdmVudCcpLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnJlY2lwaWVudChuKS5tZXRob2QobWV0aG9kKS5jbGFzc05hbWUoJ05vZGUnKS5zZW5kZXIoc2FsZXNub3cuX25vZGUpLmNhcnJpZXIoc2FsZXNub3cuX25vZGUpLnBheWxvYWQoZGF0YSk7CgkJCWlmIChldmVudCkgewoJCQkJaWYgKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOwoJCQkJaWYgKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOwoJCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJaWYgKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOwoJCQl9CgkJCXJldCA9IGF3YWl0IGV2LnRyaWdnZXIoKTsKCgkJCWlmICh0eXBlb2YocmV0KSA9PT0gInN0cmluZyIpIHsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCX0KCQkJcmV0dXJuIHJldDsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJ1cGRhdGVBUEkiOiB7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImluaXQiOiB7CgoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuTm9kZShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiZGFydEFQSSI6IHsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAicmVzdGFydCI6IHsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAic3RhdHVzIjogewoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5Ob2RlKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5Ob2RlKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJ1cGRhdGVBUEkiOiB7CgoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zY3JpcHQpOwoKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZmlsZW5hbWUpOwoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJpbml0IjogewoKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub25saW5lKTsKCgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmNvZGUpOwoKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMudWlkKTsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiZGFydEFQSSI6IHsKCgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnNjb3BlKTsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAicmVzdGFydCI6IHsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAic3RhdHVzIjogewoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBOb2RlLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgTm9kZS5faW52b2tlOiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLAoJCQkJCSdvYmonOiBvYmoKCQkJCX0KCQkJfTsKCQl9IGVsc2UgewoJCQlyZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOwoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJaWYgKGZhbHNlICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQlyZXQgPSB7CgkJCQkJX19leGNlcHRpb246IHsKCQkJCQkJJy00JzogIlVuY29tbWl0dGVkIHRyYW5zYWN0aW9uczogIiArIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uc3Fscy5sZW5ndGgsCgkJCQkJCSdvYmonOiBvYmoKCQkJCQl9CgkJCQl9CgkJCX0KCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQl9CgoJCWlmIChyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbikgewoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0ge307CgkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCXJldCA9IHJldC5tYXAociA9PiB7CgkJCQkJaWYgKHIgJiYgci5fdG9Eb2N1bWVudCkgewoJCQkJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlLl90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGUuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIk5vZGUiKTsKCgl9CgoJX19zeW5jX29uKGQpIHsKCQl0aGlzLl9fX3N5bmNfb24gPSB0aGlzLl9fX3N5bmNfb24gfHwge307CgoJCWlmIChkKSB7CgkJCXRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV0gPSBkOwoKCQkJaWYgKHRoaXMuX2JhY2t1cF9zZXQgJiYgdGhpcy5iYWNrdXAoKSkgdGhpcy5iYWNrdXAoKS5fX3N5bmNfb24oZCk7CgoJCQlpZiAodGhpcy5fcGFyZW50X3NldCAmJiB0aGlzLnBhcmVudCgpKSB0aGlzLnBhcmVudCgpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl90eXBlX3NldCAmJiB0aGlzLnR5cGUoKSkgdGhpcy50eXBlKCkuX19zeW5jX29uKGQpOwoKCQkJLy8gdGhpcy5ub2RlX05vZGVzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCS8vIHRoaXMuY2Fycmllcl9Ob2RlcygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQkvLyB0aGlzLnNlbmRlcl9Ob2RlcygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQkvLyB0aGlzLnJlY2lwaWVudF9Ob2RlcygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQkvLyB0aGlzLmJhY2t1cF9Ob2RlcygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQkvLyB0aGlzLnBhcmVudF9Ob2RlcygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQkvLyB0aGlzLm5vZGVfTm9kZXMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Ob2RlKHRoaXMuSWQpCgoJCQkuYWRkcmVzcyh0aGlzLmFkZHJlc3MoKSwgdGhpcy5fYWRkcmVzc19jb29wKQoKCQkJLmJhY2t1cCh0aGlzLmJhY2t1cCgpLCB0aGlzLl9iYWNrdXBfY29vcCkKCgkJCS5wYXJlbnQodGhpcy5wYXJlbnQoKSwgdGhpcy5fcGFyZW50X2Nvb3ApCgoJCQkucG9ydCh0aGlzLnBvcnQoKSwgdGhpcy5fcG9ydF9jb29wKQoKCQkJLm9ubGluZSh0aGlzLm9ubGluZSgpLCB0aGlzLl9vbmxpbmVfY29vcCkKCgkJCS5zZWN1cmUodGhpcy5zZWN1cmUoKSwgdGhpcy5fc2VjdXJlX2Nvb3ApCgoJCQkudHlwZSh0aGlzLnR5cGUoKSwgdGhpcy5fdHlwZV9jb29wKQoKCQkJLmFjdGl2ZSh0aGlzLmFjdGl2ZSgpLCB0aGlzLl9hY3RpdmVfY29vcCkKCgkJCS5lbmFibGVkKHRoaXMuZW5hYmxlZCgpLCB0aGlzLl9lbmFibGVkX2Nvb3ApCgoJCQkuY29kZSh0aGlzLmNvZGUoKSwgdGhpcy5fY29kZV9jb29wKQoKCQkJLm9yZGVyKHRoaXMub3JkZXIoKSwgdGhpcy5fb3JkZXJfY29vcCkKCgkJCS5kYXRlKHRoaXMuZGF0ZSgpLCB0aGlzLl9kYXRlX2Nvb3ApCgoJCQkubmFtZSh0aGlzLm5hbWUoKSwgdGhpcy5fbmFtZV9jb29wKQoKCQkJLnJlbWFyayh0aGlzLnJlbWFyaygpLCB0aGlzLl9yZW1hcmtfY29vcCkKCgkJCS5ub2RlX0NvbmZpZ3ModGhpcy5ub2RlX0NvbmZpZ3MoKSwgdGhpcy5fbm9kZV9Db25maWdzX2Nvb3ApCgoJCQkuY2Fycmllcl9FdmVudHModGhpcy5jYXJyaWVyX0V2ZW50cygpLCB0aGlzLl9jYXJyaWVyX0V2ZW50c19jb29wKQoKCQkJLnNlbmRlcl9FdmVudHModGhpcy5zZW5kZXJfRXZlbnRzKCksIHRoaXMuX3NlbmRlcl9FdmVudHNfY29vcCkKCgkJCS5yZWNpcGllbnRfRXZlbnRzKHRoaXMucmVjaXBpZW50X0V2ZW50cygpLCB0aGlzLl9yZWNpcGllbnRfRXZlbnRzX2Nvb3ApCgoJCQkuYmFja3VwX05vZGVzKHRoaXMuYmFja3VwX05vZGVzKCksIHRoaXMuX2JhY2t1cF9Ob2Rlc19jb29wKQoKCQkJLnBhcmVudF9Ob2Rlcyh0aGlzLnBhcmVudF9Ob2RlcygpLCB0aGlzLl9wYXJlbnRfTm9kZXNfY29vcCkKCgkJCS5ub2RlX05vZGVfR3JvdXBfTWVtYmVycyh0aGlzLm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKCksIHRoaXMuX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQlvYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ05vZGUnOwoJCXRvb2wgPSB0b29sIHx8IHRoaXMuVG9vbDsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJOb2RlIjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCQkJCXJldCA9IHJldC50b0xvd2VyQ2FzZSgpOwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCQl0cnkgewoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgPyAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gb3B0aW9ucy50b29sIHx8IHQgPT0gb3B0aW9ucy50b29sKSA6IHRoaXMuVG9vbDsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sIHx8IHt9OwoKCQkJbGV0IG5JRCA9IHNhbGVzbm93Ll9ub2RlID8gc2FsZXNub3cuX25vZGUuY29kZSgpIDogImRlZmF1bHQiOwoKCQkJbGV0IHJldCA9IG51bGxWYWx1ZTsKCQkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0ID0gbnVsbDsKCgkJCS8vIHRvb2xfQ29uZmlnczogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBkb25lCgkJCWxldCB0Y29uZiA9IChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiBjLm5vZGUgJiYgYy5ub2RlLmNvZGUgPT0gbklEKS5jb25jYXQoKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmICFjLm5vZGUpKTsKCQkJaWYgKHRjb25mLmxlbmd0aCkgewoJCQkJcmV0ID0gdGNvbmZbMF0udmFsdWU7CgkJCQl0cnkgewoJCQkJCXJldCA9IEpTT04ucGFyc2UocmV0KTsKCQkJCX0gY2F0Y2ggKGpleCkge30KCQkJfQoKCQkJLy8gbW9kZWwgQ29uZmlnOiBDb25maWcgaXMgY2xhc3MgbGV2ZWwsIG5vZGUgbm90IHBvc3NpYmxlIC0gcGVuZGluZwoJCQlsZXQgbWNvbmYgPSB0aGlzLkNvbmZpZyA/IHRoaXMuQ29uZmlnW25dIDogdW5kZWZpbmVkOwoJCQlpZiAodHlwZW9mKG1jb25mKSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IG1jb25mOwoKCQkJLy8gY29tbWFuZCBsaW5lOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiBnbG9iYWwubWluaW1pc3QpIHsKCQkJCXJldCA9IGdsb2JhbC5taW5pbWlzdChwcm9jZXNzLmFyZ3Yuc2xpY2UoMikpW25dIHx8IHJldDsKCQkJfQoKCQkJLy8gcmVxdWVzdDogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCXJldCA9IHRoaXMuJF9SRVFVRVNUKG4pIHx8IHJldDsKCgkJCWlmIChvcHRpb25zLm5ld1ZhbHVlKSB7CgkJCQlsZXQgdGMgPSB0Y29uZi5sZW5ndGggPyB0Y29uZlswXSA6IHt9OwoJCQkJdGMubm9kZSA9IHsKCQkJCQljb2RlOiBvcHRpb25zLm5vZGUuY29kZSgpCgkJCQl9OwoJCQkJdGMudmFsdWUgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQkJdGMubmFtZSA9IG47CgkJCQlpZiAoIXRjb25mLmxlbmd0aCkgewoJCQkJCW9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MucHVzaCh0Yyk7CgkJCQl9CgkJCQlyZXQgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQl9CgoJCQkvLyBjb25maWcgcmVwbGFjZW1lbnQKCQkJaWYgKHR5cGVvZihyZXQpID09PSAnc3RyaW5nJykocmV0Lm1hdGNoKG5ldyBSZWdFeHAoYHt7KFtefV0rKX19YCwgImciKSkgfHwgW10pLmZvckVhY2gobSA9PiByZXQgPSByZXQucmVwbGFjZShtLCB0aGlzLl9fY29uZmlnKG0ucmVwbGFjZSgne3snLCAnJykucmVwbGFjZSgnfX0nLCAnJyksIG51bGwsIG9wdGlvbnMpKSk7CgoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fY29uZmlnJywgJ0VudGl0eU9iamVjdCcsIDEsIG4sIG51bGxWYWx1ZSwgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncywgZXgpOwoJCX0KCX0KCgkvKioKCSAqIFN1bW1hcnkuIHVwZGF0ZUFQSS4KCSAqCgkgKiBEZXNjcmlwdGlvbi4gLgoJICoKCSAqIEBzaW5jZSAgICAgIHgueC54CgkgKiBAZGVwcmVjYXRlZCB4LngueCBVc2UgbmV3X2Z1bmN0aW9uX25hbWUoKSBpbnN0ZWFkLgoJICogQGFjY2VzcyAgICAgcHVibGljCgkgKgoJICogQGNsYXNzCgkgKiBAYXVnbWVudHMgcGFyZW50CgkgKiBAbWl4ZXMgICAgbWl4aW4KCSAqCgkgKiBAYWxpYXMgICAgcmVhbE5hbWUKCSAqIEBtZW1iZXJvZiBuYW1lc3BhY2UKCSAqCgkgKiBAc2VlICBGdW5jdGlvbi9jbGFzcyByZWxpZWQgb24KCSAqIEBsaW5rIFVSTAoJICogQGdsb2JhbAoJICoKCSAqIEBmaXJlcyAgIGV2ZW50TmFtZQoJICogQGZpcmVzICAgY2xhc3NOYW1lI2V2ZW50TmFtZQoJICogQGxpc3RlbnMgZXZlbnQ6ZXZlbnROYW1lCgkgKiBAbGlzdGVucyBjbGFzc05hbWV+ZXZlbnQ6ZXZlbnROYW1lCgkgKiBAcGFyYW0ge3R5cGV9ICAgdmFyICAgICAgICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyXSAgICAgICAgIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXI9ZGVmYXVsdF0gRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUgd2l0aCBkZWZhdWx0IHZhcmlhYmxlLgoJICogQHBhcmFtIHtPYmplY3R9IG9iamVjdFZhciAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgb2JqZWN0VmFyLmtleSBEZXNjcmlwdGlvbiBvZiBhIGtleSBpbiB0aGUgb2JqZWN0VmFyIHBhcmFtZXRlci4KCSAqCgkgKiBAeWllbGQge3R5cGV9IFlpZWxkZWQgdmFsdWUgZGVzY3JpcHRpb24uCgkgKgoJICogQHJldHVybiB7dHlwZX0gUmV0dXJuIHZhbHVlIGRlc2NyaXB0aW9uLgoJICovCglhc3luYyB1cGRhdGVBUEkoc2NyaXB0LCBmaWxlbmFtZSkgewoKCQlsZXQgYW5zd2VyID0gZmFsc2U7CgoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZUFQSSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGVBUEkiLCBfbm9kZSwgc2NyaXB0LCBmaWxlbmFtZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGVBUEkiLCBzY3JpcHQsIGZpbGVuYW1lKSA9PiB7CgoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZS51cGRhdGVBUEknKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQkJInNjcmlwdC1yZXF1aXJlZCI6ICgoc2NyaXB0LCBmaWxlbmFtZSkgPT4gewoKCQkJCQlsZXQgYW5zd2VyID0KCgkJCQkJCXR5cGVvZihzY3JpcHQpID09PSAndW5kZWZpbmVkJwoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZUFQSScsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgInNjcmlwdC1yZXF1aXJlZCIsIGFuc3dlcik7CgkJCQkJcmV0dXJuIGFuc3dlcjsKCQkJCX0pKHNjcmlwdCwgZmlsZW5hbWUpID8gKCdzY3JpcHQgaXMgYSByZXF1aXJlZCBQYXJhbWV0ZXInIHx8ICdWYWxpZGF0aW9uIEVycm9yJykgOiAnJywKCgkJCX07CgkJCU9iamVjdC5rZXlzKGVycm9ycykuZmlsdGVyKGsgPT4gIWVycm9yc1trXSkuZm9yRWFjaChrID0+IGRlbGV0ZSBlcnJvcnNba10pOwoJCQlpZiAoT2JqZWN0LmtleXMoZXJyb3JzKS5sZW5ndGgpIHsKCQkJCU9iamVjdC5rZXlzKGVycm9ycykuZmlsdGVyKGsgPT4gay5zdGFydHNXaXRoKCctJykpLmZvckVhY2goayA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlQVBJJywgJ0VudGl0eU9iamVjdCcsIDAsIHsKCQkJCQkJW2tdOiBlcnJvcnNba10KCQkJCQl9KTsKCQkJCQlkZWxldGUgZXJyb3JzW2tdOwoJCQkJfSk7CgkJCQlpZiAoT2JqZWN0LnZhbHVlcyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJCXJldHVybiB7CgkJCQkJCV9fZXhjZXB0aW9uOiBlcnJvcnMsCgkJCQkJfTsKCQkJCX0KCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAidW5kZWZpbmVkIikgewoJCQkJLy8gbm9kZWpzCgkJCQlyZXR1cm4gYXdhaXQgZ2xvYmFsLnV0aWwucHJvbWlzaWZ5KGdsb2JhbC5mcy53cml0ZUZpbGUpKGZpbGVuYW1lLCB0aGlzLl9hdG9iKHNjcmlwdCkpOwoJCQl9IGVsc2UgewoJCQkJbG9nKCJCcm93c2VycyBkbyBub3Qgd3JpdGUgdG8gZmlsZXMgZm9yIG5vdyIpOwoJCQl9CgkJCXJldHVybiB0cnVlOwoKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdLAoJCQlzY3JpcHQ6IHNjcmlwdCwKCQkJZmlsZW5hbWU6IGZpbGVuYW1lCgkJfSk7CgoJCS8vIHRha2Ugb3V0IHRoZSBpbnZhbGlkIG5vZGUgcmVzdWx0cwoJCXJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIgJiYgci5yZXQpOwoKCQkvLyBoYXMgYW55IG5vZGUgZ2VuZXJhdGVkIGEgdmFsaWRhdGlvbiBleGNlcHRpb24/CgkJbGV0IF9fZXggPSByZXN1bHRzLmZpbmQociA9PiByLnJldC5fX2V4Y2VwdGlvbik7CgkJaWYgKF9fZXgpIHJldHVybiBfX2V4LnJldDsKCgkJcmV0dXJuIHJlc3VsdHMubGVuZ3RoID8gcmVzdWx0c1swXS5yZXQgOiBudWxsOwoKCX0KCgkvKioKCSAqIFN1bW1hcnkuIGluaXQuCgkgKgoJICogRGVzY3JpcHRpb24uIC4KCSAqCgkgKiBAc2luY2UgICAgICB4LngueAoJICogQGRlcHJlY2F0ZWQgeC54LnggVXNlIG5ld19mdW5jdGlvbl9uYW1lKCkgaW5zdGVhZC4KCSAqIEBhY2Nlc3MgICAgIHB1YmxpYwoJICoKCSAqIEBjbGFzcwoJICogQGF1Z21lbnRzIHBhcmVudAoJICogQG1peGVzICAgIG1peGluCgkgKgoJICogQGFsaWFzICAgIHJlYWxOYW1lCgkgKiBAbWVtYmVyb2YgbmFtZXNwYWNlCgkgKgoJICogQHNlZSAgRnVuY3Rpb24vY2xhc3MgcmVsaWVkIG9uCgkgKiBAbGluayBVUkwKCSAqIEBnbG9iYWwKCSAqCgkgKiBAZmlyZXMgICBldmVudE5hbWUKCSAqIEBmaXJlcyAgIGNsYXNzTmFtZSNldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGV2ZW50OmV2ZW50TmFtZQoJICogQGxpc3RlbnMgY2xhc3NOYW1lfmV2ZW50OmV2ZW50TmFtZQoJICogQHBhcmFtIHt0eXBlfSAgIHZhciAgICAgICAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcl0gICAgICAgICBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyPWRlZmF1bHRdIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlIHdpdGggZGVmYXVsdCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3RWYXIgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIG9iamVjdFZhci5rZXkgRGVzY3JpcHRpb24gb2YgYSBrZXkgaW4gdGhlIG9iamVjdFZhciBwYXJhbWV0ZXIuCgkgKgoJICogQHlpZWxkIHt0eXBlfSBZaWVsZGVkIHZhbHVlIGRlc2NyaXB0aW9uLgoJICoKCSAqIEByZXR1cm4ge3R5cGV9IFJldHVybiB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqLwoJYXN5bmMgaW5pdChvbmxpbmUsIGNvZGUsIHVpZCkgewoKCQlsZXQgYW5zd2VyID0gbmV3IHNhbGVzbm93Lk5vZGUoKTsKCgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5pdCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbml0IiwgX25vZGUsIG9ubGluZSwgY29kZSwgdWlkKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbml0Iiwgb25saW5lLCBjb2RlLCB1aWQpID0+IHsKCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlLmluaXQnKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luaXQnLCAnRW50aXR5T2JqZWN0JywgMCwgewoJCQkJCQlba106IGVycm9yc1trXQoJCQkJCX0pOwoJCQkJCWRlbGV0ZSBlcnJvcnNba107CgkJCQl9KTsKCQkJCWlmIChPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIHsKCQkJCQkJX19leGNlcHRpb246IGVycm9ycywKCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBkZWZhdWx0cwoJCQlvbmxpbmUgPSBvbmxpbmUgfHwgdGhpcy5fX2NvbmZpZygnaW5pdC5sb29wJyk7CgkJCW9TY29wZS5fbm9kZXMgPSBvU2NvcGUuX25vZGVzIHx8IHt9OwoKCQkJLy8gY29kZSBhbmQgdHlwZSBkZXRlY3Rpb24KCQkJbGV0IG4gPSBudWxsOwoJCQlpZiAoIXVpZCAmJiBvU2NvcGUuX25vZGUpIHsKCQkJCW4gPSBvU2NvcGUuX25vZGU7CgkJCX0gZWxzZSBpZiAodWlkICYmIHR5cGVvZih1aWQpID09PSAnc3RyaW5nJykgewoJCQkJbiA9IG9TY29wZS5fbm9kZXNbdWlkXTsKCQkJfQoKCQkJbGV0IGlwID0gdGhpcy5pcEFkZHJlc3MoKTsKCQkJaXAgPSBbIjE4Mi4xNjguNzAuODIiLCAiMTkyLjE2OC4xLjI1MyJdLmluZGV4T2YoaXApID49IDAgPyAiMTk1LjExMi4yMTUuMjE4IiA6IGlwOwoJCQluID0gbiB8fCBuZXcgb1Njb3BlLk5vZGUoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5zZWN1cmUodGhpcy5zZWN1cmUoKSkuY29kZSh0aGlzLl9fY29uZmlnKCdDb2RlJykgfHwgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyA/IGdsb2JhbC5tYWNoaW5laWQubWFjaGluZUlkU3luYyh0cnVlKSA6IG51bGwpIHx8IHRoaXMuX19jb25maWcoJ3Rlc3QuY29kZScpIHx8ICgodHlwZW9mKHVpZCkgPT09ICdzdHJpbmcnKSA/IHVpZCA6IG51bGwpIHx8ICgodHlwZW9mKHV1aWQpICE9PSAidW5kZWZpbmVkIikgPyAoIC8qdWlkID0gKi8gdXVpZCgpKSA6IG51bGwpIHx8ICgxMCAqIE1hdGgucmFuZG9tKCkpKS50eXBlKG5ldyBvU2NvcGUuTm9kZV9UeXBlKCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkubmFtZSh0eXBlb2YoZ2xvYmFsKSAhPT0gInVuZGVmaW5lZCIgPyAiTm9kZUpTIiA6ICJCcm93c2VyIikuZHluYW1pYyh0eXBlb2YoZ2xvYmFsKSA9PT0gInVuZGVmaW5lZCIpKS5wb3J0KHRoaXMuX19jb25maWcoJ3BvcnQnKSB8fCAzMDAwKS5hZGRyZXNzKGlwKTsKCgkJCWlmIChuLnR5cGUoKS5keW5hbWljKCkpIHsKCQkJCS8vIHdpdGggZHluYW1pYyBub2RlcyB3ZSBuZWVkIHRvIGNoZWNrIGlmIHRoZXJlIGlzIGEgbm9kZSB0aGF0IGlzIG5vIGxvbmdlciBvbmxpbmUsIGFuZCBiaW5kIHRoaXMgaW5zdGFuY2UgdG8gaXQgKG5vZGUgcmVjeWNsaW5nKQoJCQkJLy8gYSBkeW5hbWljIG5vZGUgaXMgbm8gbG9uZ2VyIG9ubGluZSBpZiBpdCBmYWlscyB0byByZXBvcnQgaXRzIGxhc3Qgb25saW5lIHByZXNlbmNlIGFmdGVyIDUgbWludXRlcyA/Pz8KCQkJCS8vIGdldCBhIHBvb2wgb2YgYWxsIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBvbmxpbmUsIGJpbmQgdG8gdGhlIG9sZGVzdCBvbmUKCgkJCQlsZXQgZGVhZE5vZGVzID0gYXdhaXQgbmV3IG9TY29wZS5Ob2RlKCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuY29kZShudWxsLCAiIT0iKS50eXBlKG4udHlwZSgpKS5zZWN1cmUobi5zZWN1cmUoKSkub25saW5lKG5ldyBEYXRlKHRoaXMuc3IoKS5zZXJ2ZXJEYXRlKCkgLSAxMCAqIChvbmxpbmUgfHwgNSkgKiA2MDAwMCksICI8PSIpLmZpbmRBbGwoKTsKCgkJCQlpZiAoZGVhZE5vZGVzLmxlbmd0aCkgewoJCQkJCWRlYWROb2Rlcy5zb3J0KChhLCBiKSA9PiBhLl9vbmxpbmUgLSBiLl9vbmxpbmUpOwoJCQkJCWRlYWROb2RlcyA9IGRlYWROb2Rlcy5maWx0ZXIoZG4gPT4gIW9TY29wZS5fbm9kZXNbZG4uY29kZSgpXSk7CgkJCQkJbiA9IGRlYWROb2Rlc1swXTsKCQkJCQlsb2coIlJldXNpbmcgRGVhZCBOb2RlICIgKyBuLmNvZGUoKSk7CgkJCQl9CgkJCX0KCgkJCWlmICh1aWQpIHsKCQkJCW9TY29wZS5fbm9kZXNbdWlkXSA9IG9TY29wZS5fbm9kZXNbdWlkXSB8fCBuOwoJCQkJbiA9IG9TY29wZS5fbm9kZXNbdWlkXTsKCQkJfQoKCQkJaWYgKE9iamVjdC5rZXlzKG9TY29wZS5fbm9kZXMpLmxlbmd0aCA8PSAxKSB7CgkJCQlvU2NvcGUuX25vZGUgPSBuOwoJCQl9IGVsc2UgewoJCQkJZGVsZXRlIG9TY29wZS5fbm9kZTsKCQkJfQoKCQkJb1Njb3BlLm5vZGVJbml0Q2FsbHMgPSBvU2NvcGUubm9kZUluaXRDYWxscyB8fCAwOwoKCQkJdGhpcy5zZXRJbnRlcnZhbChhc3luYyAoc2NvcGUsIHVpZCwgb25saW5lKSA9PiB7CgkJCQlzY29wZS5ub2RlSW5pdENhbGxzKysKCQkJCWxvZygiQ2FsbCAjIiArIHNjb3BlLm5vZGVJbml0Q2FsbHMgKyAiIG9mICIgKyB0aGlzLl9fY29uZmlnKCdpbml0LmVuZHMnKSk7CgoJCQkJbGV0IF9uID0gbnVsbDsKCQkJCWlmICh1aWQgJiYgc2NvcGUuX25vZGVzKSB7CgkJCQkJX24gPSBzY29wZS5fbm9kZXNbdWlkXTsKCQkJCX0KCgkJCQlfbiA9IF9uIHx8IHNjb3BlLl9ub2RlOwoKCQkJCWlmIChfbikgewoJCQkJCWxldCBwSVAgPSBfbi5fX2NvbmZpZygnbm9EZXRlY3QnKSA/IG51bGwgOiBfbi5fX2NvbmZpZygiZGV0ZWN0UGFyZW50LklQIik7CgoJCQkJCWlmIChwSVApIHsKCQkJCQkJLy8gbm9kZSBoYXMgYSBwcmUtY29uZmlndXJlZCBwYXJlbnQKCQkJCQkJX24ucGFyZW50KG5ldyBvU2NvcGUuTm9kZSgpLmFkZHJlc3MocElQKS5wb3J0KHRoaXMuX19jb25maWcoJ3BvcnQnKSB8fCAzMDAwKS5jb2RlKF9uLl9fY29uZmlnKCdkZXRlY3RQYXJlbnQuY29kZScpKS50eXBlKG5ldyBvU2NvcGUuTm9kZV9UeXBlKCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkubmFtZSgiTm9kZUpTIikpLnNlY3VyZShfbi5zZWN1cmUoKSkpOwoJCQkJCQlhd2FpdCBfbi5fYXV0aG9yaXplKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJLy8gbm9kZSBoYXMgbm8gcGFyZW50LCBidXQgYSBwYXJlbnQgcXVlcnkhCgkJCQkJCV9uLnBhcmVudChuZXcgb1Njb3BlLk5vZGUoKS50eXBlKG5ldyBvU2NvcGUuTm9kZV9UeXBlKCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkubmFtZSgnTm9kZUpTJykpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLm9ubGluZShuZXcgRGF0ZSh0aGlzLnNyKCkuc2VydmVyRGF0ZSgpIC0gKG9ubGluZSB8fCA1KSAqIDYwMDAwKSwgIj49IikuY29kZShfbi5fY29kZSwgJyE9JykuYWRkcmVzcygnJywgJyE9JykucG9ydCgnJywgJyE9JykucGFyZW50KG51bGwpKTsKCQkJCQl9CgoJCQkJCWlmICh0aGlzLl9sb2FkVG9vbHMpIGF3YWl0IHRoaXMuX2xvYWRUb29scyh0aGlzLl9fY29uZmlnKCd0b29scy5zdG9yZScsIHRydWUpKTsKCgkJCQkJaWYgKG9TY29wZS5FdmVudCkgewoJCQkJCQlpZiAodGhpcy5fX2NvbmZpZygnZXZlbnQucG9sbGluZy5kaXNhYmxlZCcsIHRydWUpKSB7CgkJCQkJCQlhd2FpdCBuZXcgb1Njb3BlLkV2ZW50KCkubmFtZSh0aGlzLl9fY29uZmlnKCdldmVudCcpIHx8IGAke3RoaXMuU2NvcGV9LkV2ZW50YCkubGlzdGVuKF9uKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWxvZygiUG9sbGluZyBFdmVudHM6ICIgKyAodGhpcy5Ub29sLnR5cGUgPyB0aGlzLlRvb2wudHlwZS5uYW1lIDogJycpKTsKCgkJCQkJCQlsZXQgbWUgPSBuZXcgb1Njb3BlLk5vZGUoKS5jb2RlKG9TY29wZS5fbm9kZS5jb2RlKCkpOwoJCQkJCQkJbGV0IG5tZSA9IG5ldyBvU2NvcGUuTm9kZSgpLmNvZGUob1Njb3BlLl9ub2RlLmNvZGUoKSwgJyE9Jyk7CgkJCQkJCQlsZXQgZXYgPSBuZXcgb1Njb3BlLkV2ZW50KCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuc2VuZGVyKG1lLCAnTk9UIElOJykucmVjaXBpZW50KG1lKS5yZXNwb25zZVRvKG51bGwpOwoJCQkJCQkJbGV0IG5ldiA9IG5ldyBvU2NvcGUuRXZlbnQoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5zZW5kZXIobWUpLnJlY2lwaWVudChtZSwgJ05PVCBJTicpLnJlc3BvbnNlVG8obnVsbCwgJ05PVCBJTicpOwoJCQkJCQkJbGV0IHFldiA9IGV2LnJlc3BvbnNlVG9fRXZlbnRzKFtuZXZdLCAnTk9UIElOJyk7CgoJCQkJCQkJZm9yIGF3YWl0IChjb25zdCBlIG9mIChhd2FpdCBxZXYuZmluZEFsbCgpKSkgewoJCQkJCQkJCWF3YWl0IGUucHJvY2VzcygpOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJCWlmIChvU2NvcGUuVHJhbnNhY3Rpb24gJiYgIXRoaXMuX19jb25maWcoJ2hpc3RvcnkucG9sbGluZy5kaXNhYmxlZCcsIHRydWUpKSB7CgkJCQkJCWxvZygiUG9sbGluZyBUcmFuc2FjdGlvbnM6ICIgKyAodGhpcy5Ub29sLnR5cGUgPyB0aGlzLlRvb2wudHlwZS5uYW1lIDogJycpKTsKCQkJCQkJKGF3YWl0IG5ldyBvU2NvcGUuVHJhbnNhY3Rpb24oKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5zdGF0ZShuZXcgb1Njb3BlLlRyYW5hY3Rpb25TdGF0ZSgpLm5hbWUoImxvYWRlZCIpKS5zY29wZSh0aGlzLlNjb3BlKS5jb2RlKG9TY29wZS5fbm9kZS5jb2RlKCkpKS5wcm9jZXNzKCk7CgkJCQkJfQoJCQkJfQoKCQkJCWlmICghX24gfHwgIV9uLl9jb2RlX3NldCkgewoJCQkJCWxvZygiRXhpdGluZyBPbmxpbmUgSW50ZXJ2YWwuLi4gaW5pdCgpIHNob3VsZCBiZSBjYWxsZWQgYWdhaW4uIik7CgkJCQkJX24gPSB1bmRlZmluZWQ7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZihvbmxpbmUpID09PSAndW5kZWZpbmVkJyB8fCAhb25saW5lIHx8IG9ubGluZSA8IDApIHsKCQkJCQlsb2coIk5vdCBpbiBvbmxpbmUgbW9kZS4uLiBleGl0aW5nLiIpOwoJCQkJCV9uID0gdW5kZWZpbmVkOwoJCQkJfQoKCQkJCWlmIChzY29wZS5ub2RlSW5pdENhbGxzID49IHRoaXMuX19jb25maWcoJ2luaXQuZW5kcycsIDIpKSB7CgkJCQkJbG9nKCJFeGNlZWRlZCBjYWxscyBsaW1pdC4uLiBleGl0aW5nLiIpOwoJCQkJCV9uID0gdW5kZWZpbmVkOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX24pID09PSAidW5kZWZpbmVkIikgewoJCQkJCS8vbG9nKCJFeGl0IGNsZWFudXAuLi4iKTsKCQkJCQlpZiAob1Njb3BlLl9fYnJva2VyKSB7CgkJCQkJCWlmIChvU2NvcGUuX19icm9rZXIuZGlzY29ubmVjdCkgb1Njb3BlLl9fYnJva2VyLmRpc2Nvbm5lY3QoKTsKCQkJCQkJaWYgKG9TY29wZS5fX2Jyb2tlci5jbG9zZSkgb1Njb3BlLl9fYnJva2VyLmNsb3NlKCk7CgkJCQkJCWlmIChvU2NvcGUuX19icm9rZXIuZW5kKSBvU2NvcGUuX19icm9rZXIuZW5kKCk7CgkJCQkJfQoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQlhd2FpdCBfbi5vbmxpbmUodGhpcy5zcigpLnNlcnZlckRhdGUoKSkuc3RvcmUoKTsKCQkJCWxvZyhgKCR7X24uX2FkZHJlc3N9OiR7X24uX3BvcnR9KVske19uLl9jb2RlfS8ke19uLklkfV0gaXMgb25saW5lWyR7b25saW5lfV1gKTsKCgkJCQlsb2coIm5vZGVzIiwgSlNPTi5zdHJpbmdpZnkoKGF3YWl0IG5ldyBvU2NvcGUuTm9kZSgpLmZpbmRBbGwoKSkubWFwKG4gPT4gbi5fdG9Eb2N1bWVudCgpKSwgbnVsbCwgNCkpOwoKCQkJCXJldHVybiB0cnVlOwoJCQl9LCBvbmxpbmUsIG9TY29wZSwgdWlkLCBvbmxpbmUpOwoKCQkJcmV0dXJuIG47CgoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10sCgkJCW9ubGluZTogb25saW5lLAoJCQljb2RlOiBjb2RlLAoJCQl1aWQ6IHVpZAoJCX0pOwoKCQkvLyB0YWtlIG91dCB0aGUgaW52YWxpZCBub2RlIHJlc3VsdHMKCQlyZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByICYmIHIucmV0KTsKCgkJLy8gaGFzIGFueSBub2RlIGdlbmVyYXRlZCBhIHZhbGlkYXRpb24gZXhjZXB0aW9uPwoJCWxldCBfX2V4ID0gcmVzdWx0cy5maW5kKHIgPT4gci5yZXQuX19leGNlcHRpb24pOwoJCWlmIChfX2V4KSByZXR1cm4gX19leC5yZXQ7CgoJCXJldHVybiByZXN1bHRzLmxlbmd0aCA/IHJlc3VsdHNbMF0ucmV0IDogbnVsbDsKCgl9CgoJLyoqCgkgKiBTdW1tYXJ5LiBkYXJ0QVBJLgoJICoKCSAqIERlc2NyaXB0aW9uLiAuCgkgKgoJICogQHNpbmNlICAgICAgeC54LngKCSAqIEBkZXByZWNhdGVkIHgueC54IFVzZSBuZXdfZnVuY3Rpb25fbmFtZSgpIGluc3RlYWQuCgkgKiBAYWNjZXNzICAgICBwdWJsaWMKCSAqCgkgKiBAY2xhc3MKCSAqIEBhdWdtZW50cyBwYXJlbnQKCSAqIEBtaXhlcyAgICBtaXhpbgoJICoKCSAqIEBhbGlhcyAgICByZWFsTmFtZQoJICogQG1lbWJlcm9mIG5hbWVzcGFjZQoJICoKCSAqIEBzZWUgIEZ1bmN0aW9uL2NsYXNzIHJlbGllZCBvbgoJICogQGxpbmsgVVJMCgkgKiBAZ2xvYmFsCgkgKgoJICogQGZpcmVzICAgZXZlbnROYW1lCgkgKiBAZmlyZXMgICBjbGFzc05hbWUjZXZlbnROYW1lCgkgKiBAbGlzdGVucyBldmVudDpldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGNsYXNzTmFtZX5ldmVudDpldmVudE5hbWUKCSAqIEBwYXJhbSB7dHlwZX0gICB2YXIgICAgICAgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXJdICAgICAgICAgRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUuCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcj1kZWZhdWx0XSBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZSB3aXRoIGRlZmF1bHQgdmFyaWFibGUuCgkgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0VmFyICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBvYmplY3RWYXIua2V5IERlc2NyaXB0aW9uIG9mIGEga2V5IGluIHRoZSBvYmplY3RWYXIgcGFyYW1ldGVyLgoJICoKCSAqIEB5aWVsZCB7dHlwZX0gWWllbGRlZCB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqCgkgKiBAcmV0dXJuIHt0eXBlfSBSZXR1cm4gdmFsdWUgZGVzY3JpcHRpb24uCgkgKi8KCWFzeW5jIGRhcnRBUEkoc2NvcGUpIHsKCgkJbGV0IGFuc3dlciA9IG51bGw7CgoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImRhcnRBUEkiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZGFydEFQSSIsIF9ub2RlLCBzY29wZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJkYXJ0QVBJIiwgc2NvcGUpID0+IHsKCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlLmRhcnRBUEknKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2RhcnRBUEknLCAnRW50aXR5T2JqZWN0JywgMCwgewoJCQkJCQlba106IGVycm9yc1trXQoJCQkJCX0pOwoJCQkJCWRlbGV0ZSBlcnJvcnNba107CgkJCQl9KTsKCQkJCWlmIChPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIHsKCQkJCQkJX19leGNlcHRpb246IGVycm9ycywKCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlyZXR1cm4gKGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNTdG9yZWRTY3JpcHRGaW5kIiwgbnVsbCwgewoJCQkJTmFtZTogIkRBUlRBUEk6OiIgKyAoc2NvcGUgfHwgb1Njb3BlLl9ub2RlLlNjb3BlKQoJCQl9KSkuU2NyaXB0OwoKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdLAoJCQlzY29wZTogc2NvcGUKCQl9KTsKCgkJLy8gdGFrZSBvdXQgdGhlIGludmFsaWQgbm9kZSByZXN1bHRzCgkJcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gciAmJiByLnJldCk7CgoJCS8vIGhhcyBhbnkgbm9kZSBnZW5lcmF0ZWQgYSB2YWxpZGF0aW9uIGV4Y2VwdGlvbj8KCQlsZXQgX19leCA9IHJlc3VsdHMuZmluZChyID0+IHIucmV0Ll9fZXhjZXB0aW9uKTsKCQlpZiAoX19leCkgcmV0dXJuIF9fZXgucmV0OwoKCQlyZXR1cm4gcmVzdWx0cy5sZW5ndGggPyByZXN1bHRzWzBdLnJldCA6IG51bGw7CgoJfQoKCS8qKgoJICogU3VtbWFyeS4gcmVzdGFydC4KCSAqCgkgKiBEZXNjcmlwdGlvbi4gLgoJICoKCSAqIEBzaW5jZSAgICAgIHgueC54CgkgKiBAZGVwcmVjYXRlZCB4LngueCBVc2UgbmV3X2Z1bmN0aW9uX25hbWUoKSBpbnN0ZWFkLgoJICogQGFjY2VzcyAgICAgcHVibGljCgkgKgoJICogQGNsYXNzCgkgKiBAYXVnbWVudHMgcGFyZW50CgkgKiBAbWl4ZXMgICAgbWl4aW4KCSAqCgkgKiBAYWxpYXMgICAgcmVhbE5hbWUKCSAqIEBtZW1iZXJvZiBuYW1lc3BhY2UKCSAqCgkgKiBAc2VlICBGdW5jdGlvbi9jbGFzcyByZWxpZWQgb24KCSAqIEBsaW5rIFVSTAoJICogQGdsb2JhbAoJICoKCSAqIEBmaXJlcyAgIGV2ZW50TmFtZQoJICogQGZpcmVzICAgY2xhc3NOYW1lI2V2ZW50TmFtZQoJICogQGxpc3RlbnMgZXZlbnQ6ZXZlbnROYW1lCgkgKiBAbGlzdGVucyBjbGFzc05hbWV+ZXZlbnQ6ZXZlbnROYW1lCgkgKiBAcGFyYW0ge3R5cGV9ICAgdmFyICAgICAgICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyXSAgICAgICAgIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXI9ZGVmYXVsdF0gRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUgd2l0aCBkZWZhdWx0IHZhcmlhYmxlLgoJICogQHBhcmFtIHtPYmplY3R9IG9iamVjdFZhciAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgb2JqZWN0VmFyLmtleSBEZXNjcmlwdGlvbiBvZiBhIGtleSBpbiB0aGUgb2JqZWN0VmFyIHBhcmFtZXRlci4KCSAqCgkgKiBAeWllbGQge3R5cGV9IFlpZWxkZWQgdmFsdWUgZGVzY3JpcHRpb24uCgkgKgoJICogQHJldHVybiB7dHlwZX0gUmV0dXJuIHZhbHVlIGRlc2NyaXB0aW9uLgoJICovCglhc3luYyByZXN0YXJ0KCkgewoKCQlsZXQgYW5zd2VyID0gZmFsc2U7CgoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInJlc3RhcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAicmVzdGFydCIsIF9ub2RlLCApID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAicmVzdGFydCIsICkgPT4gewoKCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGUucmVzdGFydCcpOwoKCQkJdmFyIGVycm9ycyA9IHsKCgkJCX07CgkJCU9iamVjdC5rZXlzKGVycm9ycykuZmlsdGVyKGsgPT4gIWVycm9yc1trXSkuZm9yRWFjaChrID0+IGRlbGV0ZSBlcnJvcnNba10pOwoJCQlpZiAoT2JqZWN0LmtleXMoZXJyb3JzKS5sZW5ndGgpIHsKCQkJCU9iamVjdC5rZXlzKGVycm9ycykuZmlsdGVyKGsgPT4gay5zdGFydHNXaXRoKCctJykpLmZvckVhY2goayA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAncmVzdGFydCcsICdFbnRpdHlPYmplY3QnLCAwLCB7CgkJCQkJCVtrXTogZXJyb3JzW2tdCgkJCQkJfSk7CgkJCQkJZGVsZXRlIGVycm9yc1trXTsKCQkJCX0pOwoJCQkJaWYgKE9iamVjdC52YWx1ZXMoZXJyb3JzKS5sZW5ndGgpIHsKCQkJCQlyZXR1cm4gewoJCQkJCQlfX2V4Y2VwdGlvbjogZXJyb3JzLAoJCQkJCX07CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJCXNldFRpbWVvdXQoZnVuY3Rpb24oKSB7CgkJCQkvLyBXaGVuIE5vZGVKUyBleGl0cwoJCQkJcHJvY2Vzcy5vbigiZXhpdCIsIGZ1bmN0aW9uKCkgewoKCQkJCQlyZXF1aXJlKCJjaGlsZF9wcm9jZXNzIikuc3Bhd24ocHJvY2Vzcy5hcmd2LnNoaWZ0KCksIHByb2Nlc3MuYXJndiwgewoJCQkJCQljd2Q6IHByb2Nlc3MuY3dkKCksCgkJCQkJCWRldGFjaGVkOiB0cnVlLAoJCQkJCQlzdGRpbzogImluaGVyaXQiCgkJCQkJfSk7CgkJCQl9KTsKCQkJCXByb2Nlc3MuZXhpdCgpOwoJCQl9LCAxMDAwKTsKCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXSwKCQl9KTsKCgkJLy8gdGFrZSBvdXQgdGhlIGludmFsaWQgbm9kZSByZXN1bHRzCgkJcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gciAmJiByLnJldCk7CgoJCS8vIGhhcyBhbnkgbm9kZSBnZW5lcmF0ZWQgYSB2YWxpZGF0aW9uIGV4Y2VwdGlvbj8KCQlsZXQgX19leCA9IHJlc3VsdHMuZmluZChyID0+IHIucmV0Ll9fZXhjZXB0aW9uKTsKCQlpZiAoX19leCkgcmV0dXJuIF9fZXgucmV0OwoKCQlyZXR1cm4gcmVzdWx0cy5sZW5ndGggPyByZXN1bHRzWzBdLnJldCA6IG51bGw7CgoJfQoKCS8qKgoJICogU3VtbWFyeS4gc3RhdHVzLgoJICoKCSAqIERlc2NyaXB0aW9uLiAuCgkgKgoJICogQHNpbmNlICAgICAgeC54LngKCSAqIEBkZXByZWNhdGVkIHgueC54IFVzZSBuZXdfZnVuY3Rpb25fbmFtZSgpIGluc3RlYWQuCgkgKiBAYWNjZXNzICAgICBwdWJsaWMKCSAqCgkgKiBAY2xhc3MKCSAqIEBhdWdtZW50cyBwYXJlbnQKCSAqIEBtaXhlcyAgICBtaXhpbgoJICoKCSAqIEBhbGlhcyAgICByZWFsTmFtZQoJICogQG1lbWJlcm9mIG5hbWVzcGFjZQoJICoKCSAqIEBzZWUgIEZ1bmN0aW9uL2NsYXNzIHJlbGllZCBvbgoJICogQGxpbmsgVVJMCgkgKiBAZ2xvYmFsCgkgKgoJICogQGZpcmVzICAgZXZlbnROYW1lCgkgKiBAZmlyZXMgICBjbGFzc05hbWUjZXZlbnROYW1lCgkgKiBAbGlzdGVucyBldmVudDpldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGNsYXNzTmFtZX5ldmVudDpldmVudE5hbWUKCSAqIEBwYXJhbSB7dHlwZX0gICB2YXIgICAgICAgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXJdICAgICAgICAgRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUuCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcj1kZWZhdWx0XSBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZSB3aXRoIGRlZmF1bHQgdmFyaWFibGUuCgkgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0VmFyICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBvYmplY3RWYXIua2V5IERlc2NyaXB0aW9uIG9mIGEga2V5IGluIHRoZSBvYmplY3RWYXIgcGFyYW1ldGVyLgoJICoKCSAqIEB5aWVsZCB7dHlwZX0gWWllbGRlZCB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqCgkgKiBAcmV0dXJuIHt0eXBlfSBSZXR1cm4gdmFsdWUgZGVzY3JpcHRpb24uCgkgKi8KCWFzeW5jIHN0YXR1cygpIHsKCgkJbGV0IGFuc3dlciA9IG51bGw7CgoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0YXR1cyIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdGF0dXMiLCBfbm9kZSwgKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdGF0dXMiLCApID0+IHsKCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlLnN0YXR1cycpOwoKCQkJdmFyIGVycm9ycyA9IHsKCgkJCX07CgkJCU9iamVjdC5rZXlzKGVycm9ycykuZmlsdGVyKGsgPT4gIWVycm9yc1trXSkuZm9yRWFjaChrID0+IGRlbGV0ZSBlcnJvcnNba10pOwoJCQlpZiAoT2JqZWN0LmtleXMoZXJyb3JzKS5sZW5ndGgpIHsKCQkJCU9iamVjdC5rZXlzKGVycm9ycykuZmlsdGVyKGsgPT4gay5zdGFydHNXaXRoKCctJykpLmZvckVhY2goayA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RhdHVzJywgJ0VudGl0eU9iamVjdCcsIDAsIHsKCQkJCQkJW2tdOiBlcnJvcnNba10KCQkJCQl9KTsKCQkJCQlkZWxldGUgZXJyb3JzW2tdOwoJCQkJfSk7CgkJCQlpZiAoT2JqZWN0LnZhbHVlcyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJCXJldHVybiB7CgkJCQkJCV9fZXhjZXB0aW9uOiBlcnJvcnMsCgkJCQkJfTsKCQkJCX0KCQkJCXJldHVybjsKCQkJfQoKCQkJcmV0dXJuIHsKCQkJCV9ub2RlOiBvU2NvcGUuX25vZGUgPyBvU2NvcGUuX25vZGUuX2NvZGUgOiBudWxsLAoJCQkJdmVyc2lvbjogb1Njb3BlLl9fc2NyaXB0LkRhdGUudG9JU09TdHJpbmcoKSwKCQkJCXRpbWU6IHRoaXMuc3IoKS5zZXJ2ZXJEYXRlKCkudG9JU09TdHJpbmcoKSwKCQkJfTsKCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXSwKCQl9KTsKCgkJLy8gdGFrZSBvdXQgdGhlIGludmFsaWQgbm9kZSByZXN1bHRzCgkJcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gciAmJiByLnJldCk7CgoJCS8vIGhhcyBhbnkgbm9kZSBnZW5lcmF0ZWQgYSB2YWxpZGF0aW9uIGV4Y2VwdGlvbj8KCQlsZXQgX19leCA9IHJlc3VsdHMuZmluZChyID0+IHIucmV0Ll9fZXhjZXB0aW9uKTsKCQlpZiAoX19leCkgcmV0dXJuIF9fZXgucmV0OwoKCQlyZXR1cm4gcmVzdWx0cy5sZW5ndGggPyByZXN1bHRzWzBdLnJldCA6IG51bGw7CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWRkcmVzcycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdiYWNrdXAnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdwYXJlbnQnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdwb3J0JywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29ubGluZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc2VjdXJlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qTm9kZSovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJhZGRyZXNzIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FkZHJlc3MnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWRkcmVzcycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJiYWNrdXAiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYmFja3VwJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2JhY2t1cCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkicGFyZW50IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3BhcmVudCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdwYXJlbnQnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJInBvcnQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncG9ydCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdwb3J0JywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9ubGluZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvbmxpbmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb25saW5lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJzZWN1cmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc2VjdXJlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3NlY3VyZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkidHlwZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCW5vZGVfQ29uZmlnczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25vZGVfTm9kZXMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQkJY2Fycmllcl9FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYXJyaWVyX05vZGVzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJCXNlbmRlcl9FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzZW5kZXJfTm9kZXMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQkJcmVjaXBpZW50X0V2ZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlY2lwaWVudF9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IG9iai5zcWwgPSB2Lm1hcChfdiA9PiBfdi5fdG9TUUxUYWJsZSgpKSArIG9iai5zcWwsCgoJCQliYWNrdXBfTm9kZXM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdiYWNrdXBfTm9kZXMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQkJcGFyZW50X05vZGVzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncGFyZW50X05vZGVzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJCW5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbm9kZV9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IG9iai5zcWwgPSB2Lm1hcChfdiA9PiBfdi5fdG9TUUxUYWJsZSgpKSArIG9iai5zcWwsCgoJCX0sICJfdG9TUUxUYWJsZSIpOwoKCQkvLyByZXQuc3FsICs9ICcvKk5vZGUqLyk7XG4nOwoKCQlyZXQuc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChyZXQuc3FsKSA6IHJldC5zcWw7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NRTFRhYmxlJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldC5zcWwpOwoJCXJldHVybiByZXQuc3FsOwoJfQoKCV9mcm9tU1FMVGFibGUodGFibGUsIGZpZWxkcykgewoJCS8vIHRhYmxlIGlzIGEganNvbiBhcnJheQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWRkcmVzcyIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuYWRkcmVzcyh0YWJsZVsiYWRkcmVzcyJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJiYWNrdXAiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmJhY2t1cCh0YWJsZVsiYmFja3VwIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInBhcmVudCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucGFyZW50KHRhYmxlWyJwYXJlbnQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicG9ydCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucG9ydCh0YWJsZVsicG9ydCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvbmxpbmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9ubGluZSh0YWJsZVsib25saW5lIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInNlY3VyZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuc2VjdXJlKHRhYmxlWyJzZWN1cmUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigidHlwZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMudHlwZSh0YWJsZVsidHlwZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbChzcWwsIHRoaXMpOwoKCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCgkJCQkJLy8gaWYodGhpc1snXycrZmllbGQrJ19zZXQnXSAmJiAodHlwZW9mKHRoaXNbJ18nK2ZpZWxkXSk9PT0ndW5kZWZpbmVkJyB8fCB0aGlzWydfJytmaWVsZF09PW51bGwpKSByZXR1cm47CgkJCQkJLy8gaWYodHlwZW9mKGVhT2JqKT09PSd1bmRlZmluZWQnKSByZXR1cm47IC8vIHdoeT8KCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCXJldHVybiBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiYWRkcmVzcyIsIG9iaiwgdGhpcy5hZGRyZXNzKCkpOwoKCQlfb3B0aW9ucygicG9ydCIsIG9iaiwgdGhpcy5wb3J0KCkpOwoKCQlfb3B0aW9ucygib25saW5lIiwgb2JqLCB0aGlzLm9ubGluZSgpKTsKCgkJX29wdGlvbnMoInNlY3VyZSIsIG9iaiwgdGhpcy5zZWN1cmUoKSk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiYzZiMTRiNGUtZTUxZC00ZGJhLWFmYjgtYWM0NzhmNGI0ZTc2IiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGUgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGUgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlpZiAoIXRoaXMuYmFja3VwKCkgfHwgKHRoaXMuYmFja3VwKCkKCgkJCQkmJgoJCQkJIXRoaXMuYmFja3VwKCkubm9kZV9Db25maWdzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmJhY2t1cCgpLmNhcnJpZXJfRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmJhY2t1cCgpLnNlbmRlcl9FdmVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuYmFja3VwKCkucmVjaXBpZW50X0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5iYWNrdXAoKS5iYWNrdXBfTm9kZXMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuYmFja3VwKCkucGFyZW50X05vZGVzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmJhY2t1cCgpLm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJiYWNrdXAiLCBvYmosIHRoaXMuYmFja3VwKCkpOwoJCX0KCgkJaWYgKCF0aGlzLnBhcmVudCgpIHx8ICh0aGlzLnBhcmVudCgpCgoJCQkJJiYKCQkJCSF0aGlzLnBhcmVudCgpLm5vZGVfQ29uZmlncygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5wYXJlbnQoKS5jYXJyaWVyX0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5wYXJlbnQoKS5zZW5kZXJfRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnBhcmVudCgpLnJlY2lwaWVudF9FdmVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMucGFyZW50KCkuYmFja3VwX05vZGVzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnBhcmVudCgpLnBhcmVudF9Ob2RlcygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5wYXJlbnQoKS5ub2RlX05vZGVfR3JvdXBfTWVtYmVycygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygicGFyZW50Iiwgb2JqLCB0aGlzLnBhcmVudCgpKTsKCQl9CgoJCWlmICghdGhpcy50eXBlKCkgfHwgKHRoaXMudHlwZSgpCgoJCQkJJiYKCQkJCSF0aGlzLnR5cGUoKS50eXBlX05vZGVzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJ0eXBlIiwgb2JqLCB0aGlzLnR5cGUoKSk7CgkJfQoKCQlfb3B0aW9ucygibm9kZV9Db25maWdzIiwgb2JqLCB0aGlzLm5vZGVfQ29uZmlncygpKTsKCgkJX29wdGlvbnMoImNhcnJpZXJfRXZlbnRzIiwgb2JqLCB0aGlzLmNhcnJpZXJfRXZlbnRzKCkpOwoKCQlfb3B0aW9ucygic2VuZGVyX0V2ZW50cyIsIG9iaiwgdGhpcy5zZW5kZXJfRXZlbnRzKCkpOwoKCQlfb3B0aW9ucygicmVjaXBpZW50X0V2ZW50cyIsIG9iaiwgdGhpcy5yZWNpcGllbnRfRXZlbnRzKCkpOwoKCQlfb3B0aW9ucygiYmFja3VwX05vZGVzIiwgb2JqLCB0aGlzLmJhY2t1cF9Ob2RlcygpKTsKCgkJX29wdGlvbnMoInBhcmVudF9Ob2RlcyIsIG9iaiwgdGhpcy5wYXJlbnRfTm9kZXMoKSk7CgoJCV9vcHRpb25zKCJub2RlX05vZGVfR3JvdXBfTWVtYmVycyIsIG9iaiwgdGhpcy5ub2RlX05vZGVfR3JvdXBfTWVtYmVycygpKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWRkcmVzcycsICdiYWNrdXAnLCAncGFyZW50JywgJ3BvcnQnLCAnb25saW5lJywgJ3NlY3VyZScsICd0eXBlJywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydub2RlX0NvbmZpZ3MnLCAnY2Fycmllcl9FdmVudHMnLCAnc2VuZGVyX0V2ZW50cycsICdyZWNpcGllbnRfRXZlbnRzJywgJ2JhY2t1cF9Ob2RlcycsICdwYXJlbnRfTm9kZXMnLCAnbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIk5vZGUiICYmIChtLnRhcmdldCB8fCBtLm91dFNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSAmJiAoIW0uc291cmNlIHx8IChtLnNvdXJjZSAmJiAvKiFtLm91dFNjcmlwdCAmJiovIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX3NldCddKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5vdXRTY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMsIG9TY29wZSwgbWFwKSA9PiB7JHttLm91dFNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLm91dFNjcmlwdH0pfWApKHRoaXMsIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnNvdXJjZSkgewoJCQkJaWYgKG0uc291cmNlLmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcykgPT4ge3JldHVybiBfdGhpcy4ke20uc291cmNlfTt9YCkodGhpcyk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnNvdXJjZSwgdGhpcyk7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0udGFyZ2V0KSBvYmpbbS50YXJnZXRdID0gcmV0OwoJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQlbbS50YXJnZXQgfHwgbS5zb3VyY2VdOiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10KCQkJfSk7CgkJfSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJLy8gdXNlIHRoaXMuX21hcCgpIHdpdGggcmV2ZXJzZQoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWRkcmVzcyIsIG9iaik7CgoJCV9vcHRpb25zKCJwb3J0Iiwgb2JqKTsKCgkJX29wdGlvbnMoIm9ubGluZSIsIG9iaik7CgoJCV9vcHRpb25zKCJzZWN1cmUiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJjNmIxNGI0ZS1lNTFkLTRkYmEtYWZiOC1hYzQ3OGY0YjRlNzYiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoImJhY2t1cCIsIG9iaik7CgoJCV9vcHRpb25zKCJwYXJlbnQiLCBvYmopOwoKCQlfb3B0aW9ucygidHlwZSIsIG9iaik7CgoJCV9vcHRpb25zKCJub2RlX0NvbmZpZ3MiLCBvYmopOwoKCQlfb3B0aW9ucygiY2Fycmllcl9FdmVudHMiLCBvYmopOwoKCQlfb3B0aW9ucygic2VuZGVyX0V2ZW50cyIsIG9iaik7CgoJCV9vcHRpb25zKCJyZWNpcGllbnRfRXZlbnRzIiwgb2JqKTsKCgkJX29wdGlvbnMoImJhY2t1cF9Ob2RlcyIsIG9iaik7CgoJCV9vcHRpb25zKCJwYXJlbnRfTm9kZXMiLCBvYmopOwoKCQlfb3B0aW9ucygibm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhZGRyZXNzJywgJ2JhY2t1cCcsICdwYXJlbnQnLCAncG9ydCcsICdvbmxpbmUnLCAnc2VjdXJlJywgJ3R5cGUnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ25vZGVfQ29uZmlncycsICdjYXJyaWVyX0V2ZW50cycsICdzZW5kZXJfRXZlbnRzJywgJ3JlY2lwaWVudF9FdmVudHMnLCAnYmFja3VwX05vZGVzJywgJ3BhcmVudF9Ob2RlcycsICdub2RlX05vZGVfR3JvdXBfTWVtYmVycyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaikpOwoKCQlmYWxzZSAmJiBbXS5jb25jYXQodGhpcy5Ub29sLnR5cGUudHlwZV9NYXBwaW5ncyB8fCBbXSkuY29uY2F0KHRoaXMuVG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5maWx0ZXIobSA9PiBtLmNsYXNzTmFtZSA9PSAiTm9kZSIgJiYgKG0uc291cmNlIHx8IG0uaW5TY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5pblNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmosIG9TY29wZSwgbWFwKSA9PiB7JHttLmluU2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20uaW5TY3JpcHR9KX1gKShvYmosIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnRhcmdldCkgewoJCQkJaWYgKG0udGFyZ2V0LmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmopID0+IHtyZXR1cm4gb2JqLiR7bS50YXJnZXR9O31gKShvYmopOwoJCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqW20udGFyZ2V0XSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0udGFyZ2V0LCBvYmopOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0uc291cmNlKSB7CgkJCQlpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXRoaXNbbS5zb3VyY2VdKHJldCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXNbbS5zb3VyY2VdID0gcmV0OwoJCQkJfQoJCQl9CgkJfSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RCT2JqZWN0KGZpZWxkcywgYk5vUmVmKSB7CgkJaWYgKCF0aGlzLklkKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJJbnZhbGlkIElEIiwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lLCB0aGlzLlRvb2wpOwoJCX0KCQlsZXQgcmV0ID0gewoJCQlbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ106ICInIiArIHRoaXMuSWQgKyAiJyIKCQl9OwoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFkZHJlc3MiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fYWRkcmVzc19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hZGRyZXNzKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdhZGRyZXNzJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYmFja3VwIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2JhY2t1cF9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYmFja3VwKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdiYWNrdXAnLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInBhcmVudCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9wYXJlbnRfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnBhcmVudCgpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgncGFyZW50JywgdW5kZWZpbmVkKSArICJpZCJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJwb3J0IikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3BvcnRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucG9ydCgpOwoKCQkJZlZhbHVlID0gdiB8fCAnMCc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3BvcnQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvbmxpbmUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fb25saW5lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9ubGluZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb25saW5lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigic2VjdXJlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3NlY3VyZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5zZWN1cmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnc2VjdXJlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigidHlwZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl90eXBlX3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy50eXBlKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSArICJpZCJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fYWN0aXZlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2VuYWJsZWRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9jb2RlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNvZGUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9vcmRlcl9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5vcmRlcigpOwoKCQkJZlZhbHVlID0gdiB8fCAnMCc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9kYXRlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmRhdGUoKTsKCgkJCXRyeSB7CgkJCQlmVmFsdWUgPSAiJyIgKyAodiA/IHYudG9JU09TdHJpbmcoKSA6ICIxOTcwLTEtMSIpICsgIiciOwoJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnKSB7CgkJCQkJZlZhbHVlID0gYFNUUl9UT19EQVRFKCR7ZlZhbHVlfSwgJyVZLSVtLSVkVCVULiVmWicpYDsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gJ2RhdGV0aW1lKCcgKyBmVmFsdWUgKyAnKSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX25hbWVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMubmFtZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9yZW1hcmtfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucmVtYXJrKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9RKCkgewoJCWxldCBfbyA9ICciJzsKCQlsZXQgX3EgPSBfbzsKCgkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgewoJCQlfbyA9IF9xID0gJ2AnOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxzZXJ2ZXInKSB7CgkJCV9vID0gJ1snOwoJCQlfcSA9ICddJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ2FwaUtleScpID09ICdhaXJ0YWJsZScpIHsKCQkJX28gPSAneyc7CgkJCV9xID0gJ30nOwoJCX0KCQl0aGlzLl9fUSA9IHRoaXMuX19RID09IF9vID8gX3EgOiBfbzsKCQlyZXR1cm4gdGhpcy5fX1E7Cgl9CgoJX2ZpZWxkR3JvdXBzKGZncyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOwoJCXJldHVybiB0aGlzOwoJfQoKCV9maWVsZEFnZ3JlZ2F0ZXMoZmFzID0ge30pIHsKCQl0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOwoJCXJldHVybiB0aGlzOwoJfQoKCV90b0ZpZWxkc1NRTChmaWVsZHMpIHsKCgkJZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnLCB0aGlzLl9uQ29kZSgnYWRkcmVzcycsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdiYWNrdXAnLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdwYXJlbnQnLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdwb3J0JywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ29ubGluZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdzZWN1cmUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkgKyAiLmlkIiwgdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCldOwoJCWZpZWxkcyA9IEFycmF5LmlzQXJyYXkoZmllbGRzKSA/IGZpZWxkcyA6IFtmaWVsZHNdOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCS8vIHtmaWVsZDogb3JkZXJ9CgkJCWZpZWxkcyA9IFtdOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hZGRyZXNzKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnYWRkcmVzcycsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmJhY2t1cCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2JhY2t1cCcsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMucGFyZW50KSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgncGFyZW50JywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5wb3J0KSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgncG9ydCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9ubGluZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29ubGluZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnNlY3VyZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ3NlY3VyZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnR5cGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXSwKCgkJCQlhZGRyZXNzOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWRkcmVzcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmFkZHJlc3Mob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQliYWNrdXA6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdiYWNrdXAnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5iYWNrdXAob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlwYXJlbnQ6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwYXJlbnQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5wYXJlbnQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlwb3J0OiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncG9ydCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnBvcnQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvbmxpbmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvbmxpbmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5vbmxpbmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlzZWN1cmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzZWN1cmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5zZWN1cmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQl0eXBlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnR5cGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU51bGw6IHRydWUsCgoJCQliYWNrdXA6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdiYWNrdXAnLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Ob2RlKCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQlwYXJlbnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwYXJlbnQnLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Ob2RlKCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQl0eXBlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93Lk5vZGVfVHlwZSgpLl90b1NlbGVjdEhlYWRlcigpLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoJCXNxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsKCgkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpIHsKCQkJLy8ge2ZpZWxkOiBmdW5jdGlvbn0KCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFkZHJlc3MpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFkZHJlc3N9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FkZHJlc3MnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYmFja3VwKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5iYWNrdXB9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2JhY2t1cCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5wYXJlbnQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnBhcmVudH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncGFyZW50JywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnBvcnQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnBvcnR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3BvcnQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub25saW5lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vbmxpbmV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29ubGluZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5zZWN1cmUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnNlY3VyZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc2VjdXJlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnR5cGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnR5cGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJYWRkcmVzczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FkZHJlc3MnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FkZHJlc3Nfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9hZGRyZXNzX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9hZGRyZXNzX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9hZGRyZXNzX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fYWRkcmVzc19jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fYWRkcmVzc19jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJYmFja3VwOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYmFja3VwJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9iYWNrdXBfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9iYWNrdXBfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlwYXJlbnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwYXJlbnQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3BhcmVudF9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX3BhcmVudF9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXBvcnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwb3J0JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9wb3J0X3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fcG9ydF9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJb25saW5lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb25saW5lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vbmxpbmVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vbmxpbmVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXNlY3VyZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3NlY3VyZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fc2VjdXJlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXR5cGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl90eXBlX3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fdHlwZV9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jb2RlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fY29kZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX29yZGVyX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fb3JkZXJfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fZGF0ZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi50b0lTT1N0cmluZykgewoJCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbGl0ZScpIHsKCQkJCQkJb2JqLnNxbCArPSAic3RyZnRpbWUoJyVzJywgJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJykiOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9iai5zcWwgKz0gIiciICsgdi50b0lTT1N0cmluZygpICsgIiciOwoJCQkJCX0KCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9uYW1lX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9yZW1hcmtfc2V0KSByZXR1cm47CgoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5vZGVfQ29uZmlnczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25vZGVfTm9kZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX25vZGVfQ29uZmlnc19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoIm5vZGUuaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX25vZGVfQ29uZmlnc19jb29wID09ICchPScgfHwgdGhpcy5fbm9kZV9Db25maWdzX2Nvb3AgPT0gJ05PVCBJTicpIHsKCQkJCQlpbk9QID0gJ05PVCBJTic7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX25vZGVfQ29uZmlnc19jb29wID09ICc9JyB8fCB0aGlzLl9ub2RlX0NvbmZpZ3NfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl9ub2RlX0NvbmZpZ3NfY29vcCA9PSAnPT0nKSB7CgkJCQkJak9QID0gJ0lOVEVSU0VDVCc7CgkJCQl9CgoJCQkJb2JqLnNxbCArPSBgYW5kIC8qbm9kZV9Db25maWdzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQkJY2Fycmllcl9FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYXJyaWVyX05vZGVzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jYXJyaWVyX0V2ZW50c19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoImNhcnJpZXIuaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX2NhcnJpZXJfRXZlbnRzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl9jYXJyaWVyX0V2ZW50c19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9jYXJyaWVyX0V2ZW50c19jb29wID09ICc9JyB8fCB0aGlzLl9jYXJyaWVyX0V2ZW50c19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX2NhcnJpZXJfRXZlbnRzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKmNhcnJpZXJfRXZlbnRzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQkJc2VuZGVyX0V2ZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3NlbmRlcl9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fc2VuZGVyX0V2ZW50c19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoInNlbmRlci5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fc2VuZGVyX0V2ZW50c19jb29wID09ICchPScgfHwgdGhpcy5fc2VuZGVyX0V2ZW50c19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9zZW5kZXJfRXZlbnRzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX3NlbmRlcl9FdmVudHNfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl9zZW5kZXJfRXZlbnRzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKnNlbmRlcl9FdmVudHMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCQlyZWNpcGllbnRfRXZlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVjaXBpZW50X05vZGVzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9yZWNpcGllbnRfRXZlbnRzX3NldCkgcmV0dXJuOwoKCQkJCWxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCgicmVjaXBpZW50LmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9yZWNpcGllbnRfRXZlbnRzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl9yZWNpcGllbnRfRXZlbnRzX2Nvb3AgPT0gJ05PVCBJTicpIHsKCQkJCQlpbk9QID0gJ05PVCBJTic7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX3JlY2lwaWVudF9FdmVudHNfY29vcCA9PSAnPScgfHwgdGhpcy5fcmVjaXBpZW50X0V2ZW50c19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX3JlY2lwaWVudF9FdmVudHNfY29vcCA9PSAnPT0nKSB7CgkJCQkJak9QID0gJ0lOVEVSU0VDVCc7CgkJCQl9CgoJCQkJb2JqLnNxbCArPSBgYW5kIC8qcmVjaXBpZW50X0V2ZW50cyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJCWJhY2t1cF9Ob2RlczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2JhY2t1cF9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fYmFja3VwX05vZGVzX3NldCkgcmV0dXJuOwoKCQkJCWxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCgiYmFja3VwLmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9iYWNrdXBfTm9kZXNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX2JhY2t1cF9Ob2Rlc19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9iYWNrdXBfTm9kZXNfY29vcCA9PSAnPScgfHwgdGhpcy5fYmFja3VwX05vZGVzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fYmFja3VwX05vZGVzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKmJhY2t1cF9Ob2RlcyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJCXBhcmVudF9Ob2RlczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3BhcmVudF9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcGFyZW50X05vZGVzX3NldCkgcmV0dXJuOwoKCQkJCWxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCgicGFyZW50LmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9wYXJlbnRfTm9kZXNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX3BhcmVudF9Ob2Rlc19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9wYXJlbnRfTm9kZXNfY29vcCA9PSAnPScgfHwgdGhpcy5fcGFyZW50X05vZGVzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fcGFyZW50X05vZGVzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKnBhcmVudF9Ob2RlcyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJCW5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbm9kZV9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJub2RlLmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9ub2RlX05vZGVfR3JvdXBfTWVtYmVyc19jb29wID09ICchPScgfHwgdGhpcy5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnNfY29vcCA9PSAnPScgfHwgdGhpcy5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnNfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl9ub2RlX05vZGVfR3JvdXBfTWVtYmVyc19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLypub2RlX05vZGVfR3JvdXBfTWVtYmVycyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJfSwgIl90b1NlbGVjdFNRTCIsIGZpZWxkcykuc3FsOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCWlmIChPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWRkcmVzcykgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhZGRyZXNzJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuYWRkcmVzc31gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5iYWNrdXApIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYmFja3VwJywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5iYWNrdXB9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMucGFyZW50KSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3BhcmVudCcsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMucGFyZW50fWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnBvcnQpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncG9ydCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnBvcnR9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub25saW5lKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29ubGluZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm9ubGluZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5zZWN1cmUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc2VjdXJlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuc2VjdXJlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnR5cGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMudHlwZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWR9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuY29kZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMubmFtZX1gOwoKCQl9CgoJCWlmIChzcWwuZW5kc1dpdGgoIndoZXJlIDE9MSIpKSB7CgkJCS8vIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEiLCAid2hlcmUgMT0wIik7CgkJfSBlbHNlIHsKCQkJc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSBhbmQgIiwgIndoZXJlICIpOwoJCX0KCgkJc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpIDogc3FsOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoKCQlyZXR1cm4gc3FsOwoJfQoKCV90b1BhdGhzKCkgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCV9USElTOiBvYmogPT4ge30sCgoJCQliYWNrdXA6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdiYWNrdXAnLCB1bmRlZmluZWQpKSA9PiBvYmouYmFja3VwID0gdi5fdG9QYXRocygpLAoKCQkJcGFyZW50OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncGFyZW50JywgdW5kZWZpbmVkKSkgPT4gb2JqLnBhcmVudCA9IHYuX3RvUGF0aHMoKSwKCgkJCXR5cGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSkgPT4gb2JqLnR5cGUgPSB2Ll90b1BhdGhzKCksCgoJCQlub2RlX0NvbmZpZ3M6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdub2RlX05vZGVzJywgdW5kZWZpbmVkKSkgPT4gb2JqLm5vZGVfQ29uZmlncyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQkJY2Fycmllcl9FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYXJyaWVyX05vZGVzJywgdW5kZWZpbmVkKSkgPT4gb2JqLmNhcnJpZXJfRXZlbnRzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCQlzZW5kZXJfRXZlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc2VuZGVyX05vZGVzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNlbmRlcl9FdmVudHMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJCXJlY2lwaWVudF9FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZWNpcGllbnRfTm9kZXMnLCB1bmRlZmluZWQpKSA9PiBvYmoucmVjaXBpZW50X0V2ZW50cyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQkJYmFja3VwX05vZGVzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYmFja3VwX05vZGVzJywgdW5kZWZpbmVkKSkgPT4gb2JqLmJhY2t1cF9Ob2RlcyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQkJcGFyZW50X05vZGVzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncGFyZW50X05vZGVzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnBhcmVudF9Ob2RlcyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQkJbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdub2RlX05vZGVzJywgdW5kZWZpbmVkKSkgPT4gb2JqLm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTm9kZSkgcmV0dXJuOwoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5Ob2RlID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5Ob2RlKCkKCgkJCQkJLmJhY2t1cChuZXcgc2FsZXNub3cuTm9kZSgpKQoKCQkJCQkucGFyZW50KG5ldyBzYWxlc25vdy5Ob2RlKCkpCgoJCQkJCS50eXBlKG5ldyBzYWxlc25vdy5Ob2RlX1R5cGUoKSkKCgkJCQkJLm5vZGVfQ29uZmlncyhuZXcgc2FsZXNub3cuQ29uZmlnKCkpCgoJCQkJCS5jYXJyaWVyX0V2ZW50cyhuZXcgc2FsZXNub3cuRXZlbnQoKSkKCgkJCQkJLnNlbmRlcl9FdmVudHMobmV3IHNhbGVzbm93LkV2ZW50KCkpCgoJCQkJCS5yZWNpcGllbnRfRXZlbnRzKG5ldyBzYWxlc25vdy5FdmVudCgpKQoKCQkJCQkuYmFja3VwX05vZGVzKG5ldyBzYWxlc25vdy5Ob2RlKCkpCgoJCQkJCS5wYXJlbnRfTm9kZXMobmV3IHNhbGVzbm93Lk5vZGUoKSkKCgkJCQkJLm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKG5ldyBzYWxlc25vdy5Ob2RlX0dyb3VwX01lbWJlcigpKQoKCQkJCQkuX3RvU1FMVGFibGUoZGVwdGgpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQkJCWF3YWl0IHRoaXMuX3NxbChzcWwpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiTm9kZSIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlhZGRyZXNzOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hZGRyZXNzID0gdiA9PSBxdWVyeS5hZGRyZXNzKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FkZHJlc3Nfc2V0ICYmICFxdWVyeS5fYWRkcmVzc19zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWRkcmVzcyA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hZGRyZXNzX3NldCAmJiBxdWVyeS5fYWRkcmVzc19zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFkZHJlc3MgPSBmYWxzZTsKCQkJCX0sCgoJCQkJYmFja3VwOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5iYWNrdXAgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LmJhY2t1cCgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9iYWNrdXBfc2V0ICYmICFxdWVyeS5fYmFja3VwX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5iYWNrdXAgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYmFja3VwX3NldCAmJiBxdWVyeS5fYmFja3VwX3NldCkgfHwKCgkJCQkJCSh0aGlzLmJhY2t1cCgpICYmICF0aGlzLmJhY2t1cCgpLl9tYXRjaGVzKHF1ZXJ5LmJhY2t1cCgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYmFja3VwID0gZmFsc2U7CgkJCQl9LAoKCQkJCXBhcmVudDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucGFyZW50ID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5wYXJlbnQoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcGFyZW50X3NldCAmJiAhcXVlcnkuX3BhcmVudF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucGFyZW50ID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3BhcmVudF9zZXQgJiYgcXVlcnkuX3BhcmVudF9zZXQpIHx8CgoJCQkJCQkodGhpcy5wYXJlbnQoKSAmJiAhdGhpcy5wYXJlbnQoKS5fbWF0Y2hlcyhxdWVyeS5wYXJlbnQoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnBhcmVudCA9IGZhbHNlOwoJCQkJfSwKCgkJCQlwb3J0OiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5wb3J0ID0gdiA9PSBxdWVyeS5wb3J0KCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3BvcnRfc2V0ICYmICFxdWVyeS5fcG9ydF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucG9ydCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9wb3J0X3NldCAmJiBxdWVyeS5fcG9ydF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnBvcnQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb25saW5lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vbmxpbmUgPSB2ID09IHF1ZXJ5Lm9ubGluZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vbmxpbmVfc2V0ICYmICFxdWVyeS5fb25saW5lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vbmxpbmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb25saW5lX3NldCAmJiBxdWVyeS5fb25saW5lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub25saW5lID0gZmFsc2U7CgkJCQl9LAoKCQkJCXNlY3VyZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouc2VjdXJlID0gdiA9PSBxdWVyeS5zZWN1cmUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fc2VjdXJlX3NldCAmJiAhcXVlcnkuX3NlY3VyZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouc2VjdXJlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3NlY3VyZV9zZXQgJiYgcXVlcnkuX3NlY3VyZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnNlY3VyZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQl0eXBlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai50eXBlID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS50eXBlKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3R5cGVfc2V0ICYmICFxdWVyeS5fdHlwZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudHlwZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl90eXBlX3NldCAmJiBxdWVyeS5fdHlwZV9zZXQpIHx8CgoJCQkJCQkodGhpcy50eXBlKCkgJiYgIXRoaXMudHlwZSgpLl9tYXRjaGVzKHF1ZXJ5LnR5cGUoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnR5cGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5vZGVfQ29uZmlnczogKG9iaiwgdikgPT4gewoJCQkJCW9iai5ub2RlX0NvbmZpZ3MgPSB2Lm1hcChfdiA9PiBxdWVyeS5ub2RlX0NvbmZpZ3MoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCQljYXJyaWVyX0V2ZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5jYXJyaWVyX0V2ZW50cyA9IHYubWFwKF92ID0+IHF1ZXJ5LmNhcnJpZXJfRXZlbnRzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQkJc2VuZGVyX0V2ZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5zZW5kZXJfRXZlbnRzID0gdi5tYXAoX3YgPT4gcXVlcnkuc2VuZGVyX0V2ZW50cygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJCXJlY2lwaWVudF9FdmVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoucmVjaXBpZW50X0V2ZW50cyA9IHYubWFwKF92ID0+IHF1ZXJ5LnJlY2lwaWVudF9FdmVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCQliYWNrdXBfTm9kZXM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouYmFja3VwX05vZGVzID0gdi5tYXAoX3YgPT4gcXVlcnkuYmFja3VwX05vZGVzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQkJcGFyZW50X05vZGVzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnBhcmVudF9Ob2RlcyA9IHYubWFwKF92ID0+IHF1ZXJ5LnBhcmVudF9Ob2RlcygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJCW5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzID0gdi5tYXAoX3YgPT4gcXVlcnkubm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWJhY2t1cDogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIGJhY2t1cCIpOwoJCQkJCW9iai5iYWNrdXAgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQlwYXJlbnQ6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBwYXJlbnQiKTsKCQkJCQlvYmoucGFyZW50ID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJdHlwZTogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIHR5cGUiKTsKCQkJCQlvYmoudHlwZSA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCW5vZGVfQ29uZmlnczogKG9iaiwgdikgPT4gewoJCQkJCW9iai5ub2RlX0NvbmZpZ3MgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJCWNhcnJpZXJfRXZlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmNhcnJpZXJfRXZlbnRzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCQlzZW5kZXJfRXZlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnNlbmRlcl9FdmVudHMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJCXJlY2lwaWVudF9FdmVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoucmVjaXBpZW50X0V2ZW50cyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQkJYmFja3VwX05vZGVzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmJhY2t1cF9Ob2RlcyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQkJcGFyZW50X05vZGVzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnBhcmVudF9Ob2RlcyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQkJbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoubm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX2FkZHJlc3Nfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fYmFja3VwX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3BhcmVudF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9wb3J0X3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29ubGluZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9zZWN1cmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fdHlwZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWJhY2t1cDogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLmJhY2t1cChyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJcGFyZW50OiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMucGFyZW50KHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQl0eXBlOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMudHlwZShyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJbm9kZV9Db25maWdzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMubm9kZV9Db25maWdzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCWNhcnJpZXJfRXZlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuY2Fycmllcl9FdmVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJc2VuZGVyX0V2ZW50czogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLnNlbmRlcl9FdmVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJcmVjaXBpZW50X0V2ZW50czogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLnJlY2lwaWVudF9FdmVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJYmFja3VwX05vZGVzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuYmFja3VwX05vZGVzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCXBhcmVudF9Ob2RlczogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLnBhcmVudF9Ob2RlcygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQlub2RlX05vZGVfR3JvdXBfTWVtYmVyczogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ107CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJYWRkcmVzczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FkZHJlc3MnLCB1bmRlZmluZWQpIDogImFkZHJlc3MiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWRkcmVzc19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWRkcmVzcyhyZWYpOwoKCQkJfSwKCgkJCWJhY2t1cDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2JhY2t1cCcsIHVuZGVmaW5lZCkgOiAiYmFja3VwIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2JhY2t1cF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5iYWNrdXAoKSB8fCBuZXcgc2FsZXNub3cuTm9kZSgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuYmFja3VwKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgYmFja3VwIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQlwYXJlbnQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdwYXJlbnQnLCB1bmRlZmluZWQpIDogInBhcmVudCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9wYXJlbnRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMucGFyZW50KCkgfHwgbmV3IHNhbGVzbm93Lk5vZGUoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLnBhcmVudChvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIHBhcmVudCIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJcG9ydDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3BvcnQnLCB1bmRlZmluZWQpIDogInBvcnQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcG9ydF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucG9ydChyZWYpOwoKCQkJfSwKCgkJCW9ubGluZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29ubGluZScsIHVuZGVmaW5lZCkgOiAib25saW5lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29ubGluZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLm9ubGluZShyZWYpOwoKCQkJfSwKCgkJCXNlY3VyZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3NlY3VyZScsIHVuZGVmaW5lZCkgOiAic2VjdXJlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3NlY3VyZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuc2VjdXJlKHJlZik7CgoJCQl9LAoKCQkJdHlwZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpIDogInR5cGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fdHlwZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy50eXBlKCkgfHwgbmV3IHNhbGVzbm93Lk5vZGVfVHlwZSgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMudHlwZShvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIHR5cGUiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvZGUocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kYXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoJCQkJCWlmICh0eXBlb2YobW9tZW50KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZWYgPSBuZXcgRGF0ZShyZWYpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmVmID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpKTsKCQkJCX0KCQkJCXRoaXMuZGF0ZShyZWYpOwoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm5hbWUocmVmKTsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZW1hcmtfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnJlbWFyayhyZWYpOwoKCQkJfSwKCgkJCW5vZGVfQ29uZmlnczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25vZGVfTm9kZXMnLCB1bmRlZmluZWQpIDogIm5vZGVfQ29uZmlncyIpKSA9PiB0aGlzLm5vZGVfQ29uZmlncyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuQ29uZmlnKCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCQljYXJyaWVyX0V2ZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NhcnJpZXJfTm9kZXMnLCB1bmRlZmluZWQpIDogImNhcnJpZXJfRXZlbnRzIikpID0+IHRoaXMuY2Fycmllcl9FdmVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkV2ZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCQlzZW5kZXJfRXZlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnc2VuZGVyX05vZGVzJywgdW5kZWZpbmVkKSA6ICJzZW5kZXJfRXZlbnRzIikpID0+IHRoaXMuc2VuZGVyX0V2ZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuRXZlbnQoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJCXJlY2lwaWVudF9FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZWNpcGllbnRfTm9kZXMnLCB1bmRlZmluZWQpIDogInJlY2lwaWVudF9FdmVudHMiKSkgPT4gdGhpcy5yZWNpcGllbnRfRXZlbnRzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5FdmVudCgpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQkJYmFja3VwX05vZGVzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYmFja3VwX05vZGVzJywgdW5kZWZpbmVkKSA6ICJiYWNrdXBfTm9kZXMiKSkgPT4gdGhpcy5iYWNrdXBfTm9kZXMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJCXBhcmVudF9Ob2RlczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3BhcmVudF9Ob2RlcycsIHVuZGVmaW5lZCkgOiAicGFyZW50X05vZGVzIikpID0+IHRoaXMucGFyZW50X05vZGVzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5Ob2RlKCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCQlub2RlX05vZGVfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25vZGVfTm9kZXMnLCB1bmRlZmluZWQpIDogIm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzIikpID0+IHRoaXMubm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93Lk5vZGVfR3JvdXBfTWVtYmVyKCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddID0gdiwKCgkJCSJhZGRyZXNzIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FkZHJlc3MnLCB1bmRlZmluZWQpIDogImFkZHJlc3MiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWRkcmVzc19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWRkcmVzc19jb29wOwoJCQkJfQoJCQl9LAoKCQkJImJhY2t1cCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdiYWNrdXAnLCB1bmRlZmluZWQpIDogImJhY2t1cCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX2JhY2t1cF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYmFja3VwX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicGFyZW50IjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3BhcmVudCcsIHVuZGVmaW5lZCkgOiAicGFyZW50IikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fcGFyZW50X2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9wYXJlbnRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJwb3J0IjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3BvcnQnLCB1bmRlZmluZWQpIDogInBvcnQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcG9ydF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcG9ydF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9ubGluZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvbmxpbmUnLCB1bmRlZmluZWQpIDogIm9ubGluZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9vbmxpbmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29ubGluZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInNlY3VyZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzZWN1cmUnLCB1bmRlZmluZWQpIDogInNlY3VyZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9zZWN1cmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3NlY3VyZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInR5cGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkgOiAidHlwZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX3R5cGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3R5cGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCW5vZGVfQ29uZmlnczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25vZGVfTm9kZXMnLCB1bmRlZmluZWQpIDogIm5vZGVfQ29uZmlncyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9ub2RlX0NvbmZpZ3NfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25vZGVfQ29uZmlnc19jb29wOwoJCQkJfQoJCQl9LAoKCQkJY2Fycmllcl9FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjYXJyaWVyX05vZGVzJywgdW5kZWZpbmVkKSA6ICJjYXJyaWVyX0V2ZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9jYXJyaWVyX0V2ZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY2Fycmllcl9FdmVudHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJCXNlbmRlcl9FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzZW5kZXJfTm9kZXMnLCB1bmRlZmluZWQpIDogInNlbmRlcl9FdmVudHMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fc2VuZGVyX0V2ZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fc2VuZGVyX0V2ZW50c19jb29wOwoJCQkJfQoJCQl9LAoKCQkJcmVjaXBpZW50X0V2ZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlY2lwaWVudF9Ob2RlcycsIHVuZGVmaW5lZCkgOiAicmVjaXBpZW50X0V2ZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9yZWNpcGllbnRfRXZlbnRzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZWNpcGllbnRfRXZlbnRzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQliYWNrdXBfTm9kZXM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdiYWNrdXBfTm9kZXMnLCB1bmRlZmluZWQpIDogImJhY2t1cF9Ob2RlcyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9iYWNrdXBfTm9kZXNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2JhY2t1cF9Ob2Rlc19jb29wOwoJCQkJfQoJCQl9LAoKCQkJcGFyZW50X05vZGVzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncGFyZW50X05vZGVzJywgdW5kZWZpbmVkKSA6ICJwYXJlbnRfTm9kZXMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fcGFyZW50X05vZGVzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9wYXJlbnRfTm9kZXNfY29vcDsKCQkJCX0KCQkJfSwKCgkJCW5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbm9kZV9Ob2RlcycsIHVuZGVmaW5lZCkgOiAibm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCglieU5vZGUoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX2JhY2t1cCJdICYmIChhWyJfYmFja3VwIl0uRXF1YWxzID8gYVsiX2JhY2t1cCJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfYmFja3VwIl0sIHIpKSkgewoJCQkJCXIuX2JhY2t1cF9Ob2Rlcy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5Tm9kZShhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfcGFyZW50Il0gJiYgKGFbIl9wYXJlbnQiXS5FcXVhbHMgPyBhWyJfcGFyZW50Il0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9wYXJlbnQiXSwgcikpKSB7CgkJCQkJci5fcGFyZW50X05vZGVzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlOb2RlX1R5cGUoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX3R5cGUiXSAmJiAoYVsiX3R5cGUiXS5FcXVhbHMgPyBhWyJfdHlwZSJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfdHlwZSJdLCByKSkpIHsKCQkJCQlyLl90eXBlX05vZGVzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSBmYWxzZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLnR5cGUgPSB7fTsKCQkJaWYgKCF0aGlzLl90eXBlX3NldCkgZXJyb3IudHlwZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghdGhpcy50eXBlKCkpIGVycm9yLnR5cGVbIjAyIl0gPSAiRW1wdHkgVmFsdWUiOwoJCQlpZiAodGhpcy50eXBlKCkgJiYgYlN5bmMgJiYgIXRoaXMudHlwZSgpLl9fc3luY19vbigpKSBlcnJvci50eXBlWyIwMyJdID0gIk5vdCBpbiBTeW5jIjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IudHlwZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IudHlwZTsKCQl9CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSB0cnVlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IuY29kZSA9IHt9OwoJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSBlcnJvci5jb2RlWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5jb2RlKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5jb2RlOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5Ob2RlKG51bGwsIHRoaXMuVG9vbCk7CgoJCQkJbGV0IGJGaW5kID0gZmFsc2U7CgkJCQlpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLklkID0gdGhpcy5JZDsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5jb2RlKHRoaXMuY29kZSgpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24pID09PSAidW5kZWZpbmVkIiB8fCBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nQkVHSU4nOidTVEFSVCd9IFRSQU5TQUNUSU9OYCk7CgkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gPSB7CgkJCQkJCQlPd25lcjogdGhpcywKCQkJCQkJCXNxbHM6IFtdLAoJCQkJCQkJc3RhcnQ6IG5ldyBEYXRlKCksCgkJCQkJCQllbmQ6IG51bGwKCQkJCQkJfTsKCQkJCQl9CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fdHlwZV9zZXQpIHsKCQkJCQl0aGlzLnR5cGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gKCkgPT4gbmV3IG9TY29wZS5Ob2RlX1R5cGUoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5uYW1lKHR5cGVvZihnbG9iYWwpICE9PSAidW5kZWZpbmVkIiA/ICJOb2RlSlMiIDogIkJyb3dzZXIiKS5keW5hbWljKHR5cGVvZihnbG9iYWwpID09PSAidW5kZWZpbmVkIik7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSB7CgkJCQkJdGhpcy5hY3RpdmUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSB7CgkJCQkJdGhpcy5lbmFibGVkKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgewoJCQkJCXRoaXMuZGF0ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSBuZXcgRGF0ZSgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9iYWNrdXBfc2V0ICYmIHRoaXMuYmFja3VwKCkgJiYgIShhd2FpdCB0aGlzLmJhY2t1cCgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX2JhY2t1cCgpOwoKCQkJCQlpZiAodGhpcy5fcGFyZW50X3NldCAmJiB0aGlzLnBhcmVudCgpICYmICEoYXdhaXQgdGhpcy5wYXJlbnQoKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9wYXJlbnQoKTsKCgkJCQkJaWYgKHRoaXMuX3R5cGVfc2V0ICYmIHRoaXMudHlwZSgpICYmICEoYXdhaXQgdGhpcy50eXBlKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfdHlwZSgpOwoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9ub2RlX0NvbmZpZ3Nfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5ub2RlX0NvbmZpZ3MoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuX2NhcnJpZXJfRXZlbnRzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuY2Fycmllcl9FdmVudHMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuX3NlbmRlcl9FdmVudHNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5zZW5kZXJfRXZlbnRzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICh0aGlzLl9yZWNpcGllbnRfRXZlbnRzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMucmVjaXBpZW50X0V2ZW50cygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAodGhpcy5fYmFja3VwX05vZGVzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuYmFja3VwX05vZGVzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICh0aGlzLl9wYXJlbnRfTm9kZXNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5wYXJlbnRfTm9kZXMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMubm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCQlpZiAoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5Pd25lciA9PSB0aGlzKSB7CgkJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYENPTU1JVCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nIFRSQU5TQUNUSU9OJzonJ31gKTsKCQkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kID0gbmV3IERhdGUoKTsKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlLl9wYXJlbnQpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBpbnNlcnQoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGUudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlLl9wYXJlbnQpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGUuZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJcmV0ID0gKGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTChmaWVsZHMsIG9ianMpKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCk7CgkJCQlyZXQgPSByZXQgPyBbSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSldIDogW107CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5tYXAociA9PiBuZXcgc2FsZXNub3cuTm9kZShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93Lk5vZGVfR3JvdXAgPSBjbGFzcyBOb2RlX0dyb3VwIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUWlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpPYjJSbElqcDdJbTV2UkdWMFpXTjBJanAwY25WbExDSnBibWwwTG1WdVpITWlPaklzSW1sdWFYUXViRzl2Y0NJNk1DNDFMQ0owYjI5c2N5NXpkRzl5WlNJNlptRnNjMlVzSW1SbGRHVmpkRkJoY21WdWRDNUpVQ0k2SWpFNU5TNHhNVEl1TWpFMkxqRTNNeUlzSW1SbGRHVmpkRkJoY21WdWRDNWpiMlJsSWpvaVpUaGtaVEEyWlRObFpHTTBORE5oWlRsa1ptVXhaR1UxWldNMU1tRTBZbVlpTENKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjBzSWxSdmIyd2lPbnNpWjJsMGFIVmlMblJ2YjJ4eklqb2lhSFIwY0hNNkx5OXlZWGN1WjJsMGFIVmlkWE5sY21OdmJuUmxiblF1WTI5dEwyWmhaR2x1TDJaaFpHbHVMbWRwZEdoMVlpNXBieTl0WVhOMFpYSXZJaXdpYzJWamNtVjBJam9pYjFOTGQyZGFNbk5MUms5VVNVcGpZa0ZtVlVsUk5FTnFPWEZ6U0RRNGJtd2lMQ0p3YkdGNVozSnZkVzVrSWpwMGNuVmxMQ0puVWxCRElqcDBjblZsTENKemRHOXlaUzV6Wlc1emFYUnBkbWwwZVNJNk1Td2lZMjl0Y0dGdWVTSTZJbkpsYzNWdFpTSjlMQ0p6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpWYzJWeUlqcDdJbDloZFhSb2IzSnBlbVV1ZFhObGNtNWhiV1VpT2lKbVlXUnBJaXdpWDJGMWRHaHZjbWw2WlM1d1lYTnpkMjl5WkNJNklqRXlNeUlzSWw5aGRYUm9iM0pwZW1VdWRHVnpkRlZ6WlhJaU9uc2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0puWlc1a1pYSWlPbnNpWTI5a1pTSTZJazBpTENKdVlXMWxJam9pVFdGc1pTSjlMQ0pqYjJSbElqb2labUZrYVNJc0ltNWhiV1VpT2lKR1lXUnBJbjE5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpUY1d4RVFpSXNJa2RwZEVoMVlpSmRgKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLk1hcHBpbmdzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgVzEwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoKCQkvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUKCQl0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307CgkJdGhpcy5Ub29sID0gdG9vbDsKCQl0aGlzLklkID0gaWQ7CgoJCXRoaXMuVmFsdWVFbnRpdGllcyA9IFtdOwoKCQl0aGlzLkRhdGUgPSBudWxsOwoKCQl0aGlzLmNsZWFyX1RISVMoKTsKCQl0aGlzLkVudGl0eVZhbHVlcyA9IFtdOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiTm9kZSBHcm91cCIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJcmV0dXJuIHRoaXM7CgoJCSh0aGlzLmdyb3VwX05vZGVfR3JvdXBfTWVtYmVycygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoJY29kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb2RlICE9IHYpIHsKCQkJCXRoaXMuX2NvZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29kZSk7CgkJfQoJfQoKCWNsZWFyX2NvZGUoKSB7CgkJdGhpcy5fY29kZV9zZXQgPSBudWxsOwoJCXRoaXMuX2NvZGUgPSBudWxsOwoJCXRoaXMuX2NvZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCglkYXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImRhdGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJyA/IF92IDogKG5ldyBEYXRlKF92KSk7CgkJCQlpZiAoaXNOYU4oX3YuZ2V0VGltZSgpKSkgX3YgPSBudWxsOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuRGF0ZVZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RhdGUgIT0gdikgewoJCQkJdGhpcy5fZGF0ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkRhdGVWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGF0ZSk7CgkJfQoJfQoKCWNsZWFyX2RhdGUoKSB7CgkJdGhpcy5fZGF0ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2RhdGUgPSBudWxsOwoJCXRoaXMuX2RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoJbmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9uYW1lICE9IHYpIHsKCQkJCXRoaXMuX25hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX25hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbmFtZSk7CgkJfQoJfQoKCWNsZWFyX25hbWUoKSB7CgkJdGhpcy5fbmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX25hbWUgPSBudWxsOwoJCXRoaXMuX25hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCglyZW1hcmsodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9yZW1hcmtfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZW1hcmsiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3JlbWFyayAhPSB2KSB7CgkJCQl0aGlzLl9yZW1hcmtfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3JlbWFyayA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcmVtYXJrKTsKCQl9Cgl9CgoJY2xlYXJfcmVtYXJrKCkgewoJCXRoaXMuX3JlbWFya19zZXQgPSBudWxsOwoJCXRoaXMuX3JlbWFyayA9IG51bGw7CgkJdGhpcy5fcmVtYXJrX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMgKiovCglncm91cF9Ob2RlX0dyb3VwX01lbWJlcnModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX2dyb3VwX05vZGVfR3JvdXBfTWVtYmVyczsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnMjlmZjA1NzYtMTNmYS00Nzg0LTkxMGEtNGM1OWI0ODIxYzY4JyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdOb2RlIEdyb3VwIE1lbWJlcicpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fZ3JvdXBfc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzJywgJ0VudGl0eU9iamVjdCcsIDEsICJncm91cCBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiTm9kZV9Hcm91cF9NZW1iZXIiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMnLCAnRW50aXR5T2JqZWN0JywgMSwgImdyb3VwIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiTm9kZV9Hcm91cF9NZW1iZXIiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YuZ3JvdXAodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzLnB1c2goLi4udik7CgkJdGhpcy5fZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX2dyb3VwX05vZGVfR3JvdXBfTWVtYmVycygpIHsKCQl0aGlzLl9ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnNfc2V0ID0gbnVsbDsKCQl0aGlzLl9ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX2FjdGl2ZV9zZXQgPSB0aGlzLl9hY3RpdmVfc2V0OwoJCXJldC5fYWN0aXZlX2Nvb3AgPSB0aGlzLl9hY3RpdmVfY29vcDsKCQlyZXQuYWN0aXZlID0gdGhpcy5hY3RpdmUoKSA/IHRoaXMuYWN0aXZlKCkgOiB0aGlzLmFjdGl2ZSgpOwoKCQlyZXQuX2VuYWJsZWRfc2V0ID0gdGhpcy5fZW5hYmxlZF9zZXQ7CgkJcmV0Ll9lbmFibGVkX2Nvb3AgPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJcmV0LmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKSA/IHRoaXMuZW5hYmxlZCgpIDogdGhpcy5lbmFibGVkKCk7CgoJCXJldC5fY29kZV9zZXQgPSB0aGlzLl9jb2RlX3NldDsKCQlyZXQuX2NvZGVfY29vcCA9IHRoaXMuX2NvZGVfY29vcDsKCQlyZXQuY29kZSA9IHRoaXMuY29kZSgpID8gdGhpcy5jb2RlKCkgOiB0aGlzLmNvZGUoKTsKCgkJcmV0Ll9vcmRlcl9zZXQgPSB0aGlzLl9vcmRlcl9zZXQ7CgkJcmV0Ll9vcmRlcl9jb29wID0gdGhpcy5fb3JkZXJfY29vcDsKCQlyZXQub3JkZXIgPSB0aGlzLm9yZGVyKCkgPyB0aGlzLm9yZGVyKCkgOiB0aGlzLm9yZGVyKCk7CgoJCXJldC5fZGF0ZV9zZXQgPSB0aGlzLl9kYXRlX3NldDsKCQlyZXQuX2RhdGVfY29vcCA9IHRoaXMuX2RhdGVfY29vcDsKCQlyZXQuZGF0ZSA9IHRoaXMuZGF0ZSgpID8gdGhpcy5kYXRlKCkgOiB0aGlzLmRhdGUoKTsKCgkJcmV0Ll9uYW1lX3NldCA9IHRoaXMuX25hbWVfc2V0OwoJCXJldC5fbmFtZV9jb29wID0gdGhpcy5fbmFtZV9jb29wOwoJCXJldC5uYW1lID0gdGhpcy5uYW1lKCkgPyB0aGlzLm5hbWUoKSA6IHRoaXMubmFtZSgpOwoKCQlyZXQuX3JlbWFya19zZXQgPSB0aGlzLl9yZW1hcmtfc2V0OwoJCXJldC5fcmVtYXJrX2Nvb3AgPSB0aGlzLl9yZW1hcmtfY29vcDsKCQlyZXQucmVtYXJrID0gdGhpcy5yZW1hcmsoKSA/IHRoaXMucmVtYXJrKCkgOiB0aGlzLnJlbWFyaygpOwoKCQlyZXQuZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzID0gdGhpcy5ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCWdyb3VwX05vZGVfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwX05vZGVfR3JvdXBzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX3RvSGFzaCIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMuTm9Db2RlID8gb0hhc2ggOiB0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7Cgl9CgoJYXN5bmMgX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOwoKCX0KCglfcWxTZWxlY3Rpb25zKHNTZXQpIHsKCQlsZXQgcmV0ID0gW107CgkJaWYgKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7CgoJCXNTZXQuc2VsZWN0aW9ucy5maWx0ZXIocyA9PiBzLnNlbGVjdGlvblNldCkuZm9yRWFjaChzID0+IHsKCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpICE9ICdOb2RlX0dyb3VwJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL05vZGVfR3JvdXAvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQkJZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOwoJCQkJZGVsZXRlIGRhdGEuX190aGlzLm9ubGluZTsKCgkJCX0KCgkJCS8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/PwoKCQkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJCXRyeSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0pIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7bWV0aG9kfWApOwoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCWxldCBfaWQgPSBudWxsOwoJCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBkYXRhLCBtZXRob2QsIHt9KTsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRhdGEpID09PSAnc3RyaW5nJykgewoJCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUoZGF0YSk7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IGRhdGEuX190aGlzLmNvZGUgfHwgZGF0YS5pZCB8fCBkYXRhLklEOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJCWlmIChkYXRhLklkICYmIGRhdGEuSWQgPT0gZGF0YS5JZCkgewoJCQkJCQlfaWQgPSBkYXRhLklkOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQkJfSBlbHNlIGlmIChkYXRhLkVudGl0eUNsYXNzKSB7CgkJCQkJCV9pZCA9IGRhdGEuRW50aXR5Q2xhc3MuSWQgfHwgZGF0YS5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjRmMzIwMTg0LTk2MzYtNGRlNS1hOWJmLTk4YTg1MzMxNGQ3ZSIgfHwgIk5VTEwiOwoJCQkJCX0KCQkJCX0KCgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cCB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cFttZXRob2RdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwW21ldGhvZF0gfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwW21ldGhvZF1bX2lkXSB8fCB7fTsKCgkJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goe30sIHsKCQkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQkJfSk7CgoJCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cFttZXRob2RdW19pZF1bX2hhc2hdOwoJCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiA1KSkgewoJCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gbWV0aG9kIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJCXYucmV1c2VkKys7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhKTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cFttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnTm9kZV9Hcm91cCcpLnNlbmRlcihzYWxlc25vdy5fbm9kZSkuY2FycmllcihzYWxlc25vdy5fbm9kZSkucGF5bG9hZChkYXRhKTsKCQkJaWYgKGV2ZW50KSB7CgkJCQlpZiAoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7CgkJCQlpZiAoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7CgkJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7CgkJCQlpZiAoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7CgkJCX0KCQkJcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOwoKCQkJaWYgKHR5cGVvZihyZXQpID09PSAic3RyaW5nIikgewoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChleCkge30KCQkJfQoJCQlyZXR1cm4gcmV0OwoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93Lk5vZGVfR3JvdXAobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93Lk5vZGVfR3JvdXAobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuTm9kZV9Hcm91cCgpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOwoJCX0KCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgTm9kZV9Hcm91cC5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYE5vZGVfR3JvdXAuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cC5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlX0dyb3VwLicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlIHx8ICJOb2RlIEdyb3VwIik7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCS8vIHRoaXMuZ3JvdXBfTm9kZV9Hcm91cHMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Ob2RlX0dyb3VwKHRoaXMuSWQpCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5jb2RlKHRoaXMuY29kZSgpLCB0aGlzLl9jb2RlX2Nvb3ApCgoJCQkub3JkZXIodGhpcy5vcmRlcigpLCB0aGlzLl9vcmRlcl9jb29wKQoKCQkJLmRhdGUodGhpcy5kYXRlKCksIHRoaXMuX2RhdGVfY29vcCkKCgkJCS5uYW1lKHRoaXMubmFtZSgpLCB0aGlzLl9uYW1lX2Nvb3ApCgoJCQkucmVtYXJrKHRoaXMucmVtYXJrKCksIHRoaXMuX3JlbWFya19jb29wKQoKCQkJLmdyb3VwX05vZGVfR3JvdXBfTWVtYmVycyh0aGlzLmdyb3VwX05vZGVfR3JvdXBfTWVtYmVycygpLCB0aGlzLl9ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnNfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCkgewoJCWNvbnRleHQgPSBjb250ZXh0IHx8ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCW9iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQlvYmpUbyA9IG9ialRvIHx8IHt9OwoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAnTm9kZV9Hcm91cCc7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIk5vZGVfR3JvdXAiOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoJCQkJcmV0ID0gcmV0LnRvTG93ZXJDYXNlKCk7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMgPSB7fSkgewoJCXRyeSB7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCA/IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSBvcHRpb25zLnRvb2wgfHwgdCA9PSBvcHRpb25zLnRvb2wpIDogdGhpcy5Ub29sOwoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgfHwge307CgoJCQlsZXQgbklEID0gc2FsZXNub3cuX25vZGUgPyBzYWxlc25vdy5fbm9kZS5jb2RlKCkgOiAiZGVmYXVsdCI7CgoJCQlsZXQgcmV0ID0gbnVsbFZhbHVlOwoJCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXQgPSBudWxsOwoKCQkJLy8gdG9vbF9Db25maWdzOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIGRvbmUKCQkJbGV0IHRjb25mID0gKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmIGMubm9kZSAmJiBjLm5vZGUuY29kZSA9PSBuSUQpLmNvbmNhdCgob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgIWMubm9kZSkpOwoJCQlpZiAodGNvbmYubGVuZ3RoKSB7CgkJCQlyZXQgPSB0Y29uZlswXS52YWx1ZTsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoamV4KSB7fQoJCQl9CgoJCQkvLyBtb2RlbCBDb25maWc6IENvbmZpZyBpcyBjbGFzcyBsZXZlbCwgbm9kZSBub3QgcG9zc2libGUgLSBwZW5kaW5nCgkJCWxldCBtY29uZiA9IHRoaXMuQ29uZmlnID8gdGhpcy5Db25maWdbbl0gOiB1bmRlZmluZWQ7CgkJCWlmICh0eXBlb2YobWNvbmYpICE9PSAidW5kZWZpbmVkIikgcmV0ID0gbWNvbmY7CgoJCQkvLyBjb21tYW5kIGxpbmU6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnICYmIGdsb2JhbC5taW5pbWlzdCkgewoJCQkJcmV0ID0gZ2xvYmFsLm1pbmltaXN0KHByb2Nlc3MuYXJndi5zbGljZSgyKSlbbl0gfHwgcmV0OwoJCQl9CgoJCQkvLyByZXF1ZXN0OiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJcmV0ID0gdGhpcy4kX1JFUVVFU1QobikgfHwgcmV0OwoKCQkJaWYgKG9wdGlvbnMubmV3VmFsdWUpIHsKCQkJCWxldCB0YyA9IHRjb25mLmxlbmd0aCA/IHRjb25mWzBdIDoge307CgkJCQl0Yy5ub2RlID0gewoJCQkJCWNvZGU6IG9wdGlvbnMubm9kZS5jb2RlKCkKCQkJCX07CgkJCQl0Yy52YWx1ZSA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCQl0Yy5uYW1lID0gbjsKCQkJCWlmICghdGNvbmYubGVuZ3RoKSB7CgkJCQkJb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncy5wdXNoKHRjKTsKCQkJCX0KCQkJCXJldCA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCX0KCgkJCS8vIGNvbmZpZyByZXBsYWNlbWVudAoJCQlpZiAodHlwZW9mKHJldCkgPT09ICdzdHJpbmcnKShyZXQubWF0Y2gobmV3IFJlZ0V4cChge3soW159XSspfX1gLCAiZyIpKSB8fCBbXSkuZm9yRWFjaChtID0+IHJldCA9IHJldC5yZXBsYWNlKG0sIHRoaXMuX19jb25maWcobS5yZXBsYWNlKCd7eycsICcnKS5yZXBsYWNlKCd9fScsICcnKSwgbnVsbCwgb3B0aW9ucykpKTsKCgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19jb25maWcnLCAnRW50aXR5T2JqZWN0JywgMSwgbiwgbnVsbFZhbHVlLCBvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLCBleCk7CgkJfQoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qTm9kZV9Hcm91cCovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQlncm91cF9Ob2RlX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cF9Ob2RlX0dyb3VwcycsIHVuZGVmaW5lZCkpID0+IG9iai5zcWwgPSB2Lm1hcChfdiA9PiBfdi5fdG9TUUxUYWJsZSgpKSArIG9iai5zcWwsCgoJCX0sICJfdG9TUUxUYWJsZSIpOwoKCQkvLyByZXQuc3FsICs9ICcvKk5vZGVfR3JvdXAqLyk7XG4nOwoKCQlyZXQuc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChyZXQuc3FsKSA6IHJldC5zcWw7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NRTFRhYmxlJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldC5zcWwpOwoJCXJldHVybiByZXQuc3FsOwoJfQoKCV9mcm9tU1FMVGFibGUodGFibGUsIGZpZWxkcykgewoJCS8vIHRhYmxlIGlzIGEganNvbiBhcnJheQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5hY3RpdmUodGFibGVbImFjdGl2ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5lbmFibGVkKHRhYmxlWyJlbmFibGVkIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvZGUodGFibGVbImNvZGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9yZGVyKHRhYmxlWyJvcmRlciJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5kYXRlKHRhYmxlWyJkYXRlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm5hbWUodGFibGVbIm5hbWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5yZW1hcmsodGFibGVbInJlbWFyayJdKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIF9zcWwoc3FsLCBzb3VyY2UgPSB0aGlzKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWwoc3FsLCB0aGlzKTsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgoJCQkJCS8vIGlmKHRoaXNbJ18nK2ZpZWxkKydfc2V0J10gJiYgKHR5cGVvZih0aGlzWydfJytmaWVsZF0pPT09J3VuZGVmaW5lZCcgfHwgdGhpc1snXycrZmllbGRdPT1udWxsKSkgcmV0dXJuOwoJCQkJCS8vIGlmKHR5cGVvZihlYU9iaik9PT0ndW5kZWZpbmVkJykgcmV0dXJuOyAvLyB3aHk/CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlyZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqLCB0aGlzLmNvZGUoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmosIHRoaXMuZGF0ZSgpKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmosIHRoaXMubmFtZSgpKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaiwgdGhpcy5yZW1hcmsoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI0ZjMyMDE4NC05NjM2LTRkZTUtYTliZi05OGE4NTMzMTRkN2UiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cCB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cFtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCV9vcHRpb25zKCJncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMiLCBvYmosIHRoaXMuZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzKCkpOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJOb2RlX0dyb3VwIiAmJiAobS50YXJnZXQgfHwgbS5vdXRTY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkgJiYgKCFtLnNvdXJjZSB8fCAobS5zb3VyY2UgJiYgLyohbS5vdXRTY3JpcHQgJiYqLyB0aGlzWydfJyArIG0uc291cmNlICsgJ19zZXQnXSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0ub3V0U2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5vdXRTY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5vdXRTY3JpcHR9KX1gKSh0aGlzLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS5zb3VyY2UpIHsKCQkJCWlmIChtLnNvdXJjZS5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMpID0+IHtyZXR1cm4gX3RoaXMuJHttLnNvdXJjZX07fWApKHRoaXMpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS5zb3VyY2UsIHRoaXMpOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnRhcmdldCkgb2JqW20udGFyZ2V0XSA9IHJldDsKCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJW20udGFyZ2V0IHx8IG0uc291cmNlXTogdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddCgkJCX0pOwoJCX0pOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCS8vIHVzZSB0aGlzLl9tYXAoKSB3aXRoIHJldmVyc2UKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmopOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiNGYzMjAxODQtOTYzNi00ZGU1LWE5YmYtOThhODUzMzE0ZDdlIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXAgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXAgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cFtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cFtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cFtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcyk7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cFtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJOb2RlX0dyb3VwIiAmJiAobS5zb3VyY2UgfHwgbS5pblNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLmluU2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaiwgb1Njb3BlLCBtYXApID0+IHske20uaW5TY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5pblNjcmlwdH0pfWApKG9iaiwgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0udGFyZ2V0KSB7CgkJCQlpZiAobS50YXJnZXQuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaikgPT4ge3JldHVybiBvYmouJHttLnRhcmdldH07fWApKG9iaik7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmpbbS50YXJnZXRdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS50YXJnZXQsIG9iaik7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS5zb3VyY2UpIHsKCQkJCWlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0ocmV0KTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0gPSByZXQ7CgkJCQl9CgkJCX0KCQl9KTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXTogIiciICsgdGhpcy5JZCArICInIgoJCX07CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2FjdGl2ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hY3RpdmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9lbmFibGVkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY29kZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jb2RlKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fb3JkZXJfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMub3JkZXIoKTsKCgkJCWZWYWx1ZSA9IHYgfHwgJzAnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZGF0ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5kYXRlKCk7CgoJCQl0cnkgewoJCQkJZlZhbHVlID0gIiciICsgKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiAiMTk3MC0xLTEiKSArICInIjsKCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJykgewoJCQkJCWZWYWx1ZSA9IGBTVFJfVE9fREFURSgke2ZWYWx1ZX0sICclWS0lbS0lZFQlVC4lZlonKWA7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9ICdkYXRldGltZSgnICsgZlZhbHVlICsgJyknOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9uYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm5hbWUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcmVtYXJrX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnJlbWFyaygpOwoKCQkJZlZhbHVlID0gIiciICsgKCh2ICYmIHYucmVwbGFjZSkgPyB2LnJlcGxhY2UoL1wnL2csICJcJ1wnIikgOiB2KSArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJyB8fCB0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIHsKCQkJX28gPSBfcSA9ICdgJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3Fsc2VydmVyJykgewoJCQlfbyA9ICdbJzsKCQkJX3EgPSAnXSc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCdhcGlLZXknKSA9PSAnYWlydGFibGUnKSB7CgkJCV9vID0gJ3snOwoJCQlfcSA9ICd9JzsKCQl9CgkJdGhpcy5fX1EgPSB0aGlzLl9fUSA9PSBfbyA/IF9xIDogX287CgkJcmV0dXJuIHRoaXMuX19ROwoJfQoKCV9maWVsZEdyb3VwcyhmZ3MgPSB7fSkgewoJCXRoaXMuX19maWVsZEdyb3VwcyA9IGZnczsKCQlyZXR1cm4gdGhpczsKCX0KCglfZmllbGRBZ2dyZWdhdGVzKGZhcyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkQWdncmVnYXRlcyA9IGZhczsKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9GaWVsZHNTUUwoZmllbGRzKSB7CgoJCWZpZWxkcyA9IGZpZWxkcyB8fCBbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJywgdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCldOwoJCWZpZWxkcyA9IEFycmF5LmlzQXJyYXkoZmllbGRzKSA/IGZpZWxkcyA6IFtmaWVsZHNdOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCS8vIHtmaWVsZDogb3JkZXJ9CgkJCWZpZWxkcyA9IFtdOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU51bGw6IHRydWUsCgoJCX0sICJfdG9TZWxlY3RIZWFkZXIiKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0SGVhZGVyJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU2VsZWN0U1FMKGZpZWxkcykgewoJCWxldCBzcWwgPSAic2VsZWN0ICI7CgoJCWxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9YDsKCgkJbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7CgkJc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOwoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOwoKCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcykgewoJCQkvLyB7ZmllbGQ6IGZ1bmN0aW9ufQoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jb2RlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fb3JkZXJfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vcmRlcl9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9kYXRlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LnRvSVNPU3RyaW5nKSB7CgkJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3FsaXRlJykgewoJCQkJCQlvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbmFtZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX25hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3JlbWFya19zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXBfTm9kZV9Hcm91cHMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2dyb3VwX05vZGVfR3JvdXBfTWVtYmVyc19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoImdyb3VwLmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX2dyb3VwX05vZGVfR3JvdXBfTWVtYmVyc19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnNfY29vcCA9PSAnPScgfHwgdGhpcy5fZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKmdyb3VwX05vZGVfR3JvdXBfTWVtYmVycyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJfSwgIl90b1NlbGVjdFNRTCIsIGZpZWxkcykuc3FsOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCWlmIChPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXBfTm9kZV9Hcm91cHMnLCB1bmRlZmluZWQpKSA9PiBvYmouZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTm9kZV9Hcm91cCkgcmV0dXJuOwoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5Ob2RlX0dyb3VwID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5Ob2RlX0dyb3VwKCkKCgkJCQkJLmdyb3VwX05vZGVfR3JvdXBfTWVtYmVycyhuZXcgc2FsZXNub3cuTm9kZV9Hcm91cF9NZW1iZXIoKSkKCgkJCQkJLl90b1NRTFRhYmxlKGRlcHRoKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIk5vZGUgR3JvdXAiKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCWdyb3VwX05vZGVfR3JvdXBfTWVtYmVyczogKG9iaiwgdikgPT4gewoJCQkJCW9iai5ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMgPSB2Lm1hcChfdiA9PiBxdWVyeS5ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWdyb3VwX05vZGVfR3JvdXBfTWVtYmVyczogKG9iaiwgdikgPT4gewoJCQkJCW9iai5ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ107CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXBfTm9kZV9Hcm91cHMnLCB1bmRlZmluZWQpIDogImdyb3VwX05vZGVfR3JvdXBfTWVtYmVycyIpKSA9PiB0aGlzLmdyb3VwX05vZGVfR3JvdXBfTWVtYmVycyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuTm9kZV9Hcm91cF9NZW1iZXIoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX1RISVM6IChvYmosIHYpID0+IHsKCQkJCWlmIChiVG9vbCkgcmV0dXJuOwoJCQkJb2JqLlRISVMgPSB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQlvYmouT1BFUkFUT1JTLlRISVMgPSB0aGlzLl9USElTX2Nvb3A7CgkJCX0sCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ10gPSB2LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQkJZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXBfTm9kZV9Hcm91cHMnLCB1bmRlZmluZWQpIDogImdyb3VwX05vZGVfR3JvdXBfTWVtYmVycyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2dyb3VwX05vZGVfR3JvdXBfTWVtYmVyc19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSB0cnVlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlX0dyb3VwLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5Ob2RlX0dyb3VwKG51bGwsIHRoaXMuVG9vbCk7CgoJCQkJbGV0IGJGaW5kID0gZmFsc2U7CgkJCQlpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLklkID0gdGhpcy5JZDsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5uYW1lKHRoaXMubmFtZSgpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24pID09PSAidW5kZWZpbmVkIiB8fCBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nQkVHSU4nOidTVEFSVCd9IFRSQU5TQUNUSU9OYCk7CgkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gPSB7CgkJCQkJCQlPd25lcjogdGhpcywKCQkJCQkJCXNxbHM6IFtdLAoJCQkJCQkJc3RhcnQ6IG5ldyBEYXRlKCksCgkJCQkJCQllbmQ6IG51bGwKCQkJCQkJfTsKCQkJCQl9CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCQlpZiAoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5Pd25lciA9PSB0aGlzKSB7CgkJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYENPTU1JVCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nIFRSQU5TQUNUSU9OJzonJ31gKTsKCQkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kID0gbmV3IERhdGUoKTsKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlLl9wYXJlbnQpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBpbnNlcnQoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlX0dyb3VwLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGVfR3JvdXAudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlLl9wYXJlbnQpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGVfR3JvdXAuZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJcmV0ID0gKGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTChmaWVsZHMsIG9ianMpKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCk7CgkJCQlyZXQgPSByZXQgPyBbSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSldIDogW107CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5tYXAociA9PiBuZXcgc2FsZXNub3cuTm9kZV9Hcm91cChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93Lk5vZGVfR3JvdXBfTWVtYmVyID0gY2xhc3MgTm9kZV9Hcm91cF9NZW1iZXIgZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRaWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5Sk9iMlJsSWpwN0ltNXZSR1YwWldOMElqcDBjblZsTENKcGJtbDBMbVZ1WkhNaU9qSXNJbWx1YVhRdWJHOXZjQ0k2TUM0MUxDSjBiMjlzY3k1emRHOXlaU0k2Wm1Gc2MyVXNJbVJsZEdWamRGQmhjbVZ1ZEM1SlVDSTZJakU1TlM0eE1USXVNakUyTGpFM015SXNJbVJsZEdWamRGQmhjbVZ1ZEM1amIyUmxJam9pWlRoa1pUQTJaVE5sWkdNME5ETmhaVGxrWm1VeFpHVTFaV00xTW1FMFltWWlMQ0p6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMHNJbFJ2YjJ3aU9uc2laMmwwYUhWaUxuUnZiMnh6SWpvaWFIUjBjSE02THk5eVlYY3VaMmwwYUhWaWRYTmxjbU52Ym5SbGJuUXVZMjl0TDJaaFpHbHVMMlpoWkdsdUxtZHBkR2gxWWk1cGJ5OXRZWE4wWlhJdklpd2ljMlZqY21WMElqb2liMU5MZDJkYU1uTkxSazlVU1VwallrRm1WVWxSTkVOcU9YRnpTRFE0Ym13aUxDSndiR0Y1WjNKdmRXNWtJanAwY25WbExDSm5VbEJESWpwMGNuVmxMQ0p6ZEc5eVpTNXpaVzV6YVhScGRtbDBlU0k2TVN3aVkyOXRjR0Z1ZVNJNkluSmxjM1Z0WlNKOUxDSnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc0lrZHBkRWgxWWlKZGApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZ3JvdXAiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2dyb3VwKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibm9kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbm9kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiTm9kZSBHcm91cCBNZW1iZXIiLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCXJldHVybiB0aGlzOwoKCQlpZiAodGhpcy5fZ3JvdXBfc2V0ICYmIHRoaXMuX2dyb3VwKSB0aGlzLl9ncm91cC5Ub29sID0gdG9vbDsKCgkJaWYgKHRoaXMuX25vZGVfc2V0ICYmIHRoaXMuX25vZGUpIHRoaXMuX25vZGUuVG9vbCA9IHRvb2w7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBncm91cCAqKi8KCWdyb3VwKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZ3JvdXBfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJncm91cCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzRmMzIwMTg0LTk2MzYtNGRlNS1hOWJmLTk4YTg1MzMxNGQ3ZScgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ05vZGUgR3JvdXAnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ3JvdXAnLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICI0ZjMyMDE4NC05NjM2LTRkZTUtYTliZi05OGE4NTMzMTRkN2UiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiTm9kZSBHcm91cCIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9ncm91cCAhPSB2KSB7CgkJCQl0aGlzLl9ncm91cF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dyb3VwJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9ncm91cCA/IHRoaXMuX2dyb3VwLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9ncm91cF9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fZ3JvdXAgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZ3JvdXApOwoJCX0KCX0KCgljbGVhcl9ncm91cCgpIHsKCQl0aGlzLl9ncm91cF9zZXQgPSBudWxsOwoJCXRoaXMuX2dyb3VwID0gbnVsbDsKCQl0aGlzLl9ncm91cF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXAgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBub2RlICoqLwoJbm9kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25vZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJub2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnYzZiMTRiNGUtZTUxZC00ZGJhLWFmYjgtYWM0NzhmNGI0ZTc2JyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnTm9kZScpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdub2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiYzZiMTRiNGUtZTUxZC00ZGJhLWFmYjgtYWM0NzhmNGI0ZTc2IiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIk5vZGUiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbm9kZSAhPSB2KSB7CgkJCQl0aGlzLl9ub2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnbm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fbm9kZSA/IHRoaXMuX25vZGUuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX25vZGVfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX25vZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbm9kZSk7CgkJfQoJfQoKCWNsZWFyX25vZGUoKSB7CgkJdGhpcy5fbm9kZV9zZXQgPSBudWxsOwoJCXRoaXMuX25vZGUgPSBudWxsOwoJCXRoaXMuX25vZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5vZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoJY29kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb2RlICE9IHYpIHsKCQkJCXRoaXMuX2NvZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29kZSk7CgkJfQoJfQoKCWNsZWFyX2NvZGUoKSB7CgkJdGhpcy5fY29kZV9zZXQgPSBudWxsOwoJCXRoaXMuX2NvZGUgPSBudWxsOwoJCXRoaXMuX2NvZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCglkYXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImRhdGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJyA/IF92IDogKG5ldyBEYXRlKF92KSk7CgkJCQlpZiAoaXNOYU4oX3YuZ2V0VGltZSgpKSkgX3YgPSBudWxsOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuRGF0ZVZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RhdGUgIT0gdikgewoJCQkJdGhpcy5fZGF0ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkRhdGVWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGF0ZSk7CgkJfQoJfQoKCWNsZWFyX2RhdGUoKSB7CgkJdGhpcy5fZGF0ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2RhdGUgPSBudWxsOwoJCXRoaXMuX2RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoJbmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9uYW1lICE9IHYpIHsKCQkJCXRoaXMuX25hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX25hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbmFtZSk7CgkJfQoJfQoKCWNsZWFyX25hbWUoKSB7CgkJdGhpcy5fbmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX25hbWUgPSBudWxsOwoJCXRoaXMuX25hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCglyZW1hcmsodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9yZW1hcmtfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZW1hcmsiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3JlbWFyayAhPSB2KSB7CgkJCQl0aGlzLl9yZW1hcmtfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3JlbWFyayA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcmVtYXJrKTsKCQl9Cgl9CgoJY2xlYXJfcmVtYXJrKCkgewoJCXRoaXMuX3JlbWFya19zZXQgPSBudWxsOwoJCXRoaXMuX3JlbWFyayA9IG51bGw7CgkJdGhpcy5fcmVtYXJrX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9ncm91cF9zZXQsCgoJCQl0aGlzLl9ub2RlX3NldCwKCgkJCXRoaXMuX2FjdGl2ZV9zZXQsCgoJCQl0aGlzLl9lbmFibGVkX3NldCwKCgkJCXRoaXMuX2NvZGVfc2V0LAoKCQkJdGhpcy5fb3JkZXJfc2V0LAoKCQkJdGhpcy5fZGF0ZV9zZXQsCgoJCQl0aGlzLl9uYW1lX3NldCwKCgkJCXRoaXMuX3JlbWFya19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9ncm91cF9zZXQgPSB0aGlzLl9ncm91cF9zZXQ7CgkJcmV0Ll9ncm91cF9jb29wID0gdGhpcy5fZ3JvdXBfY29vcDsKCQlyZXQuZ3JvdXAgPSB0aGlzLmdyb3VwKCkgPyB0aGlzLmdyb3VwKCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMuZ3JvdXAoKTsKCgkJcmV0Ll9ub2RlX3NldCA9IHRoaXMuX25vZGVfc2V0OwoJCXJldC5fbm9kZV9jb29wID0gdGhpcy5fbm9kZV9jb29wOwoJCXJldC5ub2RlID0gdGhpcy5ub2RlKCkgPyB0aGlzLm5vZGUoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5ub2RlKCk7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImdyb3VwIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkibm9kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQl9LCAiX3RvSGFzaCIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMuTm9Db2RlID8gb0hhc2ggOiB0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7Cgl9CgoJYXN5bmMgX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOwoKCX0KCglfcWxTZWxlY3Rpb25zKHNTZXQpIHsKCQlsZXQgcmV0ID0gW107CgkJaWYgKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7CgoJCXNTZXQuc2VsZWN0aW9ucy5maWx0ZXIocyA9PiBzLnNlbGVjdGlvblNldCkuZm9yRWFjaChzID0+IHsKCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gImdyb3VwIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBncm91cCcsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuTm9kZV9Hcm91cCgpLmdyb3VwX05vZGVfR3JvdXBfTWVtYmVycyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gIm5vZGUiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIG5vZGUnLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5ub2RlX05vZGVfR3JvdXBfTWVtYmVycyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpICE9ICdOb2RlX0dyb3VwX01lbWJlcicpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCXJldHVybiBuZXcgc2FsZXNub3dbZXZlbnQuY2xhc3NOYW1lKCldKCkuX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdyk7CgkJCX0KCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9Ob2RlX0dyb3VwX01lbWJlci8ke21ldGhvZH1gLCBkYXRhLCBjb25maWcpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQl9CgkJfSBlbHNlIHsKCgkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMuX19nZW5lcmF0ZWQ7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMub25saW5lOwoKCQkJfQoKCQkJLy93aHkgZG8gd2UgbmVlZCB0aGlzPz8/CgoJCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQkJdHJ5IHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHttZXRob2R9YCk7CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJbGV0IF9pZCA9IG51bGw7CgkJCQlpZiAodHlwZW9mKGRhdGEpID09PSAndW5kZWZpbmVkJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIGRhdGEsIG1ldGhvZCwge30pOwoJCQkJCXJldHVybiBkYXRhOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoZGF0YSkgPT09ICdzdHJpbmcnKSB7CgkJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShkYXRhKTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gZGF0YS5fX3RoaXMuY29kZSB8fCBkYXRhLmlkIHx8IGRhdGEuSUQ7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQkJaWYgKGRhdGEuSWQgJiYgZGF0YS5JZCA9PSBkYXRhLklkKSB7CgkJCQkJCV9pZCA9IGRhdGEuSWQ7CgkJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCQl9IGVsc2UgaWYgKGRhdGEuRW50aXR5Q2xhc3MpIHsKCQkJCQkJX2lkID0gZGF0YS5FbnRpdHlDbGFzcy5JZCB8fCBkYXRhLkVudGl0eUNsYXNzLk5hbWU7CgkJCQkJfSBlbHNlIHsKCQkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiMjlmZjA1NzYtMTNmYS00Nzg0LTkxMGEtNGM1OWI0ODIxYzY4IiB8fCAiTlVMTCI7CgkJCQkJfQoJCQkJfQoKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlciA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXIgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyW21ldGhvZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyW21ldGhvZF0gfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyW21ldGhvZF1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXJbbWV0aG9kXVtfaWRdIHx8IHt9OwoKCQkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaCh7fSwgewoJCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCQl9KTsKCgkJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlclttZXRob2RdW19pZF1bX2hhc2hdOwoJCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiA1KSkgewoJCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gbWV0aG9kIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJCXYucmV1c2VkKys7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhKTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXJbbWV0aG9kXVtfaWRdW19oYXNoXSA9IHsKCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeSh7fSksCgkJCQkJb2JqOiBkYXRhLAoJCQkJCXJldXNlZDogMCwKCQkJCX07CgkJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZGF0YSwgbWV0aG9kLCB7fSwgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBUcmlnZ2VycmluZyAke21ldGhvZH0gdG8gJHtuLmNvZGUoKX0gJHtKU09OLnN0cmluZ2lmeShkYXRhLG51bGwsNCl9YCk7CgoJCQlsZXQgZXYgPSBuZXcgc2FsZXNub3cuRXZlbnQoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSh0aGlzLl9fY29uZmlnKCdldmVudCcpIHx8ICdzYWxlc25vdy5FdmVudCcpLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnJlY2lwaWVudChuKS5tZXRob2QobWV0aG9kKS5jbGFzc05hbWUoJ05vZGVfR3JvdXBfTWVtYmVyJykuc2VuZGVyKHNhbGVzbm93Ll9ub2RlKS5jYXJyaWVyKHNhbGVzbm93Ll9ub2RlKS5wYXlsb2FkKGRhdGEpOwoJCQlpZiAoZXZlbnQpIHsKCQkJCWlmIChldmVudC5fcmVzcG9uc2VUb19zZXQpIGV2LnJlc3BvbnNlVG8oZXZlbnQucmVzcG9uc2VUbygpKTsKCQkJCWlmIChldmVudC5fc2VuZGVyX3NldCkgZXYuc2VuZGVyKGV2ZW50LnNlbmRlcigpKTsKCQkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCkgZXYuY2xhc3NOYW1lKGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCWlmIChldmVudC5fY2Fycmllcl9zZXQgfHwgZXZlbnQuX3NlbmRlcl9zZXQpIGV2LmNhcnJpZXIoZXZlbnQuY2FycmllcigpIHx8IGV2ZW50LnNlbmRlcigpKTsKCQkJfQoJCQlyZXQgPSBhd2FpdCBldi50cmlnZ2VyKCk7CgoJCQlpZiAodHlwZW9mKHJldCkgPT09ICJzdHJpbmciKSB7CgkJCQl0cnkgewoJCQkJCXJldCA9IEpTT04ucGFyc2UocmV0KTsKCQkJCX0gY2F0Y2ggKGV4KSB7fQoJCQl9CgkJCXJldHVybiByZXQ7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5zZXJ0IjoKCQkJY2FzZSAidXBkYXRlIjoKCQkJY2FzZSAic3RvcmUiOgoJCQljYXNlICJkZWxldGUiOgoJCQljYXNlICJmaW5kIjogewoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuTm9kZV9Hcm91cF9NZW1iZXIobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93Lk5vZGVfR3JvdXBfTWVtYmVyKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX25vZGUpIHsKCQkJLy8gcHJvYmFibHkgc2hvdWxkIG5vdCBiZSBwcm9jZXNzZWQgaGVyZSwgYnV0IHJhdGhlciBjb25zdW1lZCBhcyBwYXJ0IG9mIHRoZSBleGVjdXRlKCkgbG9naWMsIHB1c2hpbmcgX19ub2RlIHRvIHRoZSBsaXN0IG9mIG15IG5vZGVzIHRvIGRlbGVnYXRlIHRvIT8KCQkJbGV0IHRuID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX19ub2RlKS5fZGVSZWZlcmVuY2UoKTsKCQkJZGVsZXRlIF9wYXJhbXMuX19ub2RlOwoJCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93Lk5vZGVfR3JvdXBfTWVtYmVyKCkuX2ludm9rZU5vZGUodG4sIG1ldGhvZCwgX3BhcmFtcyk7CgkJfQoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBOb2RlX0dyb3VwX01lbWJlci5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYE5vZGVfR3JvdXBfTWVtYmVyLl9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQlpZiAoZmFsc2UgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCXJldCA9IHsKCQkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCQknLTQnOiAiVW5jb21taXR0ZWQgdHJhbnNhY3Rpb25zOiAiICsgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5zcWxzLmxlbmd0aCwKCQkJCQkJJ29iaic6IG9iagoJCQkJCX0KCQkJCX0KCQkJfQoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyLl90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGVfR3JvdXBfTWVtYmVyLicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlIHx8ICJOb2RlIEdyb3VwIE1lbWJlciIpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQlpZiAodGhpcy5fZ3JvdXBfc2V0ICYmIHRoaXMuZ3JvdXAoKSkgdGhpcy5ncm91cCgpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl9ub2RlX3NldCAmJiB0aGlzLm5vZGUoKSkgdGhpcy5ub2RlKCkuX19zeW5jX29uKGQpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Ob2RlX0dyb3VwX01lbWJlcih0aGlzLklkKQoKCQkJLmdyb3VwKHRoaXMuZ3JvdXAoKSwgdGhpcy5fZ3JvdXBfY29vcCkKCgkJCS5ub2RlKHRoaXMubm9kZSgpLCB0aGlzLl9ub2RlX2Nvb3ApCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5jb2RlKHRoaXMuY29kZSgpLCB0aGlzLl9jb2RlX2Nvb3ApCgoJCQkub3JkZXIodGhpcy5vcmRlcigpLCB0aGlzLl9vcmRlcl9jb29wKQoKCQkJLmRhdGUodGhpcy5kYXRlKCksIHRoaXMuX2RhdGVfY29vcCkKCgkJCS5uYW1lKHRoaXMubmFtZSgpLCB0aGlzLl9uYW1lX2Nvb3ApCgoJCQkucmVtYXJrKHRoaXMucmVtYXJrKCksIHRoaXMuX3JlbWFya19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCW9ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdOb2RlX0dyb3VwX01lbWJlcic7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIk5vZGVfR3JvdXBfTWVtYmVyIjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCQkJCXJldCA9IHJldC50b0xvd2VyQ2FzZSgpOwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCQl0cnkgewoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgPyAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gb3B0aW9ucy50b29sIHx8IHQgPT0gb3B0aW9ucy50b29sKSA6IHRoaXMuVG9vbDsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sIHx8IHt9OwoKCQkJbGV0IG5JRCA9IHNhbGVzbm93Ll9ub2RlID8gc2FsZXNub3cuX25vZGUuY29kZSgpIDogImRlZmF1bHQiOwoKCQkJbGV0IHJldCA9IG51bGxWYWx1ZTsKCQkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0ID0gbnVsbDsKCgkJCS8vIHRvb2xfQ29uZmlnczogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBkb25lCgkJCWxldCB0Y29uZiA9IChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiBjLm5vZGUgJiYgYy5ub2RlLmNvZGUgPT0gbklEKS5jb25jYXQoKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmICFjLm5vZGUpKTsKCQkJaWYgKHRjb25mLmxlbmd0aCkgewoJCQkJcmV0ID0gdGNvbmZbMF0udmFsdWU7CgkJCQl0cnkgewoJCQkJCXJldCA9IEpTT04ucGFyc2UocmV0KTsKCQkJCX0gY2F0Y2ggKGpleCkge30KCQkJfQoKCQkJLy8gbW9kZWwgQ29uZmlnOiBDb25maWcgaXMgY2xhc3MgbGV2ZWwsIG5vZGUgbm90IHBvc3NpYmxlIC0gcGVuZGluZwoJCQlsZXQgbWNvbmYgPSB0aGlzLkNvbmZpZyA/IHRoaXMuQ29uZmlnW25dIDogdW5kZWZpbmVkOwoJCQlpZiAodHlwZW9mKG1jb25mKSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IG1jb25mOwoKCQkJLy8gY29tbWFuZCBsaW5lOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiBnbG9iYWwubWluaW1pc3QpIHsKCQkJCXJldCA9IGdsb2JhbC5taW5pbWlzdChwcm9jZXNzLmFyZ3Yuc2xpY2UoMikpW25dIHx8IHJldDsKCQkJfQoKCQkJLy8gcmVxdWVzdDogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCXJldCA9IHRoaXMuJF9SRVFVRVNUKG4pIHx8IHJldDsKCgkJCWlmIChvcHRpb25zLm5ld1ZhbHVlKSB7CgkJCQlsZXQgdGMgPSB0Y29uZi5sZW5ndGggPyB0Y29uZlswXSA6IHt9OwoJCQkJdGMubm9kZSA9IHsKCQkJCQljb2RlOiBvcHRpb25zLm5vZGUuY29kZSgpCgkJCQl9OwoJCQkJdGMudmFsdWUgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQkJdGMubmFtZSA9IG47CgkJCQlpZiAoIXRjb25mLmxlbmd0aCkgewoJCQkJCW9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MucHVzaCh0Yyk7CgkJCQl9CgkJCQlyZXQgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQl9CgoJCQkvLyBjb25maWcgcmVwbGFjZW1lbnQKCQkJaWYgKHR5cGVvZihyZXQpID09PSAnc3RyaW5nJykocmV0Lm1hdGNoKG5ldyBSZWdFeHAoYHt7KFtefV0rKX19YCwgImciKSkgfHwgW10pLmZvckVhY2gobSA9PiByZXQgPSByZXQucmVwbGFjZShtLCB0aGlzLl9fY29uZmlnKG0ucmVwbGFjZSgne3snLCAnJykucmVwbGFjZSgnfX0nLCAnJyksIG51bGwsIG9wdGlvbnMpKSk7CgoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fY29uZmlnJywgJ0VudGl0eU9iamVjdCcsIDEsIG4sIG51bGxWYWx1ZSwgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncywgZXgpOwoJCX0KCX0KCglfdG9TUUxUYWJsZSgpIHsKCQlsZXQgcmV0ID0gewoJCQlzcWw6IGBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9ICgKICAgICAgICAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbm9kZScsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICBgCgkJfTsKCQlyZXQuc3FsICs9ICcvKk5vZGVfR3JvdXBfTWVtYmVyKi8pO1xuJzsKCgkJcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogdHJ1ZSwKCQkJTnVsbDogdHJ1ZSwKCQkJLy9JZDogKG9iaiwgdikgPT4gb2JqLnNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVlgLAoKCQkJImdyb3VwIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJub2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbm9kZScsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypOb2RlX0dyb3VwX01lbWJlciovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJncm91cCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZ3JvdXAodGFibGVbImdyb3VwIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5vZGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm5vZGUodGFibGVbIm5vZGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5hY3RpdmUodGFibGVbImFjdGl2ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5lbmFibGVkKHRhYmxlWyJlbmFibGVkIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvZGUodGFibGVbImNvZGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9yZGVyKHRhYmxlWyJvcmRlciJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5kYXRlKHRhYmxlWyJkYXRlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm5hbWUodGFibGVbIm5hbWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5yZW1hcmsodGFibGVbInJlbWFyayJdKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIF9zcWwoc3FsLCBzb3VyY2UgPSB0aGlzKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWwoc3FsLCB0aGlzKTsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgoJCQkJCS8vIGlmKHRoaXNbJ18nK2ZpZWxkKydfc2V0J10gJiYgKHR5cGVvZih0aGlzWydfJytmaWVsZF0pPT09J3VuZGVmaW5lZCcgfHwgdGhpc1snXycrZmllbGRdPT1udWxsKSkgcmV0dXJuOwoJCQkJCS8vIGlmKHR5cGVvZihlYU9iaik9PT0ndW5kZWZpbmVkJykgcmV0dXJuOyAvLyB3aHk/CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlyZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqLCB0aGlzLmNvZGUoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmosIHRoaXMuZGF0ZSgpKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmosIHRoaXMubmFtZSgpKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaiwgdGhpcy5yZW1hcmsoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICIyOWZmMDU3Ni0xM2ZhLTQ3ODQtOTEwYS00YzU5YjQ4MjFjNjgiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXIgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXJbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlcltmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlcltmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXJbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiBvYmosCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIG9iaiwgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIl9USElTIiwgb2JqLCB0aGlzLl9USElTKTsKCgkJaWYgKCF0aGlzLmdyb3VwKCkgfHwgKHRoaXMuZ3JvdXAoKQoKCQkJCSYmCgkJCQkhdGhpcy5ncm91cCgpLmdyb3VwX05vZGVfR3JvdXBfTWVtYmVycygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygiZ3JvdXAiLCBvYmosIHRoaXMuZ3JvdXAoKSk7CgkJfQoKCQlpZiAoIXRoaXMubm9kZSgpIHx8ICh0aGlzLm5vZGUoKQoKCQkJCSYmCgkJCQkhdGhpcy5ub2RlKCkubm9kZV9Db25maWdzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLm5vZGUoKS5jYXJyaWVyX0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5ub2RlKCkuc2VuZGVyX0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5ub2RlKCkucmVjaXBpZW50X0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5ub2RlKCkuYmFja3VwX05vZGVzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLm5vZGUoKS5wYXJlbnRfTm9kZXMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMubm9kZSgpLm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJub2RlIiwgb2JqLCB0aGlzLm5vZGUoKSk7CgkJfQoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydncm91cCcsICdub2RlJywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWycnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIk5vZGVfR3JvdXBfTWVtYmVyIiAmJiAobS50YXJnZXQgfHwgbS5vdXRTY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkgJiYgKCFtLnNvdXJjZSB8fCAobS5zb3VyY2UgJiYgLyohbS5vdXRTY3JpcHQgJiYqLyB0aGlzWydfJyArIG0uc291cmNlICsgJ19zZXQnXSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0ub3V0U2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5vdXRTY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5vdXRTY3JpcHR9KX1gKSh0aGlzLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS5zb3VyY2UpIHsKCQkJCWlmIChtLnNvdXJjZS5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMpID0+IHtyZXR1cm4gX3RoaXMuJHttLnNvdXJjZX07fWApKHRoaXMpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS5zb3VyY2UsIHRoaXMpOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnRhcmdldCkgb2JqW20udGFyZ2V0XSA9IHJldDsKCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJW20udGFyZ2V0IHx8IG0uc291cmNlXTogdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddCgkJCX0pOwoJCX0pOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCS8vIHVzZSB0aGlzLl9tYXAoKSB3aXRoIHJldmVyc2UKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmopOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiMjlmZjA1NzYtMTNmYS00Nzg0LTkxMGEtNGM1OWI0ODIxYzY4IiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlciB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlcltmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlcltmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXJbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXJbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoImdyb3VwIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5vZGUiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydncm91cCcsICdub2RlJywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWycnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIk5vZGVfR3JvdXBfTWVtYmVyIiAmJiAobS5zb3VyY2UgfHwgbS5pblNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLmluU2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaiwgb1Njb3BlLCBtYXApID0+IHske20uaW5TY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5pblNjcmlwdH0pfWApKG9iaiwgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0udGFyZ2V0KSB7CgkJCQlpZiAobS50YXJnZXQuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaikgPT4ge3JldHVybiBvYmouJHttLnRhcmdldH07fWApKG9iaik7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmpbbS50YXJnZXRdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS50YXJnZXQsIG9iaik7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS5zb3VyY2UpIHsKCQkJCWlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0ocmV0KTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0gPSByZXQ7CgkJCQl9CgkJCX0KCQl9KTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXTogIiciICsgdGhpcy5JZCArICInIgoJCX07CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZ3JvdXAiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZ3JvdXBfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmdyb3VwKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibm9kZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9ub2RlX3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5ub2RlKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKSArICJpZCJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fYWN0aXZlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2VuYWJsZWRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9jb2RlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNvZGUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9vcmRlcl9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5vcmRlcigpOwoKCQkJZlZhbHVlID0gdiB8fCAnMCc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9kYXRlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmRhdGUoKTsKCgkJCXRyeSB7CgkJCQlmVmFsdWUgPSAiJyIgKyAodiA/IHYudG9JU09TdHJpbmcoKSA6ICIxOTcwLTEtMSIpICsgIiciOwoJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnKSB7CgkJCQkJZlZhbHVlID0gYFNUUl9UT19EQVRFKCR7ZlZhbHVlfSwgJyVZLSVtLSVkVCVULiVmWicpYDsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gJ2RhdGV0aW1lKCcgKyBmVmFsdWUgKyAnKSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX25hbWVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMubmFtZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9yZW1hcmtfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucmVtYXJrKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9RKCkgewoJCWxldCBfbyA9ICciJzsKCQlsZXQgX3EgPSBfbzsKCgkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgewoJCQlfbyA9IF9xID0gJ2AnOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxzZXJ2ZXInKSB7CgkJCV9vID0gJ1snOwoJCQlfcSA9ICddJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ2FwaUtleScpID09ICdhaXJ0YWJsZScpIHsKCQkJX28gPSAneyc7CgkJCV9xID0gJ30nOwoJCX0KCQl0aGlzLl9fUSA9IHRoaXMuX19RID09IF9vID8gX3EgOiBfbzsKCQlyZXR1cm4gdGhpcy5fX1E7Cgl9CgoJX2ZpZWxkR3JvdXBzKGZncyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOwoJCXJldHVybiB0aGlzOwoJfQoKCV9maWVsZEFnZ3JlZ2F0ZXMoZmFzID0ge30pIHsKCQl0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOwoJCXJldHVybiB0aGlzOwoJfQoKCV90b0ZpZWxkc1NRTChmaWVsZHMpIHsKCgkJZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnLCB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKV07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmdyb3VwKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5vZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXSwKCgkJCQlncm91cDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZ3JvdXAob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlub2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbm9kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5vZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU51bGw6IHRydWUsCgoJCQlncm91cDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gb2JqW2VhQ29kZV0gPSBuZXcgc2FsZXNub3cuTm9kZV9Hcm91cCgpLl90b1NlbGVjdEhlYWRlcigpLAoKCQkJbm9kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Ob2RlKCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCX0sICJfdG9TZWxlY3RIZWFkZXIiKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0SGVhZGVyJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU2VsZWN0U1FMKGZpZWxkcykgewoJCWxldCBzcWwgPSAic2VsZWN0ICI7CgoJCWxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9YDsKCgkJbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7CgkJc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOwoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOwoKCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcykgewoJCQkvLyB7ZmllbGQ6IGZ1bmN0aW9ufQoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZ3JvdXApIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmdyb3VwfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5ub2RlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5ub2RlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJfQoKCQlzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7CgoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gYCk7CgoJCXNxbCArPSBgIHdoZXJlIDE9MWA7CgoJCXNxbCA9IHRoaXMuX19leHBvcnQoewoJCQlzcWw6IHNxbAoJCX0sIHsKCQkJX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSA/IFsnSWQnXSA6IHVuZGVmaW5lZCwKCQkJTnVsbDogdHJ1ZSwKCQkJX1RISVM6IG9iaiA9PiB7CgkJCQlpZiAoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKHQuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOwoJCQl9LAoJCQlJZDogb2JqID0+IG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwKCgkJCWdyb3VwOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2dyb3VwX3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fZ3JvdXBfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlub2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbm9kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbm9kZV9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX25vZGVfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvZGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2RhdGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVtYXJrX3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9TZWxlY3RTUUwiLCBmaWVsZHMpLnNxbDsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQlpZiAoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmdyb3VwKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5ncm91cH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5ub2RlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5vZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJZ3JvdXA6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IG9iai5ncm91cCA9IHYuX3RvUGF0aHMoKSwKCgkJCW5vZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKSkgPT4gb2JqLm5vZGUgPSB2Ll90b1BhdGhzKCksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTm9kZV9Hcm91cF9NZW1iZXIpIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTm9kZV9Hcm91cF9NZW1iZXIgPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgc3FsID0gbmV3IHNhbGVzbm93Lk5vZGVfR3JvdXBfTWVtYmVyKCkKCgkJCQkJLmdyb3VwKG5ldyBzYWxlc25vdy5Ob2RlX0dyb3VwKCkpCgoJCQkJCS5ub2RlKG5ldyBzYWxlc25vdy5Ob2RlKCkpCgoJCQkJCS5fdG9TUUxUYWJsZShkZXB0aCk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJOb2RlIEdyb3VwIE1lbWJlciIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlncm91cDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZ3JvdXAgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5Lmdyb3VwKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2dyb3VwX3NldCAmJiAhcXVlcnkuX2dyb3VwX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5ncm91cCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9ncm91cF9zZXQgJiYgcXVlcnkuX2dyb3VwX3NldCkgfHwKCgkJCQkJCSh0aGlzLmdyb3VwKCkgJiYgIXRoaXMuZ3JvdXAoKS5fbWF0Y2hlcyhxdWVyeS5ncm91cCgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZ3JvdXAgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbm9kZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubm9kZSA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkubm9kZSgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9ub2RlX3NldCAmJiAhcXVlcnkuX25vZGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5vZGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbm9kZV9zZXQgJiYgcXVlcnkuX25vZGVfc2V0KSB8fAoKCQkJCQkJKHRoaXMubm9kZSgpICYmICF0aGlzLm5vZGUoKS5fbWF0Y2hlcyhxdWVyeS5ub2RlKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5ub2RlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWFjdGl2ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouYWN0aXZlID0gdiA9PSBxdWVyeS5hY3RpdmUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fYWN0aXZlX3NldCAmJiAhcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2FjdGl2ZV9zZXQgJiYgcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5lbmFibGVkID0gdiA9PSBxdWVyeS5lbmFibGVkKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ICYmICFxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9lbmFibGVkX3NldCAmJiBxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY29kZSA9IHYgPT0gcXVlcnkuY29kZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jb2RlX3NldCAmJiAhcXVlcnkuX2NvZGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY29kZV9zZXQgJiYgcXVlcnkuX2NvZGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vcmRlciA9IHYgPT0gcXVlcnkub3JkZXIoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fb3JkZXJfc2V0ICYmICFxdWVyeS5fb3JkZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX29yZGVyX3NldCAmJiBxdWVyeS5fb3JkZXJfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5kYXRlID0gdiA9PSBxdWVyeS5kYXRlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2RhdGVfc2V0ICYmICFxdWVyeS5fZGF0ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9kYXRlX3NldCAmJiBxdWVyeS5fZGF0ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubmFtZSA9IHYgPT0gcXVlcnkubmFtZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9uYW1lX3NldCAmJiAhcXVlcnkuX25hbWVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbmFtZV9zZXQgJiYgcXVlcnkuX25hbWVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gZmFsc2U7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucmVtYXJrID0gdiA9PSBxdWVyeS5yZW1hcmsoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcmVtYXJrX3NldCAmJiAhcXVlcnkuX3JlbWFya19zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3JlbWFya19zZXQgJiYgcXVlcnkuX3JlbWFya19zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IGZhbHNlOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWdyb3VwOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgZ3JvdXAiKTsKCQkJCQlvYmouZ3JvdXAgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQlub2RlOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3Igbm9kZSIpOwoJCQkJCW9iai5ub2RlID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fZ3JvdXBfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbm9kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWdyb3VwOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMuZ3JvdXAocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCW5vZGU6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5ub2RlKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCWdyb3VwOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpIDogImdyb3VwIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2dyb3VwX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLmdyb3VwKCkgfHwgbmV3IHNhbGVzbm93Lk5vZGVfR3JvdXAoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLmdyb3VwKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgZ3JvdXAiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCW5vZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKSA6ICJub2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25vZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMubm9kZSgpIHx8IG5ldyBzYWxlc25vdy5Ob2RlKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5ub2RlKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2Ugbm9kZSIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQl9LCAiX2Zyb21Eb2N1bWVudCIpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSB7CgkJbGV0IHJldCA9IHt9OwoKCQlpZiAoIWJUb29sKSB7CgkJCXJldC5fX2dlbmVyYXRlZCA9IG5ldyBEYXRlKCk7CgkJCWlmICh0aGlzLlRvb2wubmFtZSkgewoJCQkJcmV0Ll9fdG9vbCA9IHsKCQkJCQluYW1lOiB0aGlzLlRvb2wubmFtZSwKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlpZiAoc2FsZXNub3cuX25vZGUpIHsKCQkJCXJldC5fX25vZGUgPSB7CgkJCQkJY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogYkZ1bGwsCgkJCU51bGw6IGJOdWxsLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXSA9IHYsCgoJCQkiZ3JvdXAiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpIDogImdyb3VwIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fZ3JvdXBfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2dyb3VwX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibm9kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKSA6ICJub2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fbm9kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbm9kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJYnlOb2RlX0dyb3VwKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9ncm91cCJdICYmIChhWyJfZ3JvdXAiXS5FcXVhbHMgPyBhWyJfZ3JvdXAiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX2dyb3VwIl0sIHIpKSkgewoJCQkJCXIuX2dyb3VwX05vZGVfR3JvdXBfTWVtYmVycy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5Tm9kZShhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfbm9kZSJdICYmIChhWyJfbm9kZSJdLkVxdWFscyA/IGFbIl9ub2RlIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9ub2RlIl0sIHIpKSkgewoJCQkJCXIuX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSB0cnVlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IuZ3JvdXAgPSB7fTsKCQkJaWYgKCF0aGlzLl9ncm91cF9zZXQpIGVycm9yLmdyb3VwWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCF0aGlzLmdyb3VwKCkpIGVycm9yLmdyb3VwWyIwMiJdID0gIkVtcHR5IFZhbHVlIjsKCQkJaWYgKHRoaXMuZ3JvdXAoKSAmJiBiU3luYyAmJiAhdGhpcy5ncm91cCgpLl9fc3luY19vbigpKSBlcnJvci5ncm91cFsiMDMiXSA9ICJOb3QgaW4gU3luYyI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLmdyb3VwKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5ncm91cDsKCQl9CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSB0cnVlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3Iubm9kZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25vZGVfc2V0KSBlcnJvci5ub2RlWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCF0aGlzLm5vZGUoKSkgZXJyb3Iubm9kZVsiMDIiXSA9ICJFbXB0eSBWYWx1ZSI7CgkJCWlmICh0aGlzLm5vZGUoKSAmJiBiU3luYyAmJiAhdGhpcy5ub2RlKCkuX19zeW5jX29uKCkpIGVycm9yLm5vZGVbIjAzIl0gPSAiTm90IGluIFN5bmMiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5ub2RlKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5ub2RlOwoJCX0KCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IHRydWU7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGVfR3JvdXBfTWVtYmVyLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5Ob2RlX0dyb3VwX01lbWJlcihudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuZ3JvdXAodGhpcy5ncm91cCgpLCAnPScpOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLm5vZGUodGhpcy5ub2RlKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMubmFtZSh0aGlzLm5hbWUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX2dyb3VwX3NldCAmJiB0aGlzLmdyb3VwKCkgJiYgIShhd2FpdCB0aGlzLmdyb3VwKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfZ3JvdXAoKTsKCgkJCQkJaWYgKHRoaXMuX25vZGVfc2V0ICYmIHRoaXMubm9kZSgpICYmICEoYXdhaXQgdGhpcy5ub2RlKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfbm9kZSgpOwoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQkJaWYgKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uT3duZXIgPT0gdGhpcykgewoJCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGBDT01NSVQke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/JyBUUkFOU0FDVElPTic6Jyd9YCk7CgkJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCA9IG5ldyBEYXRlKCk7CgkJCQkJCX0KCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZV9Hcm91cF9NZW1iZXIuaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b0luc2VydFNRTCgpKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luc2VydCcsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZV9Hcm91cF9NZW1iZXIudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlLl9wYXJlbnQpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGVfR3JvdXBfTWVtYmVyLmZpbmRBbGwnKTsKCgkJCS8vIGF2b2lkcyBjeWNsaWMgcXVlcmllcwoJCQlvYmpzID0gKG9ianMgfHwgW10pLm1hcChvID0+IG8uX2Nsb25lKCkpOwoKCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLz8/CgoJCQlsZXQgcmV0ID0gW107IC8vIGEganNvbiBhcnJheQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCXJldCA9IChhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoZmllbGRzLCBvYmpzKSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2ApOwoJCQkJcmV0ID0gcmV0ID8gW0pTT04ucGFyc2UodGhpcy5fYXRvYihyZXQuY29udGVudCkpXSA6IFtdOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiQmVmb3JlIF9mcm9tRG9jdW1lbnQoKSIsIHJldCk7CgoJCQlyZXQgPSByZXQubWFwKHIgPT4gbmV3IHNhbGVzbm93Lk5vZGVfR3JvdXBfTWVtYmVyKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuTm9kZV9UeXBlID0gY2xhc3MgTm9kZV9UeXBlIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUWlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpPYjJSbElqcDdJbTV2UkdWMFpXTjBJanAwY25WbExDSnBibWwwTG1WdVpITWlPaklzSW1sdWFYUXViRzl2Y0NJNk1DNDFMQ0owYjI5c2N5NXpkRzl5WlNJNlptRnNjMlVzSW1SbGRHVmpkRkJoY21WdWRDNUpVQ0k2SWpFNU5TNHhNVEl1TWpFMkxqRTNNeUlzSW1SbGRHVmpkRkJoY21WdWRDNWpiMlJsSWpvaVpUaGtaVEEyWlRObFpHTTBORE5oWlRsa1ptVXhaR1UxWldNMU1tRTBZbVlpTENKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjBzSWxSdmIyd2lPbnNpWjJsMGFIVmlMblJ2YjJ4eklqb2lhSFIwY0hNNkx5OXlZWGN1WjJsMGFIVmlkWE5sY21OdmJuUmxiblF1WTI5dEwyWmhaR2x1TDJaaFpHbHVMbWRwZEdoMVlpNXBieTl0WVhOMFpYSXZJaXdpYzJWamNtVjBJam9pYjFOTGQyZGFNbk5MUms5VVNVcGpZa0ZtVlVsUk5FTnFPWEZ6U0RRNGJtd2lMQ0p3YkdGNVozSnZkVzVrSWpwMGNuVmxMQ0puVWxCRElqcDBjblZsTENKemRHOXlaUzV6Wlc1emFYUnBkbWwwZVNJNk1Td2lZMjl0Y0dGdWVTSTZJbkpsYzNWdFpTSjlMQ0p6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpWYzJWeUlqcDdJbDloZFhSb2IzSnBlbVV1ZFhObGNtNWhiV1VpT2lKbVlXUnBJaXdpWDJGMWRHaHZjbWw2WlM1d1lYTnpkMjl5WkNJNklqRXlNeUlzSWw5aGRYUm9iM0pwZW1VdWRHVnpkRlZ6WlhJaU9uc2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0puWlc1a1pYSWlPbnNpWTI5a1pTSTZJazBpTENKdVlXMWxJam9pVFdGc1pTSjlMQ0pqYjJSbElqb2labUZrYVNJc0ltNWhiV1VpT2lKR1lXUnBJbjE5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpUY1d4RVFpSXNJa2RwZEVoMVlpSmRgKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLk1hcHBpbmdzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgVzEwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoKCQkvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUKCQl0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307CgkJdGhpcy5Ub29sID0gdG9vbDsKCQl0aGlzLklkID0gaWQ7CgoJCXRoaXMuVmFsdWVFbnRpdGllcyA9IFtdOwoKCQl0aGlzLkRhdGUgPSBudWxsOwoKCQl0aGlzLmNsZWFyX1RISVMoKTsKCQl0aGlzLkVudGl0eVZhbHVlcyA9IFtdOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImR5bmFtaWMiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2R5bmFtaWMoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2FjdGl2ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2VuYWJsZWQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb2RlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb2RlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3JkZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29yZGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZGF0ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZGF0ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm5hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX25hbWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3JlbWFyaygpOwoKCQl0aGlzLmNsZWFyX3R5cGVfTm9kZXMoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJOb2RlIFR5cGUiLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCXJldHVybiB0aGlzOwoKCQkodGhpcy50eXBlX05vZGVzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJVEhJUyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsKCQlpZiAoIXYpIHJldHVybiB0aGlzOwoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCQl0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KSA9PT0gJ29iamVjdCcgJiYgX3YuRW50aXR5Q2xhc3MgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSA9PSB0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGUgPT0gdGhpcy5TY29wZSk7CgkJaWYgKGNvKSB0aGlzLl9USElTX2Nvb3AgPSBjbzsKCQlyZXR1cm4gdGhpczsKCX0KCgljbGVhcl9USElTKCkgewoJCXRoaXMuX1RISVMgPSBbXTsKCQl0aGlzLl9USElTX2Nvb3AgPSAnJzsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGR5bmFtaWMgKiovCglkeW5hbWljKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZHluYW1pY19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImR5bmFtaWMiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9keW5hbWljICE9IHYpIHsKCQkJCXRoaXMuX2R5bmFtaWNfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2R5bmFtaWMgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2R5bmFtaWMpOwoJCX0KCX0KCgljbGVhcl9keW5hbWljKCkgewoJCXRoaXMuX2R5bmFtaWNfc2V0ID0gbnVsbDsKCQl0aGlzLl9keW5hbWljID0gbnVsbDsKCQl0aGlzLl9keW5hbWljX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkeW5hbWljICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdHlwZV9Ob2RlcyAqKi8KCXR5cGVfTm9kZXModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX3R5cGVfTm9kZXM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2M2YjE0YjRlLWU1MWQtNGRiYS1hZmI4LWFjNDc4ZjRiNGU3NicgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnTm9kZScpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fdHlwZV9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0eXBlX05vZGVzJywgJ0VudGl0eU9iamVjdCcsIDEsICJ0eXBlIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJOb2RlIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndHlwZV9Ob2RlcycsICdFbnRpdHlPYmplY3QnLCAxLCAidHlwZSBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIk5vZGUiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YudHlwZSh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl90eXBlX05vZGVzLnB1c2goLi4udik7CgkJdGhpcy5fdHlwZV9Ob2Rlc19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fdHlwZV9Ob2Rlc19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfdHlwZV9Ob2RlcygpIHsKCQl0aGlzLl90eXBlX05vZGVzX3NldCA9IG51bGw7CgkJdGhpcy5fdHlwZV9Ob2RlcyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX3R5cGVfTm9kZXNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0eXBlX05vZGVzICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fZHluYW1pY19zZXQsCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fdHlwZV9Ob2Rlc19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9keW5hbWljX3NldCA9IHRoaXMuX2R5bmFtaWNfc2V0OwoJCXJldC5fZHluYW1pY19jb29wID0gdGhpcy5fZHluYW1pY19jb29wOwoJCXJldC5keW5hbWljID0gdGhpcy5keW5hbWljKCkgPyB0aGlzLmR5bmFtaWMoKSA6IHRoaXMuZHluYW1pYygpOwoKCQlyZXQuX2FjdGl2ZV9zZXQgPSB0aGlzLl9hY3RpdmVfc2V0OwoJCXJldC5fYWN0aXZlX2Nvb3AgPSB0aGlzLl9hY3RpdmVfY29vcDsKCQlyZXQuYWN0aXZlID0gdGhpcy5hY3RpdmUoKSA/IHRoaXMuYWN0aXZlKCkgOiB0aGlzLmFjdGl2ZSgpOwoKCQlyZXQuX2VuYWJsZWRfc2V0ID0gdGhpcy5fZW5hYmxlZF9zZXQ7CgkJcmV0Ll9lbmFibGVkX2Nvb3AgPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJcmV0LmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKSA/IHRoaXMuZW5hYmxlZCgpIDogdGhpcy5lbmFibGVkKCk7CgoJCXJldC5fY29kZV9zZXQgPSB0aGlzLl9jb2RlX3NldDsKCQlyZXQuX2NvZGVfY29vcCA9IHRoaXMuX2NvZGVfY29vcDsKCQlyZXQuY29kZSA9IHRoaXMuY29kZSgpID8gdGhpcy5jb2RlKCkgOiB0aGlzLmNvZGUoKTsKCgkJcmV0Ll9vcmRlcl9zZXQgPSB0aGlzLl9vcmRlcl9zZXQ7CgkJcmV0Ll9vcmRlcl9jb29wID0gdGhpcy5fb3JkZXJfY29vcDsKCQlyZXQub3JkZXIgPSB0aGlzLm9yZGVyKCkgPyB0aGlzLm9yZGVyKCkgOiB0aGlzLm9yZGVyKCk7CgoJCXJldC5fZGF0ZV9zZXQgPSB0aGlzLl9kYXRlX3NldDsKCQlyZXQuX2RhdGVfY29vcCA9IHRoaXMuX2RhdGVfY29vcDsKCQlyZXQuZGF0ZSA9IHRoaXMuZGF0ZSgpID8gdGhpcy5kYXRlKCkgOiB0aGlzLmRhdGUoKTsKCgkJcmV0Ll9uYW1lX3NldCA9IHRoaXMuX25hbWVfc2V0OwoJCXJldC5fbmFtZV9jb29wID0gdGhpcy5fbmFtZV9jb29wOwoJCXJldC5uYW1lID0gdGhpcy5uYW1lKCkgPyB0aGlzLm5hbWUoKSA6IHRoaXMubmFtZSgpOwoKCQlyZXQuX3JlbWFya19zZXQgPSB0aGlzLl9yZW1hcmtfc2V0OwoJCXJldC5fcmVtYXJrX2Nvb3AgPSB0aGlzLl9yZW1hcmtfY29vcDsKCQlyZXQucmVtYXJrID0gdGhpcy5yZW1hcmsoKSA/IHRoaXMucmVtYXJrKCkgOiB0aGlzLnJlbWFyaygpOwoKCQlyZXQudHlwZV9Ob2RlcyA9IHRoaXMudHlwZV9Ob2RlcygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkiZHluYW1pYyI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkeW5hbWljJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJdHlwZV9Ob2RlczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGVfTm9kZV9UeXBlcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCAmJiBldmVudC5jbGFzc05hbWUoKSAmJiBldmVudC5jbGFzc05hbWUoKSAhPSAnTm9kZV9UeXBlJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL05vZGVfVHlwZS8ke21ldGhvZH1gLCBkYXRhLCBjb25maWcpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQl9CgkJfSBlbHNlIHsKCgkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMuX19nZW5lcmF0ZWQ7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMub25saW5lOwoKCQkJfQoKCQkJLy93aHkgZG8gd2UgbmVlZCB0aGlzPz8/CgoJCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQkJdHJ5IHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHttZXRob2R9YCk7CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJbGV0IF9pZCA9IG51bGw7CgkJCQlpZiAodHlwZW9mKGRhdGEpID09PSAndW5kZWZpbmVkJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIGRhdGEsIG1ldGhvZCwge30pOwoJCQkJCXJldHVybiBkYXRhOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoZGF0YSkgPT09ICdzdHJpbmcnKSB7CgkJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShkYXRhKTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gZGF0YS5fX3RoaXMuY29kZSB8fCBkYXRhLmlkIHx8IGRhdGEuSUQ7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQkJaWYgKGRhdGEuSWQgJiYgZGF0YS5JZCA9PSBkYXRhLklkKSB7CgkJCQkJCV9pZCA9IGRhdGEuSWQ7CgkJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCQl9IGVsc2UgaWYgKGRhdGEuRW50aXR5Q2xhc3MpIHsKCQkJCQkJX2lkID0gZGF0YS5FbnRpdHlDbGFzcy5JZCB8fCBkYXRhLkVudGl0eUNsYXNzLk5hbWU7CgkJCQkJfSBlbHNlIHsKCQkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiOGYwNTdkY2UtYjI4Ni00OGI3LWE1ZTctNDg1ZjdiYmVmOWQ3IiB8fCAiTlVMTCI7CgkJCQkJfQoJCQkJfQoKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGUgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfVHlwZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW21ldGhvZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfVHlwZVttZXRob2RdIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGVbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGVbbWV0aG9kXVtfaWRdIHx8IHt9OwoKCQkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaCh7fSwgewoJCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCQl9KTsKCgkJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGVbbWV0aG9kXVtfaWRdW19oYXNoXTsKCQkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogNSkpIHsKCQkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIG1ldGhvZCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCQl2LnJldXNlZCsrOwoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0KCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSk7CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfVHlwZVttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnTm9kZV9UeXBlJykuc2VuZGVyKHNhbGVzbm93Ll9ub2RlKS5jYXJyaWVyKHNhbGVzbm93Ll9ub2RlKS5wYXlsb2FkKGRhdGEpOwoJCQlpZiAoZXZlbnQpIHsKCQkJCWlmIChldmVudC5fcmVzcG9uc2VUb19zZXQpIGV2LnJlc3BvbnNlVG8oZXZlbnQucmVzcG9uc2VUbygpKTsKCQkJCWlmIChldmVudC5fc2VuZGVyX3NldCkgZXYuc2VuZGVyKGV2ZW50LnNlbmRlcigpKTsKCQkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCkgZXYuY2xhc3NOYW1lKGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCWlmIChldmVudC5fY2Fycmllcl9zZXQgfHwgZXZlbnQuX3NlbmRlcl9zZXQpIGV2LmNhcnJpZXIoZXZlbnQuY2FycmllcigpIHx8IGV2ZW50LnNlbmRlcigpKTsKCQkJfQoJCQlyZXQgPSBhd2FpdCBldi50cmlnZ2VyKCk7CgoJCQlpZiAodHlwZW9mKHJldCkgPT09ICJzdHJpbmciKSB7CgkJCQl0cnkgewoJCQkJCXJldCA9IEpTT04ucGFyc2UocmV0KTsKCQkJCX0gY2F0Y2ggKGV4KSB7fQoJCQl9CgkJCXJldHVybiByZXQ7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5zZXJ0IjoKCQkJY2FzZSAidXBkYXRlIjoKCQkJY2FzZSAic3RvcmUiOgoJCQljYXNlICJkZWxldGUiOgoJCQljYXNlICJmaW5kIjogewoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuTm9kZV9UeXBlKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5Ob2RlX1R5cGUobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuTm9kZV9UeXBlKCkuX2ludm9rZU5vZGUodG4sIG1ldGhvZCwgX3BhcmFtcyk7CgkJfQoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBOb2RlX1R5cGUuX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBOb2RlX1R5cGUuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlLl90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGVfVHlwZS4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiTm9kZSBUeXBlIik7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCS8vIHRoaXMudHlwZV9Ob2RlX1R5cGVzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuTm9kZV9UeXBlKHRoaXMuSWQpCgoJCQkuZHluYW1pYyh0aGlzLmR5bmFtaWMoKSwgdGhpcy5fZHluYW1pY19jb29wKQoKCQkJLmFjdGl2ZSh0aGlzLmFjdGl2ZSgpLCB0aGlzLl9hY3RpdmVfY29vcCkKCgkJCS5lbmFibGVkKHRoaXMuZW5hYmxlZCgpLCB0aGlzLl9lbmFibGVkX2Nvb3ApCgoJCQkuY29kZSh0aGlzLmNvZGUoKSwgdGhpcy5fY29kZV9jb29wKQoKCQkJLm9yZGVyKHRoaXMub3JkZXIoKSwgdGhpcy5fb3JkZXJfY29vcCkKCgkJCS5kYXRlKHRoaXMuZGF0ZSgpLCB0aGlzLl9kYXRlX2Nvb3ApCgoJCQkubmFtZSh0aGlzLm5hbWUoKSwgdGhpcy5fbmFtZV9jb29wKQoKCQkJLnJlbWFyayh0aGlzLnJlbWFyaygpLCB0aGlzLl9yZW1hcmtfY29vcCkKCgkJCS50eXBlX05vZGVzKHRoaXMudHlwZV9Ob2RlcygpLCB0aGlzLl90eXBlX05vZGVzX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQlvYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ05vZGVfVHlwZSc7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIk5vZGVfVHlwZSI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgkJCQlyZXQgPSByZXQudG9Mb3dlckNhc2UoKTsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucyA9IHt9KSB7CgkJdHJ5IHsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sID8gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IG9wdGlvbnMudG9vbCB8fCB0ID09IG9wdGlvbnMudG9vbCkgOiB0aGlzLlRvb2w7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCB8fCB7fTsKCgkJCWxldCBuSUQgPSBzYWxlc25vdy5fbm9kZSA/IHNhbGVzbm93Ll9ub2RlLmNvZGUoKSA6ICJkZWZhdWx0IjsKCgkJCWxldCByZXQgPSBudWxsVmFsdWU7CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldCA9IG51bGw7CgoJCQkvLyB0b29sX0NvbmZpZ3M6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gZG9uZQoJCQlsZXQgdGNvbmYgPSAob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgYy5ub2RlICYmIGMubm9kZS5jb2RlID09IG5JRCkuY29uY2F0KChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiAhYy5ub2RlKSk7CgkJCWlmICh0Y29uZi5sZW5ndGgpIHsKCQkJCXJldCA9IHRjb25mWzBdLnZhbHVlOwoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChqZXgpIHt9CgkJCX0KCgkJCS8vIG1vZGVsIENvbmZpZzogQ29uZmlnIGlzIGNsYXNzIGxldmVsLCBub2RlIG5vdCBwb3NzaWJsZSAtIHBlbmRpbmcKCQkJbGV0IG1jb25mID0gdGhpcy5Db25maWcgPyB0aGlzLkNvbmZpZ1tuXSA6IHVuZGVmaW5lZDsKCQkJaWYgKHR5cGVvZihtY29uZikgIT09ICJ1bmRlZmluZWQiKSByZXQgPSBtY29uZjsKCgkJCS8vIGNvbW1hbmQgbGluZTogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgZ2xvYmFsLm1pbmltaXN0KSB7CgkJCQlyZXQgPSBnbG9iYWwubWluaW1pc3QocHJvY2Vzcy5hcmd2LnNsaWNlKDIpKVtuXSB8fCByZXQ7CgkJCX0KCgkJCS8vIHJlcXVlc3Q6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlyZXQgPSB0aGlzLiRfUkVRVUVTVChuKSB8fCByZXQ7CgoJCQlpZiAob3B0aW9ucy5uZXdWYWx1ZSkgewoJCQkJbGV0IHRjID0gdGNvbmYubGVuZ3RoID8gdGNvbmZbMF0gOiB7fTsKCQkJCXRjLm5vZGUgPSB7CgkJCQkJY29kZTogb3B0aW9ucy5ub2RlLmNvZGUoKQoJCQkJfTsKCQkJCXRjLnZhbHVlID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJCXRjLm5hbWUgPSBuOwoJCQkJaWYgKCF0Y29uZi5sZW5ndGgpIHsKCQkJCQlvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLnB1c2godGMpOwoJCQkJfQoJCQkJcmV0ID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJfQoKCQkJLy8gY29uZmlnIHJlcGxhY2VtZW50CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3N0cmluZycpKHJldC5tYXRjaChuZXcgUmVnRXhwKGB7eyhbXn1dKyl9fWAsICJnIikpIHx8IFtdKS5mb3JFYWNoKG0gPT4gcmV0ID0gcmV0LnJlcGxhY2UobSwgdGhpcy5fX2NvbmZpZyhtLnJlcGxhY2UoJ3t7JywgJycpLnJlcGxhY2UoJ319JywgJycpLCBudWxsLCBvcHRpb25zKSkpOwoKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2NvbmZpZycsICdFbnRpdHlPYmplY3QnLCAxLCBuLCBudWxsVmFsdWUsIG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MsIGV4KTsKCQl9Cgl9CgoJX3RvU1FMVGFibGUoKSB7CgkJbGV0IHJldCA9IHsKCQkJc3FsOiBgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoCiAgICAgICAgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVkKICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkeW5hbWljJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgYAoJCX07CgkJcmV0LnNxbCArPSAnLypOb2RlX1R5cGUqLyk7XG4nOwoKCQlyZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiB0cnVlLAoJCQlOdWxsOiB0cnVlLAoJCQkvL0lkOiAob2JqLCB2KSA9PiBvYmouc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWWAsCgoJCQkiZHluYW1pYyI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkeW5hbWljJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2R5bmFtaWMnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCXR5cGVfTm9kZXM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlX05vZGVfVHlwZXMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypOb2RlX1R5cGUqLyk7XG4nOwoKCQlyZXQuc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChyZXQuc3FsKSA6IHJldC5zcWw7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NRTFRhYmxlJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldC5zcWwpOwoJCXJldHVybiByZXQuc3FsOwoJfQoKCV9mcm9tU1FMVGFibGUodGFibGUsIGZpZWxkcykgewoJCS8vIHRhYmxlIGlzIGEganNvbiBhcnJheQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZHluYW1pYyIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZHluYW1pYyh0YWJsZVsiZHluYW1pYyJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbChzcWwsIHRoaXMpOwoKCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCgkJCQkJLy8gaWYodGhpc1snXycrZmllbGQrJ19zZXQnXSAmJiAodHlwZW9mKHRoaXNbJ18nK2ZpZWxkXSk9PT0ndW5kZWZpbmVkJyB8fCB0aGlzWydfJytmaWVsZF09PW51bGwpKSByZXR1cm47CgkJCQkJLy8gaWYodHlwZW9mKGVhT2JqKT09PSd1bmRlZmluZWQnKSByZXR1cm47IC8vIHdoeT8KCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCXJldHVybiBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiZHluYW1pYyIsIG9iaiwgdGhpcy5keW5hbWljKCkpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjhmMDU3ZGNlLWIyODYtNDhiNy1hNWU3LTQ4NWY3YmJlZjlkNyIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGUgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfVHlwZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGVbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfVHlwZVtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCV9vcHRpb25zKCJ0eXBlX05vZGVzIiwgb2JqLCB0aGlzLnR5cGVfTm9kZXMoKSk7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2R5bmFtaWMnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3R5cGVfTm9kZXMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIk5vZGVfVHlwZSIgJiYgKG0udGFyZ2V0IHx8IG0ub3V0U2NyaXB0KSAmJiBtLmFjdGl2ZSAmJiBtLmVuYWJsZWQgJiYgKChtLnRvb2wgJiYgbS50b29sLm5hbWUgPT0gdGhpcy5Ub29sLm5hbWUpIHx8IChtLnR5cGUgJiYgbS50eXBlLm5hbWUgPT0gdGhpcy5Ub29sLnR5cGUubmFtZSkpICYmICghbS5zb3VyY2UgfHwgKG0uc291cmNlICYmIC8qIW0ub3V0U2NyaXB0ICYmKi8gdGhpc1snXycgKyBtLnNvdXJjZSArICdfc2V0J10pKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLm91dFNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcywgb1Njb3BlLCBtYXApID0+IHske20ub3V0U2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20ub3V0U2NyaXB0fSl9YCkodGhpcywgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0uc291cmNlKSB7CgkJCQlpZiAobS5zb3VyY2UuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzKSA9PiB7cmV0dXJuIF90aGlzLiR7bS5zb3VyY2V9O31gKSh0aGlzKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0uc291cmNlLCB0aGlzKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS50YXJnZXQpIG9ialttLnRhcmdldF0gPSByZXQ7CgkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCVttLnRhcmdldCB8fCBtLnNvdXJjZV06IHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXQoJCQl9KTsKCQl9KTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQkvLyB1c2UgdGhpcy5fbWFwKCkgd2l0aCByZXZlcnNlCgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJkeW5hbWljIiwgb2JqKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmopOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiOGYwNTdkY2UtYjI4Ni00OGI3LWE1ZTctNDg1ZjdiYmVmOWQ3IiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfVHlwZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfVHlwZVtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGVbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGVbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGVbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGVbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygidHlwZV9Ob2RlcyIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2R5bmFtaWMnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3R5cGVfTm9kZXMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIk5vZGVfVHlwZSIgJiYgKG0uc291cmNlIHx8IG0uaW5TY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5pblNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmosIG9TY29wZSwgbWFwKSA9PiB7JHttLmluU2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20uaW5TY3JpcHR9KX1gKShvYmosIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnRhcmdldCkgewoJCQkJaWYgKG0udGFyZ2V0LmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmopID0+IHtyZXR1cm4gb2JqLiR7bS50YXJnZXR9O31gKShvYmopOwoJCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqW20udGFyZ2V0XSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0udGFyZ2V0LCBvYmopOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0uc291cmNlKSB7CgkJCQlpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXRoaXNbbS5zb3VyY2VdKHJldCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXNbbS5zb3VyY2VdID0gcmV0OwoJCQkJfQoJCQl9CgkJfSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RCT2JqZWN0KGZpZWxkcywgYk5vUmVmKSB7CgkJaWYgKCF0aGlzLklkKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJJbnZhbGlkIElEIiwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lLCB0aGlzLlRvb2wpOwoJCX0KCQlsZXQgcmV0ID0gewoJCQlbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ106ICInIiArIHRoaXMuSWQgKyAiJyIKCQl9OwoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImR5bmFtaWMiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZHluYW1pY19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5keW5hbWljKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2R5bmFtaWMnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fYWN0aXZlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2VuYWJsZWRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9jb2RlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNvZGUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9vcmRlcl9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5vcmRlcigpOwoKCQkJZlZhbHVlID0gdiB8fCAnMCc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9kYXRlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmRhdGUoKTsKCgkJCXRyeSB7CgkJCQlmVmFsdWUgPSAiJyIgKyAodiA/IHYudG9JU09TdHJpbmcoKSA6ICIxOTcwLTEtMSIpICsgIiciOwoJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnKSB7CgkJCQkJZlZhbHVlID0gYFNUUl9UT19EQVRFKCR7ZlZhbHVlfSwgJyVZLSVtLSVkVCVULiVmWicpYDsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gJ2RhdGV0aW1lKCcgKyBmVmFsdWUgKyAnKSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX25hbWVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMubmFtZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9yZW1hcmtfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucmVtYXJrKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9RKCkgewoJCWxldCBfbyA9ICciJzsKCQlsZXQgX3EgPSBfbzsKCgkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgewoJCQlfbyA9IF9xID0gJ2AnOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxzZXJ2ZXInKSB7CgkJCV9vID0gJ1snOwoJCQlfcSA9ICddJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ2FwaUtleScpID09ICdhaXJ0YWJsZScpIHsKCQkJX28gPSAneyc7CgkJCV9xID0gJ30nOwoJCX0KCQl0aGlzLl9fUSA9IHRoaXMuX19RID09IF9vID8gX3EgOiBfbzsKCQlyZXR1cm4gdGhpcy5fX1E7Cgl9CgoJX2ZpZWxkR3JvdXBzKGZncyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOwoJCXJldHVybiB0aGlzOwoJfQoKCV9maWVsZEFnZ3JlZ2F0ZXMoZmFzID0ge30pIHsKCQl0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOwoJCXJldHVybiB0aGlzOwoJfQoKCV90b0ZpZWxkc1NRTChmaWVsZHMpIHsKCgkJZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnLCB0aGlzLl9uQ29kZSgnZHluYW1pYycsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpXTsKCQlmaWVsZHMgPSBBcnJheS5pc0FycmF5KGZpZWxkcykgPyBmaWVsZHMgOiBbZmllbGRzXTsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQkvLyB7ZmllbGQ6IG9yZGVyfQoJCQlmaWVsZHMgPSBbXTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZHluYW1pYykgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2R5bmFtaWMnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXSwKCgkJCQlkeW5hbWljOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZHluYW1pYycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmR5bmFtaWMob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU51bGw6IHRydWUsCgoJCX0sICJfdG9TZWxlY3RIZWFkZXIiKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0SGVhZGVyJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU2VsZWN0U1FMKGZpZWxkcykgewoJCWxldCBzcWwgPSAic2VsZWN0ICI7CgoJCWxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9YDsKCgkJbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7CgkJc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOwoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOwoKCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcykgewoJCQkvLyB7ZmllbGQ6IGZ1bmN0aW9ufQoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZHluYW1pYykgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZHluYW1pY30oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZHluYW1pYycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCX0KCgkJc3FsICs9IGAgZnJvbSAke3RQcmVmfSBgOwoKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gYGxlZnQgam9pbiAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX0ke3RoaXMuX1EoKX0gYXMgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0gb24gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtrfWlkJHt0aGlzLl9RKCl9PSR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IGApOwoKCQlzcWwgKz0gYCB3aGVyZSAxPTFgOwoKCQlzcWwgPSB0aGlzLl9fZXhwb3J0KHsKCQkJc3FsOiBzcWwKCQl9LCB7CgkJCV9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgPyBbJ0lkJ10gOiB1bmRlZmluZWQsCgkJCU51bGw6IHRydWUsCgkJCV9USElTOiBvYmogPT4gewoJCQkJaWYgKCF0aGlzLl9USElTIHx8ICF0aGlzLl9USElTLmxlbmd0aCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCh0Ll9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnKSkuam9pbignIFVOSU9OIEFMTCAnKSArICIpIjsKCQkJfSwKCQkJSWQ6IG9iaiA9PiBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2AsCgoJCQlkeW5hbWljOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZHluYW1pYycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZHluYW1pY19zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvZGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2RhdGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVtYXJrX3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQl0eXBlX05vZGVzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZV9Ob2RlX1R5cGVzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl90eXBlX05vZGVzX3NldCkgcmV0dXJuOwoKCQkJCWxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCgidHlwZS5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fdHlwZV9Ob2Rlc19jb29wID09ICchPScgfHwgdGhpcy5fdHlwZV9Ob2Rlc19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl90eXBlX05vZGVzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX3R5cGVfTm9kZXNfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl90eXBlX05vZGVzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKnR5cGVfTm9kZXMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCX0sICJfdG9TZWxlY3RTUUwiLCBmaWVsZHMpLnNxbDsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQlpZiAoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmR5bmFtaWMpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZHluYW1pYycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmR5bmFtaWN9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJdHlwZV9Ob2RlczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGVfTm9kZV9UeXBlcycsIHVuZGVmaW5lZCkpID0+IG9iai50eXBlX05vZGVzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTm9kZV9UeXBlKSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLk5vZGVfVHlwZSA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCBzcWwgPSBuZXcgc2FsZXNub3cuTm9kZV9UeXBlKCkKCgkJCQkJLnR5cGVfTm9kZXMobmV3IHNhbGVzbm93Lk5vZGUoKSkKCgkJCQkJLl90b1NRTFRhYmxlKGRlcHRoKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIk5vZGUgVHlwZSIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlkeW5hbWljOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5keW5hbWljID0gdiA9PSBxdWVyeS5keW5hbWljKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2R5bmFtaWNfc2V0ICYmICFxdWVyeS5fZHluYW1pY19zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZHluYW1pYyA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9keW5hbWljX3NldCAmJiBxdWVyeS5fZHluYW1pY19zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmR5bmFtaWMgPSBmYWxzZTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCXR5cGVfTm9kZXM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoudHlwZV9Ob2RlcyA9IHYubWFwKF92ID0+IHF1ZXJ5LnR5cGVfTm9kZXMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXR5cGVfTm9kZXM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoudHlwZV9Ob2RlcyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fZHluYW1pY19zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXR5cGVfTm9kZXM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy50eXBlX05vZGVzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ107CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJZHluYW1pYzogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2R5bmFtaWMnLCB1bmRlZmluZWQpIDogImR5bmFtaWMiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZHluYW1pY19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZHluYW1pYyhyZWYpOwoKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvZGUocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kYXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoJCQkJCWlmICh0eXBlb2YobW9tZW50KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZWYgPSBuZXcgRGF0ZShyZWYpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmVmID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpKTsKCQkJCX0KCQkJCXRoaXMuZGF0ZShyZWYpOwoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm5hbWUocmVmKTsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZW1hcmtfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnJlbWFyayhyZWYpOwoKCQkJfSwKCgkJCXR5cGVfTm9kZXM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0eXBlX05vZGVfVHlwZXMnLCB1bmRlZmluZWQpIDogInR5cGVfTm9kZXMiKSkgPT4gdGhpcy50eXBlX05vZGVzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5Ob2RlKCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddID0gdiwKCgkJCSJkeW5hbWljIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2R5bmFtaWMnLCB1bmRlZmluZWQpIDogImR5bmFtaWMiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZHluYW1pY19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZHluYW1pY19jb29wOwoJCQkJfQoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQkJdHlwZV9Ob2RlczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3R5cGVfTm9kZV9UeXBlcycsIHVuZGVmaW5lZCkgOiAidHlwZV9Ob2RlcyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl90eXBlX05vZGVzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl90eXBlX05vZGVzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuX25hbWU7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IHRydWU7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGVfVHlwZS5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuTm9kZV9UeXBlKG51bGwsIHRoaXMuVG9vbCk7CgoJCQkJbGV0IGJGaW5kID0gZmFsc2U7CgkJCQlpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLklkID0gdGhpcy5JZDsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5uYW1lKHRoaXMubmFtZSgpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24pID09PSAidW5kZWZpbmVkIiB8fCBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nQkVHSU4nOidTVEFSVCd9IFRSQU5TQUNUSU9OYCk7CgkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gPSB7CgkJCQkJCQlPd25lcjogdGhpcywKCQkJCQkJCXNxbHM6IFtdLAoJCQkJCQkJc3RhcnQ6IG5ldyBEYXRlKCksCgkJCQkJCQllbmQ6IG51bGwKCQkJCQkJfTsKCQkJCQl9CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl90eXBlX05vZGVzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMudHlwZV9Ob2RlcygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGVfVHlwZS5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvSW5zZXJ0U1FMKCkpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnaW5zZXJ0JywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlLl9wYXJlbnQpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlX1R5cGUudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlLl9wYXJlbnQpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGVfVHlwZS5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSAoYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgKTsKCQkJCXJldCA9IHJldCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5Ob2RlX1R5cGUobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoKCX0KCn07CgpzYWxlc25vdy5NYXBwaW5nID0gY2xhc3MgTWFwcGluZyBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFpZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKT2IyUmxJanA3SW01dlJHVjBaV04wSWpwMGNuVmxMQ0pwYm1sMExtVnVaSE1pT2pJc0ltbHVhWFF1Ykc5dmNDSTZNQzQxTENKMGIyOXNjeTV6ZEc5eVpTSTZabUZzYzJVc0ltUmxkR1ZqZEZCaGNtVnVkQzVKVUNJNklqRTVOUzR4TVRJdU1qRTJMakUzTXlJc0ltUmxkR1ZqZEZCaGNtVnVkQzVqYjJSbElqb2laVGhrWlRBMlpUTmxaR00wTkROaFpUbGtabVV4WkdVMVpXTTFNbUUwWW1ZaUxDSnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wc0lsUnZiMndpT25zaVoybDBhSFZpTG5SdmIyeHpJam9pYUhSMGNITTZMeTl5WVhjdVoybDBhSFZpZFhObGNtTnZiblJsYm5RdVkyOXRMMlpoWkdsdUwyWmhaR2x1TG1kcGRHaDFZaTVwYnk5dFlYTjBaWEl2SWl3aWMyVmpjbVYwSWpvaWIxTkxkMmRhTW5OTFJrOVVTVXBqWWtGbVZVbFJORU5xT1hGelNEUTRibXdpTENKd2JHRjVaM0p2ZFc1a0lqcDBjblZsTENKblVsQkRJanAwY25WbExDSnpkRzl5WlM1elpXNXphWFJwZG1sMGVTSTZNU3dpWTI5dGNHRnVlU0k2SW5KbGMzVnRaU0o5TENKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzSWtkcGRFaDFZaUpkYCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2FjdGl2ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2VuYWJsZWQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjbGFzc05hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NsYXNzTmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInNjb3BlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9zY29wZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvbnRleHQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvbnRleHQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJzb3VyY2UiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3NvdXJjZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInRhcmdldCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfdGFyZ2V0KCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3BlcmF0b3IiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29wZXJhdG9yKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiaW5TY3JpcHQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2luU2NyaXB0KCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3V0U2NyaXB0IiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vdXRTY3JpcHQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJ0b29sIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl90b29sKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAidHlwZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfdHlwZSgpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIk1hcHBpbmciLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCXJldHVybiB0aGlzOwoKCQlpZiAodGhpcy5fdG9vbF9zZXQgJiYgdGhpcy5fdG9vbCkgdGhpcy5fdG9vbC5Ub29sID0gdG9vbDsKCgkJaWYgKHRoaXMuX3R5cGVfc2V0ICYmIHRoaXMuX3R5cGUpIHRoaXMuX3R5cGUuVG9vbCA9IHRvb2w7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNsYXNzTmFtZSAqKi8KCWNsYXNzTmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NsYXNzTmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNsYXNzTmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY2xhc3NOYW1lICE9IHYpIHsKCQkJCXRoaXMuX2NsYXNzTmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY2xhc3NOYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NsYXNzTmFtZSk7CgkJfQoJfQoKCWNsZWFyX2NsYXNzTmFtZSgpIHsKCQl0aGlzLl9jbGFzc05hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jbGFzc05hbWUgPSBudWxsOwoJCXRoaXMuX2NsYXNzTmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY2xhc3NOYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc2NvcGUgKiovCglzY29wZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3Njb3BlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgic2NvcGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3Njb3BlICE9IHYpIHsKCQkJCXRoaXMuX3Njb3BlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9zY29wZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9zY29wZSk7CgkJfQoJfQoKCWNsZWFyX3Njb3BlKCkgewoJCXRoaXMuX3Njb3BlX3NldCA9IG51bGw7CgkJdGhpcy5fc2NvcGUgPSBudWxsOwoJCXRoaXMuX3Njb3BlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBzY29wZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvbnRleHQgKiovCgljb250ZXh0KHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29udGV4dF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvbnRleHQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvbnRleHQgIT0gdikgewoJCQkJdGhpcy5fY29udGV4dF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29udGV4dCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb250ZXh0KTsKCQl9Cgl9CgoJY2xlYXJfY29udGV4dCgpIHsKCQl0aGlzLl9jb250ZXh0X3NldCA9IG51bGw7CgkJdGhpcy5fY29udGV4dCA9IG51bGw7CgkJdGhpcy5fY29udGV4dF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29udGV4dCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHNvdXJjZSAqKi8KCXNvdXJjZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3NvdXJjZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInNvdXJjZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fc291cmNlICE9IHYpIHsKCQkJCXRoaXMuX3NvdXJjZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fc291cmNlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3NvdXJjZSk7CgkJfQoJfQoKCWNsZWFyX3NvdXJjZSgpIHsKCQl0aGlzLl9zb3VyY2Vfc2V0ID0gbnVsbDsKCQl0aGlzLl9zb3VyY2UgPSBudWxsOwoJCXRoaXMuX3NvdXJjZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc291cmNlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdGFyZ2V0ICoqLwoJdGFyZ2V0KHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fdGFyZ2V0X2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgidGFyZ2V0Iik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl90YXJnZXQgIT0gdikgewoJCQkJdGhpcy5fdGFyZ2V0X3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl90YXJnZXQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fdGFyZ2V0KTsKCQl9Cgl9CgoJY2xlYXJfdGFyZ2V0KCkgewoJCXRoaXMuX3RhcmdldF9zZXQgPSBudWxsOwoJCXRoaXMuX3RhcmdldCA9IG51bGw7CgkJdGhpcy5fdGFyZ2V0X2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0YXJnZXQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcGVyYXRvciAqKi8KCW9wZXJhdG9yKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3BlcmF0b3JfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcGVyYXRvciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3BlcmF0b3IgIT0gdikgewoJCQkJdGhpcy5fb3BlcmF0b3Jfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29wZXJhdG9yID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29wZXJhdG9yKTsKCQl9Cgl9CgoJY2xlYXJfb3BlcmF0b3IoKSB7CgkJdGhpcy5fb3BlcmF0b3Jfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcGVyYXRvciA9IG51bGw7CgkJdGhpcy5fb3BlcmF0b3JfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9wZXJhdG9yICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgaW5TY3JpcHQgKiovCglpblNjcmlwdCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2luU2NyaXB0X2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiaW5TY3JpcHQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2luU2NyaXB0ICE9IHYpIHsKCQkJCXRoaXMuX2luU2NyaXB0X3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9pblNjcmlwdCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5faW5TY3JpcHQpOwoJCX0KCX0KCgljbGVhcl9pblNjcmlwdCgpIHsKCQl0aGlzLl9pblNjcmlwdF9zZXQgPSBudWxsOwoJCXRoaXMuX2luU2NyaXB0ID0gbnVsbDsKCQl0aGlzLl9pblNjcmlwdF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgaW5TY3JpcHQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvdXRTY3JpcHQgKiovCglvdXRTY3JpcHQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vdXRTY3JpcHRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvdXRTY3JpcHQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX291dFNjcmlwdCAhPSB2KSB7CgkJCQl0aGlzLl9vdXRTY3JpcHRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX291dFNjcmlwdCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3V0U2NyaXB0KTsKCQl9Cgl9CgoJY2xlYXJfb3V0U2NyaXB0KCkgewoJCXRoaXMuX291dFNjcmlwdF9zZXQgPSBudWxsOwoJCXRoaXMuX291dFNjcmlwdCA9IG51bGw7CgkJdGhpcy5fb3V0U2NyaXB0X2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvdXRTY3JpcHQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0b29sICoqLwoJdG9vbCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3Rvb2xfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJ0b29sIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnMzJlODExNzMtMmFiMi00NjYyLWE3MDYtMWMzOGUzNTkyNGRlJyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnVG9vbCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0b29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiMzJlODExNzMtMmFiMi00NjYyLWE3MDYtMWMzOGUzNTkyNGRlIiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIlRvb2wiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fdG9vbCAhPSB2KSB7CgkJCQl0aGlzLl90b29sX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fdG9vbCA/IHRoaXMuX3Rvb2wuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX3Rvb2xfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX3Rvb2wgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fdG9vbCk7CgkJfQoJfQoKCWNsZWFyX3Rvb2woKSB7CgkJdGhpcy5fdG9vbF9zZXQgPSBudWxsOwoJCXRoaXMuX3Rvb2wgPSBudWxsOwoJCXRoaXMuX3Rvb2xfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHRvb2wgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0eXBlICoqLwoJdHlwZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3R5cGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJ0eXBlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnZDA3OTA4M2EtZjBjMC00N2ZhLWEzOTctOWI1Yjg2NGVkNTcyJyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnVG9vbCBUeXBlJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3R5cGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICJkMDc5MDgzYS1mMGMwLTQ3ZmEtYTM5Ny05YjViODY0ZWQ1NzIiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiVG9vbCBUeXBlIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3R5cGUgIT0gdikgewoJCQkJdGhpcy5fdHlwZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3R5cGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX3R5cGUgPyB0aGlzLl90eXBlLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl90eXBlX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl90eXBlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3R5cGUpOwoJCX0KCX0KCgljbGVhcl90eXBlKCkgewoJCXRoaXMuX3R5cGVfc2V0ID0gbnVsbDsKCQl0aGlzLl90eXBlID0gbnVsbDsKCQl0aGlzLl90eXBlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0eXBlICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fb3JkZXJfc2V0LAoKCQkJdGhpcy5fY2xhc3NOYW1lX3NldCwKCgkJCXRoaXMuX3Njb3BlX3NldCwKCgkJCXRoaXMuX2NvbnRleHRfc2V0LAoKCQkJdGhpcy5fc291cmNlX3NldCwKCgkJCXRoaXMuX3RhcmdldF9zZXQsCgoJCQl0aGlzLl9vcGVyYXRvcl9zZXQsCgoJCQl0aGlzLl9pblNjcmlwdF9zZXQsCgoJCQl0aGlzLl9vdXRTY3JpcHRfc2V0LAoKCQkJdGhpcy5fdG9vbF9zZXQsCgoJCQl0aGlzLl90eXBlX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX2FjdGl2ZV9zZXQgPSB0aGlzLl9hY3RpdmVfc2V0OwoJCXJldC5fYWN0aXZlX2Nvb3AgPSB0aGlzLl9hY3RpdmVfY29vcDsKCQlyZXQuYWN0aXZlID0gdGhpcy5hY3RpdmUoKSA/IHRoaXMuYWN0aXZlKCkgOiB0aGlzLmFjdGl2ZSgpOwoKCQlyZXQuX2VuYWJsZWRfc2V0ID0gdGhpcy5fZW5hYmxlZF9zZXQ7CgkJcmV0Ll9lbmFibGVkX2Nvb3AgPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJcmV0LmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKSA/IHRoaXMuZW5hYmxlZCgpIDogdGhpcy5lbmFibGVkKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2NsYXNzTmFtZV9zZXQgPSB0aGlzLl9jbGFzc05hbWVfc2V0OwoJCXJldC5fY2xhc3NOYW1lX2Nvb3AgPSB0aGlzLl9jbGFzc05hbWVfY29vcDsKCQlyZXQuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUoKSA/IHRoaXMuY2xhc3NOYW1lKCkgOiB0aGlzLmNsYXNzTmFtZSgpOwoKCQlyZXQuX3Njb3BlX3NldCA9IHRoaXMuX3Njb3BlX3NldDsKCQlyZXQuX3Njb3BlX2Nvb3AgPSB0aGlzLl9zY29wZV9jb29wOwoJCXJldC5zY29wZSA9IHRoaXMuc2NvcGUoKSA/IHRoaXMuc2NvcGUoKSA6IHRoaXMuc2NvcGUoKTsKCgkJcmV0Ll9jb250ZXh0X3NldCA9IHRoaXMuX2NvbnRleHRfc2V0OwoJCXJldC5fY29udGV4dF9jb29wID0gdGhpcy5fY29udGV4dF9jb29wOwoJCXJldC5jb250ZXh0ID0gdGhpcy5jb250ZXh0KCkgPyB0aGlzLmNvbnRleHQoKSA6IHRoaXMuY29udGV4dCgpOwoKCQlyZXQuX3NvdXJjZV9zZXQgPSB0aGlzLl9zb3VyY2Vfc2V0OwoJCXJldC5fc291cmNlX2Nvb3AgPSB0aGlzLl9zb3VyY2VfY29vcDsKCQlyZXQuc291cmNlID0gdGhpcy5zb3VyY2UoKSA/IHRoaXMuc291cmNlKCkgOiB0aGlzLnNvdXJjZSgpOwoKCQlyZXQuX3RhcmdldF9zZXQgPSB0aGlzLl90YXJnZXRfc2V0OwoJCXJldC5fdGFyZ2V0X2Nvb3AgPSB0aGlzLl90YXJnZXRfY29vcDsKCQlyZXQudGFyZ2V0ID0gdGhpcy50YXJnZXQoKSA/IHRoaXMudGFyZ2V0KCkgOiB0aGlzLnRhcmdldCgpOwoKCQlyZXQuX29wZXJhdG9yX3NldCA9IHRoaXMuX29wZXJhdG9yX3NldDsKCQlyZXQuX29wZXJhdG9yX2Nvb3AgPSB0aGlzLl9vcGVyYXRvcl9jb29wOwoJCXJldC5vcGVyYXRvciA9IHRoaXMub3BlcmF0b3IoKSA/IHRoaXMub3BlcmF0b3IoKSA6IHRoaXMub3BlcmF0b3IoKTsKCgkJcmV0Ll9pblNjcmlwdF9zZXQgPSB0aGlzLl9pblNjcmlwdF9zZXQ7CgkJcmV0Ll9pblNjcmlwdF9jb29wID0gdGhpcy5faW5TY3JpcHRfY29vcDsKCQlyZXQuaW5TY3JpcHQgPSB0aGlzLmluU2NyaXB0KCkgPyB0aGlzLmluU2NyaXB0KCkgOiB0aGlzLmluU2NyaXB0KCk7CgoJCXJldC5fb3V0U2NyaXB0X3NldCA9IHRoaXMuX291dFNjcmlwdF9zZXQ7CgkJcmV0Ll9vdXRTY3JpcHRfY29vcCA9IHRoaXMuX291dFNjcmlwdF9jb29wOwoJCXJldC5vdXRTY3JpcHQgPSB0aGlzLm91dFNjcmlwdCgpID8gdGhpcy5vdXRTY3JpcHQoKSA6IHRoaXMub3V0U2NyaXB0KCk7CgoJCXJldC5fdG9vbF9zZXQgPSB0aGlzLl90b29sX3NldDsKCQlyZXQuX3Rvb2xfY29vcCA9IHRoaXMuX3Rvb2xfY29vcDsKCQlyZXQudG9vbCA9IHRoaXMudG9vbCgpID8gdGhpcy50b29sKCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMudG9vbCgpOwoKCQlyZXQuX3R5cGVfc2V0ID0gdGhpcy5fdHlwZV9zZXQ7CgkJcmV0Ll90eXBlX2Nvb3AgPSB0aGlzLl90eXBlX2Nvb3A7CgkJcmV0LnR5cGUgPSB0aGlzLnR5cGUoKSA/IHRoaXMudHlwZSgpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLnR5cGUoKTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY2xhc3NOYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NsYXNzTmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInNjb3BlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Njb3BlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29udGV4dCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250ZXh0JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkic291cmNlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3NvdXJjZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInRhcmdldCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0YXJnZXQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcGVyYXRvciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcGVyYXRvcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImluU2NyaXB0IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2luU2NyaXB0JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3V0U2NyaXB0IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ291dFNjcmlwdCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInRvb2wiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndG9vbCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJInR5cGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQl9LCAiX3RvSGFzaCIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMuTm9Db2RlID8gb0hhc2ggOiB0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7Cgl9CgoJYXN5bmMgX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOwoKCX0KCglfcWxTZWxlY3Rpb25zKHNTZXQpIHsKCQlsZXQgcmV0ID0gW107CgkJaWYgKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7CgoJCXNTZXQuc2VsZWN0aW9ucy5maWx0ZXIocyA9PiBzLnNlbGVjdGlvblNldCkuZm9yRWFjaChzID0+IHsKCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInRvb2wiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIHRvb2wnLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93LlRvb2woKS50b29sX01hcHBpbmdzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAidHlwZSIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgdHlwZScsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuVG9vbF9UeXBlKCkudHlwZV9NYXBwaW5ncyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpICE9ICdNYXBwaW5nJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL01hcHBpbmcvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQkJZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOwoJCQkJZGVsZXRlIGRhdGEuX190aGlzLm9ubGluZTsKCgkJCX0KCgkJCS8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/PwoKCQkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJCXRyeSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0pIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7bWV0aG9kfWApOwoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCWxldCBfaWQgPSBudWxsOwoJCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBkYXRhLCBtZXRob2QsIHt9KTsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRhdGEpID09PSAnc3RyaW5nJykgewoJCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUoZGF0YSk7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IGRhdGEuX190aGlzLmNvZGUgfHwgZGF0YS5pZCB8fCBkYXRhLklEOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJCWlmIChkYXRhLklkICYmIGRhdGEuSWQgPT0gZGF0YS5JZCkgewoJCQkJCQlfaWQgPSBkYXRhLklkOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQkJfSBlbHNlIGlmIChkYXRhLkVudGl0eUNsYXNzKSB7CgkJCQkJCV9pZCA9IGRhdGEuRW50aXR5Q2xhc3MuSWQgfHwgZGF0YS5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjU0YzIxZmFhLTIzMDctNGIyYy04YWY0LTE3YWExZDhjNTUwYSIgfHwgIk5VTEwiOwoJCQkJCX0KCQkJCX0KCgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZyA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZyB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZ1ttZXRob2RdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nW21ldGhvZF0gfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk1hcHBpbmdbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nW21ldGhvZF1bX2lkXSB8fCB7fTsKCgkJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goe30sIHsKCQkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQkJfSk7CgoJCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZ1ttZXRob2RdW19pZF1bX2hhc2hdOwoJCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiA1KSkgewoJCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gbWV0aG9kIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJCXYucmV1c2VkKys7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhKTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZ1ttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnTWFwcGluZycpLnNlbmRlcihzYWxlc25vdy5fbm9kZSkuY2FycmllcihzYWxlc25vdy5fbm9kZSkucGF5bG9hZChkYXRhKTsKCQkJaWYgKGV2ZW50KSB7CgkJCQlpZiAoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7CgkJCQlpZiAoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7CgkJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7CgkJCQlpZiAoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7CgkJCX0KCQkJcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOwoKCQkJaWYgKHR5cGVvZihyZXQpID09PSAic3RyaW5nIikgewoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChleCkge30KCQkJfQoJCQlyZXR1cm4gcmV0OwoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93Lk1hcHBpbmcobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93Lk1hcHBpbmcobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuTWFwcGluZygpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOwoJCX0KCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgTWFwcGluZy5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYE1hcHBpbmcuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZy5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5NYXBwaW5nLicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlIHx8ICJNYXBwaW5nIik7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCWlmICh0aGlzLl90b29sX3NldCAmJiB0aGlzLnRvb2woKSkgdGhpcy50b29sKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX3R5cGVfc2V0ICYmIHRoaXMudHlwZSgpKSB0aGlzLnR5cGUoKS5fX3N5bmNfb24oZCk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93Lk1hcHBpbmcodGhpcy5JZCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLm9yZGVyKHRoaXMub3JkZXIoKSwgdGhpcy5fb3JkZXJfY29vcCkKCgkJCS5jbGFzc05hbWUodGhpcy5jbGFzc05hbWUoKSwgdGhpcy5fY2xhc3NOYW1lX2Nvb3ApCgoJCQkuc2NvcGUodGhpcy5zY29wZSgpLCB0aGlzLl9zY29wZV9jb29wKQoKCQkJLmNvbnRleHQodGhpcy5jb250ZXh0KCksIHRoaXMuX2NvbnRleHRfY29vcCkKCgkJCS5zb3VyY2UodGhpcy5zb3VyY2UoKSwgdGhpcy5fc291cmNlX2Nvb3ApCgoJCQkudGFyZ2V0KHRoaXMudGFyZ2V0KCksIHRoaXMuX3RhcmdldF9jb29wKQoKCQkJLm9wZXJhdG9yKHRoaXMub3BlcmF0b3IoKSwgdGhpcy5fb3BlcmF0b3JfY29vcCkKCgkJCS5pblNjcmlwdCh0aGlzLmluU2NyaXB0KCksIHRoaXMuX2luU2NyaXB0X2Nvb3ApCgoJCQkub3V0U2NyaXB0KHRoaXMub3V0U2NyaXB0KCksIHRoaXMuX291dFNjcmlwdF9jb29wKQoKCQkJLnRvb2wodGhpcy50b29sKCksIHRoaXMuX3Rvb2xfY29vcCkKCgkJCS50eXBlKHRoaXMudHlwZSgpLCB0aGlzLl90eXBlX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQlvYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ01hcHBpbmcnOwoJCXRvb2wgPSB0b29sIHx8IHRoaXMuVG9vbDsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJNYXBwaW5nIjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCQkJCXJldCA9IHJldC50b0xvd2VyQ2FzZSgpOwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCQl0cnkgewoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgPyAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gb3B0aW9ucy50b29sIHx8IHQgPT0gb3B0aW9ucy50b29sKSA6IHRoaXMuVG9vbDsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sIHx8IHt9OwoKCQkJbGV0IG5JRCA9IHNhbGVzbm93Ll9ub2RlID8gc2FsZXNub3cuX25vZGUuY29kZSgpIDogImRlZmF1bHQiOwoKCQkJbGV0IHJldCA9IG51bGxWYWx1ZTsKCQkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0ID0gbnVsbDsKCgkJCS8vIHRvb2xfQ29uZmlnczogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBkb25lCgkJCWxldCB0Y29uZiA9IChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiBjLm5vZGUgJiYgYy5ub2RlLmNvZGUgPT0gbklEKS5jb25jYXQoKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmICFjLm5vZGUpKTsKCQkJaWYgKHRjb25mLmxlbmd0aCkgewoJCQkJcmV0ID0gdGNvbmZbMF0udmFsdWU7CgkJCQl0cnkgewoJCQkJCXJldCA9IEpTT04ucGFyc2UocmV0KTsKCQkJCX0gY2F0Y2ggKGpleCkge30KCQkJfQoKCQkJLy8gbW9kZWwgQ29uZmlnOiBDb25maWcgaXMgY2xhc3MgbGV2ZWwsIG5vZGUgbm90IHBvc3NpYmxlIC0gcGVuZGluZwoJCQlsZXQgbWNvbmYgPSB0aGlzLkNvbmZpZyA/IHRoaXMuQ29uZmlnW25dIDogdW5kZWZpbmVkOwoJCQlpZiAodHlwZW9mKG1jb25mKSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IG1jb25mOwoKCQkJLy8gY29tbWFuZCBsaW5lOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiBnbG9iYWwubWluaW1pc3QpIHsKCQkJCXJldCA9IGdsb2JhbC5taW5pbWlzdChwcm9jZXNzLmFyZ3Yuc2xpY2UoMikpW25dIHx8IHJldDsKCQkJfQoKCQkJLy8gcmVxdWVzdDogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCXJldCA9IHRoaXMuJF9SRVFVRVNUKG4pIHx8IHJldDsKCgkJCWlmIChvcHRpb25zLm5ld1ZhbHVlKSB7CgkJCQlsZXQgdGMgPSB0Y29uZi5sZW5ndGggPyB0Y29uZlswXSA6IHt9OwoJCQkJdGMubm9kZSA9IHsKCQkJCQljb2RlOiBvcHRpb25zLm5vZGUuY29kZSgpCgkJCQl9OwoJCQkJdGMudmFsdWUgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQkJdGMubmFtZSA9IG47CgkJCQlpZiAoIXRjb25mLmxlbmd0aCkgewoJCQkJCW9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MucHVzaCh0Yyk7CgkJCQl9CgkJCQlyZXQgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQl9CgoJCQkvLyBjb25maWcgcmVwbGFjZW1lbnQKCQkJaWYgKHR5cGVvZihyZXQpID09PSAnc3RyaW5nJykocmV0Lm1hdGNoKG5ldyBSZWdFeHAoYHt7KFtefV0rKX19YCwgImciKSkgfHwgW10pLmZvckVhY2gobSA9PiByZXQgPSByZXQucmVwbGFjZShtLCB0aGlzLl9fY29uZmlnKG0ucmVwbGFjZSgne3snLCAnJykucmVwbGFjZSgnfX0nLCAnJyksIG51bGwsIG9wdGlvbnMpKSk7CgoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fY29uZmlnJywgJ0VudGl0eU9iamVjdCcsIDEsIG4sIG51bGxWYWx1ZSwgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncywgZXgpOwoJCX0KCX0KCglfdG9TUUxUYWJsZSgpIHsKCQlsZXQgcmV0ID0gewoJCQlzcWw6IGBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9ICgKICAgICAgICAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3Njb3BlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvbnRleHQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc291cmNlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3RhcmdldCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcGVyYXRvcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdpblNjcmlwdCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3V0U2NyaXB0JywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgYAoJCX07CgkJcmV0LnNxbCArPSAnLypNYXBwaW5nKi8pO1xuJzsKCgkJcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogdHJ1ZSwKCQkJTnVsbDogdHJ1ZSwKCQkJLy9JZDogKG9iaiwgdikgPT4gb2JqLnNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVlgLAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiY2xhc3NOYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NsYXNzTmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjbGFzc05hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkic2NvcGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc2NvcGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc2NvcGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiY29udGV4dCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250ZXh0JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvbnRleHQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkic291cmNlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3NvdXJjZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdzb3VyY2UnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkidGFyZ2V0IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3RhcmdldCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd0YXJnZXQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkib3BlcmF0b3IiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3BlcmF0b3InLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3BlcmF0b3InLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiaW5TY3JpcHQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnaW5TY3JpcHQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnaW5TY3JpcHQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm91dFNjcmlwdCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvdXRTY3JpcHQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3V0U2NyaXB0JywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJ0b29sIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndG9vbCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkidHlwZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypNYXBwaW5nKi8pO1xuJzsKCgkJcmV0LnNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQocmV0LnNxbCkgOiByZXQuc3FsOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TUUxUYWJsZScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQuc3FsKTsKCQlyZXR1cm4gcmV0LnNxbDsKCX0KCglfZnJvbVNRTFRhYmxlKHRhYmxlLCBmaWVsZHMpIHsKCQkvLyB0YWJsZSBpcyBhIGpzb24gYXJyYXkKCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuYWN0aXZlKHRhYmxlWyJhY3RpdmUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZW5hYmxlZCh0YWJsZVsiZW5hYmxlZCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNsYXNzTmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY2xhc3NOYW1lKHRhYmxlWyJjbGFzc05hbWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigic2NvcGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnNjb3BlKHRhYmxlWyJzY29wZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb250ZXh0IikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5jb250ZXh0KHRhYmxlWyJjb250ZXh0Il0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInNvdXJjZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuc291cmNlKHRhYmxlWyJzb3VyY2UiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigidGFyZ2V0IikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy50YXJnZXQodGFibGVbInRhcmdldCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcGVyYXRvciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3BlcmF0b3IodGFibGVbIm9wZXJhdG9yIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImluU2NyaXB0IikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5pblNjcmlwdCh0YWJsZVsiaW5TY3JpcHQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3V0U2NyaXB0IikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5vdXRTY3JpcHQodGFibGVbIm91dFNjcmlwdCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJ0b29sIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy50b29sKHRhYmxlWyJ0b29sIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInR5cGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnR5cGUodGFibGVbInR5cGUiXSk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBfc3FsKHNxbCwgc291cmNlID0gdGhpcykgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsKHNxbCwgdGhpcyk7CgoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJCQkvLyBpZih0aGlzWydfJytmaWVsZCsnX3NldCddICYmICh0eXBlb2YodGhpc1snXycrZmllbGRdKT09PSd1bmRlZmluZWQnIHx8IHRoaXNbJ18nK2ZpZWxkXT09bnVsbCkpIHJldHVybjsKCQkJCQkvLyBpZih0eXBlb2YoZWFPYmopPT09J3VuZGVmaW5lZCcpIHJldHVybjsgLy8gd2h5PwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJjbGFzc05hbWUiLCBvYmosIHRoaXMuY2xhc3NOYW1lKCkpOwoKCQlfb3B0aW9ucygic2NvcGUiLCBvYmosIHRoaXMuc2NvcGUoKSk7CgoJCV9vcHRpb25zKCJjb250ZXh0Iiwgb2JqLCB0aGlzLmNvbnRleHQoKSk7CgoJCV9vcHRpb25zKCJzb3VyY2UiLCBvYmosIHRoaXMuc291cmNlKCkpOwoKCQlfb3B0aW9ucygidGFyZ2V0Iiwgb2JqLCB0aGlzLnRhcmdldCgpKTsKCgkJX29wdGlvbnMoIm9wZXJhdG9yIiwgb2JqLCB0aGlzLm9wZXJhdG9yKCkpOwoKCQlfb3B0aW9ucygiaW5TY3JpcHQiLCBvYmosIHRoaXMuaW5TY3JpcHQoKSk7CgoJCV9vcHRpb25zKCJvdXRTY3JpcHQiLCBvYmosIHRoaXMub3V0U2NyaXB0KCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiNTRjMjFmYWEtMjMwNy00YjJjLThhZjQtMTdhYTFkOGM1NTBhIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk1hcHBpbmcgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk1hcHBpbmcgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZ1tmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZ1tmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk1hcHBpbmdbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZ1tmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZ1tmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlpZiAoIXRoaXMudG9vbCgpIHx8ICh0aGlzLnRvb2woKQoKCQkJCSYmCgkJCQkhdGhpcy50b29sKCkudG9vbF9Db25maWdzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnRvb2woKS50b29sX01hcHBpbmdzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJ0b29sIiwgb2JqLCB0aGlzLnRvb2woKSk7CgkJfQoKCQlpZiAoIXRoaXMudHlwZSgpIHx8ICh0aGlzLnR5cGUoKQoKCQkJCSYmCgkJCQkhdGhpcy50eXBlKCkudHlwZV9Ub29scygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy50eXBlKCkudHlwZV9NYXBwaW5ncygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygidHlwZSIsIG9iaiwgdGhpcy50eXBlKCkpOwoJCX0KCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnb3JkZXInLCAnY2xhc3NOYW1lJywgJ3Njb3BlJywgJ2NvbnRleHQnLCAnc291cmNlJywgJ3RhcmdldCcsICdvcGVyYXRvcicsICdpblNjcmlwdCcsICdvdXRTY3JpcHQnLCAndG9vbCcsICd0eXBlJ10pLmNvbmNhdChbJyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlmYWxzZSAmJiBbXS5jb25jYXQodGhpcy5Ub29sLnR5cGUudHlwZV9NYXBwaW5ncyB8fCBbXSkuY29uY2F0KHRoaXMuVG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5maWx0ZXIobSA9PiBtLmNsYXNzTmFtZSA9PSAiTWFwcGluZyIgJiYgKG0udGFyZ2V0IHx8IG0ub3V0U2NyaXB0KSAmJiBtLmFjdGl2ZSAmJiBtLmVuYWJsZWQgJiYgKChtLnRvb2wgJiYgbS50b29sLm5hbWUgPT0gdGhpcy5Ub29sLm5hbWUpIHx8IChtLnR5cGUgJiYgbS50eXBlLm5hbWUgPT0gdGhpcy5Ub29sLnR5cGUubmFtZSkpICYmICghbS5zb3VyY2UgfHwgKG0uc291cmNlICYmIC8qIW0ub3V0U2NyaXB0ICYmKi8gdGhpc1snXycgKyBtLnNvdXJjZSArICdfc2V0J10pKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLm91dFNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcywgb1Njb3BlLCBtYXApID0+IHske20ub3V0U2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20ub3V0U2NyaXB0fSl9YCkodGhpcywgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0uc291cmNlKSB7CgkJCQlpZiAobS5zb3VyY2UuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzKSA9PiB7cmV0dXJuIF90aGlzLiR7bS5zb3VyY2V9O31gKSh0aGlzKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0uc291cmNlLCB0aGlzKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS50YXJnZXQpIG9ialttLnRhcmdldF0gPSByZXQ7CgkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCVttLnRhcmdldCB8fCBtLnNvdXJjZV06IHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXQoJCQl9KTsKCQl9KTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQkvLyB1c2UgdGhpcy5fbWFwKCkgd2l0aCByZXZlcnNlCgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJjbGFzc05hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygic2NvcGUiLCBvYmopOwoKCQlfb3B0aW9ucygiY29udGV4dCIsIG9iaik7CgoJCV9vcHRpb25zKCJzb3VyY2UiLCBvYmopOwoKCQlfb3B0aW9ucygidGFyZ2V0Iiwgb2JqKTsKCgkJX29wdGlvbnMoIm9wZXJhdG9yIiwgb2JqKTsKCgkJX29wdGlvbnMoImluU2NyaXB0Iiwgb2JqKTsKCgkJX29wdGlvbnMoIm91dFNjcmlwdCIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiNTRjMjFmYWEtMjMwNy00YjJjLThhZjQtMTdhYTFkOGM1NTBhIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk1hcHBpbmcgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk1hcHBpbmcgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZ1tmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZ1tmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk1hcHBpbmdbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZ1tmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcyk7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZ1tmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJ0b29sIiwgb2JqKTsKCgkJX29wdGlvbnMoInR5cGUiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhY3RpdmUnLCAnZW5hYmxlZCcsICdvcmRlcicsICdjbGFzc05hbWUnLCAnc2NvcGUnLCAnY29udGV4dCcsICdzb3VyY2UnLCAndGFyZ2V0JywgJ29wZXJhdG9yJywgJ2luU2NyaXB0JywgJ291dFNjcmlwdCcsICd0b29sJywgJ3R5cGUnXSkuY29uY2F0KFsnJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJNYXBwaW5nIiAmJiAobS5zb3VyY2UgfHwgbS5pblNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLmluU2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaiwgb1Njb3BlLCBtYXApID0+IHske20uaW5TY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5pblNjcmlwdH0pfWApKG9iaiwgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0udGFyZ2V0KSB7CgkJCQlpZiAobS50YXJnZXQuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaikgPT4ge3JldHVybiBvYmouJHttLnRhcmdldH07fWApKG9iaik7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmpbbS50YXJnZXRdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS50YXJnZXQsIG9iaik7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS5zb3VyY2UpIHsKCQkJCWlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0ocmV0KTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0gPSByZXQ7CgkJCQl9CgkJCX0KCQl9KTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXTogIiciICsgdGhpcy5JZCArICInIgoJCX07CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2FjdGl2ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hY3RpdmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9lbmFibGVkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjbGFzc05hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY2xhc3NOYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNsYXNzTmFtZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigic2NvcGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fc2NvcGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuc2NvcGUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3Njb3BlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29udGV4dCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9jb250ZXh0X3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNvbnRleHQoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2NvbnRleHQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJzb3VyY2UiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fc291cmNlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnNvdXJjZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnc291cmNlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigidGFyZ2V0IikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3RhcmdldF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy50YXJnZXQoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3RhcmdldCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9wZXJhdG9yIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29wZXJhdG9yX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9wZXJhdG9yKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcGVyYXRvcicsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImluU2NyaXB0IikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2luU2NyaXB0X3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmluU2NyaXB0KCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdpblNjcmlwdCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm91dFNjcmlwdCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9vdXRTY3JpcHRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMub3V0U2NyaXB0KCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvdXRTY3JpcHQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJ0b29sIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3Rvb2xfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnRvb2woKTsKCgkJCWlmICh2ICYmICh2Ll9fc3luY19vbigpIHx8IHYuSWQgPT0gdi5JZCkpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYuSWQgKyAiJyI7CgkJCX0gZWxzZSB7CgkJCQlmVmFsdWUgPSAwOwoJCQl9CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInR5cGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fdHlwZV9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMudHlwZSgpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJyB8fCB0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIHsKCQkJX28gPSBfcSA9ICdgJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3Fsc2VydmVyJykgewoJCQlfbyA9ICdbJzsKCQkJX3EgPSAnXSc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCdhcGlLZXknKSA9PSAnYWlydGFibGUnKSB7CgkJCV9vID0gJ3snOwoJCQlfcSA9ICd9JzsKCQl9CgkJdGhpcy5fX1EgPSB0aGlzLl9fUSA9PSBfbyA/IF9xIDogX287CgkJcmV0dXJuIHRoaXMuX19ROwoJfQoKCV9maWVsZEdyb3VwcyhmZ3MgPSB7fSkgewoJCXRoaXMuX19maWVsZEdyb3VwcyA9IGZnczsKCQlyZXR1cm4gdGhpczsKCX0KCglfZmllbGRBZ2dyZWdhdGVzKGZhcyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkQWdncmVnYXRlcyA9IGZhczsKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9GaWVsZHNTUUwoZmllbGRzKSB7CgoJCWZpZWxkcyA9IGZpZWxkcyB8fCBbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJywgdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2NsYXNzTmFtZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdzY29wZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdjb250ZXh0JywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3NvdXJjZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCd0YXJnZXQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnb3BlcmF0b3InLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnaW5TY3JpcHQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnb3V0U2NyaXB0JywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSArICIuaWQiXTsKCQlmaWVsZHMgPSBBcnJheS5pc0FycmF5KGZpZWxkcykgPyBmaWVsZHMgOiBbZmllbGRzXTsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQkvLyB7ZmllbGQ6IG9yZGVyfQoJCQlmaWVsZHMgPSBbXTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY2xhc3NOYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuc2NvcGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdzY29wZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvbnRleHQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb250ZXh0JywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuc291cmNlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnc291cmNlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMudGFyZ2V0KSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgndGFyZ2V0JywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3BlcmF0b3IpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcGVyYXRvcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnRvb2wpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy50eXBlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJfQoJCXJldHVybiBmaWVsZHM7Cgl9CgoJX2Zyb21EQk9iamVjdChyID0ge30pIHsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5fX2ltcG9ydChyLCB7CgkJCQlJZDogb2JqID0+IHRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ10sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY2xhc3NOYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuY2xhc3NOYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJc2NvcGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzY29wZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnNjb3BlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29udGV4dDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRleHQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb250ZXh0KG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJc291cmNlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc291cmNlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuc291cmNlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJdGFyZ2V0OiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndGFyZ2V0JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMudGFyZ2V0KG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3BlcmF0b3I6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcGVyYXRvcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9wZXJhdG9yKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJaW5TY3JpcHQ6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdpblNjcmlwdCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmluU2NyaXB0KG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3V0U2NyaXB0OiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3V0U2NyaXB0JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3V0U2NyaXB0KG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJdG9vbDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy50b29sKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJdHlwZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy50eXBlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlOdWxsOiB0cnVlLAoKCQkJdG9vbDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Ub29sKCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQl0eXBlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LlRvb2xfVHlwZSgpLl90b1NlbGVjdEhlYWRlcigpLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoJCXNxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsKCgkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpIHsKCQkJLy8ge2ZpZWxkOiBmdW5jdGlvbn0KCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNsYXNzTmFtZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY2xhc3NOYW1lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjbGFzc05hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuc2NvcGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnNjb3BlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdzY29wZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb250ZXh0KSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb250ZXh0fSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb250ZXh0JywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnNvdXJjZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuc291cmNlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdzb3VyY2UnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMudGFyZ2V0KSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy50YXJnZXR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3RhcmdldCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcGVyYXRvcikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3BlcmF0b3J9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29wZXJhdG9yJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnRvb2wpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnRvb2x9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMudHlwZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMudHlwZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCX0KCgkJc3FsICs9IGAgZnJvbSAke3RQcmVmfSBgOwoKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gYGxlZnQgam9pbiAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX0ke3RoaXMuX1EoKX0gYXMgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0gb24gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtrfWlkJHt0aGlzLl9RKCl9PSR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9IGApOwoKCQlzcWwgKz0gYCB3aGVyZSAxPTFgOwoKCQlzcWwgPSB0aGlzLl9fZXhwb3J0KHsKCQkJc3FsOiBzcWwKCQl9LCB7CgkJCV9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgPyBbJ0lkJ10gOiB1bmRlZmluZWQsCgkJCU51bGw6IHRydWUsCgkJCV9USElTOiBvYmogPT4gewoJCQkJaWYgKCF0aGlzLl9USElTIHx8ICF0aGlzLl9USElTLmxlbmd0aCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCh0Ll9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnKSkuam9pbignIFVOSU9OIEFMTCAnKSArICIpIjsKCQkJfSwKCQkJSWQ6IG9iaiA9PiBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCd9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2AsCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljbGFzc05hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbGFzc05hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NsYXNzTmFtZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NsYXNzTmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fY2xhc3NOYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jbGFzc05hbWVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jbGFzc05hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NsYXNzTmFtZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJc2NvcGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzY29wZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fc2NvcGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9zY29wZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fc2NvcGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX3Njb3BlX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fc2NvcGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX3Njb3BlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb250ZXh0OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGV4dCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29udGV4dF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvbnRleHRfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvbnRleHRfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvbnRleHRfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb250ZXh0X2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb250ZXh0X2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlzb3VyY2U6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzb3VyY2UnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3NvdXJjZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX3NvdXJjZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fc291cmNlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9zb3VyY2VfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9zb3VyY2VfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX3NvdXJjZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJdGFyZ2V0OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndGFyZ2V0JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl90YXJnZXRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl90YXJnZXRfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX3RhcmdldF9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fdGFyZ2V0X2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fdGFyZ2V0X2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl90YXJnZXRfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW9wZXJhdG9yOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3BlcmF0b3InLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX29wZXJhdG9yX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fb3BlcmF0b3JfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX29wZXJhdG9yX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9vcGVyYXRvcl9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX29wZXJhdG9yX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9vcGVyYXRvcl9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJaW5TY3JpcHQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdpblNjcmlwdCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5faW5TY3JpcHRfc2V0KSByZXR1cm47CgoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW91dFNjcmlwdDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ291dFNjcmlwdCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fb3V0U2NyaXB0X3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQl0b29sOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndG9vbCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fdG9vbF9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX3Rvb2xfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQl0eXBlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fdHlwZV9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX3R5cGVfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9TZWxlY3RTUUwiLCBmaWVsZHMpLnNxbDsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQlpZiAoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNsYXNzTmFtZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjbGFzc05hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jbGFzc05hbWV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuc2NvcGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc2NvcGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5zY29wZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb250ZXh0KSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvbnRleHQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jb250ZXh0fWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnNvdXJjZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdzb3VyY2UnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5zb3VyY2V9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMudGFyZ2V0KSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3RhcmdldCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnRhcmdldH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcGVyYXRvcikgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcGVyYXRvcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm9wZXJhdG9yfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnRvb2wpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndG9vbCcsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMudG9vbH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy50eXBlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnR5cGV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJdG9vbDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpKSA9PiBvYmoudG9vbCA9IHYuX3RvUGF0aHMoKSwKCgkJCXR5cGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSkgPT4gb2JqLnR5cGUgPSB2Ll90b1BhdGhzKCksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJ30ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTWFwcGluZykgcmV0dXJuOwoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5NYXBwaW5nID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5NYXBwaW5nKCkKCgkJCQkJLnRvb2wobmV3IHNhbGVzbm93LlRvb2woKSkKCgkJCQkJLnR5cGUobmV3IHNhbGVzbm93LlRvb2xfVHlwZSgpKQoKCQkJCQkuX3RvU1FMVGFibGUoZGVwdGgpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQkJCWF3YWl0IHRoaXMuX3NxbChzcWwpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiTWFwcGluZyIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vcmRlciA9IHYgPT0gcXVlcnkub3JkZXIoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fb3JkZXJfc2V0ICYmICFxdWVyeS5fb3JkZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX29yZGVyX3NldCAmJiBxdWVyeS5fb3JkZXJfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQljbGFzc05hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNsYXNzTmFtZSA9IHYgPT0gcXVlcnkuY2xhc3NOYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NsYXNzTmFtZV9zZXQgJiYgIXF1ZXJ5Ll9jbGFzc05hbWVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNsYXNzTmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jbGFzc05hbWVfc2V0ICYmIHF1ZXJ5Ll9jbGFzc05hbWVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jbGFzc05hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJc2NvcGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnNjb3BlID0gdiA9PSBxdWVyeS5zY29wZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9zY29wZV9zZXQgJiYgIXF1ZXJ5Ll9zY29wZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouc2NvcGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fc2NvcGVfc2V0ICYmIHF1ZXJ5Ll9zY29wZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnNjb3BlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvbnRleHQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvbnRleHQgPSB2ID09IHF1ZXJ5LmNvbnRleHQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29udGV4dF9zZXQgJiYgIXF1ZXJ5Ll9jb250ZXh0X3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb250ZXh0ID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvbnRleHRfc2V0ICYmIHF1ZXJ5Ll9jb250ZXh0X3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29udGV4dCA9IGZhbHNlOwoJCQkJfSwKCgkJCQlzb3VyY2U6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnNvdXJjZSA9IHYgPT0gcXVlcnkuc291cmNlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3NvdXJjZV9zZXQgJiYgIXF1ZXJ5Ll9zb3VyY2Vfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnNvdXJjZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9zb3VyY2Vfc2V0ICYmIHF1ZXJ5Ll9zb3VyY2Vfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5zb3VyY2UgPSBmYWxzZTsKCQkJCX0sCgoJCQkJdGFyZ2V0OiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai50YXJnZXQgPSB2ID09IHF1ZXJ5LnRhcmdldCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl90YXJnZXRfc2V0ICYmICFxdWVyeS5fdGFyZ2V0X3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai50YXJnZXQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fdGFyZ2V0X3NldCAmJiBxdWVyeS5fdGFyZ2V0X3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudGFyZ2V0ID0gZmFsc2U7CgkJCQl9LAoKCQkJCW9wZXJhdG9yOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vcGVyYXRvciA9IHYgPT0gcXVlcnkub3BlcmF0b3IoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fb3BlcmF0b3Jfc2V0ICYmICFxdWVyeS5fb3BlcmF0b3Jfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9wZXJhdG9yID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX29wZXJhdG9yX3NldCAmJiBxdWVyeS5fb3BlcmF0b3Jfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcGVyYXRvciA9IGZhbHNlOwoJCQkJfSwKCgkJCQlpblNjcmlwdDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouaW5TY3JpcHQgPSB2ID09IHF1ZXJ5LmluU2NyaXB0KCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2luU2NyaXB0X3NldCAmJiAhcXVlcnkuX2luU2NyaXB0X3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5pblNjcmlwdCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9pblNjcmlwdF9zZXQgJiYgcXVlcnkuX2luU2NyaXB0X3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouaW5TY3JpcHQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3V0U2NyaXB0OiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vdXRTY3JpcHQgPSB2ID09IHF1ZXJ5Lm91dFNjcmlwdCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vdXRTY3JpcHRfc2V0ICYmICFxdWVyeS5fb3V0U2NyaXB0X3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vdXRTY3JpcHQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3V0U2NyaXB0X3NldCAmJiBxdWVyeS5fb3V0U2NyaXB0X3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3V0U2NyaXB0ID0gZmFsc2U7CgkJCQl9LAoKCQkJCXRvb2w6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnRvb2wgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LnRvb2woKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fdG9vbF9zZXQgJiYgIXF1ZXJ5Ll90b29sX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai50b29sID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3Rvb2xfc2V0ICYmIHF1ZXJ5Ll90b29sX3NldCkgfHwKCgkJCQkJCSh0aGlzLnRvb2woKSAmJiAhdGhpcy50b29sKCkuX21hdGNoZXMocXVlcnkudG9vbCgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudG9vbCA9IGZhbHNlOwoJCQkJfSwKCgkJCQl0eXBlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai50eXBlID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS50eXBlKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3R5cGVfc2V0ICYmICFxdWVyeS5fdHlwZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudHlwZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl90eXBlX3NldCAmJiBxdWVyeS5fdHlwZV9zZXQpIHx8CgoJCQkJCQkodGhpcy50eXBlKCkgJiYgIXRoaXMudHlwZSgpLl9tYXRjaGVzKHF1ZXJ5LnR5cGUoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnR5cGUgPSBmYWxzZTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoZXMiKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDAsIG9NYXRjaCk7CgoJCQlyZXR1cm4gT2JqZWN0LmtleXMob01hdGNoKS5ldmVyeShrID0+IG9NYXRjaFtrXSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfbWF0Y2hpbmcocXVlcnkpIHsKCQl0cnkgewoJCQlsZXQgcmV0ID0gW107CgoJCQlsZXQgbWF0Y2hlcyA9IHRoaXMuX19leHBvcnQoe30sIHsKCgkJCQl0b29sOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgdG9vbCIpOwoJCQkJCW9iai50b29sID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJdHlwZTogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIHR5cGUiKTsKCQkJCQlvYmoudHlwZSA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NsYXNzTmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9zY29wZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb250ZXh0X3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3NvdXJjZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl90YXJnZXRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3BlcmF0b3Jfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5faW5TY3JpcHRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3V0U2NyaXB0X3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3Rvb2xfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fdHlwZV9zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJdG9vbDogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLnRvb2wocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCXR5cGU6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy50eXBlKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWNsYXNzTmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NsYXNzTmFtZScsIHVuZGVmaW5lZCkgOiAiY2xhc3NOYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NsYXNzTmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY2xhc3NOYW1lKHJlZik7CgoJCQl9LAoKCQkJc2NvcGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzY29wZScsIHVuZGVmaW5lZCkgOiAic2NvcGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fc2NvcGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnNjb3BlKHJlZik7CgoJCQl9LAoKCQkJY29udGV4dDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvbnRleHQnLCB1bmRlZmluZWQpIDogImNvbnRleHQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29udGV4dF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29udGV4dChyZWYpOwoKCQkJfSwKCgkJCXNvdXJjZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3NvdXJjZScsIHVuZGVmaW5lZCkgOiAic291cmNlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3NvdXJjZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuc291cmNlKHJlZik7CgoJCQl9LAoKCQkJdGFyZ2V0OiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndGFyZ2V0JywgdW5kZWZpbmVkKSA6ICJ0YXJnZXQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fdGFyZ2V0X2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy50YXJnZXQocmVmKTsKCgkJCX0sCgoJCQlvcGVyYXRvcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29wZXJhdG9yJywgdW5kZWZpbmVkKSA6ICJvcGVyYXRvciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcGVyYXRvcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3BlcmF0b3IocmVmKTsKCgkJCX0sCgoJCQlpblNjcmlwdDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2luU2NyaXB0JywgdW5kZWZpbmVkKSA6ICJpblNjcmlwdCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9pblNjcmlwdF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuaW5TY3JpcHQocmVmKTsKCgkJCX0sCgoJCQlvdXRTY3JpcHQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvdXRTY3JpcHQnLCB1bmRlZmluZWQpIDogIm91dFNjcmlwdCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vdXRTY3JpcHRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm91dFNjcmlwdChyZWYpOwoKCQkJfSwKCgkJCXRvb2w6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKSA6ICJ0b29sIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3Rvb2xfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMudG9vbCgpIHx8IG5ldyBzYWxlc25vdy5Ub29sKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy50b29sKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgdG9vbCIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJdHlwZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpIDogInR5cGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fdHlwZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy50eXBlKCkgfHwgbmV3IHNhbGVzbm93LlRvb2xfVHlwZSgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMudHlwZShvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIHR5cGUiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX1RISVM6IChvYmosIHYpID0+IHsKCQkJCWlmIChiVG9vbCkgcmV0dXJuOwoJCQkJb2JqLlRISVMgPSB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQlvYmouT1BFUkFUT1JTLlRISVMgPSB0aGlzLl9USElTX2Nvb3A7CgkJCX0sCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ10gPSB2LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNsYXNzTmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjbGFzc05hbWUnLCB1bmRlZmluZWQpIDogImNsYXNzTmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jbGFzc05hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NsYXNzTmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInNjb3BlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3Njb3BlJywgdW5kZWZpbmVkKSA6ICJzY29wZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9zY29wZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fc2NvcGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb250ZXh0IjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvbnRleHQnLCB1bmRlZmluZWQpIDogImNvbnRleHQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29udGV4dF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29udGV4dF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInNvdXJjZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzb3VyY2UnLCB1bmRlZmluZWQpIDogInNvdXJjZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9zb3VyY2VfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3NvdXJjZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInRhcmdldCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0YXJnZXQnLCB1bmRlZmluZWQpIDogInRhcmdldCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl90YXJnZXRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3RhcmdldF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9wZXJhdG9yIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29wZXJhdG9yJywgdW5kZWZpbmVkKSA6ICJvcGVyYXRvciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcGVyYXRvcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3BlcmF0b3JfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJpblNjcmlwdCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdpblNjcmlwdCcsIHVuZGVmaW5lZCkgOiAiaW5TY3JpcHQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5faW5TY3JpcHRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2luU2NyaXB0X2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3V0U2NyaXB0IjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ291dFNjcmlwdCcsIHVuZGVmaW5lZCkgOiAib3V0U2NyaXB0IikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX291dFNjcmlwdF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3V0U2NyaXB0X2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkidG9vbCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKSA6ICJ0b29sIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fdG9vbF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fdG9vbF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInR5cGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkgOiAidHlwZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX3R5cGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3R5cGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCWJ5VG9vbChhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfdG9vbCJdICYmIChhWyJfdG9vbCJdLkVxdWFscyA/IGFbIl90b29sIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl90b29sIl0sIHIpKSkgewoJCQkJCXIuX3Rvb2xfTWFwcGluZ3MucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglieVRvb2xfVHlwZShhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfdHlwZSJdICYmIChhWyJfdHlwZSJdLkVxdWFscyA/IGFbIl90eXBlIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl90eXBlIl0sIHIpKSkgewoJCQkJCXIuX3R5cGVfTWFwcGluZ3MucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuSWQ7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5NYXBwaW5nLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5NYXBwaW5nKG51bGwsIHRoaXMuVG9vbCk7CgoJCQkJbGV0IGJGaW5kID0gZmFsc2U7CgkJCQlpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLklkID0gdGhpcy5JZDsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fdG9vbF9zZXQgJiYgdGhpcy50b29sKCkgJiYgIShhd2FpdCB0aGlzLnRvb2woKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl90b29sKCk7CgoJCQkJCWlmICh0aGlzLl90eXBlX3NldCAmJiB0aGlzLnR5cGUoKSAmJiAhKGF3YWl0IHRoaXMudHlwZSgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX3R5cGUoKTsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBGaW5pc2hlZCBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0gSWQ9WyR7dGhpcy5JZH1dYCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk1hcHBpbmcuaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b0luc2VydFNRTCgpKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luc2VydCcsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZS5fcGFyZW50KQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTWFwcGluZy51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1VwZGF0ZVNRTCgpKTsKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTCgpKTsKCQkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IHJldFswXTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTWFwcGluZy5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSAoYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgKTsKCQkJCXJldCA9IHJldCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5NYXBwaW5nKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKCmlmKHR5cGVvZihtb2R1bGUpIT09InVuZGVmaW5lZCIpIG1vZHVsZS5leHBvcnRzLnNhbGVzbm93ID0gc2FsZXNub3c7CgppZih0eXBlb2Yod2luZG93KSE9PSd1bmRlZmluZWQnICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKT09PSd1bmRlZmluZWQnKXsKICAgIChhc3luYyAoKSA9PiB7CiAgICAgICAgbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LlVzZXIoKTsKCQlmb3IgYXdhaXQgKGNvbnN0IGwgb2Ygc2FsZXNub3cuaHJlZnMubWFwKG4gPT4gbi5saWIpKSB7CgkJCWF3YWl0IF90aGlzLnJlcXVpcmUobCwgc2FsZXNub3cuaHJlZnMpOwoJCX0KCQlpZihzYWxlc25vdy5Ob2RlKSBuZXcgc2FsZXNub3cuTm9kZSgpLmluaXQoKTsKICAgIH0pKCk7Cn0="></script></head><body>HTML Node Testing...</body></html>
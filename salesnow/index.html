<html><head><script type="text/javascript" src="data:text/javascript;base64,aWYodHlwZW9mKGdsb2JhbCkhPT0idW5kZWZpbmVkIikgZ2xvYmFsLkZsYXR0ZWQgPSByZXF1aXJlKCdmbGF0dGVkJyk7CgpsZXQgX19nID0gdHlwZW9mKGdsb2JhbCk9PT0idW5kZWZpbmVkIj93aW5kb3c6Z2xvYmFsOwoKbGV0IHNhbGVzbm93ID0gewogICAgX19zY3JpcHQ6IHsKICAgICAgICBEYXRlOiBuZXcgRGF0ZSgnMjAyMy0wNy0yMFQwMDowNDo0NS4wMDBaJyksCiAgICB9LAogICAgX19zZWNyZXQ6IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikhPT0idW5kZWZpbmVkIik/dGhpcy5fYXRvYjoodHlwZW9mKF9GckVNRCkhPT0idW5kZWZpbmVkIj9fRnJFTUQuX2F0b2I6YXRvYikpKGBJamRpTWpkaU5UZG1MVE5pWWpRdE5HTXlOaTA0Wmprd0xXSXdaamczWWprMU1EVTVNaUk9YCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSksCiAgICBfX21haW5DbGFzczogJ1VzZXInLAoKICAgIGhyZWZzOiBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShgVzNzaWJHbGlJam9pVEc5blNGUk5UQ0lzSW5OeVl5STZJbWgwZEhCek9pOHZZMlJ1TG1welpHVnNhWFp5TG01bGRDOXVjRzB2WTI5dWMyOXNaUzFzYjJjdGFIUnRiRUF5TGpBdU1pOWpiMjV6YjJ4bExXeHZaeTFvZEcxc0xtMXBiaTVxY3lJc0ltTmhZMmhsSWpwMGNuVmxMQ0owYjI5c2N5STZXMTBzSW14dllXUWlPaUp0YjJSMWJHVnpJRDArSUVOdmJuTnZiR1ZNYjJkSVZFMU1MbU52Ym01bFkzUW9aRzlqZFcxbGJuUXVaMlYwUld4bGJXVnVkRUo1U1dRb1hDSk1iMmRJVkUxTVhDSXBLU0lzSW5KbGNYVnBjbVZ6SWpwYlhYMHNleUpzYVdJaU9pSmtiM1F0YjJKcVpXTjBJaXdpYzNKaklqb2lhSFIwY0hNNkx5OWpaRzR1YW5Oa1pXeHBkbkl1Ym1WMEwyNXdiUzlrYjNRdGIySnFaV04wUURJdU1TNDBMMmx1WkdWNExtMXBiaTVxY3lJc0ltTmhZMmhsSWpwMGNuVmxMQ0owYjI5c2N5STZXMTBzSW5KbGNYVnBjbVZ6SWpwYlhYMHNleUpzYVdJaU9pSkJlR2x2Y3lJc0luTnlZeUk2SW1oMGRIQnpPaTh2ZFc1d2EyY3VZMjl0TDJGNGFXOXpMMlJwYzNRdllYaHBiM011YldsdUxtcHpJaXdpWTJGamFHVWlPblJ5ZFdVc0luUnZiMnh6SWpwYlhTd2ljbVZ4ZFdseVpYTWlPbHRkZlYwPWApLCAoa2V5LHZhbHVlKT0+e2lmKHR5cGVvZih2YWx1ZSk9PT0ic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpPjApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsgcmV0dXJuIHZhbHVlO30pLAoKCiAgICBfX1Rvb2xzOiBbCiAgICBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShgZXlKMGVYQmxJanA3SW01aGJXVWlPaUpIYVhSSWRXSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1VzSW5SNWNHVmZUV0Z3Y0dsdVozTWlPbHRkZlN3aWRHOXZiRjlEYjI1bWFXZHpJanBiZXlKdVlXMWxJam9pY21Wd2IzTnBkRzl5ZVNJc0luWmhiSFZsSWpvaVhDSmhjbnBvYjNOd2FYUmhiQzVuYVhSb2RXSXVhVzljSWlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2liM2R1WlhJaUxDSjJZV3gxWlNJNklsd2lZWEo2YUc5emNHbDBZV3hjSWlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2lkWEpzSWl3aWRtRnNkV1VpT2lKY0ltaDBkSEJ6T2k4dllYQnBMbWRwZEdoMVlpNWpiMjB2Y21Wd2IzTXZlM3R2ZDI1bGNuMTlMM3Q3Y21Wd2IzTnBkRzl5ZVgxOUwyTnZiblJsYm5Sekwxd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKdllYVjBhQzVoWTJObGMzTmZkRzlyWlc0aUxDSjJZV3gxWlNJNklsd2laMmwwYUhWaVgzQmhkRjh4TVVGTVJGTlZXbEV3VjAwMlluZDFUa2xPVFVJNFgxcHhURmhHTWxCWk56Rk9ZM0pIV1dsSVpYaFVZVnBTY0hCeE5XcEtla2w0WlhOV2RXbHFaV1pWTm5CTVJGcFhSRlEyUms1c1JFWjJNRGxvWENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbU55WldGMFpTSXNJblpoYkhWbElqb2lNaUlzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaVUzbHVZMFZ1ZEdsMGVVRjBkSEpwWW5WMFpYTWlMQ0oyWVd4MVpTSTZJblJ5ZFdVaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbE41Ym1OVWVYQmxaRUYwZEhKcFluVjBaWE1pTENKMllXeDFaU0k2SW1aaGJITmxJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlYwc0ltNWhiV1VpT2lKSGFYUklkV0lpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdVc0luUnZiMnhmVFdGd2NHbHVaM01pT2x0ZGZRPT1gKSwgKGtleSx2YWx1ZSk9PntpZih0eXBlb2YodmFsdWUpPT09InN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKT4wKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7IHJldHVybiB2YWx1ZTt9KSxKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShgZXlKMGVYQmxJanA3SW01aGJXVWlPaUpQUVhWMGFGTmhibVFpTENKMGVYQmxYMDFoY0hCcGJtZHpJanBiWFN3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTd2lkRzl2YkY5RGIyNW1hV2R6SWpwYmV5SnVZVzFsSWpvaWIyRjFkR2d1WTJ4cFpXNTBYMmxrSWl3aWRtRnNkV1VpT2lKY0ltMXZZMnRzWVdKZmIybGtZMXdpSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTeDdJbTVoYldVaU9pSnZZWFYwYUM1amJHbGxiblJmYzJWamNtVjBJaXdpZG1Gc2RXVWlPaUpjSW5ObFdqSlVTRnBFTTJSV05uaEhhVnBDUWw4dGIzUm9hVEoyU0RkTlZVZFRWM1p6WkhSTFpsaDBNVEZ0TURsd2Qxd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKdllYVjBhQzVzYjJkcGJpSXNJblpoYkhWbElqb2lYQ0prWldabFlYUmxaQzFsWVdkc1pVQmxlR0Z0Y0d4bExtTnZiVndpSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTeDdJbTVoYldVaU9pSnZZWFYwYUM1d1lYTnpkMjl5WkNJc0luWmhiSFZsSWpvaVhDSkhiR1ZoYldsdVp5MVVZVzFoY21sdUxUSXdYQ0lpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdWOUxIc2libUZ0WlNJNkltOWhkWFJvTG1odmMzUWlMQ0oyWVd4MVpTSTZJbHdpYjJGMWRHZ3ViVzlqYTJ4aFlpNXBiMXdpSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTeDdJbTVoYldVaU9pSnZZWFYwYUM1elkyOXdaU0lzSW5aaGJIVmxJam9pWENKdmNHVnVhV1FyY0hKdlptbHNaU3RsYldGcGJGd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKdllYVjBhQzVoZFhSb2IzSnBlbVV1ZFhKcElpd2lkbUZzZFdVaU9pSmNJbWgwZEhCek9pOHZlM3R2WVhWMGFDNW9iM04wZlgwdmIyRjFkR2d2WVhWMGFHOXlhWHBsUDNKbGMzQnZibk5sWDNSNWNHVTlZMjlrWlNaamJHbGxiblJmYVdROWUzdHZZWFYwYUM1amJHbGxiblJmYVdSOWZTWnpZMjl3WlQxN2UyOWhkWFJvTG5OamIzQmxmWDBtYzNSaGRHVTllM3R2WVhWMGFDNXpkR0YwWlgxOUpuSmxaR2x5WldOMFgzVnlhVDE3ZTI5aGRYUm9MbkpsWkdseVpXTjBMblZ5YVgxOVhDSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5TEhzaWJtRnRaU0k2SW05aGRYUm9MbkpsWkdseVpXTjBMblZ5YVNJc0luWmhiSFZsSWpvaVhDSm9kSFJ3Y3pvdkwyRnllbWh2YzNCcGRHRnNMbWRwZEdoMVlpNXBieTl6WVd4bGMyNXZkeTlwYm1SbGVDNW9kRzFzWENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbTloZFhSb0xuSmxaR2x5WldOMExtTnZaR1VpTENKMllXeDFaU0k2SWx3aVkyOWtaVndpSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTeDdJbTVoYldVaU9pSnZZWFYwYUM1eVpXUnBjbVZqZEM1emRHRjBaU0lzSW5aaGJIVmxJam9pWENKemRHRjBaVndpSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTeDdJbTVoYldVaU9pSnZZWFYwYUM1MWMyVnlhVzVtYnk1MWNta2lMQ0oyWVd4MVpTSTZJbHdpYUhSMGNITTZMeTk3ZTI5aGRYUm9MbWh2YzNSOWZTOTFjMlZ5YVc1bWIxd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKdllYVjBhQzUwYjJ0bGJpNTFjbWtpTENKMllXeDFaU0k2SWx3aWFIUjBjSE02THk5N2UyOWhkWFJvTG1odmMzUjlmUzl2WVhWMGFDOTBiMnRsYmx3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUp2WVhWMGFDNTBiMnRsYmk1aWIyUjVJaXdpZG1Gc2RXVWlPaUpjSW1keVlXNTBYM1I1Y0dVOWUzdHZZWFYwYUM1bmNtRnVkRjkwZVhCbGZYMG1ZMnhwWlc1MFgybGtQWHQ3YjJGMWRHZ3VZMnhwWlc1MFgybGtmWDBtWTJ4cFpXNTBYM05sWTNKbGREMTdlMjloZFhSb0xtTnNhV1Z1ZEY5elpXTnlaWFI5ZlNaeVpXUnBjbVZqZEY5MWNtazllM3R2WVhWMGFDNWhkWFJvYjNKcGVtVXVjbVZrYVhKbFkzUjlmU1pqYjJSbFBYdDdiMkYxZEdndVkyOWtaWDE5WENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbTloZFhSb0xuUnZhMlZ1TG0xbGRHaHZaQ0lzSW5aaGJIVmxJam9pWENKUVQxTlVYQ0lpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdWOUxIc2libUZ0WlNJNkltOWhkWFJvTG5SdmEyVnVMbU52Ym5SbGJuUmZkSGx3WlNJc0luWmhiSFZsSWpvaVhDSmhjSEJzYVdOaGRHbHZiaTk0TFhkM2R5MW1iM0p0TFhWeWJHVnVZMjlrWldSY0lpSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaWDBzZXlKdVlXMWxJam9pYjJGMWRHZ3VkRzlyWlc0dWNtVnpjRzl1YzJVdWRHOXJaVzVmZEhsd1pTSXNJblpoYkhWbElqb2lYQ0owYjJ0bGJsOTBlWEJsWENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbTloZFhSb0xuUnZhMlZ1TG5KbGMzQnZibk5sTG1WNGNHbHlaWE5mYVc0aUxDSjJZV3gxWlNJNklsd2laWGh3YVhKbGMxOXBibHdpSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTeDdJbTVoYldVaU9pSnZZWFYwYUM1MGIydGxiaTV5WlhOd2IyNXpaUzVoWTJObGMzTmZkRzlyWlc0aUxDSjJZV3gxWlNJNklsd2lZV05qWlhOelgzUnZhMlZ1WENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbTloZFhSb0xuUnZhMlZ1TG5KbGMzQnZibk5sTG5KbFpuSmxjMmhmZEc5clpXNGlMQ0oyWVd4MVpTSTZJbHdpY21WbWNtVnphRjkwYjJ0bGJsd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNXZaR1VpT25zaVkyOWtaU0k2Tnk0eU5qUXlOVGMyTkRFeU9ERTJNRGg5TENKMllXeDFaU0k2SWpRMU1HRmtZekZpTFdNNU1UY3ROR0pqTWkwNFpqUXpMVFV4TVdKak1HRTRPRFZqTXlJc0ltNWhiV1VpT2lKdllYVjBhQzV6ZEdGMFpTSjlYU3dpYm1GdFpTSTZJazlCZFhSb1UyRnVaQ0lzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlN3aWRHOXZiRjlOWVhCd2FXNW5jeUk2VzExOWApLCAoa2V5LHZhbHVlKT0+e2lmKHR5cGVvZih2YWx1ZSk9PT0ic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpPjApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsgcmV0dXJuIHZhbHVlO30pLAogICAgXSwKCn07CgoKCmRlbGV0ZSBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSTsKc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgPSBjbGFzcyBHZW5lcmljU2VydmljZUFQSSB7Cglhc3luYyBzZXRJbnRlcnZhbChmdW4sIG1pbnV0ZXMsIC4uLmFyZ3MpIHsKCQlsZXQgZk5hbWUgPSBmdW4udG9TdHJpbmcoKS5zcGxpdCgnKScpWzBdICsgJyknOwoJCXRyeSB7CgkJCS8vIHRoaXMuX190aW1lKGAke2ZOYW1lfS5Mb29wYCk7CgoJCQl0aGlzLl9fdGltZShgJHtmTmFtZX0uQ2FsbGApOwoJCQlsZXQgcmV0ID0gYXdhaXQgZnVuKC4uLmFyZ3MuY29uY2F0KFtuZXcgRGF0ZSgpXSkpOwoKCQkJdGhpcy5sb2coYHtDYWxsOiBgICsgdGhpcy5fX3RpbWUoYCR7Zk5hbWV9LkNhbGxgKSArIGAsIExvb3A6IGAgKyB0aGlzLl9fdGltZShgJHtmTmFtZX0uTG9vcGApICsgJ30nLCAnc2V0SW50ZXJ2YWwnLCBmTmFtZSk7CgkJCWlmICghcmV0KSB7CgkJCQl0aGlzLmxvZyhgZGlkIG5vdCByZXR1cm4gdHJ1ZSwgZXhpdGluZyBsb29wZXIgKCR7dGhpcy5fX3RpbWUoZk5hbWUpfSlgLCAnc2V0SW50ZXJ2YWwnLCBmTmFtZSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh0aGlzLl9fdGltZShmTmFtZSksICdzZXRJbnRlcnZhbCcsIGZOYW1lLCAyLCBleCk7CgkJCWNvbnNvbGUudHJhY2UoKTsKCQl9CgkJaWYgKCFOdW1iZXIobWludXRlcykpIHsKCQkJdGhpcy5sb2codGhpcy5fX3RpbWUoZk5hbWUpLCAnc2V0SW50ZXJ2YWwnLCBmTmFtZSwgMCwgIk5vdCByZXBlYXRpbmcuIE1pbnV0ZXMgaXMgIiArIG1pbnV0ZXMpOwoJCQlyZXR1cm47CgkJfQoJCWF3YWl0IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCBtaW51dGVzICogNjAgKiAxMDAwKSk7CgkJYXdhaXQgdGhpcy5zZXRJbnRlcnZhbChmdW4sIG1pbnV0ZXMsIC4uLmFyZ3MpOwoJfQoKCWFzeW5jIF9leGVjdXRlKHNjb3BlLCBtLCBmUm91dGVyLCBmU2NyaXB0LCBvUGFyYW1zID0ge30pIHsKCQlsZXQgX19iZWZvcmVSdWxlcyA9IG9QYXJhbXMuX19iZWZvcmVSdWxlcyB8fCBbXTsKCQlsZXQgX19hZnRlclJ1bGVzID0gb1BhcmFtcy5fX2FmdGVyUnVsZXMgfHwgW107CgkJZGVsZXRlIG9QYXJhbXMuX19iZWZvcmVSdWxlczsKCQlkZWxldGUgb1BhcmFtcy5fX2FmdGVyUnVsZXM7CgoJCV9fYmVmb3JlUnVsZXMuY29uY2F0KF9fYWZ0ZXJSdWxlcykuZm9yRWFjaChyID0+IHIuU2NyaXB0ID0gdGhpcy5ydW5TY3JpcHQoYGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBzY29wZSwgbm9kZSR7T2JqZWN0LmtleXMob1BhcmFtcykubGVuZ3RoPycsICc6Jyd9JHtPYmplY3Qua2V5cyhvUGFyYW1zKS5qb2luKCcsJyl9KSA9PiB7JHtyLlNjcmlwdH19YCkpOwoKCQlsZXQgbFBhcmFtcyA9IE9iamVjdC5lbnRyaWVzKG9QYXJhbXMpLm1hcCh4ID0+IHhbMV0pOwoJCWxldCByZXN1bHRzID0gW107CgoJCWlmICh0aGlzLkRTQ29ubmVjdCkgYXdhaXQgdGhpcy5EU0Nvbm5lY3QoKTsKCgkJbGV0IG5vZGVzID0gW107CgkJaWYgKCFzY29wZS5fbm9kZSB8fCAhZlJvdXRlcikgewoJCQlub2Rlcy5wdXNoKG51bGwpOwoJCX0gZWxzZSB7CgkJCWlmIChzY29wZS5fbm9kZSkgewoJCQkJaWYgKGF3YWl0IHRoaXMuX1NjcmlwdChmUm91dGVyLCBtLCAnUm91dGVyJywgc2NvcGUsIHNjb3BlLl9ub2RlLCAuLi5sUGFyYW1zKSkgewoJCQkJCW5vZGVzLnB1c2goc2NvcGUuX25vZGUpOwoJCQkJfQoKCQkJCXRoaXMuX2ZpeE5vZGUoc2NvcGUpOwoKCQkJCWlmIChzY29wZS5fbm9kZS5fcGFyZW50ICYmIChhd2FpdCB0aGlzLl9TY3JpcHQoZlJvdXRlciwgbSwgJ1JvdXRlcicsIHNjb3BlLCBzY29wZS5fbm9kZS5fcGFyZW50LCAuLi5sUGFyYW1zKSkpIHsKCQkJCQkvLyB0aGlzLmxvZyhzY29wZS5fbm9kZS5fcGFyZW50LCAnX2V4ZWN1dGUnLCAnYWRkaW5nIHBhcmVudCcpOwoJCQkJCW5vZGVzLnB1c2goc2NvcGUuX25vZGUuX3BhcmVudCk7CgkJCQl9IGVsc2UgaWYgKHNjb3BlLkV2ZW50ICYmIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAhPT0gIkV2ZW50IikgewoJCQkJCS8vIG5vZGVzLnB1c2gobmV3IHNjb3BlLk5vZGUoKSk7CgkJCQl9CgoJCQkJdGhpcy5fZml4Tm9kZShzY29wZSk7CgkJCQlmb3IgYXdhaXQgKGNvbnN0IGNuIG9mIHNjb3BlLl9ub2RlLnBhcmVudF9Ob2RlcygpKSB7CgkJCQkJaWYgKGF3YWl0IHRoaXMuX1NjcmlwdChmUm91dGVyLCBtLCAnU2NyaXB0Jywgc2NvcGUsIGNuLCAuLi5sUGFyYW1zKSkgewoJCQkJCQkvLyB0aGlzLmxvZyhjbiwgJ19leGVjdXRlJywgJ2FkZGluZyBjaGlsZCBub2RlJyk7CgkJCQkJCW5vZGVzLnB1c2goY24pOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJLy8gcmVtb3ZlIGFueSBudWxscwoJCQlub2RlcyA9IG5vZGVzLmZsYXQoKS5maWx0ZXIobiA9PiBuKTsKCgkJCWlmICghbm9kZXMubGVuZ3RoKSB7CgkJCQlub2Rlcy5wdXNoKHNjb3BlLl9ub2RlKTsKCQkJfQoKCQkJLy8gdGhpcy5sb2cobm9kZXMubGVuZ3RoLCAnX2V4ZWN1dGUnLCAnbm9kZXMubGVuZ3RoJyk7CgkJfQoKCQlmb3IgYXdhaXQgKGNvbnN0IG4gb2Ygbm9kZXMpIHsKCQkJdGhpcy5fZml4Tm9kZShzY29wZSk7CgkJCWxldCBuUmV0ID0gbnVsbDsKCQkJdGhpcy5sb2coYCR7bX0gQCAke24/LmNvZGUoKSB8fCAnTE9DQUwnfWAsICdfZXhlY3V0ZScsIGAke3RoaXMuRW50aXR5Q2xhc3MuTmFtZX1gKTsKCQkJaWYgKCFuIHx8IHRoaXMuX3NhbWVOb2RlKHNjb3BlLl9ub2RlLCBuKSkgewoJCQkJLy8gbG9jYWwgc2NyaXB0CgkJCQlmb3IgYXdhaXQgKGNvbnN0IHIgb2YgX19iZWZvcmVSdWxlcykgewoJCQkJCWF3YWl0IHRoaXMuX1NjcmlwdChyLlNjcmlwdCwgbSwgci5OYW1lIHx8ICdCZWZvcmVSdWxlJywgc2NvcGUsIG51bGwsIC4uLmxQYXJhbXMpOwoJCQkJfQoKCQkJCW5SZXQgPSBhd2FpdCB0aGlzLl9TY3JpcHQoZlNjcmlwdCwgbSwgJ1NjcmlwdCcsIHNjb3BlLCAuLi5sUGFyYW1zKTsKCgkJCQlmb3IgYXdhaXQgKGNvbnN0IHIgb2YgX19hZnRlclJ1bGVzKSB7CgkJCQkJYXdhaXQgdGhpcy5fU2NyaXB0KHIuU2NyaXB0LCBtLCByLk5hbWUgfHwgJ0FmdGVyUnVsZScsIHNjb3BlLCBudWxsLCAuLi5sUGFyYW1zKTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCW5SZXQgPSBhd2FpdCB0aGlzLl9pbnZva2VOb2RlKG4sIG0sIG9QYXJhbXMpOwoJCQl9CgoJCQlyZXN1bHRzLnB1c2goewoJCQkJbm9kZTogbiwKCQkJCXJldDogblJldAoJCQl9KTsKCQl9CgkJLy8gdGhpcy5sb2cocmVzdWx0cywgJ19leGVjdXRlJywgJ1Jlc3VsdHMnKTsKCgkJbGV0IGVycm9ycyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gci5yZXQgJiYgci5yZXQuX19leGNlcHRpb24pIC8qLmZpbHRlcihyID0+ICF0aGlzLl9zYW1lTm9kZShzY29wZS5fbm9kZSwgci5ub2RlKSkqLyAubWFwKHIgPT4gKHsKCQkJbm9kZTogci5ub2RlID8gewoJCQkJY29kZTogci5ub2RlLmNvZGUoKSwKCQkJCWFkZHJlc3M6IHIubm9kZS5hZGRyZXNzKCkKCQkJfSA6IG51bGwsCgkJCV9fZXhjZXB0aW9uOiByLnJldC5fX2V4Y2VwdGlvbgoJCX0pKTsKCQlpZiAoZXJyb3JzLmxlbmd0aCkgewoJCQl0aGlzLmxvZygiX2V4ZWN1dGUiLCBtLCAiZXJyb3JzIiwgMSwgZXJyb3JzKTsKCQl9CgoJCXJldHVybiByZXN1bHRzOwoJfQoKCV9zYW1lTm9kZShuMSwgbjIpIHsKCQlpZiAodHlwZW9mKG4yKSA9PT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKG4xKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbjIgPSBuMTsKCQkJbjEgPSB0aGlzOwoJCX0KCgkJaWYgKCFuMSB8fCAhbjIpIHJldHVybiBmYWxzZTsKCgkJaWYgKHR5cGVvZihuMS5fY29kZSkgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZihuMi5fY29kZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gZmFsc2U7CgoJCWlmIChuMS5jb25zdHJ1Y3Rvci5uYW1lICE9ICJOb2RlIiB8fCBuMi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJOb2RlIikgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQlpZiAobjEuX2NvZGVfY29vcCB8fCBuMi5fY29kZV9jb29wKSByZXR1cm4gZmFsc2U7CgoJCWlmIChuMS5fY29kZSA9PSBuMi5fY29kZSkgcmV0dXJuIHRydWU7CgoJCXJldHVybiB0aGlzLkVxdWFscyhuMSwgbjIpOwoJfQoKCV9maXhOb2RlKHNjb3BlKSB7CgkJLy8gb24gTm9kZUpTIGZvciBzb21lIHJlYXNvbiwgX25vZGUgaXMgc29tZXRpbWVzIGFuIGFycmF5IQoJCXRyeSB7CgkJCXNjb3BlID0gc2NvcGUgfHwgdGhpcy5fX3Njb3BlKCk7CgkJCWlmIChBcnJheS5pc0FycmF5KHNjb3BlLl9ub2RlKSkgc2NvcGUuX25vZGUgPSBzY29wZS5fbm9kZVswXTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZygnX2ZpeE5vZGUnLCB0eXBlb2YodGhpcyksIDEsIGV4LCB0aGlzLmNvbnN0cnVjdG9yLm5hbWUpOwoJCX0KCX0KCglsb2cob2JqLCBtLCB0eXBlLCBsZXZlbCwgLi4ubXNnKSB7CgkJdHJ5IHsKCQkJbGV0IGRlYnVnID0gdGhpcy5EZWJ1ZzsKCQkJbGV0IGxldmVscyA9IFsiaW5mbyIsICJ3YXJuIiwgImVycm9yIiwgImNyaXRpY2FsIl07CgoJCQlkZWJ1ZyA9IGRlYnVnIHx8IE9iamVjdC5mcm9tRW50cmllcyhuZXcgTWFwKGxldmVscy5tYXAobCA9PiBbbCwgJyonXSkpKTsKCgkJCWxldCBmdW5jdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCAuLi5sZXZlbHMubWFwKGwgPT4gKHsKCQkJCVtsXTogZGVidWdbbF0gPyBkZWJ1Z1tsXS5zcGxpdCgnLCcpIDogW10KCQkJfSkpKTsKCgkJCWxldCBjc3MgPSAnYmFja2dyb3VuZDogIzAwZmYwMDsgY29sb3I6ICMwMDgwMDAnOwoJCQlsZXQgZmcgPSAnXHgxYlszMm0nOwoJCQlzd2l0Y2ggKE51bWJlcihsZXZlbCkpIHsKCQkJCWNhc2UgMToKCQkJCQljc3MgPSAnYmFja2dyb3VuZDogI2ZmZmYwMDsgY29sb3I6ICMwMDAwODAnOwoJCQkJCWZnID0gJ1x4MWJbMzNtJzsKCQkJCQlicmVhazsKCQkJCWNhc2UgMjoKCQkJCQljc3MgPSAnYmFja2dyb3VuZDogI2IyMjIyMjsgY29sb3I6ICNmZmZmZmYnOwoJCQkJCWZnID0gJ1x4MWJbMzFtJzsKCQkJCQlicmVhazsKCQkJCWNhc2UgMzoKCQkJCQljc3MgPSAnYmFja2dyb3VuZDogI2IyMjIyMjsgY29sb3I6ICNmZmZmZmYnOwoJCQkJCWZnID0gJ1x4MWJbMzFtW0NSSVRJQ0FMXSc7CgkJCQkJYnJlYWs7CgkJCX0KCgkJCWlmIChmdW5jdGlvbnNbbGV2ZWxzW051bWJlcihsZXZlbCkgfHwgMF1dLmV2ZXJ5KGYgPT4gIVsnKi4qJywgJyouJyArIG0sICcqJywgbSwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lICsgJy4nICsgbSwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lICsgJy4qJ10uaW5jbHVkZXMoZikpKSB7CgkJCQkvLyBjb25zb2xlLmxvZygnbm8gbWV0aG9kJywgZnVuY3Rpb25zLCBmdW5jdGlvbnNbbGV2ZWxzW051bWJlcihsZXZlbCkgfHwgMF1dLCBtLCBbJyouKicsICcqLicgKyBtLCAnKicsIG0sIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSArICcuJyArIG0sIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSArICcuKiddKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJykgewoJCQkJY29uc29sZS5sb2coZmcgKyAiJXNceDFiWzBtIiwgYCR7dHlwZSB8fCAnPHR5cGU+J306ICR7dGhpcy5TY29wZX0uJHt0aGlzLkVudGl0eUNsYXNzLk5hbWV9LiR7bSB8fCAnPG1ldGhvZD4nfSgpYCwgLi4uKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJyA/IChtc2cgfHwgW10pIDogW29ial0uY29uY2F0KG1zZyB8fCBbXSkpKTsKCQkJfSBlbHNlIHsKCQkJCWNvbnNvbGUubG9nKGAlYyAke3R5cGUgfHwgJzx0eXBlPid9OiAke3RoaXMuU2NvcGV9LiR7dGhpcy5FbnRpdHlDbGFzcy5OYW1lfS4ke20gfHwgJzxtZXRob2Q+J30oKWAsIGNzcywgLi4uKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJyA/IChtc2cgfHwgW10pIDogW29ial0uY29uY2F0KG1zZyB8fCBbXSkpKTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQkJLy90aGlzLmxvZyhleCwgbSwgdHlwZSwgMyk7CgkJfQoJfQoKCWFzeW5jIF9TY3JpcHQoc2NyaXB0LCBtLCB0eXBlLCBzY29wZSwgLi4uc2ZBcmdzKSB7CgkJaWYgKHR5cGVvZihzY3JpcHQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoKCQlyZXR1cm4gYXdhaXQgKGFzeW5jICh0eXBlLCAuLi5zQXJncykgPT4gewoJCQlsZXQgbG9nID0gKG9iaiwgLi4ubXNnKSA9PiB0aGlzLmxvZyhvYmosIG0sIHR5cGUsIDAsIC4uLm1zZyk7CgkJCWxldCB3YXJuID0gKG9iaiwgLi4ubXNnKSA9PiB0aGlzLmxvZyhvYmosIG0sIHR5cGUsIDEsIC4uLm1zZyk7CgkJCWxldCBlcnJvciA9IChvYmosIC4uLm1zZykgPT4gdGhpcy5sb2cob2JqLCBtLCB0eXBlLCAyLCAuLi5tc2cpOwoKCQkJdHJ5IHsKCQkJCWxldCByZXQgPSBudWxsOwoKCQkJCWlmICh0eXBlb2Yoc2NyaXB0KSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IGF3YWl0IHNjcmlwdChsb2csIHdhcm4sIGVycm9yLCBzY29wZSwgbSwgLi4uc0FyZ3MpOwoJCQkJfQoKCQkJCXRoaXMuX2ZpeE5vZGUoKTsKCQkJCXJldHVybiByZXQ7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJZXJyb3IoZXgsIDIsIC4uLnNBcmdzLCBzY3JpcHQpOwoJCQkJfSBlbHNlIHsKCQkJCQllcnJvcihleCwgMik7CgkJCQl9CgkJCX0KCQl9KSh0eXBlLCAuLi5zZkFyZ3MpOwoJfQp9OwoKCnNhbGVzbm93LlVzZXIgPSBjbGFzcyBVc2VyIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUXNLaTVmYkc5aFpGUnZiMnh6TENvdVlYVjBhRU52WkdVc1JYWmxiblF1YkdsemRHVnVMRVYyWlc1MExuQnliMk5sYzNNc1JYWmxiblF1ZEhKcFoyZGxjaUo5YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUp6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpmWVhWMGFHOXlhWHBsTG5WelpYSnVZVzFsSWpvaVptRmthU0lzSWw5aGRYUm9iM0pwZW1VdWNHRnpjM2R2Y21RaU9pSXhNak1pTENKZllYVjBhRzl5YVhwbExuUmxjM1JWYzJWeUlqcDdJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaU3dpWjJWdVpHVnlJanA3SW1OdlpHVWlPaUpOSWl3aWJtRnRaU0k2SWsxaGJHVWlmU3dpWTI5a1pTSTZJbVpoWkdraUxDSnVZVzFsSWpvaVJtRmthU0o5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpQUVhWMGFGTmhibVFpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAidXNlcm5hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3VzZXJuYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicGFzc3dvcmQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3Bhc3N3b3JkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZGVwYXJ0bWVudCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZGVwYXJ0bWVudCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfbWFuYWdlcl9EZXBhcnRtZW50cygpOwoKCQl0aGlzLmNsZWFyX2NhbGxlcl9JbmNpZGVudHMoKTsKCgkJdGhpcy5jbGVhcl9jb250YWN0X0luY2lkZW50cygpOwoKCQl0aGlzLmNsZWFyX3VzZXJfR3JvdXBfTWVtYmVycygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIlVzZXIiLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCS8vIGlmKHRoaXMuX2RlcGFydG1lbnRfc2V0ICYmIHRoaXMuX2RlcGFydG1lbnQpIHRoaXMuX2RlcGFydG1lbnQuVG9vbCA9IHRvb2w7CgoJCS8vICh0aGlzLm1hbmFnZXJfRGVwYXJ0bWVudHMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQkvLyAodGhpcy5jYWxsZXJfSW5jaWRlbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJLy8gKHRoaXMuY29udGFjdF9JbmNpZGVudHMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQkvLyAodGhpcy51c2VyX0dyb3VwX01lbWJlcnMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdXNlcm5hbWUgKiovCgl1c2VybmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3VzZXJuYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgidXNlcm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3VzZXJuYW1lICE9IHYpIHsKCQkJCXRoaXMuX3VzZXJuYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl91c2VybmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl91c2VybmFtZSk7CgkJfQoJfQoKCWNsZWFyX3VzZXJuYW1lKCkgewoJCXRoaXMuX3VzZXJuYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fdXNlcm5hbWUgPSBudWxsOwoJCXRoaXMuX3VzZXJuYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB1c2VybmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHBhc3N3b3JkICoqLwoJcGFzc3dvcmQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9wYXNzd29yZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInBhc3N3b3JkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9wYXNzd29yZCAhPSB2KSB7CgkJCQl0aGlzLl9wYXNzd29yZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcGFzc3dvcmQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcGFzc3dvcmQpOwoJCX0KCX0KCgljbGVhcl9wYXNzd29yZCgpIHsKCQl0aGlzLl9wYXNzd29yZF9zZXQgPSBudWxsOwoJCXRoaXMuX3Bhc3N3b3JkID0gbnVsbDsKCQl0aGlzLl9wYXNzd29yZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcGFzc3dvcmQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkZXBhcnRtZW50ICoqLwoJZGVwYXJ0bWVudCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RlcGFydG1lbnRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkZXBhcnRtZW50Iik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnNDJjZjYwZGYtYTgwMS00MDk4LTgxYjYtOGVjNjRlNmViZmY4JyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnRGVwYXJ0bWVudCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdkZXBhcnRtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiNDJjZjYwZGYtYTgwMS00MDk4LTgxYjYtOGVjNjRlNmViZmY4IiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIkRlcGFydG1lbnQiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGVwYXJ0bWVudCAhPSB2KSB7CgkJCQl0aGlzLl9kZXBhcnRtZW50X3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZGVwYXJ0bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fZGVwYXJ0bWVudCA/IHRoaXMuX2RlcGFydG1lbnQuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX2RlcGFydG1lbnRfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX2RlcGFydG1lbnQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGVwYXJ0bWVudCk7CgkJfQoJfQoKCWNsZWFyX2RlcGFydG1lbnQoKSB7CgkJdGhpcy5fZGVwYXJ0bWVudF9zZXQgPSBudWxsOwoJCXRoaXMuX2RlcGFydG1lbnQgPSBudWxsOwoJCXRoaXMuX2RlcGFydG1lbnRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRlcGFydG1lbnQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoJY29kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb2RlICE9IHYpIHsKCQkJCXRoaXMuX2NvZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29kZSk7CgkJfQoJfQoKCWNsZWFyX2NvZGUoKSB7CgkJdGhpcy5fY29kZV9zZXQgPSBudWxsOwoJCXRoaXMuX2NvZGUgPSBudWxsOwoJCXRoaXMuX2NvZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCglkYXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImRhdGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJyA/IF92IDogKG5ldyBEYXRlKF92KSk7CgkJCQlpZiAoaXNOYU4oX3YuZ2V0VGltZSgpKSkgX3YgPSBudWxsOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuRGF0ZVZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RhdGUgIT0gdikgewoJCQkJdGhpcy5fZGF0ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkRhdGVWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGF0ZSk7CgkJfQoJfQoKCWNsZWFyX2RhdGUoKSB7CgkJdGhpcy5fZGF0ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2RhdGUgPSBudWxsOwoJCXRoaXMuX2RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoJbmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9uYW1lICE9IHYpIHsKCQkJCXRoaXMuX25hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX25hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbmFtZSk7CgkJfQoJfQoKCWNsZWFyX25hbWUoKSB7CgkJdGhpcy5fbmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX25hbWUgPSBudWxsOwoJCXRoaXMuX25hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCglyZW1hcmsodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9yZW1hcmtfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZW1hcmsiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3JlbWFyayAhPSB2KSB7CgkJCQl0aGlzLl9yZW1hcmtfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3JlbWFyayA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcmVtYXJrKTsKCQl9Cgl9CgoJY2xlYXJfcmVtYXJrKCkgewoJCXRoaXMuX3JlbWFya19zZXQgPSBudWxsOwoJCXRoaXMuX3JlbWFyayA9IG51bGw7CgkJdGhpcy5fcmVtYXJrX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBtYW5hZ2VyX0RlcGFydG1lbnRzICoqLwoJbWFuYWdlcl9EZXBhcnRtZW50cyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50czsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnNDJjZjYwZGYtYTgwMS00MDk4LTgxYjYtOGVjNjRlNmViZmY4JyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdEZXBhcnRtZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9tYW5hZ2VyX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ21hbmFnZXJfRGVwYXJ0bWVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgIm1hbmFnZXIgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkRlcGFydG1lbnQiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdtYW5hZ2VyX0RlcGFydG1lbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJtYW5hZ2VyIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiRGVwYXJ0bWVudCIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5tYW5hZ2VyKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHMucHVzaCguLi52KTsKCQl0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9tYW5hZ2VyX0RlcGFydG1lbnRzKCkgewoJCXRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50c19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG1hbmFnZXJfRGVwYXJ0bWVudHMgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjYWxsZXJfSW5jaWRlbnRzICoqLwoJY2FsbGVyX0luY2lkZW50cyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fY2FsbGVyX0luY2lkZW50czsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnNWJlZTIzNGMtNWU0My00NGNhLThlMGYtNDAyYzJhZGUxOTM0JyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdJbmNpZGVudCcpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fY2FsbGVyX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NhbGxlcl9JbmNpZGVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgImNhbGxlciBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiSW5jaWRlbnQiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjYWxsZXJfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJjYWxsZXIgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJJbmNpZGVudCIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5jYWxsZXIodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fY2FsbGVyX0luY2lkZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX2NhbGxlcl9JbmNpZGVudHNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX2NhbGxlcl9JbmNpZGVudHNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX2NhbGxlcl9JbmNpZGVudHMoKSB7CgkJdGhpcy5fY2FsbGVyX0luY2lkZW50c19zZXQgPSBudWxsOwoJCXRoaXMuX2NhbGxlcl9JbmNpZGVudHMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9jYWxsZXJfSW5jaWRlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY2FsbGVyX0luY2lkZW50cyAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvbnRhY3RfSW5jaWRlbnRzICoqLwoJY29udGFjdF9JbmNpZGVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICc1YmVlMjM0Yy01ZTQzLTQ0Y2EtOGUwZi00MDJjMmFkZTE5MzQnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0luY2lkZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9jb250YWN0X3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NvbnRhY3RfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJjb250YWN0IGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJJbmNpZGVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NvbnRhY3RfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJjb250YWN0IG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiSW5jaWRlbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YuY29udGFjdCh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9jb250YWN0X0luY2lkZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9jb250YWN0X0luY2lkZW50c19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfY29udGFjdF9JbmNpZGVudHMoKSB7CgkJdGhpcy5fY29udGFjdF9JbmNpZGVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb250YWN0X0luY2lkZW50cyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29udGFjdF9JbmNpZGVudHMgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB1c2VyX0dyb3VwX01lbWJlcnMgKiovCgl1c2VyX0dyb3VwX01lbWJlcnModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyczsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnYWMzN2NmMTktNThhZC00ZDg3LTg5MWMtMzNiOTZmNTQ2MjUzJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdHcm91cCBNZW1iZXInKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX3VzZXJfc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXNlcl9Hcm91cF9NZW1iZXJzJywgJ0VudGl0eU9iamVjdCcsIDEsICJ1c2VyIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJHcm91cF9NZW1iZXIiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1c2VyX0dyb3VwX01lbWJlcnMnLCAnRW50aXR5T2JqZWN0JywgMSwgInVzZXIgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJHcm91cF9NZW1iZXIiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YudXNlcih0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl91c2VyX0dyb3VwX01lbWJlcnMucHVzaCguLi52KTsKCQl0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfdXNlcl9Hcm91cF9NZW1iZXJzKCkgewoJCXRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19zZXQgPSBudWxsOwoJCXRoaXMuX3VzZXJfR3JvdXBfTWVtYmVycyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHVzZXJfR3JvdXBfTWVtYmVycyAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX3VzZXJuYW1lX3NldCwKCgkJCXRoaXMuX3Bhc3N3b3JkX3NldCwKCgkJCXRoaXMuX2RlcGFydG1lbnRfc2V0LAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJCXRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfc2V0LAoKCQkJdGhpcy5fY2FsbGVyX0luY2lkZW50c19zZXQsCgoJCQl0aGlzLl9jb250YWN0X0luY2lkZW50c19zZXQsCgoJCQl0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fdXNlcm5hbWVfc2V0ID0gdGhpcy5fdXNlcm5hbWVfc2V0OwoJCXJldC5fdXNlcm5hbWVfY29vcCA9IHRoaXMuX3VzZXJuYW1lX2Nvb3A7CgkJcmV0LnVzZXJuYW1lID0gdGhpcy51c2VybmFtZSgpID8gdGhpcy51c2VybmFtZSgpIDogdGhpcy51c2VybmFtZSgpOwoKCQlyZXQuX3Bhc3N3b3JkX3NldCA9IHRoaXMuX3Bhc3N3b3JkX3NldDsKCQlyZXQuX3Bhc3N3b3JkX2Nvb3AgPSB0aGlzLl9wYXNzd29yZF9jb29wOwoJCXJldC5wYXNzd29yZCA9IHRoaXMucGFzc3dvcmQoKSA/IHRoaXMucGFzc3dvcmQoKSA6IHRoaXMucGFzc3dvcmQoKTsKCgkJcmV0Ll9kZXBhcnRtZW50X3NldCA9IHRoaXMuX2RlcGFydG1lbnRfc2V0OwoJCXJldC5fZGVwYXJ0bWVudF9jb29wID0gdGhpcy5fZGVwYXJ0bWVudF9jb29wOwoJCXJldC5kZXBhcnRtZW50ID0gdGhpcy5kZXBhcnRtZW50KCkgPyB0aGlzLmRlcGFydG1lbnQoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5kZXBhcnRtZW50KCk7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5tYW5hZ2VyX0RlcGFydG1lbnRzID0gdGhpcy5tYW5hZ2VyX0RlcGFydG1lbnRzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXQuY2FsbGVyX0luY2lkZW50cyA9IHRoaXMuY2FsbGVyX0luY2lkZW50cygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0LmNvbnRhY3RfSW5jaWRlbnRzID0gdGhpcy5jb250YWN0X0luY2lkZW50cygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0LnVzZXJfR3JvdXBfTWVtYmVycyA9IHRoaXMudXNlcl9Hcm91cF9NZW1iZXJzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJ1c2VybmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VybmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInBhc3N3b3JkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZGVwYXJ0bWVudCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJbWFuYWdlcl9EZXBhcnRtZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXJfVXNlcnMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQljYWxsZXJfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2FsbGVyX1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJY29udGFjdF9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250YWN0X1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJdXNlcl9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcl9Vc2VycycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCWlmICghdXNlcm5hbWUgJiYgIXBhc3N3b3JkICYmICFzYWxlc25vdy5fX3Rva2VuICYmIHRoaXMuVGVzdFsnX2F1dGhvcml6ZS51c2VybmFtZSddKSB7CgkJCXVzZXJuYW1lID0gdGhpcy5UZXN0WydfYXV0aG9yaXplLnVzZXJuYW1lJ107CgkJCXBhc3N3b3JkID0gdGhpcy5UZXN0WydfYXV0aG9yaXplLnBhc3N3b3JkJ107CgkJfQoKCQlpZiAoYlNlcnZlcikgewoJCQlpZiAodXNlcm5hbWUgJiYgIXNhbGVzbm93Ll90ZXN0VXNlcikgewoJCQkJc2FsZXNub3cuX3Rlc3RVc2VyID0gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZnJvbURvY3VtZW50KHRoaXMuVGVzdFsnX2F1dGhvcml6ZS50ZXN0VXNlciddIHx8IHt9KS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS51c2VybmFtZSh1c2VybmFtZSkucGFzc3dvcmQocGFzc3dvcmQpLnN0b3JlKCk7CgkJCX0KCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMudXNlcm5hbWUodXNlcm5hbWUsICc9JykucGFzc3dvcmQocGFzc3dvcmQsICc9JykuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuZmluZCgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfYXV0aG9yaXplJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXJ2ZXI6ICIgKyBiU2VydmVyICsgIiwgT2JqOiIsIHJldCk7CgoJCQlpZiAocmV0KSB7CgkJCQlpZiAodHlwZW9mKGpzb253ZWJ0b2tlbikgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0ganNvbndlYnRva2VuLnNpZ24ocmV0Ll90b0RvY3VtZW50KCksIHRoaXMuX19jb25maWcoJ3NlY3JldCcpLCB7CgkJCQkJCWV4cGlyZXNJbjogJzE4MDBzJwoJCQkJCX0pOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSB0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KHJldC5fdG9Eb2N1bWVudCgpKSk7CgkJCQl9CgkJCX0KCgkJCXJldCA9IHsKCQkJCWFjY2Vzc190b2tlbjogcmV0LAoJCQl9OwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfYXV0aG9yaXplJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXJ2ZXI6ICIgKyBiU2VydmVyICsgIiwgdG9rZW46ICIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBlbHNlIHsKCQkJbGV0IGNsaWVudF9pZCA9IHRoaXMuX19jb25maWcoJ2NsaWVudF9pZCcpOwoJCQlsZXQgY2xpZW50X3NlY3JldCA9IHRoaXMuX19jb25maWcoJ3NlY3JldCcpOwoKCQkJaWYgKCF1c2VybmFtZSAmJiAhcGFzc3dvcmQgJiYgc2FsZXNub3cuX190b2tlbikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2F1dGhvcml6ZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gdXNlcm5hbWUvcGFzc3dvcmQgYW5kIHRva2VuIGFscmVhZHkgZXhpc3RzIik7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXNhbGVzbm93Ll9fdG9rZW4gPSBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLnVzZXJuYW1lKHVzZXJuYW1lKS5wYXNzd29yZChwYXNzd29yZCkuYXV0aG9yaXplKCk7CgoJCX0KCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJkZXBhcnRtZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBkZXBhcnRtZW50Jywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5EZXBhcnRtZW50KCkuZGVwYXJ0bWVudF9Vc2Vycyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX3NlcnZlcigpIHsKCQkvLyBuZXRzdGF0IC1hbm8gfCBmaW5kc3RyIDozMDAwIHwgZmluZHN0ciBMSVNURU5JTkcKCQkvLyB0c2tpbGwgPHBpZD4KCgkJLy8gZ2xvYmFscwoJCXZhciBnbG9iYWxNb2R1bGVzID0gewoJCQlleHByZXNzOiAnZXhwcmVzcycsCgkJCWh0dHBzOiAnaHR0cHMnLAoJCQlodHRwOiAnaHR0cCcsCgkJCXNlbGZzaWduZWQ6ICdzZWxmc2lnbmVkJywKCQkJdXRpbDogJ3V0aWwnLAoJCQljb3JzOiAnY29ycycsCgkJCWJvZHlQYXJzZXI6ICdib2R5LXBhcnNlcicsCgkJCWF4aW9zOiAnYXhpb3MnLAoJCQkvL2NyeXB0bzogJ2NyeXB0bycsCgkJCWZzOiAnZnMnLAoJCQlvczogJ29zJywKCQkJRG90T2JqZWN0OiAnZG90LW9iamVjdCcsCgoJCQltaW5pbWlzdDogJ21pbmltaXN0JywKCgkJCW1hY2hpbmVpZDogJ25vZGUtbWFjaGluZS1pZCcsCgkJCWNoaWxkX3Byb2Nlc3M6ICdjaGlsZF9wcm9jZXNzJywKCgkJCWV2ZW50czogJ2V2ZW50cycsCgkJCXNvY2tldGlvOiAnc29ja2V0LmlvJywKCQkJbXF0dDogJ21xdHQnLAoKCQkJanNvbndlYnRva2VuOiAnanNvbndlYnRva2VuJywKCgkJfTsKCgkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX3NlcnZlcicsICdFbnRpdHlPYmplY3QnLCAwLCAibnBtIGluc3RhbGwgIiArIE9iamVjdC52YWx1ZXMoZ2xvYmFsTW9kdWxlcykuam9pbignICcpKTsKCQlsZXQgbWlzc2luZ0dsb2JhbE1vZHVsZXMgPSBPYmplY3QuZW50cmllcyhnbG9iYWxNb2R1bGVzKS5tYXAoZSA9PiB7CgkJCXRyeSB7CgkJCQlnbG9iYWxbZVswXV0gPSByZXF1aXJlKGVbMV0pOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3NlcnZlcicsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCQlyZXR1cm4gZVsxXTsKCQkJfQoJCX0pLmZpbHRlcihlID0+IGUpOwoJCWlmIChtaXNzaW5nR2xvYmFsTW9kdWxlcy5sZW5ndGgpIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19zZXJ2ZXInLCAnRW50aXR5T2JqZWN0JywgMSwgIm5wbSBpbnN0YWxsICIgKyBtaXNzaW5nR2xvYmFsTW9kdWxlcy5qb2luKCcgJykpOwoKCQkvLyByZWZyZXNoIHNjcmlwdAoJCXRoaXMuc2V0SW50ZXJ2YWwoYXN5bmMgKHMpID0+IGF3YWl0IHRoaXMuX3JlZnJlc2hBUEkocywgJ2FwaXNlcnZlci5qcycpLCAwLjUsIHByb2Nlc3MuYXJndi5zbGljZSgyKS5sZW5ndGggPyBwcm9jZXNzLmFyZ3Yuc2xpY2UoMilbMF0gOiAnc2FsZXNub3cnKTsKCgkJY29uc3QgYXBwID0gZXhwcmVzcygpOwoKCQlhcHAudXNlKGNvcnMoKSk7CgoJCWFwcC51c2UoZXhwcmVzcy51cmxlbmNvZGVkKHsKCQkJZXh0ZW5kZWQ6IHRydWUsCgkJCWxpbWl0OiAnNTBtYicKCQl9KSk7CgkJYXBwLnVzZShib2R5UGFyc2VyLmpzb24oewoJCQl2ZXJpZnk6IChyZXEsIHJlcywgYnVmKSA9PiByZXEucmF3Qm9keSA9IGJ1ZgoJCX0pKTsKCgkJZ2xvYmFsLmF1dGhlbnRpY2F0ZSA9IGFzeW5jIChyZXEsIHJlcywgbmV4dCkgPT4gewoJCQljb25zdCBhdXRoSGVhZGVyID0gcmVxLmhlYWRlcnNbJ2F1dGhvcml6YXRpb24nXTsKCQkJY29uc3QgdG9rZW4gPSBhdXRoSGVhZGVyICYmIGF1dGhIZWFkZXIuc3BsaXQoJyAnKVsxXTsKCgkJCWlmICh0b2tlbiA9PSBudWxsKSByZXR1cm4gcmVzLnNlbmRTdGF0dXMoNDAxKTsKCgkJCWpzb253ZWJ0b2tlbi52ZXJpZnkodG9rZW4sIHRoaXMuX19jb25maWcoJ3NlY3JldCcpLCAoZXJyLCBvYmopID0+IHsKCQkJCWlmIChlcnIpIHJldHVybiByZXMuc2VuZFN0YXR1cyg0MDMpOwoKCQkJCXJlcS5fX2F1dGhvcml6YXRpb24gPSBvYmo7CgkJCQluZXh0KCk7CgkJCX0pOwoJCX07CgoJCWFwcC5wb3N0KCcvbWV0aG9kL1VzZXIvYXV0aG9yaXplJywgKHJlcSwgcmVzKSA9PiB0aGlzLl9pbmJvdW5kQ2FsbChyZXEsIHJlcywgIlVzZXIiLCAiYXV0aG9yaXplIikpOwoJCWFwcC5nZXQoJy9tZXRob2QvVXNlci9hdXRob3JpemUnLCAocmVxLCByZXMpID0+IHRoaXMuX2luYm91bmRDYWxsKHJlcSwgcmVzLCAiVXNlciIsICJhdXRob3JpemUiKSk7CgoJCWFwcC5wb3N0KCcvbWV0aG9kLzpjbGFzcy86bWV0aG9kJywgZ2xvYmFsLmF1dGhlbnRpY2F0ZSwgKHJlcSwgcmVzKSA9PiB0aGlzLl9pbmJvdW5kQ2FsbChyZXEsIHJlcykpOwoJCWFwcC5nZXQoJy9tZXRob2QvOmNsYXNzLzptZXRob2QnLCBnbG9iYWwuYXV0aGVudGljYXRlLCAocmVxLCByZXMpID0+IHRoaXMuX2luYm91bmRDYWxsKHJlcSwgcmVzKSk7CgoJCWlmICh0aGlzLl9fY29uZmlnKCdlbWFpbC5ob3N0JykpIHsKCQkJc2FsZXNub3cudHJhbnNwb3J0ZXIgPSBub2RlbWFpbGVyLmNyZWF0ZVRyYW5zcG9ydCh7CgkJCQlzZXJ2aWNlOiB0aGlzLl9fY29uZmlnKCdlbWFpbC5ob3N0JyksCgkJCQlhdXRoOiB0aGlzLl9fY29uZmlnKCdlbWFpbC51c2VyJykgPyB7CgkJCQkJdXNlcjogdGhpcy5fX2NvbmZpZygnZW1haWwudXNlcicpLAoJCQkJCXBhc3M6IHRoaXMuX19jb25maWcoJ2VtYWlsLnBhc3N3b3JkJyksCgkJCQl9IDogdW5kZWZpbmVkLAoJCQl9KTsKCgkJCS8qCgkJCWF3YWl0IHNhbGVzbm93LnRyYW5zcG9ydGVyLnNlbmRNYWlsKHsKCQkJICAgIGZyb206IHRoaXMuX19jb25maWcoJ2VtYWlsLnNlbmRlcicpLAoJCQkgICAgdG8sCgkJCSAgICBzdWJqZWN0LAoJCQkgICAgdGV4dCwKCQkJfSk7CgkJCSovCgkJfQoKCQlsZXQgc2VjdXJlID0gdGhpcy5fX2NvbmZpZygnc2VjdXJlJyk7CgoJCXNhbGVzbm93Ll9ub2RlID0gYXdhaXQgbmV3IHNhbGVzbm93Lk5vZGUoKS5zZWN1cmUoc2VjdXJlKS5pbml0KHRoaXMuX19jb25maWcoJ2luaXQubG9vcCcpIHx8IDAuNSk7CgoJCWxldCBwb3J0ID0gc2FsZXNub3cuX25vZGUgPyAoc2FsZXNub3cuX25vZGUucG9ydCgpIHx8IDMwMDApIDogMzAwMDsKCQlsZXQgYWRkcmVzcyA9ICIwLjAuMC4wIjsKCgkJaWYgKHRoaXMuX19jb25maWcoJ0NPUlNQcm94eScpKSB7CgkJCWNvcnNfcHJveHkuY3JlYXRlU2VydmVyKHsKCQkJCW9yaWdpbldoaXRlbGlzdDogW10sIC8vIEFsbG93IGFsbCBvcmlnaW5zCgkJCQlyZXF1aXJlSGVhZGVyOiBbJ29yaWdpbicsICd4LXJlcXVlc3RlZC13aXRoJ10sCgkJCQlyZW1vdmVIZWFkZXJzOiBbJ2Nvb2tpZScsICdjb29raWUyJ10KCQkJfSkubGlzdGVuKDgwMDAsIGFkZHJlc3MsIGZ1bmN0aW9uKCkgewoJCQkJY29uc29sZS5sb2coJ1J1bm5pbmcgQ09SUyBBbnl3aGVyZSBvbiAnICsgYWRkcmVzcyArICc6JyArICc4MDAwJyk7CgkJCX0pOwoJCX0KCgkJbGV0IGxpc3RlbiA9IGFzeW5jICgpID0+IHRoaXMubG9nKHVuZGVmaW5lZCwgJ19zZXJ2ZXInLCAnRW50aXR5T2JqZWN0JywgMCwgYHNhbGVzbm93WyR7dGhpcy5pcEFkZHJlc3MoKX1dIGxpc3RlbmluZyBhdCBodHRwJHtzZWN1cmU/J3MnOicnfTovLyR7YWRkcmVzc306JHtwb3J0fWApOwoJCWlmIChzZWN1cmUpIHsKCQkJbGV0IGNlcnQgPSBudWxsOwoJCQlpZiAodGhpcy5fX2NvbmZpZygnc2VjdXJlLnByaXZhdGUnKSkgewoJCQkJY2VydCA9IHsKCQkJCQlwcml2YXRlOiAoYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUodGhpcy5fX2NvbmZpZygnc2VjdXJlLnByaXZhdGUnKSkpLAoJCQkJCWNlcnQ6IChhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZSh0aGlzLl9fY29uZmlnKCdzZWN1cmUuY2VydCcpKSksCgkJCQl9OwoJCQl9IGVsc2UgewoJCQkJY2VydCA9IHNlbGZzaWduZWQuZ2VuZXJhdGUoW3sKCQkJCQluYW1lOiAnY29tbW9uTmFtZScsCgkJCQkJdmFsdWU6ICduYW1tb3VyLmNvbScKCQkJCX1dLCB7CgkJCQkJZGF5czogMzY1CgkJCQl9KTsKCQkJfQoJCQlnbG9iYWwuZXhTZXJ2ZXIgPSBodHRwcy5jcmVhdGVTZXJ2ZXIoewoJCQkJa2V5OiBjZXJ0LnByaXZhdGUsCgkJCQljZXJ0OiBjZXJ0LmNlcnQKCQkJfSwgYXBwKS5saXN0ZW4ocG9ydCwgYWRkcmVzcywgbGlzdGVuKTsKCQl9IGVsc2UgewoJCQlnbG9iYWwuZXhTZXJ2ZXIgPSBodHRwLmNyZWF0ZVNlcnZlcihhcHApLmxpc3Rlbihwb3J0LCBhZGRyZXNzLCBsaXN0ZW4pOwoJCX0KCX0KCglhc3luYyBfaW5ib3VuZENhbGwocmVxLCByZXMsIGNOYW1lLCBtTmFtZSkgewoJCWxldCByZXQgPSB7fTsKCQl0cnkgewoJCQlyZXQgPSBhd2FpdCBuZXcgc2FsZXNub3dbcmVxLnBhcmFtcy5jbGFzcyB8fCBjTmFtZV0oKS5faW52b2tlKHJlcS5wYXJhbXMubWV0aG9kIHx8IG1OYW1lLCByZXEuYm9keSwgcmVxLnF1ZXJ5LCByZXEuX19hdXRob3JpemF0aW9uKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW5ib3VuZENhbGwnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQlyZXQgPSB7CgkJCQlFeGNlcHRpb246ICJFeGNlcHRpb246ICIgKyBleCwKCQkJfTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJlcS5xdWVyeVsianNvbiJdICE9ICJ0cnVlIiAmJiByZXEuYm9keSAmJiByZXEuYm9keS5fX2ZsYXR0ZWQpIHJldCA9IHsKCQkJX19mbGF0dGVkOiBGbGF0dGVkLnN0cmluZ2lmeShyZXQpCgkJfTsKCgkJaWYgKHJldCAmJiB0eXBlb2YocmV0KSA9PT0gIm51bWJlciIpIHJldCA9IHJldC50b1N0cmluZygpOwoJCXJlcy5zZW5kKHJldCk7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpICE9ICdVc2VyJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQkJY2FzZSAiaW5pdCI6IHsKCgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJY2FzZSAiYXV0aG9yaXplIjogewoKCQkJCQlicmVhazsKCQkJCX0KCgkJCX0KCQl9CgoJCWlmICghbiB8fCBzYWxlc25vdy5fbm9kZS5fc2FtZU5vZGUobikpIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkNhbGxiYWNrIik7CgkJCXJldCA9IGF3YWl0IHRoaXMuX2ludm9rZShtZXRob2QsIGRhdGEpOwoJCX0gZWxzZSBpZiAobi5hZGRyZXNzKCkgJiYgbi5fc2FtZU5vZGUobikgLyphY3R1YWwgbm9kZSovICkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBuLl9hZGRyZXNzLCBuLl9wb3J0LCBtZXRob2QpOwoJCQl0cnkgewoJCQkJbGV0IGNvbmZpZyA9IHsKCQkJCQloZWFkZXJzOiB7fSwKCQkJCX07CgkJCQlpZiAoc2FsZXNub3cuX190b2tlbikgY29uZmlnLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGAke3NhbGVzbm93Ll9fdG9rZW4udG9rZW5fdHlwZX0gJHtzYWxlc25vdy5fX3Rva2VuLmFjY2Vzc190b2tlbn1gOwoJCQkJcmV0ID0gYXdhaXQgYXhpb3MucG9zdChgaHR0cCR7bi5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHtuLmFkZHJlc3MoKX06JHtuLnBvcnQoKSB8fCAzMDAwfS9tZXRob2QvVXNlci8ke21ldGhvZH1gLCBkYXRhLCBjb25maWcpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQl9CgkJfSBlbHNlIHsKCgkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMuX19nZW5lcmF0ZWQ7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMub25saW5lOwoKCQkJfQoKCQkJLy93aHkgZG8gd2UgbmVlZCB0aGlzPz8/CgoJCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQkJdHJ5IHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHttZXRob2R9YCk7CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJbGV0IF9pZCA9IG51bGw7CgkJCQlpZiAodHlwZW9mKGRhdGEpID09PSAndW5kZWZpbmVkJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIGRhdGEsIG1ldGhvZCwge30pOwoJCQkJCXJldHVybiBkYXRhOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoZGF0YSkgPT09ICdzdHJpbmcnKSB7CgkJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShkYXRhKTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gZGF0YS5fX3RoaXMuY29kZSB8fCBkYXRhLmlkIHx8IGRhdGEuSUQ7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQkJaWYgKGRhdGEuSWQgJiYgZGF0YS5JZCA9PSBkYXRhLklkKSB7CgkJCQkJCV9pZCA9IGRhdGEuSWQ7CgkJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCQl9IGVsc2UgaWYgKGRhdGEuRW50aXR5Q2xhc3MpIHsKCQkJCQkJX2lkID0gZGF0YS5FbnRpdHlDbGFzcy5JZCB8fCBkYXRhLkVudGl0eUNsYXNzLk5hbWU7CgkJCQkJfSBlbHNlIHsKCQkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiYjU4YjcwMzYtNjUxOS00NmVhLWFmNjgtNTEyM2ZkNDZiMWVlIiB8fCAiTlVMTCI7CgkJCQkJfQoJCQkJfQoKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW21ldGhvZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVXNlclttZXRob2RdW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbbWV0aG9kXVtfaWRdIHx8IHt9OwoKCQkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaCh7fSwgewoJCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCQl9KTsKCgkJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW21ldGhvZF1bX2lkXVtfaGFzaF0gPSB7CgkJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoe30pLAoJCQkJCW9iajogZGF0YSwKCQkJCQlyZXVzZWQ6IDAsCgkJCQl9OwoJCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0gPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGRhdGEsIG1ldGhvZCwge30sIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBgVHJpZ2dlcnJpbmcgJHttZXRob2R9IHRvICR7bi5jb2RlKCl9ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSxudWxsLDQpfWApOwoKCQkJbGV0IGV2ID0gbmV3IHNhbGVzbm93LkV2ZW50KCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuY29kZSh0aGlzLl91dWlkKCkpLm5hbWUodGhpcy5fX2NvbmZpZygnZXZlbnQnKSB8fCAnc2FsZXNub3cuRXZlbnQnKS5kYXRlKHRoaXMuc2VydmVyRGF0ZSgpKS5yZWNpcGllbnQobikubWV0aG9kKG1ldGhvZCkuY2xhc3NOYW1lKCdVc2VyJykuc2VuZGVyKHNhbGVzbm93Ll9ub2RlKS5jYXJyaWVyKHNhbGVzbm93Ll9ub2RlKS5wYXlsb2FkKGRhdGEpOwoJCQlpZiAoZXZlbnQpIHsKCQkJCWlmIChldmVudC5fcmVzcG9uc2VUb19zZXQpIGV2LnJlc3BvbnNlVG8oZXZlbnQucmVzcG9uc2VUbygpKTsKCQkJCWlmIChldmVudC5fc2VuZGVyX3NldCkgZXYuc2VuZGVyKGV2ZW50LnNlbmRlcigpKTsKCQkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCkgZXYuY2xhc3NOYW1lKGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCWlmIChldmVudC5fY2Fycmllcl9zZXQgfHwgZXZlbnQuX3NlbmRlcl9zZXQpIGV2LmNhcnJpZXIoZXZlbnQuY2FycmllcigpIHx8IGV2ZW50LnNlbmRlcigpKTsKCQkJfQoJCQlyZXQgPSBhd2FpdCBldi50cmlnZ2VyKCk7CgoJCQlpZiAodHlwZW9mKHJldCkgPT09ICJzdHJpbmciKSB7CgkJCQl0cnkgewoJCQkJCXJldCA9IEpTT04ucGFyc2UocmV0KTsKCQkJCX0gY2F0Y2ggKGV4KSB7fQoJCQl9CgkJCXJldHVybiByZXQ7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5pdCI6IHsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiYXV0aG9yaXplIjogewoKCQkJCXNhbGVzbm93Ll9fdG9rZW4gPSB7CgkJCQkJdG9rZW5fdHlwZTogIkJlYXJlciIsCgkJCQkJYWNjZXNzX3Rva2VuOiByZXQKCQkJCX07CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LlVzZXIobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93LlVzZXIobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOwoJCX0KCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5pdCI6IHsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiYXV0aG9yaXplIjogewoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBVc2VyLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgVXNlci5faW52b2tlOiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLAoJCQkJCSdvYmonOiBvYmoKCQkJCX0KCQkJfTsKCQl9IGVsc2UgewoJCQlyZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOwoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQl9CgoJCWlmIChyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbikgewoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0ge307CgkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCXJldCA9IHJldC5tYXAociA9PiB7CgkJCQkJaWYgKHIgJiYgci5fdG9Eb2N1bWVudCkgewoJCQkJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyLl90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93LlVzZXIuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCWlmIChzYWxlc25vdy5Ub29scyAmJiBzYWxlc25vdy5Ub29scy5sZW5ndGgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2xvYWRUb29scycsICdFbnRpdHlPYmplY3QnLCAwLCBgWyR7c291cmNlfV06IFRvb2xzIGFscmVhZHkgbG9hZGVkYCk7CgkJCXJldHVybiBzYWxlc25vdy5Ub29sczsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19sb2FkVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMCwgYFske3NvdXJjZX1dOiBMb2FkaW5nIHRvb2xzLi4uYCk7CgoJCWRlbGV0ZSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzczsKCgkJaWYgKHNhbGVzbm93Ll9ub2RlICYmIHNhbGVzbm93Ll9ub2RlLl9wYXJlbnRfc2V0ICYmIHNhbGVzbm93Ll9ub2RlLnBhcmVudCgpLl9zYW1lTm9kZShzYWxlc25vdy5fbm9kZS5wYXJlbnQoKSkpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2xvYWRUb29scycsICdFbnRpdHlPYmplY3QnLCAwLCBgWyR7c291cmNlfV06IExvYWRpbmcgZnJvbSBub2RlIHBhcmVudGApOwoJCQlsZXQgcmV0ID0gc2FsZXNub3cuVG9vbCA/IChhd2FpdCBuZXcgc2FsZXNub3cuVG9vbCgpLiAvKm5vZGUoc2FsZXNub3cuX25vZGUpLiovIGZpbmRBbGwoMikpLm1hcCh0ID0+IHQuX3RvRG9jdW1lbnQoKSkgOiBudWxsOwoJCQlpZiAocmV0ICYmIHJldC5sZW5ndGgpIHsKCQkJCXNhbGVzbm93LlRvb2xzID0gcmV0OwoJCQkJcmV0dXJuIHJldDsKCQkJfQoJCX0KCgkJbGV0IHRvb2xzID0gdGhpcy5ydW5TY3JpcHQoYFt7CiAgICAgICAgCQl0eXBlOiB7CiAgICAgICAgCQkJbmFtZTogIlNxbERCIiwKICAgICAgICAJCX0sCiAgICAgICAgCQl0b29sX0NvbmZpZ3M6IFt7CiAgICAgICAgCQkJbmFtZTogImNyZWF0ZSIsCiAgICAgICAgCQkJdmFsdWU6IDMsCiAgICAgICAgCQl9LCB7CiAgICAgICAgCQkJbmFtZTogInR5cGUiLAogICAgICAgIAkJCXZhbHVlOiAic3FsaXRlIiwKICAgICAgICAJCX0sIHsKICAgICAgICAJCQluYW1lOiAiU3luY0VudGl0eUF0dHJpYnV0ZXMiLAogICAgICAgIAkJCXZhbHVlOiB0cnVlLAogICAgICAgIAkJfSwgewogICAgICAgIAkJCW5hbWU6ICJTeW5jVHlwZWRBdHRyaWJ1dGVzIiwKICAgICAgICAJCQl2YWx1ZTogdHJ1ZSwKICAgICAgICAJCX1dCiAgICAgICAgCX1dYCk7CgoJCXRyeSB7CgkJCWxldCBmTmFtZSA9ICJBUElTRVJWRVJfX2xvYWRUb29scy5qc29uIjsKCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiBmcy5leGlzdHNTeW5jKGZOYW1lKSkgdG9vbHMgPSB0aGlzLnJ1blNjcmlwdChhd2FpdCBmcy5wcm9taXNlcy5yZWFkRmlsZShmTmFtZSkpIHx8IHRvb2xzOwoJCQlpZiAodGhpcy5fX2NvbmZpZygiZ2l0aHViLnRvb2xzIikpIHRvb2xzID0gdGhpcy5ydW5TY3JpcHQoYXdhaXQgYXhpb3MuZ2V0KHRoaXMuX19jb25maWcoImdpdGh1Yi50b29scyIpICsgZk5hbWUsIHsKCQkJCXZhbGlkYXRlU3RhdHVzOiBzdGF0dXMgPT4gc3RhdHVzIDwgNTAwCgkJCX0pLmRhdGEpIHx8IHRvb2xzOwoKCQkJbGV0IHREYXRhID0gbnVsbDsKCQkJaWYgKHRoaXMuc3IoKSkgdERhdGEgPSBhd2FpdCB0aGlzLnNyKCkuXygiQ29udGVudE1hbmFnZXIuY21zU3RvcmVkU2NyaXB0RmluZCIsIG51bGwsIHsKCQkJCU5hbWU6IGZOYW1lLAoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJRW5hYmxlZDogdHJ1ZQoJCQl9KTsKCQkJaWYgKCF0RGF0YSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2xvYWRUb29scycsICdFbnRpdHlPYmplY3QnLCAwLCBgWyR7c291cmNlfV06IFRvb2xzIG5vdCBpbiBDTVNgKTsKCQkJfSBlbHNlIHsKCQkJCXRvb2xzID0gdGhpcy5ydW5TY3JpcHQodERhdGEuU2NyaXB0KSB8fCB0b29sczsKCQkJfQoKCQkJdG9vbHMgPSBzYWxlc25vdy5fX1Rvb2xzIHx8IHRvb2xzOwoJCQlkZWxldGUgc2FsZXNub3cuX19Ub29sczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbG9hZFRvb2xzJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQl9CgoJCXRvb2xzLmZpbHRlcih0ID0+IHR5cGVvZih0LmFjdGl2ZSkgPT09ICJ1bmRlZmluZWQiIHx8ICh0eXBlb2YodC5hY3RpdmUpID09PSAidW5kZWZpbmVkIiAmJiB0LmFjdGl2ZSkpLmZvckVhY2godCA9PiB7CgkJCXQubmFtZSA9IHQubmFtZSB8fCB0LnR5cGUubmFtZTsKCgkJCXQuYWN0aXZlID0gdHlwZW9mKHQuYWN0aXZlKSAhPT0gJ3VuZGVmaW5lZCcgPyB0LmFjdGl2ZSA6IHRydWU7CgkJCXQuZW5hYmxlZCA9IHR5cGVvZih0LmVuYWJsZWQpICE9PSAndW5kZWZpbmVkJyA/IHQuZW5hYmxlZCA6IHRydWU7CgkJCXQudHlwZS5hY3RpdmUgPSB0eXBlb2YodC50eXBlLmFjdGl2ZSkgIT09ICd1bmRlZmluZWQnID8gdC50eXBlLmFjdGl2ZSA6IHRydWU7CgkJCXQudHlwZS5lbmFibGVkID0gdHlwZW9mKHQudHlwZS5lbmFibGVkKSAhPT0gJ3VuZGVmaW5lZCcgPyB0LnR5cGUuZW5hYmxlZCA6IHRydWU7CgoJCQl0LnRvb2xfQ29uZmlncyA9IHQudG9vbF9Db25maWdzIHx8IFtdOwoJCQl0LnRvb2xfQ29uZmlncy5mb3JFYWNoKGMgPT4gewoJCQkJYy5hY3RpdmUgPSB0eXBlb2YoYy5hY3RpdmUpICE9PSAndW5kZWZpbmVkJyA/IGMuYWN0aXZlIDogdHJ1ZTsKCQkJCWMuZW5hYmxlZCA9IHR5cGVvZihjLmVuYWJsZWQpICE9PSAndW5kZWZpbmVkJyA/IGMuZW5hYmxlZCA6IHRydWU7CgkJCX0pOwoKCQkJdC50eXBlLnR5cGVfTWFwcGluZ3MgPSB0LnR5cGUudHlwZV9NYXBwaW5ncyB8fCBbXTsKCQkJdC50eXBlLnR5cGVfTWFwcGluZ3MuZm9yRWFjaChtID0+IHsKCQkJCW0uYWN0aXZlID0gdHlwZW9mKG0uYWN0aXZlKSAhPT0gJ3VuZGVmaW5lZCcgPyBtLmFjdGl2ZSA6IHRydWU7CgkJCQltLmVuYWJsZWQgPSB0eXBlb2YobS5lbmFibGVkKSAhPT0gJ3VuZGVmaW5lZCcgPyBtLmVuYWJsZWQgOiB0cnVlOwoJCQkJbS50eXBlID0gewoJCQkJCW5hbWU6IHQudHlwZS5uYW1lCgkJCQl9OwoJCQl9KTsKCgkJCXQudG9vbF9NYXBwaW5ncyA9IHQudG9vbF9NYXBwaW5ncyB8fCBbXTsKCQkJdC50b29sX01hcHBpbmdzLmZvckVhY2gobSA9PiB7CgkJCQltLmFjdGl2ZSA9IHR5cGVvZihtLmFjdGl2ZSkgIT09ICd1bmRlZmluZWQnID8gbS5hY3RpdmUgOiB0cnVlOwoJCQkJbS5lbmFibGVkID0gdHlwZW9mKG0uZW5hYmxlZCkgIT09ICd1bmRlZmluZWQnID8gbS5lbmFibGVkIDogdHJ1ZTsKCQkJCW0udG9vbCA9IHsKCQkJCQluYW1lOiB0Lm5hbWUKCQkJCX07CgkJCX0pOwoJCX0pOwoKCQl0b29scy5mb3JFYWNoKHQgPT4gdC50b29sX0NvbmZpZ3MgPSB0LnRvb2xfQ29uZmlncy5maWx0ZXIoYyA9PiB0eXBlb2YoYy52YWx1ZSkgIT09ICJvYmplY3QiKS5jb25jYXQodC50b29sX0NvbmZpZ3MuZmlsdGVyKGMgPT4gdHlwZW9mKGMudmFsdWUpID09PSAib2JqZWN0IikubWFwKGMgPT4gT2JqZWN0LmtleXMoYy52YWx1ZSkubWFwKG5jb2RlID0+IHsKCQkJbGV0IF9jID0gewoJCQkJbmFtZTogYy5uYW1lLAoJCQkJdmFsdWU6IGMudmFsdWVbbmNvZGVdLAoJCQl9OwoJCQlpZiAobmNvZGUgIT0gImRlZmF1bHQiKSB7CgkJCQlfYy5ub2RlID0gewoJCQkJCWNvZGU6IG5jb2RlLAoJCQkJCWFjdGl2ZTogdHJ1ZSwKCQkJCQllbmFibGVkOiBmYWxzZSwgLy8gb3RoZXJ3aXNlIGl0IHN0YXJ0cyBnZXR0aW5nIGV2ZW50cwoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogIk5vZGVKUyIsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlyZXR1cm4gX2M7CgkJfSkuZmxhdCgpKS5mbGF0KCkpKTsKCgkJdG9vbHMuZm9yRWFjaCh0ID0+IHQudG9vbF9Db25maWdzLmZvckVhY2goYyA9PiBjLnZhbHVlID0gSlNPTi5zdHJpbmdpZnkoYy52YWx1ZSkpKTsKCgkJdG9vbHMgPSB0b29scy5maWx0ZXIodCA9PiBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpQUVhWMGFGTmhibVFpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pLmZpbmQoX3QgPT4gKHR5cGVvZihfdCkgPT09ICdzdHJpbmcnID8gX3QgOiBfdC5uYW1lKSA9PSB0Lm5hbWUpKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2xvYWRUb29scycsICdFbnRpdHlPYmplY3QnLCAwLCBgWyR7c291cmNlfV06IFRvb2xzIGFyZSAke3Rvb2xzLmxlbmd0aH1gKTsKCgkJc2FsZXNub3cuVG9vbHMgPSB0b29sczsKCgkJaWYgKHNhbGVzbm93Ll9ub2RlICYmIGJTdG9yZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbG9hZFRvb2xzJywgJ0VudGl0eU9iamVjdCcsIDAsICJTYXZpbmcgVG9vbHMiLCBzYWxlc25vdy5fbm9kZS5jb2RlKCksIHRoaXMuX19jb25maWcoJ3R5cGUnKSk7CgkJCWZvciBhd2FpdCAoY29uc3QgdCBvZiB0b29scykgewoJCQkJdC50b29sX01hcHBpbmdzLmZvckVhY2gobSA9PiBkZWxldGUgbS50b29sKTsKCQkJCXQudHlwZS50eXBlX01hcHBpbmdzLmZvckVhY2gobSA9PiBkZWxldGUgbS50eXBlKTsKCgkJCQlhd2FpdCBuZXcgc2FsZXNub3cuVG9vbCgpLl9mcm9tRG9jdW1lbnQodCkuc3RvcmUoKTsKCQkJfQoJCX0KCgkJc2FsZXNub3cuVG9vbHMuZmlsdGVyKHQgPT4gIXQuYXhpb3MpLmZvckVhY2godCA9PiB7CgkJCXQuYXhpb3MgPSBheGlvcy5jcmVhdGUoKTsKCQkJdC5heGlvcy5pbnRlcmNlcHRvcnMucmVxdWVzdC51c2UoYXN5bmMgY29uZmlnID0+IHsKCQkJCXRyeSB7CgkJCQkJY29uZmlnLm1ldGEgPSBjb25maWcubWV0YSB8fCB7fTsKCQkJCQljb25maWcubWV0YS5jb3VudGVyID0gNDsKCgkJCQkJbGV0IHRva2VuVXJpID0gdGhpcy5fX2NvbmZpZygib2F1dGgudG9rZW4udXJpIiwgbnVsbCwgewoJCQkJCQl0b29sOiB0CgkJCQkJfSk7CgkJCQkJbGV0IHJlZnJlc2hVcmkgPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5yZWZyZXNoLnVyaSIsIG51bGwsIHsKCQkJCQkJdG9vbDogdAoJCQkJCX0pOwoJCQkJCWxldCB0b2tlbiA9IHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190b2tlbiIsIG51bGwsIHsKCQkJCQkJdG9vbDogdCwKCQkJCQkJbm9kZTogc2FsZXNub3cuX25vZGUKCQkJCQl9KTsKCQkJCQlpZiAoIWNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gJiYgW3Rva2VuVXJpLCByZWZyZXNoVXJpXS5pbmRleE9mKGNvbmZpZy51cmwpIDwgMCkgewoJCQkJCQlpZiAoIXRva2VuICYmIHNhbGVzbm93Ll9ub2RlKSB7CgoJCQkJCQkJLy8gY3JlYXRlIG9yIGxvYWQgYSBuZXcgb2F1dGggc3RhdGUKCQkJCQkJCXRoaXMuX19jb25maWcoIm9hdXRoLnN0YXRlIiwgbnVsbCwgewoJCQkJCQkJCXRvb2w6IHQsCgkJCQkJCQkJbm9kZTogc2FsZXNub3cuX25vZGUsCgkJCQkJCQkJbmV3VmFsdWU6IHNhbGVzbm93Ll9ub2RlLklkCgkJCQkJCQl9KTsKCQkJCQkJCWxldCBhdXRoVXJpID0gdGhpcy5fX2NvbmZpZygib2F1dGguYXV0aG9yaXplLnVyaSIsIG51bGwsIHsKCQkJCQkJCQl0b29sOiB0CgkJCQkJCQl9KTsKCQkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19sb2FkVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMCwgImF1dGhVcmkiLCBhdXRoVXJpKTsKCQkJCQkJCWlmIChmYWxzZSAmJiBhdXRoVXJpKSB7CgkJCQkJCQkJLy8gYXV0aG9yaXplIGFuZCBnZXQgdGhlIGF1dGggY29kZQoJCQkJCQkJCXdpbmRvdy5vcGVuKGF1dGhVcmkpOwoJCQkJCQkJCWF3YWl0IHRoaXMuc2V0SW50ZXJ2YWwodG9vbCA9PiBjb25maWcubWV0YS5jb3VudGVyLS0gJiYgIXRoaXMuX19jb25maWcoJ29hdXRoLmF1dGhvcml6ZS5jb2RlJywgbnVsbCwgewoJCQkJCQkJCQl0b29sOiB0b29sCgkJCQkJCQkJfSksIDAuMSwgdCk7CgkJCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2xvYWRUb29scycsICdFbnRpdHlPYmplY3QnLCAwLCAiRG9uZSBMb29waW5nLi4uIiwgdGhpcy5fX2NvbmZpZygnb2F1dGguYXV0aG9yaXplLmNvZGUnLCBudWxsLCB7CgkJCQkJCQkJCXRvb2w6IHQKCQkJCQkJCQl9KSk7CgkJCQkJCQl9CgoJCQkJCQkJLy8gZ2V0IHRoZSB0b2tlbgoKCQkJCQkJfQoJCQkJCQljb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gdGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3R5cGUiLCAiQmVhcmVyIiwgewoJCQkJCQkJdG9vbDogdAoJCQkJCQl9KSArICIgIiArIHRva2VuOwoJCQkJCX0KCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2xvYWRUb29scycsICdFbnRpdHlPYmplY3QnLCAyLCAiYXhpb3MucmVxdWVzdCIsIGV4KTsKCQkJCX0KCQkJCXJldHVybiBjb25maWc7CgkJCX0sIGFzeW5jIGVycm9yID0+IHt9KTsKCQkJdC5heGlvcy5pbnRlcmNlcHRvcnMucmVzcG9uc2UudXNlKHJlc3BvbnNlID0+IHsKCQkJCXJldHVybiByZXNwb25zZTsKCQkJfSwgYXN5bmMgZXJyb3IgPT4gewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2xvYWRUb29scycsICdFbnRpdHlPYmplY3QnLCAwLCAiYXhpb3MgcmVzcG9uc2UgZXJyb3IiLCBlcnJvcik7CgkJCQl0cnkgewoJCQkJCWNvbnN0IG9yaWdpbmFsUmVxdWVzdCA9IGVycm9yLmNvbmZpZzsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3Rva2VuIiwgbnVsbCwgewoJCQkJCQkJdG9vbDogdAoJCQkJCQl9KSAmJiBlcnJvci5yZXNwb25zZSAmJiBlcnJvci5yZXNwb25zZS5zdGF0dXMgPT09IDQwMSAmJiAhb3JpZ2luYWxSZXF1ZXN0Ll9yZXRyeSAmJiBvcmlnaW5hbFJlcXVlc3QuaGVhZGVycy5BdXRob3JpemF0aW9uLmluZGV4T2YodGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3Rva2VuIiwgbnVsbCwgewoJCQkJCQkJdG9vbDogdAoJCQkJCQl9KSkgPiAwKSB7CgkJCQkJCW9yaWdpbmFsUmVxdWVzdC5fcmV0cnkgPSB0cnVlOwoJCQkJCQkvLyBhd2FpdCAoZ2V0IHRoZSB0b2tlbiBvciByZWZyZXNoIGl0KQoKCQkJCQkJb3JpZ2luYWxSZXF1ZXN0LmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190eXBlIiwgIkJlYXJlciIsIHsKCQkJCQkJCXRvb2w6IHQKCQkJCQkJfSkgKyAiICIgKyB0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdG9rZW4iLCBudWxsLCB7CgkJCQkJCQl0b29sOiB0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gdC5heGlvcyhvcmlnaW5hbFJlcXVlc3QpOwoJCQkJCX0KCQkJCQlyZXR1cm4gUHJvbWlzZS5yZWplY3QoZXJyb3IpOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbG9hZFRvb2xzJywgJ0VudGl0eU9iamVjdCcsIDIsICJSZXNwIEludGVyY2VwdG9yIiwgZXgsIGVycm9yKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgoJCXJldHVybiB0b29sczsKCgl9CgoJX19zeW5jX29uKGQpIHsKCQl0aGlzLl9fX3N5bmNfb24gPSB0aGlzLl9fX3N5bmNfb24gfHwge307CgoJCWlmIChkKSB7CgkJCXRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV0gPSBkOwoKCQkJaWYgKHRoaXMuX2RlcGFydG1lbnRfc2V0ICYmIHRoaXMuZGVwYXJ0bWVudCgpKSB0aGlzLmRlcGFydG1lbnQoKS5fX3N5bmNfb24oZCk7CgoJCQkvLyB0aGlzLm1hbmFnZXJfVXNlcnMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJLy8gdGhpcy5jYWxsZXJfVXNlcnMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJLy8gdGhpcy5jb250YWN0X1VzZXJzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCS8vIHRoaXMudXNlcl9Vc2VycygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIodGhpcy5JZCkKCgkJCS51c2VybmFtZSh0aGlzLnVzZXJuYW1lKCksIHRoaXMuX3VzZXJuYW1lX2Nvb3ApCgoJCQkucGFzc3dvcmQodGhpcy5wYXNzd29yZCgpLCB0aGlzLl9wYXNzd29yZF9jb29wKQoKCQkJLmRlcGFydG1lbnQodGhpcy5kZXBhcnRtZW50KCksIHRoaXMuX2RlcGFydG1lbnRfY29vcCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkubWFuYWdlcl9EZXBhcnRtZW50cyh0aGlzLm1hbmFnZXJfRGVwYXJ0bWVudHMoKSwgdGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50c19jb29wKQoKCQkJLmNhbGxlcl9JbmNpZGVudHModGhpcy5jYWxsZXJfSW5jaWRlbnRzKCksIHRoaXMuX2NhbGxlcl9JbmNpZGVudHNfY29vcCkKCgkJCS5jb250YWN0X0luY2lkZW50cyh0aGlzLmNvbnRhY3RfSW5jaWRlbnRzKCksIHRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX2Nvb3ApCgoJCQkudXNlcl9Hcm91cF9NZW1iZXJzKHRoaXMudXNlcl9Hcm91cF9NZW1iZXJzKCksIHRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCW9ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdVc2VyJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgoJCXRyeSB7CgkJCWlmIChBcnJheS5pc0FycmF5KG9iakZyb20pKSByZXR1cm4gb2JqRnJvbS5tYXAobyA9PiB0aGlzLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG8sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpKTsKCgkJCWxldCBzRmllbGQgPSBiUmV2ZXJzZSA/ICd0YXJnZXQnIDogJ3NvdXJjZSc7CgkJCWxldCBzU2NyaXB0ID0gKGJSZXZlcnNlID8gJ291dCcgOiAnaW4nKSArICdTY3JpcHQnOwoJCQlsZXQgdEZpZWxkID0gYlJldmVyc2UgPyAnc291cmNlJyA6ICd0YXJnZXQnOwoJCQlsZXQgdFNjcmlwdCA9IChiUmV2ZXJzZSA/ICdpbicgOiAnb3V0JykgKyAnU2NyaXB0JzsKCgkJCWxldCBfbWF0Y2ggPSAocywgcikgPT4gewoJCQkJbGV0IGFuc3dlciA9IHMgPT0gciB8fCBzLm1hdGNoKG5ldyBSZWdFeHAociwgJ2cnKSk7CgkJCQkvL2xldCBzY3JpcHQgPSBgXGAke3N9XGA9PVxgJHtyfVxgIHx8IFxgJHtzfVxgLm1hdGNoKC8ke3J9L2cpYDsKCQkJCS8vbGV0IGFuc3dlciA9IHRoaXMucnVuU2NyaXB0KHNjcmlwdCk7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXAnLCAnRW50aXR5T2JqZWN0JywgMCwgc2NyaXB0LCBhbnN3ZXIpOwoJCQkJcmV0dXJuIChhbnN3ZXIgJiYgYW5zd2VyLmxlbmd0aCkgPyB0cnVlIDogZmFsc2U7CgkJCX0KCgkJCWxldCB0ZXN0ID0gbSA9PiAoewoJCQkJdmFsaWQ6IG0uYWN0aXZlICYmIG0uZW5hYmxlZCwKCQkJCWNvbnRleHQ6IF9tYXRjaChjb250ZXh0LCBtLmNvbnRleHQpLAoJCQkJY2xhc3M6IF9tYXRjaChjbGFzc05hbWUsIG0uY2xhc3NOYW1lKSwKCQkJCXNGaWVsZDogdHlwZW9mKGNvZGUpID09PSAndW5kZWZpbmVkJyB8fCBfbWF0Y2goY29kZSwgbVtzRmllbGRdKSwKCQkJCXNTY3JpcHQ6IHR5cGVvZihjb2RlKSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mKG1bc1NjcmlwdF0pICE9PSAndW5kZWZpbmVkJywKCQkJCXRhcmdldDogKG1bdEZpZWxkXSB8fCBtW3RTY3JpcHRdKSAhPSBudWxsLAoJCQkJdGV4dDogY29kZSArICcsJyArIHNGaWVsZCArICcsJyArIHRGaWVsZCwKCQkJfSk7CgoJCQlsZXQgbXMgPSAodG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hcCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtjbGFzc05hbWV9LiR7Y29kZX1gLCB0aGlzLl9iZWF1dGlmeShtcy5tYXAobSA9PiAoewoJCQkJbSwKCQkJCXRlc3Q6IHRlc3QobSkKCQkJfSkpLCAnamF2YXNjcmlwdCcpKTsKCQkJbXMgPSBtcy5maWx0ZXIobSA9PiB0ZXN0KG0pLnZhbGlkICYmIHRlc3QobSkuY29udGV4dCAmJiB0ZXN0KG0pLmNsYXNzICYmICh0ZXN0KG0pLnNGaWVsZCB8fCB0ZXN0KG0pLnNTY3JpcHQpICYmIHRlc3QobSkudGFyZ2V0KS5zb3J0KG0gPT4gLW0ub3JkZXIpOwoKCQkJbXMuZmlsdGVyKG0gPT4gbVtzRmllbGRdICYmIG1bdEZpZWxkXSkuZm9yRWFjaChtID0+IHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXAnLCAnRW50aXR5T2JqZWN0JywgMCwgYFske2NvbnRleHR9XS8ke2NsYXNzTmFtZX0uJHtjb2RlfTogJHttW3NGaWVsZF19ID0+ICR7bVt0RmllbGRdfWApOwoJCQkJaWYgKG0uY29udGV4dCA9PSAnRW50aXR5Q2xhc3MnKSB7fSBlbHNlIHsKCQkJCQlEb3RPYmplY3QuY29weShtW3NGaWVsZF0sIG1bdEZpZWxkXSwgb2JqRnJvbSwgb2JqVG8pOwoJCQkJfQoJCQl9KTsKCQkJbXMuZmlsdGVyKG0gPT4gbVtzU2NyaXB0XSB8fCBtW3RTY3JpcHRdKS5mb3JFYWNoKG0gPT4gewoJCQkJWydzU2NyaXB0JywgJ3RTY3JpcHQnXS5mb3JFYWNoKHNOYW1lID0+IHRoaXMuX1NjcmlwdCh0aGlzLnJ1blNjcmlwdChgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIHNjb3BlLCBtZXRob2QsIF90aGlzLCBvYmpGcm9tLCBvYmpUbywgY29kZSkgPT4geyR7bVtzTmFtZV19fWApLCBzTmFtZSwgJ01hcHBpbmcnLCBzYWxlc25vdywgbSwgb2JqRnJvbSwgb2JqVG8sIGNvZGUpKTsKCQkJfSk7CgoJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXAnLCAnRW50aXR5T2JqZWN0JywgMCwgYFske2NvbnRleHR9XS8ke2NsYXNzTmFtZX0uJHtjb2RlfTogcmVzdWx0YCwgb2JqRnJvbSwgb2JqVG8pOwoKCQkJaWYgKHR5cGVvZihjb2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXJldHVybiBvYmpUbzsKCQkJfQoKCQkJaWYgKG1zLmxlbmd0aCAmJiBtc1swXVt0RmllbGRdKSB7CgkJCQlyZXR1cm4gdGhpcy5ydW5TY3JpcHQoYFxgJHtjb2RlfVxgLnJlcGxhY2UoLyR7bXNbMF1bc0ZpZWxkXX0vZywgXGAke21zWzBdW3RGaWVsZF19XGApYCk7CgkJCQkvL3JldHVybiBtc1swXVt0RmllbGRdOwoJCQl9CgkJCXJldHVybiBjb2RlOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXAnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIlVzZXIiOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoJCQkJcmV0ID0gcmV0LnRvTG93ZXJDYXNlKCk7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMgPSB7fSkgewoJCXRyeSB7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCA/IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSBvcHRpb25zLnRvb2wgfHwgdCA9PSBvcHRpb25zLnRvb2wpIDogdGhpcy5Ub29sOwoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgfHwge307CgoJCQlsZXQgbklEID0gc2FsZXNub3cuX25vZGUgPyBzYWxlc25vdy5fbm9kZS5jb2RlKCkgOiAiZGVmYXVsdCI7CgoJCQlsZXQgcmV0ID0gbnVsbFZhbHVlOwoJCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXQgPSBudWxsOwoKCQkJLy8gdG9vbF9Db25maWdzOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIGRvbmUKCQkJbGV0IHRjb25mID0gKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmIGMubm9kZSAmJiBjLm5vZGUuY29kZSA9PSBuSUQpLmNvbmNhdCgob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgIWMubm9kZSkpOwoJCQlpZiAodGNvbmYubGVuZ3RoKSB7CgkJCQlyZXQgPSB0Y29uZlswXS52YWx1ZTsKCQkJCXRyeSB7CgkJCQkJWzEsIDIsIDNdLmZvckVhY2goYSA9PiByZXQgPSBKU09OLnBhcnNlKHJldCkpOwoJCQkJfSBjYXRjaCAoamV4KSB7fQoJCQl9CgoJCQkvLyBtb2RlbCBDb25maWc6IENvbmZpZyBpcyBjbGFzcyBsZXZlbCwgbm9kZSBub3QgcG9zc2libGUgLSBwZW5kaW5nCgkJCWxldCBtY29uZiA9IHRoaXMuQ29uZmlnID8gdGhpcy5Db25maWdbbl0gOiB1bmRlZmluZWQ7CgkJCWlmICh0eXBlb2YobWNvbmYpICE9PSAidW5kZWZpbmVkIikgcmV0ID0gbWNvbmY7CgoJCQkvLyBjb21tYW5kIGxpbmU6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnICYmIGdsb2JhbC5taW5pbWlzdCkgewoJCQkJcmV0ID0gZ2xvYmFsLm1pbmltaXN0KHByb2Nlc3MuYXJndi5zbGljZSgyKSlbbl0gfHwgcmV0OwoJCQl9CgoJCQkvLyByZXF1ZXN0OiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJcmV0ID0gdGhpcy4kX1JFUVVFU1QobikgfHwgcmV0OwoKCQkJaWYgKG9wdGlvbnMubmV3VmFsdWUpIHsKCQkJCWxldCB0YyA9IHRjb25mLmxlbmd0aCA/IHRjb25mWzBdIDoge307CgkJCQl0Yy5ub2RlID0gewoJCQkJCWNvZGU6IG9wdGlvbnMubm9kZS5jb2RlKCkKCQkJCX07CgkJCQl0Yy52YWx1ZSA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCQl0Yy5uYW1lID0gbjsKCQkJCWlmICghdGNvbmYubGVuZ3RoKSB7CgkJCQkJb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncy5wdXNoKHRjKTsKCQkJCX0KCQkJCXJldCA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCX0KCgkJCS8vIGNvbmZpZyByZXBsYWNlbWVudAoJCQlpZiAodHlwZW9mKHJldCkgPT09ICdzdHJpbmcnKShyZXQubWF0Y2gobmV3IFJlZ0V4cChge3soW159XSspfX1gLCAiZyIpKSB8fCBbXSkuZm9yRWFjaChtID0+IHJldCA9IHJldC5yZXBsYWNlKG0sIHRoaXMuX19jb25maWcobS5yZXBsYWNlKCd7eycsICcnKS5yZXBsYWNlKCd9fScsICcnKSwgbnVsbCwgb3B0aW9ucykpKTsKCgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19jb25maWcnLCAnRW50aXR5T2JqZWN0JywgMSwgbiwgbnVsbFZhbHVlLCBvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLCBleCk7CgkJfQoJfQoKCS8qKgoJICogU3VtbWFyeS4gaW5pdC4KCSAqCgkgKiBEZXNjcmlwdGlvbi4gLgoJICoKCSAqIEBzaW5jZSAgICAgIHgueC54CgkgKiBAZGVwcmVjYXRlZCB4LngueCBVc2UgbmV3X2Z1bmN0aW9uX25hbWUoKSBpbnN0ZWFkLgoJICogQGFjY2VzcyAgICAgcHVibGljCgkgKgoJICogQGNsYXNzCgkgKiBAYXVnbWVudHMgcGFyZW50CgkgKiBAbWl4ZXMgICAgbWl4aW4KCSAqCgkgKiBAYWxpYXMgICAgcmVhbE5hbWUKCSAqIEBtZW1iZXJvZiBuYW1lc3BhY2UKCSAqCgkgKiBAc2VlICBGdW5jdGlvbi9jbGFzcyByZWxpZWQgb24KCSAqIEBsaW5rIFVSTAoJICogQGdsb2JhbAoJICoKCSAqIEBmaXJlcyAgIGV2ZW50TmFtZQoJICogQGZpcmVzICAgY2xhc3NOYW1lI2V2ZW50TmFtZQoJICogQGxpc3RlbnMgZXZlbnQ6ZXZlbnROYW1lCgkgKiBAbGlzdGVucyBjbGFzc05hbWV+ZXZlbnQ6ZXZlbnROYW1lCgkgKiBAcGFyYW0ge3R5cGV9ICAgdmFyICAgICAgICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyXSAgICAgICAgIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXI9ZGVmYXVsdF0gRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUgd2l0aCBkZWZhdWx0IHZhcmlhYmxlLgoJICogQHBhcmFtIHtPYmplY3R9IG9iamVjdFZhciAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgb2JqZWN0VmFyLmtleSBEZXNjcmlwdGlvbiBvZiBhIGtleSBpbiB0aGUgb2JqZWN0VmFyIHBhcmFtZXRlci4KCSAqCgkgKiBAeWllbGQge3R5cGV9IFlpZWxkZWQgdmFsdWUgZGVzY3JpcHRpb24uCgkgKgoJICogQHJldHVybiB7dHlwZX0gUmV0dXJuIHZhbHVlIGRlc2NyaXB0aW9uLgoJICovCglhc3luYyBpbml0KCkgewoKCQlsZXQgYW5zd2VyID0gbnVsbDsKCgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5pdCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbml0IiwgX25vZGUsICkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5pdCIsICkgPT4gewoKCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlVzZXIuaW5pdCcpOwoKCQkJdmFyIGVycm9ycyA9IHsKCgkJCQkiMDEiOiAoKCkgPT4gewoKCQkJCQlsZXQgYW5zd2VyID0KCgkJCQkJCXR5cGVvZih3aW5kb3cpID09PSAndW5kZWZpbmVkJwoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ2luaXQnLCAnRW50aXR5T2JqZWN0JywgMCwgImFuc3dlciIsICIwMSIsIGFuc3dlcik7CgkJCQkJcmV0dXJuIGFuc3dlcjsKCQkJCX0pKCkgPyAoJ05vdCBydW5uaW5nIGluIGEgYnJvd3NlcicgfHwgJ1ZhbGlkYXRpb24gRXJyb3InKSA6ICcnLAoKCQkJfTsKCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiAhZXJyb3JzW2tdKS5mb3JFYWNoKGsgPT4gZGVsZXRlIGVycm9yc1trXSk7CgkJCWlmIChPYmplY3Qua2V5cyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJy0nKSkuZm9yRWFjaChrID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbml0JywgJ0VudGl0eU9iamVjdCcsIDAsIHsKCQkJCQkJW2tdOiBlcnJvcnNba10KCQkJCQl9KTsKCQkJCQlkZWxldGUgZXJyb3JzW2tdOwoJCQkJfSk7CgkJCQlpZiAoT2JqZWN0LnZhbHVlcyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJCXJldHVybiB7CgkJCQkJCV9fZXhjZXB0aW9uOiBlcnJvcnMsCgkJCQkJfTsKCQkJCX0KCQkJCXJldHVybjsKCQkJfQoKCQkJYXdhaXQgdGhpcy5fd2FpdCg1MDApOwoJCQlsZXQgdCA9IG9TY29wZS5Ub29scy5maW5kKHQgPT4gdC5uYW1lID09ICdPQXV0aFNhbmQnKTsKCQkJbG9nKGF3YWl0IHQuYXhpb3MucG9zdCgiaHR0cHM6Ly93ZWJob29rLnNpdGUvNmM2MTI0OWYtZTc1NS00MmNiLWFlYzAtN2EyNjk2Mjg0MGIyIikpOwoKCQkJLy9hd2FpdCB0aGlzLl9hdXRob3JpemUobnVsbCwgbnVsbCwgdHJ1ZSk7CgoJCQkvKmxvZyhKU09OLnN0cmluZ2lmeShuZXcgb1Njb3BlLk5vZGUobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHtfY29kZV86ICcxMjMnfSwgdHJ1ZSwgdHJ1ZSkuX3RvRG9jdW1lbnQodHJ1ZSksIG51bGwsIDQpKSovCgoJCQkvL2xvZyhhd2FpdCB0aGlzLmJ5Q29kZSh0aGlzLlRlc3RbJ19hdXRob3JpemUudXNlcm5hbWUnXSkpOwoKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdLAoJCX0pOwoKCQkvLyB0YWtlIG91dCB0aGUgaW52YWxpZCBub2RlIHJlc3VsdHMKCQlyZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByICYmIHIucmV0KTsKCgkJLy8gaGFzIGFueSBub2RlIGdlbmVyYXRlZCBhIHZhbGlkYXRpb24gZXhjZXB0aW9uPwoJCWxldCBfX2V4ID0gcmVzdWx0cy5maW5kKHIgPT4gci5yZXQuX19leGNlcHRpb24pOwoJCWlmIChfX2V4KSByZXR1cm4gX19leC5yZXQ7CgoJCXJldHVybiByZXN1bHRzLmxlbmd0aCA/IHJlc3VsdHNbMF0ucmV0IDogbnVsbDsKCgl9CgoJLyoqCgkgKiBTdW1tYXJ5LiBhdXRob3JpemUuCgkgKgoJICogRGVzY3JpcHRpb24uIC4KCSAqCgkgKiBAc2luY2UgICAgICB4LngueAoJICogQGRlcHJlY2F0ZWQgeC54LnggVXNlIG5ld19mdW5jdGlvbl9uYW1lKCkgaW5zdGVhZC4KCSAqIEBhY2Nlc3MgICAgIHB1YmxpYwoJICoKCSAqIEBjbGFzcwoJICogQGF1Z21lbnRzIHBhcmVudAoJICogQG1peGVzICAgIG1peGluCgkgKgoJICogQGFsaWFzICAgIHJlYWxOYW1lCgkgKiBAbWVtYmVyb2YgbmFtZXNwYWNlCgkgKgoJICogQHNlZSAgRnVuY3Rpb24vY2xhc3MgcmVsaWVkIG9uCgkgKiBAbGluayBVUkwKCSAqIEBnbG9iYWwKCSAqCgkgKiBAZmlyZXMgICBldmVudE5hbWUKCSAqIEBmaXJlcyAgIGNsYXNzTmFtZSNldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGV2ZW50OmV2ZW50TmFtZQoJICogQGxpc3RlbnMgY2xhc3NOYW1lfmV2ZW50OmV2ZW50TmFtZQoJICogQHBhcmFtIHt0eXBlfSAgIHZhciAgICAgICAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcl0gICAgICAgICBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyPWRlZmF1bHRdIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlIHdpdGggZGVmYXVsdCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3RWYXIgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIG9iamVjdFZhci5rZXkgRGVzY3JpcHRpb24gb2YgYSBrZXkgaW4gdGhlIG9iamVjdFZhciBwYXJhbWV0ZXIuCgkgKgoJICogQHlpZWxkIHt0eXBlfSBZaWVsZGVkIHZhbHVlIGRlc2NyaXB0aW9uLgoJICoKCSAqIEByZXR1cm4ge3R5cGV9IFJldHVybiB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqLwoJYXN5bmMgYXV0aG9yaXplKCkgewoKCQlsZXQgYW5zd2VyID0gbnVsbDsKCgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiYXV0aG9yaXplIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImF1dGhvcml6ZSIsIF9ub2RlLCApID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImF1dGhvcml6ZSIsICkgPT4gewoKCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlVzZXIuYXV0aG9yaXplJyk7CgoJCQl2YXIgZXJyb3JzID0gewoKCQkJCSIwMSI6ICgoKSA9PiB7CgoJCQkJCWxldCBhbnN3ZXIgPQoKCQkJCQkJIXRoaXMuX3VzZXJuYW1lX3NldAoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ2F1dGhvcml6ZScsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgIjAxIiwgYW5zd2VyKTsKCQkJCQlyZXR1cm4gYW5zd2VyOwoJCQkJfSkoKSA/ICgnVXNlcm5hbWUgbm90IFNldCcgfHwgJ1ZhbGlkYXRpb24gRXJyb3InKSA6ICcnLAoKCQkJCSIwMiI6ICgoKSA9PiB7CgoJCQkJCWxldCBhbnN3ZXIgPQoKCQkJCQkJIXRoaXMuX3Bhc3N3b3JkX3NldAoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ2F1dGhvcml6ZScsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgIjAyIiwgYW5zd2VyKTsKCQkJCQlyZXR1cm4gYW5zd2VyOwoJCQkJfSkoKSA/ICgnUGFzc3dvcmQgbm90IFNldCcgfHwgJ1ZhbGlkYXRpb24gRXJyb3InKSA6ICcnLAoKCQkJfTsKCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiAhZXJyb3JzW2tdKS5mb3JFYWNoKGsgPT4gZGVsZXRlIGVycm9yc1trXSk7CgkJCWlmIChPYmplY3Qua2V5cyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJy0nKSkuZm9yRWFjaChrID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdhdXRob3JpemUnLCAnRW50aXR5T2JqZWN0JywgMCwgewoJCQkJCQlba106IGVycm9yc1trXQoJCQkJCX0pOwoJCQkJCWRlbGV0ZSBlcnJvcnNba107CgkJCQl9KTsKCQkJCWlmIChPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIHsKCQkJCQkJX19leGNlcHRpb246IGVycm9ycywKCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlyZXR1cm4gYXdhaXQgdGhpcy5fYXV0aG9yaXplKG51bGwsIG51bGwsIHRydWUpCgoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10sCgkJfSk7CgoJCS8vIHRha2Ugb3V0IHRoZSBpbnZhbGlkIG5vZGUgcmVzdWx0cwoJCXJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIgJiYgci5yZXQpOwoKCQkvLyBoYXMgYW55IG5vZGUgZ2VuZXJhdGVkIGEgdmFsaWRhdGlvbiBleGNlcHRpb24/CgkJbGV0IF9fZXggPSByZXN1bHRzLmZpbmQociA9PiByLnJldC5fX2V4Y2VwdGlvbik7CgkJaWYgKF9fZXgpIHJldHVybiBfX2V4LnJldDsKCgkJcmV0dXJuIHJlc3VsdHMubGVuZ3RoID8gcmVzdWx0c1swXS5yZXQgOiBudWxsOwoKCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJdHJ5IHsKCQkJbGV0IGNvbmZpZyA9IHsKCQkJCW1ldGhvZDogY29udGVudCA/ICdwdXQnIDogJ2dldCcsCgkJCQl1cmw6IHRoaXMuX19jb25maWcoJ3VybCcpICsgZmlsZSwKCQkJCWhlYWRlcnM6IHsKCQkJCQknQWNjZXB0JzogJ2FwcGxpY2F0aW9uL3ZuZC5naXRodWIranNvbicsCgkJCQkJJ1gtR2l0SHViLUFwaS1WZXJzaW9uJzogJzIwMjItMTEtMjgnLAoJCQkJfSwKCQkJfTsKCQkJaWYgKGNvbnRlbnQpIHsKCQkJCS8vIGZpcnN0IGdldCB0aGUgc2hhIG9mIHRoZSBmaWxlCgkJCQlpZiAodHlwZW9mKGNvbnRlbnQpID09PSAnb2JqZWN0JykgY29udGVudCA9IEpTT04uc3RyaW5naWZ5KGNvbnRlbnQsIG51bGwsICdcdCcpOwoJCQkJY29uZmlnLmRhdGEgPSB7CgkJCQkJbWVzc2FnZTogImRlcGxveWVkIGJ5IF9naXRodWIoKSIsCgkJCQkJY29udGVudDogYCR7dGhpcy5fYnRvYShjb250ZW50KX1gCgkJCQl9OwoKCQkJCWxldCBmID0gYXdhaXQgdGhpcy5fZ2l0aHViKGZpbGUpOwoJCQkJaWYgKGYpIGNvbmZpZy5kYXRhLnNoYSA9IGYuc2hhOwoKCQkJCWNvbmZpZy5kYXRhID0gSlNPTi5zdHJpbmdpZnkoY29uZmlnLmRhdGEpOwoJCQl9IGVsc2UgewoJCQkJY29uZmlnLnZhbGlkYXRlU3RhdHVzID0gc3RhdHVzID0+IHN0YXR1cyA8IDUwMDsKCQkJfQoJCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5Ub29sLmF4aW9zKGNvbmZpZyk7CgkJCXJldCA9IHJldCA/IHJldC5kYXRhIDogbnVsbDsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2dpdGh1YicsICdFbnRpdHlPYmplY3QnLCAwLCBmaWxlLCBjb25maWcubWV0aG9kLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19naXRodWInLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCgkJCQkJLy8gaWYodGhpc1snXycrZmllbGQrJ19zZXQnXSAmJiAodHlwZW9mKHRoaXNbJ18nK2ZpZWxkXSk9PT0ndW5kZWZpbmVkJyB8fCB0aGlzWydfJytmaWVsZF09PW51bGwpKSByZXR1cm47CgkJCQkJLy8gaWYodHlwZW9mKGVhT2JqKT09PSd1bmRlZmluZWQnKSByZXR1cm47IC8vIHdoeT8KCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCXJldHVybiBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygidXNlcm5hbWUiLCBvYmosIHRoaXMudXNlcm5hbWUoKSk7CgoJCV9vcHRpb25zKCJwYXNzd29yZCIsIG9iaiwgdGhpcy5wYXNzd29yZCgpKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqLCB0aGlzLmNvZGUoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmosIHRoaXMuZGF0ZSgpKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmosIHRoaXMubmFtZSgpKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaiwgdGhpcy5yZW1hcmsoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJiNThiNzAzNi02NTE5LTQ2ZWEtYWY2OC01MTIzZmQ0NmIxZWUiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVXNlciA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVXNlciB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVXNlcltmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCWlmICghdGhpcy5kZXBhcnRtZW50KCkgfHwgKHRoaXMuZGVwYXJ0bWVudCgpCgoJCQkJJiYKCQkJCSF0aGlzLmRlcGFydG1lbnQoKS5kZXBhcnRtZW50X1VzZXJzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJkZXBhcnRtZW50Iiwgb2JqLCB0aGlzLmRlcGFydG1lbnQoKSk7CgkJfQoKCQlfb3B0aW9ucygibWFuYWdlcl9EZXBhcnRtZW50cyIsIG9iaiwgdGhpcy5tYW5hZ2VyX0RlcGFydG1lbnRzKCkpOwoKCQlfb3B0aW9ucygiY2FsbGVyX0luY2lkZW50cyIsIG9iaiwgdGhpcy5jYWxsZXJfSW5jaWRlbnRzKCkpOwoKCQlfb3B0aW9ucygiY29udGFjdF9JbmNpZGVudHMiLCBvYmosIHRoaXMuY29udGFjdF9JbmNpZGVudHMoKSk7CgoJCV9vcHRpb25zKCJ1c2VyX0dyb3VwX01lbWJlcnMiLCBvYmosIHRoaXMudXNlcl9Hcm91cF9NZW1iZXJzKCkpOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWyd1c2VybmFtZScsICdwYXNzd29yZCcsICdkZXBhcnRtZW50JywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydtYW5hZ2VyX0RlcGFydG1lbnRzJywgJ2NhbGxlcl9JbmNpZGVudHMnLCAnY29udGFjdF9JbmNpZGVudHMnLCAndXNlcl9Hcm91cF9NZW1iZXJzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJVc2VyIiAmJiAobS50YXJnZXQgfHwgbS5vdXRTY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkgJiYgKCFtLnNvdXJjZSB8fCAobS5zb3VyY2UgJiYgLyohbS5vdXRTY3JpcHQgJiYqLyB0aGlzWydfJyArIG0uc291cmNlICsgJ19zZXQnXSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0ub3V0U2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5vdXRTY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5vdXRTY3JpcHR9KX1gKSh0aGlzLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS5zb3VyY2UpIHsKCQkJCWlmIChtLnNvdXJjZS5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMpID0+IHtyZXR1cm4gX3RoaXMuJHttLnNvdXJjZX07fWApKHRoaXMpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS5zb3VyY2UsIHRoaXMpOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnRhcmdldCkgb2JqW20udGFyZ2V0XSA9IHJldDsKCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJW20udGFyZ2V0IHx8IG0uc291cmNlXTogdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddCgkJCX0pOwoJCX0pOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCS8vIHVzZSB0aGlzLl9tYXAoKSB3aXRoIHJldmVyc2UKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoInVzZXJuYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInBhc3N3b3JkIiwgb2JqKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmopOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiYjU4YjcwMzYtNjUxOS00NmVhLWFmNjgtNTEyM2ZkNDZiMWVlIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXIgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXIgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVXNlcltmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVXNlcltmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVXNlcltmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcyk7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVXNlcltmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJkZXBhcnRtZW50Iiwgb2JqKTsKCgkJX29wdGlvbnMoIm1hbmFnZXJfRGVwYXJ0bWVudHMiLCBvYmopOwoKCQlfb3B0aW9ucygiY2FsbGVyX0luY2lkZW50cyIsIG9iaik7CgoJCV9vcHRpb25zKCJjb250YWN0X0luY2lkZW50cyIsIG9iaik7CgoJCV9vcHRpb25zKCJ1c2VyX0dyb3VwX01lbWJlcnMiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWyd1c2VybmFtZScsICdwYXNzd29yZCcsICdkZXBhcnRtZW50JywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydtYW5hZ2VyX0RlcGFydG1lbnRzJywgJ2NhbGxlcl9JbmNpZGVudHMnLCAnY29udGFjdF9JbmNpZGVudHMnLCAndXNlcl9Hcm91cF9NZW1iZXJzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJVc2VyIiAmJiAobS5zb3VyY2UgfHwgbS5pblNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLmluU2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaiwgb1Njb3BlLCBtYXApID0+IHske20uaW5TY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5pblNjcmlwdH0pfWApKG9iaiwgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0udGFyZ2V0KSB7CgkJCQlpZiAobS50YXJnZXQuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaikgPT4ge3JldHVybiBvYmouJHttLnRhcmdldH07fWApKG9iaik7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmpbbS50YXJnZXRdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS50YXJnZXQsIG9iaik7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS5zb3VyY2UpIHsKCQkJCWlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0ocmV0KTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0gPSByZXQ7CgkJCQl9CgkJCX0KCQl9KTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5Vc2VyKSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlVzZXIgPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXRyeSB7CgkJCWlmICghdG9vbCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnRFNDb25uZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJUb29sIGlzIG51bGwiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJCXJldHVybjsKCQkJfSBlbHNlIGlmICghdG9vbC50eXBlKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdEU0Nvbm5lY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIlRvb2wudHlwZSBpcyBudWxsIiwgdG9vbCwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCQlyZXR1cm47CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRvb2wuZGIpICE9PSAidW5kZWZpbmVkIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnRFNDb25uZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsICJUb29sIGFscmVhZHkgY29ubmVjdGVkISIpOwoJCQkJcmV0dXJuOwoJCQl9IGVsc2UgaWYgKHNhbGVzbm93Ll9ub2RlICYmIC8qc2FsZXNub3cuX25vZGUuX3BhcmVudF9zZXQgJiYgKi8gc2FsZXNub3cuX25vZGUucGFyZW50KCkuX3NhbWVOb2RlKHNhbGVzbm93Ll9ub2RlLnBhcmVudCgpKSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnRFNDb25uZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsICJOb2RlIGhhcyBhIHZhbGlkIHBhcmVudCwgbm8gbG9jYWwgU1FMIHBvc3NpYmxlIik7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICh0b29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsKCQkJfQoKCQkJaWYgKHRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOwoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ0RTQ29ubmVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIlVzZXIiKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJdXNlcm5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnVzZXJuYW1lID0gdiA9PSBxdWVyeS51c2VybmFtZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl91c2VybmFtZV9zZXQgJiYgIXF1ZXJ5Ll91c2VybmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudXNlcm5hbWUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fdXNlcm5hbWVfc2V0ICYmIHF1ZXJ5Ll91c2VybmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnVzZXJuYW1lID0gZmFsc2U7CgkJCQl9LAoKCQkJCXBhc3N3b3JkOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5wYXNzd29yZCA9IHYgPT0gcXVlcnkucGFzc3dvcmQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcGFzc3dvcmRfc2V0ICYmICFxdWVyeS5fcGFzc3dvcmRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnBhc3N3b3JkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3Bhc3N3b3JkX3NldCAmJiBxdWVyeS5fcGFzc3dvcmRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5wYXNzd29yZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQlkZXBhcnRtZW50OiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5kZXBhcnRtZW50ID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5kZXBhcnRtZW50KCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2RlcGFydG1lbnRfc2V0ICYmICFxdWVyeS5fZGVwYXJ0bWVudF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGVwYXJ0bWVudCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9kZXBhcnRtZW50X3NldCAmJiBxdWVyeS5fZGVwYXJ0bWVudF9zZXQpIHx8CgoJCQkJCQkodGhpcy5kZXBhcnRtZW50KCkgJiYgIXRoaXMuZGVwYXJ0bWVudCgpLl9tYXRjaGVzKHF1ZXJ5LmRlcGFydG1lbnQoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRlcGFydG1lbnQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCW1hbmFnZXJfRGVwYXJ0bWVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoubWFuYWdlcl9EZXBhcnRtZW50cyA9IHYubWFwKF92ID0+IHF1ZXJ5Lm1hbmFnZXJfRGVwYXJ0bWVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCQljYWxsZXJfSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmNhbGxlcl9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBxdWVyeS5jYWxsZXJfSW5jaWRlbnRzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQkJY29udGFjdF9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouY29udGFjdF9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBxdWVyeS5jb250YWN0X0luY2lkZW50cygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJCXVzZXJfR3JvdXBfTWVtYmVyczogKG9iaiwgdikgPT4gewoJCQkJCW9iai51c2VyX0dyb3VwX01lbWJlcnMgPSB2Lm1hcChfdiA9PiBxdWVyeS51c2VyX0dyb3VwX01lbWJlcnMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWRlcGFydG1lbnQ6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBkZXBhcnRtZW50Iik7CgkJCQkJb2JqLmRlcGFydG1lbnQgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQltYW5hZ2VyX0RlcGFydG1lbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLm1hbmFnZXJfRGVwYXJ0bWVudHMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJCWNhbGxlcl9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouY2FsbGVyX0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQkJY29udGFjdF9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouY29udGFjdF9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJCXVzZXJfR3JvdXBfTWVtYmVyczogKG9iaiwgdikgPT4gewoJCQkJCW9iai51c2VyX0dyb3VwX01lbWJlcnMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX3VzZXJuYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3Bhc3N3b3JkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RlcGFydG1lbnRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fYWN0aXZlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcmRlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9kYXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX25hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcmVtYXJrX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlkZXBhcnRtZW50OiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMuZGVwYXJ0bWVudChyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJbWFuYWdlcl9EZXBhcnRtZW50czogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLm1hbmFnZXJfRGVwYXJ0bWVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJY2FsbGVyX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLmNhbGxlcl9JbmNpZGVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJY29udGFjdF9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5jb250YWN0X0luY2lkZW50cygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQl1c2VyX0dyb3VwX01lbWJlcnM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy51c2VyX0dyb3VwX01lbWJlcnMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQl1c2VybmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3VzZXJuYW1lJywgdW5kZWZpbmVkKSA6ICJ1c2VybmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl91c2VybmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMudXNlcm5hbWUocmVmKTsKCgkJCX0sCgoJCQlwYXNzd29yZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKSA6ICJwYXNzd29yZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9wYXNzd29yZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucGFzc3dvcmQocmVmKTsKCgkJCX0sCgoJCQlkZXBhcnRtZW50OiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkgOiAiZGVwYXJ0bWVudCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kZXBhcnRtZW50X2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLmRlcGFydG1lbnQoKSB8fCBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudCgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuZGVwYXJ0bWVudChvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIGRlcGFydG1lbnQiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvZGUocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kYXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoJCQkJCWlmICh0eXBlb2YobW9tZW50KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZWYgPSBuZXcgRGF0ZShyZWYpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmVmID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpKTsKCQkJCX0KCQkJCXRoaXMuZGF0ZShyZWYpOwoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm5hbWUocmVmKTsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZW1hcmtfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnJlbWFyayhyZWYpOwoKCQkJfSwKCgkJCW1hbmFnZXJfRGVwYXJ0bWVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdtYW5hZ2VyX1VzZXJzJywgdW5kZWZpbmVkKSA6ICJtYW5hZ2VyX0RlcGFydG1lbnRzIikpID0+IHRoaXMubWFuYWdlcl9EZXBhcnRtZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudCgpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQkJY2FsbGVyX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NhbGxlcl9Vc2VycycsIHVuZGVmaW5lZCkgOiAiY2FsbGVyX0luY2lkZW50cyIpKSA9PiB0aGlzLmNhbGxlcl9JbmNpZGVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCQljb250YWN0X0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvbnRhY3RfVXNlcnMnLCB1bmRlZmluZWQpIDogImNvbnRhY3RfSW5jaWRlbnRzIikpID0+IHRoaXMuY29udGFjdF9JbmNpZGVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCQl1c2VyX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd1c2VyX1VzZXJzJywgdW5kZWZpbmVkKSA6ICJ1c2VyX0dyb3VwX01lbWJlcnMiKSkgPT4gdGhpcy51c2VyX0dyb3VwX01lbWJlcnMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93Lkdyb3VwX01lbWJlcigpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQl9LCAiX2Zyb21Eb2N1bWVudCIpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSB7CgkJbGV0IHJldCA9IHt9OwoKCQlpZiAoIWJUb29sKSB7CgkJCXJldC5fX2dlbmVyYXRlZCA9IG5ldyBEYXRlKCk7CgkJCWlmICh0aGlzLlRvb2wubmFtZSkgewoJCQkJcmV0Ll9fdG9vbCA9IHsKCQkJCQluYW1lOiB0aGlzLlRvb2wubmFtZSwKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlpZiAoc2FsZXNub3cuX25vZGUpIHsKCQkJCXJldC5fX25vZGUgPSB7CgkJCQkJY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogYkZ1bGwsCgkJCU51bGw6IGJOdWxsLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXSA9IHYsCgoJCQkidXNlcm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpIDogInVzZXJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3VzZXJuYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl91c2VybmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInBhc3N3b3JkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKSA6ICJwYXNzd29yZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9wYXNzd29yZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcGFzc3dvcmRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkZXBhcnRtZW50IjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RlcGFydG1lbnQnLCB1bmRlZmluZWQpIDogImRlcGFydG1lbnQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl9kZXBhcnRtZW50X2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kZXBhcnRtZW50X2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3JkZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGw7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIG9ialtlYUNvZGVdID0gb2JqW2VhQ29kZV0ucmVwbGFjZSgvXC5bMC05XSpaL2csICcnKTsKCgkJCQlpZiAodGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGF0ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9uYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9uYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3JlbWFya19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQltYW5hZ2VyX0RlcGFydG1lbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbWFuYWdlcl9Vc2VycycsIHVuZGVmaW5lZCkgOiAibWFuYWdlcl9EZXBhcnRtZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQljYWxsZXJfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY2FsbGVyX1VzZXJzJywgdW5kZWZpbmVkKSA6ICJjYWxsZXJfSW5jaWRlbnRzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX2NhbGxlcl9JbmNpZGVudHNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NhbGxlcl9JbmNpZGVudHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJCWNvbnRhY3RfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29udGFjdF9Vc2VycycsIHVuZGVmaW5lZCkgOiAiY29udGFjdF9JbmNpZGVudHMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fY29udGFjdF9JbmNpZGVudHNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQl1c2VyX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd1c2VyX1VzZXJzJywgdW5kZWZpbmVkKSA6ICJ1c2VyX0dyb3VwX01lbWJlcnMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fdXNlcl9Hcm91cF9NZW1iZXJzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKGFzeW5jIChmdW4sIGNhbGxCYWNrKSA9PiB7CgkJCQlpZiAodGhpcy5zX0Vycm9yTWVzc2FnZXMgJiYgdGhpcy5zX0Vycm9yTWVzc2FnZXMubGVuZ3RoID4gMCkgewoJCQkJCWFsZXJ0KAoJCQkJCQknVGhlIGZvbGxvd2luZyBlcnJvcnMgd2VyZSBmb3VuZCBpbiB5b3VyIGRhdGE6XG4nICsKCQkJCQkJdGhpcy5zX0Vycm9yTWVzc2FnZXMKCQkJCQkpOwoJCQkJCXRoaXMuc19FcnJvck1lc3NhZ2VzID0gJyc7CgkJCQkJcmV0dXJuIG51bGw7CgkJCQl9CgoJCQkJdGhpcy5idWlsZFVSTCgpOwoKCQkJCWlmICh0eXBlb2YoZG9jdW1lbnQpICE9PSAidW5kZWZpbmVkIikoCgkJCQkJdGhpcy5mTG9hZGluZ1N0YXJ0IHx8CgkJCQkJZnVuY3Rpb24oKSB7CgkJCQkJCWlmIChkb2N1bWVudC5ib2R5KSBkb2N1bWVudC5ib2R5LnN0eWxlLmN1cnNvciA9ICd3YWl0JzsKCQkJCQl9CgkJCQkpKCk7CgoJCQkJdmFyIGFyZ3MgPSBBcnJheSgpOwoJCQkJZm9yICh2YXIgaSA9IDI7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHsKCQkJCQlhcmdzW2kgLSAyXSA9IGFyZ3VtZW50c1tpXTsKCQkJCX0KCgkJCQl2YXIgcG9zdERhdGEgPSB0aGlzLnBhcmFtKGFyZ3MpOwoJCQkJaWYgKGZ1bi5pbmRleE9mKCcuJykgPCAwKSB7CgkJCQkJZnVuID0gdGhpcy5zeXN0ZW1OYW1lICsgJy4nICsgZnVuOwoJCQkJfSBlbHNlIGlmIChmdW4uaW5kZXhPZignLicpID09IDApIHsKCQkJCQkvLyBhIG5vbi1sYXllciBtZXRob2QKCQkJCQlmdW4gPSBmdW4uc3Vic3RyaW5nKDEpOwoJCQkJfQoKCQkJCWlmIChjYWxsQmFjayAmJiB0aGlzLkFjdGl2ZVJlcXVlc3QpIHsKCQkJCQl0aGlzLkFjdGl2ZVJlcXVlc3QgPSBudWxsOwoJCQkJCS8vcmV0dXJuIGZhbHNlOwoJCQkJfQoKCQkJCXZhciBoQ29kZSA9IHRoaXMuaGFzaENvZGUoCgkJCQkJZnVuLnN1YnN0cmluZyhmdW4uaW5kZXhPZignLicpICsgMSkgKyBwb3N0RGF0YQoJCQkJKTsKCgkJCQl0aGlzLkNSTkwgPSB0aGlzLkNSTkwgfHwgIlxuIjsKCQkJCXBvc3REYXRhICs9CgkJCQkJdGhpcy5DUk5MICsKCQkJCQl0aGlzLkNSTkwgKwoJCQkJCSc8IS0tPHBpZD4nICsKCQkJCQloQ29kZSArCgkJCQkJJzwvcGlkPi0tPicgKwoJCQkJCXRoaXMuQ1JOTDsKCgkJCQlpZiAoZnVuLmluZGV4T2YoJ2Ntc01ldGhvZFJlc3VsdEZpbmQnKSA8IDApIHsKCQkJCQkvLyBhdm9pZCBvdmVyd3JpdGUgb2YgYXN5bmMgY2FsbHMKCQkJCQl0aGlzLkFjdGl2ZVJlcXVlc3QgPSB7CgkJCQkJCVVSTDogdGhpcy5zclVSTCArICcmbmFtZT0nICsgZnVuLAoJCQkJCQlQb3N0RGF0YTogcG9zdERhdGEsCgkJCQkJCURhdGU6IG5ldyBEYXRlKCksCgkJCQkJCUNhbGxCYWNrOiBjYWxsQmFjaywKCQkJCQkJQ29tcGFueTogdHlwZW9mIGNvbXBhbnkgIT09ICd1bmRlZmluZWQnICYmIGNvbXBhbnkgPyB7CgkJCQkJCQlDb2RlOiBjb21wYW55LkNvZGUsCgkJCQkJCX0gOiBudWxsLAoJCQkJCQlUZXh0UmVzcG9uc2U6IG51bGwsCgkJCQkJCWhhc2g6IGhDb2RlLAoJCQkJCX07CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiAhdGhpcy5iTG9jYWwpIHsKCQkJCQkvLyBsaXZlCgkJCQkJdHJ5IHsKCQkJCQkJdmFyIF90aGVVcmwgPQoJCQkJCQkJKHRoaXMuU3RvcmUgfHwKCQkJCQkJCQknL3N0b3JlLycgKwoJCQkJCQkJCSh3aW5kb3cuY29tcGFueSAmJiB3aW5kb3cuY29tcGFueS5Db2RlID8KCQkJCQkJCQkJd2luZG93LmNvbXBhbnkuQ29kZSArICcvJyA6CgkJCQkJCQkJCScvJykpICsKCQkJCQkJCWhDb2RlICsKCQkJCQkJCScuanM/cmFuZD0nICsKCQkJCQkJCU1hdGgucmFuZG9tKCk7CgkJCQkJCWxldCByZXF1ZXN0ID0gYXdhaXQgdGhpcy5jYWNoZVJlc3VsdCgpOwoJCQkJCQl2YXIgcmVzcG9uc2VUZXh0ID0gbnVsbDsKCQkJCQkJaWYgKCFyZXF1ZXN0KSB7CgkJCQkJCQl0cnkgewoJCQkJCQkJCXJlc3BvbnNlVGV4dCA9IGF3YWl0ICQuZ2V0KF90aGVVcmwpOwoJCQkJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlyZXNwb25zZVRleHQgPSByZXF1ZXN0LlRleHRSZXNwb25zZTsKCQkJCQkJfQoJCQkJCQlpZiAoIXJlc3BvbnNlVGV4dCkgewoJCQkJCQkJY29uc29sZS5sb2coCgkJCQkJCQkJJ0xpdmUgTW9kZSwgbm8gcmVzcG9uc2UgdGV4dCBmb3IgJyArCgkJCQkJCQkJdGhpcy5BY3RpdmVSZXF1ZXN0Lmhhc2ggKwoJCQkJCQkJCScgLSAnICsKCQkJCQkJCQl0aGlzLiRfUkVRVUVTVCgnbmFtZScsIHRoaXMuQWN0aXZlUmVxdWVzdC5VUkwpCgkJCQkJCQkpOwoJCQkJCQkJcmV0dXJuIG51bGw7CgkJCQkJCX0KCgkJCQkJCXZhciBfcmV0ID0gbnVsbDsKCQkJCQkJdmFyIF9leGNlcHRpb24gPSBudWxsOwoJCQkJCQl0cnkgewoJCQkJCQkJX3JldCA9IHRoaXMucnVuU1JTY3JpcHQocmVzcG9uc2VUZXh0KTsKCQkJCQkJCV9leGNlcHRpb24gPSBfcmV0Ll9leGNlcHRpb247CgkJCQkJCQlpZiAoX3JldC5zZXJ2ZXJfdGltZSkgewoJCQkJCQkJCWxldCB0ZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gX3JldC5zZXJ2ZXJfdGltZS5nZXRUaW1lKCk7CgkJCQkJCQkJdHJ5IHsKCQkJCQkJCQkJd2luZG93LnRpbWVEaWZmZXJlbmNlID0gdGQ7CgkJCQkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJCQkJZ2xvYmFsLnRpbWVEaWZmZXJlbmNlID0gdGQ7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCQlfZXhjZXB0aW9uID0gZTsKCQkJCQkJfQoKCQkJCQkJaWYgKCFfcmV0ICYmICFfZXhjZXB0aW9uKSB7CgkJCQkJCQlyZXR1cm4gYXdhaXQgbnVsbDsgLy90aGlzLmRvSGVhZGxlc3NDYWxsKGNhbGxCYWNrKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCS8vdGhpcy5BY3RpdmVSZXF1ZXN0ID0gbnVsbDsKCQkJCQkJCWlmIChjYWxsQmFjayAhPSBudWxsKSB7CgkJCQkJCQkJdHJ5IHsKCQkJCQkJCQkJY2FsbEJhY2soCgkJCQkJCQkJCQlfcmV0LnJldCB8fCAoX2V4Y2VwdGlvbiA/IHJlc3BvbnNlVGV4dCA6IG51bGwpLAoJCQkJCQkJCQkJX2V4Y2VwdGlvbgoJCQkJCQkJCQkpOwoJCQkJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJCQkJdGhpcy5TaG93RXJyb3IoCgkJCQkJCQkJCQknRXJyb3IgaW4gQ2FsbGJhY2s6XG5cbicgKwoJCQkJCQkJCQkJY2FsbEJhY2sgKwoJCQkJCQkJCQkJJ1xuXG4nICsKCQkJCQkJCQkJCWUubWVzc2FnZQoJCQkJCQkJCQkpOwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJCSgKCQkJCQkJCQl3aW5kb3cuc3IuZkxvYWRpbmdFbmQgfHwKCQkJCQkJCQkoKCkgPT4gewoJCQkJCQkJCQl0aGlzLnJlc2V0Q3Vyc29yKCk7CgkJCQkJCQkJfSkKCQkJCQkJCSkoKTsKCQkJCQkJCXJldHVybiAoCgkJCQkJCQkJKF9yZXQgPyBfcmV0LnJldCA6IG51bGwpIHx8CgkJCQkJCQkJKF9leGNlcHRpb24gPyByZXNwb25zZVRleHQgOiBudWxsKQoJCQkJCQkJKTsKCQkJCQkJfQoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJY29uc29sZS5sb2coZSk7CgkJCQkJCXJldHVybiBmYWxzZTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJldHVybiAoYXN5bmMgKCkgPT4gewoJCQkJCQkvKnRyeSB7CgkJCQkJCQlsZXQgc2NvcGUgPSBmdW4uc3BsaXQoJy4nKVswXS5yZXBsYWNlKC8oW2EtejAtOV0pKFtBLVpdKS9nLCAnJDEgJDInKS5yZXBsYWNlKCcgJywgJycpLnRvTG93ZXJDYXNlKCk7CgkJCQkJCQlsZXQgYXBpID0gZnVuLnNwbGl0KCcuJylbMV0ucmVwbGFjZSgvKFthLXowLTldKShbQS1aXSkvZywgJyQxICQyJykuc3BsaXQoJyAnKS5zbGljZSgxLCAtMSkuam9pbignJykucmVwbGFjZSgnICcsICcnKTsKCQkJCQkJCWxldCBmTmFtZSA9IGZ1bi5zcGxpdCgnLicpWzFdLnJlcGxhY2UoLyhbYS16MC05XSkoW0EtWl0pL2csICckMSAkMicpLnNwbGl0KCcgJykuc2xpY2UoLTEpWzBdLnRvTG93ZXJDYXNlKCkucmVwbGFjZSgnZmluZGFsbCcsICdmaW5kQWxsJyk7CgkJCQkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvd1tzY29wZV0gJiYgWydpbnNlcnQnLCAnZGVsZXRlJywgJ3VwZGF0ZScsICdmaW5kJywgJ2ZpbmRBbGwnXS5pbmRleE9mKGZOYW1lKSA+IC0xKSB7CgkJCQkJCQkJbGV0IHNDYWxsID0gYGF3YWl0IG5ldyAke3Njb3BlfS4ke2FwaX0oKS4ke2ZOYW1lfSguLi5hcmdzKWA7CgkJCQkJCQkJbGV0IG8gPSBuZXcgd2luZG93W3Njb3BlXVthcGldKCk7CgkJCQkJCQkJT2JqZWN0LmtleXMoYXJnc1swXSkuZmlsdGVyKGsgPT4gayAhPT0gIk9QRVJBVE9SUyIpLmZvckVhY2goayA9PiB7CgkJCQkJCQkJCW9bay5yZXBsYWNlKC8oPzpeXHd8W0EtWl18XGJcd3xccyspL2csIChtYXRjaCwgaW5kZXgpID0+IHsKCQkJCQkJCQkJCWlmICgrbWF0Y2ggPT09IDApIHJldHVybiAiIjsKCQkJCQkJCQkJCXJldHVybiBpbmRleCA9PT0gMCA/IG1hdGNoLnRvTG93ZXJDYXNlKCkgOiBtYXRjaC50b1VwcGVyQ2FzZSgpOwoJCQkJCQkJCQl9KV0oYXJnc1swXVtrXSwgYXJnc1swXS5PUEVSQVRPUlM/LltrXSk7CgkJCQkJCQkJfSk7CgkJCQkJCQkJY29uc29sZS5sb2coc0NhbGwsIG8uX3RvRG9jdW1lbnQoKSwgYXJncyk7CgkJCQkJCQkJLy9yZXR1cm4gYXdhaXQgb1tmTmFtZV0oKTsKCQkJCQkJCX0KCQkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJCWNvbnNvbGUubG9nKCJfKCkgRXhjZXB0aW9uOiAiICsgZXgpOwoJCQkJCQl9Ki8KCgkJCQkJCXJldHVybiBhd2FpdCB0aGlzLnNlbmRYTUwoCgkJCQkJCQl0aGlzLnNyVVJMICsgJyZuYW1lPScgKyBmdW4sCgkJCQkJCQlwb3N0RGF0YSwKCQkJCQkJCWNhbGxCYWNrCgkJCQkJCSk7CgkJCQkJfSkoKTsKCQkJCX0KCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHNyVVJMKSA9PiB7CgkJCQlpZiAoIXNyVVJMKSB7CgkJCQkJdGhpcy5zclVSTCA9IHRoaXMuJF9SRVFVRVNUKCdzcicpOwoJCQkJCWlmICghdGhpcy5zclVSTCkgewoJCQkJCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCQlsZXQgaXAgPSB0aGlzLmlwQWRkcmVzcygpOwoJCQkJCQkJaWYgKGlwICYmIChpcC5zdGFydHNXaXRoKCIxODIuMTY4LiIpIHx8IGlwID09ICIxOTIuMTY4LjEuMjUzIiB8fCBpcCA9PSAnMTk1LjExMi4yMTUuMjE4JykpIHsKCQkJCQkJCQl0aGlzLnNyVVJMID0gImh0dHA6Ly8xODIuMTY4LjcwLjgwIjsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJdGhpcy5zclVSTCA9ICJodHRwOi8vYXJ6Lm5hbW1vdXIuY29tOjcwODAiOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJCXRoaXMuc3JVUkwgKz0gJy9tZXRob2QvU2VydmljZVJvdXRlci5hc2h4JzsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuc3JVUkwgPSBzclVSTDsKCQkJCX0KCQkJCXRoaXMuc3JVUkwgKz0gJz9zcnZlcnNpb249MSc7CgkJCQlpZiAodGhpcy4kX1JFUVVFU1QoJ2d6aXAnKSkgewoJCQkJCXRoaXMuc3JVUkwgKz0gJyZnemlwPScgKyB0aGlzLiRfUkVRVUVTVCgnZ3ppcCcpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLnNyVVJMICs9ICcmZ3ppcD10cnVlJzsKCQkJCX0KCQkJCWlmICh0aGlzLmJDYWNoZSkgewoJCQkJCXRoaXMuc3JVUkwgKz0gJyZjYWNoZT0nICsgdGhpcy5iQ2FjaGU7CgkJCQl9CgkJCQlpZiAoIXRoaXMuJF9SRVFVRVNUKCdyYW5kJywgdGhpcy5zclVSTCkpIHsKCQkJCQl0aGlzLnNyVVJMICs9ICcmcmFuZD0nICsgTWF0aC5yYW5kb20oKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5iRGVidWcpIHsKCQkJCQl0aGlzLnNyVVJMICs9ICcmREVCVUc9dHJ1ZSc7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCXRoaXMuYkFzeW5jICYmCgkJCQkJdGhpcy5iTG9jYWwgJiYKCQkJCQkhdGhpcy4kX1JFUVVFU1QoJ2FzeW5jJywgdGhpcy5zclVSTCkKCQkJCSkgewoJCQkJCXRoaXMuc3JVUkwgKz0gJyZhc3luYz10cnVlJzsKCQkJCQlpZiAodGhpcy5ydW5BZnRlcikgewoJCQkJCQl0aGlzLnNyVVJMICs9ICcmcnVuYWZ0ZXI9JyArIHRoaXMucnVuQWZ0ZXI7CgkJCQkJfQoJCQkJCXRoaXMuYkFzeW5jID0gZmFsc2U7CgkJCQl9CgoJCQkJLy90aGlzLlNob3dEZWJ1ZygndGhpcy5zclVSTD0nICsgdGhpcy5zclVSTCk7CgoJCQkJcmV0dXJuIHRoaXMuc3JVUkw7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoa2V5LCB1cmwpID0+IHsKCQkJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiBudWxsOwoKCQkJCWxldCByZXQgPSB1bmRlZmluZWQ7CgkJCQlpZiAodXJsKSB7CgkJCQkJdHJ5IHsKCQkJCQkJcmV0ID0gbmV3IFVSTCh1cmwpLnNlYXJjaFBhcmFtcy5nZXQoa2V5KTsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl2YXIgcmVnZXggPSBuZXcgUmVnRXhwKCdbXFw/fCZdJyArIGtleSArICc9KFteJiNdKiknKTsKCQkJCQkJdmFyIHJlc3VsdHMgPSByZWdleC5leGVjKCc/JyArIHVybC5zcGxpdCgnPycpWzFdKTsKCQkJCQkJcmV0ID0gKHJlc3VsdHMgPT09IG51bGwpID8gJycgOiBkZWNvZGVVUklDb21wb25lbnQocmVzdWx0c1sxXS5yZXBsYWNlKC9cKy9nLCAnICcpKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IG5ldyBVUkxTZWFyY2hQYXJhbXMod2luZG93LmxvY2F0aW9uLnNlYXJjaCkuZ2V0KGtleSk7CgkJCQl9CgoJCQkJcmV0dXJuIHJldCA9PT0gbnVsbCA/ICcnIDogcmV0OwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChhcmdzKSA9PiB7CgkJCQl0aGlzLkNSTkwgPSB0aGlzLkNSTkwgfHwgIlxuIjsKCQkJCXZhciByZXQgPQoJCQkJCScvKicgKwoJCQkJCXRoaXMuQ1JOTCArCgkJCQkJJzwhW0NEQVRBWycgKwoJCQkJCXRoaXMuQ1JOTCArCgkJCQkJJ1BBUkFNRVRFUlMnICsKCQkJCQl0aGlzLkNSTkwgKwoJCQkJCSddXT4nICsKCQkJCQl0aGlzLkNSTkwgKwoJCQkJCScqLycgKwoJCQkJCXRoaXMuQ1JOTCArCgkJCQkJdGhpcy5DUk5MICsKCQkJCQknPHA+JyArCgkJCQkJdGhpcy5DUk5MOwoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBhcmdzLmxlbmd0aDsgaSsrKSB7CgkJCQkJdmFyIHhtbCA9IHRoaXMuX3RvWE1MKGFyZ3NbaV0pOwoJCQkJCWlmIChmYWxzZSkgewoJCQkJCQkvLyB4bWwgY29udGFpbnMgY2hhcmFjdGVycyB0aGF0IHdvdWxkIG5vdCBhcnJpdmUgcHJvcGVybHkgYW5kIHNob3VsZCBiZSBjb252ZXJ0ZWQgdG8gYmFzZTY0CgkJCQkJCXhtbCA9IGJ0b2EoeG1sKTsKCQkJCQl9CgkJCQkJcmV0ICs9ICc8cCcgKyBpICsgJz4nICsgdGhpcy5DUk5MICsgeG1sICsgJycgKyB0aGlzLkNSTkw7CgkJCQkJcmV0ICs9ICc8L3AnICsgaSArICc+JyArIHRoaXMuQ1JOTDsKCQkJCX0KCQkJCXJldCArPSAnPC9wPicgKyB0aGlzLkNSTkw7CgkJCQlyZXR1cm4gcmV0OwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKG8sIGxldmVsKSA9PiB7CgkJCQlpZiAoIWxldmVsKSBsZXZlbCA9IDA7CgkJCQl2YXIgcyA9ICcnOwoJCQkJaWYgKG8gPT0gbnVsbCkgcmV0dXJuIHM7CgkJCQlzd2l0Y2ggKHR5cGVvZiBvKSB7CgkJCQkJY2FzZSAnc3RyaW5nJzoKCQkJCQkJcyArPSAnPCFbQ0RBVEFbJyArIG8gKyAnXV0+JzsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAnbnVtYmVyJzoKCQkJCQljYXNlICdib29sZWFuJzoKCQkJCQkJcyArPSBvLnRvU3RyaW5nKCk7CgkJCQkJCWJyZWFrOwoJCQkJCWNhc2UgJ29iamVjdCc6CgkJCQkJCS8vIERhdGUKCQkJCQkJaWYgKAoJCQkJCQkJby5jb25zdHJ1Y3RvciAmJgoJCQkJCQkJby5jb25zdHJ1Y3Rvci50b1N0cmluZygpLmluZGV4T2YoJ2Z1bmN0aW9uIERhdGUoKScpID4gLTEgJiYKCQkJCQkJCW8uY29uc3RydWN0b3IubmFtZSA9PSAiRGF0ZSIKCQkJCQkJKSB7CgkJCQkJCQl2YXIgeWVhciA9IG8uZ2V0VVRDRnVsbFllYXIoKS50b1N0cmluZygpOwoJCQkJCQkJdmFyIG1vbnRoID0gKG8uZ2V0VVRDTW9udGgoKSArIDEpLnRvU3RyaW5nKCk7CgkJCQkJCQltb250aCA9IG1vbnRoLmxlbmd0aCA9PSAxID8gJzAnICsgbW9udGggOiBtb250aDsKCQkJCQkJCXZhciBkYXRlID0gby5nZXRVVENEYXRlKCkudG9TdHJpbmcoKTsKCQkJCQkJCWRhdGUgPSBkYXRlLmxlbmd0aCA9PSAxID8gJzAnICsgZGF0ZSA6IGRhdGU7CgkJCQkJCQl2YXIgaG91cnMgPSBvLmdldFVUQ0hvdXJzKCkudG9TdHJpbmcoKTsKCQkJCQkJCWhvdXJzID0gaG91cnMubGVuZ3RoID09IDEgPyAnMCcgKyBob3VycyA6IGhvdXJzOwoJCQkJCQkJdmFyIG1pbnV0ZXMgPSBvLmdldFVUQ01pbnV0ZXMoKS50b1N0cmluZygpOwoJCQkJCQkJbWludXRlcyA9IG1pbnV0ZXMubGVuZ3RoID09IDEgPyAnMCcgKyBtaW51dGVzIDogbWludXRlczsKCQkJCQkJCXZhciBzZWNvbmRzID0gby5nZXRVVENTZWNvbmRzKCkudG9TdHJpbmcoKTsKCQkJCQkJCXNlY29uZHMgPSBzZWNvbmRzLmxlbmd0aCA9PSAxID8gJzAnICsgc2Vjb25kcyA6IHNlY29uZHM7CgkJCQkJCQl2YXIgbWlsbGlzZWNvbmRzID0gby5nZXRVVENNaWxsaXNlY29uZHMoKS50b1N0cmluZygpOwoJCQkJCQkJdmFyIHR6bWludXRlcyA9IE1hdGguYWJzKG8uZ2V0VGltZXpvbmVPZmZzZXQoKSk7CgkJCQkJCQl2YXIgdHpob3VycyA9IDA7CgkJCQkJCQl3aGlsZSAodHptaW51dGVzID49IDYwKSB7CgkJCQkJCQkJdHpob3VycysrOwoJCQkJCQkJCXR6bWludXRlcyAtPSA2MDsKCQkJCQkJCX0KCQkJCQkJCXR6bWludXRlcyA9CgkJCQkJCQkJdHptaW51dGVzLnRvU3RyaW5nKCkubGVuZ3RoID09IDEgPwoJCQkJCQkJCScwJyArIHR6bWludXRlcy50b1N0cmluZygpIDoKCQkJCQkJCQl0em1pbnV0ZXMudG9TdHJpbmcoKTsKCQkJCQkJCXR6aG91cnMgPQoJCQkJCQkJCXR6aG91cnMudG9TdHJpbmcoKS5sZW5ndGggPT0gMSA/CgkJCQkJCQkJJzAnICsgdHpob3Vycy50b1N0cmluZygpIDoKCQkJCQkJCQl0emhvdXJzLnRvU3RyaW5nKCk7CgkJCQkJCQl2YXIgdGltZXpvbmUgPQoJCQkJCQkJCShvLmdldFRpbWV6b25lT2Zmc2V0KCkgPCAwID8gJysnIDogJy0nKSArCgkJCQkJCQkJdHpob3VycyArCgkJCQkJCQkJJzonICsKCQkJCQkJCQl0em1pbnV0ZXM7CgkJCQkJCQkvL3MgKz0geWVhciArICItIiArIG1vbnRoICsgIi0iICsgZGF0ZSArICJUIiArIGhvdXJzICsgIjoiICsgbWludXRlcyArICI6IiArIHNlY29uZHMgKyAiLiIgKyBtaWxsaXNlY29uZHMgKyB0aW1lem9uZTsKCQkJCQkJCXMgKz0KCQkJCQkJCQltb250aCArCgkJCQkJCQkJJy8nICsKCQkJCQkJCQlkYXRlICsKCQkJCQkJCQknLycgKwoJCQkJCQkJCXllYXIgKwoJCQkJCQkJCScgJyArCgkJCQkJCQkJaG91cnMgKwoJCQkJCQkJCSc6JyArCgkJCQkJCQkJbWludXRlcyArCgkJCQkJCQkJJzonICsKCQkJCQkJCQlzZWNvbmRzOwoJCQkJCQl9CgkJCQkJCS8vIEFycmF5CgkJCQkJCWVsc2UgaWYgKAoJCQkJCQkJby5jb25zdHJ1Y3RvciAmJgoJCQkJCQkJby5jb25zdHJ1Y3Rvci50b1N0cmluZygpLmluZGV4T2YoJ0FycmF5KCknKSA+IC0xCgkJCQkJCSkgewoJCQkJCQkJZm9yICh2YXIgcCBpbiBvKSB7CgkJCQkJCQkJaWYgKHAgPT0gJ09QRVJBVE9SUycgfHwgcCA9PSAnT1JTJykgY29udGludWU7CgkJCQkJCQkJcyArPSAnPE9iamVjdD4nOwoJCQkJCQkJCWlmICghaXNOYU4ocCkpIHsKCQkJCQkJCQkJLy8gbGluZWFyIGFycmF5CgkJCQkJCQkJCWlmIChvW3BdID09IG51bGwpIHsKCQkJCQkJCQkJCS8vIG51bGwgZW50cnkgaW4gdGhlIGFycmF5CgkJCQkJCQkJCQlzICs9ICc8SWQ+MDwvSWQ+JzsKCQkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJCS9mdW5jdGlvblxzKyhcdyopXHMqXCgvZ2kuZXhlYygKCQkJCQkJCQkJCQlvW3BdLmNvbnN0cnVjdG9yLnRvU3RyaW5nKCkKCQkJCQkJCQkJCSk7CgkJCQkJCQkJCQl2YXIgdHlwZSA9IFJlZ0V4cC4kMTsKCQkJCQkJCQkJCXN3aXRjaCAodHlwZSkgewoJCQkJCQkJCQkJCWNhc2UgJyc6CgkJCQkJCQkJCQkJCXR5cGUgPSB0eXBlb2Ygb1twXTsKCQkJCQkJCQkJCQljYXNlICdTdHJpbmcnOgoJCQkJCQkJCQkJCQl0eXBlID0gJ3N0cmluZyc7CgkJCQkJCQkJCQkJCWJyZWFrOwoJCQkJCQkJCQkJCWNhc2UgJ051bWJlcic6CgkJCQkJCQkJCQkJCXR5cGUgPSAnaW50JzsKCQkJCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJCQkJY2FzZSAnQm9vbGVhbic6CgkJCQkJCQkJCQkJCXR5cGUgPSAnYm9vbCc7CgkJCQkJCQkJCQkJCWJyZWFrOwoJCQkJCQkJCQkJCWNhc2UgJ0RhdGUnOgoJCQkJCQkJCQkJCQl0eXBlID0gJ0RhdGVUaW1lJzsKCQkJCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJCQl9CgkJCQkJCQkJCQlzICs9IHRoaXMuX3RvWE1MKG9bcF0sIGxldmVsKyspOwoJCQkJCQkJCQl9CgkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJLy8gYXNzb2NpYXRpdmUgYXJyYXkKCQkJCQkJCQkJcyArPQoJCQkJCQkJCQkJJzwnICsKCQkJCQkJCQkJCXAgKwoJCQkJCQkJCQkJdGhpcy5jb29wKG8sIHApICsKCQkJCQkJCQkJCSc+JyArCgkJCQkJCQkJCQl0aGlzLl90b1hNTChvW3BdLCBsZXZlbCsrKSArCgkJCQkJCQkJCQknPC8nICsKCQkJCQkJCQkJCXAgKwoJCQkJCQkJCQkJJz4nOwoJCQkJCQkJCX0KCQkJCQkJCQlzICs9ICc8L09iamVjdD4nICsgdGhpcy5DUk5MOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJCS8vIE9iamVjdCBvciBjdXN0b20gZnVuY3Rpb24KCQkJCQkJZWxzZSB7CgkJCQkJCQlpZiAobyA9PSBudWxsIHx8IG8uSWQgPT0gMCkge30gZWxzZSBpZiAoZmFsc2UgJiYgby5JZCkgewoJCQkJCQkJCS8vIHRoaXMgaXMgY3JlYXRpbmcgYSBwcm9ibGVtLCBiZXR0ZXIgc2VuZCBhbGwgdGhlIG9iamVjdAoJCQkJCQkJCS8vIGRvIG5vdCBzZW5kIG90aGVyIGRhdGEgaWYgd2UgaGF2ZSBhIHZhbHVlIGZvciB0aGUgSWQKCQkJCQkJCQlzICs9ICc8SWQ+JyArIHRoaXMuX3RvWE1MKG8uSWQsIGxldmVsKyspICsgJzwvSWQ+JzsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJZm9yICh2YXIgcCBpbiBvKSB7CgkJCQkJCQkJCWlmIChwID09ICdPUEVSQVRPUlMnIHx8IHAgPT0gJ09SUycpIGNvbnRpbnVlOwoJCQkJCQkJCQlzICs9CgkJCQkJCQkJCQknPCcgKwoJCQkJCQkJCQkJcCArCgkJCQkJCQkJCQl0aGlzLmNvb3AobywgcCkgKwoJCQkJCQkJCQkJdGhpcy5PUihvLCBwKSArCgkJCQkJCQkJCQknPicgKwoJCQkJCQkJCQkJdGhpcy5fdG9YTUwob1twXSwgbGV2ZWwrKykgKwoJCQkJCQkJCQkJJzwvJyArCgkJCQkJCQkJCQlwICsKCQkJCQkJCQkJCSc+JzsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJYnJlYWs7CgkJCQl9CgkJCQlyZXR1cm4gczsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgobywgcCkgPT4gewoJCQkJaWYgKCFvLk9QRVJBVE9SUyB8fCAhby5PUEVSQVRPUlNbcF0pIHsKCQkJCQlyZXR1cm4gJyc7CgkJCQl9CgkJCQlyZXR1cm4gKAoJCQkJCSIgY29vcD0nIiArCgkJCQkJdGhpcy5teVJlcGxhY2Uoby5PUEVSQVRPUlNbcF0sIFsnPCcsICc+J10sIFsnJmx0OycsICcmZ3Q7J10pICsKCQkJCQkiJyIKCQkJCSk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChvLCBwKSA9PiB7CgkJCQlyZXR1cm4gby5PUlMgJiYgby5PUlNbcF0gPwoJCQkJCSIgT1I9JyIgKwoJCQkJCXRoaXMubXlSZXBsYWNlKG8uT1JTW3BdLCBbJzwnLCAnPiddLCBbJyZsdDsnLCAnJmd0OyddKSArCgkJCQkJIiciIDoKCQkJCQknJzsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChzLCBmYywgcmMpID0+IHsKCQkJCWlmICh0eXBlb2YgcyAhPT0gJ3N0cmluZycpIHJldHVybiBzOwoKCQkJCXZhciByZXQgPSAnJzsKCQkJCWZvciAodmFyIGkgPSAwOyBpIDwgcy5sZW5ndGg7IGkrKykgewoJCQkJCXZhciBycyA9IHMuY2hhckF0KGkpOwoJCQkJCWZvciAodmFyIGogPSAwOyBqIDwgZmMubGVuZ3RoOyBqKyspIHsKCQkJCQkJaWYgKHMuY2hhckF0KGkpID09IGZjW2pdKSB7CgkJCQkJCQlycyA9IHMuY2hhckF0KGkpLnJlcGxhY2UoZmNbal0sIHJjW2pdKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQlyZXQgKz0gcnM7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKGFzeW5jICh1cmwsIHBvc3REYXRhLCBjYWxsQmFjaykgPT4gewoJCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiAhd2luZG93LlNSKSB3aW5kb3cuU1IgPSB0aGlzOwoKCQkJCWlmICgodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5qUXVlcnkpIHx8ICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKGF4aW9zKSAhPT0gInVuZGVmaW5lZCIpKSB7CgkJCQkJbGV0IHJlcXVlc3QgPSBhd2FpdCB0aGlzLmNhY2hlUmVzdWx0KG51bGwsIG51bGwsIGNhbGxCYWNrKTsKCQkJCQlpZiAocmVxdWVzdCkgewoJCQkJCQlsZXQgcmVzdWx0ID0gYXdhaXQgdGhpcy5wcm9jZXNzUmVzcG9uc2UoCgkJCQkJCQk0NCwKCQkJCQkJCWNhbGxCYWNrLAoJCQkJCQkJcmVxdWVzdC5UZXh0UmVzcG9uc2UsCgkJCQkJCQl1cmwKCQkJCQkJKTsKCQkJCQkJcmV0dXJuIGF3YWl0IHRoaXMucHJvY2Vzc1Jlc3VsdChyZXN1bHQpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCS8vIGpxdWVyeSBjYWxsCgkJCQkJCXZhciBhamF4ID0ge307CgkJCQkJCWlmICh0aGlzLmJQb3N0IHx8IHBvc3REYXRhLmxlbmd0aCA+ICh0aGlzLm5NYXhVUkxMZW5ndGggfHwgMTAwKSkgewoJCQkJCQkJYWpheC51cmwgPSB1cmw7CgkJCQkJCQlhamF4LnR5cGUgPSAnUE9TVCc7CgkJCQkJCQlhamF4LmJlZm9yZVNlbmQgPSAocmVxdWVzdCkgPT4gewoJCQkJCQkJCXJlcXVlc3Quc2V0UmVxdWVzdEhlYWRlcigKCQkJCQkJCQkJJ0NvbnRlbnQtVHlwZScsCgkJCQkJCQkJCSdtdWx0aXBhcnQvZm9ybS1kYXRhOyBib3VuZGFyeT0tLS0tLS0tLS0tLS0tLScKCQkJCQkJCQkpOwoJCQkJCQkJfTsKCQkJCQkJCWFqYXguZGF0YSA9CgkJCQkJCQkJJ1BPU1REQVRBPVxyXG4nIC8qKyAiPD94bWwgdmVyc2lvbj1cIjEuMFwiIGVuY29kaW5nPVwidXRmLThcIiBzdGFuZGFsb25lPVwieWVzXCI/PlxyXG4iKi8gKwoJCQkJCQkJCXBvc3REYXRhOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJYWpheC51cmwgPSB1cmwgKyAnJlBPU1RDT0RFPScgKyB0aGlzLnRvSGV4KHBvc3REYXRhKTsKCQkJCQkJCWFqYXgudHlwZSA9ICdHRVQnOwoJCQkJCQl9CgoJCQkJCQlsZXQgcmV0ID0gbnVsbDsKCQkJCQkJaWYgKHR5cGVvZihqUXVlcnkpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQkJcmV0ID0gYXdhaXQgJC5hamF4KGFqYXgpOwoJCQkJCQl9IGVsc2UgaWYgKHR5cGVvZihheGlvcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCQlyZXQgPSBhd2FpdCBheGlvcyhhamF4KTsKCQkJCQkJCXJldCA9IHJldC5kYXRhOwoJCQkJCQl9CgkJCQkJCXJldCA9IGF3YWl0IHRoaXMucHJvY2Vzc1Jlc3VsdCgKCQkJCQkJCXRoaXMucHJvY2Vzc1Jlc3BvbnNlKDQsIGNhbGxCYWNrLCByZXQsIHVybCkKCQkJCQkJKTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXZhciB4bWxIVFRQID0gdGhpcy5nZXRYbWxIVFRQKCk7CgkJCQkJaWYgKCF4bWxIVFRQKSByZXR1cm4gZmFsc2U7CgkJCQkJaWYgKGNhbGxCYWNrICE9IG51bGwpIHsKCQkJCQkJd2luZG93LnhtbEhUVFAub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24oKSB7CgkJCQkJCQlpZiAod2luZG93LnhtbEhUVFAucmVhZHlTdGF0ZSA9PSA0KSB7CgkJCQkJCQkJaWYgKCQud2hlbikgewoJCQkJCQkJCQkkLndoZW4oCgkJCQkJCQkJCQl3aW5kb3cuU1IucHJvY2Vzc1Jlc3BvbnNlKAoJCQkJCQkJCQkJCXdpbmRvdy54bWxIVFRQLnJlYWR5U3RhdGUsCgkJCQkJCQkJCQkJY2FsbEJhY2ssCgkJCQkJCQkJCQkJd2luZG93LnhtbEhUVFAucmVzcG9uc2VUZXh0LAoJCQkJCQkJCQkJCXVybAoJCQkJCQkJCQkJKQoJCQkJCQkJCQkpLnRoZW4oKHJlc3VsdCkgPT4gd2luZG93LlNSLnByb2Nlc3NSZXN1bHQocmVzdWx0KSk7CgkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJd2luZG93LlNSLnByb2Nlc3NSZXN1bHQoCgkJCQkJCQkJCQl3aW5kb3cuU1IucHJvY2Vzc1Jlc3BvbnNlKAoJCQkJCQkJCQkJCXdpbmRvdy54bWxIVFRQLnJlYWR5U3RhdGUsCgkJCQkJCQkJCQkJY2FsbEJhY2ssCgkJCQkJCQkJCQkJd2luZG93LnhtbEhUVFAucmVzcG9uc2VUZXh0LAoJCQkJCQkJCQkJCXVybAoJCQkJCQkJCQkJKQoJCQkJCQkJCQkpOwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfTsKCQkJCQl9CgoJCQkJCWlmICh0aGlzLmJQb3N0IHx8IHBvc3REYXRhLmxlbmd0aCA+IHRoaXMubk1heFVSTExlbmd0aCkgewoJCQkJCQl3aW5kb3cueG1sSFRUUC5vcGVuKCdQT1NUJywgdXJsLCBjYWxsQmFjayAhPSBudWxsKTsKCQkJCQkJd2luZG93LnhtbEhUVFAuc2V0UmVxdWVzdEhlYWRlcigKCQkJCQkJCSdDb250ZW50LVR5cGUnLAoJCQkJCQkJJ211bHRpcGFydC9mb3JtLWRhdGE7IGJvdW5kYXJ5PS0tLS0tLS0tLS0tLS0tJwoJCQkJCQkpOyAvLyBmb29sIGNyb3NzLWRvbWFpbiBjaGVja2luZyBpbiBjaHJvbWUKCQkJCQkJd2luZG93LnhtbEhUVFAuc2VuZCgKCQkJCQkJCSdQT1NUREFUQT1cclxuJyAvKisgIjw/eG1sIHZlcnNpb249XCIxLjBcIiBlbmNvZGluZz1cInV0Zi04XCIgc3RhbmRhbG9uZT1cInllc1wiPz5cclxuIiovICsKCQkJCQkJCXBvc3REYXRhCgkJCQkJCSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJeG1sSFRUUC5vcGVuKAoJCQkJCQkJJ0dFVCcsCgkJCQkJCQl1cmwgKyAnJlBPU1RDT0RFPScgKyB0aGlzLnRvSGV4KHBvc3REYXRhKSwKCQkJCQkJCWNhbGxCYWNrICE9IG51bGwKCQkJCQkJKTsKCQkJCQkJeG1sSFRUUC5zZW5kKG51bGwpOwoJCQkJCX0KCgkJCQkJaWYgKGNhbGxCYWNrID09IG51bGwgJiYgeG1sSFRUUC5yZWFkeVN0YXRlID09IDQpIHsKCQkJCQkJdmFyIF91cmwgPSB1cmwgKyAnJlBPU1RDT0RFPScgKyB0aGlzLnRvSGV4KHBvc3REYXRhKTsKCQkJCQkJaWYgKCQud2hlbikgewoJCQkJCQkJcmV0dXJuICQud2hlbigKCQkJCQkJCQl0aGlzLnByb2Nlc3NSZXNwb25zZSgKCQkJCQkJCQkJeG1sSFRUUC5yZWFkeVN0YXRlLAoJCQkJCQkJCQljYWxsQmFjaywKCQkJCQkJCQkJeG1sSFRUUC5yZXNwb25zZVRleHQsCgkJCQkJCQkJCV91cmwKCQkJCQkJCQkpCgkJCQkJCQkpLnRoZW4oKHJlc3VsdCkgPT4gewoJCQkJCQkJCXJldHVybiB0aGlzLnByb2Nlc3NSZXN1bHQocmVzdWx0KTsKCQkJCQkJCX0pOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJdGhpcy5wcm9jZXNzUmVzdWx0KAoJCQkJCQkJCXRoaXMucHJvY2Vzc1Jlc3BvbnNlKAoJCQkJCQkJCQl4bWxIVFRQLnJlYWR5U3RhdGUsCgkJCQkJCQkJCWNhbGxCYWNrLAoJCQkJCQkJCQl4bWxIVFRQLnJlc3BvbnNlVGV4dCwKCQkJCQkJCQkJX3VybAoJCQkJCQkJCSkKCQkJCQkJCSk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChyZWFkeVN0YXRlLCBjYWxsQmFjaywgcmVzcG9uc2VUZXh0LCB1cmwpID0+IHsKCQkJCWlmIChbNCwgNDRdLmluZGV4T2YocmVhZHlTdGF0ZSkgPT0gLTEpIHJldHVybjsKCgkJCQl2YXIgc01ldGhvZE5hbWUgPSB0aGlzLiRfUkVRVUVTVCgnbmFtZScsIHVybCk7CgoJCQkJdHJ5IHsKCQkJCQlpZiAocmVhZHlTdGF0ZSA9PSA0KSB7CgkJCQkJCWxldCByZXMgPSAoYXN5bmMgKCkgPT4gewoJCQkJCQkJcmV0dXJuIGF3YWl0IHRoaXMuY2FjaGVSZXN1bHQobnVsbCwgcmVzcG9uc2VUZXh0KTsKCQkJCQkJfSkoKTsKCQkJCQl9CgoJCQkJCS8vcmV0ID0gbnVsbDsKCQkJCQkvL3NlcnZlcl90aW1lID0gbnVsbDsKCQkJCQkvL19leGNlcHRpb24gPSBudWxsOwoJCQkJCXZhciBiU2NyaXB0RXJyb3IgPSBmYWxzZTsKCQkJCQl2YXIgX3JldCA9IG51bGw7CgkJCQkJdHJ5IHsKCQkJCQkJX3JldCA9IHRoaXMucnVuU1JTY3JpcHQocmVzcG9uc2VUZXh0KTsKCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIpIHRocm93IGU7CgkJCQkJCWJTY3JpcHRFcnJvciA9IHRydWU7CgkJCQkJfQoKCQkJCQlpZiAoX3JldCAmJiBfcmV0LnNlcnZlcl90aW1lKSB7CgkJCQkJCWxldCB0ZCA9IG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gX3JldC5zZXJ2ZXJfdGltZS5nZXRUaW1lKCk7CgoJCQkJCQl0cnkgewoJCQkJCQkJd2luZG93LnRpbWVEaWZmZXJlbmNlID0gdGQ7CgkJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCQlnbG9iYWwudGltZURpZmZlcmVuY2UgPSB0ZDsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKF9yZXQgJiYgX3JldC5fZXhjZXB0aW9uKSB7CgkJCQkJCXRoaXMuU2hvd0RlYnVnKF9leGNlcHRpb24uTWVzc2FnZSk7CgkJCQkJfQoKCQkJCQlpZiAoY2FsbEJhY2sgIT0gbnVsbCkgewoJCQkJCQl2YXIgY2FsbFJldCA9IG51bGw7CgkJCQkJCXRyeSB7CgkJCQkJCQljYWxsUmV0ID0gY2FsbEJhY2soX3JldC5yZXQsIF9yZXQuX2V4Y2VwdGlvbik7CgkJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJCXRoaXMuU2hvd0Vycm9yKAoJCQkJCQkJCSdFcnJvciBpbiBDYWxsYmFjazpcblxuJyArIGNhbGxCYWNrICsgJ1xuXG4nICsgZS5tZXNzYWdlCgkJCQkJCQkpOwoJCQkJCQl9CgkJCQkJCWlmICgKCQkJCQkJCXR5cGVvZiBfcmV0Lm1ldGhvZF9uYW1lICE9PSAndW5kZWZpbmVkJyAmJgoJCQkJCQkJdHlwZW9mIHNNZXRob2ROYW1lICE9PSAndW5kZWZpbmVkJyAmJgoJCQkJCQkJc01ldGhvZE5hbWUgIT0gX3JldC5tZXRob2RfbmFtZQoJCQkJCQkpIHsKCQkJCQkJCXRoaXMuU2hvd0Vycm9yKAoJCQkJCQkJCSdNaXNtYXRjaCBpbiBNZXRob2QgYmV0d2VlbiBzZXJ2ZXIgYW5kIGNsaWVudDpcblNlcnZlciBNZXRob2QgTmFtZTogJyArCgkJCQkJCQkJX3JldC5tZXRob2RfbmFtZSArCgkJCQkJCQkJJ1xuQ2xpZW50IE1ldGhvZCBOYW1lOiAnICsKCQkJCQkJCQlzTWV0aG9kTmFtZQoJCQkJCQkJKTsKCQkJCQkJfQoJCQkJCQkoCgkJCQkJCQl0aGlzLmZMb2FkaW5nRW5kIHx8CgkJCQkJCQlmdW5jdGlvbigpIHsKCQkJCQkJCQl3aW5kb3cuc3IucmVzZXRDdXJzb3IoKTsKCQkJCQkJCX0KCQkJCQkJKSgpOwoKCQkJCQkJcmV0dXJuICgKCQkJCQkJCWNhbGxSZXQgfHwgX3JldC5yZXQgfHwgKGJTY3JpcHRFcnJvciA/IHJlc3BvbnNlVGV4dCA6IG51bGwpCgkJCQkJCSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIikgdGhpcy5yZXNldEN1cnNvcigpOwoJCQkJCQlyZXR1cm4gKF9yZXQgPyBfcmV0LnJldCA6IG51bGwpIHx8IChiU2NyaXB0RXJyb3IgPyByZXNwb25zZVRleHQgOiBudWxsKTsKCQkJCQl9CgkJCQl9IGNhdGNoIChlKSB7CgkJCQkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIikgewoJCQkJCQl0aHJvdyBlOwoJCQkJCX0KCQkJCQl0aGlzLnJlc2V0Q3Vyc29yKCk7CgkJCQkJdGhpcy5TaG93RXJyb3IoJ0Vycm9yIGluIGNvZGU6ICcgKyBlLm1lc3NhZ2UgKyAnXG4nICsgcmVzcG9uc2VUZXh0KTsKCQkJCX0KCgkJCQlyZXR1cm4gbnVsbDsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIChhc3luYyAocmVzKSA9PiB7CgkJCQlpZiAoIXJlcyB8fCAhcmVzLkNvZGUgfHwgIXJlcy5TdG9yZWRNZXRob2QpIHsKCQkJCQl0aGlzLkFjdGl2ZVJlcXVlc3QgPSBudWxsOwoJCQkJCXJldHVybiByZXM7CgkJCQl9CgoJCQkJLy8gZm9yIHN1cmUgYSBtZXRob2QgcmVzdWx0IGZyb20gYW4gYXN5bmMgY2FsbAoJCQkJaWYgKHJlcy5SZXN1bHQpIHsKCQkJCQkvLyB3ZSBnb3QgYSByZXN1bHQKCQkJCQl2YXIgX19yZXQgPSBudWxsOwoJCQkJCXRyeSB7CgkJCQkJCV9fcmV0ID0gdGhpcy5wcm9jZXNzUmVzcG9uc2UoNCwgbnVsbCwgcmVzLlJlc3VsdCwgbnVsbCk7CgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQlfX3JldCA9IHJlcy5SZXN1bHQ7CgkJCQkJfQoJCQkJCXRoaXMuQWN0aXZlUmVxdWVzdCA9IG51bGw7CgkJCQkJcmV0dXJuIF9fcmV0OwoJCQkJfQoKCQkJCXZhciB0aW1lb3V0ID0gcmVzLlJ1bkFmdGVyIC0gcmVzLkRhdGU7CgkJCQlpZiAodGltZW91dCA8PSAwKSB7CgkJCQkJLy8gbmVnYXRpdmUgdGltZW91dCBtZWFucyB0aGF0IGl0IHdhcyBzdXBwb3NlZCB0byBiZSBydW4gYnV0IGRpZCBub3QgZm9yIHNvbWUgcmVhc29uIChkZWxheSwgZmFpbHVyZSwgZXRjLi4uKQoJCQkJCS8vIHNhbWUgZGF0ZSBhcyBydW5hZnRlciBtZWFucyB0aGF0IHdlIGFyZSB1c2luZyB0aGUgaW1tZWRpYXRlIGFzeW5jIGV4ZWN1dGlvbi4gaS5lLiB0aGVyZSBpcyBubyBuZWVkIGZvciB0aGUgcnVubmVyIHRocmVhZCB0YXNrCgkJCQkJdGltZW91dCA9IDMwMDAwOwoJCQkJfSBlbHNlIGlmICh0aW1lb3V0ID4gNSAqIDYwICogMTAwMCkgewoJCQkJCS8vIG1vcmUgdGhhbiB3ZSBjYW4gd2FpdCwgd2UgcmV0dXJuIGEgcmVmZXJlbmNlIHRvIHRoZSByZXN1bHQKCQkJCQljb25zb2xlLmxvZygKCQkJCQkJJ1dlIGNhbm5vdCB3YWl0ICcgKwoJCQkJCQlNYXRoLmZsb29yKHRpbWVvdXQgLyAxMDAwKSArCgkJCQkJCScgc2Vjb25kcy4gUmV0dXJuaW5nIHJlc3VsdC4nCgkJCQkJKTsKCQkJCQlyZXR1cm4gcmVzOwoJCQkJfQoJCQkJY29uc29sZS5sb2coCgkJCQkJJ01ha2luZyB0aGUgbmV4dCBjYWxsIGluICcgKwoJCQkJCU1hdGguZmxvb3IodGltZW91dCAvIDEwMDApICsKCQkJCQknIHNlY29uZHMuJwoJCQkJKTsKCgkJCQlhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSkgPT4gc2V0VGltZW91dChyZXNvbHZlLCB0aW1lb3V0KSk7CgkJCQlpZiAoIXRoaXMuQWN0aXZlUmVxdWVzdCkgewoJCQkJCWNvbnNvbGUubG9nKCdObyBBY3RpdmVSZXF1ZXN0LCBleGl0aW5nLi4uJyk7CgkJCQkJcmV0dXJuIG51bGw7CgkJCQl9CgkJCQl0cnkgewoJCQkJCWxldCByZXQgPSBhd2FpdCAkLmFqYXgoewoJCQkJCQl1cmw6ICcvbWV0aG9kL2EuYXNoeD9uYW1lPUNvbnRlbnRNYW5hZ2VyLmNtc01ldGhvZFJlc3VsdEZpbmQmcDA9e0NvZGV9JyArCgkJCQkJCQlyZXMuQ29kZSArCgkJCQkJCQkney9Db2RlfXtJZH0nICsKCQkJCQkJCXJlcy5JZCArCgkJCQkJCQkney9JZH0mcmFuZD0nICsKCQkJCQkJCU1hdGgucmFuZG9tKCksCgkJCQkJfSk7CgkJCQkJcmV0ID0gdGhpcy5wcm9jZXNzUmVzcG9uc2UoNCwgbnVsbCwgcmV0LCB0aGlzLkFjdGl2ZVJlcXVlc3QuVVJMKTsKCQkJCQlyZXQgPSBhd2FpdCB0aGlzLnByb2Nlc3NSZXN1bHQocmV0KTsKCQkJCQlyZXR1cm4gcmV0OwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZygncHJvY2Vzc1Jlc3VsdCcsIGV4KTsKCQkJCQlyZXR1cm4gYXdhaXQgdGhpcy5fKCdDb250ZW50TWFuYWdlci5jbXNNZXRob2RSZXN1bHRGaW5kJywgbnVsbCwgewoJCQkJCQlDb2RlOiByZXMuQ29kZSwKCQkJCQkJSWQ6IHJlcy5JZCwKCQkJCQl9KTsKCQkJCX0KCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKGQpID0+IHsKCQkJCWxldCB0ZCA9IDA7CgkJCQl0cnkgewoJCQkJCXRkID0gd2luZG93LnRpbWVEaWZmZXJlbmNlOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQl0ZCA9IGdsb2JhbC50aW1lRGlmZmVyZW5jZTsKCQkJCX0KCQkJCXJldHVybiB0aGlzLmFkZE1TZWNvbmRzKGQgfHwgbmV3IERhdGUoKSwgLXRkKTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKG8sIG1zKSA9PiB7CgkJCQlyZXR1cm4gbmV3IERhdGUoby5nZXRUaW1lKCkgKyBtcyk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgocykgPT4gewoJCQkJaWYgKCFzKSByZXR1cm4gbnVsbDsKCgkJCQlsZXQgY0xpbmVzID0gcy5zcGxpdCgnXG4nKTsKCQkJCXRyeSB7CgkJCQkJaWYgKHR5cGVvZihlc3ByaW1hKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkJZXNwcmltYS5wYXJzZShzLCB7CgkJCQkJCQllczY6IHRydWUKCQkJCQkJfSk7CgkJCQkJfQoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQlpZiAoY0xpbmVzW2V4LmxpbmVOdW1iZXIgLSAxXS5pbmRleE9mKCdmb3IgYXdhaXQnKSA8IDApIHsKCQkJCQkJY29uc29sZS5sb2coInJ1blNjcmlwdCgpICIgKyBleC5kZXNjcmlwdGlvbiwgZXgubGluZU51bWJlciwgY0xpbmVzW2V4LmxpbmVOdW1iZXIgLSAxXSk7CgkJCQkJCXJldHVybjsKCQkJCQl9CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCXRyeSB7CgkJCQkJCWlmICh3aW5kb3cuX2NvbnRlbnQgJiYgd2luZG93Ll9jb250ZW50LmV2YWwpIHsKCQkJCQkJCXZhciBvdXRwdXQgPSB3aW5kb3cuX2NvbnRlbnQuZXZhbChzKTsKCQkJCQkJCXJldHVybiBvdXRwdXQ7CgkJCQkJCX0KCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCXRoaXMuU2hvd0Vycm9yKCdGRiBTQ1JJUFQ6IFxuJyArIGUubWVzc2FnZSArICdcbicgKyBzKTsKCQkJCQl9CgkJCQkJdHJ5IHsKCQkJCQkJaWYgKHdpbmRvdy5leGVjU2NyaXB0KSB7CgkJCQkJCQlpZiAocy5pbmRleE9mKCdcclxuJykgPiAwKSB7CgkJCQkJCQkJLy8gYSBtdWx0aS1saW5lIHN0YXRlbWVudAoJCQkJCQkJCXdpbmRvdy5leGVjU2NyaXB0KHMpOwoJCQkJCQkJCXJldHVybiBudWxsOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkvLyBhIHNpbmdsZS1saW5lIHN0YXRlbWVudAoJCQkJCQkJCW5ld1YgPSBudWxsOwoJCQkJCQkJCXZhciBuZXdTID0gJ25ld1YgPSAnICsgczsKCQkJCQkJCQl3aW5kb3cuZXhlY1NjcmlwdChuZXdTKTsKCQkJCQkJCQlyZXR1cm4gbmV3VjsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJdGhpcy5TaG93RXJyb3IoJ0lFNiBTQ1JJUFQ6IFxuJyArIGUubWVzc2FnZSArICdcbicgKyBzKTsKCQkJCQl9CgoJCQkJCXRyeSB7CgkJCQkJCWlmICh3aW5kb3cuZXhlY1NjcmlwdCkgewoJCQkJCQkJaWYgKHMuaW5kZXhPZignXHJcbicpID4gMCkgewoJCQkJCQkJCS8vIGEgbXVsdGktbGluZSBzdGF0ZW1lbnQKCQkJCQkJCQl3aW5kb3cuZXhlY1NjcmlwdChzKTsKCQkJCQkJCQlyZXR1cm4gbnVsbDsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJLy8gYSBzaW5nbGUtbGluZSBzdGF0ZW1lbnQKCQkJCQkJCQluZXdWID0gbnVsbDsKCQkJCQkJCQl2YXIgbmV3UyA9ICduZXdWID0gJyArIHM7CgkJCQkJCQkJZXZhbChuZXdTKTsKCQkJCQkJCQlyZXR1cm4gbmV3VjsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJdGhpcy5TaG93RXJyb3IoJ0lFNyBTQ1JJUFQ6IFxuJyArIGUubWVzc2FnZSArICdcbicgKyBzKTsKCQkJCQl9CgoJCQkJCXRyeSB7CgkJCQkJCXZhciBmbiA9IGZ1bmN0aW9uKCkgewoJCQkJCQkJdmFyIHJldCA9IHdpbmRvdy5ldmFsLmNhbGwod2luZG93LCBzKTsKCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX07CgoJCQkJCQlyZXR1cm4gZm4oKTsKCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCXRoaXMuU2hvd0Vycm9yKCdUQUcgU0NSSVBUOiBcbicgKyBlLm1lc3NhZ2UgKyAnXG4nICsgcyk7CgkJCQkJfQoJCQkJfQoKCQkJCXRyeSB7CgkJCQkJcyA9IHMucmVwbGFjZSgvbmV3IERhdGVcKDAwMDEvZywgJ25ldyBEYXRlKDEnKTsKCQkJCQlyZXR1cm4gZXZhbChzKTsKCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQl0aGlzLlNob3dFcnJvcignRVZBTCBTQ1JJUFQ6IFxuJyArIGUubWVzc2FnZSArICdcbicgKyBzKTsKCQkJCX0KCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgocykgPT4gewoJCQkJcmV0dXJuIHRoaXMucnVuU2NyaXB0KAoJCQkJCScoKCkgPT4geyB2YXIgcmV0ID0gbnVsbDsgJyArCgkJCQkJcyArCgkJCQkJJyBpZih0eXBlb2Yod2luZG93KSE9PSJ1bmRlZmluZWQiKXt3aW5kb3cubWV0aG9kX25hbWUgPSBtZXRob2RfbmFtZTsgd2luZG93LnNlcnZlcl90aW1lID0gc2VydmVyX3RpbWU7IHdpbmRvdy5fZXhjZXB0aW9uID0gdHlwZW9mKF9leGNlcHRpb24pPT09InVuZGVmaW5lZCI/bnVsbDpfZXhjZXB0aW9uOyB3aW5kb3cuZXhlY3V0aW9uX3RpbWUgPSBleGVjdXRpb25fdGltZTt9IHJldHVybiB7X2V4Y2VwdGlvbjogdHlwZW9mKF9leGNlcHRpb24pPT09InVuZGVmaW5lZCI/bnVsbDpfZXhjZXB0aW9uLCBtZXRob2RfbmFtZTogbWV0aG9kX25hbWUsIHNlcnZlcl90aW1lOiBzZXJ2ZXJfdGltZSwgZXhlY3V0aW9uX3RpbWU6IGV4ZWN1dGlvbl90aW1lLCByZXQ6IHJldH07fSkoKTsnCgkJCQkpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHMpID0+IHsKCQkJCXZhciBoYXNoID0gMCwKCQkJCQlpLAoJCQkJCWNociwKCQkJCQlsZW47CgkJCQlpZiAocy5sZW5ndGggPT0gMCkgcmV0dXJuIGhhc2g7CgkJCQlmb3IgKGkgPSAwLCBsZW4gPSBzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CgkJCQkJY2hyID0gcy5jaGFyQ29kZUF0KGkpOwoJCQkJCWhhc2ggPSAoaGFzaCA8PCA1KSAtIGhhc2ggKyBjaHI7CgkJCQkJaGFzaCB8PSAwOyAvLyBDb252ZXJ0IHRvIDMyYml0IGludGVnZXIKCQkJCX0KCQkJCXJldHVybiBoYXNoOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKGFyLCBmaWVsZCkgPT4gewoJCQkJaWYgKCFhciB8fCAhZmllbGQpIHJldHVybiBudWxsOwoKCQkJCXZhciBrZXlzID0gW107CgkJCQlhci5mb3JFYWNoKGEgPT4gewoJCQkJCXZhciBrZXkgPSBudWxsOwoJCQkJCWZpZWxkLnNwbGl0KCcuJykuZm9yRWFjaChmID0+IGtleSA9IChrZXkgfHwgYSlbZl0pOwoJCQkJCWxldCBrID0ga2V5cy5maW5kKGsgPT4gdGhpcy5FcXVhbHMoay5rZXksIGtleSkpOwoJCQkJCWlmIChrKSB7CgkJCQkJCWsudmFsdWVzLnB1c2goYSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJa2V5cy5wdXNoKHsKCQkJCQkJCWtleToga2V5LAoJCQkJCQkJdmFsdWVzOiBbYV0sCgkJCQkJCX0pOwoJCQkJCX0KCQkJCX0pOwoJCQkJcmV0dXJuIGtleXM7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChzLCBiSWdub3JlRGVidWcpID0+IHsKCQkJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCQljb25zb2xlLmxvZygiU2hvd0RlYnVnOiAiICsgcyk7CgkJCQl9CgkJCQlpZiAodGhpcy5iRGVidWcgfHwgYklnbm9yZURlYnVnKSB0aGlzLlNob3dNZXNzYWdlKHMpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKGFzeW5jIChyZXF1ZXN0LCB0ZXh0cmVzcG9uc2UpID0+IHsKCQkJCWlmICghdGhpcy5iQ2FjaGVSZXN1bHQpIHJldHVybjsKCQkJCXJlcXVlc3QgPSByZXF1ZXN0IHx8IHRoaXMuQWN0aXZlUmVxdWVzdDsKCgkJCQlpZiAoIXJlcXVlc3QpIHsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKAoJCQkJCXRleHRyZXNwb25zZSAmJgoJCQkJCXRleHRyZXNwb25zZS5pbmRleE9mKCdyZXQuQ29kZSA9ICcpID4gLTEgJiYKCQkJCQl0ZXh0cmVzcG9uc2UuaW5kZXhPZigncmV0LlJ1bkFmdGVyID0gJykgPiAtMSAmJgoJCQkJCXRleHRyZXNwb25zZS5pbmRleE9mKCdyZXQuUmVzdWx0ID0gIiInKSA+IC0xCgkJCQkpIHsKCQkJCQljb25zb2xlLmxvZygndGV4dHJlc3BvbnNlIGNvbnRpYW5zIGluY29tcGxldGUgbWV0aG9kIHJlc3VsdCcpOwoJCQkJCXJldHVybiBudWxsOwoJCQkJfQoKCQkJCXZhciBzTWV0aG9kID0gdGhpcy4kX1JFUVVFU1QoJ25hbWUnLCByZXF1ZXN0LlVSTCk7CgkJCQlzTWV0aG9kID0gc01ldGhvZC5zdWJzdHJpbmcoc01ldGhvZC5sYXN0SW5kZXhPZignLicpICsgMSk7CgkJCQl0cnkgewoJCQkJCXZhciBfdXNhYmxlID0gKHIpID0+IHsKCQkJCQkJdmFyIGl0ZW0gPQoJCQkJCQkJKHIgJiYKCQkJCQkJCQlyLmhhc2ggPT0gcmVxdWVzdC5oYXNoICYmCgkJCQkJCQkJKHIuVVJMID09IHJlcXVlc3QuVVJMIHx8IHRoaXMuJF9SRVFVRVNUKCduYW1lJywgci5VUkwpID09IHNNZXRob2QpICYmCgkJCQkJCQkJci5UZXh0UmVzcG9uc2UgJiYKCQkJCQkJCQkodHlwZW9mIHIuRXhwaXJlcyA9PT0gJ3VuZGVmaW5lZCcgfHwKCQkJCQkJCQkJbmV3IERhdGUoci5FeHBpcmVzKSA+IG5ldyBEYXRlKCkpKSA/CgkJCQkJCQlyIDoKCQkJCQkJCW51bGw7CgkJCQkJCWlmICh0ZXh0cmVzcG9uc2UpIHsKCQkJCQkJCWl0ZW0gPSBpdGVtIHx8IHJlcXVlc3Q7CgkJCQkJCQlpdGVtLlRleHRSZXNwb25zZSA9IHRleHRyZXNwb25zZTsKCQkJCQkJCWl0ZW0uRXhwaXJlcyA9IG5ldyBEYXRlKAoJCQkJCQkJCW5ldyBEYXRlKCkuZ2V0VGltZSgpICsKCQkJCQkJCQlwYXJzZUZsb2F0KAoJCQkJCQkJCQl0aGlzLm5DYWNoZUV4cGlyZUhvdXJzIHx8IHRoaXMuJF9SRVFVRVNUKCduQ2FjaGVFeHBpcmVIb3VycycpIHx8IDEKCQkJCQkJCQkpICoKCQkJCQkJCQk2MCAqCgkJCQkJCQkJNjAgKgoJCQkJCQkJCTEwMDAKCQkJCQkJCSk7CgkJCQkJCX0KCgkJCQkJCXJldHVybiBpdGVtOwoJCQkJCX07CgoJCQkJCWlmICgKCQkJCQkJdGhpcy5iQ2FjaGVSZXN1bHQgPT0gJ2t2c3RvcmUnICYmCgkJCQkJCXR5cGVvZiB3aW5kb3cuY29tcGFueS5yZXN0aW9kYlNldHRpbmdzICE9PSAndW5kZWZpbmVkJwoJCQkJCSkgewoJCQkJCQl2YXIgYWpheCA9IChrZXksIHZhbHVlLCBpZCkgPT4gewoJCQkJCQkJdmFyIHJldCA9IGNvbXBhbnkucmVzdGlvZGJTZXR0aW5ncygpOwoJCQkJCQkJcmV0LnVybCArPSAna3ZzdG9yZSc7CgkJCQkJCQlpZiAodmFsdWUpIHsKCQkJCQkJCQlpZiAoaWQpIHsKCQkJCQkJCQkJLy8gdXBkYXRlIHJlY29yZAoJCQkJCQkJCQlyZXQudXJsICs9ICcvJyArIGlkOwoJCQkJCQkJCQlyZXQubWV0aG9kID0gJ1BVVCc7CgkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJLy8gbmV3IHJlY29yZAoJCQkJCQkJCQlyZXQubWV0aG9kID0gJ1BPU1QnOwoJCQkJCQkJCX0KCQkJCQkJCQlyZXQuZGF0YSA9IEpTT04uc3RyaW5naWZ5KHsKCQkJCQkJCQkJa2V5OiBrZXksCgkJCQkJCQkJCXZhbHVlOiBKU09OLnN0cmluZ2lmeSh2YWx1ZSwgbnVsbCwgNCksCgkJCQkJCQkJfSk7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCWlmIChpZCkgewoJCQkJCQkJCQkvLyBkZWxldGUgcmVjb3JkCgkJCQkJCQkJCXJldC51cmwgKz0gJy8nICsgaWQ7CgkJCQkJCQkJCXJldC5tZXRob2QgPSAnREVMRVRFJzsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQlyZXQubWV0aG9kID0gJ0dFVCc7CgkJCQkJCQkJCXJldC51cmwgKz0gJz9xPXsia2V5IjonICsga2V5ICsgJ30nOwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJCS8vY29uc29sZS5sb2coJ21ldGhvZCcsIHJldC5tZXRob2QpOwoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfTsKCgkJCQkJCWxldCByZWNvcmQgPSBhd2FpdCAkLmFqYXgoYWpheChyZXF1ZXN0Lmhhc2gpKTsKCQkJCQkJbGV0IHIgPQoJCQkJCQkJcmVjb3JkICYmIHJlY29yZC5sZW5ndGggPwoJCQkJCQkJSlNPTi5wYXJzZShyZWNvcmRbMF0udmFsdWUpIDoKCQkJCQkJCW51bGw7CgkJCQkJCWxldCBpdGVtID0gX3VzYWJsZShyKTsKCgkJCQkJCWlmICghaXRlbSkgewoJCQkJCQkJaWYgKHIpIHsKCQkJCQkJCQlhd2FpdCAkLmFqYXgoYWpheChyZXF1ZXN0Lmhhc2gsIG51bGwsIHJlY29yZFswXS5faWQpKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiBudWxsOwoJCQkJCQl9CgoJCQkJCQlpZiAoIXIgfHwgaXRlbS5FeHBpcmVzID4gci5FeHBpcmVzKSB7CgkJCQkJCQlhd2FpdCAkLmFqYXgoCgkJCQkJCQkJYWpheChpdGVtLmhhc2gsIGl0ZW0sIHIgPyByZWNvcmRbMF0uX2lkIDogbnVsbCkKCQkJCQkJCSk7CgkJCQkJCQlyZXR1cm4gaXRlbTsKCQkJCQkJfQoKCQkJCQkJcmV0dXJuIGl0ZW07CgkJCQkJfSBlbHNlIGlmICh0aGlzLmJDYWNoZVJlc3VsdCA9PSAnc3InKSB7CgkJCQkJCXZhciBhamF4ID0gKGtleSwgdmFsdWUsIGlkKSA9PiB7CgkJCQkJCQl2YXIgbWV0aG9kID0gJ0ZpbmQnOwoJCQkJCQkJdmFyIHJldCA9IHsKCQkJCQkJCQl1cmw6ICcvbWV0aG9kL2EuYXNoeD9uYW1lPUNvbnRlbnRNYW5hZ2VyLmNtc01ldGhvZFJlc3VsdCcsCgkJCQkJCQkJcHJvY2Vzc0RhdGE6IGZhbHNlLAoJCQkJCQkJCXR5cGU6ICdQT1NUJywKCQkJCQkJCX07CgkJCQkJCQlpZiAodmFsdWUpIHsKCQkJCQkJCQlpZiAoaWQpIHsKCQkJCQkJCQkJLy8gdXBkYXRlIHJlY29yZAoJCQkJCQkJCQltZXRob2QgPSAnVXBkYXRlJzsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQkvLyBuZXcgcmVjb3JkCgkJCQkJCQkJCW1ldGhvZCA9ICdJbnNlcnQnOwoJCQkJCQkJCX0KCQkJCQkJCQlyZXQuYmVmb3JlU2VuZCA9IChyZXF1ZXN0KSA9PiB7CgkJCQkJCQkJCXJlcXVlc3Quc2V0UmVxdWVzdEhlYWRlcigKCQkJCQkJCQkJCSdDb250ZW50LVR5cGUnLAoJCQkJCQkJCQkJJ211bHRpcGFydC9mb3JtLWRhdGE7IGJvdW5kYXJ5PS0tLS0tLS0tLS0tLS0tJwoJCQkJCQkJCQkpOwoJCQkJCQkJCX07CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCXJldC50eXBlID0gJ0dFVCc7CgkJCQkJCQkJaWYgKGlkKSB7CgkJCQkJCQkJCS8vIGRlbGV0ZSByZWNvcmQKCQkJCQkJCQkJbWV0aG9kID0gJ0RlbGV0ZSc7CgkJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkJLy8gZ2V0IHJlY29yZAoJCQkJCQkJCQltZXRob2QgPSAnRmluZCc7CgkJCQkJCQkJfQoJCQkJCQkJCW1ldGhvZCArPQoJCQkJCQkJCQknJnAwPXtDb2RlfScgKwoJCQkJCQkJCQkoY29tcGFueSA/IGNvbXBhbnkuQ29kZSArICctJyA6ICcnKSArCgkJCQkJCQkJCWtleSArCgkJCQkJCQkJCSd7L0NvZGV9JzsKCQkJCQkJCX0KCQkJCQkJCXJldC51cmwgKz0gbWV0aG9kOwoJCQkJCQkJaWYgKHJldC50eXBlICE9ICdHRVQnKSB7CgkJCQkJCQkJZGVsZXRlIGl0ZW0uUG9zdERhdGE7IC8vIGJlY2F1c2Ugd2UgaGF2ZSB0aGUgY2FjaGUga2V5CgkJCQkJCQkJdmFyIHAwID0gewoJCQkJCQkJCQlDb2RlOiAoY29tcGFueSA/IGNvbXBhbnkuQ29kZSArICctJyA6ICcnKSArIGtleSwKCQkJCQkJCQkJQ29tcGxldGVkOiBuZXcgRGF0ZSgpLAoJCQkJCQkJCQlEYXRlOiB0aGlzLkFjdGl2ZVJlcXVlc3QgPwoJCQkJCQkJCQkJdGhpcy5BY3RpdmVSZXF1ZXN0LkRhdGUgOiBuZXcgRGF0ZSgpLAoJCQkJCQkJCQlSZXN1bHQ6IGJ0b2EodW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KEpTT04uc3RyaW5naWZ5KGl0ZW0pKSkpLCAvL2l0ZW0uVGV4dFJlc3BvbnNlLAoJCQkJCQkJCQlTdG9yZWRNZXRob2Q6IHsKCQkJCQkJCQkJCU5hbWU6IHNNZXRob2QsCgkJCQkJCQkJCX0sCgkJCQkJCQkJfTsKCQkJCQkJCQlpZiAoaWQpIHsKCQkJCQkJCQkJcDAuSWQgPSBpZDsKCQkJCQkJCQl9CgkJCQkJCQkJcmV0LmRhdGEgPQoJCQkJCQkJCQknUE9TVERBVEE9XHJcbicgLyorICI8P3htbCB2ZXJzaW9uPVwiMS4wXCIgZW5jb2Rpbmc9XCJ1dGYtOFwiIHN0YW5kYWxvbmU9XCJ5ZXNcIj8+XHJcbiIqLyArCgkJCQkJCQkJCXRoaXMucGFyYW0oW3AwXSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9OwoKCQkJCQkJbGV0IHJlY29yZCA9IHRoaXMucnVuU2NyaXB0IC8qcnVuU1JTY3JpcHQqLygKCQkJCQkJCScoKCkgPT4geyB2YXIgcmV0ID0gbnVsbDsgJyArCgkJCQkJCQkoYXdhaXQgJC5hamF4KGFqYXgocmVxdWVzdC5oYXNoKSkpICsKCQkJCQkJCSdyZXR1cm4gcmV0O30pKCk7JwoJCQkJCQkpOwoJCQkJCQlsZXQgciA9IHJlY29yZCA/IEpTT04ucGFyc2UocmVjb3JkLlJlc3VsdCkgOiBudWxsOwoJCQkJCQlsZXQgaXRlbSA9IF91c2FibGUocik7CgoJCQkJCQlpZiAoIWl0ZW0pIHsKCQkJCQkJCWlmIChyKSB7CgkJCQkJCQkJdHJ5IHsKCQkJCQkJCQkJYXdhaXQgJC5hamF4KGFqYXgocmVxdWVzdC5oYXNoLCBudWxsLCByZWNvcmQuSWQpKTsKCQkJCQkJCQl9IGNhdGNoIChleCkge30KCQkJCQkJCX0KCQkJCQkJCXJldHVybiBudWxsOwoJCQkJCQl9CgoJCQkJCQlpZiAoIXIgfHwgaXRlbS5FeHBpcmVzID4gci5FeHBpcmVzKSB7CgkJCQkJCQlhd2FpdCAkLmFqYXgoCgkJCQkJCQkJYWpheChpdGVtLmhhc2gsIGl0ZW0sIHIgJiYgcmVjb3JkID8gcmVjb3JkLklkIDogbnVsbCkKCQkJCQkJCSk7CgkJCQkJCQlyZXR1cm4gaXRlbTsKCQkJCQkJfQoKCQkJCQkJcmV0dXJuIGl0ZW07CgkJCQkJfSBlbHNlIGlmICh0aGlzLmJDYWNoZVJlc3VsdCA9PSAnZ2l0aHViJykgewoJCQkJCQlpZiAocmVxdWVzdC5VUkwuaW5kZXhPZignY21zTWV0aG9kUmVzdWx0JykgPj0gMCkgcmV0dXJuIG51bGw7CgkJCQkJCWxldCByZXMgPSBudWxsOwoJCQkJCQl0cnkgewoJCQkJCQkJcmVzID0gYXdhaXQgJC5hamF4KHsKCQkJCQkJCQl1cmw6ICdodHRwczovL2Fyemhvc3BpdGFsLmdpdGh1Yi5pby8nICsKCQkJCQkJCQkJY29tcGFueS5TdG9yZSArCgkJCQkJCQkJCScvJyArCgkJCQkJCQkJCXJlcXVlc3QuaGFzaCArCgkJCQkJCQkJCScuanMnLAoJCQkJCQkJCWRhdGFUeXBlOiAnanNvbnAnLAoJCQkJCQkJCXByb2Nlc3NSZXN1bHQ6IGZhbHNlLAoJCQkJCQkJfSk7CgkJCQkJCQlyZXR1cm4gewoJCQkJCQkJCVRleHRSZXNwb25zZTogcmVzLAoJCQkJCQkJfTsKCQkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJCWNvbnNvbGUubG9nKCdFUlJPUlM6JywgZXgpOwoJCQkJCQkJcmV0dXJuIG51bGw7CgkJCQkJCX0KCQkJCQl9IGVsc2UgaWYgKHRoaXMuYkNhY2hlUmVzdWx0ID09ICdsb2NhbCcpIHsKCQkJCQkJdmFyIHNyQ2FjaGUgPSBsb2NhbFN0b3JhZ2UuZ2V0SXRlbSgnc3JDYWNoZScpOwoJCQkJCQlpZiAoc3JDYWNoZSA9PSBudWxsKSB7CgkJCQkJCQlzckNhY2hlID0gewoJCQkJCQkJCVJlcXVlc3RzOiB7fSwKCQkJCQkJCX07CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlzckNhY2hlID0gSlNPTi5wYXJzZShzckNhY2hlKTsKCQkJCQkJfQoKCQkJCQkJdmFyIHIgPSBzckNhY2hlLlJlcXVlc3RzW3JlcXVlc3QuaGFzaF07CgkJCQkJCXZhciBpdGVtID0gX3VzYWJsZShyKTsKCgkJCQkJCWlmICghaXRlbSkgewoJCQkJCQkJZGVsZXRlIHNyQ2FjaGUuUmVxdWVzdHNbcmVxdWVzdC5oYXNoXTsKCQkJCQkJCWxvY2FsU3RvcmFnZS5zZXRJdGVtKCdzckNhY2hlJywgSlNPTi5zdHJpbmdpZnkoc3JDYWNoZSkpOwoJCQkJCQkJcmV0dXJuIG51bGw7CgkJCQkJCX0KCgkJCQkJCWlmICghciB8fCBpdGVtLkV4cGlyZXMgPiByLkV4cGlyZXMpIHsKCQkJCQkJCXNyQ2FjaGUuUmVxdWVzdHNbaXRlbS5oYXNoXSA9IGl0ZW07CgkJCQkJCQlsb2NhbFN0b3JhZ2Uuc2V0SXRlbSgnc3JDYWNoZScsIEpTT04uc3RyaW5naWZ5KHNyQ2FjaGUpKTsKCQkJCQkJCXJldHVybiBpdGVtOwoJCQkJCQl9CgoJCQkJCQlyZXR1cm4gaXRlbTsKCQkJCQl9CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKGV4KTsKCQkJCQl0aHJvdyBleDsKCQkJCX0KCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChzKSA9PiB7CgkJCQlpZiAodHlwZW9mIHMgIT09ICdzdHJpbmcnKSByZXR1cm4gczsKCgkJCQl2YXIgYXJyMSA9IFtdOwoJCQkJZm9yICh2YXIgbiA9IDAsIGwgPSBzLmxlbmd0aDsgbiA8IGw7IG4rKykgewoJCQkJCXZhciBoZXggPSBOdW1iZXIocy5jaGFyQ29kZUF0KG4pKS50b1N0cmluZygxNik7CgkJCQkJYXJyMS5wdXNoKGhleCk7CgkJCQl9CgkJCQlyZXR1cm4gYXJyMS5qb2luKCcnKTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChzKSA9PiB7CgkJCQljb25zb2xlLmxvZyhzKTsKCQkJCWlmICh0aGlzLmJTaG93RXJyb3JzKSB0aGlzLlNob3dNZXNzYWdlKHMpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChvMSwgbzIpID0+IHsKCQkJCWlmIChvMSA9PSBvMikgcmV0dXJuIHRydWU7CgoJCQkJaWYgKAoJCQkJCW8xICYmCgkJCQkJbzEuX19PQkpFQ1RJRCAmJgoJCQkJCW8yICYmCgkJCQkJbzIuX19PQkpFQ1RJRCAmJgoJCQkJCW8xLl9fT0JKRUNUSUQgPT0gbzIuX19PQkpFQ1RJRAoJCQkJKQoJCQkJCXJldHVybiB0cnVlOwoJCQkJaWYgKG8xICYmIG8xLl9fUk9XSUQgJiYgbzIgJiYgbzIuX19ST1dJRCAmJiBvMS5fX1JPV0lEID09IG8yLl9fUk9XSUQpCgkJCQkJcmV0dXJuIHRydWU7CgkJCQlpZiAobzEgJiYgbzEuSWQgJiYgbzIgJiYgbzIuSWQgJiYgbzEuSWQgPT0gbzIuSWQpIHJldHVybiB0cnVlOwoKCQkJCXJldHVybiBmYWxzZTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoKSA9PiB7CgkJCQl0cnkgewoJCQkJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiBudWxsOwoJCQkJCWlmICh0eXBlb2YoZ2xvYmFsKSA9PT0gJ3VuZGVmaW5lZCcgfHwgdHlwZW9mKGdsb2JhbC5vcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJCS8vIGNvbnNvbGUubG9nKCJpcEFkZHJlc3MoKTogSW52YWxpZCBnbG9iYWwgb3IgZ2xvYmFsLm9zIG5vdCBkZWZpbmVkIik7CgkJCQkJCXJldHVybiBudWxsOwoJCQkJCX0KCQkJCQlyZXR1cm4gW10uY29uY2F0KC4uLk9iamVjdC52YWx1ZXMoZ2xvYmFsLm9zLm5ldHdvcmtJbnRlcmZhY2VzKCkpKS5maW5kKChkZXRhaWxzKSA9PiBkZXRhaWxzLmZhbWlseSA9PT0gJ0lQdjQnICYmICFkZXRhaWxzLmludGVybmFsKS5hZGRyZXNzOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQljb25zb2xlLmxvZygiaXBBZGRyZXNzKCk6ICIgKyBleCk7CgkJCQkJcmV0dXJuIG51bGw7CgkJCQl9CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChlYSkgPT4gewoJCQkJdHJ5IHsKCQkJCQlpZiAoZWEuRW50aXR5VHlwZSkgcmV0dXJuICJFbnRpdHkiOwoJCQkJCXJldHVybiBPYmplY3Qua2V5cyhlYSkuZmlsdGVyKGsgPT4gIWsuaW5kZXhPZigiSXMiKSAmJiBrICE9PSAiSXNVbmlxdWUiKS5maW5kKGsgPT4gZWFba10pLnJlcGxhY2UoJ0lzJywgJycpOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQlyZXR1cm4gbnVsbDsKCQkJCX0KCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoYSkgPT4gewoJCQkJcmV0dXJuIGEuZmlsdGVyKChhZywgaSkgPT4gIWEuZmluZCgoX2FnLCBfaSkgPT4gX2FnLk5hbWUgPT0gYWcuTmFtZSAmJiBfaSA+IGkgJiYgaSA9PSBfaSkpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoYXN5bmMgKHNjb3BlLCBmaWxlbmFtZSkgPT4gewoJCQkJbGV0IG9TY29wZSA9IHRoaXMuX19zY29wZShzY29wZSk7CgoJCQkJbGV0IHMgPSB7CgkJCQkJRW5hYmxlZDogdHJ1ZSwKCQkJCQlOYW1lOiAiQVBJU0VSVkVSOjoiICsgc2NvcGUsCgkJCQl9OwoJCQkJaWYgKG9TY29wZS5fX3NjcmlwdCAmJiBvU2NvcGUuX19zY3JpcHQuRGF0ZSkgewoJCQkJCXMuRGF0ZSA9IG9TY29wZS5fX3NjcmlwdC5EYXRlOwoJCQkJCXMuT1BFUkFUT1JTID0gewoJCQkJCQlEYXRlOiAiPiIKCQkJCQl9CgkJCQl9CgkJCQlsZXQgc2NyaXB0ID0gYXdhaXQgdGhpcy5zcigpLl8oYENvbnRlbnRNYW5hZ2VyLmNtc1N0b3JlZFNjcmlwdEZpbmRgLCBudWxsLCBzKTsKCQkJCWlmIChzY3JpcHQgJiYgc2NyaXB0LlNjcmlwdCkgewoJCQkJCXNjcmlwdC5TY3JpcHQgPSB0aGlzLl9hdG9iKHNjcmlwdC5TY3JpcHQpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyBjb25zb2xlLmxvZygiX3JlZnJlc2hBUEk6IHNjcmlwdCBpcyBudWxsIik7CgkJCQkJcmV0dXJuIDE7CgkJCQl9CgoJCQkJaWYgKCFvU2NvcGUgfHwgIW9TY29wZS5fX3NjcmlwdCB8fCAoc2NyaXB0ICYmIHNjcmlwdC5TY3JpcHQgJiYgKChzY3JpcHQuRGF0ZS5nZXRUaW1lKCkgLSBvU2NvcGUuX19zY3JpcHQuRGF0ZS5nZXRUaW1lKCkpIC8gMTAwMCkgPiA1KSkgewoJCQkJCWlmIChmaWxlbmFtZSkgewoJCQkJCQljb25zb2xlLmxvZygiWyIgKyBzY29wZSArICJdIE5ldyBVcGRhdGVkIFZlcnNpb24sIG92ZXJ3cml0dGluZyAiICsgZmlsZW5hbWUsIHNjcmlwdC5EYXRlLCAob1Njb3BlICYmIG9TY29wZS5fX3NjcmlwdCkgPyBvU2NvcGUuX19zY3JpcHQuRGF0ZSA6IG51bGwpOwoJCQkJCX0KCgkJCQkJaWYgKGZpbGVuYW1lICYmIHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQlhd2FpdCBnbG9iYWwudXRpbC5wcm9taXNpZnkoZ2xvYmFsLmZzLndyaXRlRmlsZSkoZmlsZW5hbWUsIHNjcmlwdC5TY3JpcHQpOwoJCQkJCX0gZWxzZSBpZiAoZmlsZW5hbWUpIHsKCQkJCQkJYXdhaXQgdGhpcy5zcigpLl8oJ0NvbnRlbnRNYW5hZ2VyLmNtc1NhdmVGaWxlQm9keScsIG51bGwsIGZpbGVuYW1lLCB0aGlzLl9idG9hKHNjcmlwdC5TY3JpcHQpKTsKCQkJCQl9CgoJCQkJCWlmICghb1Njb3BlKSByZXR1cm47CgkJCQkJb1Njb3BlLl9fc2NyaXB0ID0gc2NyaXB0OwoJCQkJfSBlbHNlIHsKCQkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnKQoJCQkJCQljb25zb2xlLmxvZyhgWyR7c2NvcGV9XSBTYW1lIG9yIG9sZGVyIHZlcnNpb24sIHNraXBwaW5nIHVwZGF0ZWAsIHNjcmlwdCA/IHNjcmlwdC5EYXRlIDogbnVsbCwgb1Njb3BlLl9fc2NyaXB0ID8gb1Njb3BlLl9fc2NyaXB0LkRhdGUgOiBudWxsKTsKCQkJCX0KCgkJCQlkZWxldGUgb1Njb3BlLl9fc2NyaXB0LlNjcmlwdDsKCQkJCXJldHVybiBvU2NvcGUuX19zY3JpcHQ7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHNjb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJyA/IHdpbmRvdyA6IGdsb2JhbCk7CgkJCQlpZiAoc2NvcGUpIHJldCA9IHJldFtzY29wZV07CgkJCQlyZXR1cm4gcmV0OwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKCkgPT4gewoJCQkJcmV0dXJuICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93LlNSKSA/IHdpbmRvdy5TUiA6IHRoaXM7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKGEpID0+IHsKCQkJCXJldHVybiB0eXBlb2YoYXRvYikgPT09ICJ1bmRlZmluZWQiID8gQnVmZmVyLmZyb20oYSwgJ2Jhc2U2NCcpLnRvU3RyaW5nKCdiaW5hcnknKSA6IGF0b2IoYSk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKGIpID0+IHsKCQkJCXJldHVybiB0eXBlb2YoYnRvYSkgPT09ICJ1bmRlZmluZWQiID8gQnVmZmVyLmZyb20oYikudG9TdHJpbmcoJ2Jhc2U2NCcpIDogYnRvYSh1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQoYikpKTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgobmFtZSA9ICJnbG9iYWwiKSA9PiB7CgkJCQlsZXQgZCA9IG5ldyBEYXRlKCkgfHwgdGhpcy5zcigpLnNlcnZlckRhdGUoKTsKCQkJCXRoaXMuX19zY29wZSgpLl9fdGltZXMgPSB0aGlzLl9fc2NvcGUoKS5fX3RpbWVzIHx8IHt9OwoJCQkJdGhpcy5fX3Njb3BlKCkuX190aW1lc1tuYW1lXSA9IHRoaXMuX19zY29wZSgpLl9fdGltZXNbbmFtZV0gfHwgZDsKCgkJCQlsZXQgcyA9IE1hdGgucm91bmQoKChkIC0gdGhpcy5fX3Njb3BlKCkuX190aW1lc1tuYW1lXSkgLyAxMDAwKSAqIDEwMCwgMikgLyAxMDA7CgkJCQl0aGlzLl9fc2NvcGUoKS5fX3RpbWVzW25hbWVdID0gZDsKCQkJCXJldHVybiAocyArICdzJyk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKGFzeW5jIChtcykgPT4gewoJCQkJYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIG1zKSk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKGVhLCBkYlR5cGUpID0+IHsKCQkJCWxldCB0eXBlID0gdHlwZW9mKGVhKSA9PT0gInN0cmluZyIgPyBlYSA6IHRoaXMuX2F0dHIoZWEpOwoJCQkJc3dpdGNoICh0eXBlKSB7CgkJCQkJY2FzZSAiU3RyaW5nIjoKCQkJCQkJcmV0dXJuICJWQVJDSEFSKDI1NSkiOwoJCQkJCWNhc2UgIlRleHQiOgoJCQkJCWNhc2UgIk9iamVjdCI6CgkJCQkJCXJldHVybiBgJHtkYlR5cGU9PSdzcWxpdGUnPydWQVJDSEFSJzonVEVYVCd9KDQwMDApYDsKCQkJCQljYXNlICJCb29sIjoKCQkJCQkJcmV0dXJuICJUSU5ZSU5UIjsgLy9CSVQKCQkJCQljYXNlICJEYXRlIjoKCQkJCQkJcmV0dXJuICJEQVRFVElNRSI7CgkJCQkJY2FzZSAiSW50IjoKCQkJCQkJcmV0dXJuICJJTlRFR0VSIjsKCQkJCQljYXNlICJMb25nIjoKCQkJCQkJcmV0dXJuICJCSUdJTlQiOwoJCQkJCWNhc2UgIkVudGl0eSI6CgkJCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJCQljYXNlICJJbWFnZSI6CgkJCQkJY2FzZSAiRmlsZSI6CgkJCQkJCXJldHVybiAiQkxPQiI7CgkJCQkJZGVmYXVsdDoKCQkJCQkJcmV0dXJuIHR5cGUgKyAiKDQwKSI7CgkJCQl9CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKGlkLCBsZW4pID0+IHsKCQkJCWxldCByZXQgPSBudWxsOwoKCQkJCWlmICghcmV0ICYmIHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YoY3J5cHRvKSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IGNyeXB0by5yYW5kb21VVUlEKCk7CgkJCQlpZiAoIXJldCAmJiB0eXBlb2YodXVpZHY0KSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IHV1aWR2NCgpOwoKCQkJCWlmICghcmV0KSByZXQgPSAoKChpZCA/IE51bWJlcihpZCkgOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSAvIDEwKSB8IDApLnRvU3RyaW5nKDE2KSkgKyAneHh4eHh4eHh4eHh4eHh4eCcucmVwbGFjZSgvW3hdL2csICgpID0+IHsKCQkJCQlyZXR1cm4gKChpZCA/IGlkIDogTWF0aC5yYW5kb20oKSkgKiAxNiB8IDApLnRvU3RyaW5nKDE2KTsKCQkJCX0pLnRvTG93ZXJDYXNlKCkuc3Vic3RyaW5nKDAsIGxlbiB8fCAyNCkucmVwbGFjZSgvXC0vZywgJycpOwoKCQkJCS8vbGV0IHBvb2wgPSAodGhpcy5fX3Njb3BlKCkuX191dWlkUG9vbCA9IHRoaXMuX19zY29wZSgpLl9fdXVpZFBvb2wgfHwgW10pOwoJCQkJLy9pZiAocG9vbC5maW5kKHUgPT4gdSA9PSByZXQpKSByZXR1cm4gdGhpcy5fdXVpZChpZCwgbGVuKTsKCQkJCS8vcG9vbC5wdXNoKHJldCk7CgoJCQkJcmV0dXJuIHJldDsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIChhc3luYyAobGliTmFtZSwgaHJlZnMpID0+IHsKCQkJCWZvciBhd2FpdCAoY29uc3QgbiBvZiAoaHJlZnMgfHwgdGhpcy5ocmVmcykuZmlsdGVyKGwgPT4gbC5saWIgPT09IGxpYk5hbWUgJiYgdGhpcy5faW5jbHVkZShsKSkpIHsKCQkJCQluLnJlcXVpcmVzID0gbi5yZXF1aXJlcyB8fCBbXTsKCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHIgb2Ygbi5yZXF1aXJlcy5maWx0ZXIociA9PiByICE9IGxpYk5hbWUpKSB7CgkJCQkJCWF3YWl0IHRoaXMucmVxdWlyZShyLCBocmVmcyk7CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mKHRoaXMuX2NzcykgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJCWZvciAoY29uc3QgYyBvZiBBcnJheS5pc0FycmF5KG4uY3NzKSA/IG4uY3NzIDogW24uY3NzXSkgewoJCQkJCQkJdGhpcy5fY3NzKGMpOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXZhciBtb2R1bGVzID0gW107CgkJCQkJZm9yIGF3YWl0IChjb25zdCBzIG9mIEFycmF5LmlzQXJyYXkobi5zcmMpID8gbi5zcmMgOiBbbi5zcmNdKSB7CgkJCQkJCXRyeSB7CgkJCQkJCQlpZiAocy5OYW1lKSB7CgkJCQkJCQkJLy8gc3RvcmVkIHNjcmlwdAoJCQkJCQkJCWxldCBfc2MgPSBhd2FpdCBzci5fKCJDb250ZW50TWFuYWdlci5jbXNTdG9yZWRTY3JpcHRGaW5kIiwgbnVsbCwgcyk7CgkJCQkJCQkJYXdhaXQgc3IucnVuU2NyaXB0KF9zYy5TY3JpcHQpOwoJCQkJCQkJfSBlbHNlIGlmIChuLm1vZHVsZSkgewoJCQkJCQkJCW1vZHVsZXMucHVzaChhd2FpdCBpbXBvcnQocykpOwoJCQkJCQkJfSBlbHNlIGlmICh0eXBlb2YoJCkgIT09ICd1bmRlZmluZWQnICYmIHR5cGVvZigkLmFqYXgpICE9PSAndW5kZWZpbmVkJykgewoKCQkJCQkJCQlhd2FpdCAkLmFqYXgoewoJCQkJCQkJCQl1cmw6IG4uY2FjaGUgPyBzIDogdGhpcy5yYW5kVVJMKHMpLAoJCQkJCQkJCQlkYXRhVHlwZTogInNjcmlwdCIsCgkJCQkJCQkJCWNhY2hlOiBuLmNhY2hlID8gJ2ZvcmNlLWNhY2hlJyA6ICdkZWZhdWx0JwoJCQkJCQkJCX0pOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlhd2FpdCBuZXcgUHJvbWlzZShyID0+IHsKCQkJCQkJCQkJbGV0IHNjcmlwdCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpOwoJCQkJCQkJCQlzY3JpcHQub25sb2FkID0gKCkgPT4gcigpOwoJCQkJCQkJCQlzY3JpcHQuc3JjID0gczsKCQkJCQkJCQkJKGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuaGVhZCkuYXBwZW5kQ2hpbGQoc2NyaXB0KTsKCQkJCQkJCQl9KTsKCQkJCQkJCX0KCQkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJCWNvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBuLmxpYiArICJdIEV4Y2VwdGlvbjogIiArIGV4LCBzKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQlpZiAobi5sb2FkKSB7CgkJCQkJCXRyeSB7CgkJCQkJCQlhd2FpdCBuLmxvYWQobW9kdWxlcyk7CgkJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCQljb25zb2xlLmxvZygiRXhjZXB0aW9uIGluIGxvYWQoKSBvZiAiICsgbi5saWIsIGV4KTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJCWNvbnNvbGUubG9nKCJyZXF1aXJlWyIgKyBsaWJOYW1lICsgIl0iKTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChfaHJlZikgPT4gewoJCQkJcmV0dXJuICEoX2hyZWYuZGlzYWJsZWQgfHwgKF9ocmVmLnR5cGUgJiYgdGhpcy5pc01vYmlsZSgpICYmIF9ocmVmLnR5cGUgIT0gIm1vYmlsZSIpIHx8IChfaHJlZi50eXBlICYmICF0aGlzLmlzTW9iaWxlKCkgJiYgX2hyZWYudHlwZSA9PSAibW9iaWxlIikpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKCh2YWx1ZSwgdHlwZSkgPT4gewoJCQkJdHJ5IHsKCQkJCQlpZiAodHlwZW9mKGJlYXV0aWZpZXIpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQl2YXIgb3B0aW9ucyA9IHsKCQkJCQkJCSJpbmRlbnRfc2l6ZSI6ICIxIiwKCQkJCQkJCSJpbmRlbnRfY2hhciI6ICJcdCIsCgkJCQkJCQkibWF4X3ByZXNlcnZlX25ld2xpbmVzIjogIjIiLAoJCQkJCQkJInByZXNlcnZlX25ld2xpbmVzIjogdHJ1ZSwKCQkJCQkJCSJrZWVwX2FycmF5X2luZGVudGF0aW9uIjogZmFsc2UsCgkJCQkJCQkiYnJlYWtfY2hhaW5lZF9tZXRob2RzIjogZmFsc2UsCgkJCQkJCQkiaW5kZW50X3NjcmlwdHMiOiAibm9ybWFsIiwKCQkJCQkJCSJicmFjZV9zdHlsZSI6ICJjb2xsYXBzZSIsCgkJCQkJCQkic3BhY2VfYmVmb3JlX2NvbmRpdGlvbmFsIjogdHJ1ZSwKCQkJCQkJCSJ1bmVzY2FwZV9zdHJpbmdzIjogZmFsc2UsCgkJCQkJCQkianNsaW50X2hhcHB5IjogZmFsc2UsCgkJCQkJCQkiZW5kX3dpdGhfbmV3bGluZSI6IGZhbHNlLAoJCQkJCQkJIndyYXBfbGluZV9sZW5ndGgiOiAiMCIsCgkJCQkJCQkiaW5kZW50X2lubmVyX2h0bWwiOiBmYWxzZSwKCQkJCQkJCSJjb21tYV9maXJzdCI6IGZhbHNlLAoJCQkJCQkJImU0eCI6IHRydWUsCgkJCQkJCQkiaW5kZW50X2VtcHR5X2xpbmVzIjogZmFsc2UKCQkJCQkJfTsKCQkJCQkJaWYgKFsnY3NoYXJwJywgJ2phdmFzY3JpcHQnXS5pbmRleE9mKHR5cGUpID4gLTEpIHsKCQkJCQkJCXZhbHVlID0gYmVhdXRpZmllci5qcyh0eXBlb2YodmFsdWUpICE9PSAnc3RyaW5nJyA/IEpTT04uc3RyaW5naWZ5KHZhbHVlKSA6IHZhbHVlLCBvcHRpb25zKTsKCQkJCQkJfSBlbHNlIGlmIChbJ2h0bWwnXS5pbmRleE9mKHR5cGUpID4gLTEpIHsKCQkJCQkJCXZhbHVlID0gYmVhdXRpZmllci5odG1sKHZhbHVlLCBvcHRpb25zKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0gY2F0Y2ggKGV4KSB7fQoJCQkJcmV0dXJuIHZhbHVlOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCglieURlcGFydG1lbnQoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX2RlcGFydG1lbnQiXSAmJiAoYVsiX2RlcGFydG1lbnQiXS5FcXVhbHMgPyBhWyJfZGVwYXJ0bWVudCJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfZGVwYXJ0bWVudCJdLCByKSkpIHsKCQkJCQlyLl9kZXBhcnRtZW50X1VzZXJzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSBmYWxzZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLm5hbWUgPSB7fTsKCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgZXJyb3IubmFtZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IubmFtZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IubmFtZTsKCQl9CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlVzZXIuc3RvcmUnKTsgLy8gb3IgaW5zaWRlIGV4ZWN1dGU/CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJbGV0IGJVcGRhdGUgPSBmYWxzZTsKCQkJbGV0IGJJbnNlcnQgPSBmYWxzZTsKCgkJCWlmICghdGhpcy5fX3N5bmNfb24oKSkgewoJCQkJbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LlVzZXIobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLnVzZXJuYW1lKHRoaXMudXNlcm5hbWUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5jb2RlKHRoaXMuY29kZSgpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSB7CgkJCQkJdGhpcy5hY3RpdmUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSB7CgkJCQkJdGhpcy5lbmFibGVkKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgewoJCQkJCXRoaXMuZGF0ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSBuZXcgRGF0ZSgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9kZXBhcnRtZW50X3NldCAmJiB0aGlzLmRlcGFydG1lbnQoKSAmJiAhKGF3YWl0IHRoaXMuZGVwYXJ0bWVudCgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX2RlcGFydG1lbnQoKTsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBGaW5pc2hlZCBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0gSWQ9WyR7dGhpcy5JZH1dYCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50c19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLm1hbmFnZXJfRGVwYXJ0bWVudHMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuX2NhbGxlcl9JbmNpZGVudHNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5jYWxsZXJfSW5jaWRlbnRzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICh0aGlzLl9jb250YWN0X0luY2lkZW50c19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLmNvbnRhY3RfSW5jaWRlbnRzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICh0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy51c2VyX0dyb3VwX01lbWJlcnMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuVXNlci5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Vc2VyLnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuVXNlci5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCk7CgkJCQlyZXQgPSByZXQuY29udGVudCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5Vc2VyKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXRyeSB7CgkJCWlmIChkZXB0aCA+IDEpIHsKCQkJCWZvciBhd2FpdCAoY29uc3QgciBvZiByZXQpIHsKCgkJCQkJaWYgKHIuX2RlcGFydG1lbnRfc2V0KSB7CgkJCQkJCXIuZGVwYXJ0bWVudChhd2FpdCByLl9kZXBhcnRtZW50LmZpbmQoZGVwdGggLSAxKSk7CgkJCQkJfQoKCQkJCQlyLm1hbmFnZXJfRGVwYXJ0bWVudHMoYXdhaXQgbmV3IHNhbGVzbm93LkRlcGFydG1lbnQobnVsbCwgci5Ub29sKS5tYW5hZ2VyKHIpLmZpbmRBbGwoZGVwdGggLSAxKSk7CgoJCQkJCXIuY2FsbGVyX0luY2lkZW50cyhhd2FpdCBuZXcgc2FsZXNub3cuSW5jaWRlbnQobnVsbCwgci5Ub29sKS5jYWxsZXIocikuZmluZEFsbChkZXB0aCAtIDEpKTsKCgkJCQkJci5jb250YWN0X0luY2lkZW50cyhhd2FpdCBuZXcgc2FsZXNub3cuSW5jaWRlbnQobnVsbCwgci5Ub29sKS5jb250YWN0KHIpLmZpbmRBbGwoZGVwdGggLSAxKSk7CgoJCQkJCXIudXNlcl9Hcm91cF9NZW1iZXJzKGF3YWl0IG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIobnVsbCwgci5Ub29sKS51c2VyKHIpLmZpbmRBbGwoZGVwdGggLSAxKSk7CgoJCQkJfQoJCQl9CgoJCQlsZXQgcmVmcyA9IFtdOwoJCQlpZiAoIUFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gW3JldF07CgoJCQlyZWZzLnB1c2goLi4ucmV0LmZpbHRlcihyID0+IHIuRW50aXR5Q2xhc3MpKTsKCQkJZm9yIGF3YWl0IChjb25zdCBvIG9mIChvYmpzIHx8IFtdKSkgewoJCQkJbGV0IG9mYSA9IFtdOwoJCQkJaWYgKG8uX3RvRU1TT2JqZWN0KSB7CgkJCQkJb2ZhID0gYXdhaXQgdGhpcy5fZnJvbUVNU1ZhbHVlcyhhd2FpdCBvLl90b0VNU09iamVjdCh0cnVlLCB0cnVlKS5maW5kQWxsKGRlcHRoKSk7CgkJCQl9IGVsc2UgewoJCQkJCW9mYSA9IGF3YWl0IG8uZmluZEFsbChkZXB0aCk7CgkJCQl9CgkJCQlyZWZzLnB1c2goLi4ub2ZhKTsKCQkJfQoJCQlyZWZzID0gcmVmcy5maWx0ZXIociA9PiByKTsKCQkJcmVmcy5mb3JFYWNoKHIgPT4gewoJCQkJZm9yICh2YXIgcCBpbiByKSB7CgkJCQkJaWYgKHAuc3RhcnRzV2l0aCgnXycpICYmIHJbcF0gJiYgcltwICsgIl9zZXQiXSAmJiByW3BdLklkICYmIHJlZnMuZmluZChvID0+IG8uSWQgPT0gcltwXS5JZCkpIHsKCQkJCQkJcltwLnN1YnN0cmluZygxKV0ocmVmcy5maW5kKG8gPT4gby5JZCA9PSByW3BdLklkKSk7CgkJCQkJfQoJCQkJfQoJCQl9KTsKCgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ZpbmRSZWZlcmVuY2VzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgoJfQoKfTsKCnNhbGVzbm93LkRlcGFydG1lbnQgPSBjbGFzcyBEZXBhcnRtZW50IGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUXNLaTVmYkc5aFpGUnZiMnh6TENvdVlYVjBhRU52WkdVc1JYWmxiblF1YkdsemRHVnVMRVYyWlc1MExuQnliMk5sYzNNc1JYWmxiblF1ZEhKcFoyZGxjaUo5YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUp6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpWYzJWeUlqcDdJbDloZFhSb2IzSnBlbVV1ZFhObGNtNWhiV1VpT2lKbVlXUnBJaXdpWDJGMWRHaHZjbWw2WlM1d1lYTnpkMjl5WkNJNklqRXlNeUlzSWw5aGRYUm9iM0pwZW1VdWRHVnpkRlZ6WlhJaU9uc2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0puWlc1a1pYSWlPbnNpWTI5a1pTSTZJazBpTENKdVlXMWxJam9pVFdGc1pTSjlMQ0pqYjJSbElqb2labUZrYVNJc0ltNWhiV1VpT2lKR1lXUnBJbjE5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpQUVhWMGFGTmhibVFpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibWFuYWdlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbWFuYWdlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfZGVwYXJ0bWVudF9Vc2VycygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIkRlcGFydG1lbnQiLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCS8vIGlmKHRoaXMuX21hbmFnZXJfc2V0ICYmIHRoaXMuX21hbmFnZXIpIHRoaXMuX21hbmFnZXIuVG9vbCA9IHRvb2w7CgoJCS8vICh0aGlzLmRlcGFydG1lbnRfVXNlcnMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbWFuYWdlciAqKi8KCW1hbmFnZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9tYW5hZ2VyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibWFuYWdlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2I1OGI3MDM2LTY1MTktNDZlYS1hZjY4LTUxMjNmZDQ2YjFlZScgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ1VzZXInKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnbWFuYWdlcicsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgImI1OGI3MDM2LTY1MTktNDZlYS1hZjY4LTUxMjNmZDQ2YjFlZSIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJVc2VyIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX21hbmFnZXIgIT0gdikgewoJCQkJdGhpcy5fbWFuYWdlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ21hbmFnZXInLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX21hbmFnZXIgPyB0aGlzLl9tYW5hZ2VyLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9tYW5hZ2VyX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9tYW5hZ2VyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX21hbmFnZXIpOwoJCX0KCX0KCgljbGVhcl9tYW5hZ2VyKCkgewoJCXRoaXMuX21hbmFnZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9tYW5hZ2VyID0gbnVsbDsKCQl0aGlzLl9tYW5hZ2VyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBtYW5hZ2VyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGVwYXJ0bWVudF9Vc2VycyAqKi8KCWRlcGFydG1lbnRfVXNlcnModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX2RlcGFydG1lbnRfVXNlcnM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2I1OGI3MDM2LTY1MTktNDZlYS1hZjY4LTUxMjNmZDQ2YjFlZScgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnVXNlcicpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fZGVwYXJ0bWVudF9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdkZXBhcnRtZW50X1VzZXJzJywgJ0VudGl0eU9iamVjdCcsIDEsICJkZXBhcnRtZW50IGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJVc2VyIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZGVwYXJ0bWVudF9Vc2VycycsICdFbnRpdHlPYmplY3QnLCAxLCAiZGVwYXJ0bWVudCBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIlVzZXIiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YuZGVwYXJ0bWVudCh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9kZXBhcnRtZW50X1VzZXJzLnB1c2goLi4udik7CgkJdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfZGVwYXJ0bWVudF9Vc2VycygpIHsKCQl0aGlzLl9kZXBhcnRtZW50X1VzZXJzX3NldCA9IG51bGw7CgkJdGhpcy5fZGVwYXJ0bWVudF9Vc2VycyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX2RlcGFydG1lbnRfVXNlcnNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkZXBhcnRtZW50X1VzZXJzICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fbWFuYWdlcl9zZXQsCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9tYW5hZ2VyX3NldCA9IHRoaXMuX21hbmFnZXJfc2V0OwoJCXJldC5fbWFuYWdlcl9jb29wID0gdGhpcy5fbWFuYWdlcl9jb29wOwoJCXJldC5tYW5hZ2VyID0gdGhpcy5tYW5hZ2VyKCkgPyB0aGlzLm1hbmFnZXIoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5tYW5hZ2VyKCk7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5kZXBhcnRtZW50X1VzZXJzID0gdGhpcy5kZXBhcnRtZW50X1VzZXJzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJtYW5hZ2VyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQlkZXBhcnRtZW50X1VzZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudF9EZXBhcnRtZW50cycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJtYW5hZ2VyIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBtYW5hZ2VyJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Vc2VyKCkubWFuYWdlcl9EZXBhcnRtZW50cyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpICE9ICdEZXBhcnRtZW50JykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL0RlcGFydG1lbnQvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQkJZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOwoJCQkJZGVsZXRlIGRhdGEuX190aGlzLm9ubGluZTsKCgkJCX0KCgkJCS8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/PwoKCQkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJCXRyeSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0pIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7bWV0aG9kfWApOwoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCWxldCBfaWQgPSBudWxsOwoJCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBkYXRhLCBtZXRob2QsIHt9KTsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRhdGEpID09PSAnc3RyaW5nJykgewoJCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUoZGF0YSk7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IGRhdGEuX190aGlzLmNvZGUgfHwgZGF0YS5pZCB8fCBkYXRhLklEOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJCWlmIChkYXRhLklkICYmIGRhdGEuSWQgPT0gZGF0YS5JZCkgewoJCQkJCQlfaWQgPSBkYXRhLklkOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQkJfSBlbHNlIGlmIChkYXRhLkVudGl0eUNsYXNzKSB7CgkJCQkJCV9pZCA9IGRhdGEuRW50aXR5Q2xhc3MuSWQgfHwgZGF0YS5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjQyY2Y2MGRmLWE4MDEtNDA5OC04MWI2LThlYzY0ZTZlYmZmOCIgfHwgIk5VTEwiOwoJCQkJCX0KCQkJCX0KCgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudCB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFttZXRob2RdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W21ldGhvZF0gfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnRbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W21ldGhvZF1bX2lkXSB8fCB7fTsKCgkJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goe30sIHsKCQkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQkJfSk7CgoJCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFttZXRob2RdW19pZF1bX2hhc2hdOwoJCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiA1KSkgewoJCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gbWV0aG9kIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJCXYucmV1c2VkKys7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhKTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnRGVwYXJ0bWVudCcpLnNlbmRlcihzYWxlc25vdy5fbm9kZSkuY2FycmllcihzYWxlc25vdy5fbm9kZSkucGF5bG9hZChkYXRhKTsKCQkJaWYgKGV2ZW50KSB7CgkJCQlpZiAoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7CgkJCQlpZiAoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7CgkJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7CgkJCQlpZiAoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7CgkJCX0KCQkJcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOwoKCQkJaWYgKHR5cGVvZihyZXQpID09PSAic3RyaW5nIikgewoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChleCkge30KCQkJfQoJCQlyZXR1cm4gcmV0OwoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LkRlcGFydG1lbnQobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93LkRlcGFydG1lbnQobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudCgpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOwoJCX0KCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgRGVwYXJ0bWVudC5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYERlcGFydG1lbnQuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudC5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5EZXBhcnRtZW50LicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlIHx8ICJEZXBhcnRtZW50Iik7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCWlmICh0aGlzLl9tYW5hZ2VyX3NldCAmJiB0aGlzLm1hbmFnZXIoKSkgdGhpcy5tYW5hZ2VyKCkuX19zeW5jX29uKGQpOwoKCQkJLy8gdGhpcy5kZXBhcnRtZW50X0RlcGFydG1lbnRzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudCh0aGlzLklkKQoKCQkJLm1hbmFnZXIodGhpcy5tYW5hZ2VyKCksIHRoaXMuX21hbmFnZXJfY29vcCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkuZGVwYXJ0bWVudF9Vc2Vycyh0aGlzLmRlcGFydG1lbnRfVXNlcnMoKSwgdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCW9ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdEZXBhcnRtZW50JzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiRGVwYXJ0bWVudCI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgkJCQlyZXQgPSByZXQudG9Mb3dlckNhc2UoKTsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucyA9IHt9KSB7CgkJdHJ5IHsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sID8gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IG9wdGlvbnMudG9vbCB8fCB0ID09IG9wdGlvbnMudG9vbCkgOiB0aGlzLlRvb2w7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCB8fCB7fTsKCgkJCWxldCBuSUQgPSBzYWxlc25vdy5fbm9kZSA/IHNhbGVzbm93Ll9ub2RlLmNvZGUoKSA6ICJkZWZhdWx0IjsKCgkJCWxldCByZXQgPSBudWxsVmFsdWU7CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldCA9IG51bGw7CgoJCQkvLyB0b29sX0NvbmZpZ3M6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gZG9uZQoJCQlsZXQgdGNvbmYgPSAob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgYy5ub2RlICYmIGMubm9kZS5jb2RlID09IG5JRCkuY29uY2F0KChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiAhYy5ub2RlKSk7CgkJCWlmICh0Y29uZi5sZW5ndGgpIHsKCQkJCXJldCA9IHRjb25mWzBdLnZhbHVlOwoJCQkJdHJ5IHsKCQkJCQlbMSwgMiwgM10uZm9yRWFjaChhID0+IHJldCA9IEpTT04ucGFyc2UocmV0KSk7CgkJCQl9IGNhdGNoIChqZXgpIHt9CgkJCX0KCgkJCS8vIG1vZGVsIENvbmZpZzogQ29uZmlnIGlzIGNsYXNzIGxldmVsLCBub2RlIG5vdCBwb3NzaWJsZSAtIHBlbmRpbmcKCQkJbGV0IG1jb25mID0gdGhpcy5Db25maWcgPyB0aGlzLkNvbmZpZ1tuXSA6IHVuZGVmaW5lZDsKCQkJaWYgKHR5cGVvZihtY29uZikgIT09ICJ1bmRlZmluZWQiKSByZXQgPSBtY29uZjsKCgkJCS8vIGNvbW1hbmQgbGluZTogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgZ2xvYmFsLm1pbmltaXN0KSB7CgkJCQlyZXQgPSBnbG9iYWwubWluaW1pc3QocHJvY2Vzcy5hcmd2LnNsaWNlKDIpKVtuXSB8fCByZXQ7CgkJCX0KCgkJCS8vIHJlcXVlc3Q6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlyZXQgPSB0aGlzLiRfUkVRVUVTVChuKSB8fCByZXQ7CgoJCQlpZiAob3B0aW9ucy5uZXdWYWx1ZSkgewoJCQkJbGV0IHRjID0gdGNvbmYubGVuZ3RoID8gdGNvbmZbMF0gOiB7fTsKCQkJCXRjLm5vZGUgPSB7CgkJCQkJY29kZTogb3B0aW9ucy5ub2RlLmNvZGUoKQoJCQkJfTsKCQkJCXRjLnZhbHVlID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJCXRjLm5hbWUgPSBuOwoJCQkJaWYgKCF0Y29uZi5sZW5ndGgpIHsKCQkJCQlvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLnB1c2godGMpOwoJCQkJfQoJCQkJcmV0ID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJfQoKCQkJLy8gY29uZmlnIHJlcGxhY2VtZW50CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3N0cmluZycpKHJldC5tYXRjaChuZXcgUmVnRXhwKGB7eyhbXn1dKyl9fWAsICJnIikpIHx8IFtdKS5mb3JFYWNoKG0gPT4gcmV0ID0gcmV0LnJlcGxhY2UobSwgdGhpcy5fX2NvbmZpZyhtLnJlcGxhY2UoJ3t7JywgJycpLnJlcGxhY2UoJ319JywgJycpLCBudWxsLCBvcHRpb25zKSkpOwoKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2NvbmZpZycsICdFbnRpdHlPYmplY3QnLCAxLCBuLCBudWxsVmFsdWUsIG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MsIGV4KTsKCQl9Cgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgoJCQkJCS8vIGlmKHRoaXNbJ18nK2ZpZWxkKydfc2V0J10gJiYgKHR5cGVvZih0aGlzWydfJytmaWVsZF0pPT09J3VuZGVmaW5lZCcgfHwgdGhpc1snXycrZmllbGRdPT1udWxsKSkgcmV0dXJuOwoJCQkJCS8vIGlmKHR5cGVvZihlYU9iaik9PT0ndW5kZWZpbmVkJykgcmV0dXJuOyAvLyB3aHk/CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlyZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqLCB0aGlzLmNvZGUoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmosIHRoaXMuZGF0ZSgpKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmosIHRoaXMubmFtZSgpKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaiwgdGhpcy5yZW1hcmsoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI0MmNmNjBkZi1hODAxLTQwOTgtODFiNi04ZWM2NGU2ZWJmZjgiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudCB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnRbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCWlmICghdGhpcy5tYW5hZ2VyKCkgfHwgKHRoaXMubWFuYWdlcigpCgoJCQkJJiYKCQkJCSF0aGlzLm1hbmFnZXIoKS5tYW5hZ2VyX0RlcGFydG1lbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLm1hbmFnZXIoKS5jYWxsZXJfSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLm1hbmFnZXIoKS5jb250YWN0X0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5tYW5hZ2VyKCkudXNlcl9Hcm91cF9NZW1iZXJzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJtYW5hZ2VyIiwgb2JqLCB0aGlzLm1hbmFnZXIoKSk7CgkJfQoKCQlfb3B0aW9ucygiZGVwYXJ0bWVudF9Vc2VycyIsIG9iaiwgdGhpcy5kZXBhcnRtZW50X1VzZXJzKCkpOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydtYW5hZ2VyJywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydkZXBhcnRtZW50X1VzZXJzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJEZXBhcnRtZW50IiAmJiAobS50YXJnZXQgfHwgbS5vdXRTY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkgJiYgKCFtLnNvdXJjZSB8fCAobS5zb3VyY2UgJiYgLyohbS5vdXRTY3JpcHQgJiYqLyB0aGlzWydfJyArIG0uc291cmNlICsgJ19zZXQnXSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0ub3V0U2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5vdXRTY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5vdXRTY3JpcHR9KX1gKSh0aGlzLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS5zb3VyY2UpIHsKCQkJCWlmIChtLnNvdXJjZS5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMpID0+IHtyZXR1cm4gX3RoaXMuJHttLnNvdXJjZX07fWApKHRoaXMpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS5zb3VyY2UsIHRoaXMpOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnRhcmdldCkgb2JqW20udGFyZ2V0XSA9IHJldDsKCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJW20udGFyZ2V0IHx8IG0uc291cmNlXTogdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddCgkJCX0pOwoJCX0pOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCS8vIHVzZSB0aGlzLl9tYXAoKSB3aXRoIHJldmVyc2UKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmopOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiNDJjZjYwZGYtYTgwMS00MDk4LTgxYjYtOGVjNjRlNmViZmY4IiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnQgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnQgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnRbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcyk7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJtYW5hZ2VyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRlcGFydG1lbnRfVXNlcnMiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydtYW5hZ2VyJywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydkZXBhcnRtZW50X1VzZXJzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJEZXBhcnRtZW50IiAmJiAobS5zb3VyY2UgfHwgbS5pblNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLmluU2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaiwgb1Njb3BlLCBtYXApID0+IHske20uaW5TY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5pblNjcmlwdH0pfWApKG9iaiwgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0udGFyZ2V0KSB7CgkJCQlpZiAobS50YXJnZXQuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaikgPT4ge3JldHVybiBvYmouJHttLnRhcmdldH07fWApKG9iaik7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmpbbS50YXJnZXRdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS50YXJnZXQsIG9iaik7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS5zb3VyY2UpIHsKCQkJCWlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0ocmV0KTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0gPSByZXQ7CgkJCQl9CgkJCX0KCQl9KTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5EZXBhcnRtZW50KSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLkRlcGFydG1lbnQgPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJEZXBhcnRtZW50IikgcmV0dXJuIGZhbHNlOwoKCQkJbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJCUZ1bGw6IHRydWUsCgkJCQlOdWxsOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5faWQgPSB0aGlzLklkID09IHF1ZXJ5LklkLAoKCQkJCW1hbmFnZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm1hbmFnZXIgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5Lm1hbmFnZXIoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbWFuYWdlcl9zZXQgJiYgIXF1ZXJ5Ll9tYW5hZ2VyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5tYW5hZ2VyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX21hbmFnZXJfc2V0ICYmIHF1ZXJ5Ll9tYW5hZ2VyX3NldCkgfHwKCgkJCQkJCSh0aGlzLm1hbmFnZXIoKSAmJiAhdGhpcy5tYW5hZ2VyKCkuX21hdGNoZXMocXVlcnkubWFuYWdlcigpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubWFuYWdlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGVwYXJ0bWVudF9Vc2VyczogKG9iaiwgdikgPT4gewoJCQkJCW9iai5kZXBhcnRtZW50X1VzZXJzID0gdi5tYXAoX3YgPT4gcXVlcnkuZGVwYXJ0bWVudF9Vc2VycygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJbWFuYWdlcjogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIG1hbmFnZXIiKTsKCQkJCQlvYmoubWFuYWdlciA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCWRlcGFydG1lbnRfVXNlcnM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouZGVwYXJ0bWVudF9Vc2VycyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fbWFuYWdlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCW1hbmFnZXI6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5tYW5hZ2VyKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlkZXBhcnRtZW50X1VzZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuZGVwYXJ0bWVudF9Vc2VycygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCW1hbmFnZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdtYW5hZ2VyJywgdW5kZWZpbmVkKSA6ICJtYW5hZ2VyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX21hbmFnZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMubWFuYWdlcigpIHx8IG5ldyBzYWxlc25vdy5Vc2VyKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5tYW5hZ2VyKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgbWFuYWdlciIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJZGVwYXJ0bWVudF9Vc2VyczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RlcGFydG1lbnRfRGVwYXJ0bWVudHMnLCB1bmRlZmluZWQpIDogImRlcGFydG1lbnRfVXNlcnMiKSkgPT4gdGhpcy5kZXBhcnRtZW50X1VzZXJzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddID0gdiwKCgkJCSJtYW5hZ2VyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpIDogIm1hbmFnZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl9tYW5hZ2VyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9tYW5hZ2VyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3JkZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGw7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIG9ialtlYUNvZGVdID0gb2JqW2VhQ29kZV0ucmVwbGFjZSgvXC5bMC05XSpaL2csICcnKTsKCgkJCQlpZiAodGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGF0ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9uYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9uYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3JlbWFya19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQlkZXBhcnRtZW50X1VzZXJzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudF9EZXBhcnRtZW50cycsIHVuZGVmaW5lZCkgOiAiZGVwYXJ0bWVudF9Vc2VycyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9kZXBhcnRtZW50X1VzZXJzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kZXBhcnRtZW50X1VzZXJzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCglieVVzZXIoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX21hbmFnZXIiXSAmJiAoYVsiX21hbmFnZXIiXS5FcXVhbHMgPyBhWyJfbWFuYWdlciJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfbWFuYWdlciJdLCByKSkpIHsKCQkJCQlyLl9tYW5hZ2VyX0RlcGFydG1lbnRzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSB0cnVlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuRGVwYXJ0bWVudC5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudChudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMubmFtZSh0aGlzLm5hbWUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fbWFuYWdlcl9zZXQgJiYgdGhpcy5tYW5hZ2VyKCkgJiYgIShhd2FpdCB0aGlzLm1hbmFnZXIoKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9tYW5hZ2VyKCk7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fX2Fzc2VydFZhbGlkKHRydWUpKSByZXR1cm4gbnVsbDsKCgkJCQkvL2F3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8gaW4gY2FzZSBUb29sIGNoYW5nZXMKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgQWJvdXQgdG8gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9YCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgRmluaXNoZWQgSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9IElkPVske3RoaXMuSWR9XWApOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX2RlcGFydG1lbnRfVXNlcnNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5kZXBhcnRtZW50X1VzZXJzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkRlcGFydG1lbnQuaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuRGVwYXJ0bWVudC51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkRlcGFydG1lbnQuZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2ApOwoJCQkJcmV0ID0gcmV0LmNvbnRlbnQgPyBbSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSldIDogW107CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5tYXAociA9PiBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93LlByaW9yaXR5ID0gY2xhc3MgUHJpb3JpdHkgZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRc0tpNWZiRzloWkZSdmIyeHpMQ291WVhWMGFFTnZaR1VzUlhabGJuUXViR2x6ZEdWdUxFVjJaVzUwTG5CeWIyTmxjM01zUlhabGJuUXVkSEpwWjJkbGNpSjlgKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlBRWFYwYUZOaGJtUWlMQ0pIYVhSSWRXSWlYUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2FjdGl2ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2VuYWJsZWQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb2RlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb2RlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3JkZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29yZGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZGF0ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZGF0ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm5hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX25hbWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3JlbWFyaygpOwoKCQl0aGlzLmNsZWFyX3ByaW9yaXR5X0luY2lkZW50cygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIlByaW9yaXR5IiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQkvLyAodGhpcy5wcmlvcml0eV9JbmNpZGVudHMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcHJpb3JpdHlfSW5jaWRlbnRzICoqLwoJcHJpb3JpdHlfSW5jaWRlbnRzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9wcmlvcml0eV9JbmNpZGVudHM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzViZWUyMzRjLTVlNDMtNDRjYS04ZTBmLTQwMmMyYWRlMTkzNCcgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnSW5jaWRlbnQnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX3ByaW9yaXR5X3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3ByaW9yaXR5X0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAicHJpb3JpdHkgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkluY2lkZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAncHJpb3JpdHlfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJwcmlvcml0eSBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkluY2lkZW50Iik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LnByaW9yaXR5KHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX3ByaW9yaXR5X0luY2lkZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9wcmlvcml0eV9JbmNpZGVudHMoKSB7CgkJdGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzX3NldCA9IG51bGw7CgkJdGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcHJpb3JpdHlfSW5jaWRlbnRzICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJCXRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0LnByaW9yaXR5X0luY2lkZW50cyA9IHRoaXMucHJpb3JpdHlfSW5jaWRlbnRzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQlwcmlvcml0eV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwcmlvcml0eV9Qcmlvcml0eXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkgIT0gJ1ByaW9yaXR5JykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL1ByaW9yaXR5LyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7CgoJCQl9CgoJCQkvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8KCgkJCWxldCB2ID0gdW5kZWZpbmVkOwoJCQl0cnkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke21ldGhvZH1gKTsKCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQlsZXQgX2lkID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgZGF0YSwgbWV0aG9kLCB7fSk7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIHsKCQkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKGRhdGEpOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSBkYXRhLl9fdGhpcy5jb2RlIHx8IGRhdGEuaWQgfHwgZGF0YS5JRDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCQlpZiAoZGF0YS5JZCAmJiBkYXRhLklkID09IGRhdGEuSWQpIHsKCQkJCQkJX2lkID0gZGF0YS5JZDsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5FbnRpdHlDbGFzcykgewoJCQkJCQlfaWQgPSBkYXRhLkVudGl0eUNsYXNzLklkIHx8IGRhdGEuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJiYmYwNjc1ZC01YjgxLTQzOWYtOWIyMy04MWI5ODNmZmJjZGEiIHx8ICJOVUxMIjsKCQkJCQl9CgkJCQl9CgoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbbWV0aG9kXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVttZXRob2RdW19pZF0gfHwge307CgoJCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKHt9LCB7CgkJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJCX0pOwoKCQkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnUHJpb3JpdHknKS5zZW5kZXIoc2FsZXNub3cuX25vZGUpLmNhcnJpZXIoc2FsZXNub3cuX25vZGUpLnBheWxvYWQoZGF0YSk7CgkJCWlmIChldmVudCkgewoJCQkJaWYgKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOwoJCQkJaWYgKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOwoJCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJaWYgKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOwoJCQl9CgkJCXJldCA9IGF3YWl0IGV2LnRyaWdnZXIoKTsKCgkJCWlmICh0eXBlb2YocmV0KSA9PT0gInN0cmluZyIpIHsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCX0KCQkJcmV0dXJuIHJldDsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5Qcmlvcml0eShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuUHJpb3JpdHkobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuUHJpb3JpdHkoKS5faW52b2tlTm9kZSh0biwgbWV0aG9kLCBfcGFyYW1zKTsKCQl9CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYFByaW9yaXR5Ll9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgUHJpb3JpdHkuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHkuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuUHJpb3JpdHkuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIlByaW9yaXR5Iik7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCS8vIHRoaXMucHJpb3JpdHlfUHJpb3JpdHlzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuUHJpb3JpdHkodGhpcy5JZCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkucHJpb3JpdHlfSW5jaWRlbnRzKHRoaXMucHJpb3JpdHlfSW5jaWRlbnRzKCksIHRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCW9ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdQcmlvcml0eSc7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIlByaW9yaXR5IjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCQkJCXJldCA9IHJldC50b0xvd2VyQ2FzZSgpOwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCQl0cnkgewoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgPyAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gb3B0aW9ucy50b29sIHx8IHQgPT0gb3B0aW9ucy50b29sKSA6IHRoaXMuVG9vbDsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sIHx8IHt9OwoKCQkJbGV0IG5JRCA9IHNhbGVzbm93Ll9ub2RlID8gc2FsZXNub3cuX25vZGUuY29kZSgpIDogImRlZmF1bHQiOwoKCQkJbGV0IHJldCA9IG51bGxWYWx1ZTsKCQkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0ID0gbnVsbDsKCgkJCS8vIHRvb2xfQ29uZmlnczogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBkb25lCgkJCWxldCB0Y29uZiA9IChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiBjLm5vZGUgJiYgYy5ub2RlLmNvZGUgPT0gbklEKS5jb25jYXQoKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmICFjLm5vZGUpKTsKCQkJaWYgKHRjb25mLmxlbmd0aCkgewoJCQkJcmV0ID0gdGNvbmZbMF0udmFsdWU7CgkJCQl0cnkgewoJCQkJCVsxLCAyLCAzXS5mb3JFYWNoKGEgPT4gcmV0ID0gSlNPTi5wYXJzZShyZXQpKTsKCQkJCX0gY2F0Y2ggKGpleCkge30KCQkJfQoKCQkJLy8gbW9kZWwgQ29uZmlnOiBDb25maWcgaXMgY2xhc3MgbGV2ZWwsIG5vZGUgbm90IHBvc3NpYmxlIC0gcGVuZGluZwoJCQlsZXQgbWNvbmYgPSB0aGlzLkNvbmZpZyA/IHRoaXMuQ29uZmlnW25dIDogdW5kZWZpbmVkOwoJCQlpZiAodHlwZW9mKG1jb25mKSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IG1jb25mOwoKCQkJLy8gY29tbWFuZCBsaW5lOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiBnbG9iYWwubWluaW1pc3QpIHsKCQkJCXJldCA9IGdsb2JhbC5taW5pbWlzdChwcm9jZXNzLmFyZ3Yuc2xpY2UoMikpW25dIHx8IHJldDsKCQkJfQoKCQkJLy8gcmVxdWVzdDogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCXJldCA9IHRoaXMuJF9SRVFVRVNUKG4pIHx8IHJldDsKCgkJCWlmIChvcHRpb25zLm5ld1ZhbHVlKSB7CgkJCQlsZXQgdGMgPSB0Y29uZi5sZW5ndGggPyB0Y29uZlswXSA6IHt9OwoJCQkJdGMubm9kZSA9IHsKCQkJCQljb2RlOiBvcHRpb25zLm5vZGUuY29kZSgpCgkJCQl9OwoJCQkJdGMudmFsdWUgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQkJdGMubmFtZSA9IG47CgkJCQlpZiAoIXRjb25mLmxlbmd0aCkgewoJCQkJCW9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MucHVzaCh0Yyk7CgkJCQl9CgkJCQlyZXQgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQl9CgoJCQkvLyBjb25maWcgcmVwbGFjZW1lbnQKCQkJaWYgKHR5cGVvZihyZXQpID09PSAnc3RyaW5nJykocmV0Lm1hdGNoKG5ldyBSZWdFeHAoYHt7KFtefV0rKX19YCwgImciKSkgfHwgW10pLmZvckVhY2gobSA9PiByZXQgPSByZXQucmVwbGFjZShtLCB0aGlzLl9fY29uZmlnKG0ucmVwbGFjZSgne3snLCAnJykucmVwbGFjZSgnfX0nLCAnJyksIG51bGwsIG9wdGlvbnMpKSk7CgoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fY29uZmlnJywgJ0VudGl0eU9iamVjdCcsIDEsIG4sIG51bGxWYWx1ZSwgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncywgZXgpOwoJCX0KCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCgkJCQkJLy8gaWYodGhpc1snXycrZmllbGQrJ19zZXQnXSAmJiAodHlwZW9mKHRoaXNbJ18nK2ZpZWxkXSk9PT0ndW5kZWZpbmVkJyB8fCB0aGlzWydfJytmaWVsZF09PW51bGwpKSByZXR1cm47CgkJCQkJLy8gaWYodHlwZW9mKGVhT2JqKT09PSd1bmRlZmluZWQnKSByZXR1cm47IC8vIHdoeT8KCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCXJldHVybiBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgImJiZjA2NzVkLTViODEtNDM5Zi05YjIzLTgxYjk4M2ZmYmNkYSIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHkgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlfb3B0aW9ucygicHJpb3JpdHlfSW5jaWRlbnRzIiwgb2JqLCB0aGlzLnByaW9yaXR5X0luY2lkZW50cygpKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3ByaW9yaXR5X0luY2lkZW50cyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlmYWxzZSAmJiBbXS5jb25jYXQodGhpcy5Ub29sLnR5cGUudHlwZV9NYXBwaW5ncyB8fCBbXSkuY29uY2F0KHRoaXMuVG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5maWx0ZXIobSA9PiBtLmNsYXNzTmFtZSA9PSAiUHJpb3JpdHkiICYmIChtLnRhcmdldCB8fCBtLm91dFNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSAmJiAoIW0uc291cmNlIHx8IChtLnNvdXJjZSAmJiAvKiFtLm91dFNjcmlwdCAmJiovIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX3NldCddKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5vdXRTY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMsIG9TY29wZSwgbWFwKSA9PiB7JHttLm91dFNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLm91dFNjcmlwdH0pfWApKHRoaXMsIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnNvdXJjZSkgewoJCQkJaWYgKG0uc291cmNlLmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcykgPT4ge3JldHVybiBfdGhpcy4ke20uc291cmNlfTt9YCkodGhpcyk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnNvdXJjZSwgdGhpcyk7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0udGFyZ2V0KSBvYmpbbS50YXJnZXRdID0gcmV0OwoJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQlbbS50YXJnZXQgfHwgbS5zb3VyY2VdOiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10KCQkJfSk7CgkJfSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJLy8gdXNlIHRoaXMuX21hcCgpIHdpdGggcmV2ZXJzZQoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJiYmYwNjc1ZC01YjgxLTQzOWYtOWIyMy04MWI5ODNmZmJjZGEiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHkgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5IHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcyk7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygicHJpb3JpdHlfSW5jaWRlbnRzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3ByaW9yaXR5X0luY2lkZW50cyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaikpOwoKCQlmYWxzZSAmJiBbXS5jb25jYXQodGhpcy5Ub29sLnR5cGUudHlwZV9NYXBwaW5ncyB8fCBbXSkuY29uY2F0KHRoaXMuVG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5maWx0ZXIobSA9PiBtLmNsYXNzTmFtZSA9PSAiUHJpb3JpdHkiICYmIChtLnNvdXJjZSB8fCBtLmluU2NyaXB0KSAmJiBtLmFjdGl2ZSAmJiBtLmVuYWJsZWQgJiYgKChtLnRvb2wgJiYgbS50b29sLm5hbWUgPT0gdGhpcy5Ub29sLm5hbWUpIHx8IChtLnR5cGUgJiYgbS50eXBlLm5hbWUgPT0gdGhpcy5Ub29sLnR5cGUubmFtZSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0uaW5TY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAob2JqLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5pblNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLmluU2NyaXB0fSl9YCkob2JqLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS50YXJnZXQpIHsKCQkJCWlmIChtLnRhcmdldC5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAob2JqKSA9PiB7cmV0dXJuIG9iai4ke20udGFyZ2V0fTt9YCkob2JqKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKG9ialttLnRhcmdldF0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gb2JqW20udGFyZ2V0XSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnRhcmdldCwgb2JqKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gb2JqW20udGFyZ2V0XTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnNvdXJjZSkgewoJCQkJaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQl0aGlzW20uc291cmNlXShyZXQpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzW20uc291cmNlXSA9IHJldDsKCQkJCX0KCQkJfQoJCX0pOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlByaW9yaXR5KSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlByaW9yaXR5ID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiUHJpb3JpdHkiKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCXByaW9yaXR5X0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5wcmlvcml0eV9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBxdWVyeS5wcmlvcml0eV9JbmNpZGVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXByaW9yaXR5X0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5wcmlvcml0eV9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJcHJpb3JpdHlfSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMucHJpb3JpdHlfSW5jaWRlbnRzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ107CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJcHJpb3JpdHlfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncHJpb3JpdHlfUHJpb3JpdHlzJywgdW5kZWZpbmVkKSA6ICJwcmlvcml0eV9JbmNpZGVudHMiKSkgPT4gdGhpcy5wcmlvcml0eV9JbmNpZGVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddID0gdiwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCXByaW9yaXR5X0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3ByaW9yaXR5X1ByaW9yaXR5cycsIHVuZGVmaW5lZCkgOiAicHJpb3JpdHlfSW5jaWRlbnRzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuX25hbWU7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IGZhbHNlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuUHJpb3JpdHkuc3RvcmUnKTsgLy8gb3IgaW5zaWRlIGV4ZWN1dGU/CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJbGV0IGJVcGRhdGUgPSBmYWxzZTsKCQkJbGV0IGJJbnNlcnQgPSBmYWxzZTsKCgkJCWlmICghdGhpcy5fX3N5bmNfb24oKSkgewoJCQkJbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LlByaW9yaXR5KG51bGwsIHRoaXMuVG9vbCk7CgoJCQkJbGV0IGJGaW5kID0gZmFsc2U7CgkJCQlpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLklkID0gdGhpcy5JZDsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5jb2RlKHRoaXMuY29kZSgpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSB7CgkJCQkJdGhpcy5hY3RpdmUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSB7CgkJCQkJdGhpcy5lbmFibGVkKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgewoJCQkJCXRoaXMuZGF0ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSBuZXcgRGF0ZSgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fX2Fzc2VydFZhbGlkKHRydWUpKSByZXR1cm4gbnVsbDsKCgkJCQkvL2F3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8gaW4gY2FzZSBUb29sIGNoYW5nZXMKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgQWJvdXQgdG8gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9YCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgRmluaXNoZWQgSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9IElkPVske3RoaXMuSWR9XWApOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLnByaW9yaXR5X0luY2lkZW50cygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBpbnNlcnQoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Qcmlvcml0eS5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Qcmlvcml0eS51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlByaW9yaXR5LmZpbmRBbGwnKTsKCgkJCS8vIGF2b2lkcyBjeWNsaWMgcXVlcmllcwoJCQlvYmpzID0gKG9ianMgfHwgW10pLm1hcChvID0+IG8uX2Nsb25lKCkpOwoKCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLz8/CgoJCQlsZXQgcmV0ID0gW107IC8vIGEganNvbiBhcnJheQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgKTsKCQkJCXJldCA9IHJldC5jb250ZW50ID8gW0pTT04ucGFyc2UodGhpcy5fYXRvYihyZXQuY29udGVudCkpXSA6IFtdOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiQmVmb3JlIF9mcm9tRG9jdW1lbnQoKSIsIHJldCk7CgoJCQlyZXQgPSByZXQubWFwKHIgPT4gbmV3IHNhbGVzbm93LlByaW9yaXR5KG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuUmVhc29uID0gY2xhc3MgUmVhc29uIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUXNLaTVmYkc5aFpGUnZiMnh6TENvdVlYVjBhRU52WkdVc1JYWmxiblF1YkdsemRHVnVMRVYyWlc1MExuQnliMk5sYzNNc1JYWmxiblF1ZEhKcFoyZGxjaUo5YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUp6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpWYzJWeUlqcDdJbDloZFhSb2IzSnBlbVV1ZFhObGNtNWhiV1VpT2lKbVlXUnBJaXdpWDJGMWRHaHZjbWw2WlM1d1lYTnpkMjl5WkNJNklqRXlNeUlzSWw5aGRYUm9iM0pwZW1VdWRHVnpkRlZ6WlhJaU9uc2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0puWlc1a1pYSWlPbnNpWTI5a1pTSTZJazBpTENKdVlXMWxJam9pVFdGc1pTSjlMQ0pqYjJSbElqb2labUZrYVNJc0ltNWhiV1VpT2lKR1lXUnBJbjE5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpQUVhWMGFGTmhibVFpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgkJdGhpcy5jbGVhcl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiUmVhc29uIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQkvLyAodGhpcy5jbG9zZV9yZWFzb25fSW5jaWRlbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJVEhJUyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsKCQlpZiAoIXYpIHJldHVybiB0aGlzOwoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCQl0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KSA9PT0gJ29iamVjdCcgJiYgX3YuRW50aXR5Q2xhc3MgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSA9PSB0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGUgPT0gdGhpcy5TY29wZSk7CgkJaWYgKGNvKSB0aGlzLl9USElTX2Nvb3AgPSBjbzsKCQlyZXR1cm4gdGhpczsKCX0KCgljbGVhcl9USElTKCkgewoJCXRoaXMuX1RISVMgPSBbXTsKCQl0aGlzLl9USElTX2Nvb3AgPSAnJzsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNsb3NlX3JlYXNvbl9JbmNpZGVudHMgKiovCgljbG9zZV9yZWFzb25fSW5jaWRlbnRzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICc1YmVlMjM0Yy01ZTQzLTQ0Y2EtOGUwZi00MDJjMmFkZTE5MzQnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0luY2lkZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9jbG9zZV9yZWFzb25fc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnY2xvc2VfcmVhc29uX0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAiY2xvc2VfcmVhc29uIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJJbmNpZGVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2Nsb3NlX3JlYXNvbl9JbmNpZGVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgImNsb3NlX3JlYXNvbiBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkluY2lkZW50Iik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LmNsb3NlX3JlYXNvbih0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzLnB1c2goLi4udik7CgkJdGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfY2xvc2VfcmVhc29uX0luY2lkZW50cygpIHsKCQl0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX3NldCA9IG51bGw7CgkJdGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50cyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjbG9zZV9yZWFzb25fSW5jaWRlbnRzICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJCXRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5jbG9zZV9yZWFzb25fSW5jaWRlbnRzID0gdGhpcy5jbG9zZV9yZWFzb25fSW5jaWRlbnRzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQljbG9zZV9yZWFzb25fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uX1JlYXNvbnMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkgIT0gJ1JlYXNvbicpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCXJldHVybiBuZXcgc2FsZXNub3dbZXZlbnQuY2xhc3NOYW1lKCldKCkuX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdyk7CgkJCX0KCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9SZWFzb24vJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQkJZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOwoJCQkJZGVsZXRlIGRhdGEuX190aGlzLm9ubGluZTsKCgkJCX0KCgkJCS8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/PwoKCQkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJCXRyeSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0pIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7bWV0aG9kfWApOwoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCWxldCBfaWQgPSBudWxsOwoJCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBkYXRhLCBtZXRob2QsIHt9KTsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRhdGEpID09PSAnc3RyaW5nJykgewoJCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUoZGF0YSk7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IGRhdGEuX190aGlzLmNvZGUgfHwgZGF0YS5pZCB8fCBkYXRhLklEOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJCWlmIChkYXRhLklkICYmIGRhdGEuSWQgPT0gZGF0YS5JZCkgewoJCQkJCQlfaWQgPSBkYXRhLklkOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQkJfSBlbHNlIGlmIChkYXRhLkVudGl0eUNsYXNzKSB7CgkJCQkJCV9pZCA9IGRhdGEuRW50aXR5Q2xhc3MuSWQgfHwgZGF0YS5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjdlZjRlZDI5LTdhYzUtNDdmZi05MTg5LWZhYmIwMTlmZDE0NSIgfHwgIk5VTEwiOwoJCQkJCX0KCQkJCX0KCgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uID0gc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb24gfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvblttZXRob2RdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW21ldGhvZF1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW21ldGhvZF1bX2lkXSB8fCB7fTsKCgkJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goe30sIHsKCQkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQkJfSk7CgoJCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bbWV0aG9kXVtfaWRdW19oYXNoXSA9IHsKCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeSh7fSksCgkJCQkJb2JqOiBkYXRhLAoJCQkJCXJldXNlZDogMCwKCQkJCX07CgkJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZGF0YSwgbWV0aG9kLCB7fSwgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBUcmlnZ2VycmluZyAke21ldGhvZH0gdG8gJHtuLmNvZGUoKX0gJHtKU09OLnN0cmluZ2lmeShkYXRhLG51bGwsNCl9YCk7CgoJCQlsZXQgZXYgPSBuZXcgc2FsZXNub3cuRXZlbnQoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSh0aGlzLl9fY29uZmlnKCdldmVudCcpIHx8ICdzYWxlc25vdy5FdmVudCcpLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnJlY2lwaWVudChuKS5tZXRob2QobWV0aG9kKS5jbGFzc05hbWUoJ1JlYXNvbicpLnNlbmRlcihzYWxlc25vdy5fbm9kZSkuY2FycmllcihzYWxlc25vdy5fbm9kZSkucGF5bG9hZChkYXRhKTsKCQkJaWYgKGV2ZW50KSB7CgkJCQlpZiAoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7CgkJCQlpZiAoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7CgkJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7CgkJCQlpZiAoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7CgkJCX0KCQkJcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOwoKCQkJaWYgKHR5cGVvZihyZXQpID09PSAic3RyaW5nIikgewoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChleCkge30KCQkJfQoJCQlyZXR1cm4gcmV0OwoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LlJlYXNvbihudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuUmVhc29uKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX25vZGUpIHsKCQkJLy8gcHJvYmFibHkgc2hvdWxkIG5vdCBiZSBwcm9jZXNzZWQgaGVyZSwgYnV0IHJhdGhlciBjb25zdW1lZCBhcyBwYXJ0IG9mIHRoZSBleGVjdXRlKCkgbG9naWMsIHB1c2hpbmcgX19ub2RlIHRvIHRoZSBsaXN0IG9mIG15IG5vZGVzIHRvIGRlbGVnYXRlIHRvIT8KCQkJbGV0IHRuID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX19ub2RlKS5fZGVSZWZlcmVuY2UoKTsKCQkJZGVsZXRlIF9wYXJhbXMuX19ub2RlOwoJCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlJlYXNvbigpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOwoJCX0KCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgUmVhc29uLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgUmVhc29uLl9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbi5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5SZWFzb24uJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIlJlYXNvbiIpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQkvLyB0aGlzLmNsb3NlX3JlYXNvbl9SZWFzb25zKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuUmVhc29uKHRoaXMuSWQpCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5jb2RlKHRoaXMuY29kZSgpLCB0aGlzLl9jb2RlX2Nvb3ApCgoJCQkub3JkZXIodGhpcy5vcmRlcigpLCB0aGlzLl9vcmRlcl9jb29wKQoKCQkJLmRhdGUodGhpcy5kYXRlKCksIHRoaXMuX2RhdGVfY29vcCkKCgkJCS5uYW1lKHRoaXMubmFtZSgpLCB0aGlzLl9uYW1lX2Nvb3ApCgoJCQkucmVtYXJrKHRoaXMucmVtYXJrKCksIHRoaXMuX3JlbWFya19jb29wKQoKCQkJLmNsb3NlX3JlYXNvbl9JbmNpZGVudHModGhpcy5jbG9zZV9yZWFzb25fSW5jaWRlbnRzKCksIHRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCkgewoJCWNvbnRleHQgPSBjb250ZXh0IHx8ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCW9iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQlvYmpUbyA9IG9ialRvIHx8IHt9OwoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAnUmVhc29uJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiUmVhc29uIjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCQkJCXJldCA9IHJldC50b0xvd2VyQ2FzZSgpOwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCQl0cnkgewoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgPyAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gb3B0aW9ucy50b29sIHx8IHQgPT0gb3B0aW9ucy50b29sKSA6IHRoaXMuVG9vbDsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sIHx8IHt9OwoKCQkJbGV0IG5JRCA9IHNhbGVzbm93Ll9ub2RlID8gc2FsZXNub3cuX25vZGUuY29kZSgpIDogImRlZmF1bHQiOwoKCQkJbGV0IHJldCA9IG51bGxWYWx1ZTsKCQkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0ID0gbnVsbDsKCgkJCS8vIHRvb2xfQ29uZmlnczogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBkb25lCgkJCWxldCB0Y29uZiA9IChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiBjLm5vZGUgJiYgYy5ub2RlLmNvZGUgPT0gbklEKS5jb25jYXQoKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmICFjLm5vZGUpKTsKCQkJaWYgKHRjb25mLmxlbmd0aCkgewoJCQkJcmV0ID0gdGNvbmZbMF0udmFsdWU7CgkJCQl0cnkgewoJCQkJCVsxLCAyLCAzXS5mb3JFYWNoKGEgPT4gcmV0ID0gSlNPTi5wYXJzZShyZXQpKTsKCQkJCX0gY2F0Y2ggKGpleCkge30KCQkJfQoKCQkJLy8gbW9kZWwgQ29uZmlnOiBDb25maWcgaXMgY2xhc3MgbGV2ZWwsIG5vZGUgbm90IHBvc3NpYmxlIC0gcGVuZGluZwoJCQlsZXQgbWNvbmYgPSB0aGlzLkNvbmZpZyA/IHRoaXMuQ29uZmlnW25dIDogdW5kZWZpbmVkOwoJCQlpZiAodHlwZW9mKG1jb25mKSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IG1jb25mOwoKCQkJLy8gY29tbWFuZCBsaW5lOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiBnbG9iYWwubWluaW1pc3QpIHsKCQkJCXJldCA9IGdsb2JhbC5taW5pbWlzdChwcm9jZXNzLmFyZ3Yuc2xpY2UoMikpW25dIHx8IHJldDsKCQkJfQoKCQkJLy8gcmVxdWVzdDogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCXJldCA9IHRoaXMuJF9SRVFVRVNUKG4pIHx8IHJldDsKCgkJCWlmIChvcHRpb25zLm5ld1ZhbHVlKSB7CgkJCQlsZXQgdGMgPSB0Y29uZi5sZW5ndGggPyB0Y29uZlswXSA6IHt9OwoJCQkJdGMubm9kZSA9IHsKCQkJCQljb2RlOiBvcHRpb25zLm5vZGUuY29kZSgpCgkJCQl9OwoJCQkJdGMudmFsdWUgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQkJdGMubmFtZSA9IG47CgkJCQlpZiAoIXRjb25mLmxlbmd0aCkgewoJCQkJCW9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MucHVzaCh0Yyk7CgkJCQl9CgkJCQlyZXQgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQl9CgoJCQkvLyBjb25maWcgcmVwbGFjZW1lbnQKCQkJaWYgKHR5cGVvZihyZXQpID09PSAnc3RyaW5nJykocmV0Lm1hdGNoKG5ldyBSZWdFeHAoYHt7KFtefV0rKX19YCwgImciKSkgfHwgW10pLmZvckVhY2gobSA9PiByZXQgPSByZXQucmVwbGFjZShtLCB0aGlzLl9fY29uZmlnKG0ucmVwbGFjZSgne3snLCAnJykucmVwbGFjZSgnfX0nLCAnJyksIG51bGwsIG9wdGlvbnMpKSk7CgoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fY29uZmlnJywgJ0VudGl0eU9iamVjdCcsIDEsIG4sIG51bGxWYWx1ZSwgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncywgZXgpOwoJCX0KCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCgkJCQkJLy8gaWYodGhpc1snXycrZmllbGQrJ19zZXQnXSAmJiAodHlwZW9mKHRoaXNbJ18nK2ZpZWxkXSk9PT0ndW5kZWZpbmVkJyB8fCB0aGlzWydfJytmaWVsZF09PW51bGwpKSByZXR1cm47CgkJCQkJLy8gaWYodHlwZW9mKGVhT2JqKT09PSd1bmRlZmluZWQnKSByZXR1cm47IC8vIHdoeT8KCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCXJldHVybiBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjdlZjRlZDI5LTdhYzUtNDdmZi05MTg5LWZhYmIwMTlmZDE0NSIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb24gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbiB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCV9vcHRpb25zKCJjbG9zZV9yZWFzb25fSW5jaWRlbnRzIiwgb2JqLCB0aGlzLmNsb3NlX3JlYXNvbl9JbmNpZGVudHMoKSk7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydjbG9zZV9yZWFzb25fSW5jaWRlbnRzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJSZWFzb24iICYmIChtLnRhcmdldCB8fCBtLm91dFNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSAmJiAoIW0uc291cmNlIHx8IChtLnNvdXJjZSAmJiAvKiFtLm91dFNjcmlwdCAmJiovIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX3NldCddKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5vdXRTY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMsIG9TY29wZSwgbWFwKSA9PiB7JHttLm91dFNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLm91dFNjcmlwdH0pfWApKHRoaXMsIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnNvdXJjZSkgewoJCQkJaWYgKG0uc291cmNlLmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcykgPT4ge3JldHVybiBfdGhpcy4ke20uc291cmNlfTt9YCkodGhpcyk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnNvdXJjZSwgdGhpcyk7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0udGFyZ2V0KSBvYmpbbS50YXJnZXRdID0gcmV0OwoJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQlbbS50YXJnZXQgfHwgbS5zb3VyY2VdOiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10KCQkJfSk7CgkJfSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJLy8gdXNlIHRoaXMuX21hcCgpIHdpdGggcmV2ZXJzZQoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI3ZWY0ZWQyOS03YWM1LTQ3ZmYtOTE4OS1mYWJiMDE5ZmQxNDUiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uID0gc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb24gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJjbG9zZV9yZWFzb25fSW5jaWRlbnRzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ2Nsb3NlX3JlYXNvbl9JbmNpZGVudHMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIlJlYXNvbiIgJiYgKG0uc291cmNlIHx8IG0uaW5TY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5pblNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmosIG9TY29wZSwgbWFwKSA9PiB7JHttLmluU2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20uaW5TY3JpcHR9KX1gKShvYmosIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnRhcmdldCkgewoJCQkJaWYgKG0udGFyZ2V0LmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmopID0+IHtyZXR1cm4gb2JqLiR7bS50YXJnZXR9O31gKShvYmopOwoJCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqW20udGFyZ2V0XSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0udGFyZ2V0LCBvYmopOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0uc291cmNlKSB7CgkJCQlpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXRoaXNbbS5zb3VyY2VdKHJldCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXNbbS5zb3VyY2VdID0gcmV0OwoJCQkJfQoJCQl9CgkJfSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuUmVhc29uKSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlJlYXNvbiA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIlJlYXNvbiIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY2xvc2VfcmVhc29uX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5jbG9zZV9yZWFzb25fSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gcXVlcnkuY2xvc2VfcmVhc29uX0luY2lkZW50cygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJY2xvc2VfcmVhc29uX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5jbG9zZV9yZWFzb25fSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWNsb3NlX3JlYXNvbl9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5jbG9zZV9yZWFzb25fSW5jaWRlbnRzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ107CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJY2xvc2VfcmVhc29uX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbl9SZWFzb25zJywgdW5kZWZpbmVkKSA6ICJjbG9zZV9yZWFzb25fSW5jaWRlbnRzIikpID0+IHRoaXMuY2xvc2VfcmVhc29uX0luY2lkZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuSW5jaWRlbnQoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX1RISVM6IChvYmosIHYpID0+IHsKCQkJCWlmIChiVG9vbCkgcmV0dXJuOwoJCQkJb2JqLlRISVMgPSB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQlvYmouT1BFUkFUT1JTLlRISVMgPSB0aGlzLl9USElTX2Nvb3A7CgkJCX0sCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ10gPSB2LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQkJY2xvc2VfcmVhc29uX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbl9SZWFzb25zJywgdW5kZWZpbmVkKSA6ICJjbG9zZV9yZWFzb25fSW5jaWRlbnRzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gZmFsc2U7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5SZWFzb24uc3RvcmUnKTsgLy8gb3IgaW5zaWRlIGV4ZWN1dGU/CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJbGV0IGJVcGRhdGUgPSBmYWxzZTsKCQkJbGV0IGJJbnNlcnQgPSBmYWxzZTsKCgkJCWlmICghdGhpcy5fX3N5bmNfb24oKSkgewoJCQkJbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LlJlYXNvbihudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuY29kZSh0aGlzLmNvZGUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuY2xvc2VfcmVhc29uX0luY2lkZW50cygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBpbnNlcnQoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5SZWFzb24uaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuUmVhc29uLnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuUmVhc29uLmZpbmRBbGwnKTsKCgkJCS8vIGF2b2lkcyBjeWNsaWMgcXVlcmllcwoJCQlvYmpzID0gKG9ianMgfHwgW10pLm1hcChvID0+IG8uX2Nsb25lKCkpOwoKCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLz8/CgoJCQlsZXQgcmV0ID0gW107IC8vIGEganNvbiBhcnJheQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgKTsKCQkJCXJldCA9IHJldC5jb250ZW50ID8gW0pTT04ucGFyc2UodGhpcy5fYXRvYihyZXQuY29udGVudCkpXSA6IFtdOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiQmVmb3JlIF9mcm9tRG9jdW1lbnQoKSIsIHJldCk7CgoJCQlyZXQgPSByZXQubWFwKHIgPT4gbmV3IHNhbGVzbm93LlJlYXNvbihudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93LlN5bXB0b20gPSBjbGFzcyBTeW1wdG9tIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUXNLaTVmYkc5aFpGUnZiMnh6TENvdVlYVjBhRU52WkdVc1JYWmxiblF1YkdsemRHVnVMRVYyWlc1MExuQnliMk5sYzNNc1JYWmxiblF1ZEhKcFoyZGxjaUo5YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUp6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpWYzJWeUlqcDdJbDloZFhSb2IzSnBlbVV1ZFhObGNtNWhiV1VpT2lKbVlXUnBJaXdpWDJGMWRHaHZjbWw2WlM1d1lYTnpkMjl5WkNJNklqRXlNeUlzSWw5aGRYUm9iM0pwZW1VdWRHVnpkRlZ6WlhJaU9uc2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0puWlc1a1pYSWlPbnNpWTI5a1pTSTZJazBpTENKdVlXMWxJam9pVFdGc1pTSjlMQ0pqYjJSbElqb2labUZrYVNJc0ltNWhiV1VpT2lKR1lXUnBJbjE5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpQUVhWMGFGTmhibVFpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgkJdGhpcy5jbGVhcl9zeW1wdG9tX0luY2lkZW50cygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIlN5bXB0b20iLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCS8vICh0aGlzLnN5bXB0b21fSW5jaWRlbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJVEhJUyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsKCQlpZiAoIXYpIHJldHVybiB0aGlzOwoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCQl0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KSA9PT0gJ29iamVjdCcgJiYgX3YuRW50aXR5Q2xhc3MgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSA9PSB0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGUgPT0gdGhpcy5TY29wZSk7CgkJaWYgKGNvKSB0aGlzLl9USElTX2Nvb3AgPSBjbzsKCQlyZXR1cm4gdGhpczsKCX0KCgljbGVhcl9USElTKCkgewoJCXRoaXMuX1RISVMgPSBbXTsKCQl0aGlzLl9USElTX2Nvb3AgPSAnJzsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHN5bXB0b21fSW5jaWRlbnRzICoqLwoJc3ltcHRvbV9JbmNpZGVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX3N5bXB0b21fSW5jaWRlbnRzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICc1YmVlMjM0Yy01ZTQzLTQ0Y2EtOGUwZi00MDJjMmFkZTE5MzQnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0luY2lkZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9zeW1wdG9tX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N5bXB0b21fSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJzeW1wdG9tIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJJbmNpZGVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N5bXB0b21fSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJzeW1wdG9tIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiSW5jaWRlbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3Yuc3ltcHRvbSh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9zeW1wdG9tX0luY2lkZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX3N5bXB0b21fSW5jaWRlbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9zeW1wdG9tX0luY2lkZW50c19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfc3ltcHRvbV9JbmNpZGVudHMoKSB7CgkJdGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9zeW1wdG9tX0luY2lkZW50cyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX3N5bXB0b21fSW5jaWRlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc3ltcHRvbV9JbmNpZGVudHMgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5zeW1wdG9tX0luY2lkZW50cyA9IHRoaXMuc3ltcHRvbV9JbmNpZGVudHMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCXN5bXB0b21fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3ltcHRvbV9TeW1wdG9tcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCAmJiBldmVudC5jbGFzc05hbWUoKSAmJiBldmVudC5jbGFzc05hbWUoKSAhPSAnU3ltcHRvbScpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCXJldHVybiBuZXcgc2FsZXNub3dbZXZlbnQuY2xhc3NOYW1lKCldKCkuX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdyk7CgkJCX0KCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9TeW1wdG9tLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7CgoJCQl9CgoJCQkvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8KCgkJCWxldCB2ID0gdW5kZWZpbmVkOwoJCQl0cnkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke21ldGhvZH1gKTsKCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQlsZXQgX2lkID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgZGF0YSwgbWV0aG9kLCB7fSk7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIHsKCQkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKGRhdGEpOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSBkYXRhLl9fdGhpcy5jb2RlIHx8IGRhdGEuaWQgfHwgZGF0YS5JRDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCQlpZiAoZGF0YS5JZCAmJiBkYXRhLklkID09IGRhdGEuSWQpIHsKCQkJCQkJX2lkID0gZGF0YS5JZDsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5FbnRpdHlDbGFzcykgewoJCQkJCQlfaWQgPSBkYXRhLkVudGl0eUNsYXNzLklkIHx8IGRhdGEuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJiMjUxY2JhMC05NTM5LTRiZTctOWM2Ny1iYWY5ZWVkNTUxZTciIHx8ICJOVUxMIjsKCQkJCQl9CgkJCQl9CgoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b20gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b20gfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bbWV0aG9kXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVttZXRob2RdIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW21ldGhvZF1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVttZXRob2RdW19pZF0gfHwge307CgoJCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKHt9LCB7CgkJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJCX0pOwoKCQkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bbWV0aG9kXVtfaWRdW19oYXNoXTsKCQkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogNSkpIHsKCQkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIG1ldGhvZCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCQl2LnJldXNlZCsrOwoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0KCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSk7CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bbWV0aG9kXVtfaWRdW19oYXNoXSA9IHsKCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeSh7fSksCgkJCQkJb2JqOiBkYXRhLAoJCQkJCXJldXNlZDogMCwKCQkJCX07CgkJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZGF0YSwgbWV0aG9kLCB7fSwgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBUcmlnZ2VycmluZyAke21ldGhvZH0gdG8gJHtuLmNvZGUoKX0gJHtKU09OLnN0cmluZ2lmeShkYXRhLG51bGwsNCl9YCk7CgoJCQlsZXQgZXYgPSBuZXcgc2FsZXNub3cuRXZlbnQoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSh0aGlzLl9fY29uZmlnKCdldmVudCcpIHx8ICdzYWxlc25vdy5FdmVudCcpLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnJlY2lwaWVudChuKS5tZXRob2QobWV0aG9kKS5jbGFzc05hbWUoJ1N5bXB0b20nKS5zZW5kZXIoc2FsZXNub3cuX25vZGUpLmNhcnJpZXIoc2FsZXNub3cuX25vZGUpLnBheWxvYWQoZGF0YSk7CgkJCWlmIChldmVudCkgewoJCQkJaWYgKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOwoJCQkJaWYgKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOwoJCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJaWYgKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOwoJCQl9CgkJCXJldCA9IGF3YWl0IGV2LnRyaWdnZXIoKTsKCgkJCWlmICh0eXBlb2YocmV0KSA9PT0gInN0cmluZyIpIHsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCX0KCQkJcmV0dXJuIHJldDsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5TeW1wdG9tKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5TeW1wdG9tKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX25vZGUpIHsKCQkJLy8gcHJvYmFibHkgc2hvdWxkIG5vdCBiZSBwcm9jZXNzZWQgaGVyZSwgYnV0IHJhdGhlciBjb25zdW1lZCBhcyBwYXJ0IG9mIHRoZSBleGVjdXRlKCkgbG9naWMsIHB1c2hpbmcgX19ub2RlIHRvIHRoZSBsaXN0IG9mIG15IG5vZGVzIHRvIGRlbGVnYXRlIHRvIT8KCQkJbGV0IHRuID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX19ub2RlKS5fZGVSZWZlcmVuY2UoKTsKCQkJZGVsZXRlIF9wYXJhbXMuX19ub2RlOwoJCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlN5bXB0b20oKS5faW52b2tlTm9kZSh0biwgbWV0aG9kLCBfcGFyYW1zKTsKCQl9CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYFN5bXB0b20uX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBTeW1wdG9tLl9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b20uX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuU3ltcHRvbS4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiU3ltcHRvbSIpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQkvLyB0aGlzLnN5bXB0b21fU3ltcHRvbXMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5TeW1wdG9tKHRoaXMuSWQpCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5jb2RlKHRoaXMuY29kZSgpLCB0aGlzLl9jb2RlX2Nvb3ApCgoJCQkub3JkZXIodGhpcy5vcmRlcigpLCB0aGlzLl9vcmRlcl9jb29wKQoKCQkJLmRhdGUodGhpcy5kYXRlKCksIHRoaXMuX2RhdGVfY29vcCkKCgkJCS5uYW1lKHRoaXMubmFtZSgpLCB0aGlzLl9uYW1lX2Nvb3ApCgoJCQkucmVtYXJrKHRoaXMucmVtYXJrKCksIHRoaXMuX3JlbWFya19jb29wKQoKCQkJLnN5bXB0b21fSW5jaWRlbnRzKHRoaXMuc3ltcHRvbV9JbmNpZGVudHMoKSwgdGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCkgewoJCWNvbnRleHQgPSBjb250ZXh0IHx8ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCW9iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQlvYmpUbyA9IG9ialRvIHx8IHt9OwoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAnU3ltcHRvbSc7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIlN5bXB0b20iOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoJCQkJcmV0ID0gcmV0LnRvTG93ZXJDYXNlKCk7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMgPSB7fSkgewoJCXRyeSB7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCA/IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSBvcHRpb25zLnRvb2wgfHwgdCA9PSBvcHRpb25zLnRvb2wpIDogdGhpcy5Ub29sOwoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgfHwge307CgoJCQlsZXQgbklEID0gc2FsZXNub3cuX25vZGUgPyBzYWxlc25vdy5fbm9kZS5jb2RlKCkgOiAiZGVmYXVsdCI7CgoJCQlsZXQgcmV0ID0gbnVsbFZhbHVlOwoJCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXQgPSBudWxsOwoKCQkJLy8gdG9vbF9Db25maWdzOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIGRvbmUKCQkJbGV0IHRjb25mID0gKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmIGMubm9kZSAmJiBjLm5vZGUuY29kZSA9PSBuSUQpLmNvbmNhdCgob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgIWMubm9kZSkpOwoJCQlpZiAodGNvbmYubGVuZ3RoKSB7CgkJCQlyZXQgPSB0Y29uZlswXS52YWx1ZTsKCQkJCXRyeSB7CgkJCQkJWzEsIDIsIDNdLmZvckVhY2goYSA9PiByZXQgPSBKU09OLnBhcnNlKHJldCkpOwoJCQkJfSBjYXRjaCAoamV4KSB7fQoJCQl9CgoJCQkvLyBtb2RlbCBDb25maWc6IENvbmZpZyBpcyBjbGFzcyBsZXZlbCwgbm9kZSBub3QgcG9zc2libGUgLSBwZW5kaW5nCgkJCWxldCBtY29uZiA9IHRoaXMuQ29uZmlnID8gdGhpcy5Db25maWdbbl0gOiB1bmRlZmluZWQ7CgkJCWlmICh0eXBlb2YobWNvbmYpICE9PSAidW5kZWZpbmVkIikgcmV0ID0gbWNvbmY7CgoJCQkvLyBjb21tYW5kIGxpbmU6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnICYmIGdsb2JhbC5taW5pbWlzdCkgewoJCQkJcmV0ID0gZ2xvYmFsLm1pbmltaXN0KHByb2Nlc3MuYXJndi5zbGljZSgyKSlbbl0gfHwgcmV0OwoJCQl9CgoJCQkvLyByZXF1ZXN0OiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJcmV0ID0gdGhpcy4kX1JFUVVFU1QobikgfHwgcmV0OwoKCQkJaWYgKG9wdGlvbnMubmV3VmFsdWUpIHsKCQkJCWxldCB0YyA9IHRjb25mLmxlbmd0aCA/IHRjb25mWzBdIDoge307CgkJCQl0Yy5ub2RlID0gewoJCQkJCWNvZGU6IG9wdGlvbnMubm9kZS5jb2RlKCkKCQkJCX07CgkJCQl0Yy52YWx1ZSA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCQl0Yy5uYW1lID0gbjsKCQkJCWlmICghdGNvbmYubGVuZ3RoKSB7CgkJCQkJb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncy5wdXNoKHRjKTsKCQkJCX0KCQkJCXJldCA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCX0KCgkJCS8vIGNvbmZpZyByZXBsYWNlbWVudAoJCQlpZiAodHlwZW9mKHJldCkgPT09ICdzdHJpbmcnKShyZXQubWF0Y2gobmV3IFJlZ0V4cChge3soW159XSspfX1gLCAiZyIpKSB8fCBbXSkuZm9yRWFjaChtID0+IHJldCA9IHJldC5yZXBsYWNlKG0sIHRoaXMuX19jb25maWcobS5yZXBsYWNlKCd7eycsICcnKS5yZXBsYWNlKCd9fScsICcnKSwgbnVsbCwgb3B0aW9ucykpKTsKCgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19jb25maWcnLCAnRW50aXR5T2JqZWN0JywgMSwgbiwgbnVsbFZhbHVlLCBvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLCBleCk7CgkJfQoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJCQkvLyBpZih0aGlzWydfJytmaWVsZCsnX3NldCddICYmICh0eXBlb2YodGhpc1snXycrZmllbGRdKT09PSd1bmRlZmluZWQnIHx8IHRoaXNbJ18nK2ZpZWxkXT09bnVsbCkpIHJldHVybjsKCQkJCQkvLyBpZih0eXBlb2YoZWFPYmopPT09J3VuZGVmaW5lZCcpIHJldHVybjsgLy8gd2h5PwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiYjI1MWNiYTAtOTUzOS00YmU3LTljNjctYmFmOWVlZDU1MWU3IiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b20gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b20gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlfb3B0aW9ucygic3ltcHRvbV9JbmNpZGVudHMiLCBvYmosIHRoaXMuc3ltcHRvbV9JbmNpZGVudHMoKSk7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydzeW1wdG9tX0luY2lkZW50cyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlmYWxzZSAmJiBbXS5jb25jYXQodGhpcy5Ub29sLnR5cGUudHlwZV9NYXBwaW5ncyB8fCBbXSkuY29uY2F0KHRoaXMuVG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5maWx0ZXIobSA9PiBtLmNsYXNzTmFtZSA9PSAiU3ltcHRvbSIgJiYgKG0udGFyZ2V0IHx8IG0ub3V0U2NyaXB0KSAmJiBtLmFjdGl2ZSAmJiBtLmVuYWJsZWQgJiYgKChtLnRvb2wgJiYgbS50b29sLm5hbWUgPT0gdGhpcy5Ub29sLm5hbWUpIHx8IChtLnR5cGUgJiYgbS50eXBlLm5hbWUgPT0gdGhpcy5Ub29sLnR5cGUubmFtZSkpICYmICghbS5zb3VyY2UgfHwgKG0uc291cmNlICYmIC8qIW0ub3V0U2NyaXB0ICYmKi8gdGhpc1snXycgKyBtLnNvdXJjZSArICdfc2V0J10pKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLm91dFNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcywgb1Njb3BlLCBtYXApID0+IHske20ub3V0U2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20ub3V0U2NyaXB0fSl9YCkodGhpcywgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0uc291cmNlKSB7CgkJCQlpZiAobS5zb3VyY2UuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzKSA9PiB7cmV0dXJuIF90aGlzLiR7bS5zb3VyY2V9O31gKSh0aGlzKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0uc291cmNlLCB0aGlzKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS50YXJnZXQpIG9ialttLnRhcmdldF0gPSByZXQ7CgkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCVttLnRhcmdldCB8fCBtLnNvdXJjZV06IHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXQoJCQl9KTsKCQl9KTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQkvLyB1c2UgdGhpcy5fbWFwKCkgd2l0aCByZXZlcnNlCgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgImIyNTFjYmEwLTk1MzktNGJlNy05YzY3LWJhZjllZWQ1NTFlNyIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygic3ltcHRvbV9JbmNpZGVudHMiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnc3ltcHRvbV9JbmNpZGVudHMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIlN5bXB0b20iICYmIChtLnNvdXJjZSB8fCBtLmluU2NyaXB0KSAmJiBtLmFjdGl2ZSAmJiBtLmVuYWJsZWQgJiYgKChtLnRvb2wgJiYgbS50b29sLm5hbWUgPT0gdGhpcy5Ub29sLm5hbWUpIHx8IChtLnR5cGUgJiYgbS50eXBlLm5hbWUgPT0gdGhpcy5Ub29sLnR5cGUubmFtZSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0uaW5TY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAob2JqLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5pblNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLmluU2NyaXB0fSl9YCkob2JqLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS50YXJnZXQpIHsKCQkJCWlmIChtLnRhcmdldC5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAob2JqKSA9PiB7cmV0dXJuIG9iai4ke20udGFyZ2V0fTt9YCkob2JqKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKG9ialttLnRhcmdldF0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gb2JqW20udGFyZ2V0XSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnRhcmdldCwgb2JqKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gb2JqW20udGFyZ2V0XTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnNvdXJjZSkgewoJCQkJaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQl0aGlzW20uc291cmNlXShyZXQpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzW20uc291cmNlXSA9IHJldDsKCQkJCX0KCQkJfQoJCX0pOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlN5bXB0b20pIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuU3ltcHRvbSA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIlN5bXB0b20iKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCXN5bXB0b21fSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnN5bXB0b21fSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gcXVlcnkuc3ltcHRvbV9JbmNpZGVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXN5bXB0b21fSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnN5bXB0b21fSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXN5bXB0b21fSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuc3ltcHRvbV9JbmNpZGVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb2RlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jb2RlKHJlZik7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3JkZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9yZGVyKHJlZik7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLmRhdGUocmVmKTsKCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9uYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5uYW1lKHJlZik7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVtYXJrX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5yZW1hcmsocmVmKTsKCgkJCX0sCgoJCQlzeW1wdG9tX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3N5bXB0b21fU3ltcHRvbXMnLCB1bmRlZmluZWQpIDogInN5bXB0b21fSW5jaWRlbnRzIikpID0+IHRoaXMuc3ltcHRvbV9JbmNpZGVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddID0gdiwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCXN5bXB0b21fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnc3ltcHRvbV9TeW1wdG9tcycsIHVuZGVmaW5lZCkgOiAic3ltcHRvbV9JbmNpZGVudHMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3N5bXB0b21fSW5jaWRlbnRzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuX25hbWU7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IGZhbHNlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuU3ltcHRvbS5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuU3ltcHRvbShudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuY29kZSh0aGlzLmNvZGUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9zeW1wdG9tX0luY2lkZW50c19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLnN5bXB0b21fSW5jaWRlbnRzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlN5bXB0b20uaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuU3ltcHRvbS51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlN5bXB0b20uZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2ApOwoJCQkJcmV0ID0gcmV0LmNvbnRlbnQgPyBbSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSldIDogW107CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5tYXAociA9PiBuZXcgc2FsZXNub3cuU3ltcHRvbShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93LkluY2lkZW50ID0gY2xhc3MgSW5jaWRlbnQgZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRc0tpNWZiRzloWkZSdmIyeHpMQ291WVhWMGFFTnZaR1VzUlhabGJuUXViR2x6ZEdWdUxFVjJaVzUwTG5CeWIyTmxjM01zUlhabGJuUXVkSEpwWjJkbGNpSjlgKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlBRWFYwYUZOaGJtUWlMQ0pIYVhSSWRXSWlYUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJudW1iZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX251bWJlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInRpdGxlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl90aXRsZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRlc2NyaXB0aW9uIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kZXNjcmlwdGlvbigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImxvY2F0aW9uIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9sb2NhdGlvbigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImdyb3VwIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9ncm91cCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInN0YXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9zdGF0ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInN5bXB0b20iLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3N5bXB0b20oKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjbG9zZV9yZWFzb24iLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2Nsb3NlX3JlYXNvbigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInByaW9yaXR5IiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9wcmlvcml0eSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNhbGxlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY2FsbGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29udGFjdCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29udGFjdCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiSW5jaWRlbnQiLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCS8vIGlmKHRoaXMuX2xvY2F0aW9uX3NldCAmJiB0aGlzLl9sb2NhdGlvbikgdGhpcy5fbG9jYXRpb24uVG9vbCA9IHRvb2w7CgoJCS8vIGlmKHRoaXMuX2dyb3VwX3NldCAmJiB0aGlzLl9ncm91cCkgdGhpcy5fZ3JvdXAuVG9vbCA9IHRvb2w7CgoJCS8vIGlmKHRoaXMuX3N0YXRlX3NldCAmJiB0aGlzLl9zdGF0ZSkgdGhpcy5fc3RhdGUuVG9vbCA9IHRvb2w7CgoJCS8vIGlmKHRoaXMuX3N5bXB0b21fc2V0ICYmIHRoaXMuX3N5bXB0b20pIHRoaXMuX3N5bXB0b20uVG9vbCA9IHRvb2w7CgoJCS8vIGlmKHRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQgJiYgdGhpcy5fY2xvc2VfcmVhc29uKSB0aGlzLl9jbG9zZV9yZWFzb24uVG9vbCA9IHRvb2w7CgoJCS8vIGlmKHRoaXMuX3ByaW9yaXR5X3NldCAmJiB0aGlzLl9wcmlvcml0eSkgdGhpcy5fcHJpb3JpdHkuVG9vbCA9IHRvb2w7CgoJCS8vIGlmKHRoaXMuX2NhbGxlcl9zZXQgJiYgdGhpcy5fY2FsbGVyKSB0aGlzLl9jYWxsZXIuVG9vbCA9IHRvb2w7CgoJCS8vIGlmKHRoaXMuX2NvbnRhY3Rfc2V0ICYmIHRoaXMuX2NvbnRhY3QpIHRoaXMuX2NvbnRhY3QuVG9vbCA9IHRvb2w7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBudW1iZXIgKiovCgludW1iZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9udW1iZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJudW1iZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX251bWJlciAhPSB2KSB7CgkJCQl0aGlzLl9udW1iZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX251bWJlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9udW1iZXIpOwoJCX0KCX0KCgljbGVhcl9udW1iZXIoKSB7CgkJdGhpcy5fbnVtYmVyX3NldCA9IG51bGw7CgkJdGhpcy5fbnVtYmVyID0gbnVsbDsKCQl0aGlzLl9udW1iZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG51bWJlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHRpdGxlICoqLwoJdGl0bGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl90aXRsZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInRpdGxlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl90aXRsZSAhPSB2KSB7CgkJCQl0aGlzLl90aXRsZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fdGl0bGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fdGl0bGUpOwoJCX0KCX0KCgljbGVhcl90aXRsZSgpIHsKCQl0aGlzLl90aXRsZV9zZXQgPSBudWxsOwoJCXRoaXMuX3RpdGxlID0gbnVsbDsKCQl0aGlzLl90aXRsZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdGl0bGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkZXNjcmlwdGlvbiAqKi8KCWRlc2NyaXB0aW9uKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGVzY3JpcHRpb25fY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkZXNjcmlwdGlvbiIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGVzY3JpcHRpb24gIT0gdikgewoJCQkJdGhpcy5fZGVzY3JpcHRpb25fc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2Rlc2NyaXB0aW9uID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2Rlc2NyaXB0aW9uKTsKCQl9Cgl9CgoJY2xlYXJfZGVzY3JpcHRpb24oKSB7CgkJdGhpcy5fZGVzY3JpcHRpb25fc2V0ID0gbnVsbDsKCQl0aGlzLl9kZXNjcmlwdGlvbiA9IG51bGw7CgkJdGhpcy5fZGVzY3JpcHRpb25fY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRlc2NyaXB0aW9uICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbG9jYXRpb24gKiovCglsb2NhdGlvbih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2xvY2F0aW9uX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibG9jYXRpb24iKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICcyZmRjNzgzMS01YjVkLTQzOWMtYmI4Yy1jNTg5OGMwYjIzY2MnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdMb2NhdGlvbicpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdsb2NhdGlvbicsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjJmZGM3ODMxLTViNWQtNDM5Yy1iYjhjLWM1ODk4YzBiMjNjYyIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJMb2NhdGlvbiIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9sb2NhdGlvbiAhPSB2KSB7CgkJCQl0aGlzLl9sb2NhdGlvbl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2xvY2F0aW9uJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9sb2NhdGlvbiA/IHRoaXMuX2xvY2F0aW9uLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9sb2NhdGlvbl9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fbG9jYXRpb24gPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbG9jYXRpb24pOwoJCX0KCX0KCgljbGVhcl9sb2NhdGlvbigpIHsKCQl0aGlzLl9sb2NhdGlvbl9zZXQgPSBudWxsOwoJCXRoaXMuX2xvY2F0aW9uID0gbnVsbDsKCQl0aGlzLl9sb2NhdGlvbl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbG9jYXRpb24gKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBncm91cCAqKi8KCWdyb3VwKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZ3JvdXBfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJncm91cCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzRiZGY0ODAxLWIxZWYtNDAzMS1hMDkzLWM4Yzg5ZWZhYzc2NicgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0dyb3VwJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dyb3VwJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiNGJkZjQ4MDEtYjFlZi00MDMxLWEwOTMtYzhjODllZmFjNzY2IiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIkdyb3VwIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2dyb3VwICE9IHYpIHsKCQkJCXRoaXMuX2dyb3VwX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ3JvdXAnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX2dyb3VwID8gdGhpcy5fZ3JvdXAuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX2dyb3VwX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9ncm91cCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9ncm91cCk7CgkJfQoJfQoKCWNsZWFyX2dyb3VwKCkgewoJCXRoaXMuX2dyb3VwX3NldCA9IG51bGw7CgkJdGhpcy5fZ3JvdXAgPSBudWxsOwoJCXRoaXMuX2dyb3VwX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBncm91cCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHN0YXRlICoqLwoJc3RhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9zdGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInN0YXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnMTcwNTRjZjItNzBjZS00ZDFlLTg0ZmYtZWNjNWNlMmEwMjJjJyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnU3RhdGUnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RhdGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICIxNzA1NGNmMi03MGNlLTRkMWUtODRmZi1lY2M1Y2UyYTAyMmMiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiU3RhdGUiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fc3RhdGUgIT0gdikgewoJCQkJdGhpcy5fc3RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fc3RhdGUgPyB0aGlzLl9zdGF0ZS5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fc3RhdGVfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX3N0YXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3N0YXRlKTsKCQl9Cgl9CgoJY2xlYXJfc3RhdGUoKSB7CgkJdGhpcy5fc3RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9zdGF0ZSA9IG51bGw7CgkJdGhpcy5fc3RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHN0YXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc3ltcHRvbSAqKi8KCXN5bXB0b20odiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9zeW1wdG9tX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgic3ltcHRvbSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2IyNTFjYmEwLTk1MzktNGJlNy05YzY3LWJhZjllZWQ1NTFlNycgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ1N5bXB0b20nKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3ltcHRvbScsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgImIyNTFjYmEwLTk1MzktNGJlNy05YzY3LWJhZjllZWQ1NTFlNyIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJTeW1wdG9tIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3N5bXB0b20gIT0gdikgewoJCQkJdGhpcy5fc3ltcHRvbV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N5bXB0b20nLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX3N5bXB0b20gPyB0aGlzLl9zeW1wdG9tLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9zeW1wdG9tX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9zeW1wdG9tID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3N5bXB0b20pOwoJCX0KCX0KCgljbGVhcl9zeW1wdG9tKCkgewoJCXRoaXMuX3N5bXB0b21fc2V0ID0gbnVsbDsKCQl0aGlzLl9zeW1wdG9tID0gbnVsbDsKCQl0aGlzLl9zeW1wdG9tX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBzeW1wdG9tICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY2xvc2VfcmVhc29uICoqLwoJY2xvc2VfcmVhc29uKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY2xvc2VfcmVhc29uX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY2xvc2VfcmVhc29uIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnN2VmNGVkMjktN2FjNS00N2ZmLTkxODktZmFiYjAxOWZkMTQ1JyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnUmVhc29uJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2Nsb3NlX3JlYXNvbicsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjdlZjRlZDI5LTdhYzUtNDdmZi05MTg5LWZhYmIwMTlmZDE0NSIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJSZWFzb24iKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY2xvc2VfcmVhc29uICE9IHYpIHsKCQkJCXRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2Nsb3NlX3JlYXNvbicsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fY2xvc2VfcmVhc29uID8gdGhpcy5fY2xvc2VfcmVhc29uLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9jbG9zZV9yZWFzb25fc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX2Nsb3NlX3JlYXNvbiA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jbG9zZV9yZWFzb24pOwoJCX0KCX0KCgljbGVhcl9jbG9zZV9yZWFzb24oKSB7CgkJdGhpcy5fY2xvc2VfcmVhc29uX3NldCA9IG51bGw7CgkJdGhpcy5fY2xvc2VfcmVhc29uID0gbnVsbDsKCQl0aGlzLl9jbG9zZV9yZWFzb25fY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNsb3NlX3JlYXNvbiAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHByaW9yaXR5ICoqLwoJcHJpb3JpdHkodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9wcmlvcml0eV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInByaW9yaXR5Iik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnYmJmMDY3NWQtNWI4MS00MzlmLTliMjMtODFiOTgzZmZiY2RhJyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnUHJpb3JpdHknKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAncHJpb3JpdHknLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICJiYmYwNjc1ZC01YjgxLTQzOWYtOWIyMy04MWI5ODNmZmJjZGEiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiUHJpb3JpdHkiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcHJpb3JpdHkgIT0gdikgewoJCQkJdGhpcy5fcHJpb3JpdHlfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdwcmlvcml0eScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fcHJpb3JpdHkgPyB0aGlzLl9wcmlvcml0eS5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fcHJpb3JpdHlfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX3ByaW9yaXR5ID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3ByaW9yaXR5KTsKCQl9Cgl9CgoJY2xlYXJfcHJpb3JpdHkoKSB7CgkJdGhpcy5fcHJpb3JpdHlfc2V0ID0gbnVsbDsKCQl0aGlzLl9wcmlvcml0eSA9IG51bGw7CgkJdGhpcy5fcHJpb3JpdHlfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHByaW9yaXR5ICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY2FsbGVyICoqLwoJY2FsbGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY2FsbGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY2FsbGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnYjU4YjcwMzYtNjUxOS00NmVhLWFmNjgtNTEyM2ZkNDZiMWVlJyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnVXNlcicpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjYWxsZXInLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICJiNThiNzAzNi02NTE5LTQ2ZWEtYWY2OC01MTIzZmQ0NmIxZWUiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiVXNlciIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jYWxsZXIgIT0gdikgewoJCQkJdGhpcy5fY2FsbGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnY2FsbGVyJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9jYWxsZXIgPyB0aGlzLl9jYWxsZXIuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX2NhbGxlcl9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fY2FsbGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NhbGxlcik7CgkJfQoJfQoKCWNsZWFyX2NhbGxlcigpIHsKCQl0aGlzLl9jYWxsZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9jYWxsZXIgPSBudWxsOwoJCXRoaXMuX2NhbGxlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY2FsbGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29udGFjdCAqKi8KCWNvbnRhY3QodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb250YWN0X2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29udGFjdCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2I1OGI3MDM2LTY1MTktNDZlYS1hZjY4LTUxMjNmZDQ2YjFlZScgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ1VzZXInKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnY29udGFjdCcsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgImI1OGI3MDM2LTY1MTktNDZlYS1hZjY4LTUxMjNmZDQ2YjFlZSIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJVc2VyIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvbnRhY3QgIT0gdikgewoJCQkJdGhpcy5fY29udGFjdF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NvbnRhY3QnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX2NvbnRhY3QgPyB0aGlzLl9jb250YWN0LlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9jb250YWN0X3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9jb250YWN0ID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvbnRhY3QpOwoJCX0KCX0KCgljbGVhcl9jb250YWN0KCkgewoJCXRoaXMuX2NvbnRhY3Rfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb250YWN0ID0gbnVsbDsKCQl0aGlzLl9jb250YWN0X2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb250YWN0ICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fbnVtYmVyX3NldCwKCgkJCXRoaXMuX3RpdGxlX3NldCwKCgkJCXRoaXMuX2Rlc2NyaXB0aW9uX3NldCwKCgkJCXRoaXMuX2xvY2F0aW9uX3NldCwKCgkJCXRoaXMuX2dyb3VwX3NldCwKCgkJCXRoaXMuX3N0YXRlX3NldCwKCgkJCXRoaXMuX3N5bXB0b21fc2V0LAoKCQkJdGhpcy5fY2xvc2VfcmVhc29uX3NldCwKCgkJCXRoaXMuX3ByaW9yaXR5X3NldCwKCgkJCXRoaXMuX2NhbGxlcl9zZXQsCgoJCQl0aGlzLl9jb250YWN0X3NldCwKCgkJCXRoaXMuX2FjdGl2ZV9zZXQsCgoJCQl0aGlzLl9lbmFibGVkX3NldCwKCgkJCXRoaXMuX2NvZGVfc2V0LAoKCQkJdGhpcy5fb3JkZXJfc2V0LAoKCQkJdGhpcy5fZGF0ZV9zZXQsCgoJCQl0aGlzLl9uYW1lX3NldCwKCgkJCXRoaXMuX3JlbWFya19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9udW1iZXJfc2V0ID0gdGhpcy5fbnVtYmVyX3NldDsKCQlyZXQuX251bWJlcl9jb29wID0gdGhpcy5fbnVtYmVyX2Nvb3A7CgkJcmV0Lm51bWJlciA9IHRoaXMubnVtYmVyKCkgPyB0aGlzLm51bWJlcigpIDogdGhpcy5udW1iZXIoKTsKCgkJcmV0Ll90aXRsZV9zZXQgPSB0aGlzLl90aXRsZV9zZXQ7CgkJcmV0Ll90aXRsZV9jb29wID0gdGhpcy5fdGl0bGVfY29vcDsKCQlyZXQudGl0bGUgPSB0aGlzLnRpdGxlKCkgPyB0aGlzLnRpdGxlKCkgOiB0aGlzLnRpdGxlKCk7CgoJCXJldC5fZGVzY3JpcHRpb25fc2V0ID0gdGhpcy5fZGVzY3JpcHRpb25fc2V0OwoJCXJldC5fZGVzY3JpcHRpb25fY29vcCA9IHRoaXMuX2Rlc2NyaXB0aW9uX2Nvb3A7CgkJcmV0LmRlc2NyaXB0aW9uID0gdGhpcy5kZXNjcmlwdGlvbigpID8gdGhpcy5kZXNjcmlwdGlvbigpIDogdGhpcy5kZXNjcmlwdGlvbigpOwoKCQlyZXQuX2xvY2F0aW9uX3NldCA9IHRoaXMuX2xvY2F0aW9uX3NldDsKCQlyZXQuX2xvY2F0aW9uX2Nvb3AgPSB0aGlzLl9sb2NhdGlvbl9jb29wOwoJCXJldC5sb2NhdGlvbiA9IHRoaXMubG9jYXRpb24oKSA/IHRoaXMubG9jYXRpb24oKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5sb2NhdGlvbigpOwoKCQlyZXQuX2dyb3VwX3NldCA9IHRoaXMuX2dyb3VwX3NldDsKCQlyZXQuX2dyb3VwX2Nvb3AgPSB0aGlzLl9ncm91cF9jb29wOwoJCXJldC5ncm91cCA9IHRoaXMuZ3JvdXAoKSA/IHRoaXMuZ3JvdXAoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5ncm91cCgpOwoKCQlyZXQuX3N0YXRlX3NldCA9IHRoaXMuX3N0YXRlX3NldDsKCQlyZXQuX3N0YXRlX2Nvb3AgPSB0aGlzLl9zdGF0ZV9jb29wOwoJCXJldC5zdGF0ZSA9IHRoaXMuc3RhdGUoKSA/IHRoaXMuc3RhdGUoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5zdGF0ZSgpOwoKCQlyZXQuX3N5bXB0b21fc2V0ID0gdGhpcy5fc3ltcHRvbV9zZXQ7CgkJcmV0Ll9zeW1wdG9tX2Nvb3AgPSB0aGlzLl9zeW1wdG9tX2Nvb3A7CgkJcmV0LnN5bXB0b20gPSB0aGlzLnN5bXB0b20oKSA/IHRoaXMuc3ltcHRvbSgpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLnN5bXB0b20oKTsKCgkJcmV0Ll9jbG9zZV9yZWFzb25fc2V0ID0gdGhpcy5fY2xvc2VfcmVhc29uX3NldDsKCQlyZXQuX2Nsb3NlX3JlYXNvbl9jb29wID0gdGhpcy5fY2xvc2VfcmVhc29uX2Nvb3A7CgkJcmV0LmNsb3NlX3JlYXNvbiA9IHRoaXMuY2xvc2VfcmVhc29uKCkgPyB0aGlzLmNsb3NlX3JlYXNvbigpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLmNsb3NlX3JlYXNvbigpOwoKCQlyZXQuX3ByaW9yaXR5X3NldCA9IHRoaXMuX3ByaW9yaXR5X3NldDsKCQlyZXQuX3ByaW9yaXR5X2Nvb3AgPSB0aGlzLl9wcmlvcml0eV9jb29wOwoJCXJldC5wcmlvcml0eSA9IHRoaXMucHJpb3JpdHkoKSA/IHRoaXMucHJpb3JpdHkoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5wcmlvcml0eSgpOwoKCQlyZXQuX2NhbGxlcl9zZXQgPSB0aGlzLl9jYWxsZXJfc2V0OwoJCXJldC5fY2FsbGVyX2Nvb3AgPSB0aGlzLl9jYWxsZXJfY29vcDsKCQlyZXQuY2FsbGVyID0gdGhpcy5jYWxsZXIoKSA/IHRoaXMuY2FsbGVyKCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMuY2FsbGVyKCk7CgoJCXJldC5fY29udGFjdF9zZXQgPSB0aGlzLl9jb250YWN0X3NldDsKCQlyZXQuX2NvbnRhY3RfY29vcCA9IHRoaXMuX2NvbnRhY3RfY29vcDsKCQlyZXQuY29udGFjdCA9IHRoaXMuY29udGFjdCgpID8gdGhpcy5jb250YWN0KCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMuY29udGFjdCgpOwoKCQlyZXQuX2FjdGl2ZV9zZXQgPSB0aGlzLl9hY3RpdmVfc2V0OwoJCXJldC5fYWN0aXZlX2Nvb3AgPSB0aGlzLl9hY3RpdmVfY29vcDsKCQlyZXQuYWN0aXZlID0gdGhpcy5hY3RpdmUoKSA/IHRoaXMuYWN0aXZlKCkgOiB0aGlzLmFjdGl2ZSgpOwoKCQlyZXQuX2VuYWJsZWRfc2V0ID0gdGhpcy5fZW5hYmxlZF9zZXQ7CgkJcmV0Ll9lbmFibGVkX2Nvb3AgPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJcmV0LmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKSA/IHRoaXMuZW5hYmxlZCgpIDogdGhpcy5lbmFibGVkKCk7CgoJCXJldC5fY29kZV9zZXQgPSB0aGlzLl9jb2RlX3NldDsKCQlyZXQuX2NvZGVfY29vcCA9IHRoaXMuX2NvZGVfY29vcDsKCQlyZXQuY29kZSA9IHRoaXMuY29kZSgpID8gdGhpcy5jb2RlKCkgOiB0aGlzLmNvZGUoKTsKCgkJcmV0Ll9vcmRlcl9zZXQgPSB0aGlzLl9vcmRlcl9zZXQ7CgkJcmV0Ll9vcmRlcl9jb29wID0gdGhpcy5fb3JkZXJfY29vcDsKCQlyZXQub3JkZXIgPSB0aGlzLm9yZGVyKCkgPyB0aGlzLm9yZGVyKCkgOiB0aGlzLm9yZGVyKCk7CgoJCXJldC5fZGF0ZV9zZXQgPSB0aGlzLl9kYXRlX3NldDsKCQlyZXQuX2RhdGVfY29vcCA9IHRoaXMuX2RhdGVfY29vcDsKCQlyZXQuZGF0ZSA9IHRoaXMuZGF0ZSgpID8gdGhpcy5kYXRlKCkgOiB0aGlzLmRhdGUoKTsKCgkJcmV0Ll9uYW1lX3NldCA9IHRoaXMuX25hbWVfc2V0OwoJCXJldC5fbmFtZV9jb29wID0gdGhpcy5fbmFtZV9jb29wOwoJCXJldC5uYW1lID0gdGhpcy5uYW1lKCkgPyB0aGlzLm5hbWUoKSA6IHRoaXMubmFtZSgpOwoKCQlyZXQuX3JlbWFya19zZXQgPSB0aGlzLl9yZW1hcmtfc2V0OwoJCXJldC5fcmVtYXJrX2Nvb3AgPSB0aGlzLl9yZW1hcmtfY29vcDsKCQlyZXQucmVtYXJrID0gdGhpcy5yZW1hcmsoKSA/IHRoaXMucmVtYXJrKCkgOiB0aGlzLnJlbWFyaygpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJudW1iZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbnVtYmVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkidGl0bGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndGl0bGUnLCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpUWlhKMmFXTmxUbTkzSWpvaWMyaHZjblJmWkdWelkzSnBjSFJwYjI0aWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJCQlyZXR1cm4gdmFsdWU7CgkJCQl9KSkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRlc2NyaXB0aW9uIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2Rlc2NyaXB0aW9uJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkibG9jYXRpb24iOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJncm91cCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJInN0YXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N0YXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkic3ltcHRvbSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkiY2xvc2VfcmVhc29uIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJInByaW9yaXR5IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3ByaW9yaXR5JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkiY2FsbGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJImNvbnRhY3QiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJsb2NhdGlvbiIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgbG9jYXRpb24nLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93LkxvY2F0aW9uKCkubG9jYXRpb25fSW5jaWRlbnRzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAiZ3JvdXAiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIGdyb3VwJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Hcm91cCgpLmdyb3VwX0luY2lkZW50cyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInN0YXRlIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBzdGF0ZScsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuU3RhdGUoKS5zdGF0ZV9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJzeW1wdG9tIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBzeW1wdG9tJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5TeW1wdG9tKCkuc3ltcHRvbV9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJjbG9zZV9yZWFzb24iKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIGNsb3NlX3JlYXNvbicsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuUmVhc29uKCkuY2xvc2VfcmVhc29uX0luY2lkZW50cyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInByaW9yaXR5IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBwcmlvcml0eScsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuUHJpb3JpdHkoKS5wcmlvcml0eV9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJjYWxsZXIiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIGNhbGxlcicsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuVXNlcigpLmNhbGxlcl9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJjb250YWN0IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBjb250YWN0Jywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Vc2VyKCkuY29udGFjdF9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCAmJiBldmVudC5jbGFzc05hbWUoKSAmJiBldmVudC5jbGFzc05hbWUoKSAhPSAnSW5jaWRlbnQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiRGVsZWdhdGluZyBpbnZva2F0aW9uIHRvICIgKyBldmVudC5jbGFzc05hbWUoKSk7CgkJCQlyZXR1cm4gbmV3IHNhbGVzbm93W2V2ZW50LmNsYXNzTmFtZSgpXSgpLl9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpOwoJCQl9CgoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQlkYXRhLl9fdGhpcyA9IGRhdGEuX190aGlzIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkJc3dpdGNoIChtZXRob2QpIHsKCgkJCQljYXNlICJ0ZXN0U3luYyI6IHsKCgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJY2FzZSAiaW5Qcm9ncmVzcyI6IHsKCgkJCQkJZGF0YS5yZWFzb24gPSBkYXRhLnJlYXNvbiA/IGRhdGEucmVhc29uCgoJCQkJCQk6CgkJCQkJCXVuZGVmaW5lZDsKCgkJCQkJYnJlYWs7CgkJCQl9CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL0luY2lkZW50LyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7CgoJCQl9CgoJCQkvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8KCgkJCWxldCB2ID0gdW5kZWZpbmVkOwoJCQl0cnkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke21ldGhvZH1gKTsKCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQlsZXQgX2lkID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgZGF0YSwgbWV0aG9kLCB7fSk7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIHsKCQkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKGRhdGEpOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSBkYXRhLl9fdGhpcy5jb2RlIHx8IGRhdGEuaWQgfHwgZGF0YS5JRDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCQlpZiAoZGF0YS5JZCAmJiBkYXRhLklkID09IGRhdGEuSWQpIHsKCQkJCQkJX2lkID0gZGF0YS5JZDsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5FbnRpdHlDbGFzcykgewoJCQkJCQlfaWQgPSBkYXRhLkVudGl0eUNsYXNzLklkIHx8IGRhdGEuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI1YmVlMjM0Yy01ZTQzLTQ0Y2EtOGUwZi00MDJjMmFkZTE5MzQiIHx8ICJOVUxMIjsKCQkJCQl9CgkJCQl9CgoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudCB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbbWV0aG9kXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFttZXRob2RdW19pZF0gfHwge307CgoJCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKHt9LCB7CgkJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJCX0pOwoKCQkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnSW5jaWRlbnQnKS5zZW5kZXIoc2FsZXNub3cuX25vZGUpLmNhcnJpZXIoc2FsZXNub3cuX25vZGUpLnBheWxvYWQoZGF0YSk7CgkJCWlmIChldmVudCkgewoJCQkJaWYgKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOwoJCQkJaWYgKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOwoJCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJaWYgKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOwoJCQl9CgkJCXJldCA9IGF3YWl0IGV2LnRyaWdnZXIoKTsKCgkJCWlmICh0eXBlb2YocmV0KSA9PT0gInN0cmluZyIpIHsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCX0KCQkJcmV0dXJuIHJldDsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJ0ZXN0U3luYyI6IHsKCgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5JbmNpZGVudChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiaW5Qcm9ncmVzcyI6IHsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiaW5zZXJ0IjoKCQkJY2FzZSAidXBkYXRlIjoKCQkJY2FzZSAic3RvcmUiOgoJCQljYXNlICJkZWxldGUiOgoJCQljYXNlICJmaW5kIjogewoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuSW5jaWRlbnQobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX25vZGUpIHsKCQkJLy8gcHJvYmFibHkgc2hvdWxkIG5vdCBiZSBwcm9jZXNzZWQgaGVyZSwgYnV0IHJhdGhlciBjb25zdW1lZCBhcyBwYXJ0IG9mIHRoZSBleGVjdXRlKCkgbG9naWMsIHB1c2hpbmcgX19ub2RlIHRvIHRoZSBsaXN0IG9mIG15IG5vZGVzIHRvIGRlbGVnYXRlIHRvIT8KCQkJbGV0IHRuID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX19ub2RlKS5fZGVSZWZlcmVuY2UoKTsKCQkJZGVsZXRlIF9wYXJhbXMuX19ub2RlOwoJCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2ludm9rZU5vZGUodG4sIG1ldGhvZCwgX3BhcmFtcyk7CgkJfQoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJ0ZXN0U3luYyI6IHsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiaW5Qcm9ncmVzcyI6IHsKCgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnJlYXNvbik7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYEluY2lkZW50Ll9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgSW5jaWRlbnQuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnQuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuSW5jaWRlbnQuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIkluY2lkZW50Iik7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCWlmICh0aGlzLl9sb2NhdGlvbl9zZXQgJiYgdGhpcy5sb2NhdGlvbigpKSB0aGlzLmxvY2F0aW9uKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX2dyb3VwX3NldCAmJiB0aGlzLmdyb3VwKCkpIHRoaXMuZ3JvdXAoKS5fX3N5bmNfb24oZCk7CgoJCQlpZiAodGhpcy5fc3RhdGVfc2V0ICYmIHRoaXMuc3RhdGUoKSkgdGhpcy5zdGF0ZSgpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl9zeW1wdG9tX3NldCAmJiB0aGlzLnN5bXB0b20oKSkgdGhpcy5zeW1wdG9tKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQgJiYgdGhpcy5jbG9zZV9yZWFzb24oKSkgdGhpcy5jbG9zZV9yZWFzb24oKS5fX3N5bmNfb24oZCk7CgoJCQlpZiAodGhpcy5fcHJpb3JpdHlfc2V0ICYmIHRoaXMucHJpb3JpdHkoKSkgdGhpcy5wcmlvcml0eSgpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl9jYWxsZXJfc2V0ICYmIHRoaXMuY2FsbGVyKCkpIHRoaXMuY2FsbGVyKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX2NvbnRhY3Rfc2V0ICYmIHRoaXMuY29udGFjdCgpKSB0aGlzLmNvbnRhY3QoKS5fX3N5bmNfb24oZCk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93LkluY2lkZW50KHRoaXMuSWQpCgoJCQkubnVtYmVyKHRoaXMubnVtYmVyKCksIHRoaXMuX251bWJlcl9jb29wKQoKCQkJLnRpdGxlKHRoaXMudGl0bGUoKSwgdGhpcy5fdGl0bGVfY29vcCkKCgkJCS5kZXNjcmlwdGlvbih0aGlzLmRlc2NyaXB0aW9uKCksIHRoaXMuX2Rlc2NyaXB0aW9uX2Nvb3ApCgoJCQkubG9jYXRpb24odGhpcy5sb2NhdGlvbigpLCB0aGlzLl9sb2NhdGlvbl9jb29wKQoKCQkJLmdyb3VwKHRoaXMuZ3JvdXAoKSwgdGhpcy5fZ3JvdXBfY29vcCkKCgkJCS5zdGF0ZSh0aGlzLnN0YXRlKCksIHRoaXMuX3N0YXRlX2Nvb3ApCgoJCQkuc3ltcHRvbSh0aGlzLnN5bXB0b20oKSwgdGhpcy5fc3ltcHRvbV9jb29wKQoKCQkJLmNsb3NlX3JlYXNvbih0aGlzLmNsb3NlX3JlYXNvbigpLCB0aGlzLl9jbG9zZV9yZWFzb25fY29vcCkKCgkJCS5wcmlvcml0eSh0aGlzLnByaW9yaXR5KCksIHRoaXMuX3ByaW9yaXR5X2Nvb3ApCgoJCQkuY2FsbGVyKHRoaXMuY2FsbGVyKCksIHRoaXMuX2NhbGxlcl9jb29wKQoKCQkJLmNvbnRhY3QodGhpcy5jb250YWN0KCksIHRoaXMuX2NvbnRhY3RfY29vcCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQlvYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ0luY2lkZW50JzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiSW5jaWRlbnQiOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoJCQkJcmV0ID0gcmV0LnRvTG93ZXJDYXNlKCk7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMgPSB7fSkgewoJCXRyeSB7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCA/IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSBvcHRpb25zLnRvb2wgfHwgdCA9PSBvcHRpb25zLnRvb2wpIDogdGhpcy5Ub29sOwoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgfHwge307CgoJCQlsZXQgbklEID0gc2FsZXNub3cuX25vZGUgPyBzYWxlc25vdy5fbm9kZS5jb2RlKCkgOiAiZGVmYXVsdCI7CgoJCQlsZXQgcmV0ID0gbnVsbFZhbHVlOwoJCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXQgPSBudWxsOwoKCQkJLy8gdG9vbF9Db25maWdzOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIGRvbmUKCQkJbGV0IHRjb25mID0gKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmIGMubm9kZSAmJiBjLm5vZGUuY29kZSA9PSBuSUQpLmNvbmNhdCgob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgIWMubm9kZSkpOwoJCQlpZiAodGNvbmYubGVuZ3RoKSB7CgkJCQlyZXQgPSB0Y29uZlswXS52YWx1ZTsKCQkJCXRyeSB7CgkJCQkJWzEsIDIsIDNdLmZvckVhY2goYSA9PiByZXQgPSBKU09OLnBhcnNlKHJldCkpOwoJCQkJfSBjYXRjaCAoamV4KSB7fQoJCQl9CgoJCQkvLyBtb2RlbCBDb25maWc6IENvbmZpZyBpcyBjbGFzcyBsZXZlbCwgbm9kZSBub3QgcG9zc2libGUgLSBwZW5kaW5nCgkJCWxldCBtY29uZiA9IHRoaXMuQ29uZmlnID8gdGhpcy5Db25maWdbbl0gOiB1bmRlZmluZWQ7CgkJCWlmICh0eXBlb2YobWNvbmYpICE9PSAidW5kZWZpbmVkIikgcmV0ID0gbWNvbmY7CgoJCQkvLyBjb21tYW5kIGxpbmU6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnICYmIGdsb2JhbC5taW5pbWlzdCkgewoJCQkJcmV0ID0gZ2xvYmFsLm1pbmltaXN0KHByb2Nlc3MuYXJndi5zbGljZSgyKSlbbl0gfHwgcmV0OwoJCQl9CgoJCQkvLyByZXF1ZXN0OiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJcmV0ID0gdGhpcy4kX1JFUVVFU1QobikgfHwgcmV0OwoKCQkJaWYgKG9wdGlvbnMubmV3VmFsdWUpIHsKCQkJCWxldCB0YyA9IHRjb25mLmxlbmd0aCA/IHRjb25mWzBdIDoge307CgkJCQl0Yy5ub2RlID0gewoJCQkJCWNvZGU6IG9wdGlvbnMubm9kZS5jb2RlKCkKCQkJCX07CgkJCQl0Yy52YWx1ZSA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCQl0Yy5uYW1lID0gbjsKCQkJCWlmICghdGNvbmYubGVuZ3RoKSB7CgkJCQkJb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncy5wdXNoKHRjKTsKCQkJCX0KCQkJCXJldCA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCX0KCgkJCS8vIGNvbmZpZyByZXBsYWNlbWVudAoJCQlpZiAodHlwZW9mKHJldCkgPT09ICdzdHJpbmcnKShyZXQubWF0Y2gobmV3IFJlZ0V4cChge3soW159XSspfX1gLCAiZyIpKSB8fCBbXSkuZm9yRWFjaChtID0+IHJldCA9IHJldC5yZXBsYWNlKG0sIHRoaXMuX19jb25maWcobS5yZXBsYWNlKCd7eycsICcnKS5yZXBsYWNlKCd9fScsICcnKSwgbnVsbCwgb3B0aW9ucykpKTsKCgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19jb25maWcnLCAnRW50aXR5T2JqZWN0JywgMSwgbiwgbnVsbFZhbHVlLCBvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLCBleCk7CgkJfQoJfQoKCS8qKgoJICogU3VtbWFyeS4gdGVzdFN5bmMuCgkgKgoJICogRGVzY3JpcHRpb24uIC4KCSAqCgkgKiBAc2luY2UgICAgICB4LngueAoJICogQGRlcHJlY2F0ZWQgeC54LnggVXNlIG5ld19mdW5jdGlvbl9uYW1lKCkgaW5zdGVhZC4KCSAqIEBhY2Nlc3MgICAgIHB1YmxpYwoJICoKCSAqIEBjbGFzcwoJICogQGF1Z21lbnRzIHBhcmVudAoJICogQG1peGVzICAgIG1peGluCgkgKgoJICogQGFsaWFzICAgIHJlYWxOYW1lCgkgKiBAbWVtYmVyb2YgbmFtZXNwYWNlCgkgKgoJICogQHNlZSAgRnVuY3Rpb24vY2xhc3MgcmVsaWVkIG9uCgkgKiBAbGluayBVUkwKCSAqIEBnbG9iYWwKCSAqCgkgKiBAZmlyZXMgICBldmVudE5hbWUKCSAqIEBmaXJlcyAgIGNsYXNzTmFtZSNldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGV2ZW50OmV2ZW50TmFtZQoJICogQGxpc3RlbnMgY2xhc3NOYW1lfmV2ZW50OmV2ZW50TmFtZQoJICogQHBhcmFtIHt0eXBlfSAgIHZhciAgICAgICAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcl0gICAgICAgICBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyPWRlZmF1bHRdIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlIHdpdGggZGVmYXVsdCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3RWYXIgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIG9iamVjdFZhci5rZXkgRGVzY3JpcHRpb24gb2YgYSBrZXkgaW4gdGhlIG9iamVjdFZhciBwYXJhbWV0ZXIuCgkgKgoJICogQHlpZWxkIHt0eXBlfSBZaWVsZGVkIHZhbHVlIGRlc2NyaXB0aW9uLgoJICoKCSAqIEByZXR1cm4ge3R5cGV9IFJldHVybiB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqLwoJYXN5bmMgdGVzdFN5bmMoKSB7CgoJCWxldCBhbnN3ZXIgPSBuZXcgc2FsZXNub3cuSW5jaWRlbnQoKTsKCgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidGVzdFN5bmMiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidGVzdFN5bmMiLCBfbm9kZSwgKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ0ZXN0U3luYyIsICkgPT4gewoKCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkluY2lkZW50LnRlc3RTeW5jJyk7CgoJCQl2YXIgZXJyb3JzID0gewoKCQkJfTsKCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiAhZXJyb3JzW2tdKS5mb3JFYWNoKGsgPT4gZGVsZXRlIGVycm9yc1trXSk7CgkJCWlmIChPYmplY3Qua2V5cyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJy0nKSkuZm9yRWFjaChrID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0ZXN0U3luYycsICdFbnRpdHlPYmplY3QnLCAwLCB7CgkJCQkJCVtrXTogZXJyb3JzW2tdCgkJCQkJfSk7CgkJCQkJZGVsZXRlIGVycm9yc1trXTsKCQkJCX0pOwoJCQkJaWYgKE9iamVjdC52YWx1ZXMoZXJyb3JzKS5sZW5ndGgpIHsKCQkJCQlyZXR1cm4gewoJCQkJCQlfX2V4Y2VwdGlvbjogZXJyb3JzLAoJCQkJCX07CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJCWxldCBpbmMgPSBhd2FpdCBuZXcgb1Njb3BlLkluY2lkZW50KCkubnVtYmVyKCJJTkMxMjM0IikudGl0bGUoIlRlc3RpbmciKS5ncm91cChuZXcgb1Njb3BlLkdyb3VwKCkubmFtZSgiR3JvdXAxIikpLnN0YXRlKG5ldyBvU2NvcGUuU3RhdGUoKS5uYW1lKCJBc3NpZ25lZCIpKS5wcmlvcml0eShuZXcgb1Njb3BlLlByaW9yaXR5KCkubmFtZSgiSGlnaCIpLmNvZGUoIlAxIikpLmNhbGxlcihuZXcgb1Njb3BlLlVzZXIoKS51c2VybmFtZSgiZmFkaSIpLm5hbWUoIkZhZGkiKSkuc3RvcmUoKTsKCQkJaW5jLlRvb2wgPSAiTW9uZ29EQiI7CgkJCXJldHVybiBhd2FpdCBpbmMuc3RvcmUoKTsKCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXSwKCQl9KTsKCgkJLy8gdGFrZSBvdXQgdGhlIGludmFsaWQgbm9kZSByZXN1bHRzCgkJcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gciAmJiByLnJldCk7CgoJCS8vIGhhcyBhbnkgbm9kZSBnZW5lcmF0ZWQgYSB2YWxpZGF0aW9uIGV4Y2VwdGlvbj8KCQlsZXQgX19leCA9IHJlc3VsdHMuZmluZChyID0+IHIucmV0Ll9fZXhjZXB0aW9uKTsKCQlpZiAoX19leCkgcmV0dXJuIF9fZXgucmV0OwoKCQlyZXR1cm4gcmVzdWx0cy5sZW5ndGggPyByZXN1bHRzWzBdLnJldCA6IG51bGw7CgoJfQoKCS8qKgoJICogU3VtbWFyeS4gaW5Qcm9ncmVzcy4KCSAqCgkgKiBEZXNjcmlwdGlvbi4gLgoJICoKCSAqIEBzaW5jZSAgICAgIHgueC54CgkgKiBAZGVwcmVjYXRlZCB4LngueCBVc2UgbmV3X2Z1bmN0aW9uX25hbWUoKSBpbnN0ZWFkLgoJICogQGFjY2VzcyAgICAgcHVibGljCgkgKgoJICogQGNsYXNzCgkgKiBAYXVnbWVudHMgcGFyZW50CgkgKiBAbWl4ZXMgICAgbWl4aW4KCSAqCgkgKiBAYWxpYXMgICAgcmVhbE5hbWUKCSAqIEBtZW1iZXJvZiBuYW1lc3BhY2UKCSAqCgkgKiBAc2VlICBGdW5jdGlvbi9jbGFzcyByZWxpZWQgb24KCSAqIEBsaW5rIFVSTAoJICogQGdsb2JhbAoJICoKCSAqIEBmaXJlcyAgIGV2ZW50TmFtZQoJICogQGZpcmVzICAgY2xhc3NOYW1lI2V2ZW50TmFtZQoJICogQGxpc3RlbnMgZXZlbnQ6ZXZlbnROYW1lCgkgKiBAbGlzdGVucyBjbGFzc05hbWV+ZXZlbnQ6ZXZlbnROYW1lCgkgKiBAcGFyYW0ge3R5cGV9ICAgdmFyICAgICAgICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyXSAgICAgICAgIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXI9ZGVmYXVsdF0gRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUgd2l0aCBkZWZhdWx0IHZhcmlhYmxlLgoJICogQHBhcmFtIHtPYmplY3R9IG9iamVjdFZhciAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgb2JqZWN0VmFyLmtleSBEZXNjcmlwdGlvbiBvZiBhIGtleSBpbiB0aGUgb2JqZWN0VmFyIHBhcmFtZXRlci4KCSAqCgkgKiBAeWllbGQge3R5cGV9IFlpZWxkZWQgdmFsdWUgZGVzY3JpcHRpb24uCgkgKgoJICogQHJldHVybiB7dHlwZX0gUmV0dXJuIHZhbHVlIGRlc2NyaXB0aW9uLgoJICovCglhc3luYyBpblByb2dyZXNzKHJlYXNvbikgewoKCQlsZXQgYW5zd2VyID0gZmFsc2U7CgoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluUHJvZ3Jlc3MiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5Qcm9ncmVzcyIsIF9ub2RlLCByZWFzb24pID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluUHJvZ3Jlc3MiLCByZWFzb24pID0+IHsKCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5JbmNpZGVudC5pblByb2dyZXNzJyk7CgoJCQl2YXIgZXJyb3JzID0gewoKCQkJfTsKCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiAhZXJyb3JzW2tdKS5mb3JFYWNoKGsgPT4gZGVsZXRlIGVycm9yc1trXSk7CgkJCWlmIChPYmplY3Qua2V5cyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJy0nKSkuZm9yRWFjaChrID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpblByb2dyZXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIHsKCQkJCQkJW2tdOiBlcnJvcnNba10KCQkJCQl9KTsKCQkJCQlkZWxldGUgZXJyb3JzW2tdOwoJCQkJfSk7CgkJCQlpZiAoT2JqZWN0LnZhbHVlcyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJCXJldHVybiB7CgkJCQkJCV9fZXhjZXB0aW9uOiBlcnJvcnMsCgkJCQkJfTsKCQkJCX0KCQkJCXJldHVybjsKCQkJfQoKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdLAoJCQlyZWFzb246IHJlYXNvbgoJCX0pOwoKCQkvLyB0YWtlIG91dCB0aGUgaW52YWxpZCBub2RlIHJlc3VsdHMKCQlyZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByICYmIHIucmV0KTsKCgkJLy8gaGFzIGFueSBub2RlIGdlbmVyYXRlZCBhIHZhbGlkYXRpb24gZXhjZXB0aW9uPwoJCWxldCBfX2V4ID0gcmVzdWx0cy5maW5kKHIgPT4gci5yZXQuX19leGNlcHRpb24pOwoJCWlmIChfX2V4KSByZXR1cm4gX19leC5yZXQ7CgoJCXJldHVybiByZXN1bHRzLmxlbmd0aCA/IHJlc3VsdHNbMF0ucmV0IDogbnVsbDsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgoJCQkJCS8vIGlmKHRoaXNbJ18nK2ZpZWxkKydfc2V0J10gJiYgKHR5cGVvZih0aGlzWydfJytmaWVsZF0pPT09J3VuZGVmaW5lZCcgfHwgdGhpc1snXycrZmllbGRdPT1udWxsKSkgcmV0dXJuOwoJCQkJCS8vIGlmKHR5cGVvZihlYU9iaik9PT0ndW5kZWZpbmVkJykgcmV0dXJuOyAvLyB3aHk/CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlyZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoIm51bWJlciIsIG9iaiwgdGhpcy5udW1iZXIoKSk7CgoJCV9vcHRpb25zKCJ0aXRsZSIsIG9iaiwgdGhpcy50aXRsZSgpKTsKCgkJX29wdGlvbnMoImRlc2NyaXB0aW9uIiwgb2JqLCB0aGlzLmRlc2NyaXB0aW9uKCkpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjViZWUyMzRjLTVlNDMtNDRjYS04ZTBmLTQwMmMyYWRlMTkzNCIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnQgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlpZiAoIXRoaXMubG9jYXRpb24oKSB8fCAodGhpcy5sb2NhdGlvbigpCgoJCQkJJiYKCQkJCSF0aGlzLmxvY2F0aW9uKCkubG9jYXRpb25fSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJsb2NhdGlvbiIsIG9iaiwgdGhpcy5sb2NhdGlvbigpKTsKCQl9CgoJCWlmICghdGhpcy5ncm91cCgpIHx8ICh0aGlzLmdyb3VwKCkKCgkJCQkmJgoJCQkJIXRoaXMuZ3JvdXAoKS5ncm91cF9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuZ3JvdXAoKS5ncm91cF9Hcm91cF9NZW1iZXJzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJncm91cCIsIG9iaiwgdGhpcy5ncm91cCgpKTsKCQl9CgoJCWlmICghdGhpcy5zdGF0ZSgpIHx8ICh0aGlzLnN0YXRlKCkKCgkJCQkmJgoJCQkJIXRoaXMuc3RhdGUoKS5zdGF0ZV9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoInN0YXRlIiwgb2JqLCB0aGlzLnN0YXRlKCkpOwoJCX0KCgkJaWYgKCF0aGlzLnN5bXB0b20oKSB8fCAodGhpcy5zeW1wdG9tKCkKCgkJCQkmJgoJCQkJIXRoaXMuc3ltcHRvbSgpLnN5bXB0b21fSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJzeW1wdG9tIiwgb2JqLCB0aGlzLnN5bXB0b20oKSk7CgkJfQoKCQlpZiAoIXRoaXMuY2xvc2VfcmVhc29uKCkgfHwgKHRoaXMuY2xvc2VfcmVhc29uKCkKCgkJCQkmJgoJCQkJIXRoaXMuY2xvc2VfcmVhc29uKCkuY2xvc2VfcmVhc29uX0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygiY2xvc2VfcmVhc29uIiwgb2JqLCB0aGlzLmNsb3NlX3JlYXNvbigpKTsKCQl9CgoJCWlmICghdGhpcy5wcmlvcml0eSgpIHx8ICh0aGlzLnByaW9yaXR5KCkKCgkJCQkmJgoJCQkJIXRoaXMucHJpb3JpdHkoKS5wcmlvcml0eV9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoInByaW9yaXR5Iiwgb2JqLCB0aGlzLnByaW9yaXR5KCkpOwoJCX0KCgkJaWYgKCF0aGlzLmNhbGxlcigpIHx8ICh0aGlzLmNhbGxlcigpCgoJCQkJJiYKCQkJCSF0aGlzLmNhbGxlcigpLm1hbmFnZXJfRGVwYXJ0bWVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuY2FsbGVyKCkuY2FsbGVyX0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jYWxsZXIoKS5jb250YWN0X0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jYWxsZXIoKS51c2VyX0dyb3VwX01lbWJlcnMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoImNhbGxlciIsIG9iaiwgdGhpcy5jYWxsZXIoKSk7CgkJfQoKCQlpZiAoIXRoaXMuY29udGFjdCgpIHx8ICh0aGlzLmNvbnRhY3QoKQoKCQkJCSYmCgkJCQkhdGhpcy5jb250YWN0KCkubWFuYWdlcl9EZXBhcnRtZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jb250YWN0KCkuY2FsbGVyX0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jb250YWN0KCkuY29udGFjdF9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuY29udGFjdCgpLnVzZXJfR3JvdXBfTWVtYmVycygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygiY29udGFjdCIsIG9iaiwgdGhpcy5jb250YWN0KCkpOwoJCX0KCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnbnVtYmVyJywgJ3RpdGxlJywgJ2Rlc2NyaXB0aW9uJywgJ2xvY2F0aW9uJywgJ2dyb3VwJywgJ3N0YXRlJywgJ3N5bXB0b20nLCAnY2xvc2VfcmVhc29uJywgJ3ByaW9yaXR5JywgJ2NhbGxlcicsICdjb250YWN0JywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWycnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIkluY2lkZW50IiAmJiAobS50YXJnZXQgfHwgbS5vdXRTY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkgJiYgKCFtLnNvdXJjZSB8fCAobS5zb3VyY2UgJiYgLyohbS5vdXRTY3JpcHQgJiYqLyB0aGlzWydfJyArIG0uc291cmNlICsgJ19zZXQnXSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0ub3V0U2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5vdXRTY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5vdXRTY3JpcHR9KX1gKSh0aGlzLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS5zb3VyY2UpIHsKCQkJCWlmIChtLnNvdXJjZS5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMpID0+IHtyZXR1cm4gX3RoaXMuJHttLnNvdXJjZX07fWApKHRoaXMpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS5zb3VyY2UsIHRoaXMpOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnRhcmdldCkgb2JqW20udGFyZ2V0XSA9IHJldDsKCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJW20udGFyZ2V0IHx8IG0uc291cmNlXTogdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddCgkJCX0pOwoJCX0pOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCS8vIHVzZSB0aGlzLl9tYXAoKSB3aXRoIHJldmVyc2UKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoIm51bWJlciIsIG9iaik7CgoJCV9vcHRpb25zKCJ0aXRsZSIsIG9iaik7CgoJCV9vcHRpb25zKCJkZXNjcmlwdGlvbiIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjViZWUyMzRjLTVlNDMtNDRjYS04ZTBmLTQwMmMyYWRlMTkzNCIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnQgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJsb2NhdGlvbiIsIG9iaik7CgoJCV9vcHRpb25zKCJncm91cCIsIG9iaik7CgoJCV9vcHRpb25zKCJzdGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJzeW1wdG9tIiwgb2JqKTsKCgkJX29wdGlvbnMoImNsb3NlX3JlYXNvbiIsIG9iaik7CgoJCV9vcHRpb25zKCJwcmlvcml0eSIsIG9iaik7CgoJCV9vcHRpb25zKCJjYWxsZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiY29udGFjdCIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ251bWJlcicsICd0aXRsZScsICdkZXNjcmlwdGlvbicsICdsb2NhdGlvbicsICdncm91cCcsICdzdGF0ZScsICdzeW1wdG9tJywgJ2Nsb3NlX3JlYXNvbicsICdwcmlvcml0eScsICdjYWxsZXInLCAnY29udGFjdCcsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJJbmNpZGVudCIgJiYgKG0uc291cmNlIHx8IG0uaW5TY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5pblNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmosIG9TY29wZSwgbWFwKSA9PiB7JHttLmluU2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20uaW5TY3JpcHR9KX1gKShvYmosIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnRhcmdldCkgewoJCQkJaWYgKG0udGFyZ2V0LmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmopID0+IHtyZXR1cm4gb2JqLiR7bS50YXJnZXR9O31gKShvYmopOwoJCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqW20udGFyZ2V0XSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0udGFyZ2V0LCBvYmopOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0uc291cmNlKSB7CgkJCQlpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXRoaXNbbS5zb3VyY2VdKHJldCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXNbbS5zb3VyY2VdID0gcmV0OwoJCQkJfQoJCQl9CgkJfSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuSW5jaWRlbnQpIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuSW5jaWRlbnQgPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJJbmNpZGVudCIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQludW1iZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm51bWJlciA9IHYgPT0gcXVlcnkubnVtYmVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX251bWJlcl9zZXQgJiYgIXF1ZXJ5Ll9udW1iZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm51bWJlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9udW1iZXJfc2V0ICYmIHF1ZXJ5Ll9udW1iZXJfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5udW1iZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJdGl0bGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnRpdGxlID0gdiA9PSBxdWVyeS50aXRsZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl90aXRsZV9zZXQgJiYgIXF1ZXJ5Ll90aXRsZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudGl0bGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fdGl0bGVfc2V0ICYmIHF1ZXJ5Ll90aXRsZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnRpdGxlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRlc2NyaXB0aW9uOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5kZXNjcmlwdGlvbiA9IHYgPT0gcXVlcnkuZGVzY3JpcHRpb24oKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGVzY3JpcHRpb25fc2V0ICYmICFxdWVyeS5fZGVzY3JpcHRpb25fc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRlc2NyaXB0aW9uID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2Rlc2NyaXB0aW9uX3NldCAmJiBxdWVyeS5fZGVzY3JpcHRpb25fc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kZXNjcmlwdGlvbiA9IGZhbHNlOwoJCQkJfSwKCgkJCQlsb2NhdGlvbjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubG9jYXRpb24gPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LmxvY2F0aW9uKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2xvY2F0aW9uX3NldCAmJiAhcXVlcnkuX2xvY2F0aW9uX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5sb2NhdGlvbiA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9sb2NhdGlvbl9zZXQgJiYgcXVlcnkuX2xvY2F0aW9uX3NldCkgfHwKCgkJCQkJCSh0aGlzLmxvY2F0aW9uKCkgJiYgIXRoaXMubG9jYXRpb24oKS5fbWF0Y2hlcyhxdWVyeS5sb2NhdGlvbigpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubG9jYXRpb24gPSBmYWxzZTsKCQkJCX0sCgoJCQkJZ3JvdXA6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmdyb3VwID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5ncm91cCgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9ncm91cF9zZXQgJiYgIXF1ZXJ5Ll9ncm91cF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZ3JvdXAgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZ3JvdXBfc2V0ICYmIHF1ZXJ5Ll9ncm91cF9zZXQpIHx8CgoJCQkJCQkodGhpcy5ncm91cCgpICYmICF0aGlzLmdyb3VwKCkuX21hdGNoZXMocXVlcnkuZ3JvdXAoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmdyb3VwID0gZmFsc2U7CgkJCQl9LAoKCQkJCXN0YXRlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5zdGF0ZSA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkuc3RhdGUoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fc3RhdGVfc2V0ICYmICFxdWVyeS5fc3RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnN0YXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3N0YXRlX3NldCAmJiBxdWVyeS5fc3RhdGVfc2V0KSB8fAoKCQkJCQkJKHRoaXMuc3RhdGUoKSAmJiAhdGhpcy5zdGF0ZSgpLl9tYXRjaGVzKHF1ZXJ5LnN0YXRlKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5zdGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlzeW1wdG9tOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5zeW1wdG9tID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5zeW1wdG9tKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3N5bXB0b21fc2V0ICYmICFxdWVyeS5fc3ltcHRvbV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouc3ltcHRvbSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9zeW1wdG9tX3NldCAmJiBxdWVyeS5fc3ltcHRvbV9zZXQpIHx8CgoJCQkJCQkodGhpcy5zeW1wdG9tKCkgJiYgIXRoaXMuc3ltcHRvbSgpLl9tYXRjaGVzKHF1ZXJ5LnN5bXB0b20oKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnN5bXB0b20gPSBmYWxzZTsKCQkJCX0sCgoJCQkJY2xvc2VfcmVhc29uOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jbG9zZV9yZWFzb24gPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LmNsb3NlX3JlYXNvbigpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jbG9zZV9yZWFzb25fc2V0ICYmICFxdWVyeS5fY2xvc2VfcmVhc29uX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jbG9zZV9yZWFzb24gPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY2xvc2VfcmVhc29uX3NldCAmJiBxdWVyeS5fY2xvc2VfcmVhc29uX3NldCkgfHwKCgkJCQkJCSh0aGlzLmNsb3NlX3JlYXNvbigpICYmICF0aGlzLmNsb3NlX3JlYXNvbigpLl9tYXRjaGVzKHF1ZXJ5LmNsb3NlX3JlYXNvbigpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY2xvc2VfcmVhc29uID0gZmFsc2U7CgkJCQl9LAoKCQkJCXByaW9yaXR5OiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5wcmlvcml0eSA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkucHJpb3JpdHkoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcHJpb3JpdHlfc2V0ICYmICFxdWVyeS5fcHJpb3JpdHlfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnByaW9yaXR5ID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3ByaW9yaXR5X3NldCAmJiBxdWVyeS5fcHJpb3JpdHlfc2V0KSB8fAoKCQkJCQkJKHRoaXMucHJpb3JpdHkoKSAmJiAhdGhpcy5wcmlvcml0eSgpLl9tYXRjaGVzKHF1ZXJ5LnByaW9yaXR5KCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5wcmlvcml0eSA9IGZhbHNlOwoJCQkJfSwKCgkJCQljYWxsZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNhbGxlciA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkuY2FsbGVyKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NhbGxlcl9zZXQgJiYgIXF1ZXJ5Ll9jYWxsZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNhbGxlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jYWxsZXJfc2V0ICYmIHF1ZXJ5Ll9jYWxsZXJfc2V0KSB8fAoKCQkJCQkJKHRoaXMuY2FsbGVyKCkgJiYgIXRoaXMuY2FsbGVyKCkuX21hdGNoZXMocXVlcnkuY2FsbGVyKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jYWxsZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY29udGFjdDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY29udGFjdCA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkuY29udGFjdCgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jb250YWN0X3NldCAmJiAhcXVlcnkuX2NvbnRhY3Rfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvbnRhY3QgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY29udGFjdF9zZXQgJiYgcXVlcnkuX2NvbnRhY3Rfc2V0KSB8fAoKCQkJCQkJKHRoaXMuY29udGFjdCgpICYmICF0aGlzLmNvbnRhY3QoKS5fbWF0Y2hlcyhxdWVyeS5jb250YWN0KCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb250YWN0ID0gZmFsc2U7CgkJCQl9LAoKCQkJCWFjdGl2ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouYWN0aXZlID0gdiA9PSBxdWVyeS5hY3RpdmUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fYWN0aXZlX3NldCAmJiAhcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2FjdGl2ZV9zZXQgJiYgcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5lbmFibGVkID0gdiA9PSBxdWVyeS5lbmFibGVkKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ICYmICFxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9lbmFibGVkX3NldCAmJiBxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY29kZSA9IHYgPT0gcXVlcnkuY29kZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jb2RlX3NldCAmJiAhcXVlcnkuX2NvZGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY29kZV9zZXQgJiYgcXVlcnkuX2NvZGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vcmRlciA9IHYgPT0gcXVlcnkub3JkZXIoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fb3JkZXJfc2V0ICYmICFxdWVyeS5fb3JkZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX29yZGVyX3NldCAmJiBxdWVyeS5fb3JkZXJfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5kYXRlID0gdiA9PSBxdWVyeS5kYXRlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2RhdGVfc2V0ICYmICFxdWVyeS5fZGF0ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9kYXRlX3NldCAmJiBxdWVyeS5fZGF0ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubmFtZSA9IHYgPT0gcXVlcnkubmFtZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9uYW1lX3NldCAmJiAhcXVlcnkuX25hbWVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbmFtZV9zZXQgJiYgcXVlcnkuX25hbWVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gZmFsc2U7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucmVtYXJrID0gdiA9PSBxdWVyeS5yZW1hcmsoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcmVtYXJrX3NldCAmJiAhcXVlcnkuX3JlbWFya19zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3JlbWFya19zZXQgJiYgcXVlcnkuX3JlbWFya19zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IGZhbHNlOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWxvY2F0aW9uOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgbG9jYXRpb24iKTsKCQkJCQlvYmoubG9jYXRpb24gPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQlncm91cDogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIGdyb3VwIik7CgkJCQkJb2JqLmdyb3VwID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJc3RhdGU6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBzdGF0ZSIpOwoJCQkJCW9iai5zdGF0ZSA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCXN5bXB0b206IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBzeW1wdG9tIik7CgkJCQkJb2JqLnN5bXB0b20gPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQljbG9zZV9yZWFzb246IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBjbG9zZV9yZWFzb24iKTsKCQkJCQlvYmouY2xvc2VfcmVhc29uID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJcHJpb3JpdHk6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBwcmlvcml0eSIpOwoJCQkJCW9iai5wcmlvcml0eSA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCWNhbGxlcjogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIGNhbGxlciIpOwoJCQkJCW9iai5jYWxsZXIgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQljb250YWN0OiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgY29udGFjdCIpOwoJCQkJCW9iai5jb250YWN0ID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fbnVtYmVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3RpdGxlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2Rlc2NyaXB0aW9uX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2xvY2F0aW9uX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2dyb3VwX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3N0YXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3N5bXB0b21fc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY2xvc2VfcmVhc29uX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3ByaW9yaXR5X3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NhbGxlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb250YWN0X3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJbG9jYXRpb246IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5sb2NhdGlvbihyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJZ3JvdXA6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5ncm91cChyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJc3RhdGU6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5zdGF0ZShyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJc3ltcHRvbTogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLnN5bXB0b20ocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCWNsb3NlX3JlYXNvbjogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLmNsb3NlX3JlYXNvbihyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJcHJpb3JpdHk6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5wcmlvcml0eShyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJY2FsbGVyOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMuY2FsbGVyKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQljb250YWN0OiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMuY29udGFjdChyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQludW1iZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdudW1iZXInLCB1bmRlZmluZWQpIDogIm51bWJlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9udW1iZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm51bWJlcihyZWYpOwoKCQkJfSwKCgkJCXRpdGxlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndGl0bGUnLCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpUWlhKMmFXTmxUbTkzSWpvaWMyaHZjblJmWkdWelkzSnBjSFJwYjI0aWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQkJcmV0dXJuIHZhbHVlOwoJCQl9KSkgOiAidGl0bGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fdGl0bGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnRpdGxlKHJlZik7CgoJCQl9LAoKCQkJZGVzY3JpcHRpb246IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkZXNjcmlwdGlvbicsIHVuZGVmaW5lZCkgOiAiZGVzY3JpcHRpb24iKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZGVzY3JpcHRpb25fY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmRlc2NyaXB0aW9uKHJlZik7CgoJCQl9LAoKCQkJbG9jYXRpb246IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdsb2NhdGlvbicsIHVuZGVmaW5lZCkgOiAibG9jYXRpb24iKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbG9jYXRpb25fY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMubG9jYXRpb24oKSB8fCBuZXcgc2FsZXNub3cuTG9jYXRpb24oKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLmxvY2F0aW9uKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgbG9jYXRpb24iLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCWdyb3VwOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpIDogImdyb3VwIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2dyb3VwX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLmdyb3VwKCkgfHwgbmV3IHNhbGVzbm93Lkdyb3VwKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5ncm91cChvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIGdyb3VwIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQlzdGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3N0YXRlJywgdW5kZWZpbmVkKSA6ICJzdGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9zdGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5zdGF0ZSgpIHx8IG5ldyBzYWxlc25vdy5TdGF0ZSgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuc3RhdGUob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSBzdGF0ZSIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJc3ltcHRvbTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3N5bXB0b20nLCB1bmRlZmluZWQpIDogInN5bXB0b20iKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fc3ltcHRvbV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5zeW1wdG9tKCkgfHwgbmV3IHNhbGVzbm93LlN5bXB0b20oKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLnN5bXB0b20ob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSBzeW1wdG9tIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQljbG9zZV9yZWFzb246IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpIDogImNsb3NlX3JlYXNvbiIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jbG9zZV9yZWFzb25fY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMuY2xvc2VfcmVhc29uKCkgfHwgbmV3IHNhbGVzbm93LlJlYXNvbigpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuY2xvc2VfcmVhc29uKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgY2xvc2VfcmVhc29uIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQlwcmlvcml0eTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3ByaW9yaXR5JywgdW5kZWZpbmVkKSA6ICJwcmlvcml0eSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9wcmlvcml0eV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5wcmlvcml0eSgpIHx8IG5ldyBzYWxlc25vdy5Qcmlvcml0eSgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMucHJpb3JpdHkob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSBwcmlvcml0eSIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJY2FsbGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKSA6ICJjYWxsZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY2FsbGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLmNhbGxlcigpIHx8IG5ldyBzYWxlc25vdy5Vc2VyKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5jYWxsZXIob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSBjYWxsZXIiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCWNvbnRhY3Q6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb250YWN0JywgdW5kZWZpbmVkKSA6ICJjb250YWN0IikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvbnRhY3RfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMuY29udGFjdCgpIHx8IG5ldyBzYWxlc25vdy5Vc2VyKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5jb250YWN0KG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgY29udGFjdCIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQl9LCAiX2Zyb21Eb2N1bWVudCIpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSB7CgkJbGV0IHJldCA9IHt9OwoKCQlpZiAoIWJUb29sKSB7CgkJCXJldC5fX2dlbmVyYXRlZCA9IG5ldyBEYXRlKCk7CgkJCWlmICh0aGlzLlRvb2wubmFtZSkgewoJCQkJcmV0Ll9fdG9vbCA9IHsKCQkJCQluYW1lOiB0aGlzLlRvb2wubmFtZSwKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlpZiAoc2FsZXNub3cuX25vZGUpIHsKCQkJCXJldC5fX25vZGUgPSB7CgkJCQkJY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogYkZ1bGwsCgkJCU51bGw6IGJOdWxsLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXSA9IHYsCgoJCQkibnVtYmVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ251bWJlcicsIHVuZGVmaW5lZCkgOiAibnVtYmVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX251bWJlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbnVtYmVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkidGl0bGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndGl0bGUnLCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpUWlhKMmFXTmxUbTkzSWpvaWMyaHZjblJmWkdWelkzSnBjSFJwYjI0aWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQkJcmV0dXJuIHZhbHVlOwoJCQl9KSkgOiAidGl0bGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fdGl0bGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3RpdGxlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGVzY3JpcHRpb24iOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGVzY3JpcHRpb24nLCB1bmRlZmluZWQpIDogImRlc2NyaXB0aW9uIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2Rlc2NyaXB0aW9uX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kZXNjcmlwdGlvbl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImxvY2F0aW9uIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKSA6ICJsb2NhdGlvbiIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX2xvY2F0aW9uX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9sb2NhdGlvbl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImdyb3VwIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSA6ICJncm91cCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX2dyb3VwX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9ncm91cF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInN0YXRlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3N0YXRlJywgdW5kZWZpbmVkKSA6ICJzdGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX3N0YXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9zdGF0ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInN5bXB0b20iOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCkgOiAic3ltcHRvbSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX3N5bXB0b21fY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3N5bXB0b21fY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjbG9zZV9yZWFzb24iOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uJywgdW5kZWZpbmVkKSA6ICJjbG9zZV9yZWFzb24iKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl9jbG9zZV9yZWFzb25fY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2Nsb3NlX3JlYXNvbl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInByaW9yaXR5IjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3ByaW9yaXR5JywgdW5kZWZpbmVkKSA6ICJwcmlvcml0eSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX3ByaW9yaXR5X2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9wcmlvcml0eV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNhbGxlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpIDogImNhbGxlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX2NhbGxlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY2FsbGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29udGFjdCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb250YWN0JywgdW5kZWZpbmVkKSA6ICJjb250YWN0IikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fY29udGFjdF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29udGFjdF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJYnlMb2NhdGlvbihhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfbG9jYXRpb24iXSAmJiAoYVsiX2xvY2F0aW9uIl0uRXF1YWxzID8gYVsiX2xvY2F0aW9uIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9sb2NhdGlvbiJdLCByKSkpIHsKCQkJCQlyLl9sb2NhdGlvbl9JbmNpZGVudHMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglieUdyb3VwKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9ncm91cCJdICYmIChhWyJfZ3JvdXAiXS5FcXVhbHMgPyBhWyJfZ3JvdXAiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX2dyb3VwIl0sIHIpKSkgewoJCQkJCXIuX2dyb3VwX0luY2lkZW50cy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5U3RhdGUoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX3N0YXRlIl0gJiYgKGFbIl9zdGF0ZSJdLkVxdWFscyA/IGFbIl9zdGF0ZSJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfc3RhdGUiXSwgcikpKSB7CgkJCQkJci5fc3RhdGVfSW5jaWRlbnRzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlTeW1wdG9tKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9zeW1wdG9tIl0gJiYgKGFbIl9zeW1wdG9tIl0uRXF1YWxzID8gYVsiX3N5bXB0b20iXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX3N5bXB0b20iXSwgcikpKSB7CgkJCQkJci5fc3ltcHRvbV9JbmNpZGVudHMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglieVJlYXNvbihhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfY2xvc2VfcmVhc29uIl0gJiYgKGFbIl9jbG9zZV9yZWFzb24iXS5FcXVhbHMgPyBhWyJfY2xvc2VfcmVhc29uIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9jbG9zZV9yZWFzb24iXSwgcikpKSB7CgkJCQkJci5fY2xvc2VfcmVhc29uX0luY2lkZW50cy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5UHJpb3JpdHkoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX3ByaW9yaXR5Il0gJiYgKGFbIl9wcmlvcml0eSJdLkVxdWFscyA/IGFbIl9wcmlvcml0eSJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfcHJpb3JpdHkiXSwgcikpKSB7CgkJCQkJci5fcHJpb3JpdHlfSW5jaWRlbnRzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlVc2VyKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9jYWxsZXIiXSAmJiAoYVsiX2NhbGxlciJdLkVxdWFscyA/IGFbIl9jYWxsZXIiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX2NhbGxlciJdLCByKSkpIHsKCQkJCQlyLl9jYWxsZXJfSW5jaWRlbnRzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlVc2VyKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9jb250YWN0Il0gJiYgKGFbIl9jb250YWN0Il0uRXF1YWxzID8gYVsiX2NvbnRhY3QiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX2NvbnRhY3QiXSwgcikpKSB7CgkJCQkJci5fY29udGFjdF9JbmNpZGVudHMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuX25hbWU7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IGZhbHNlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuSW5jaWRlbnQuc3RvcmUnKTsgLy8gb3IgaW5zaWRlIGV4ZWN1dGU/CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJbGV0IGJVcGRhdGUgPSBmYWxzZTsKCQkJbGV0IGJJbnNlcnQgPSBmYWxzZTsKCgkJCWlmICghdGhpcy5fX3N5bmNfb24oKSkgewoJCQkJbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LkluY2lkZW50KG51bGwsIHRoaXMuVG9vbCk7CgoJCQkJbGV0IGJGaW5kID0gZmFsc2U7CgkJCQlpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLklkID0gdGhpcy5JZDsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5udW1iZXIodGhpcy5udW1iZXIoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5jb2RlKHRoaXMuY29kZSgpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSB7CgkJCQkJdGhpcy5hY3RpdmUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSB7CgkJCQkJdGhpcy5lbmFibGVkKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgewoJCQkJCXRoaXMuZGF0ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSBuZXcgRGF0ZSgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9sb2NhdGlvbl9zZXQgJiYgdGhpcy5sb2NhdGlvbigpICYmICEoYXdhaXQgdGhpcy5sb2NhdGlvbigpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX2xvY2F0aW9uKCk7CgoJCQkJCWlmICh0aGlzLl9ncm91cF9zZXQgJiYgdGhpcy5ncm91cCgpICYmICEoYXdhaXQgdGhpcy5ncm91cCgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX2dyb3VwKCk7CgoJCQkJCWlmICh0aGlzLl9zdGF0ZV9zZXQgJiYgdGhpcy5zdGF0ZSgpICYmICEoYXdhaXQgdGhpcy5zdGF0ZSgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX3N0YXRlKCk7CgoJCQkJCWlmICh0aGlzLl9zeW1wdG9tX3NldCAmJiB0aGlzLnN5bXB0b20oKSAmJiAhKGF3YWl0IHRoaXMuc3ltcHRvbSgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX3N5bXB0b20oKTsKCgkJCQkJaWYgKHRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQgJiYgdGhpcy5jbG9zZV9yZWFzb24oKSAmJiAhKGF3YWl0IHRoaXMuY2xvc2VfcmVhc29uKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfY2xvc2VfcmVhc29uKCk7CgoJCQkJCWlmICh0aGlzLl9wcmlvcml0eV9zZXQgJiYgdGhpcy5wcmlvcml0eSgpICYmICEoYXdhaXQgdGhpcy5wcmlvcml0eSgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX3ByaW9yaXR5KCk7CgoJCQkJCWlmICh0aGlzLl9jYWxsZXJfc2V0ICYmIHRoaXMuY2FsbGVyKCkgJiYgIShhd2FpdCB0aGlzLmNhbGxlcigpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX2NhbGxlcigpOwoKCQkJCQlpZiAodGhpcy5fY29udGFjdF9zZXQgJiYgdGhpcy5jb250YWN0KCkgJiYgIShhd2FpdCB0aGlzLmNvbnRhY3QoKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9jb250YWN0KCk7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fX2Fzc2VydFZhbGlkKHRydWUpKSByZXR1cm4gbnVsbDsKCgkJCQkvL2F3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8gaW4gY2FzZSBUb29sIGNoYW5nZXMKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgQWJvdXQgdG8gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9YCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgRmluaXNoZWQgSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9IElkPVske3RoaXMuSWR9XWApOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuSW5jaWRlbnQuaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuSW5jaWRlbnQudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5JbmNpZGVudC5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCk7CgkJCQlyZXQgPSByZXQuY29udGVudCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5JbmNpZGVudChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93LlN0YXRlID0gY2xhc3MgU3RhdGUgZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRc0tpNWZiRzloWkZSdmIyeHpMQ291WVhWMGFFTnZaR1VzUlhabGJuUXViR2x6ZEdWdUxFVjJaVzUwTG5CeWIyTmxjM01zUlhabGJuUXVkSEpwWjJkbGNpSjlgKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlBRWFYwYUZOaGJtUWlMQ0pIYVhSSWRXSWlYUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2FjdGl2ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2VuYWJsZWQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb2RlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb2RlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3JkZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29yZGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZGF0ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZGF0ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm5hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX25hbWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3JlbWFyaygpOwoKCQl0aGlzLmNsZWFyX3N0YXRlX0luY2lkZW50cygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIlN0YXRlIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQkvLyAodGhpcy5zdGF0ZV9JbmNpZGVudHMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc3RhdGVfSW5jaWRlbnRzICoqLwoJc3RhdGVfSW5jaWRlbnRzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9zdGF0ZV9JbmNpZGVudHM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzViZWUyMzRjLTVlNDMtNDRjYS04ZTBmLTQwMmMyYWRlMTkzNCcgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnSW5jaWRlbnQnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX3N0YXRlX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0YXRlX0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAic3RhdGUgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkluY2lkZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RhdGVfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJzdGF0ZSBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkluY2lkZW50Iik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LnN0YXRlKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX3N0YXRlX0luY2lkZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX3N0YXRlX0luY2lkZW50c19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fc3RhdGVfSW5jaWRlbnRzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9zdGF0ZV9JbmNpZGVudHMoKSB7CgkJdGhpcy5fc3RhdGVfSW5jaWRlbnRzX3NldCA9IG51bGw7CgkJdGhpcy5fc3RhdGVfSW5jaWRlbnRzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fc3RhdGVfSW5jaWRlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc3RhdGVfSW5jaWRlbnRzICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJCXRoaXMuX3N0YXRlX0luY2lkZW50c19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0LnN0YXRlX0luY2lkZW50cyA9IHRoaXMuc3RhdGVfSW5jaWRlbnRzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQlzdGF0ZV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzdGF0ZV9TdGF0ZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkgIT0gJ1N0YXRlJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL1N0YXRlLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7CgoJCQl9CgoJCQkvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8KCgkJCWxldCB2ID0gdW5kZWZpbmVkOwoJCQl0cnkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke21ldGhvZH1gKTsKCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQlsZXQgX2lkID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgZGF0YSwgbWV0aG9kLCB7fSk7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIHsKCQkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKGRhdGEpOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSBkYXRhLl9fdGhpcy5jb2RlIHx8IGRhdGEuaWQgfHwgZGF0YS5JRDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCQlpZiAoZGF0YS5JZCAmJiBkYXRhLklkID09IGRhdGEuSWQpIHsKCQkJCQkJX2lkID0gZGF0YS5JZDsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5FbnRpdHlDbGFzcykgewoJCQkJCQlfaWQgPSBkYXRhLkVudGl0eUNsYXNzLklkIHx8IGRhdGEuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICIxNzA1NGNmMi03MGNlLTRkMWUtODRmZi1lY2M1Y2UyYTAyMmMiIHx8ICJOVUxMIjsKCQkJCQl9CgkJCQl9CgoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbbWV0aG9kXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVttZXRob2RdW19pZF0gfHwge307CgoJCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKHt9LCB7CgkJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJCX0pOwoKCQkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnU3RhdGUnKS5zZW5kZXIoc2FsZXNub3cuX25vZGUpLmNhcnJpZXIoc2FsZXNub3cuX25vZGUpLnBheWxvYWQoZGF0YSk7CgkJCWlmIChldmVudCkgewoJCQkJaWYgKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOwoJCQkJaWYgKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOwoJCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJaWYgKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOwoJCQl9CgkJCXJldCA9IGF3YWl0IGV2LnRyaWdnZXIoKTsKCgkJCWlmICh0eXBlb2YocmV0KSA9PT0gInN0cmluZyIpIHsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCX0KCQkJcmV0dXJuIHJldDsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5TdGF0ZShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuU3RhdGUobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuU3RhdGUoKS5faW52b2tlTm9kZSh0biwgbWV0aG9kLCBfcGFyYW1zKTsKCQl9CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYFN0YXRlLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgU3RhdGUuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGUuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuU3RhdGUuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIlN0YXRlIik7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCS8vIHRoaXMuc3RhdGVfU3RhdGVzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuU3RhdGUodGhpcy5JZCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkuc3RhdGVfSW5jaWRlbnRzKHRoaXMuc3RhdGVfSW5jaWRlbnRzKCksIHRoaXMuX3N0YXRlX0luY2lkZW50c19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCW9ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdTdGF0ZSc7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIlN0YXRlIjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCQkJCXJldCA9IHJldC50b0xvd2VyQ2FzZSgpOwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCQl0cnkgewoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgPyAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gb3B0aW9ucy50b29sIHx8IHQgPT0gb3B0aW9ucy50b29sKSA6IHRoaXMuVG9vbDsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sIHx8IHt9OwoKCQkJbGV0IG5JRCA9IHNhbGVzbm93Ll9ub2RlID8gc2FsZXNub3cuX25vZGUuY29kZSgpIDogImRlZmF1bHQiOwoKCQkJbGV0IHJldCA9IG51bGxWYWx1ZTsKCQkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0ID0gbnVsbDsKCgkJCS8vIHRvb2xfQ29uZmlnczogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBkb25lCgkJCWxldCB0Y29uZiA9IChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiBjLm5vZGUgJiYgYy5ub2RlLmNvZGUgPT0gbklEKS5jb25jYXQoKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmICFjLm5vZGUpKTsKCQkJaWYgKHRjb25mLmxlbmd0aCkgewoJCQkJcmV0ID0gdGNvbmZbMF0udmFsdWU7CgkJCQl0cnkgewoJCQkJCVsxLCAyLCAzXS5mb3JFYWNoKGEgPT4gcmV0ID0gSlNPTi5wYXJzZShyZXQpKTsKCQkJCX0gY2F0Y2ggKGpleCkge30KCQkJfQoKCQkJLy8gbW9kZWwgQ29uZmlnOiBDb25maWcgaXMgY2xhc3MgbGV2ZWwsIG5vZGUgbm90IHBvc3NpYmxlIC0gcGVuZGluZwoJCQlsZXQgbWNvbmYgPSB0aGlzLkNvbmZpZyA/IHRoaXMuQ29uZmlnW25dIDogdW5kZWZpbmVkOwoJCQlpZiAodHlwZW9mKG1jb25mKSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IG1jb25mOwoKCQkJLy8gY29tbWFuZCBsaW5lOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiBnbG9iYWwubWluaW1pc3QpIHsKCQkJCXJldCA9IGdsb2JhbC5taW5pbWlzdChwcm9jZXNzLmFyZ3Yuc2xpY2UoMikpW25dIHx8IHJldDsKCQkJfQoKCQkJLy8gcmVxdWVzdDogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCXJldCA9IHRoaXMuJF9SRVFVRVNUKG4pIHx8IHJldDsKCgkJCWlmIChvcHRpb25zLm5ld1ZhbHVlKSB7CgkJCQlsZXQgdGMgPSB0Y29uZi5sZW5ndGggPyB0Y29uZlswXSA6IHt9OwoJCQkJdGMubm9kZSA9IHsKCQkJCQljb2RlOiBvcHRpb25zLm5vZGUuY29kZSgpCgkJCQl9OwoJCQkJdGMudmFsdWUgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQkJdGMubmFtZSA9IG47CgkJCQlpZiAoIXRjb25mLmxlbmd0aCkgewoJCQkJCW9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MucHVzaCh0Yyk7CgkJCQl9CgkJCQlyZXQgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQl9CgoJCQkvLyBjb25maWcgcmVwbGFjZW1lbnQKCQkJaWYgKHR5cGVvZihyZXQpID09PSAnc3RyaW5nJykocmV0Lm1hdGNoKG5ldyBSZWdFeHAoYHt7KFtefV0rKX19YCwgImciKSkgfHwgW10pLmZvckVhY2gobSA9PiByZXQgPSByZXQucmVwbGFjZShtLCB0aGlzLl9fY29uZmlnKG0ucmVwbGFjZSgne3snLCAnJykucmVwbGFjZSgnfX0nLCAnJyksIG51bGwsIG9wdGlvbnMpKSk7CgoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fY29uZmlnJywgJ0VudGl0eU9iamVjdCcsIDEsIG4sIG51bGxWYWx1ZSwgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncywgZXgpOwoJCX0KCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCgkJCQkJLy8gaWYodGhpc1snXycrZmllbGQrJ19zZXQnXSAmJiAodHlwZW9mKHRoaXNbJ18nK2ZpZWxkXSk9PT0ndW5kZWZpbmVkJyB8fCB0aGlzWydfJytmaWVsZF09PW51bGwpKSByZXR1cm47CgkJCQkJLy8gaWYodHlwZW9mKGVhT2JqKT09PSd1bmRlZmluZWQnKSByZXR1cm47IC8vIHdoeT8KCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCXJldHVybiBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjE3MDU0Y2YyLTcwY2UtNGQxZS04NGZmLWVjYzVjZTJhMDIyYyIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGUgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlfb3B0aW9ucygic3RhdGVfSW5jaWRlbnRzIiwgb2JqLCB0aGlzLnN0YXRlX0luY2lkZW50cygpKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3N0YXRlX0luY2lkZW50cyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlmYWxzZSAmJiBbXS5jb25jYXQodGhpcy5Ub29sLnR5cGUudHlwZV9NYXBwaW5ncyB8fCBbXSkuY29uY2F0KHRoaXMuVG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5maWx0ZXIobSA9PiBtLmNsYXNzTmFtZSA9PSAiU3RhdGUiICYmIChtLnRhcmdldCB8fCBtLm91dFNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSAmJiAoIW0uc291cmNlIHx8IChtLnNvdXJjZSAmJiAvKiFtLm91dFNjcmlwdCAmJiovIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX3NldCddKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5vdXRTY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMsIG9TY29wZSwgbWFwKSA9PiB7JHttLm91dFNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLm91dFNjcmlwdH0pfWApKHRoaXMsIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnNvdXJjZSkgewoJCQkJaWYgKG0uc291cmNlLmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcykgPT4ge3JldHVybiBfdGhpcy4ke20uc291cmNlfTt9YCkodGhpcyk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnNvdXJjZSwgdGhpcyk7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0udGFyZ2V0KSBvYmpbbS50YXJnZXRdID0gcmV0OwoJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQlbbS50YXJnZXQgfHwgbS5zb3VyY2VdOiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10KCQkJfSk7CgkJfSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJLy8gdXNlIHRoaXMuX21hcCgpIHdpdGggcmV2ZXJzZQoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICIxNzA1NGNmMi03MGNlLTRkMWUtODRmZi1lY2M1Y2UyYTAyMmMiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGUgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcyk7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygic3RhdGVfSW5jaWRlbnRzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3N0YXRlX0luY2lkZW50cyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaikpOwoKCQlmYWxzZSAmJiBbXS5jb25jYXQodGhpcy5Ub29sLnR5cGUudHlwZV9NYXBwaW5ncyB8fCBbXSkuY29uY2F0KHRoaXMuVG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5maWx0ZXIobSA9PiBtLmNsYXNzTmFtZSA9PSAiU3RhdGUiICYmIChtLnNvdXJjZSB8fCBtLmluU2NyaXB0KSAmJiBtLmFjdGl2ZSAmJiBtLmVuYWJsZWQgJiYgKChtLnRvb2wgJiYgbS50b29sLm5hbWUgPT0gdGhpcy5Ub29sLm5hbWUpIHx8IChtLnR5cGUgJiYgbS50eXBlLm5hbWUgPT0gdGhpcy5Ub29sLnR5cGUubmFtZSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0uaW5TY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAob2JqLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5pblNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLmluU2NyaXB0fSl9YCkob2JqLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS50YXJnZXQpIHsKCQkJCWlmIChtLnRhcmdldC5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAob2JqKSA9PiB7cmV0dXJuIG9iai4ke20udGFyZ2V0fTt9YCkob2JqKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKG9ialttLnRhcmdldF0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gb2JqW20udGFyZ2V0XSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnRhcmdldCwgb2JqKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gb2JqW20udGFyZ2V0XTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnNvdXJjZSkgewoJCQkJaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQl0aGlzW20uc291cmNlXShyZXQpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzW20uc291cmNlXSA9IHJldDsKCQkJCX0KCQkJfQoJCX0pOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlN0YXRlKSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlN0YXRlID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiU3RhdGUiKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCXN0YXRlX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5zdGF0ZV9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBxdWVyeS5zdGF0ZV9JbmNpZGVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXN0YXRlX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5zdGF0ZV9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJc3RhdGVfSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuc3RhdGVfSW5jaWRlbnRzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ107CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJc3RhdGVfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnc3RhdGVfU3RhdGVzJywgdW5kZWZpbmVkKSA6ICJzdGF0ZV9JbmNpZGVudHMiKSkgPT4gdGhpcy5zdGF0ZV9JbmNpZGVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddID0gdiwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCXN0YXRlX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3N0YXRlX1N0YXRlcycsIHVuZGVmaW5lZCkgOiAic3RhdGVfSW5jaWRlbnRzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX3N0YXRlX0luY2lkZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fc3RhdGVfSW5jaWRlbnRzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuX25hbWU7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IGZhbHNlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuU3RhdGUuc3RvcmUnKTsgLy8gb3IgaW5zaWRlIGV4ZWN1dGU/CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJbGV0IGJVcGRhdGUgPSBmYWxzZTsKCQkJbGV0IGJJbnNlcnQgPSBmYWxzZTsKCgkJCWlmICghdGhpcy5fX3N5bmNfb24oKSkgewoJCQkJbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LlN0YXRlKG51bGwsIHRoaXMuVG9vbCk7CgoJCQkJbGV0IGJGaW5kID0gZmFsc2U7CgkJCQlpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLklkID0gdGhpcy5JZDsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5jb2RlKHRoaXMuY29kZSgpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSB7CgkJCQkJdGhpcy5hY3RpdmUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSB7CgkJCQkJdGhpcy5lbmFibGVkKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgewoJCQkJCXRoaXMuZGF0ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSBuZXcgRGF0ZSgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fX2Fzc2VydFZhbGlkKHRydWUpKSByZXR1cm4gbnVsbDsKCgkJCQkvL2F3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8gaW4gY2FzZSBUb29sIGNoYW5nZXMKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgQWJvdXQgdG8gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9YCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgRmluaXNoZWQgSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9IElkPVske3RoaXMuSWR9XWApOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX3N0YXRlX0luY2lkZW50c19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLnN0YXRlX0luY2lkZW50cygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBpbnNlcnQoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5TdGF0ZS5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5TdGF0ZS51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlN0YXRlLmZpbmRBbGwnKTsKCgkJCS8vIGF2b2lkcyBjeWNsaWMgcXVlcmllcwoJCQlvYmpzID0gKG9ianMgfHwgW10pLm1hcChvID0+IG8uX2Nsb25lKCkpOwoKCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLz8/CgoJCQlsZXQgcmV0ID0gW107IC8vIGEganNvbiBhcnJheQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgKTsKCQkJCXJldCA9IHJldC5jb250ZW50ID8gW0pTT04ucGFyc2UodGhpcy5fYXRvYihyZXQuY29udGVudCkpXSA6IFtdOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiQmVmb3JlIF9mcm9tRG9jdW1lbnQoKSIsIHJldCk7CgoJCQlyZXQgPSByZXQubWFwKHIgPT4gbmV3IHNhbGVzbm93LlN0YXRlKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuR3JvdXAgPSBjbGFzcyBHcm91cCBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFzS2k1ZmJHOWhaRlJ2YjJ4ekxDb3VZWFYwYUVOdlpHVXNSWFpsYm5RdWJHbHpkR1Z1TEVWMlpXNTBMbkJ5YjJObGMzTXNSWFpsYm5RdWRISnBaMmRsY2lKOWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKUFFYVjBhRk5oYm1RaUxDSkhhWFJJZFdJaVhRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLk1hcHBpbmdzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgVzEwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoKCQkvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUKCQl0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307CgkJdGhpcy5Ub29sID0gdG9vbDsKCQl0aGlzLklkID0gaWQ7CgoJCXRoaXMuVmFsdWVFbnRpdGllcyA9IFtdOwoKCQl0aGlzLkRhdGUgPSBudWxsOwoKCQl0aGlzLmNsZWFyX1RISVMoKTsKCQl0aGlzLkVudGl0eVZhbHVlcyA9IFtdOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9wZW5JbmNpZGVudFRocmVhc2hvbGQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29wZW5JbmNpZGVudFRocmVhc2hvbGQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2FjdGl2ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2VuYWJsZWQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb2RlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb2RlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3JkZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29yZGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZGF0ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZGF0ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm5hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX25hbWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3JlbWFyaygpOwoKCQl0aGlzLmNsZWFyX2dyb3VwX0luY2lkZW50cygpOwoKCQl0aGlzLmNsZWFyX2dyb3VwX0dyb3VwX01lbWJlcnMoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJHcm91cCIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJLy8gKHRoaXMuZ3JvdXBfSW5jaWRlbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJLy8gKHRoaXMuZ3JvdXBfR3JvdXBfTWVtYmVycygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcGVuSW5jaWRlbnRUaHJlYXNob2xkICoqLwoJb3BlbkluY2lkZW50VGhyZWFzaG9sZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcGVuSW5jaWRlbnRUaHJlYXNob2xkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZCAhPSB2KSB7CgkJCQl0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGQpOwoJCX0KCX0KCgljbGVhcl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkKCkgewoJCXRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkID0gbnVsbDsKCQl0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcGVuSW5jaWRlbnRUaHJlYXNob2xkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXBfSW5jaWRlbnRzICoqLwoJZ3JvdXBfSW5jaWRlbnRzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9ncm91cF9JbmNpZGVudHM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzViZWUyMzRjLTVlNDMtNDRjYS04ZTBmLTQwMmMyYWRlMTkzNCcgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnSW5jaWRlbnQnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX2dyb3VwX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dyb3VwX0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAiZ3JvdXAgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkluY2lkZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ3JvdXBfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJncm91cCBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkluY2lkZW50Iik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92Lmdyb3VwKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX2dyb3VwX0luY2lkZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX2dyb3VwX0luY2lkZW50c19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fZ3JvdXBfSW5jaWRlbnRzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9ncm91cF9JbmNpZGVudHMoKSB7CgkJdGhpcy5fZ3JvdXBfSW5jaWRlbnRzX3NldCA9IG51bGw7CgkJdGhpcy5fZ3JvdXBfSW5jaWRlbnRzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fZ3JvdXBfSW5jaWRlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXBfSW5jaWRlbnRzICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXBfR3JvdXBfTWVtYmVycyAqKi8KCWdyb3VwX0dyb3VwX01lbWJlcnModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2FjMzdjZjE5LTU4YWQtNGQ4Ny04OTFjLTMzYjk2ZjU0NjI1MycgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnR3JvdXAgTWVtYmVyJykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9ncm91cF9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdncm91cF9Hcm91cF9NZW1iZXJzJywgJ0VudGl0eU9iamVjdCcsIDEsICJncm91cCBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiR3JvdXBfTWVtYmVyIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ3JvdXBfR3JvdXBfTWVtYmVycycsICdFbnRpdHlPYmplY3QnLCAxLCAiZ3JvdXAgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJHcm91cF9NZW1iZXIiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YuZ3JvdXAodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVycy5wdXNoKC4uLnYpOwoJCXRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX2dyb3VwX0dyb3VwX01lbWJlcnMoKSB7CgkJdGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVyc19zZXQgPSBudWxsOwoJCXRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXBfR3JvdXBfTWVtYmVycyAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0LAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJCXRoaXMuX2dyb3VwX0luY2lkZW50c19zZXQsCgoJCQl0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0ID0gdGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9zZXQ7CgkJcmV0Ll9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX2Nvb3AgPSB0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX2Nvb3A7CgkJcmV0Lm9wZW5JbmNpZGVudFRocmVhc2hvbGQgPSB0aGlzLm9wZW5JbmNpZGVudFRocmVhc2hvbGQoKSA/IHRoaXMub3BlbkluY2lkZW50VGhyZWFzaG9sZCgpIDogdGhpcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKCk7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5ncm91cF9JbmNpZGVudHMgPSB0aGlzLmdyb3VwX0luY2lkZW50cygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0Lmdyb3VwX0dyb3VwX01lbWJlcnMgPSB0aGlzLmdyb3VwX0dyb3VwX01lbWJlcnMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJIm9wZW5JbmNpZGVudFRocmVhc2hvbGQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCWdyb3VwX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwX0dyb3VwcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCWdyb3VwX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cF9Hcm91cHMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkgIT0gJ0dyb3VwJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL0dyb3VwLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7CgoJCQl9CgoJCQkvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8KCgkJCWxldCB2ID0gdW5kZWZpbmVkOwoJCQl0cnkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke21ldGhvZH1gKTsKCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQlsZXQgX2lkID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgZGF0YSwgbWV0aG9kLCB7fSk7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIHsKCQkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKGRhdGEpOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSBkYXRhLl9fdGhpcy5jb2RlIHx8IGRhdGEuaWQgfHwgZGF0YS5JRDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCQlpZiAoZGF0YS5JZCAmJiBkYXRhLklkID09IGRhdGEuSWQpIHsKCQkJCQkJX2lkID0gZGF0YS5JZDsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5FbnRpdHlDbGFzcykgewoJCQkJCQlfaWQgPSBkYXRhLkVudGl0eUNsYXNzLklkIHx8IGRhdGEuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI0YmRmNDgwMS1iMWVmLTQwMzEtYTA5My1jOGM4OWVmYWM3NjYiIHx8ICJOVUxMIjsKCQkJCQl9CgkJCQl9CgoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cCB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbbWV0aG9kXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFttZXRob2RdW19pZF0gfHwge307CgoJCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKHt9LCB7CgkJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJCX0pOwoKCQkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnR3JvdXAnKS5zZW5kZXIoc2FsZXNub3cuX25vZGUpLmNhcnJpZXIoc2FsZXNub3cuX25vZGUpLnBheWxvYWQoZGF0YSk7CgkJCWlmIChldmVudCkgewoJCQkJaWYgKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOwoJCQkJaWYgKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOwoJCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJaWYgKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOwoJCQl9CgkJCXJldCA9IGF3YWl0IGV2LnRyaWdnZXIoKTsKCgkJCWlmICh0eXBlb2YocmV0KSA9PT0gInN0cmluZyIpIHsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCX0KCQkJcmV0dXJuIHJldDsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5Hcm91cChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuR3JvdXAobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuR3JvdXAoKS5faW52b2tlTm9kZSh0biwgbWV0aG9kLCBfcGFyYW1zKTsKCQl9CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYEdyb3VwLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgR3JvdXAuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXAuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuR3JvdXAuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIkdyb3VwIik7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCS8vIHRoaXMuZ3JvdXBfR3JvdXBzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCS8vIHRoaXMuZ3JvdXBfR3JvdXBzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuR3JvdXAodGhpcy5JZCkKCgkJCS5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKHRoaXMub3BlbkluY2lkZW50VGhyZWFzaG9sZCgpLCB0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX2Nvb3ApCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5jb2RlKHRoaXMuY29kZSgpLCB0aGlzLl9jb2RlX2Nvb3ApCgoJCQkub3JkZXIodGhpcy5vcmRlcigpLCB0aGlzLl9vcmRlcl9jb29wKQoKCQkJLmRhdGUodGhpcy5kYXRlKCksIHRoaXMuX2RhdGVfY29vcCkKCgkJCS5uYW1lKHRoaXMubmFtZSgpLCB0aGlzLl9uYW1lX2Nvb3ApCgoJCQkucmVtYXJrKHRoaXMucmVtYXJrKCksIHRoaXMuX3JlbWFya19jb29wKQoKCQkJLmdyb3VwX0luY2lkZW50cyh0aGlzLmdyb3VwX0luY2lkZW50cygpLCB0aGlzLl9ncm91cF9JbmNpZGVudHNfY29vcCkKCgkJCS5ncm91cF9Hcm91cF9NZW1iZXJzKHRoaXMuZ3JvdXBfR3JvdXBfTWVtYmVycygpLCB0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQlvYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ0dyb3VwJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiR3JvdXAiOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoJCQkJcmV0ID0gcmV0LnRvTG93ZXJDYXNlKCk7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMgPSB7fSkgewoJCXRyeSB7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCA/IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSBvcHRpb25zLnRvb2wgfHwgdCA9PSBvcHRpb25zLnRvb2wpIDogdGhpcy5Ub29sOwoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgfHwge307CgoJCQlsZXQgbklEID0gc2FsZXNub3cuX25vZGUgPyBzYWxlc25vdy5fbm9kZS5jb2RlKCkgOiAiZGVmYXVsdCI7CgoJCQlsZXQgcmV0ID0gbnVsbFZhbHVlOwoJCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXQgPSBudWxsOwoKCQkJLy8gdG9vbF9Db25maWdzOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIGRvbmUKCQkJbGV0IHRjb25mID0gKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmIGMubm9kZSAmJiBjLm5vZGUuY29kZSA9PSBuSUQpLmNvbmNhdCgob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgIWMubm9kZSkpOwoJCQlpZiAodGNvbmYubGVuZ3RoKSB7CgkJCQlyZXQgPSB0Y29uZlswXS52YWx1ZTsKCQkJCXRyeSB7CgkJCQkJWzEsIDIsIDNdLmZvckVhY2goYSA9PiByZXQgPSBKU09OLnBhcnNlKHJldCkpOwoJCQkJfSBjYXRjaCAoamV4KSB7fQoJCQl9CgoJCQkvLyBtb2RlbCBDb25maWc6IENvbmZpZyBpcyBjbGFzcyBsZXZlbCwgbm9kZSBub3QgcG9zc2libGUgLSBwZW5kaW5nCgkJCWxldCBtY29uZiA9IHRoaXMuQ29uZmlnID8gdGhpcy5Db25maWdbbl0gOiB1bmRlZmluZWQ7CgkJCWlmICh0eXBlb2YobWNvbmYpICE9PSAidW5kZWZpbmVkIikgcmV0ID0gbWNvbmY7CgoJCQkvLyBjb21tYW5kIGxpbmU6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnICYmIGdsb2JhbC5taW5pbWlzdCkgewoJCQkJcmV0ID0gZ2xvYmFsLm1pbmltaXN0KHByb2Nlc3MuYXJndi5zbGljZSgyKSlbbl0gfHwgcmV0OwoJCQl9CgoJCQkvLyByZXF1ZXN0OiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJcmV0ID0gdGhpcy4kX1JFUVVFU1QobikgfHwgcmV0OwoKCQkJaWYgKG9wdGlvbnMubmV3VmFsdWUpIHsKCQkJCWxldCB0YyA9IHRjb25mLmxlbmd0aCA/IHRjb25mWzBdIDoge307CgkJCQl0Yy5ub2RlID0gewoJCQkJCWNvZGU6IG9wdGlvbnMubm9kZS5jb2RlKCkKCQkJCX07CgkJCQl0Yy52YWx1ZSA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCQl0Yy5uYW1lID0gbjsKCQkJCWlmICghdGNvbmYubGVuZ3RoKSB7CgkJCQkJb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncy5wdXNoKHRjKTsKCQkJCX0KCQkJCXJldCA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCX0KCgkJCS8vIGNvbmZpZyByZXBsYWNlbWVudAoJCQlpZiAodHlwZW9mKHJldCkgPT09ICdzdHJpbmcnKShyZXQubWF0Y2gobmV3IFJlZ0V4cChge3soW159XSspfX1gLCAiZyIpKSB8fCBbXSkuZm9yRWFjaChtID0+IHJldCA9IHJldC5yZXBsYWNlKG0sIHRoaXMuX19jb25maWcobS5yZXBsYWNlKCd7eycsICcnKS5yZXBsYWNlKCd9fScsICcnKSwgbnVsbCwgb3B0aW9ucykpKTsKCgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19jb25maWcnLCAnRW50aXR5T2JqZWN0JywgMSwgbiwgbnVsbFZhbHVlLCBvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLCBleCk7CgkJfQoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJCQkvLyBpZih0aGlzWydfJytmaWVsZCsnX3NldCddICYmICh0eXBlb2YodGhpc1snXycrZmllbGRdKT09PSd1bmRlZmluZWQnIHx8IHRoaXNbJ18nK2ZpZWxkXT09bnVsbCkpIHJldHVybjsKCQkJCQkvLyBpZih0eXBlb2YoZWFPYmopPT09J3VuZGVmaW5lZCcpIHJldHVybjsgLy8gd2h5PwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJvcGVuSW5jaWRlbnRUaHJlYXNob2xkIiwgb2JqLCB0aGlzLm9wZW5JbmNpZGVudFRocmVhc2hvbGQoKSk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiNGJkZjQ4MDEtYjFlZi00MDMxLWEwOTMtYzhjODllZmFjNzY2IiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cCB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCV9vcHRpb25zKCJncm91cF9JbmNpZGVudHMiLCBvYmosIHRoaXMuZ3JvdXBfSW5jaWRlbnRzKCkpOwoKCQlfb3B0aW9ucygiZ3JvdXBfR3JvdXBfTWVtYmVycyIsIG9iaiwgdGhpcy5ncm91cF9Hcm91cF9NZW1iZXJzKCkpOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydvcGVuSW5jaWRlbnRUaHJlYXNob2xkJywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydncm91cF9JbmNpZGVudHMnLCAnZ3JvdXBfR3JvdXBfTWVtYmVycyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlmYWxzZSAmJiBbXS5jb25jYXQodGhpcy5Ub29sLnR5cGUudHlwZV9NYXBwaW5ncyB8fCBbXSkuY29uY2F0KHRoaXMuVG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5maWx0ZXIobSA9PiBtLmNsYXNzTmFtZSA9PSAiR3JvdXAiICYmIChtLnRhcmdldCB8fCBtLm91dFNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSAmJiAoIW0uc291cmNlIHx8IChtLnNvdXJjZSAmJiAvKiFtLm91dFNjcmlwdCAmJiovIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX3NldCddKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5vdXRTY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMsIG9TY29wZSwgbWFwKSA9PiB7JHttLm91dFNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLm91dFNjcmlwdH0pfWApKHRoaXMsIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnNvdXJjZSkgewoJCQkJaWYgKG0uc291cmNlLmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcykgPT4ge3JldHVybiBfdGhpcy4ke20uc291cmNlfTt9YCkodGhpcyk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnNvdXJjZSwgdGhpcyk7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0udGFyZ2V0KSBvYmpbbS50YXJnZXRdID0gcmV0OwoJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQlbbS50YXJnZXQgfHwgbS5zb3VyY2VdOiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10KCQkJfSk7CgkJfSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJLy8gdXNlIHRoaXMuX21hcCgpIHdpdGggcmV2ZXJzZQoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygib3BlbkluY2lkZW50VGhyZWFzaG9sZCIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjRiZGY0ODAxLWIxZWYtNDAzMS1hMDkzLWM4Yzg5ZWZhYzc2NiIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXAgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJncm91cF9JbmNpZGVudHMiLCBvYmopOwoKCQlfb3B0aW9ucygiZ3JvdXBfR3JvdXBfTWVtYmVycyIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ2dyb3VwX0luY2lkZW50cycsICdncm91cF9Hcm91cF9NZW1iZXJzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJHcm91cCIgJiYgKG0uc291cmNlIHx8IG0uaW5TY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5pblNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmosIG9TY29wZSwgbWFwKSA9PiB7JHttLmluU2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20uaW5TY3JpcHR9KX1gKShvYmosIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnRhcmdldCkgewoJCQkJaWYgKG0udGFyZ2V0LmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmopID0+IHtyZXR1cm4gb2JqLiR7bS50YXJnZXR9O31gKShvYmopOwoJCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqW20udGFyZ2V0XSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0udGFyZ2V0LCBvYmopOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0uc291cmNlKSB7CgkJCQlpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXRoaXNbbS5zb3VyY2VdKHJldCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXNbbS5zb3VyY2VdID0gcmV0OwoJCQkJfQoJCQl9CgkJfSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuR3JvdXApIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuR3JvdXAgPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJHcm91cCIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlvcGVuSW5jaWRlbnRUaHJlYXNob2xkOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vcGVuSW5jaWRlbnRUaHJlYXNob2xkID0gdiA9PSBxdWVyeS5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0ICYmICFxdWVyeS5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3BlbkluY2lkZW50VGhyZWFzaG9sZCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX3NldCAmJiBxdWVyeS5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9wZW5JbmNpZGVudFRocmVhc2hvbGQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCWdyb3VwX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5ncm91cF9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBxdWVyeS5ncm91cF9JbmNpZGVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCQlncm91cF9Hcm91cF9NZW1iZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmdyb3VwX0dyb3VwX01lbWJlcnMgPSB2Lm1hcChfdiA9PiBxdWVyeS5ncm91cF9Hcm91cF9NZW1iZXJzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoZXMiKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDAsIG9NYXRjaCk7CgoJCQlyZXR1cm4gT2JqZWN0LmtleXMob01hdGNoKS5ldmVyeShrID0+IG9NYXRjaFtrXSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfbWF0Y2hpbmcocXVlcnkpIHsKCQl0cnkgewoJCQlsZXQgcmV0ID0gW107CgoJCQlsZXQgbWF0Y2hlcyA9IHRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlncm91cF9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouZ3JvdXBfSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCQlncm91cF9Hcm91cF9NZW1iZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmdyb3VwX0dyb3VwX01lbWJlcnMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fYWN0aXZlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcmRlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9kYXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX25hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcmVtYXJrX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlncm91cF9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5ncm91cF9JbmNpZGVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJZ3JvdXBfR3JvdXBfTWVtYmVyczogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLmdyb3VwX0dyb3VwX01lbWJlcnMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlvcGVuSW5jaWRlbnRUaHJlYXNob2xkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsIHVuZGVmaW5lZCkgOiAib3BlbkluY2lkZW50VGhyZWFzaG9sZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKHJlZik7CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJZ3JvdXBfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXBfR3JvdXBzJywgdW5kZWZpbmVkKSA6ICJncm91cF9JbmNpZGVudHMiKSkgPT4gdGhpcy5ncm91cF9JbmNpZGVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCQlncm91cF9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXBfR3JvdXBzJywgdW5kZWZpbmVkKSA6ICJncm91cF9Hcm91cF9NZW1iZXJzIikpID0+IHRoaXMuZ3JvdXBfR3JvdXBfTWVtYmVycyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuR3JvdXBfTWVtYmVyKCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddID0gdiwKCgkJCSJvcGVuSW5jaWRlbnRUaHJlYXNob2xkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpIDogIm9wZW5JbmNpZGVudFRocmVhc2hvbGQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQkJZ3JvdXBfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXBfR3JvdXBzJywgdW5kZWZpbmVkKSA6ICJncm91cF9JbmNpZGVudHMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fZ3JvdXBfSW5jaWRlbnRzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9ncm91cF9JbmNpZGVudHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJCWdyb3VwX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdncm91cF9Hcm91cHMnLCB1bmRlZmluZWQpIDogImdyb3VwX0dyb3VwX01lbWJlcnMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVyc19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVyc19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSBmYWxzZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLm5hbWUgPSB7fTsKCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgZXJyb3IubmFtZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IubmFtZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IubmFtZTsKCQl9CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lkdyb3VwLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5Hcm91cChudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuY29kZSh0aGlzLmNvZGUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9ncm91cF9JbmNpZGVudHNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5ncm91cF9JbmNpZGVudHMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5ncm91cF9Hcm91cF9NZW1iZXJzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lkdyb3VwLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lkdyb3VwLnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuR3JvdXAuZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2ApOwoJCQkJcmV0ID0gcmV0LmNvbnRlbnQgPyBbSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSldIDogW107CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5tYXAociA9PiBuZXcgc2FsZXNub3cuR3JvdXAobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoKCX0KCn07CgpzYWxlc25vdy5Hcm91cF9NZW1iZXIgPSBjbGFzcyBHcm91cF9NZW1iZXIgZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRc0tpNWZiRzloWkZSdmIyeHpMQ291WVhWMGFFTnZaR1VzUlhabGJuUXViR2x6ZEdWdUxFVjJaVzUwTG5CeWIyTmxjM01zUlhabGJuUXVkSEpwWjJkbGNpSjlgKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlBRWFYwYUZOaGJtUWlMQ0pIYVhSSWRXSWlYUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJncm91cCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZ3JvdXAoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJ1c2VyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl91c2VyKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiR3JvdXAgTWVtYmVyIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQkvLyBpZih0aGlzLl9ncm91cF9zZXQgJiYgdGhpcy5fZ3JvdXApIHRoaXMuX2dyb3VwLlRvb2wgPSB0b29sOwoKCQkvLyBpZih0aGlzLl91c2VyX3NldCAmJiB0aGlzLl91c2VyKSB0aGlzLl91c2VyLlRvb2wgPSB0b29sOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXAgKiovCglncm91cCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2dyb3VwX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZ3JvdXAiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc0YmRmNDgwMS1iMWVmLTQwMzEtYTA5My1jOGM4OWVmYWM3NjYnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdHcm91cCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdncm91cCcsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjRiZGY0ODAxLWIxZWYtNDAzMS1hMDkzLWM4Yzg5ZWZhYzc2NiIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJHcm91cCIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9ncm91cCAhPSB2KSB7CgkJCQl0aGlzLl9ncm91cF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dyb3VwJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9ncm91cCA/IHRoaXMuX2dyb3VwLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9ncm91cF9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fZ3JvdXAgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZ3JvdXApOwoJCX0KCX0KCgljbGVhcl9ncm91cCgpIHsKCQl0aGlzLl9ncm91cF9zZXQgPSBudWxsOwoJCXRoaXMuX2dyb3VwID0gbnVsbDsKCQl0aGlzLl9ncm91cF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXAgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB1c2VyICoqLwoJdXNlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3VzZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJ1c2VyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnYjU4YjcwMzYtNjUxOS00NmVhLWFmNjgtNTEyM2ZkNDZiMWVlJyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnVXNlcicpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1c2VyJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiYjU4YjcwMzYtNjUxOS00NmVhLWFmNjgtNTEyM2ZkNDZiMWVlIiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIlVzZXIiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fdXNlciAhPSB2KSB7CgkJCQl0aGlzLl91c2VyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXNlcicsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fdXNlciA/IHRoaXMuX3VzZXIuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX3VzZXJfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX3VzZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fdXNlcik7CgkJfQoJfQoKCWNsZWFyX3VzZXIoKSB7CgkJdGhpcy5fdXNlcl9zZXQgPSBudWxsOwoJCXRoaXMuX3VzZXIgPSBudWxsOwoJCXRoaXMuX3VzZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHVzZXIgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9ncm91cF9zZXQsCgoJCQl0aGlzLl91c2VyX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX2dyb3VwX3NldCA9IHRoaXMuX2dyb3VwX3NldDsKCQlyZXQuX2dyb3VwX2Nvb3AgPSB0aGlzLl9ncm91cF9jb29wOwoJCXJldC5ncm91cCA9IHRoaXMuZ3JvdXAoKSA/IHRoaXMuZ3JvdXAoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5ncm91cCgpOwoKCQlyZXQuX3VzZXJfc2V0ID0gdGhpcy5fdXNlcl9zZXQ7CgkJcmV0Ll91c2VyX2Nvb3AgPSB0aGlzLl91c2VyX2Nvb3A7CgkJcmV0LnVzZXIgPSB0aGlzLnVzZXIoKSA/IHRoaXMudXNlcigpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLnVzZXIoKTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkiZ3JvdXAiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJ1c2VyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJncm91cCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgZ3JvdXAnLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93Lkdyb3VwKCkuZ3JvdXBfR3JvdXBfTWVtYmVycyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInVzZXIiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIHVzZXInLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93LlVzZXIoKS51c2VyX0dyb3VwX01lbWJlcnModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCAmJiBldmVudC5jbGFzc05hbWUoKSAmJiBldmVudC5jbGFzc05hbWUoKSAhPSAnR3JvdXBfTWVtYmVyJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL0dyb3VwX01lbWJlci8ke21ldGhvZH1gLCBkYXRhLCBjb25maWcpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQl9CgkJfSBlbHNlIHsKCgkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMuX19nZW5lcmF0ZWQ7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMub25saW5lOwoKCQkJfQoKCQkJLy93aHkgZG8gd2UgbmVlZCB0aGlzPz8/CgoJCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQkJdHJ5IHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHttZXRob2R9YCk7CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJbGV0IF9pZCA9IG51bGw7CgkJCQlpZiAodHlwZW9mKGRhdGEpID09PSAndW5kZWZpbmVkJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIGRhdGEsIG1ldGhvZCwge30pOwoJCQkJCXJldHVybiBkYXRhOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoZGF0YSkgPT09ICdzdHJpbmcnKSB7CgkJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShkYXRhKTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gZGF0YS5fX3RoaXMuY29kZSB8fCBkYXRhLmlkIHx8IGRhdGEuSUQ7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQkJaWYgKGRhdGEuSWQgJiYgZGF0YS5JZCA9PSBkYXRhLklkKSB7CgkJCQkJCV9pZCA9IGRhdGEuSWQ7CgkJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCQl9IGVsc2UgaWYgKGRhdGEuRW50aXR5Q2xhc3MpIHsKCQkJCQkJX2lkID0gZGF0YS5FbnRpdHlDbGFzcy5JZCB8fCBkYXRhLkVudGl0eUNsYXNzLk5hbWU7CgkJCQkJfSBlbHNlIHsKCQkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiYWMzN2NmMTktNThhZC00ZDg3LTg5MWMtMzNiOTZmNTQ2MjUzIiB8fCAiTlVMTCI7CgkJCQkJfQoJCQkJfQoKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXIgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlciB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyW21ldGhvZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlclttZXRob2RdIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbbWV0aG9kXVtfaWRdIHx8IHt9OwoKCQkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaCh7fSwgewoJCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCQl9KTsKCgkJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbbWV0aG9kXVtfaWRdW19oYXNoXTsKCQkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogNSkpIHsKCQkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIG1ldGhvZCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCQl2LnJldXNlZCsrOwoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0KCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSk7CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlclttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnR3JvdXBfTWVtYmVyJykuc2VuZGVyKHNhbGVzbm93Ll9ub2RlKS5jYXJyaWVyKHNhbGVzbm93Ll9ub2RlKS5wYXlsb2FkKGRhdGEpOwoJCQlpZiAoZXZlbnQpIHsKCQkJCWlmIChldmVudC5fcmVzcG9uc2VUb19zZXQpIGV2LnJlc3BvbnNlVG8oZXZlbnQucmVzcG9uc2VUbygpKTsKCQkJCWlmIChldmVudC5fc2VuZGVyX3NldCkgZXYuc2VuZGVyKGV2ZW50LnNlbmRlcigpKTsKCQkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCkgZXYuY2xhc3NOYW1lKGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCWlmIChldmVudC5fY2Fycmllcl9zZXQgfHwgZXZlbnQuX3NlbmRlcl9zZXQpIGV2LmNhcnJpZXIoZXZlbnQuY2FycmllcigpIHx8IGV2ZW50LnNlbmRlcigpKTsKCQkJfQoJCQlyZXQgPSBhd2FpdCBldi50cmlnZ2VyKCk7CgoJCQlpZiAodHlwZW9mKHJldCkgPT09ICJzdHJpbmciKSB7CgkJCQl0cnkgewoJCQkJCXJldCA9IEpTT04ucGFyc2UocmV0KTsKCQkJCX0gY2F0Y2ggKGV4KSB7fQoJCQl9CgkJCXJldHVybiByZXQ7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5zZXJ0IjoKCQkJY2FzZSAidXBkYXRlIjoKCQkJY2FzZSAic3RvcmUiOgoJCQljYXNlICJkZWxldGUiOgoJCQljYXNlICJmaW5kIjogewoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuR3JvdXBfTWVtYmVyKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuR3JvdXBfTWVtYmVyKCkuX2ludm9rZU5vZGUodG4sIG1ldGhvZCwgX3BhcmFtcyk7CgkJfQoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBHcm91cF9NZW1iZXIuX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBHcm91cF9NZW1iZXIuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyLl90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93Lkdyb3VwX01lbWJlci4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiR3JvdXAgTWVtYmVyIik7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCWlmICh0aGlzLl9ncm91cF9zZXQgJiYgdGhpcy5ncm91cCgpKSB0aGlzLmdyb3VwKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX3VzZXJfc2V0ICYmIHRoaXMudXNlcigpKSB0aGlzLnVzZXIoKS5fX3N5bmNfb24oZCk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93Lkdyb3VwX01lbWJlcih0aGlzLklkKQoKCQkJLmdyb3VwKHRoaXMuZ3JvdXAoKSwgdGhpcy5fZ3JvdXBfY29vcCkKCgkJCS51c2VyKHRoaXMudXNlcigpLCB0aGlzLl91c2VyX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQlvYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ0dyb3VwX01lbWJlcic7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIkdyb3VwX01lbWJlciI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgkJCQlyZXQgPSByZXQudG9Mb3dlckNhc2UoKTsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucyA9IHt9KSB7CgkJdHJ5IHsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sID8gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IG9wdGlvbnMudG9vbCB8fCB0ID09IG9wdGlvbnMudG9vbCkgOiB0aGlzLlRvb2w7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCB8fCB7fTsKCgkJCWxldCBuSUQgPSBzYWxlc25vdy5fbm9kZSA/IHNhbGVzbm93Ll9ub2RlLmNvZGUoKSA6ICJkZWZhdWx0IjsKCgkJCWxldCByZXQgPSBudWxsVmFsdWU7CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldCA9IG51bGw7CgoJCQkvLyB0b29sX0NvbmZpZ3M6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gZG9uZQoJCQlsZXQgdGNvbmYgPSAob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgYy5ub2RlICYmIGMubm9kZS5jb2RlID09IG5JRCkuY29uY2F0KChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiAhYy5ub2RlKSk7CgkJCWlmICh0Y29uZi5sZW5ndGgpIHsKCQkJCXJldCA9IHRjb25mWzBdLnZhbHVlOwoJCQkJdHJ5IHsKCQkJCQlbMSwgMiwgM10uZm9yRWFjaChhID0+IHJldCA9IEpTT04ucGFyc2UocmV0KSk7CgkJCQl9IGNhdGNoIChqZXgpIHt9CgkJCX0KCgkJCS8vIG1vZGVsIENvbmZpZzogQ29uZmlnIGlzIGNsYXNzIGxldmVsLCBub2RlIG5vdCBwb3NzaWJsZSAtIHBlbmRpbmcKCQkJbGV0IG1jb25mID0gdGhpcy5Db25maWcgPyB0aGlzLkNvbmZpZ1tuXSA6IHVuZGVmaW5lZDsKCQkJaWYgKHR5cGVvZihtY29uZikgIT09ICJ1bmRlZmluZWQiKSByZXQgPSBtY29uZjsKCgkJCS8vIGNvbW1hbmQgbGluZTogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgZ2xvYmFsLm1pbmltaXN0KSB7CgkJCQlyZXQgPSBnbG9iYWwubWluaW1pc3QocHJvY2Vzcy5hcmd2LnNsaWNlKDIpKVtuXSB8fCByZXQ7CgkJCX0KCgkJCS8vIHJlcXVlc3Q6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlyZXQgPSB0aGlzLiRfUkVRVUVTVChuKSB8fCByZXQ7CgoJCQlpZiAob3B0aW9ucy5uZXdWYWx1ZSkgewoJCQkJbGV0IHRjID0gdGNvbmYubGVuZ3RoID8gdGNvbmZbMF0gOiB7fTsKCQkJCXRjLm5vZGUgPSB7CgkJCQkJY29kZTogb3B0aW9ucy5ub2RlLmNvZGUoKQoJCQkJfTsKCQkJCXRjLnZhbHVlID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJCXRjLm5hbWUgPSBuOwoJCQkJaWYgKCF0Y29uZi5sZW5ndGgpIHsKCQkJCQlvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLnB1c2godGMpOwoJCQkJfQoJCQkJcmV0ID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJfQoKCQkJLy8gY29uZmlnIHJlcGxhY2VtZW50CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3N0cmluZycpKHJldC5tYXRjaChuZXcgUmVnRXhwKGB7eyhbXn1dKyl9fWAsICJnIikpIHx8IFtdKS5mb3JFYWNoKG0gPT4gcmV0ID0gcmV0LnJlcGxhY2UobSwgdGhpcy5fX2NvbmZpZyhtLnJlcGxhY2UoJ3t7JywgJycpLnJlcGxhY2UoJ319JywgJycpLCBudWxsLCBvcHRpb25zKSkpOwoKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2NvbmZpZycsICdFbnRpdHlPYmplY3QnLCAxLCBuLCBudWxsVmFsdWUsIG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MsIGV4KTsKCQl9Cgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgoJCQkJCS8vIGlmKHRoaXNbJ18nK2ZpZWxkKydfc2V0J10gJiYgKHR5cGVvZih0aGlzWydfJytmaWVsZF0pPT09J3VuZGVmaW5lZCcgfHwgdGhpc1snXycrZmllbGRdPT1udWxsKSkgcmV0dXJuOwoJCQkJCS8vIGlmKHR5cGVvZihlYU9iaik9PT0ndW5kZWZpbmVkJykgcmV0dXJuOyAvLyB3aHk/CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlyZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgImFjMzdjZjE5LTU4YWQtNGQ4Ny04OTFjLTMzYjk2ZjU0NjI1MyIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXIgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlciB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCWlmICghdGhpcy5ncm91cCgpIHx8ICh0aGlzLmdyb3VwKCkKCgkJCQkmJgoJCQkJIXRoaXMuZ3JvdXAoKS5ncm91cF9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuZ3JvdXAoKS5ncm91cF9Hcm91cF9NZW1iZXJzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJncm91cCIsIG9iaiwgdGhpcy5ncm91cCgpKTsKCQl9CgoJCWlmICghdGhpcy51c2VyKCkgfHwgKHRoaXMudXNlcigpCgoJCQkJJiYKCQkJCSF0aGlzLnVzZXIoKS5tYW5hZ2VyX0RlcGFydG1lbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnVzZXIoKS5jYWxsZXJfSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnVzZXIoKS5jb250YWN0X0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy51c2VyKCkudXNlcl9Hcm91cF9NZW1iZXJzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJ1c2VyIiwgb2JqLCB0aGlzLnVzZXIoKSk7CgkJfQoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydncm91cCcsICd1c2VyJ10pLmNvbmNhdChbJyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlmYWxzZSAmJiBbXS5jb25jYXQodGhpcy5Ub29sLnR5cGUudHlwZV9NYXBwaW5ncyB8fCBbXSkuY29uY2F0KHRoaXMuVG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5maWx0ZXIobSA9PiBtLmNsYXNzTmFtZSA9PSAiR3JvdXBfTWVtYmVyIiAmJiAobS50YXJnZXQgfHwgbS5vdXRTY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkgJiYgKCFtLnNvdXJjZSB8fCAobS5zb3VyY2UgJiYgLyohbS5vdXRTY3JpcHQgJiYqLyB0aGlzWydfJyArIG0uc291cmNlICsgJ19zZXQnXSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0ub3V0U2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5vdXRTY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5vdXRTY3JpcHR9KX1gKSh0aGlzLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS5zb3VyY2UpIHsKCQkJCWlmIChtLnNvdXJjZS5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMpID0+IHtyZXR1cm4gX3RoaXMuJHttLnNvdXJjZX07fWApKHRoaXMpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS5zb3VyY2UsIHRoaXMpOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnRhcmdldCkgb2JqW20udGFyZ2V0XSA9IHJldDsKCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJW20udGFyZ2V0IHx8IG0uc291cmNlXTogdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddCgkJCX0pOwoJCX0pOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCS8vIHVzZSB0aGlzLl9tYXAoKSB3aXRoIHJldmVyc2UKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJhYzM3Y2YxOS01OGFkLTRkODctODkxYy0zM2I5NmY1NDYyNTMiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXIgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJncm91cCIsIG9iaik7CgoJCV9vcHRpb25zKCJ1c2VyIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnZ3JvdXAnLCAndXNlciddKS5jb25jYXQoWycnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIkdyb3VwX01lbWJlciIgJiYgKG0uc291cmNlIHx8IG0uaW5TY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5pblNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmosIG9TY29wZSwgbWFwKSA9PiB7JHttLmluU2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20uaW5TY3JpcHR9KX1gKShvYmosIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnRhcmdldCkgewoJCQkJaWYgKG0udGFyZ2V0LmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmopID0+IHtyZXR1cm4gb2JqLiR7bS50YXJnZXR9O31gKShvYmopOwoJCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqW20udGFyZ2V0XSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0udGFyZ2V0LCBvYmopOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0uc291cmNlKSB7CgkJCQlpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXRoaXNbbS5zb3VyY2VdKHJldCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXNbbS5zb3VyY2VdID0gcmV0OwoJCQkJfQoJCQl9CgkJfSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuR3JvdXBfTWVtYmVyKSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLkdyb3VwX01lbWJlciA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIkdyb3VwIE1lbWJlciIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlncm91cDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZ3JvdXAgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5Lmdyb3VwKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2dyb3VwX3NldCAmJiAhcXVlcnkuX2dyb3VwX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5ncm91cCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9ncm91cF9zZXQgJiYgcXVlcnkuX2dyb3VwX3NldCkgfHwKCgkJCQkJCSh0aGlzLmdyb3VwKCkgJiYgIXRoaXMuZ3JvdXAoKS5fbWF0Y2hlcyhxdWVyeS5ncm91cCgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZ3JvdXAgPSBmYWxzZTsKCQkJCX0sCgoJCQkJdXNlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoudXNlciA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkudXNlcigpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl91c2VyX3NldCAmJiAhcXVlcnkuX3VzZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnVzZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fdXNlcl9zZXQgJiYgcXVlcnkuX3VzZXJfc2V0KSB8fAoKCQkJCQkJKHRoaXMudXNlcigpICYmICF0aGlzLnVzZXIoKS5fbWF0Y2hlcyhxdWVyeS51c2VyKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai51c2VyID0gZmFsc2U7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJZ3JvdXA6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBncm91cCIpOwoJCQkJCW9iai5ncm91cCA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCXVzZXI6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciB1c2VyIik7CgkJCQkJb2JqLnVzZXIgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl9ncm91cF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl91c2VyX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlncm91cDogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLmdyb3VwKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQl1c2VyOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMudXNlcihyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlncm91cDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSA6ICJncm91cCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9ncm91cF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5ncm91cCgpIHx8IG5ldyBzYWxlc25vdy5Hcm91cCgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuZ3JvdXAob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSBncm91cCIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJdXNlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpIDogInVzZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fdXNlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy51c2VyKCkgfHwgbmV3IHNhbGVzbm93LlVzZXIoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLnVzZXIob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSB1c2VyIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddID0gdiwKCgkJCSJncm91cCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkgOiAiZ3JvdXAiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl9ncm91cF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZ3JvdXBfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJ1c2VyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpIDogInVzZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl91c2VyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl91c2VyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCglieUdyb3VwKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9ncm91cCJdICYmIChhWyJfZ3JvdXAiXS5FcXVhbHMgPyBhWyJfZ3JvdXAiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX2dyb3VwIl0sIHIpKSkgewoJCQkJCXIuX2dyb3VwX0dyb3VwX01lbWJlcnMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglieVVzZXIoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX3VzZXIiXSAmJiAoYVsiX3VzZXIiXS5FcXVhbHMgPyBhWyJfdXNlciJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfdXNlciJdLCByKSkpIHsKCQkJCQlyLl91c2VyX0dyb3VwX01lbWJlcnMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuSWQ7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuR3JvdXBfTWVtYmVyLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLmdyb3VwKHRoaXMuZ3JvdXAoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy51c2VyKHRoaXMudXNlcigpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX2dyb3VwX3NldCAmJiB0aGlzLmdyb3VwKCkgJiYgIShhd2FpdCB0aGlzLmdyb3VwKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfZ3JvdXAoKTsKCgkJCQkJaWYgKHRoaXMuX3VzZXJfc2V0ICYmIHRoaXMudXNlcigpICYmICEoYXdhaXQgdGhpcy51c2VyKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfdXNlcigpOwoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lkdyb3VwX01lbWJlci5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Hcm91cF9NZW1iZXIudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Hcm91cF9NZW1iZXIuZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2ApOwoJCQkJcmV0ID0gcmV0LmNvbnRlbnQgPyBbSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSldIDogW107CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5tYXAociA9PiBuZXcgc2FsZXNub3cuR3JvdXBfTWVtYmVyKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuTG9jYXRpb24gPSBjbGFzcyBMb2NhdGlvbiBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFzS2k1ZmJHOWhaRlJ2YjJ4ekxDb3VZWFYwYUVOdlpHVXNSWFpsYm5RdWJHbHpkR1Z1TEVWMlpXNTBMbkJ5YjJObGMzTXNSWFpsYm5RdWRISnBaMmRsY2lKOWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKUFFYVjBhRk5oYm1RaUxDSkhhWFJJZFdJaVhRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLk1hcHBpbmdzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgVzEwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoKCQkvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUKCQl0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307CgkJdGhpcy5Ub29sID0gdG9vbDsKCQl0aGlzLklkID0gaWQ7CgoJCXRoaXMuVmFsdWVFbnRpdGllcyA9IFtdOwoKCQl0aGlzLkRhdGUgPSBudWxsOwoKCQl0aGlzLmNsZWFyX1RISVMoKTsKCQl0aGlzLkVudGl0eVZhbHVlcyA9IFtdOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfbG9jYXRpb25fSW5jaWRlbnRzKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiTG9jYXRpb24iLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCS8vICh0aGlzLmxvY2F0aW9uX0luY2lkZW50cygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoJY29kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb2RlICE9IHYpIHsKCQkJCXRoaXMuX2NvZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29kZSk7CgkJfQoJfQoKCWNsZWFyX2NvZGUoKSB7CgkJdGhpcy5fY29kZV9zZXQgPSBudWxsOwoJCXRoaXMuX2NvZGUgPSBudWxsOwoJCXRoaXMuX2NvZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCglkYXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImRhdGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJyA/IF92IDogKG5ldyBEYXRlKF92KSk7CgkJCQlpZiAoaXNOYU4oX3YuZ2V0VGltZSgpKSkgX3YgPSBudWxsOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuRGF0ZVZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RhdGUgIT0gdikgewoJCQkJdGhpcy5fZGF0ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkRhdGVWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGF0ZSk7CgkJfQoJfQoKCWNsZWFyX2RhdGUoKSB7CgkJdGhpcy5fZGF0ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2RhdGUgPSBudWxsOwoJCXRoaXMuX2RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoJbmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9uYW1lICE9IHYpIHsKCQkJCXRoaXMuX25hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX25hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbmFtZSk7CgkJfQoJfQoKCWNsZWFyX25hbWUoKSB7CgkJdGhpcy5fbmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX25hbWUgPSBudWxsOwoJCXRoaXMuX25hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCglyZW1hcmsodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9yZW1hcmtfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZW1hcmsiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3JlbWFyayAhPSB2KSB7CgkJCQl0aGlzLl9yZW1hcmtfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3JlbWFyayA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcmVtYXJrKTsKCQl9Cgl9CgoJY2xlYXJfcmVtYXJrKCkgewoJCXRoaXMuX3JlbWFya19zZXQgPSBudWxsOwoJCXRoaXMuX3JlbWFyayA9IG51bGw7CgkJdGhpcy5fcmVtYXJrX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBsb2NhdGlvbl9JbmNpZGVudHMgKiovCglsb2NhdGlvbl9JbmNpZGVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX2xvY2F0aW9uX0luY2lkZW50czsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnNWJlZTIzNGMtNWU0My00NGNhLThlMGYtNDAyYzJhZGUxOTM0JyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdJbmNpZGVudCcpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fbG9jYXRpb25fc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnbG9jYXRpb25fSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJsb2NhdGlvbiBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiSW5jaWRlbnQiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdsb2NhdGlvbl9JbmNpZGVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgImxvY2F0aW9uIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiSW5jaWRlbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YubG9jYXRpb24odGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzLnB1c2goLi4udik7CgkJdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX2xvY2F0aW9uX0luY2lkZW50cygpIHsKCQl0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBsb2NhdGlvbl9JbmNpZGVudHMgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX2FjdGl2ZV9zZXQgPSB0aGlzLl9hY3RpdmVfc2V0OwoJCXJldC5fYWN0aXZlX2Nvb3AgPSB0aGlzLl9hY3RpdmVfY29vcDsKCQlyZXQuYWN0aXZlID0gdGhpcy5hY3RpdmUoKSA/IHRoaXMuYWN0aXZlKCkgOiB0aGlzLmFjdGl2ZSgpOwoKCQlyZXQuX2VuYWJsZWRfc2V0ID0gdGhpcy5fZW5hYmxlZF9zZXQ7CgkJcmV0Ll9lbmFibGVkX2Nvb3AgPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJcmV0LmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKSA/IHRoaXMuZW5hYmxlZCgpIDogdGhpcy5lbmFibGVkKCk7CgoJCXJldC5fY29kZV9zZXQgPSB0aGlzLl9jb2RlX3NldDsKCQlyZXQuX2NvZGVfY29vcCA9IHRoaXMuX2NvZGVfY29vcDsKCQlyZXQuY29kZSA9IHRoaXMuY29kZSgpID8gdGhpcy5jb2RlKCkgOiB0aGlzLmNvZGUoKTsKCgkJcmV0Ll9vcmRlcl9zZXQgPSB0aGlzLl9vcmRlcl9zZXQ7CgkJcmV0Ll9vcmRlcl9jb29wID0gdGhpcy5fb3JkZXJfY29vcDsKCQlyZXQub3JkZXIgPSB0aGlzLm9yZGVyKCkgPyB0aGlzLm9yZGVyKCkgOiB0aGlzLm9yZGVyKCk7CgoJCXJldC5fZGF0ZV9zZXQgPSB0aGlzLl9kYXRlX3NldDsKCQlyZXQuX2RhdGVfY29vcCA9IHRoaXMuX2RhdGVfY29vcDsKCQlyZXQuZGF0ZSA9IHRoaXMuZGF0ZSgpID8gdGhpcy5kYXRlKCkgOiB0aGlzLmRhdGUoKTsKCgkJcmV0Ll9uYW1lX3NldCA9IHRoaXMuX25hbWVfc2V0OwoJCXJldC5fbmFtZV9jb29wID0gdGhpcy5fbmFtZV9jb29wOwoJCXJldC5uYW1lID0gdGhpcy5uYW1lKCkgPyB0aGlzLm5hbWUoKSA6IHRoaXMubmFtZSgpOwoKCQlyZXQuX3JlbWFya19zZXQgPSB0aGlzLl9yZW1hcmtfc2V0OwoJCXJldC5fcmVtYXJrX2Nvb3AgPSB0aGlzLl9yZW1hcmtfY29vcDsKCQlyZXQucmVtYXJrID0gdGhpcy5yZW1hcmsoKSA/IHRoaXMucmVtYXJrKCkgOiB0aGlzLnJlbWFyaygpOwoKCQlyZXQubG9jYXRpb25fSW5jaWRlbnRzID0gdGhpcy5sb2NhdGlvbl9JbmNpZGVudHMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCWxvY2F0aW9uX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2xvY2F0aW9uX0xvY2F0aW9ucycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCAmJiBldmVudC5jbGFzc05hbWUoKSAmJiBldmVudC5jbGFzc05hbWUoKSAhPSAnTG9jYXRpb24nKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiRGVsZWdhdGluZyBpbnZva2F0aW9uIHRvICIgKyBldmVudC5jbGFzc05hbWUoKSk7CgkJCQlyZXR1cm4gbmV3IHNhbGVzbm93W2V2ZW50LmNsYXNzTmFtZSgpXSgpLl9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpOwoJCQl9CgoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQlkYXRhLl9fdGhpcyA9IGRhdGEuX190aGlzIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkJc3dpdGNoIChtZXRob2QpIHsKCgkJCX0KCQl9CgoJCWlmICghbiB8fCBzYWxlc25vdy5fbm9kZS5fc2FtZU5vZGUobikpIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkNhbGxiYWNrIik7CgkJCXJldCA9IGF3YWl0IHRoaXMuX2ludm9rZShtZXRob2QsIGRhdGEpOwoJCX0gZWxzZSBpZiAobi5hZGRyZXNzKCkgJiYgbi5fc2FtZU5vZGUobikgLyphY3R1YWwgbm9kZSovICkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBuLl9hZGRyZXNzLCBuLl9wb3J0LCBtZXRob2QpOwoJCQl0cnkgewoJCQkJbGV0IGNvbmZpZyA9IHsKCQkJCQloZWFkZXJzOiB7fSwKCQkJCX07CgkJCQlpZiAoc2FsZXNub3cuX190b2tlbikgY29uZmlnLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGAke3NhbGVzbm93Ll9fdG9rZW4udG9rZW5fdHlwZX0gJHtzYWxlc25vdy5fX3Rva2VuLmFjY2Vzc190b2tlbn1gOwoJCQkJcmV0ID0gYXdhaXQgYXhpb3MucG9zdChgaHR0cCR7bi5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHtuLmFkZHJlc3MoKX06JHtuLnBvcnQoKSB8fCAzMDAwfS9tZXRob2QvTG9jYXRpb24vJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQkJZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOwoJCQkJZGVsZXRlIGRhdGEuX190aGlzLm9ubGluZTsKCgkJCX0KCgkJCS8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/PwoKCQkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJCXRyeSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0pIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7bWV0aG9kfWApOwoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCWxldCBfaWQgPSBudWxsOwoJCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBkYXRhLCBtZXRob2QsIHt9KTsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRhdGEpID09PSAnc3RyaW5nJykgewoJCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUoZGF0YSk7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IGRhdGEuX190aGlzLmNvZGUgfHwgZGF0YS5pZCB8fCBkYXRhLklEOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJCWlmIChkYXRhLklkICYmIGRhdGEuSWQgPT0gZGF0YS5JZCkgewoJCQkJCQlfaWQgPSBkYXRhLklkOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQkJfSBlbHNlIGlmIChkYXRhLkVudGl0eUNsYXNzKSB7CgkJCQkJCV9pZCA9IGRhdGEuRW50aXR5Q2xhc3MuSWQgfHwgZGF0YS5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjJmZGM3ODMxLTViNWQtNDM5Yy1iYjhjLWM1ODk4YzBiMjNjYyIgfHwgIk5VTEwiOwoJCQkJCX0KCQkJCX0KCgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb24gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvblttZXRob2RdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvblttZXRob2RdIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvblttZXRob2RdW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW21ldGhvZF1bX2lkXSB8fCB7fTsKCgkJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goe30sIHsKCQkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQkJfSk7CgoJCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bbWV0aG9kXVtfaWRdW19oYXNoXTsKCQkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogNSkpIHsKCQkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIG1ldGhvZCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCQl2LnJldXNlZCsrOwoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0KCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSk7CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW21ldGhvZF1bX2lkXVtfaGFzaF0gPSB7CgkJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoe30pLAoJCQkJCW9iajogZGF0YSwKCQkJCQlyZXVzZWQ6IDAsCgkJCQl9OwoJCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0gPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGRhdGEsIG1ldGhvZCwge30sIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBgVHJpZ2dlcnJpbmcgJHttZXRob2R9IHRvICR7bi5jb2RlKCl9ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSxudWxsLDQpfWApOwoKCQkJbGV0IGV2ID0gbmV3IHNhbGVzbm93LkV2ZW50KCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuY29kZSh0aGlzLl91dWlkKCkpLm5hbWUodGhpcy5fX2NvbmZpZygnZXZlbnQnKSB8fCAnc2FsZXNub3cuRXZlbnQnKS5kYXRlKHRoaXMuc2VydmVyRGF0ZSgpKS5yZWNpcGllbnQobikubWV0aG9kKG1ldGhvZCkuY2xhc3NOYW1lKCdMb2NhdGlvbicpLnNlbmRlcihzYWxlc25vdy5fbm9kZSkuY2FycmllcihzYWxlc25vdy5fbm9kZSkucGF5bG9hZChkYXRhKTsKCQkJaWYgKGV2ZW50KSB7CgkJCQlpZiAoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7CgkJCQlpZiAoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7CgkJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7CgkJCQlpZiAoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7CgkJCX0KCQkJcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOwoKCQkJaWYgKHR5cGVvZihyZXQpID09PSAic3RyaW5nIikgewoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChleCkge30KCQkJfQoJCQlyZXR1cm4gcmV0OwoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LkxvY2F0aW9uKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5Mb2NhdGlvbihudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocCkpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHt9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2UobWV0aG9kLCBib2R5LCBxdWVyeSwgYXV0aE9iaikgewoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgbWV0aG9kLCBxdWVyeSwgYm9keSk7CgoJCWlmICh0eXBlb2YoYm9keSkgPT09ICdzdHJpbmcnIHx8ICh0eXBlb2YoQnVmZmVyKSAhPT0gJ3VuZGVmaW5lZCcgJiYgQnVmZmVyLmlzQnVmZmVyKGJvZHkpKSkgewoJCQl0cnkgewoJCQkJYm9keSA9IEpTT04ucGFyc2UoYm9keS50b1N0cmluZygpKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJvZHkgaXMgbm90IGEgdmFsaWQgSlNPTiIsIGJvZHkpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoKCQlsZXQgX3BhcmFtcyA9IHF1ZXJ5ID8gT2JqZWN0LmFzc2lnbihxdWVyeSwgYm9keSkgOiBib2R5OwoJCWlmICh0eXBlb2YoX3BhcmFtcykgPT09ICdzdHJpbmcnKSBfcGFyYW1zID0gSlNPTi5wYXJzZShfcGFyYW1zKTsKCgkJaWYgKF9wYXJhbXMpIHsKCQkJX3BhcmFtcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcyk7CgkJfSBlbHNlIHsKCQkJX3BhcmFtcyA9IHt9OwoJCX0KCgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgX3BhcmFtcy5fX2ZsYXR0ZWQpIF9wYXJhbXMgPSBGbGF0dGVkLnBhcnNlKF9wYXJhbXMuX19mbGF0dGVkKTsKCgkJaWYgKF9wYXJhbXMuX19ub2RlKSB7CgkJCS8vIHByb2JhYmx5IHNob3VsZCBub3QgYmUgcHJvY2Vzc2VkIGhlcmUsIGJ1dCByYXRoZXIgY29uc3VtZWQgYXMgcGFydCBvZiB0aGUgZXhlY3V0ZSgpIGxvZ2ljLCBwdXNoaW5nIF9fbm9kZSB0byB0aGUgbGlzdCBvZiBteSBub2RlcyB0byBkZWxlZ2F0ZSB0byE/CgkJCWxldCB0biA9IG5ldyBzYWxlc25vdy5Ob2RlKCkuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fbm9kZSkuX2RlUmVmZXJlbmNlKCk7CgkJCWRlbGV0ZSBfcGFyYW1zLl9fbm9kZTsKCQkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Mb2NhdGlvbigpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOwoJCX0KCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgTG9jYXRpb24uX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBMb2NhdGlvbi5faW52b2tlOiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLAoJCQkJCSdvYmonOiBvYmoKCQkJCX0KCQkJfTsKCQl9IGVsc2UgewoJCQlyZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOwoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQl9CgoJCWlmIChyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbikgewoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0ge307CgkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCXJldCA9IHJldC5tYXAociA9PiB7CgkJCQkJaWYgKHIgJiYgci5fdG9Eb2N1bWVudCkgewoJCQkJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbi5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5Mb2NhdGlvbi4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiTG9jYXRpb24iKTsKCgl9CgoJX19zeW5jX29uKGQpIHsKCQl0aGlzLl9fX3N5bmNfb24gPSB0aGlzLl9fX3N5bmNfb24gfHwge307CgoJCWlmIChkKSB7CgkJCXRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV0gPSBkOwoKCQkJLy8gdGhpcy5sb2NhdGlvbl9Mb2NhdGlvbnMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Mb2NhdGlvbih0aGlzLklkKQoKCQkJLmFjdGl2ZSh0aGlzLmFjdGl2ZSgpLCB0aGlzLl9hY3RpdmVfY29vcCkKCgkJCS5lbmFibGVkKHRoaXMuZW5hYmxlZCgpLCB0aGlzLl9lbmFibGVkX2Nvb3ApCgoJCQkuY29kZSh0aGlzLmNvZGUoKSwgdGhpcy5fY29kZV9jb29wKQoKCQkJLm9yZGVyKHRoaXMub3JkZXIoKSwgdGhpcy5fb3JkZXJfY29vcCkKCgkJCS5kYXRlKHRoaXMuZGF0ZSgpLCB0aGlzLl9kYXRlX2Nvb3ApCgoJCQkubmFtZSh0aGlzLm5hbWUoKSwgdGhpcy5fbmFtZV9jb29wKQoKCQkJLnJlbWFyayh0aGlzLnJlbWFyaygpLCB0aGlzLl9yZW1hcmtfY29vcCkKCgkJCS5sb2NhdGlvbl9JbmNpZGVudHModGhpcy5sb2NhdGlvbl9JbmNpZGVudHMoKSwgdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQlvYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ0xvY2F0aW9uJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiTG9jYXRpb24iOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoJCQkJcmV0ID0gcmV0LnRvTG93ZXJDYXNlKCk7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMgPSB7fSkgewoJCXRyeSB7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCA/IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSBvcHRpb25zLnRvb2wgfHwgdCA9PSBvcHRpb25zLnRvb2wpIDogdGhpcy5Ub29sOwoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgfHwge307CgoJCQlsZXQgbklEID0gc2FsZXNub3cuX25vZGUgPyBzYWxlc25vdy5fbm9kZS5jb2RlKCkgOiAiZGVmYXVsdCI7CgoJCQlsZXQgcmV0ID0gbnVsbFZhbHVlOwoJCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXQgPSBudWxsOwoKCQkJLy8gdG9vbF9Db25maWdzOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIGRvbmUKCQkJbGV0IHRjb25mID0gKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmIGMubm9kZSAmJiBjLm5vZGUuY29kZSA9PSBuSUQpLmNvbmNhdCgob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgIWMubm9kZSkpOwoJCQlpZiAodGNvbmYubGVuZ3RoKSB7CgkJCQlyZXQgPSB0Y29uZlswXS52YWx1ZTsKCQkJCXRyeSB7CgkJCQkJWzEsIDIsIDNdLmZvckVhY2goYSA9PiByZXQgPSBKU09OLnBhcnNlKHJldCkpOwoJCQkJfSBjYXRjaCAoamV4KSB7fQoJCQl9CgoJCQkvLyBtb2RlbCBDb25maWc6IENvbmZpZyBpcyBjbGFzcyBsZXZlbCwgbm9kZSBub3QgcG9zc2libGUgLSBwZW5kaW5nCgkJCWxldCBtY29uZiA9IHRoaXMuQ29uZmlnID8gdGhpcy5Db25maWdbbl0gOiB1bmRlZmluZWQ7CgkJCWlmICh0eXBlb2YobWNvbmYpICE9PSAidW5kZWZpbmVkIikgcmV0ID0gbWNvbmY7CgoJCQkvLyBjb21tYW5kIGxpbmU6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnICYmIGdsb2JhbC5taW5pbWlzdCkgewoJCQkJcmV0ID0gZ2xvYmFsLm1pbmltaXN0KHByb2Nlc3MuYXJndi5zbGljZSgyKSlbbl0gfHwgcmV0OwoJCQl9CgoJCQkvLyByZXF1ZXN0OiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJcmV0ID0gdGhpcy4kX1JFUVVFU1QobikgfHwgcmV0OwoKCQkJaWYgKG9wdGlvbnMubmV3VmFsdWUpIHsKCQkJCWxldCB0YyA9IHRjb25mLmxlbmd0aCA/IHRjb25mWzBdIDoge307CgkJCQl0Yy5ub2RlID0gewoJCQkJCWNvZGU6IG9wdGlvbnMubm9kZS5jb2RlKCkKCQkJCX07CgkJCQl0Yy52YWx1ZSA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCQl0Yy5uYW1lID0gbjsKCQkJCWlmICghdGNvbmYubGVuZ3RoKSB7CgkJCQkJb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncy5wdXNoKHRjKTsKCQkJCX0KCQkJCXJldCA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCX0KCgkJCS8vIGNvbmZpZyByZXBsYWNlbWVudAoJCQlpZiAodHlwZW9mKHJldCkgPT09ICdzdHJpbmcnKShyZXQubWF0Y2gobmV3IFJlZ0V4cChge3soW159XSspfX1gLCAiZyIpKSB8fCBbXSkuZm9yRWFjaChtID0+IHJldCA9IHJldC5yZXBsYWNlKG0sIHRoaXMuX19jb25maWcobS5yZXBsYWNlKCd7eycsICcnKS5yZXBsYWNlKCd9fScsICcnKSwgbnVsbCwgb3B0aW9ucykpKTsKCgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19jb25maWcnLCAnRW50aXR5T2JqZWN0JywgMSwgbiwgbnVsbFZhbHVlLCBvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLCBleCk7CgkJfQoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJCQkvLyBpZih0aGlzWydfJytmaWVsZCsnX3NldCddICYmICh0eXBlb2YodGhpc1snXycrZmllbGRdKT09PSd1bmRlZmluZWQnIHx8IHRoaXNbJ18nK2ZpZWxkXT09bnVsbCkpIHJldHVybjsKCQkJCQkvLyBpZih0eXBlb2YoZWFPYmopPT09J3VuZGVmaW5lZCcpIHJldHVybjsgLy8gd2h5PwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiMmZkYzc4MzEtNWI1ZC00MzljLWJiOGMtYzU4OThjMGIyM2NjIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbiB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbltmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbltmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCV9vcHRpb25zKCJsb2NhdGlvbl9JbmNpZGVudHMiLCBvYmosIHRoaXMubG9jYXRpb25fSW5jaWRlbnRzKCkpOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnbG9jYXRpb25fSW5jaWRlbnRzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJMb2NhdGlvbiIgJiYgKG0udGFyZ2V0IHx8IG0ub3V0U2NyaXB0KSAmJiBtLmFjdGl2ZSAmJiBtLmVuYWJsZWQgJiYgKChtLnRvb2wgJiYgbS50b29sLm5hbWUgPT0gdGhpcy5Ub29sLm5hbWUpIHx8IChtLnR5cGUgJiYgbS50eXBlLm5hbWUgPT0gdGhpcy5Ub29sLnR5cGUubmFtZSkpICYmICghbS5zb3VyY2UgfHwgKG0uc291cmNlICYmIC8qIW0ub3V0U2NyaXB0ICYmKi8gdGhpc1snXycgKyBtLnNvdXJjZSArICdfc2V0J10pKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLm91dFNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcywgb1Njb3BlLCBtYXApID0+IHske20ub3V0U2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20ub3V0U2NyaXB0fSl9YCkodGhpcywgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0uc291cmNlKSB7CgkJCQlpZiAobS5zb3VyY2UuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzKSA9PiB7cmV0dXJuIF90aGlzLiR7bS5zb3VyY2V9O31gKSh0aGlzKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0uc291cmNlLCB0aGlzKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS50YXJnZXQpIG9ialttLnRhcmdldF0gPSByZXQ7CgkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCVttLnRhcmdldCB8fCBtLnNvdXJjZV06IHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXQoJCQl9KTsKCQl9KTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQkvLyB1c2UgdGhpcy5fbWFwKCkgd2l0aCByZXZlcnNlCgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjJmZGM3ODMxLTViNWQtNDM5Yy1iYjhjLWM1ODk4YzBiMjNjYyIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb24gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbltmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbltmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJsb2NhdGlvbl9JbmNpZGVudHMiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnbG9jYXRpb25fSW5jaWRlbnRzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJMb2NhdGlvbiIgJiYgKG0uc291cmNlIHx8IG0uaW5TY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5pblNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmosIG9TY29wZSwgbWFwKSA9PiB7JHttLmluU2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20uaW5TY3JpcHR9KX1gKShvYmosIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnRhcmdldCkgewoJCQkJaWYgKG0udGFyZ2V0LmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmopID0+IHtyZXR1cm4gb2JqLiR7bS50YXJnZXR9O31gKShvYmopOwoJCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqW20udGFyZ2V0XSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0udGFyZ2V0LCBvYmopOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0uc291cmNlKSB7CgkJCQlpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXRoaXNbbS5zb3VyY2VdKHJldCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXNbbS5zb3VyY2VdID0gcmV0OwoJCQkJfQoJCQl9CgkJfSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTG9jYXRpb24pIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTG9jYXRpb24gPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJMb2NhdGlvbiIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbG9jYXRpb25fSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmxvY2F0aW9uX0luY2lkZW50cyA9IHYubWFwKF92ID0+IHF1ZXJ5LmxvY2F0aW9uX0luY2lkZW50cygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJbG9jYXRpb25fSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmxvY2F0aW9uX0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fYWN0aXZlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcmRlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9kYXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX25hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcmVtYXJrX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlsb2NhdGlvbl9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5sb2NhdGlvbl9JbmNpZGVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb2RlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jb2RlKHJlZik7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3JkZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9yZGVyKHJlZik7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLmRhdGUocmVmKTsKCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9uYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5uYW1lKHJlZik7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVtYXJrX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5yZW1hcmsocmVmKTsKCgkJCX0sCgoJCQlsb2NhdGlvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdsb2NhdGlvbl9Mb2NhdGlvbnMnLCB1bmRlZmluZWQpIDogImxvY2F0aW9uX0luY2lkZW50cyIpKSA9PiB0aGlzLmxvY2F0aW9uX0luY2lkZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuSW5jaWRlbnQoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX1RISVM6IChvYmosIHYpID0+IHsKCQkJCWlmIChiVG9vbCkgcmV0dXJuOwoJCQkJb2JqLlRISVMgPSB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQlvYmouT1BFUkFUT1JTLlRISVMgPSB0aGlzLl9USElTX2Nvb3A7CgkJCX0sCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ10gPSB2LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQkJbG9jYXRpb25fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbG9jYXRpb25fTG9jYXRpb25zJywgdW5kZWZpbmVkKSA6ICJsb2NhdGlvbl9JbmNpZGVudHMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gdHJ1ZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLm5hbWUgPSB7fTsKCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgZXJyb3IubmFtZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IubmFtZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IubmFtZTsKCQl9CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkxvY2F0aW9uLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5Mb2NhdGlvbihudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMubmFtZSh0aGlzLm5hbWUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5sb2NhdGlvbl9JbmNpZGVudHMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTG9jYXRpb24uaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTG9jYXRpb24udXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Mb2NhdGlvbi5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCk7CgkJCQlyZXQgPSByZXQuY29udGVudCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5Mb2NhdGlvbihudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93LkNvbmZpZyA9IGNsYXNzIENvbmZpZyBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFzS2k1ZmJHOWhaRlJ2YjJ4ekxDb3VZWFYwYUVOdlpHVXNSWFpsYm5RdWJHbHpkR1Z1TEVWMlpXNTBMbkJ5YjJObGMzTXNSWFpsYm5RdWRISnBaMmRsY2lKOWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKT2IyUmxJanA3SW01dlJHVjBaV04wSWpwMGNuVmxMQ0pwYm1sMExtVnVaSE1pT2pJc0ltbHVhWFF1Ykc5dmNDSTZNQzQxTENKMGIyOXNjeTV6ZEc5eVpTSTZabUZzYzJVc0ltUmxkR1ZqZEZCaGNtVnVkQzVKVUNJNklqRTRNaTR4TmpndU56QXVPRElpTENKa1pYUmxZM1JRWVhKbGJuUXVZMjlrWlNJNkltVTRaR1V3Tm1VelpXUmpORFF6WVdVNVpHWmxNV1JsTldWak5USmhOR0ptSWl3aWMyVmpjbVYwSWpvaWIxTkxkMmRhTW5OTFJrOVVTVXBqWWtGbVZVbFJORU5xT1hGelNEUTRibXdpTENKd2JHRjVaM0p2ZFc1a0lqcDBjblZsTENKblVsQkRJanAwY25WbExDSnpkRzl5WlM1elpXNXphWFJwZG1sMGVTSTZNU3dpWTI5dGNHRnVlU0k2SW5KbGMzVnRaU0o5TENKRmRtVnVkQ0k2ZXlKMGNtbG5aMlZ5TG5ScGJXVnZkWFFpT2pFd01EQXdMQ0p6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMHNJbFJ2YjJ3aU9uc2laMmwwYUhWaUxuUnZiMnh6SWpvaWFIUjBjSE02THk5eVlYY3VaMmwwYUhWaWRYTmxjbU52Ym5SbGJuUXVZMjl0TDJaaFpHbHVMMlpoWkdsdUxtZHBkR2gxWWk1cGJ5OXRZWE4wWlhJdklpd2ljMlZqY21WMElqb2liMU5MZDJkYU1uTkxSazlVU1VwallrRm1WVWxSTkVOcU9YRnpTRFE0Ym13aUxDSndiR0Y1WjNKdmRXNWtJanAwY25WbExDSm5VbEJESWpwMGNuVmxMQ0p6ZEc5eVpTNXpaVzV6YVhScGRtbDBlU0k2TVN3aVkyOXRjR0Z1ZVNJNkluSmxjM1Z0WlNKOUxDSnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlBRWFYwYUZOaGJtUWlMQ0pIYVhSSWRXSWlYUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJ2YWx1ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfdmFsdWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJ0b29sIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl90b29sKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibm9kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbm9kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiQ29uZmlnIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQkvLyBpZih0aGlzLl90b29sX3NldCAmJiB0aGlzLl90b29sKSB0aGlzLl90b29sLlRvb2wgPSB0b29sOwoKCQkvLyBpZih0aGlzLl9ub2RlX3NldCAmJiB0aGlzLl9ub2RlKSB0aGlzLl9ub2RlLlRvb2wgPSB0b29sOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdmFsdWUgKiovCgl2YWx1ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3ZhbHVlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgidmFsdWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3ZhbHVlICE9IHYpIHsKCQkJCXRoaXMuX3ZhbHVlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl92YWx1ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLk9iamVjdFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl92YWx1ZSk7CgkJfQoJfQoKCWNsZWFyX3ZhbHVlKCkgewoJCXRoaXMuX3ZhbHVlX3NldCA9IG51bGw7CgkJdGhpcy5fdmFsdWUgPSBudWxsOwoJCXRoaXMuX3ZhbHVlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB2YWx1ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHRvb2wgKiovCgl0b29sKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fdG9vbF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInRvb2wiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc2OWUwMmI0NS1iYzIwLTQ3N2ItYWVkYi1jZDcyNzg2YjRjZmQnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdUb29sJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3Rvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICI2OWUwMmI0NS1iYzIwLTQ3N2ItYWVkYi1jZDcyNzg2YjRjZmQiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiVG9vbCIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl90b29sICE9IHYpIHsKCQkJCXRoaXMuX3Rvb2xfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0b29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl90b29sID8gdGhpcy5fdG9vbC5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fdG9vbF9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fdG9vbCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl90b29sKTsKCQl9Cgl9CgoJY2xlYXJfdG9vbCgpIHsKCQl0aGlzLl90b29sX3NldCA9IG51bGw7CgkJdGhpcy5fdG9vbCA9IG51bGw7CgkJdGhpcy5fdG9vbF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdG9vbCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5vZGUgKiovCglub2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbm9kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5vZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc4ODBkOWY2NC1hMDFlLTRhOTYtODVkMy03Y2QxMjBjODliYmInICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdOb2RlJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ25vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICI4ODBkOWY2NC1hMDFlLTRhOTYtODVkMy03Y2QxMjBjODliYmIiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiTm9kZSIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9ub2RlICE9IHYpIHsKCQkJCXRoaXMuX25vZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdub2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9ub2RlID8gdGhpcy5fbm9kZS5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fbm9kZV9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fbm9kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9ub2RlKTsKCQl9Cgl9CgoJY2xlYXJfbm9kZSgpIHsKCQl0aGlzLl9ub2RlX3NldCA9IG51bGw7CgkJdGhpcy5fbm9kZSA9IG51bGw7CgkJdGhpcy5fbm9kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igbm9kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX3ZhbHVlX3NldCwKCgkJCXRoaXMuX3Rvb2xfc2V0LAoKCQkJdGhpcy5fbm9kZV9zZXQsCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fdmFsdWVfc2V0ID0gdGhpcy5fdmFsdWVfc2V0OwoJCXJldC5fdmFsdWVfY29vcCA9IHRoaXMuX3ZhbHVlX2Nvb3A7CgkJcmV0LnZhbHVlID0gdGhpcy52YWx1ZSgpID8gdGhpcy52YWx1ZSgpIDogdGhpcy52YWx1ZSgpOwoKCQlyZXQuX3Rvb2xfc2V0ID0gdGhpcy5fdG9vbF9zZXQ7CgkJcmV0Ll90b29sX2Nvb3AgPSB0aGlzLl90b29sX2Nvb3A7CgkJcmV0LnRvb2wgPSB0aGlzLnRvb2woKSA/IHRoaXMudG9vbCgpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLnRvb2woKTsKCgkJcmV0Ll9ub2RlX3NldCA9IHRoaXMuX25vZGVfc2V0OwoJCXJldC5fbm9kZV9jb29wID0gdGhpcy5fbm9kZV9jb29wOwoJCXJldC5ub2RlID0gdGhpcy5ub2RlKCkgPyB0aGlzLm5vZGUoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5ub2RlKCk7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJInZhbHVlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3ZhbHVlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkidG9vbCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkibm9kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQl9LCAiX3RvSGFzaCIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMuTm9Db2RlID8gb0hhc2ggOiB0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7Cgl9CgoJYXN5bmMgX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOwoKCX0KCglfcWxTZWxlY3Rpb25zKHNTZXQpIHsKCQlsZXQgcmV0ID0gW107CgkJaWYgKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7CgoJCXNTZXQuc2VsZWN0aW9ucy5maWx0ZXIocyA9PiBzLnNlbGVjdGlvblNldCkuZm9yRWFjaChzID0+IHsKCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInRvb2wiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIHRvb2wnLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93LlRvb2woKS50b29sX0NvbmZpZ3ModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJub2RlIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBub2RlJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Ob2RlKCkubm9kZV9Db25maWdzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkgIT0gJ0NvbmZpZycpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCXJldHVybiBuZXcgc2FsZXNub3dbZXZlbnQuY2xhc3NOYW1lKCldKCkuX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdyk7CgkJCX0KCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9Db25maWcvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQkJZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOwoJCQkJZGVsZXRlIGRhdGEuX190aGlzLm9ubGluZTsKCgkJCX0KCgkJCS8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/PwoKCQkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJCXRyeSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0pIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7bWV0aG9kfWApOwoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCWxldCBfaWQgPSBudWxsOwoJCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBkYXRhLCBtZXRob2QsIHt9KTsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRhdGEpID09PSAnc3RyaW5nJykgewoJCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUoZGF0YSk7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IGRhdGEuX190aGlzLmNvZGUgfHwgZGF0YS5pZCB8fCBkYXRhLklEOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJCWlmIChkYXRhLklkICYmIGRhdGEuSWQgPT0gZGF0YS5JZCkgewoJCQkJCQlfaWQgPSBkYXRhLklkOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQkJfSBlbHNlIGlmIChkYXRhLkVudGl0eUNsYXNzKSB7CgkJCQkJCV9pZCA9IGRhdGEuRW50aXR5Q2xhc3MuSWQgfHwgZGF0YS5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjg0Y2U0Mzg4LTFiM2QtNDFiNy04ZGFiLTQzYjVhZjFkNGUzMSIgfHwgIk5VTEwiOwoJCQkJCX0KCQkJCX0KCgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWcgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZ1ttZXRob2RdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWdbbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnW21ldGhvZF1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnW21ldGhvZF1bX2lkXSB8fCB7fTsKCgkJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goe30sIHsKCQkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQkJfSk7CgoJCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnW21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWdbbWV0aG9kXVtfaWRdW19oYXNoXSA9IHsKCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeSh7fSksCgkJCQkJb2JqOiBkYXRhLAoJCQkJCXJldXNlZDogMCwKCQkJCX07CgkJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZGF0YSwgbWV0aG9kLCB7fSwgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBUcmlnZ2VycmluZyAke21ldGhvZH0gdG8gJHtuLmNvZGUoKX0gJHtKU09OLnN0cmluZ2lmeShkYXRhLG51bGwsNCl9YCk7CgoJCQlsZXQgZXYgPSBuZXcgc2FsZXNub3cuRXZlbnQoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSh0aGlzLl9fY29uZmlnKCdldmVudCcpIHx8ICdzYWxlc25vdy5FdmVudCcpLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnJlY2lwaWVudChuKS5tZXRob2QobWV0aG9kKS5jbGFzc05hbWUoJ0NvbmZpZycpLnNlbmRlcihzYWxlc25vdy5fbm9kZSkuY2FycmllcihzYWxlc25vdy5fbm9kZSkucGF5bG9hZChkYXRhKTsKCQkJaWYgKGV2ZW50KSB7CgkJCQlpZiAoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7CgkJCQlpZiAoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7CgkJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7CgkJCQlpZiAoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7CgkJCX0KCQkJcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOwoKCQkJaWYgKHR5cGVvZihyZXQpID09PSAic3RyaW5nIikgewoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChleCkge30KCQkJfQoJCQlyZXR1cm4gcmV0OwoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LkNvbmZpZyhudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuQ29uZmlnKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX25vZGUpIHsKCQkJLy8gcHJvYmFibHkgc2hvdWxkIG5vdCBiZSBwcm9jZXNzZWQgaGVyZSwgYnV0IHJhdGhlciBjb25zdW1lZCBhcyBwYXJ0IG9mIHRoZSBleGVjdXRlKCkgbG9naWMsIHB1c2hpbmcgX19ub2RlIHRvIHRoZSBsaXN0IG9mIG15IG5vZGVzIHRvIGRlbGVnYXRlIHRvIT8KCQkJbGV0IHRuID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX19ub2RlKS5fZGVSZWZlcmVuY2UoKTsKCQkJZGVsZXRlIF9wYXJhbXMuX19ub2RlOwoJCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LkNvbmZpZygpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOwoJCX0KCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgQ29uZmlnLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgQ29uZmlnLl9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZy5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5Db25maWcuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIkNvbmZpZyIpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQlpZiAodGhpcy5fdG9vbF9zZXQgJiYgdGhpcy50b29sKCkpIHRoaXMudG9vbCgpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl9ub2RlX3NldCAmJiB0aGlzLm5vZGUoKSkgdGhpcy5ub2RlKCkuX19zeW5jX29uKGQpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Db25maWcodGhpcy5JZCkKCgkJCS52YWx1ZSh0aGlzLnZhbHVlKCksIHRoaXMuX3ZhbHVlX2Nvb3ApCgoJCQkudG9vbCh0aGlzLnRvb2woKSwgdGhpcy5fdG9vbF9jb29wKQoKCQkJLm5vZGUodGhpcy5ub2RlKCksIHRoaXMuX25vZGVfY29vcCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQlvYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ0NvbmZpZyc7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIkNvbmZpZyI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgkJCQlyZXQgPSByZXQudG9Mb3dlckNhc2UoKTsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucyA9IHt9KSB7CgkJdHJ5IHsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sID8gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IG9wdGlvbnMudG9vbCB8fCB0ID09IG9wdGlvbnMudG9vbCkgOiB0aGlzLlRvb2w7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCB8fCB7fTsKCgkJCWxldCBuSUQgPSBzYWxlc25vdy5fbm9kZSA/IHNhbGVzbm93Ll9ub2RlLmNvZGUoKSA6ICJkZWZhdWx0IjsKCgkJCWxldCByZXQgPSBudWxsVmFsdWU7CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldCA9IG51bGw7CgoJCQkvLyB0b29sX0NvbmZpZ3M6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gZG9uZQoJCQlsZXQgdGNvbmYgPSAob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgYy5ub2RlICYmIGMubm9kZS5jb2RlID09IG5JRCkuY29uY2F0KChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiAhYy5ub2RlKSk7CgkJCWlmICh0Y29uZi5sZW5ndGgpIHsKCQkJCXJldCA9IHRjb25mWzBdLnZhbHVlOwoJCQkJdHJ5IHsKCQkJCQlbMSwgMiwgM10uZm9yRWFjaChhID0+IHJldCA9IEpTT04ucGFyc2UocmV0KSk7CgkJCQl9IGNhdGNoIChqZXgpIHt9CgkJCX0KCgkJCS8vIG1vZGVsIENvbmZpZzogQ29uZmlnIGlzIGNsYXNzIGxldmVsLCBub2RlIG5vdCBwb3NzaWJsZSAtIHBlbmRpbmcKCQkJbGV0IG1jb25mID0gdGhpcy5Db25maWcgPyB0aGlzLkNvbmZpZ1tuXSA6IHVuZGVmaW5lZDsKCQkJaWYgKHR5cGVvZihtY29uZikgIT09ICJ1bmRlZmluZWQiKSByZXQgPSBtY29uZjsKCgkJCS8vIGNvbW1hbmQgbGluZTogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgZ2xvYmFsLm1pbmltaXN0KSB7CgkJCQlyZXQgPSBnbG9iYWwubWluaW1pc3QocHJvY2Vzcy5hcmd2LnNsaWNlKDIpKVtuXSB8fCByZXQ7CgkJCX0KCgkJCS8vIHJlcXVlc3Q6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlyZXQgPSB0aGlzLiRfUkVRVUVTVChuKSB8fCByZXQ7CgoJCQlpZiAob3B0aW9ucy5uZXdWYWx1ZSkgewoJCQkJbGV0IHRjID0gdGNvbmYubGVuZ3RoID8gdGNvbmZbMF0gOiB7fTsKCQkJCXRjLm5vZGUgPSB7CgkJCQkJY29kZTogb3B0aW9ucy5ub2RlLmNvZGUoKQoJCQkJfTsKCQkJCXRjLnZhbHVlID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJCXRjLm5hbWUgPSBuOwoJCQkJaWYgKCF0Y29uZi5sZW5ndGgpIHsKCQkJCQlvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLnB1c2godGMpOwoJCQkJfQoJCQkJcmV0ID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJfQoKCQkJLy8gY29uZmlnIHJlcGxhY2VtZW50CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3N0cmluZycpKHJldC5tYXRjaChuZXcgUmVnRXhwKGB7eyhbXn1dKyl9fWAsICJnIikpIHx8IFtdKS5mb3JFYWNoKG0gPT4gcmV0ID0gcmV0LnJlcGxhY2UobSwgdGhpcy5fX2NvbmZpZyhtLnJlcGxhY2UoJ3t7JywgJycpLnJlcGxhY2UoJ319JywgJycpLCBudWxsLCBvcHRpb25zKSkpOwoKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2NvbmZpZycsICdFbnRpdHlPYmplY3QnLCAxLCBuLCBudWxsVmFsdWUsIG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MsIGV4KTsKCQl9Cgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgoJCQkJCS8vIGlmKHRoaXNbJ18nK2ZpZWxkKydfc2V0J10gJiYgKHR5cGVvZih0aGlzWydfJytmaWVsZF0pPT09J3VuZGVmaW5lZCcgfHwgdGhpc1snXycrZmllbGRdPT1udWxsKSkgcmV0dXJuOwoJCQkJCS8vIGlmKHR5cGVvZihlYU9iaik9PT0ndW5kZWZpbmVkJykgcmV0dXJuOyAvLyB3aHk/CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlyZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoInZhbHVlIiwgb2JqLCB0aGlzLnZhbHVlKCkpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjg0Y2U0Mzg4LTFiM2QtNDFiNy04ZGFiLTQzYjVhZjFkNGUzMSIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWcgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZyB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWdbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZ1tmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCWlmICghdGhpcy50b29sKCkgfHwgKHRoaXMudG9vbCgpCgoJCQkJJiYKCQkJCSF0aGlzLnRvb2woKS50b29sX0NvbmZpZ3MoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMudG9vbCgpLnRvb2xfTWFwcGluZ3MoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoInRvb2wiLCBvYmosIHRoaXMudG9vbCgpKTsKCQl9CgoJCWlmICghdGhpcy5ub2RlKCkgfHwgKHRoaXMubm9kZSgpCgoJCQkJJiYKCQkJCSF0aGlzLm5vZGUoKS5ub2RlX0NvbmZpZ3MoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMubm9kZSgpLmNhcnJpZXJfRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLm5vZGUoKS5zZW5kZXJfRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLm5vZGUoKS5yZWNpcGllbnRfRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLm5vZGUoKS5iYWNrdXBfTm9kZXMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMubm9kZSgpLnBhcmVudF9Ob2RlcygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5ub2RlKCkubm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoIm5vZGUiLCBvYmosIHRoaXMubm9kZSgpKTsKCQl9CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ3ZhbHVlJywgJ3Rvb2wnLCAnbm9kZScsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJDb25maWciICYmIChtLnRhcmdldCB8fCBtLm91dFNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSAmJiAoIW0uc291cmNlIHx8IChtLnNvdXJjZSAmJiAvKiFtLm91dFNjcmlwdCAmJiovIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX3NldCddKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5vdXRTY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMsIG9TY29wZSwgbWFwKSA9PiB7JHttLm91dFNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLm91dFNjcmlwdH0pfWApKHRoaXMsIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnNvdXJjZSkgewoJCQkJaWYgKG0uc291cmNlLmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcykgPT4ge3JldHVybiBfdGhpcy4ke20uc291cmNlfTt9YCkodGhpcyk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnNvdXJjZSwgdGhpcyk7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0udGFyZ2V0KSBvYmpbbS50YXJnZXRdID0gcmV0OwoJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQlbbS50YXJnZXQgfHwgbS5zb3VyY2VdOiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10KCQkJfSk7CgkJfSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJLy8gdXNlIHRoaXMuX21hcCgpIHdpdGggcmV2ZXJzZQoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygidmFsdWUiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI4NGNlNDM4OC0xYjNkLTQxYjctOGRhYi00M2I1YWYxZDRlMzEiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWcgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZ1tmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZ1tmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZ1tmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWdbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZ1tmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJ0b29sIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5vZGUiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWyd2YWx1ZScsICd0b29sJywgJ25vZGUnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaikpOwoKCQlmYWxzZSAmJiBbXS5jb25jYXQodGhpcy5Ub29sLnR5cGUudHlwZV9NYXBwaW5ncyB8fCBbXSkuY29uY2F0KHRoaXMuVG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5maWx0ZXIobSA9PiBtLmNsYXNzTmFtZSA9PSAiQ29uZmlnIiAmJiAobS5zb3VyY2UgfHwgbS5pblNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLmluU2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaiwgb1Njb3BlLCBtYXApID0+IHske20uaW5TY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5pblNjcmlwdH0pfWApKG9iaiwgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0udGFyZ2V0KSB7CgkJCQlpZiAobS50YXJnZXQuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaikgPT4ge3JldHVybiBvYmouJHttLnRhcmdldH07fWApKG9iaik7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmpbbS50YXJnZXRdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS50YXJnZXQsIG9iaik7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS5zb3VyY2UpIHsKCQkJCWlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0ocmV0KTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0gPSByZXQ7CgkJCQl9CgkJCX0KCQl9KTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5Db25maWcpIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuQ29uZmlnID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiQ29uZmlnIikgcmV0dXJuIGZhbHNlOwoKCQkJbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJCUZ1bGw6IHRydWUsCgkJCQlOdWxsOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5faWQgPSB0aGlzLklkID09IHF1ZXJ5LklkLAoKCQkJCXZhbHVlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai52YWx1ZSA9IHYgPT0gcXVlcnkudmFsdWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fdmFsdWVfc2V0ICYmICFxdWVyeS5fdmFsdWVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnZhbHVlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3ZhbHVlX3NldCAmJiBxdWVyeS5fdmFsdWVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai52YWx1ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQl0b29sOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai50b29sID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS50b29sKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3Rvb2xfc2V0ICYmICFxdWVyeS5fdG9vbF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudG9vbCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl90b29sX3NldCAmJiBxdWVyeS5fdG9vbF9zZXQpIHx8CgoJCQkJCQkodGhpcy50b29sKCkgJiYgIXRoaXMudG9vbCgpLl9tYXRjaGVzKHF1ZXJ5LnRvb2woKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnRvb2wgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbm9kZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubm9kZSA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkubm9kZSgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9ub2RlX3NldCAmJiAhcXVlcnkuX25vZGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5vZGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbm9kZV9zZXQgJiYgcXVlcnkuX25vZGVfc2V0KSB8fAoKCQkJCQkJKHRoaXMubm9kZSgpICYmICF0aGlzLm5vZGUoKS5fbWF0Y2hlcyhxdWVyeS5ub2RlKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5ub2RlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWFjdGl2ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouYWN0aXZlID0gdiA9PSBxdWVyeS5hY3RpdmUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fYWN0aXZlX3NldCAmJiAhcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2FjdGl2ZV9zZXQgJiYgcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5lbmFibGVkID0gdiA9PSBxdWVyeS5lbmFibGVkKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ICYmICFxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9lbmFibGVkX3NldCAmJiBxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY29kZSA9IHYgPT0gcXVlcnkuY29kZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jb2RlX3NldCAmJiAhcXVlcnkuX2NvZGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY29kZV9zZXQgJiYgcXVlcnkuX2NvZGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vcmRlciA9IHYgPT0gcXVlcnkub3JkZXIoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fb3JkZXJfc2V0ICYmICFxdWVyeS5fb3JkZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX29yZGVyX3NldCAmJiBxdWVyeS5fb3JkZXJfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5kYXRlID0gdiA9PSBxdWVyeS5kYXRlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2RhdGVfc2V0ICYmICFxdWVyeS5fZGF0ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9kYXRlX3NldCAmJiBxdWVyeS5fZGF0ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubmFtZSA9IHYgPT0gcXVlcnkubmFtZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9uYW1lX3NldCAmJiAhcXVlcnkuX25hbWVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbmFtZV9zZXQgJiYgcXVlcnkuX25hbWVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gZmFsc2U7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucmVtYXJrID0gdiA9PSBxdWVyeS5yZW1hcmsoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcmVtYXJrX3NldCAmJiAhcXVlcnkuX3JlbWFya19zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3JlbWFya19zZXQgJiYgcXVlcnkuX3JlbWFya19zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IGZhbHNlOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXRvb2w6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciB0b29sIik7CgkJCQkJb2JqLnRvb2wgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQlub2RlOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3Igbm9kZSIpOwoJCQkJCW9iai5ub2RlID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fdmFsdWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fdG9vbF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9ub2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJdG9vbDogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLnRvb2wocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCW5vZGU6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5ub2RlKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCXZhbHVlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndmFsdWUnLCB1bmRlZmluZWQpIDogInZhbHVlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3ZhbHVlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy52YWx1ZShyZWYpOwoKCQkJfSwKCgkJCXRvb2w6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKSA6ICJ0b29sIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3Rvb2xfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMudG9vbCgpIHx8IG5ldyBzYWxlc25vdy5Ub29sKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy50b29sKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgdG9vbCIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJbm9kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpIDogIm5vZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbm9kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5ub2RlKCkgfHwgbmV3IHNhbGVzbm93Lk5vZGUoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLm5vZGUob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSBub2RlIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb2RlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jb2RlKHJlZik7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3JkZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9yZGVyKHJlZik7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLmRhdGUocmVmKTsKCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9uYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5uYW1lKHJlZik7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVtYXJrX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5yZW1hcmsocmVmKTsKCgkJCX0sCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddID0gdiwKCgkJCSJ2YWx1ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd2YWx1ZScsIHVuZGVmaW5lZCkgOiAidmFsdWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fdmFsdWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3ZhbHVlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkidG9vbCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKSA6ICJ0b29sIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fdG9vbF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fdG9vbF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5vZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbm9kZScsIHVuZGVmaW5lZCkgOiAibm9kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX25vZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25vZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCWJ5VG9vbChhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfdG9vbCJdICYmIChhWyJfdG9vbCJdLkVxdWFscyA/IGFbIl90b29sIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl90b29sIl0sIHIpKSkgewoJCQkJCXIuX3Rvb2xfQ29uZmlncy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5Tm9kZShhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfbm9kZSJdICYmIChhWyJfbm9kZSJdLkVxdWFscyA/IGFbIl9ub2RlIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9ub2RlIl0sIHIpKSkgewoJCQkJCXIuX25vZGVfQ29uZmlncy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gdHJ1ZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLm5hbWUgPSB7fTsKCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgZXJyb3IubmFtZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IubmFtZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IubmFtZTsKCQl9CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkNvbmZpZy5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuQ29uZmlnKG51bGwsIHRoaXMuVG9vbCk7CgoJCQkJbGV0IGJGaW5kID0gZmFsc2U7CgkJCQlpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLklkID0gdGhpcy5JZDsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy50b29sKHRoaXMudG9vbCgpLCAnPScpOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLm5hbWUodGhpcy5uYW1lKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX3Rvb2xfc2V0ICYmIHRoaXMudG9vbCgpICYmICEoYXdhaXQgdGhpcy50b29sKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfdG9vbCgpOwoKCQkJCQlpZiAodGhpcy5fbm9kZV9zZXQgJiYgdGhpcy5ub2RlKCkgJiYgIShhd2FpdCB0aGlzLm5vZGUoKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9ub2RlKCk7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fX2Fzc2VydFZhbGlkKHRydWUpKSByZXR1cm4gbnVsbDsKCgkJCQkvL2F3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8gaW4gY2FzZSBUb29sIGNoYW5nZXMKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgQWJvdXQgdG8gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9YCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgRmluaXNoZWQgSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9IElkPVske3RoaXMuSWR9XWApOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuQ29uZmlnLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkNvbmZpZy51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkNvbmZpZy5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCk7CgkJCQlyZXQgPSByZXQuY29udGVudCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5Db25maWcobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoKCX0KCn07CgpzYWxlc25vdy5Ub29sID0gY2xhc3MgVG9vbCBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFzS2k1ZmJHOWhaRlJ2YjJ4ekxDb3VZWFYwYUVOdlpHVXNSWFpsYm5RdWJHbHpkR1Z1TEVWMlpXNTBMbkJ5YjJObGMzTXNSWFpsYm5RdWRISnBaMmRsY2lKOWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKbmFYUm9kV0l1ZEc5dmJITWlPaUpvZEhSd2N6b3ZMM0poZHk1bmFYUm9kV0oxYzJWeVkyOXVkR1Z1ZEM1amIyMHZabUZrYVc0dlptRmthVzR1WjJsMGFIVmlMbWx2TDIxaGMzUmxjaThpTENKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKUFFYVjBhRk5oYm1RaUxDSkhhWFJJZFdJaVhRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLk1hcHBpbmdzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgVzEwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoKCQkvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUKCQl0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307CgkJdGhpcy5Ub29sID0gdG9vbDsKCQl0aGlzLklkID0gaWQ7CgoJCXRoaXMuVmFsdWVFbnRpdGllcyA9IFtdOwoKCQl0aGlzLkRhdGUgPSBudWxsOwoKCQl0aGlzLmNsZWFyX1RISVMoKTsKCQl0aGlzLkVudGl0eVZhbHVlcyA9IFtdOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInR5cGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3R5cGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2FjdGl2ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2VuYWJsZWQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb2RlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb2RlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3JkZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29yZGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZGF0ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZGF0ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm5hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX25hbWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3JlbWFyaygpOwoKCQl0aGlzLmNsZWFyX3Rvb2xfQ29uZmlncygpOwoKCQl0aGlzLmNsZWFyX3Rvb2xfTWFwcGluZ3MoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJUb29sIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQkvLyBpZih0aGlzLl90eXBlX3NldCAmJiB0aGlzLl90eXBlKSB0aGlzLl90eXBlLlRvb2wgPSB0b29sOwoKCQkvLyAodGhpcy50b29sX0NvbmZpZ3MoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQkvLyAodGhpcy50b29sX01hcHBpbmdzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJVEhJUyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsKCQlpZiAoIXYpIHJldHVybiB0aGlzOwoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCQl0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KSA9PT0gJ29iamVjdCcgJiYgX3YuRW50aXR5Q2xhc3MgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSA9PSB0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGUgPT0gdGhpcy5TY29wZSk7CgkJaWYgKGNvKSB0aGlzLl9USElTX2Nvb3AgPSBjbzsKCQlyZXR1cm4gdGhpczsKCX0KCgljbGVhcl9USElTKCkgewoJCXRoaXMuX1RISVMgPSBbXTsKCQl0aGlzLl9USElTX2Nvb3AgPSAnJzsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHR5cGUgKiovCgl0eXBlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fdHlwZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInR5cGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICdmMTYwNzU5MS0zMDQ5LTQ3OGYtOTg5Zi04ZTY5MjA1YWZjMWInICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdUb29sIFR5cGUnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndHlwZScsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgImYxNjA3NTkxLTMwNDktNDc4Zi05ODlmLThlNjkyMDVhZmMxYiIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJUb29sIFR5cGUiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fdHlwZSAhPSB2KSB7CgkJCQl0aGlzLl90eXBlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndHlwZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fdHlwZSA/IHRoaXMuX3R5cGUuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX3R5cGVfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX3R5cGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fdHlwZSk7CgkJfQoJfQoKCWNsZWFyX3R5cGUoKSB7CgkJdGhpcy5fdHlwZV9zZXQgPSBudWxsOwoJCXRoaXMuX3R5cGUgPSBudWxsOwoJCXRoaXMuX3R5cGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHR5cGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoJY29kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb2RlICE9IHYpIHsKCQkJCXRoaXMuX2NvZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29kZSk7CgkJfQoJfQoKCWNsZWFyX2NvZGUoKSB7CgkJdGhpcy5fY29kZV9zZXQgPSBudWxsOwoJCXRoaXMuX2NvZGUgPSBudWxsOwoJCXRoaXMuX2NvZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCglkYXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImRhdGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJyA/IF92IDogKG5ldyBEYXRlKF92KSk7CgkJCQlpZiAoaXNOYU4oX3YuZ2V0VGltZSgpKSkgX3YgPSBudWxsOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuRGF0ZVZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RhdGUgIT0gdikgewoJCQkJdGhpcy5fZGF0ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkRhdGVWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGF0ZSk7CgkJfQoJfQoKCWNsZWFyX2RhdGUoKSB7CgkJdGhpcy5fZGF0ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2RhdGUgPSBudWxsOwoJCXRoaXMuX2RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoJbmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9uYW1lICE9IHYpIHsKCQkJCXRoaXMuX25hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX25hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbmFtZSk7CgkJfQoJfQoKCWNsZWFyX25hbWUoKSB7CgkJdGhpcy5fbmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX25hbWUgPSBudWxsOwoJCXRoaXMuX25hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCglyZW1hcmsodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9yZW1hcmtfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZW1hcmsiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3JlbWFyayAhPSB2KSB7CgkJCQl0aGlzLl9yZW1hcmtfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3JlbWFyayA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcmVtYXJrKTsKCQl9Cgl9CgoJY2xlYXJfcmVtYXJrKCkgewoJCXRoaXMuX3JlbWFya19zZXQgPSBudWxsOwoJCXRoaXMuX3JlbWFyayA9IG51bGw7CgkJdGhpcy5fcmVtYXJrX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0b29sX0NvbmZpZ3MgKiovCgl0b29sX0NvbmZpZ3ModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX3Rvb2xfQ29uZmlnczsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnODRjZTQzODgtMWIzZC00MWI3LThkYWItNDNiNWFmMWQ0ZTMxJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdDb25maWcnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX3Rvb2xfc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndG9vbF9Db25maWdzJywgJ0VudGl0eU9iamVjdCcsIDEsICJ0b29sIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJDb25maWciKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0b29sX0NvbmZpZ3MnLCAnRW50aXR5T2JqZWN0JywgMSwgInRvb2wgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJDb25maWciKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YudG9vbCh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl90b29sX0NvbmZpZ3MucHVzaCguLi52KTsKCQl0aGlzLl90b29sX0NvbmZpZ3Nfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX3Rvb2xfQ29uZmlnc19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfdG9vbF9Db25maWdzKCkgewoJCXRoaXMuX3Rvb2xfQ29uZmlnc19zZXQgPSBudWxsOwoJCXRoaXMuX3Rvb2xfQ29uZmlncyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX3Rvb2xfQ29uZmlnc19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHRvb2xfQ29uZmlncyAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHRvb2xfTWFwcGluZ3MgKiovCgl0b29sX01hcHBpbmdzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl90b29sX01hcHBpbmdzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICdmZWI2NzE1Ni1mNzRmLTQ4MzYtOTRhMi0xNGI5ZjIwMDM5ODgnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ01hcHBpbmcnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX3Rvb2xfc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndG9vbF9NYXBwaW5ncycsICdFbnRpdHlPYmplY3QnLCAxLCAidG9vbCBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiTWFwcGluZyIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3Rvb2xfTWFwcGluZ3MnLCAnRW50aXR5T2JqZWN0JywgMSwgInRvb2wgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJNYXBwaW5nIik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LnRvb2wodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fdG9vbF9NYXBwaW5ncy5wdXNoKC4uLnYpOwoJCXRoaXMuX3Rvb2xfTWFwcGluZ3Nfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX3Rvb2xfTWFwcGluZ3NfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX3Rvb2xfTWFwcGluZ3MoKSB7CgkJdGhpcy5fdG9vbF9NYXBwaW5nc19zZXQgPSBudWxsOwoJCXRoaXMuX3Rvb2xfTWFwcGluZ3MgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl90b29sX01hcHBpbmdzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdG9vbF9NYXBwaW5ncyAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX3R5cGVfc2V0LAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJCXRoaXMuX3Rvb2xfQ29uZmlnc19zZXQsCgoJCQl0aGlzLl90b29sX01hcHBpbmdzX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX3R5cGVfc2V0ID0gdGhpcy5fdHlwZV9zZXQ7CgkJcmV0Ll90eXBlX2Nvb3AgPSB0aGlzLl90eXBlX2Nvb3A7CgkJcmV0LnR5cGUgPSB0aGlzLnR5cGUoKSA/IHRoaXMudHlwZSgpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLnR5cGUoKTsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0LnRvb2xfQ29uZmlncyA9IHRoaXMudG9vbF9Db25maWdzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXQudG9vbF9NYXBwaW5ncyA9IHRoaXMudG9vbF9NYXBwaW5ncygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkidHlwZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJdG9vbF9Db25maWdzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndG9vbF9Ub29scycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCXRvb2xfTWFwcGluZ3M6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0b29sX1Rvb2xzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX3RvSGFzaCIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMuTm9Db2RlID8gb0hhc2ggOiB0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7Cgl9CgoJYXN5bmMgX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOwoKCX0KCglfcWxTZWxlY3Rpb25zKHNTZXQpIHsKCQlsZXQgcmV0ID0gW107CgkJaWYgKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7CgoJCXNTZXQuc2VsZWN0aW9ucy5maWx0ZXIocyA9PiBzLnNlbGVjdGlvblNldCkuZm9yRWFjaChzID0+IHsKCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInR5cGUiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIHR5cGUnLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93LlRvb2xfVHlwZSgpLnR5cGVfVG9vbHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCAmJiBldmVudC5jbGFzc05hbWUoKSAmJiBldmVudC5jbGFzc05hbWUoKSAhPSAnVG9vbCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCXJldHVybiBuZXcgc2FsZXNub3dbZXZlbnQuY2xhc3NOYW1lKCldKCkuX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdyk7CgkJCX0KCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9Ub29sLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7CgoJCQl9CgoJCQkvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8KCgkJCWxldCB2ID0gdW5kZWZpbmVkOwoJCQl0cnkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke21ldGhvZH1gKTsKCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQlsZXQgX2lkID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgZGF0YSwgbWV0aG9kLCB7fSk7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIHsKCQkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKGRhdGEpOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSBkYXRhLl9fdGhpcy5jb2RlIHx8IGRhdGEuaWQgfHwgZGF0YS5JRDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCQlpZiAoZGF0YS5JZCAmJiBkYXRhLklkID09IGRhdGEuSWQpIHsKCQkJCQkJX2lkID0gZGF0YS5JZDsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5FbnRpdHlDbGFzcykgewoJCQkJCQlfaWQgPSBkYXRhLkVudGl0eUNsYXNzLklkIHx8IGRhdGEuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI2OWUwMmI0NS1iYzIwLTQ3N2ItYWVkYi1jZDcyNzg2YjRjZmQiIHx8ICJOVUxMIjsKCQkJCQl9CgkJCQl9CgoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2wgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2wgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xbbWV0aG9kXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbFttZXRob2RdIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sW21ldGhvZF1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbFttZXRob2RdW19pZF0gfHwge307CgoJCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKHt9LCB7CgkJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJCX0pOwoKCQkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xbbWV0aG9kXVtfaWRdW19oYXNoXTsKCQkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogNSkpIHsKCQkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIG1ldGhvZCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCQl2LnJldXNlZCsrOwoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0KCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSk7CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xbbWV0aG9kXVtfaWRdW19oYXNoXSA9IHsKCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeSh7fSksCgkJCQkJb2JqOiBkYXRhLAoJCQkJCXJldXNlZDogMCwKCQkJCX07CgkJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZGF0YSwgbWV0aG9kLCB7fSwgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBUcmlnZ2VycmluZyAke21ldGhvZH0gdG8gJHtuLmNvZGUoKX0gJHtKU09OLnN0cmluZ2lmeShkYXRhLG51bGwsNCl9YCk7CgoJCQlsZXQgZXYgPSBuZXcgc2FsZXNub3cuRXZlbnQoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSh0aGlzLl9fY29uZmlnKCdldmVudCcpIHx8ICdzYWxlc25vdy5FdmVudCcpLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnJlY2lwaWVudChuKS5tZXRob2QobWV0aG9kKS5jbGFzc05hbWUoJ1Rvb2wnKS5zZW5kZXIoc2FsZXNub3cuX25vZGUpLmNhcnJpZXIoc2FsZXNub3cuX25vZGUpLnBheWxvYWQoZGF0YSk7CgkJCWlmIChldmVudCkgewoJCQkJaWYgKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOwoJCQkJaWYgKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOwoJCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJaWYgKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOwoJCQl9CgkJCXJldCA9IGF3YWl0IGV2LnRyaWdnZXIoKTsKCgkJCWlmICh0eXBlb2YocmV0KSA9PT0gInN0cmluZyIpIHsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCX0KCQkJcmV0dXJuIHJldDsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5Ub29sKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5Ub29sKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX25vZGUpIHsKCQkJLy8gcHJvYmFibHkgc2hvdWxkIG5vdCBiZSBwcm9jZXNzZWQgaGVyZSwgYnV0IHJhdGhlciBjb25zdW1lZCBhcyBwYXJ0IG9mIHRoZSBleGVjdXRlKCkgbG9naWMsIHB1c2hpbmcgX19ub2RlIHRvIHRoZSBsaXN0IG9mIG15IG5vZGVzIHRvIGRlbGVnYXRlIHRvIT8KCQkJbGV0IHRuID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX19ub2RlKS5fZGVSZWZlcmVuY2UoKTsKCQkJZGVsZXRlIF9wYXJhbXMuX19ub2RlOwoJCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlRvb2woKS5faW52b2tlTm9kZSh0biwgbWV0aG9kLCBfcGFyYW1zKTsKCQl9CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYFRvb2wuX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBUb29sLl9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2wuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuVG9vbC4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiVG9vbCIpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQlpZiAodGhpcy5fdHlwZV9zZXQgJiYgdGhpcy50eXBlKCkpIHRoaXMudHlwZSgpLl9fc3luY19vbihkKTsKCgkJCS8vIHRoaXMudG9vbF9Ub29scygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQkvLyB0aGlzLnRvb2xfVG9vbHMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Ub29sKHRoaXMuSWQpCgoJCQkudHlwZSh0aGlzLnR5cGUoKSwgdGhpcy5fdHlwZV9jb29wKQoKCQkJLmFjdGl2ZSh0aGlzLmFjdGl2ZSgpLCB0aGlzLl9hY3RpdmVfY29vcCkKCgkJCS5lbmFibGVkKHRoaXMuZW5hYmxlZCgpLCB0aGlzLl9lbmFibGVkX2Nvb3ApCgoJCQkuY29kZSh0aGlzLmNvZGUoKSwgdGhpcy5fY29kZV9jb29wKQoKCQkJLm9yZGVyKHRoaXMub3JkZXIoKSwgdGhpcy5fb3JkZXJfY29vcCkKCgkJCS5kYXRlKHRoaXMuZGF0ZSgpLCB0aGlzLl9kYXRlX2Nvb3ApCgoJCQkubmFtZSh0aGlzLm5hbWUoKSwgdGhpcy5fbmFtZV9jb29wKQoKCQkJLnJlbWFyayh0aGlzLnJlbWFyaygpLCB0aGlzLl9yZW1hcmtfY29vcCkKCgkJCS50b29sX0NvbmZpZ3ModGhpcy50b29sX0NvbmZpZ3MoKSwgdGhpcy5fdG9vbF9Db25maWdzX2Nvb3ApCgoJCQkudG9vbF9NYXBwaW5ncyh0aGlzLnRvb2xfTWFwcGluZ3MoKSwgdGhpcy5fdG9vbF9NYXBwaW5nc19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCW9ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdUb29sJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiVG9vbCI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgkJCQlyZXQgPSByZXQudG9Mb3dlckNhc2UoKTsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucyA9IHt9KSB7CgkJdHJ5IHsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sID8gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IG9wdGlvbnMudG9vbCB8fCB0ID09IG9wdGlvbnMudG9vbCkgOiB0aGlzLlRvb2w7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCB8fCB7fTsKCgkJCWxldCBuSUQgPSBzYWxlc25vdy5fbm9kZSA/IHNhbGVzbm93Ll9ub2RlLmNvZGUoKSA6ICJkZWZhdWx0IjsKCgkJCWxldCByZXQgPSBudWxsVmFsdWU7CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldCA9IG51bGw7CgoJCQkvLyB0b29sX0NvbmZpZ3M6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gZG9uZQoJCQlsZXQgdGNvbmYgPSAob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgYy5ub2RlICYmIGMubm9kZS5jb2RlID09IG5JRCkuY29uY2F0KChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiAhYy5ub2RlKSk7CgkJCWlmICh0Y29uZi5sZW5ndGgpIHsKCQkJCXJldCA9IHRjb25mWzBdLnZhbHVlOwoJCQkJdHJ5IHsKCQkJCQlbMSwgMiwgM10uZm9yRWFjaChhID0+IHJldCA9IEpTT04ucGFyc2UocmV0KSk7CgkJCQl9IGNhdGNoIChqZXgpIHt9CgkJCX0KCgkJCS8vIG1vZGVsIENvbmZpZzogQ29uZmlnIGlzIGNsYXNzIGxldmVsLCBub2RlIG5vdCBwb3NzaWJsZSAtIHBlbmRpbmcKCQkJbGV0IG1jb25mID0gdGhpcy5Db25maWcgPyB0aGlzLkNvbmZpZ1tuXSA6IHVuZGVmaW5lZDsKCQkJaWYgKHR5cGVvZihtY29uZikgIT09ICJ1bmRlZmluZWQiKSByZXQgPSBtY29uZjsKCgkJCS8vIGNvbW1hbmQgbGluZTogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgZ2xvYmFsLm1pbmltaXN0KSB7CgkJCQlyZXQgPSBnbG9iYWwubWluaW1pc3QocHJvY2Vzcy5hcmd2LnNsaWNlKDIpKVtuXSB8fCByZXQ7CgkJCX0KCgkJCS8vIHJlcXVlc3Q6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlyZXQgPSB0aGlzLiRfUkVRVUVTVChuKSB8fCByZXQ7CgoJCQlpZiAob3B0aW9ucy5uZXdWYWx1ZSkgewoJCQkJbGV0IHRjID0gdGNvbmYubGVuZ3RoID8gdGNvbmZbMF0gOiB7fTsKCQkJCXRjLm5vZGUgPSB7CgkJCQkJY29kZTogb3B0aW9ucy5ub2RlLmNvZGUoKQoJCQkJfTsKCQkJCXRjLnZhbHVlID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJCXRjLm5hbWUgPSBuOwoJCQkJaWYgKCF0Y29uZi5sZW5ndGgpIHsKCQkJCQlvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLnB1c2godGMpOwoJCQkJfQoJCQkJcmV0ID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJfQoKCQkJLy8gY29uZmlnIHJlcGxhY2VtZW50CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3N0cmluZycpKHJldC5tYXRjaChuZXcgUmVnRXhwKGB7eyhbXn1dKyl9fWAsICJnIikpIHx8IFtdKS5mb3JFYWNoKG0gPT4gcmV0ID0gcmV0LnJlcGxhY2UobSwgdGhpcy5fX2NvbmZpZyhtLnJlcGxhY2UoJ3t7JywgJycpLnJlcGxhY2UoJ319JywgJycpLCBudWxsLCBvcHRpb25zKSkpOwoKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2NvbmZpZycsICdFbnRpdHlPYmplY3QnLCAxLCBuLCBudWxsVmFsdWUsIG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MsIGV4KTsKCQl9Cgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgoJCQkJCS8vIGlmKHRoaXNbJ18nK2ZpZWxkKydfc2V0J10gJiYgKHR5cGVvZih0aGlzWydfJytmaWVsZF0pPT09J3VuZGVmaW5lZCcgfHwgdGhpc1snXycrZmllbGRdPT1udWxsKSkgcmV0dXJuOwoJCQkJCS8vIGlmKHR5cGVvZihlYU9iaik9PT0ndW5kZWZpbmVkJykgcmV0dXJuOyAvLyB3aHk/CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlyZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqLCB0aGlzLmNvZGUoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmosIHRoaXMuZGF0ZSgpKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmosIHRoaXMubmFtZSgpKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaiwgdGhpcy5yZW1hcmsoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI2OWUwMmI0NS1iYzIwLTQ3N2ItYWVkYi1jZDcyNzg2YjRjZmQiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbCB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbFtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCWlmICghdGhpcy50eXBlKCkgfHwgKHRoaXMudHlwZSgpCgoJCQkJJiYKCQkJCSF0aGlzLnR5cGUoKS50eXBlX1Rvb2xzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnR5cGUoKS50eXBlX01hcHBpbmdzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJ0eXBlIiwgb2JqLCB0aGlzLnR5cGUoKSk7CgkJfQoKCQlfb3B0aW9ucygidG9vbF9Db25maWdzIiwgb2JqLCB0aGlzLnRvb2xfQ29uZmlncygpKTsKCgkJX29wdGlvbnMoInRvb2xfTWFwcGluZ3MiLCBvYmosIHRoaXMudG9vbF9NYXBwaW5ncygpKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsndHlwZScsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsndG9vbF9Db25maWdzJywgJ3Rvb2xfTWFwcGluZ3MnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIlRvb2wiICYmIChtLnRhcmdldCB8fCBtLm91dFNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSAmJiAoIW0uc291cmNlIHx8IChtLnNvdXJjZSAmJiAvKiFtLm91dFNjcmlwdCAmJiovIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX3NldCddKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5vdXRTY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMsIG9TY29wZSwgbWFwKSA9PiB7JHttLm91dFNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLm91dFNjcmlwdH0pfWApKHRoaXMsIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnNvdXJjZSkgewoJCQkJaWYgKG0uc291cmNlLmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcykgPT4ge3JldHVybiBfdGhpcy4ke20uc291cmNlfTt9YCkodGhpcyk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnNvdXJjZSwgdGhpcyk7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0udGFyZ2V0KSBvYmpbbS50YXJnZXRdID0gcmV0OwoJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQlbbS50YXJnZXQgfHwgbS5zb3VyY2VdOiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10KCQkJfSk7CgkJfSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJLy8gdXNlIHRoaXMuX21hcCgpIHdpdGggcmV2ZXJzZQoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI2OWUwMmI0NS1iYzIwLTQ3N2ItYWVkYi1jZDcyNzg2YjRjZmQiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbCB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbFtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoInR5cGUiLCBvYmopOwoKCQlfb3B0aW9ucygidG9vbF9Db25maWdzIiwgb2JqKTsKCgkJX29wdGlvbnMoInRvb2xfTWFwcGluZ3MiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWyd0eXBlJywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWyd0b29sX0NvbmZpZ3MnLCAndG9vbF9NYXBwaW5ncyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaikpOwoKCQlmYWxzZSAmJiBbXS5jb25jYXQodGhpcy5Ub29sLnR5cGUudHlwZV9NYXBwaW5ncyB8fCBbXSkuY29uY2F0KHRoaXMuVG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5maWx0ZXIobSA9PiBtLmNsYXNzTmFtZSA9PSAiVG9vbCIgJiYgKG0uc291cmNlIHx8IG0uaW5TY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5pblNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmosIG9TY29wZSwgbWFwKSA9PiB7JHttLmluU2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20uaW5TY3JpcHR9KX1gKShvYmosIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnRhcmdldCkgewoJCQkJaWYgKG0udGFyZ2V0LmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmopID0+IHtyZXR1cm4gb2JqLiR7bS50YXJnZXR9O31gKShvYmopOwoJCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqW20udGFyZ2V0XSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0udGFyZ2V0LCBvYmopOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0uc291cmNlKSB7CgkJCQlpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXRoaXNbbS5zb3VyY2VdKHJldCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXNbbS5zb3VyY2VdID0gcmV0OwoJCQkJfQoJCQl9CgkJfSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuVG9vbCkgcmV0dXJuOwoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5Ub29sID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiVG9vbCIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQl0eXBlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai50eXBlID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS50eXBlKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3R5cGVfc2V0ICYmICFxdWVyeS5fdHlwZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudHlwZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl90eXBlX3NldCAmJiBxdWVyeS5fdHlwZV9zZXQpIHx8CgoJCQkJCQkodGhpcy50eXBlKCkgJiYgIXRoaXMudHlwZSgpLl9tYXRjaGVzKHF1ZXJ5LnR5cGUoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnR5cGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCXRvb2xfQ29uZmlnczogKG9iaiwgdikgPT4gewoJCQkJCW9iai50b29sX0NvbmZpZ3MgPSB2Lm1hcChfdiA9PiBxdWVyeS50b29sX0NvbmZpZ3MoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCQl0b29sX01hcHBpbmdzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnRvb2xfTWFwcGluZ3MgPSB2Lm1hcChfdiA9PiBxdWVyeS50b29sX01hcHBpbmdzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoZXMiKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDAsIG9NYXRjaCk7CgoJCQlyZXR1cm4gT2JqZWN0LmtleXMob01hdGNoKS5ldmVyeShrID0+IG9NYXRjaFtrXSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfbWF0Y2hpbmcocXVlcnkpIHsKCQl0cnkgewoJCQlsZXQgcmV0ID0gW107CgoJCQlsZXQgbWF0Y2hlcyA9IHRoaXMuX19leHBvcnQoe30sIHsKCgkJCQl0eXBlOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgdHlwZSIpOwoJCQkJCW9iai50eXBlID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJdG9vbF9Db25maWdzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnRvb2xfQ29uZmlncyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQkJdG9vbF9NYXBwaW5nczogKG9iaiwgdikgPT4gewoJCQkJCW9iai50b29sX01hcHBpbmdzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl90eXBlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJdHlwZTogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLnR5cGUocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCXRvb2xfQ29uZmlnczogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLnRvb2xfQ29uZmlncygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQl0b29sX01hcHBpbmdzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMudG9vbF9NYXBwaW5ncygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCXR5cGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSA6ICJ0eXBlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3R5cGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMudHlwZSgpIHx8IG5ldyBzYWxlc25vdy5Ub29sX1R5cGUoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLnR5cGUob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSB0eXBlIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb2RlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jb2RlKHJlZik7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3JkZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9yZGVyKHJlZik7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLmRhdGUocmVmKTsKCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9uYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5uYW1lKHJlZik7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVtYXJrX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5yZW1hcmsocmVmKTsKCgkJCX0sCgoJCQl0b29sX0NvbmZpZ3M6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0b29sX1Rvb2xzJywgdW5kZWZpbmVkKSA6ICJ0b29sX0NvbmZpZ3MiKSkgPT4gdGhpcy50b29sX0NvbmZpZ3Mob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkNvbmZpZygpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQkJdG9vbF9NYXBwaW5nczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3Rvb2xfVG9vbHMnLCB1bmRlZmluZWQpIDogInRvb2xfTWFwcGluZ3MiKSkgPT4gdGhpcy50b29sX01hcHBpbmdzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5NYXBwaW5nKCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddID0gdiwKCgkJCSJ0eXBlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpIDogInR5cGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl90eXBlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl90eXBlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3JkZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGw7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIG9ialtlYUNvZGVdID0gb2JqW2VhQ29kZV0ucmVwbGFjZSgvXC5bMC05XSpaL2csICcnKTsKCgkJCQlpZiAodGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGF0ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9uYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9uYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3JlbWFya19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQl0b29sX0NvbmZpZ3M6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0b29sX1Rvb2xzJywgdW5kZWZpbmVkKSA6ICJ0b29sX0NvbmZpZ3MiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fdG9vbF9Db25maWdzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl90b29sX0NvbmZpZ3NfY29vcDsKCQkJCX0KCQkJfSwKCgkJCXRvb2xfTWFwcGluZ3M6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0b29sX1Rvb2xzJywgdW5kZWZpbmVkKSA6ICJ0b29sX01hcHBpbmdzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX3Rvb2xfTWFwcGluZ3NfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3Rvb2xfTWFwcGluZ3NfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCWJ5VG9vbF9UeXBlKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl90eXBlIl0gJiYgKGFbIl90eXBlIl0uRXF1YWxzID8gYVsiX3R5cGUiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX3R5cGUiXSwgcikpKSB7CgkJCQkJci5fdHlwZV9Ub29scy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gdHJ1ZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLm5hbWUgPSB7fTsKCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgZXJyb3IubmFtZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IubmFtZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IubmFtZTsKCQl9CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlRvb2wuc3RvcmUnKTsgLy8gb3IgaW5zaWRlIGV4ZWN1dGU/CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJbGV0IGJVcGRhdGUgPSBmYWxzZTsKCQkJbGV0IGJJbnNlcnQgPSBmYWxzZTsKCgkJCWlmICghdGhpcy5fX3N5bmNfb24oKSkgewoJCQkJbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LlRvb2wobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLm5hbWUodGhpcy5uYW1lKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX3R5cGVfc2V0ICYmIHRoaXMudHlwZSgpICYmICEoYXdhaXQgdGhpcy50eXBlKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfdHlwZSgpOwoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl90b29sX0NvbmZpZ3Nfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy50b29sX0NvbmZpZ3MoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuX3Rvb2xfTWFwcGluZ3Nfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy50b29sX01hcHBpbmdzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlRvb2wuaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuVG9vbC51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlRvb2wuZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2ApOwoJCQkJcmV0ID0gcmV0LmNvbnRlbnQgPyBbSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSldIDogW107CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5tYXAociA9PiBuZXcgc2FsZXNub3cuVG9vbChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93LlRvb2xfVHlwZSA9IGNsYXNzIFRvb2xfVHlwZSBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFzS2k1ZmJHOWhaRlJ2YjJ4ekxDb3VZWFYwYUVOdlpHVXNSWFpsYm5RdWJHbHpkR1Z1TEVWMlpXNTBMbkJ5YjJObGMzTXNSWFpsYm5RdWRISnBaMmRsY2lKOWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKT2IyUmxJanA3SW01dlJHVjBaV04wSWpwMGNuVmxMQ0pwYm1sMExtVnVaSE1pT2pJc0ltbHVhWFF1Ykc5dmNDSTZNQzQxTENKMGIyOXNjeTV6ZEc5eVpTSTZabUZzYzJVc0ltUmxkR1ZqZEZCaGNtVnVkQzVKVUNJNklqRTRNaTR4TmpndU56QXVPRElpTENKa1pYUmxZM1JRWVhKbGJuUXVZMjlrWlNJNkltVTRaR1V3Tm1VelpXUmpORFF6WVdVNVpHWmxNV1JsTldWak5USmhOR0ptSWl3aWMyVmpjbVYwSWpvaWIxTkxkMmRhTW5OTFJrOVVTVXBqWWtGbVZVbFJORU5xT1hGelNEUTRibXdpTENKd2JHRjVaM0p2ZFc1a0lqcDBjblZsTENKblVsQkRJanAwY25WbExDSnpkRzl5WlM1elpXNXphWFJwZG1sMGVTSTZNU3dpWTI5dGNHRnVlU0k2SW5KbGMzVnRaU0o5TENKRmRtVnVkQ0k2ZXlKMGNtbG5aMlZ5TG5ScGJXVnZkWFFpT2pFd01EQXdMQ0p6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMHNJbFJ2YjJ3aU9uc2laMmwwYUhWaUxuUnZiMnh6SWpvaWFIUjBjSE02THk5eVlYY3VaMmwwYUhWaWRYTmxjbU52Ym5SbGJuUXVZMjl0TDJaaFpHbHVMMlpoWkdsdUxtZHBkR2gxWWk1cGJ5OXRZWE4wWlhJdklpd2ljMlZqY21WMElqb2liMU5MZDJkYU1uTkxSazlVU1VwallrRm1WVWxSTkVOcU9YRnpTRFE0Ym13aUxDSndiR0Y1WjNKdmRXNWtJanAwY25WbExDSm5VbEJESWpwMGNuVmxMQ0p6ZEc5eVpTNXpaVzV6YVhScGRtbDBlU0k2TVN3aVkyOXRjR0Z1ZVNJNkluSmxjM1Z0WlNKOUxDSnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlBRWFYwYUZOaGJtUWlMQ0pIYVhSSWRXSWlYUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2FjdGl2ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2VuYWJsZWQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb2RlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb2RlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3JkZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29yZGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZGF0ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZGF0ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm5hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX25hbWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3JlbWFyaygpOwoKCQl0aGlzLmNsZWFyX3R5cGVfVG9vbHMoKTsKCgkJdGhpcy5jbGVhcl90eXBlX01hcHBpbmdzKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiVG9vbCBUeXBlIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQkvLyAodGhpcy50eXBlX1Rvb2xzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJLy8gKHRoaXMudHlwZV9NYXBwaW5ncygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoJY29kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb2RlICE9IHYpIHsKCQkJCXRoaXMuX2NvZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29kZSk7CgkJfQoJfQoKCWNsZWFyX2NvZGUoKSB7CgkJdGhpcy5fY29kZV9zZXQgPSBudWxsOwoJCXRoaXMuX2NvZGUgPSBudWxsOwoJCXRoaXMuX2NvZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCglkYXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImRhdGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJyA/IF92IDogKG5ldyBEYXRlKF92KSk7CgkJCQlpZiAoaXNOYU4oX3YuZ2V0VGltZSgpKSkgX3YgPSBudWxsOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuRGF0ZVZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RhdGUgIT0gdikgewoJCQkJdGhpcy5fZGF0ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkRhdGVWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGF0ZSk7CgkJfQoJfQoKCWNsZWFyX2RhdGUoKSB7CgkJdGhpcy5fZGF0ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2RhdGUgPSBudWxsOwoJCXRoaXMuX2RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoJbmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9uYW1lICE9IHYpIHsKCQkJCXRoaXMuX25hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX25hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbmFtZSk7CgkJfQoJfQoKCWNsZWFyX25hbWUoKSB7CgkJdGhpcy5fbmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX25hbWUgPSBudWxsOwoJCXRoaXMuX25hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCglyZW1hcmsodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9yZW1hcmtfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZW1hcmsiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3JlbWFyayAhPSB2KSB7CgkJCQl0aGlzLl9yZW1hcmtfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3JlbWFyayA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcmVtYXJrKTsKCQl9Cgl9CgoJY2xlYXJfcmVtYXJrKCkgewoJCXRoaXMuX3JlbWFya19zZXQgPSBudWxsOwoJCXRoaXMuX3JlbWFyayA9IG51bGw7CgkJdGhpcy5fcmVtYXJrX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0eXBlX1Rvb2xzICoqLwoJdHlwZV9Ub29scyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fdHlwZV9Ub29sczsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnNjllMDJiNDUtYmMyMC00NzdiLWFlZGItY2Q3Mjc4NmI0Y2ZkJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdUb29sJykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll90eXBlX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3R5cGVfVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMSwgInR5cGUgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIlRvb2wiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0eXBlX1Rvb2xzJywgJ0VudGl0eU9iamVjdCcsIDEsICJ0eXBlIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiVG9vbCIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi50eXBlKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX3R5cGVfVG9vbHMucHVzaCguLi52KTsKCQl0aGlzLl90eXBlX1Rvb2xzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl90eXBlX1Rvb2xzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl90eXBlX1Rvb2xzKCkgewoJCXRoaXMuX3R5cGVfVG9vbHNfc2V0ID0gbnVsbDsKCQl0aGlzLl90eXBlX1Rvb2xzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fdHlwZV9Ub29sc19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHR5cGVfVG9vbHMgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0eXBlX01hcHBpbmdzICoqLwoJdHlwZV9NYXBwaW5ncyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fdHlwZV9NYXBwaW5nczsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnZmViNjcxNTYtZjc0Zi00ODM2LTk0YTItMTRiOWYyMDAzOTg4JyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdNYXBwaW5nJykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll90eXBlX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3R5cGVfTWFwcGluZ3MnLCAnRW50aXR5T2JqZWN0JywgMSwgInR5cGUgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIk1hcHBpbmciKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0eXBlX01hcHBpbmdzJywgJ0VudGl0eU9iamVjdCcsIDEsICJ0eXBlIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiTWFwcGluZyIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi50eXBlKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX3R5cGVfTWFwcGluZ3MucHVzaCguLi52KTsKCQl0aGlzLl90eXBlX01hcHBpbmdzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl90eXBlX01hcHBpbmdzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl90eXBlX01hcHBpbmdzKCkgewoJCXRoaXMuX3R5cGVfTWFwcGluZ3Nfc2V0ID0gbnVsbDsKCQl0aGlzLl90eXBlX01hcHBpbmdzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fdHlwZV9NYXBwaW5nc19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHR5cGVfTWFwcGluZ3MgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fdHlwZV9Ub29sc19zZXQsCgoJCQl0aGlzLl90eXBlX01hcHBpbmdzX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX2FjdGl2ZV9zZXQgPSB0aGlzLl9hY3RpdmVfc2V0OwoJCXJldC5fYWN0aXZlX2Nvb3AgPSB0aGlzLl9hY3RpdmVfY29vcDsKCQlyZXQuYWN0aXZlID0gdGhpcy5hY3RpdmUoKSA/IHRoaXMuYWN0aXZlKCkgOiB0aGlzLmFjdGl2ZSgpOwoKCQlyZXQuX2VuYWJsZWRfc2V0ID0gdGhpcy5fZW5hYmxlZF9zZXQ7CgkJcmV0Ll9lbmFibGVkX2Nvb3AgPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJcmV0LmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKSA/IHRoaXMuZW5hYmxlZCgpIDogdGhpcy5lbmFibGVkKCk7CgoJCXJldC5fY29kZV9zZXQgPSB0aGlzLl9jb2RlX3NldDsKCQlyZXQuX2NvZGVfY29vcCA9IHRoaXMuX2NvZGVfY29vcDsKCQlyZXQuY29kZSA9IHRoaXMuY29kZSgpID8gdGhpcy5jb2RlKCkgOiB0aGlzLmNvZGUoKTsKCgkJcmV0Ll9vcmRlcl9zZXQgPSB0aGlzLl9vcmRlcl9zZXQ7CgkJcmV0Ll9vcmRlcl9jb29wID0gdGhpcy5fb3JkZXJfY29vcDsKCQlyZXQub3JkZXIgPSB0aGlzLm9yZGVyKCkgPyB0aGlzLm9yZGVyKCkgOiB0aGlzLm9yZGVyKCk7CgoJCXJldC5fZGF0ZV9zZXQgPSB0aGlzLl9kYXRlX3NldDsKCQlyZXQuX2RhdGVfY29vcCA9IHRoaXMuX2RhdGVfY29vcDsKCQlyZXQuZGF0ZSA9IHRoaXMuZGF0ZSgpID8gdGhpcy5kYXRlKCkgOiB0aGlzLmRhdGUoKTsKCgkJcmV0Ll9uYW1lX3NldCA9IHRoaXMuX25hbWVfc2V0OwoJCXJldC5fbmFtZV9jb29wID0gdGhpcy5fbmFtZV9jb29wOwoJCXJldC5uYW1lID0gdGhpcy5uYW1lKCkgPyB0aGlzLm5hbWUoKSA6IHRoaXMubmFtZSgpOwoKCQlyZXQuX3JlbWFya19zZXQgPSB0aGlzLl9yZW1hcmtfc2V0OwoJCXJldC5fcmVtYXJrX2Nvb3AgPSB0aGlzLl9yZW1hcmtfY29vcDsKCQlyZXQucmVtYXJrID0gdGhpcy5yZW1hcmsoKSA/IHRoaXMucmVtYXJrKCkgOiB0aGlzLnJlbWFyaygpOwoKCQlyZXQudHlwZV9Ub29scyA9IHRoaXMudHlwZV9Ub29scygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0LnR5cGVfTWFwcGluZ3MgPSB0aGlzLnR5cGVfTWFwcGluZ3MoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCXR5cGVfVG9vbHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlX1Rvb2xfVHlwZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQl0eXBlX01hcHBpbmdzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZV9Ub29sX1R5cGVzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX3RvSGFzaCIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMuTm9Db2RlID8gb0hhc2ggOiB0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7Cgl9CgoJYXN5bmMgX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOwoKCX0KCglfcWxTZWxlY3Rpb25zKHNTZXQpIHsKCQlsZXQgcmV0ID0gW107CgkJaWYgKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7CgoJCXNTZXQuc2VsZWN0aW9ucy5maWx0ZXIocyA9PiBzLnNlbGVjdGlvblNldCkuZm9yRWFjaChzID0+IHsKCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpICE9ICdUb29sX1R5cGUnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiRGVsZWdhdGluZyBpbnZva2F0aW9uIHRvICIgKyBldmVudC5jbGFzc05hbWUoKSk7CgkJCQlyZXR1cm4gbmV3IHNhbGVzbm93W2V2ZW50LmNsYXNzTmFtZSgpXSgpLl9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpOwoJCQl9CgoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQlkYXRhLl9fdGhpcyA9IGRhdGEuX190aGlzIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkJc3dpdGNoIChtZXRob2QpIHsKCgkJCX0KCQl9CgoJCWlmICghbiB8fCBzYWxlc25vdy5fbm9kZS5fc2FtZU5vZGUobikpIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkNhbGxiYWNrIik7CgkJCXJldCA9IGF3YWl0IHRoaXMuX2ludm9rZShtZXRob2QsIGRhdGEpOwoJCX0gZWxzZSBpZiAobi5hZGRyZXNzKCkgJiYgbi5fc2FtZU5vZGUobikgLyphY3R1YWwgbm9kZSovICkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBuLl9hZGRyZXNzLCBuLl9wb3J0LCBtZXRob2QpOwoJCQl0cnkgewoJCQkJbGV0IGNvbmZpZyA9IHsKCQkJCQloZWFkZXJzOiB7fSwKCQkJCX07CgkJCQlpZiAoc2FsZXNub3cuX190b2tlbikgY29uZmlnLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGAke3NhbGVzbm93Ll9fdG9rZW4udG9rZW5fdHlwZX0gJHtzYWxlc25vdy5fX3Rva2VuLmFjY2Vzc190b2tlbn1gOwoJCQkJcmV0ID0gYXdhaXQgYXhpb3MucG9zdChgaHR0cCR7bi5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHtuLmFkZHJlc3MoKX06JHtuLnBvcnQoKSB8fCAzMDAwfS9tZXRob2QvVG9vbF9UeXBlLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7CgoJCQl9CgoJCQkvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8KCgkJCWxldCB2ID0gdW5kZWZpbmVkOwoJCQl0cnkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke21ldGhvZH1gKTsKCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQlsZXQgX2lkID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgZGF0YSwgbWV0aG9kLCB7fSk7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIHsKCQkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKGRhdGEpOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSBkYXRhLl9fdGhpcy5jb2RlIHx8IGRhdGEuaWQgfHwgZGF0YS5JRDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCQlpZiAoZGF0YS5JZCAmJiBkYXRhLklkID09IGRhdGEuSWQpIHsKCQkJCQkJX2lkID0gZGF0YS5JZDsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5FbnRpdHlDbGFzcykgewoJCQkJCQlfaWQgPSBkYXRhLkVudGl0eUNsYXNzLklkIHx8IGRhdGEuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJmMTYwNzU5MS0zMDQ5LTQ3OGYtOTg5Zi04ZTY5MjA1YWZjMWIiIHx8ICJOVUxMIjsKCQkJCQl9CgkJCQl9CgoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sX1R5cGVbbWV0aG9kXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlW21ldGhvZF0gfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVttZXRob2RdW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVttZXRob2RdW19pZF0gfHwge307CgoJCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKHt9LCB7CgkJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJCX0pOwoKCQkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVttZXRob2RdW19pZF1bX2hhc2hdOwoJCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiA1KSkgewoJCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gbWV0aG9kIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJCXYucmV1c2VkKys7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhKTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlW21ldGhvZF1bX2lkXVtfaGFzaF0gPSB7CgkJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoe30pLAoJCQkJCW9iajogZGF0YSwKCQkJCQlyZXVzZWQ6IDAsCgkJCQl9OwoJCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0gPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGRhdGEsIG1ldGhvZCwge30sIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBgVHJpZ2dlcnJpbmcgJHttZXRob2R9IHRvICR7bi5jb2RlKCl9ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSxudWxsLDQpfWApOwoKCQkJbGV0IGV2ID0gbmV3IHNhbGVzbm93LkV2ZW50KCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuY29kZSh0aGlzLl91dWlkKCkpLm5hbWUodGhpcy5fX2NvbmZpZygnZXZlbnQnKSB8fCAnc2FsZXNub3cuRXZlbnQnKS5kYXRlKHRoaXMuc2VydmVyRGF0ZSgpKS5yZWNpcGllbnQobikubWV0aG9kKG1ldGhvZCkuY2xhc3NOYW1lKCdUb29sX1R5cGUnKS5zZW5kZXIoc2FsZXNub3cuX25vZGUpLmNhcnJpZXIoc2FsZXNub3cuX25vZGUpLnBheWxvYWQoZGF0YSk7CgkJCWlmIChldmVudCkgewoJCQkJaWYgKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOwoJCQkJaWYgKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOwoJCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJaWYgKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOwoJCQl9CgkJCXJldCA9IGF3YWl0IGV2LnRyaWdnZXIoKTsKCgkJCWlmICh0eXBlb2YocmV0KSA9PT0gInN0cmluZyIpIHsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCX0KCQkJcmV0dXJuIHJldDsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5Ub29sX1R5cGUobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93LlRvb2xfVHlwZShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocCkpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHt9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2UobWV0aG9kLCBib2R5LCBxdWVyeSwgYXV0aE9iaikgewoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgbWV0aG9kLCBxdWVyeSwgYm9keSk7CgoJCWlmICh0eXBlb2YoYm9keSkgPT09ICdzdHJpbmcnIHx8ICh0eXBlb2YoQnVmZmVyKSAhPT0gJ3VuZGVmaW5lZCcgJiYgQnVmZmVyLmlzQnVmZmVyKGJvZHkpKSkgewoJCQl0cnkgewoJCQkJYm9keSA9IEpTT04ucGFyc2UoYm9keS50b1N0cmluZygpKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJvZHkgaXMgbm90IGEgdmFsaWQgSlNPTiIsIGJvZHkpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoKCQlsZXQgX3BhcmFtcyA9IHF1ZXJ5ID8gT2JqZWN0LmFzc2lnbihxdWVyeSwgYm9keSkgOiBib2R5OwoJCWlmICh0eXBlb2YoX3BhcmFtcykgPT09ICdzdHJpbmcnKSBfcGFyYW1zID0gSlNPTi5wYXJzZShfcGFyYW1zKTsKCgkJaWYgKF9wYXJhbXMpIHsKCQkJX3BhcmFtcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcyk7CgkJfSBlbHNlIHsKCQkJX3BhcmFtcyA9IHt9OwoJCX0KCgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgX3BhcmFtcy5fX2ZsYXR0ZWQpIF9wYXJhbXMgPSBGbGF0dGVkLnBhcnNlKF9wYXJhbXMuX19mbGF0dGVkKTsKCgkJaWYgKF9wYXJhbXMuX19ub2RlKSB7CgkJCS8vIHByb2JhYmx5IHNob3VsZCBub3QgYmUgcHJvY2Vzc2VkIGhlcmUsIGJ1dCByYXRoZXIgY29uc3VtZWQgYXMgcGFydCBvZiB0aGUgZXhlY3V0ZSgpIGxvZ2ljLCBwdXNoaW5nIF9fbm9kZSB0byB0aGUgbGlzdCBvZiBteSBub2RlcyB0byBkZWxlZ2F0ZSB0byE/CgkJCWxldCB0biA9IG5ldyBzYWxlc25vdy5Ob2RlKCkuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fbm9kZSkuX2RlUmVmZXJlbmNlKCk7CgkJCWRlbGV0ZSBfcGFyYW1zLl9fbm9kZTsKCQkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Ub29sX1R5cGUoKS5faW52b2tlTm9kZSh0biwgbWV0aG9kLCBfcGFyYW1zKTsKCQl9CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYFRvb2xfVHlwZS5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYFRvb2xfVHlwZS5faW52b2tlOiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLAoJCQkJCSdvYmonOiBvYmoKCQkJCX0KCQkJfTsKCQl9IGVsc2UgewoJCQlyZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOwoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQl9CgoJCWlmIChyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbikgewoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0ge307CgkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCXJldCA9IHJldC5tYXAociA9PiB7CgkJCQkJaWYgKHIgJiYgci5fdG9Eb2N1bWVudCkgewoJCQkJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sX1R5cGUuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuVG9vbF9UeXBlLicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlIHx8ICJUb29sIFR5cGUiKTsKCgl9CgoJX19zeW5jX29uKGQpIHsKCQl0aGlzLl9fX3N5bmNfb24gPSB0aGlzLl9fX3N5bmNfb24gfHwge307CgoJCWlmIChkKSB7CgkJCXRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV0gPSBkOwoKCQkJLy8gdGhpcy50eXBlX1Rvb2xfVHlwZXMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJLy8gdGhpcy50eXBlX1Rvb2xfVHlwZXMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Ub29sX1R5cGUodGhpcy5JZCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkudHlwZV9Ub29scyh0aGlzLnR5cGVfVG9vbHMoKSwgdGhpcy5fdHlwZV9Ub29sc19jb29wKQoKCQkJLnR5cGVfTWFwcGluZ3ModGhpcy50eXBlX01hcHBpbmdzKCksIHRoaXMuX3R5cGVfTWFwcGluZ3NfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCkgewoJCWNvbnRleHQgPSBjb250ZXh0IHx8ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCW9iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQlvYmpUbyA9IG9ialRvIHx8IHt9OwoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAnVG9vbF9UeXBlJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiVG9vbF9UeXBlIjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCQkJCXJldCA9IHJldC50b0xvd2VyQ2FzZSgpOwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCQl0cnkgewoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgPyAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gb3B0aW9ucy50b29sIHx8IHQgPT0gb3B0aW9ucy50b29sKSA6IHRoaXMuVG9vbDsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sIHx8IHt9OwoKCQkJbGV0IG5JRCA9IHNhbGVzbm93Ll9ub2RlID8gc2FsZXNub3cuX25vZGUuY29kZSgpIDogImRlZmF1bHQiOwoKCQkJbGV0IHJldCA9IG51bGxWYWx1ZTsKCQkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0ID0gbnVsbDsKCgkJCS8vIHRvb2xfQ29uZmlnczogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBkb25lCgkJCWxldCB0Y29uZiA9IChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiBjLm5vZGUgJiYgYy5ub2RlLmNvZGUgPT0gbklEKS5jb25jYXQoKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmICFjLm5vZGUpKTsKCQkJaWYgKHRjb25mLmxlbmd0aCkgewoJCQkJcmV0ID0gdGNvbmZbMF0udmFsdWU7CgkJCQl0cnkgewoJCQkJCVsxLCAyLCAzXS5mb3JFYWNoKGEgPT4gcmV0ID0gSlNPTi5wYXJzZShyZXQpKTsKCQkJCX0gY2F0Y2ggKGpleCkge30KCQkJfQoKCQkJLy8gbW9kZWwgQ29uZmlnOiBDb25maWcgaXMgY2xhc3MgbGV2ZWwsIG5vZGUgbm90IHBvc3NpYmxlIC0gcGVuZGluZwoJCQlsZXQgbWNvbmYgPSB0aGlzLkNvbmZpZyA/IHRoaXMuQ29uZmlnW25dIDogdW5kZWZpbmVkOwoJCQlpZiAodHlwZW9mKG1jb25mKSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IG1jb25mOwoKCQkJLy8gY29tbWFuZCBsaW5lOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiBnbG9iYWwubWluaW1pc3QpIHsKCQkJCXJldCA9IGdsb2JhbC5taW5pbWlzdChwcm9jZXNzLmFyZ3Yuc2xpY2UoMikpW25dIHx8IHJldDsKCQkJfQoKCQkJLy8gcmVxdWVzdDogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCXJldCA9IHRoaXMuJF9SRVFVRVNUKG4pIHx8IHJldDsKCgkJCWlmIChvcHRpb25zLm5ld1ZhbHVlKSB7CgkJCQlsZXQgdGMgPSB0Y29uZi5sZW5ndGggPyB0Y29uZlswXSA6IHt9OwoJCQkJdGMubm9kZSA9IHsKCQkJCQljb2RlOiBvcHRpb25zLm5vZGUuY29kZSgpCgkJCQl9OwoJCQkJdGMudmFsdWUgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQkJdGMubmFtZSA9IG47CgkJCQlpZiAoIXRjb25mLmxlbmd0aCkgewoJCQkJCW9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MucHVzaCh0Yyk7CgkJCQl9CgkJCQlyZXQgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQl9CgoJCQkvLyBjb25maWcgcmVwbGFjZW1lbnQKCQkJaWYgKHR5cGVvZihyZXQpID09PSAnc3RyaW5nJykocmV0Lm1hdGNoKG5ldyBSZWdFeHAoYHt7KFtefV0rKX19YCwgImciKSkgfHwgW10pLmZvckVhY2gobSA9PiByZXQgPSByZXQucmVwbGFjZShtLCB0aGlzLl9fY29uZmlnKG0ucmVwbGFjZSgne3snLCAnJykucmVwbGFjZSgnfX0nLCAnJyksIG51bGwsIG9wdGlvbnMpKSk7CgoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fY29uZmlnJywgJ0VudGl0eU9iamVjdCcsIDEsIG4sIG51bGxWYWx1ZSwgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncywgZXgpOwoJCX0KCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCgkJCQkJLy8gaWYodGhpc1snXycrZmllbGQrJ19zZXQnXSAmJiAodHlwZW9mKHRoaXNbJ18nK2ZpZWxkXSk9PT0ndW5kZWZpbmVkJyB8fCB0aGlzWydfJytmaWVsZF09PW51bGwpKSByZXR1cm47CgkJCQkJLy8gaWYodHlwZW9mKGVhT2JqKT09PSd1bmRlZmluZWQnKSByZXR1cm47IC8vIHdoeT8KCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCXJldHVybiBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgImYxNjA3NTkxLTMwNDktNDc4Zi05ODlmLThlNjkyMDVhZmMxYiIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sX1R5cGUgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sX1R5cGVbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCV9vcHRpb25zKCJ0eXBlX1Rvb2xzIiwgb2JqLCB0aGlzLnR5cGVfVG9vbHMoKSk7CgoJCV9vcHRpb25zKCJ0eXBlX01hcHBpbmdzIiwgb2JqLCB0aGlzLnR5cGVfTWFwcGluZ3MoKSk7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWyd0eXBlX1Rvb2xzJywgJ3R5cGVfTWFwcGluZ3MnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIlRvb2xfVHlwZSIgJiYgKG0udGFyZ2V0IHx8IG0ub3V0U2NyaXB0KSAmJiBtLmFjdGl2ZSAmJiBtLmVuYWJsZWQgJiYgKChtLnRvb2wgJiYgbS50b29sLm5hbWUgPT0gdGhpcy5Ub29sLm5hbWUpIHx8IChtLnR5cGUgJiYgbS50eXBlLm5hbWUgPT0gdGhpcy5Ub29sLnR5cGUubmFtZSkpICYmICghbS5zb3VyY2UgfHwgKG0uc291cmNlICYmIC8qIW0ub3V0U2NyaXB0ICYmKi8gdGhpc1snXycgKyBtLnNvdXJjZSArICdfc2V0J10pKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLm91dFNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcywgb1Njb3BlLCBtYXApID0+IHske20ub3V0U2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20ub3V0U2NyaXB0fSl9YCkodGhpcywgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0uc291cmNlKSB7CgkJCQlpZiAobS5zb3VyY2UuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzKSA9PiB7cmV0dXJuIF90aGlzLiR7bS5zb3VyY2V9O31gKSh0aGlzKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0uc291cmNlLCB0aGlzKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS50YXJnZXQpIG9ialttLnRhcmdldF0gPSByZXQ7CgkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCVttLnRhcmdldCB8fCBtLnNvdXJjZV06IHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXQoJCQl9KTsKCQl9KTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQkvLyB1c2UgdGhpcy5fbWFwKCkgd2l0aCByZXZlcnNlCgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgImYxNjA3NTkxLTMwNDktNDc4Zi05ODlmLThlNjkyMDVhZmMxYiIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sX1R5cGUgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sX1R5cGVbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcyk7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoInR5cGVfVG9vbHMiLCBvYmopOwoKCQlfb3B0aW9ucygidHlwZV9NYXBwaW5ncyIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWyd0eXBlX1Rvb2xzJywgJ3R5cGVfTWFwcGluZ3MnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIlRvb2xfVHlwZSIgJiYgKG0uc291cmNlIHx8IG0uaW5TY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5pblNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmosIG9TY29wZSwgbWFwKSA9PiB7JHttLmluU2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20uaW5TY3JpcHR9KX1gKShvYmosIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnRhcmdldCkgewoJCQkJaWYgKG0udGFyZ2V0LmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmopID0+IHtyZXR1cm4gb2JqLiR7bS50YXJnZXR9O31gKShvYmopOwoJCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqW20udGFyZ2V0XSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0udGFyZ2V0LCBvYmopOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0uc291cmNlKSB7CgkJCQlpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXRoaXNbbS5zb3VyY2VdKHJldCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXNbbS5zb3VyY2VdID0gcmV0OwoJCQkJfQoJCQl9CgkJfSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuVG9vbF9UeXBlKSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlRvb2xfVHlwZSA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIlRvb2wgVHlwZSIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQkJdHlwZV9Ub29sczogKG9iaiwgdikgPT4gewoJCQkJCW9iai50eXBlX1Rvb2xzID0gdi5tYXAoX3YgPT4gcXVlcnkudHlwZV9Ub29scygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJCXR5cGVfTWFwcGluZ3M6IChvYmosIHYpID0+IHsKCQkJCQlvYmoudHlwZV9NYXBwaW5ncyA9IHYubWFwKF92ID0+IHF1ZXJ5LnR5cGVfTWFwcGluZ3MoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXR5cGVfVG9vbHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoudHlwZV9Ub29scyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQkJdHlwZV9NYXBwaW5nczogKG9iaiwgdikgPT4gewoJCQkJCW9iai50eXBlX01hcHBpbmdzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXR5cGVfVG9vbHM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy50eXBlX1Rvb2xzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCXR5cGVfTWFwcGluZ3M6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy50eXBlX01hcHBpbmdzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ107CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJdHlwZV9Ub29sczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3R5cGVfVG9vbF9UeXBlcycsIHVuZGVmaW5lZCkgOiAidHlwZV9Ub29scyIpKSA9PiB0aGlzLnR5cGVfVG9vbHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LlRvb2woKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJCXR5cGVfTWFwcGluZ3M6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0eXBlX1Rvb2xfVHlwZXMnLCB1bmRlZmluZWQpIDogInR5cGVfTWFwcGluZ3MiKSkgPT4gdGhpcy50eXBlX01hcHBpbmdzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5NYXBwaW5nKCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddID0gdiwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCXR5cGVfVG9vbHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0eXBlX1Rvb2xfVHlwZXMnLCB1bmRlZmluZWQpIDogInR5cGVfVG9vbHMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fdHlwZV9Ub29sc19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fdHlwZV9Ub29sc19jb29wOwoJCQkJfQoJCQl9LAoKCQkJdHlwZV9NYXBwaW5nczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3R5cGVfVG9vbF9UeXBlcycsIHVuZGVmaW5lZCkgOiAidHlwZV9NYXBwaW5ncyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl90eXBlX01hcHBpbmdzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl90eXBlX01hcHBpbmdzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuX25hbWU7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IHRydWU7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ub29sX1R5cGUuc3RvcmUnKTsgLy8gb3IgaW5zaWRlIGV4ZWN1dGU/CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJbGV0IGJVcGRhdGUgPSBmYWxzZTsKCQkJbGV0IGJJbnNlcnQgPSBmYWxzZTsKCgkJCWlmICghdGhpcy5fX3N5bmNfb24oKSkgewoJCQkJbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LlRvb2xfVHlwZShudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMubmFtZSh0aGlzLm5hbWUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl90eXBlX1Rvb2xzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMudHlwZV9Ub29scygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAodGhpcy5fdHlwZV9NYXBwaW5nc19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLnR5cGVfTWFwcGluZ3MoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuVG9vbF9UeXBlLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlRvb2xfVHlwZS51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlRvb2xfVHlwZS5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCk7CgkJCQlyZXQgPSByZXQuY29udGVudCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5Ub29sX1R5cGUobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoKCX0KCn07CgpzYWxlc25vdy5FdmVudCA9IGNsYXNzIEV2ZW50IGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUXNLaTVmYkc5aFpGUnZiMnh6TENvdVlYVjBhRU52WkdVc1JYWmxiblF1YkdsemRHVnVMRVYyWlc1MExuQnliMk5sYzNNc1JYWmxiblF1ZEhKcFoyZGxjaUo5YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUowY21sbloyVnlMblJwYldWdmRYUWlPakV3TURBd0xDSnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlBRWFYwYUZOaGJtUWlMQ0pIYVhSSWRXSWlYUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjbGFzc05hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NsYXNzTmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm1ldGhvZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbWV0aG9kKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicGF5bG9hZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcGF5bG9hZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNhcnJpZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NhcnJpZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJzZW5kZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3NlbmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlY2lwaWVudCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVjaXBpZW50KCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVzcG9uc2VUbyIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVzcG9uc2VUbygpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfcmVzcG9uc2VUb19FdmVudHMoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJFdmVudCIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJLy8gaWYodGhpcy5fY2Fycmllcl9zZXQgJiYgdGhpcy5fY2FycmllcikgdGhpcy5fY2Fycmllci5Ub29sID0gdG9vbDsKCgkJLy8gaWYodGhpcy5fc2VuZGVyX3NldCAmJiB0aGlzLl9zZW5kZXIpIHRoaXMuX3NlbmRlci5Ub29sID0gdG9vbDsKCgkJLy8gaWYodGhpcy5fcmVjaXBpZW50X3NldCAmJiB0aGlzLl9yZWNpcGllbnQpIHRoaXMuX3JlY2lwaWVudC5Ub29sID0gdG9vbDsKCgkJLy8gaWYodGhpcy5fcmVzcG9uc2VUb19zZXQgJiYgdGhpcy5fcmVzcG9uc2VUbykgdGhpcy5fcmVzcG9uc2VUby5Ub29sID0gdG9vbDsKCgkJLy8gKHRoaXMucmVzcG9uc2VUb19FdmVudHMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY2xhc3NOYW1lICoqLwoJY2xhc3NOYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY2xhc3NOYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY2xhc3NOYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jbGFzc05hbWUgIT0gdikgewoJCQkJdGhpcy5fY2xhc3NOYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jbGFzc05hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY2xhc3NOYW1lKTsKCQl9Cgl9CgoJY2xlYXJfY2xhc3NOYW1lKCkgewoJCXRoaXMuX2NsYXNzTmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX2NsYXNzTmFtZSA9IG51bGw7CgkJdGhpcy5fY2xhc3NOYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjbGFzc05hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBtZXRob2QgKiovCgltZXRob2QodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9tZXRob2RfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJtZXRob2QiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX21ldGhvZCAhPSB2KSB7CgkJCQl0aGlzLl9tZXRob2Rfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX21ldGhvZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9tZXRob2QpOwoJCX0KCX0KCgljbGVhcl9tZXRob2QoKSB7CgkJdGhpcy5fbWV0aG9kX3NldCA9IG51bGw7CgkJdGhpcy5fbWV0aG9kID0gbnVsbDsKCQl0aGlzLl9tZXRob2RfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG1ldGhvZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHBheWxvYWQgKiovCglwYXlsb2FkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcGF5bG9hZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInBheWxvYWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3BheWxvYWQgIT0gdikgewoJCQkJdGhpcy5fcGF5bG9hZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcGF5bG9hZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcGF5bG9hZCk7CgkJfQoJfQoKCWNsZWFyX3BheWxvYWQoKSB7CgkJdGhpcy5fcGF5bG9hZF9zZXQgPSBudWxsOwoJCXRoaXMuX3BheWxvYWQgPSBudWxsOwoJCXRoaXMuX3BheWxvYWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHBheWxvYWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjYXJyaWVyICoqLwoJY2Fycmllcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NhcnJpZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjYXJyaWVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnODgwZDlmNjQtYTAxZS00YTk2LTg1ZDMtN2NkMTIwYzg5YmJiJyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnTm9kZScpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjYXJyaWVyJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiODgwZDlmNjQtYTAxZS00YTk2LTg1ZDMtN2NkMTIwYzg5YmJiIiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIk5vZGUiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY2FycmllciAhPSB2KSB7CgkJCQl0aGlzLl9jYXJyaWVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnY2FycmllcicsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fY2FycmllciA/IHRoaXMuX2NhcnJpZXIuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX2NhcnJpZXJfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX2NhcnJpZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY2Fycmllcik7CgkJfQoJfQoKCWNsZWFyX2NhcnJpZXIoKSB7CgkJdGhpcy5fY2Fycmllcl9zZXQgPSBudWxsOwoJCXRoaXMuX2NhcnJpZXIgPSBudWxsOwoJCXRoaXMuX2NhcnJpZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNhcnJpZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBzZW5kZXIgKiovCglzZW5kZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9zZW5kZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJzZW5kZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc4ODBkOWY2NC1hMDFlLTRhOTYtODVkMy03Y2QxMjBjODliYmInICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdOb2RlJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NlbmRlcicsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjg4MGQ5ZjY0LWEwMWUtNGE5Ni04NWQzLTdjZDEyMGM4OWJiYiIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJOb2RlIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3NlbmRlciAhPSB2KSB7CgkJCQl0aGlzLl9zZW5kZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZW5kZXInLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX3NlbmRlciA/IHRoaXMuX3NlbmRlci5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fc2VuZGVyX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9zZW5kZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fc2VuZGVyKTsKCQl9Cgl9CgoJY2xlYXJfc2VuZGVyKCkgewoJCXRoaXMuX3NlbmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX3NlbmRlciA9IG51bGw7CgkJdGhpcy5fc2VuZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBzZW5kZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZWNpcGllbnQgKiovCglyZWNpcGllbnQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9yZWNpcGllbnRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZWNpcGllbnQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc4ODBkOWY2NC1hMDFlLTRhOTYtODVkMy03Y2QxMjBjODliYmInICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdOb2RlJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3JlY2lwaWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjg4MGQ5ZjY0LWEwMWUtNGE5Ni04NWQzLTdjZDEyMGM4OWJiYiIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJOb2RlIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3JlY2lwaWVudCAhPSB2KSB7CgkJCQl0aGlzLl9yZWNpcGllbnRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdyZWNpcGllbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX3JlY2lwaWVudCA/IHRoaXMuX3JlY2lwaWVudC5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fcmVjaXBpZW50X3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9yZWNpcGllbnQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcmVjaXBpZW50KTsKCQl9Cgl9CgoJY2xlYXJfcmVjaXBpZW50KCkgewoJCXRoaXMuX3JlY2lwaWVudF9zZXQgPSBudWxsOwoJCXRoaXMuX3JlY2lwaWVudCA9IG51bGw7CgkJdGhpcy5fcmVjaXBpZW50X2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZWNpcGllbnQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZXNwb25zZVRvICoqLwoJcmVzcG9uc2VUbyh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3Jlc3BvbnNlVG9fY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZXNwb25zZVRvIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnZGZlYjVjMjMtZjkwYi00YThkLTgzNDktMDBiZmNiMjQ2ZjYwJyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnRXZlbnQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAncmVzcG9uc2VUbycsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgImRmZWI1YzIzLWY5MGItNGE4ZC04MzQ5LTAwYmZjYjI0NmY2MCIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJFdmVudCIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZXNwb25zZVRvICE9IHYpIHsKCQkJCXRoaXMuX3Jlc3BvbnNlVG9fc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdyZXNwb25zZVRvJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9yZXNwb25zZVRvID8gdGhpcy5fcmVzcG9uc2VUby5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fcmVzcG9uc2VUb19zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fcmVzcG9uc2VUbyA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZXNwb25zZVRvKTsKCQl9Cgl9CgoJY2xlYXJfcmVzcG9uc2VUbygpIHsKCQl0aGlzLl9yZXNwb25zZVRvX3NldCA9IG51bGw7CgkJdGhpcy5fcmVzcG9uc2VUbyA9IG51bGw7CgkJdGhpcy5fcmVzcG9uc2VUb19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVzcG9uc2VUbyAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlc3BvbnNlVG9fRXZlbnRzICoqLwoJcmVzcG9uc2VUb19FdmVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICdkZmViNWMyMy1mOTBiLTRhOGQtODM0OS0wMGJmY2IyNDZmNjAnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0V2ZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9yZXNwb25zZVRvX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3Jlc3BvbnNlVG9fRXZlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJyZXNwb25zZVRvIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJFdmVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3Jlc3BvbnNlVG9fRXZlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJyZXNwb25zZVRvIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiRXZlbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YucmVzcG9uc2VUbyh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9yZXNwb25zZVRvX0V2ZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9yZXNwb25zZVRvX0V2ZW50c19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfcmVzcG9uc2VUb19FdmVudHMoKSB7CgkJdGhpcy5fcmVzcG9uc2VUb19FdmVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZXNwb25zZVRvX0V2ZW50cyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVzcG9uc2VUb19FdmVudHMgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9jbGFzc05hbWVfc2V0LAoKCQkJdGhpcy5fbWV0aG9kX3NldCwKCgkJCXRoaXMuX3BheWxvYWRfc2V0LAoKCQkJdGhpcy5fY2Fycmllcl9zZXQsCgoJCQl0aGlzLl9zZW5kZXJfc2V0LAoKCQkJdGhpcy5fcmVjaXBpZW50X3NldCwKCgkJCXRoaXMuX3Jlc3BvbnNlVG9fc2V0LAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJCXRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX2NsYXNzTmFtZV9zZXQgPSB0aGlzLl9jbGFzc05hbWVfc2V0OwoJCXJldC5fY2xhc3NOYW1lX2Nvb3AgPSB0aGlzLl9jbGFzc05hbWVfY29vcDsKCQlyZXQuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUoKSA/IHRoaXMuY2xhc3NOYW1lKCkgOiB0aGlzLmNsYXNzTmFtZSgpOwoKCQlyZXQuX21ldGhvZF9zZXQgPSB0aGlzLl9tZXRob2Rfc2V0OwoJCXJldC5fbWV0aG9kX2Nvb3AgPSB0aGlzLl9tZXRob2RfY29vcDsKCQlyZXQubWV0aG9kID0gdGhpcy5tZXRob2QoKSA/IHRoaXMubWV0aG9kKCkgOiB0aGlzLm1ldGhvZCgpOwoKCQlyZXQuX3BheWxvYWRfc2V0ID0gdGhpcy5fcGF5bG9hZF9zZXQ7CgkJcmV0Ll9wYXlsb2FkX2Nvb3AgPSB0aGlzLl9wYXlsb2FkX2Nvb3A7CgkJcmV0LnBheWxvYWQgPSB0aGlzLnBheWxvYWQoKSA/IHRoaXMucGF5bG9hZCgpIDogdGhpcy5wYXlsb2FkKCk7CgoJCXJldC5fY2Fycmllcl9zZXQgPSB0aGlzLl9jYXJyaWVyX3NldDsKCQlyZXQuX2NhcnJpZXJfY29vcCA9IHRoaXMuX2NhcnJpZXJfY29vcDsKCQlyZXQuY2FycmllciA9IHRoaXMuY2FycmllcigpID8gdGhpcy5jYXJyaWVyKCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMuY2FycmllcigpOwoKCQlyZXQuX3NlbmRlcl9zZXQgPSB0aGlzLl9zZW5kZXJfc2V0OwoJCXJldC5fc2VuZGVyX2Nvb3AgPSB0aGlzLl9zZW5kZXJfY29vcDsKCQlyZXQuc2VuZGVyID0gdGhpcy5zZW5kZXIoKSA/IHRoaXMuc2VuZGVyKCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMuc2VuZGVyKCk7CgoJCXJldC5fcmVjaXBpZW50X3NldCA9IHRoaXMuX3JlY2lwaWVudF9zZXQ7CgkJcmV0Ll9yZWNpcGllbnRfY29vcCA9IHRoaXMuX3JlY2lwaWVudF9jb29wOwoJCXJldC5yZWNpcGllbnQgPSB0aGlzLnJlY2lwaWVudCgpID8gdGhpcy5yZWNpcGllbnQoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5yZWNpcGllbnQoKTsKCgkJcmV0Ll9yZXNwb25zZVRvX3NldCA9IHRoaXMuX3Jlc3BvbnNlVG9fc2V0OwoJCXJldC5fcmVzcG9uc2VUb19jb29wID0gdGhpcy5fcmVzcG9uc2VUb19jb29wOwoJCXJldC5yZXNwb25zZVRvID0gdGhpcy5yZXNwb25zZVRvKCkgPyB0aGlzLnJlc3BvbnNlVG8oKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5yZXNwb25zZVRvKCk7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5yZXNwb25zZVRvX0V2ZW50cyA9IHRoaXMucmVzcG9uc2VUb19FdmVudHMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImNsYXNzTmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbGFzc05hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJtZXRob2QiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbWV0aG9kJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkicGF5bG9hZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwYXlsb2FkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY2FycmllciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYXJyaWVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkic2VuZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3NlbmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJInJlY2lwaWVudCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZWNpcGllbnQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJyZXNwb25zZVRvIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Jlc3BvbnNlVG8nLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQlyZXNwb25zZVRvX0V2ZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Jlc3BvbnNlVG9fRXZlbnRzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX3RvSGFzaCIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMuTm9Db2RlID8gb0hhc2ggOiB0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7Cgl9CgoJYXN5bmMgX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOwoKCX0KCglfcWxTZWxlY3Rpb25zKHNTZXQpIHsKCQlsZXQgcmV0ID0gW107CgkJaWYgKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7CgoJCXNTZXQuc2VsZWN0aW9ucy5maWx0ZXIocyA9PiBzLnNlbGVjdGlvblNldCkuZm9yRWFjaChzID0+IHsKCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gImNhcnJpZXIiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIGNhcnJpZXInLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5jYXJyaWVyX0V2ZW50cyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInNlbmRlciIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3Igc2VuZGVyJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Ob2RlKCkuc2VuZGVyX0V2ZW50cyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInJlY2lwaWVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgcmVjaXBpZW50Jywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Ob2RlKCkucmVjaXBpZW50X0V2ZW50cyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInJlc3BvbnNlVG8iKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIHJlc3BvbnNlVG8nLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93LkV2ZW50KCkucmVzcG9uc2VUb19FdmVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCAmJiBldmVudC5jbGFzc05hbWUoKSAmJiBldmVudC5jbGFzc05hbWUoKSAhPSAnRXZlbnQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiRGVsZWdhdGluZyBpbnZva2F0aW9uIHRvICIgKyBldmVudC5jbGFzc05hbWUoKSk7CgkJCQlyZXR1cm4gbmV3IHNhbGVzbm93W2V2ZW50LmNsYXNzTmFtZSgpXSgpLl9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpOwoJCQl9CgoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQlkYXRhLl9fdGhpcyA9IGRhdGEuX190aGlzIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkJc3dpdGNoIChtZXRob2QpIHsKCgkJCQljYXNlICJsaXN0ZW4iOiB7CgoJCQkJCWRhdGEubm9kZSA9IGRhdGEubm9kZSA/IGRhdGEubm9kZQoKCQkJCQkJLl90b0RvY3VtZW50KCkKCgkJCQkJCToKCQkJCQkJdW5kZWZpbmVkOwoKCQkJCQlicmVhazsKCQkJCX0KCgkJCQljYXNlICJ0cmlnZ2VyIjogewoKCQkJCQlicmVhazsKCQkJCX0KCgkJCQljYXNlICJwcm9jZXNzIjogewoKCQkJCQlicmVhazsKCQkJCX0KCgkJCX0KCQl9CgoJCWlmICghbiB8fCBzYWxlc25vdy5fbm9kZS5fc2FtZU5vZGUobikpIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkNhbGxiYWNrIik7CgkJCXJldCA9IGF3YWl0IHRoaXMuX2ludm9rZShtZXRob2QsIGRhdGEpOwoJCX0gZWxzZSBpZiAobi5hZGRyZXNzKCkgJiYgbi5fc2FtZU5vZGUobikgLyphY3R1YWwgbm9kZSovICkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBuLl9hZGRyZXNzLCBuLl9wb3J0LCBtZXRob2QpOwoJCQl0cnkgewoJCQkJbGV0IGNvbmZpZyA9IHsKCQkJCQloZWFkZXJzOiB7fSwKCQkJCX07CgkJCQlpZiAoc2FsZXNub3cuX190b2tlbikgY29uZmlnLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGAke3NhbGVzbm93Ll9fdG9rZW4udG9rZW5fdHlwZX0gJHtzYWxlc25vdy5fX3Rva2VuLmFjY2Vzc190b2tlbn1gOwoJCQkJcmV0ID0gYXdhaXQgYXhpb3MucG9zdChgaHR0cCR7bi5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHtuLmFkZHJlc3MoKX06JHtuLnBvcnQoKSB8fCAzMDAwfS9tZXRob2QvRXZlbnQvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAibGlzdGVuIjogewoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJ0cmlnZ2VyIjogewoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJwcm9jZXNzIjogewoKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LkV2ZW50KG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5FdmVudChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuRXZlbnQobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuRXZlbnQoKS5faW52b2tlTm9kZSh0biwgbWV0aG9kLCBfcGFyYW1zKTsKCQl9CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImxpc3RlbiI6IHsKCgkJCQlfcGFyYW1zLm5vZGUgPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5ub2RlKS5fZGVSZWZlcmVuY2UoKTsKCgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm5vZGUpOwoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJ0cmlnZ2VyIjogewoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJwcm9jZXNzIjogewoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBFdmVudC5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYEV2ZW50Ll9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLkV2ZW50Ll90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93LkV2ZW50LicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlIHx8ICJFdmVudCIpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQlpZiAodGhpcy5fY2Fycmllcl9zZXQgJiYgdGhpcy5jYXJyaWVyKCkpIHRoaXMuY2FycmllcigpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl9zZW5kZXJfc2V0ICYmIHRoaXMuc2VuZGVyKCkpIHRoaXMuc2VuZGVyKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX3JlY2lwaWVudF9zZXQgJiYgdGhpcy5yZWNpcGllbnQoKSkgdGhpcy5yZWNpcGllbnQoKS5fX3N5bmNfb24oZCk7CgoJCQlpZiAodGhpcy5fcmVzcG9uc2VUb19zZXQgJiYgdGhpcy5yZXNwb25zZVRvKCkpIHRoaXMucmVzcG9uc2VUbygpLl9fc3luY19vbihkKTsKCgkJCS8vIHRoaXMucmVzcG9uc2VUb19FdmVudHMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5FdmVudCh0aGlzLklkKQoKCQkJLmNsYXNzTmFtZSh0aGlzLmNsYXNzTmFtZSgpLCB0aGlzLl9jbGFzc05hbWVfY29vcCkKCgkJCS5tZXRob2QodGhpcy5tZXRob2QoKSwgdGhpcy5fbWV0aG9kX2Nvb3ApCgoJCQkucGF5bG9hZCh0aGlzLnBheWxvYWQoKSwgdGhpcy5fcGF5bG9hZF9jb29wKQoKCQkJLmNhcnJpZXIodGhpcy5jYXJyaWVyKCksIHRoaXMuX2NhcnJpZXJfY29vcCkKCgkJCS5zZW5kZXIodGhpcy5zZW5kZXIoKSwgdGhpcy5fc2VuZGVyX2Nvb3ApCgoJCQkucmVjaXBpZW50KHRoaXMucmVjaXBpZW50KCksIHRoaXMuX3JlY2lwaWVudF9jb29wKQoKCQkJLnJlc3BvbnNlVG8odGhpcy5yZXNwb25zZVRvKCksIHRoaXMuX3Jlc3BvbnNlVG9fY29vcCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkucmVzcG9uc2VUb19FdmVudHModGhpcy5yZXNwb25zZVRvX0V2ZW50cygpLCB0aGlzLl9yZXNwb25zZVRvX0V2ZW50c19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCW9ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdFdmVudCc7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIkV2ZW50IjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCQkJCXJldCA9IHJldC50b0xvd2VyQ2FzZSgpOwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCQl0cnkgewoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgPyAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gb3B0aW9ucy50b29sIHx8IHQgPT0gb3B0aW9ucy50b29sKSA6IHRoaXMuVG9vbDsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sIHx8IHt9OwoKCQkJbGV0IG5JRCA9IHNhbGVzbm93Ll9ub2RlID8gc2FsZXNub3cuX25vZGUuY29kZSgpIDogImRlZmF1bHQiOwoKCQkJbGV0IHJldCA9IG51bGxWYWx1ZTsKCQkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0ID0gbnVsbDsKCgkJCS8vIHRvb2xfQ29uZmlnczogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBkb25lCgkJCWxldCB0Y29uZiA9IChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiBjLm5vZGUgJiYgYy5ub2RlLmNvZGUgPT0gbklEKS5jb25jYXQoKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmICFjLm5vZGUpKTsKCQkJaWYgKHRjb25mLmxlbmd0aCkgewoJCQkJcmV0ID0gdGNvbmZbMF0udmFsdWU7CgkJCQl0cnkgewoJCQkJCVsxLCAyLCAzXS5mb3JFYWNoKGEgPT4gcmV0ID0gSlNPTi5wYXJzZShyZXQpKTsKCQkJCX0gY2F0Y2ggKGpleCkge30KCQkJfQoKCQkJLy8gbW9kZWwgQ29uZmlnOiBDb25maWcgaXMgY2xhc3MgbGV2ZWwsIG5vZGUgbm90IHBvc3NpYmxlIC0gcGVuZGluZwoJCQlsZXQgbWNvbmYgPSB0aGlzLkNvbmZpZyA/IHRoaXMuQ29uZmlnW25dIDogdW5kZWZpbmVkOwoJCQlpZiAodHlwZW9mKG1jb25mKSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IG1jb25mOwoKCQkJLy8gY29tbWFuZCBsaW5lOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiBnbG9iYWwubWluaW1pc3QpIHsKCQkJCXJldCA9IGdsb2JhbC5taW5pbWlzdChwcm9jZXNzLmFyZ3Yuc2xpY2UoMikpW25dIHx8IHJldDsKCQkJfQoKCQkJLy8gcmVxdWVzdDogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCXJldCA9IHRoaXMuJF9SRVFVRVNUKG4pIHx8IHJldDsKCgkJCWlmIChvcHRpb25zLm5ld1ZhbHVlKSB7CgkJCQlsZXQgdGMgPSB0Y29uZi5sZW5ndGggPyB0Y29uZlswXSA6IHt9OwoJCQkJdGMubm9kZSA9IHsKCQkJCQljb2RlOiBvcHRpb25zLm5vZGUuY29kZSgpCgkJCQl9OwoJCQkJdGMudmFsdWUgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQkJdGMubmFtZSA9IG47CgkJCQlpZiAoIXRjb25mLmxlbmd0aCkgewoJCQkJCW9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MucHVzaCh0Yyk7CgkJCQl9CgkJCQlyZXQgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQl9CgoJCQkvLyBjb25maWcgcmVwbGFjZW1lbnQKCQkJaWYgKHR5cGVvZihyZXQpID09PSAnc3RyaW5nJykocmV0Lm1hdGNoKG5ldyBSZWdFeHAoYHt7KFtefV0rKX19YCwgImciKSkgfHwgW10pLmZvckVhY2gobSA9PiByZXQgPSByZXQucmVwbGFjZShtLCB0aGlzLl9fY29uZmlnKG0ucmVwbGFjZSgne3snLCAnJykucmVwbGFjZSgnfX0nLCAnJyksIG51bGwsIG9wdGlvbnMpKSk7CgoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fY29uZmlnJywgJ0VudGl0eU9iamVjdCcsIDEsIG4sIG51bGxWYWx1ZSwgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncywgZXgpOwoJCX0KCX0KCgkvKioKCSAqIFN1bW1hcnkuIGxpc3Rlbi4KCSAqCgkgKiBEZXNjcmlwdGlvbi4gLgoJICoKCSAqIEBzaW5jZSAgICAgIHgueC54CgkgKiBAZGVwcmVjYXRlZCB4LngueCBVc2UgbmV3X2Z1bmN0aW9uX25hbWUoKSBpbnN0ZWFkLgoJICogQGFjY2VzcyAgICAgcHVibGljCgkgKgoJICogQGNsYXNzCgkgKiBAYXVnbWVudHMgcGFyZW50CgkgKiBAbWl4ZXMgICAgbWl4aW4KCSAqCgkgKiBAYWxpYXMgICAgcmVhbE5hbWUKCSAqIEBtZW1iZXJvZiBuYW1lc3BhY2UKCSAqCgkgKiBAc2VlICBGdW5jdGlvbi9jbGFzcyByZWxpZWQgb24KCSAqIEBsaW5rIFVSTAoJICogQGdsb2JhbAoJICoKCSAqIEBmaXJlcyAgIGV2ZW50TmFtZQoJICogQGZpcmVzICAgY2xhc3NOYW1lI2V2ZW50TmFtZQoJICogQGxpc3RlbnMgZXZlbnQ6ZXZlbnROYW1lCgkgKiBAbGlzdGVucyBjbGFzc05hbWV+ZXZlbnQ6ZXZlbnROYW1lCgkgKiBAcGFyYW0ge3R5cGV9ICAgdmFyICAgICAgICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyXSAgICAgICAgIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXI9ZGVmYXVsdF0gRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUgd2l0aCBkZWZhdWx0IHZhcmlhYmxlLgoJICogQHBhcmFtIHtPYmplY3R9IG9iamVjdFZhciAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgb2JqZWN0VmFyLmtleSBEZXNjcmlwdGlvbiBvZiBhIGtleSBpbiB0aGUgb2JqZWN0VmFyIHBhcmFtZXRlci4KCSAqCgkgKiBAeWllbGQge3R5cGV9IFlpZWxkZWQgdmFsdWUgZGVzY3JpcHRpb24uCgkgKgoJICogQHJldHVybiB7dHlwZX0gUmV0dXJuIHZhbHVlIGRlc2NyaXB0aW9uLgoJICovCglhc3luYyBsaXN0ZW4obm9kZSkgewoKCQlsZXQgYW5zd2VyID0gbnVsbDsKCgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAibGlzdGVuIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImxpc3RlbiIsIF9ub2RlLCBub2RlKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJsaXN0ZW4iLCBub2RlKSA9PiB7CgoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuRXZlbnQubGlzdGVuJyk7CgoJCQl2YXIgZXJyb3JzID0gewoKCQkJCSJub2RlIjogKChub2RlKSA9PiB7CgoJCQkJCWxldCBhbnN3ZXIgPQoKCQkJCQkJKCFub2RlICYmIGZhbHNlKSB8fCAobm9kZSAmJiAobm9kZS5jb25zdHJ1Y3Rvci5uYW1lICE9ICdOb2RlJyB8fCBub2RlLkVudGl0eUNsYXNzLk5hbWUgIT0gJ05vZGUnKSkKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdsaXN0ZW4nLCAnRW50aXR5T2JqZWN0JywgMCwgImFuc3dlciIsICJub2RlIiwgYW5zd2VyKTsKCQkJCQlyZXR1cm4gYW5zd2VyOwoJCQkJfSkobm9kZSkgPyAoJ25vZGUgaXMgbm90IG9mIHR5cGUgTm9kZScgfHwgJ1ZhbGlkYXRpb24gRXJyb3InKSA6ICcnLAoKCQkJCSIwMSI6ICgobm9kZSkgPT4gewoKCQkJCQlsZXQgYW5zd2VyID0KCgkJCQkJCXR5cGVvZihub2RlKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKG9TY29wZS5fbm9kZSkgPT09ICd1bmRlZmluZWQnCgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnbGlzdGVuJywgJ0VudGl0eU9iamVjdCcsIDAsICJhbnN3ZXIiLCAiMDEiLCBhbnN3ZXIpOwoJCQkJCXJldHVybiBhbnN3ZXI7CgkJCQl9KShub2RlKSA/ICgnb1Njb3BlLl9ub2RlIG5vdCBkZWZpbmVkJyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQkJIi0wMiI6ICgobm9kZSkgPT4gewoKCQkJCQlsZXQgYW5zd2VyID0KCgkJCQkJCXR5cGVvZihvU2NvcGUuX19icm9rZXIpICE9PSAndW5kZWZpbmVkJwoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ2xpc3RlbicsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgIi0wMiIsIGFuc3dlcik7CgkJCQkJcmV0dXJuIGFuc3dlcjsKCQkJCX0pKG5vZGUpID8gKCdvU2NvcGUuX19icm9rZXIgYWxyZWFkeSBkZWZpbmVkJyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2xpc3RlbicsICdFbnRpdHlPYmplY3QnLCAwLCB7CgkJCQkJCVtrXTogZXJyb3JzW2tdCgkJCQkJfSk7CgkJCQkJZGVsZXRlIGVycm9yc1trXTsKCQkJCX0pOwoJCQkJaWYgKE9iamVjdC52YWx1ZXMoZXJyb3JzKS5sZW5ndGgpIHsKCQkJCQlyZXR1cm4gewoJCQkJCQlfX2V4Y2VwdGlvbjogZXJyb3JzLAoJCQkJCX07CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJCW5vZGUgPSBub2RlIHx8IG9TY29wZS5fbm9kZTsKCgkJCWlmICh0eXBlb2YobXF0dCkgIT09ICd1bmRlZmluZWQnICYmIG5vZGUuX19jb25maWcoJ21xdHQuc2VydmVyJykpIHsKCQkJCWxvZyhgRXN0YWJsaXNoaW5nIGNvbm5lY3Rpb24gd2l0aCBNUVRUIHNlcnZlciBAJHtub2RlLmNvZGUoKX0gJHtub2RlLl9fY29uZmlnKCdtcXR0LnNlcnZlcicpfToke25vZGUuX19jb25maWcoJ21xdHQucG9ydCcpfHw4MDgwfWApOwoJCQkJb1Njb3BlLl9fYnJva2VyID0gbXF0dC5jb25uZWN0KGB3czovLyR7bm9kZS5fX2NvbmZpZygnbXF0dC5zZXJ2ZXInKX06JHtub2RlLl9fY29uZmlnKCdtcXR0LnBvcnQnKXx8ODA4MH0vbXF0dGAsIHsKCQkJCQkvLyBDbGVhbiBzZXNzaW9uCgkJCQkJY2xlYW46IHR5cGVvZihub2RlLl9fY29uZmlnKCdtcXR0LmNsZWFuJykpICE9PSAndW5kZWZpbmVkJyA/IG5vZGUuX19jb25maWcoJ21xdHQuY2xlYW4nKSA6IHRydWUsCgkJCQkJY29ubmVjdFRpbWVvdXQ6IG5vZGUuX19jb25maWcoJ21xdHQuY29ubmVjdFRpbWVvdXQnKSB8fCA0MDAwLAoJCQkJCS8vIEF1dGhlbnRpY2F0aW9uCgkJCQkJY2xpZW50SWQ6IG5vZGUuX19jb25maWcoJ21xdHQuY2xpZW50SWQnKSB8fCBub2RlLmNvZGUoKSwKCQkJCQkvL3JlY29ubmVjdFBlcmlvZDogbm9kZS5fX2NvbmZpZygnbXF0dC51c2VybmFtZScpLAoJCQkJCXVzZXJuYW1lOiBub2RlLl9fY29uZmlnKCdtcXR0LnVzZXJuYW1lJyksCgkJCQkJcGFzc3dvcmQ6IG5vZGUuX19jb25maWcoJ21xdHQucGFzc3dvcmQnKSwKCQkJCX0pOwoJCQkJb1Njb3BlLl9fYnJva2VyLm9uKCdjb25uZWN0JywgKCkgPT4gb1Njb3BlLl9fYnJva2VyLnN1YnNjcmliZSh0aGlzLlNjb3BlKSk7CgkJCQlvU2NvcGUuX19icm9rZXIuc3RyZWFtLm9uKCdlcnJvcicsIGVyID0+IG9TY29wZS5fX2Jyb2tlci5lbmQoKSk7CgkJCQlvU2NvcGUuX19icm9rZXIub24oJ21lc3NhZ2UnLCAodG9waWMsIG1lc3NhZ2UpID0+IHsKCQkJCQlsZXQgbXNnID0gSlNPTi5wYXJzZShtZXNzYWdlLnRvU3RyaW5nKCkpOwoJCQkJCS8vbG9nKCJNUVRUIE1lc3NhZ2UiLCBtc2cpOwoJCQkJCW5ldyBvU2NvcGUuRXZlbnQoKS5fZnJvbURvY3VtZW50KG1zZykuX2RlUmVmZXJlbmNlKCkucHJvY2VzcygpOwoJCQkJfSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mKGdsb2JhbCkgPT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZihpbykgIT09ICJ1bmRlZmluZWQiICYmIG5vZGUucGFyZW50KCkuYWRkcmVzcygpKSB7CgkJCQlsb2coYEVzdGFibGlzaGluZyBTb2NrZXQuSU8gd2l0aCBuZXcgUGFyZW50ICR7bm9kZS5fcGFyZW50Ll9hZGRyZXNzfToke25vZGUuX3BhcmVudC5fcG9ydHx8MzAwMH1gKTsKCQkJCW9TY29wZS5fX2Jyb2tlciA9IGlvKGAke25vZGUuX3BhcmVudC5fYWRkcmVzc306JHtub2RlLl9wYXJlbnQuX3BvcnR8fDMwMDB9YCwgewoJCQkJCXRyYW5zcG9ydHM6IFsnd2Vic29ja2V0J10sCgkJCQkJcmVjb25uZWN0aW9uOiBmYWxzZSwKCQkJCQlxdWVyeTogYF9ub2RlPSR7bm9kZS5fY29kZX0mX2RhdGU9JHtzci5zZXJ2ZXJEYXRlKCkudG9VVENTdHJpbmcoKX1gCgkJCQl9KTsKCQkJCW9TY29wZS5fX2Jyb2tlci5vbih0aGlzLm5hbWUoKSwgZSA9PiBuZXcgb1Njb3BlLkV2ZW50KCkuX2Zyb21Eb2N1bWVudChlKS5fZGVSZWZlcmVuY2UoKS5wcm9jZXNzKCkpOwoJCQkJb1Njb3BlLl9fYnJva2VyLm9uKCJkaXNjb25uZWN0IiwgcmVhc29uID0+IHsKCQkJCQlsb2coIkRpc2Nvbm5lY3RlZCB3aXRoIHJlYXNvbjogIiArIHJlYXNvbik7CgkJCQl9KTsKCQkJfSBlbHNlIGlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHNvY2tldGlvKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCW9TY29wZS5fX2Jyb2tlciA9IG5ldyBzb2NrZXRpby5TZXJ2ZXIoZ2xvYmFsLmV4U2VydmVyKTsKCgkJCQlvU2NvcGUuZXZlbnRFbWl0dGVyID0gbmV3IGV2ZW50cy5FdmVudEVtaXR0ZXIoKTsKCgkJCQlsb2coIlN0YXJ0aW5nIFNvY2tldElPIHNlcnZlciIpOwoJCQkJb1Njb3BlLl9fYnJva2VyLm9uKCdjb25uZWN0aW9uJywgc29ja2V0ID0+IHsKCQkJCQlsZXQgcGFyYW0gPSBzb2NrZXQuaGFuZHNoYWtlLnF1ZXJ5OwoJCQkJCWlmICghcGFyYW0uX25vZGUgfHwgIXBhcmFtLl9kYXRlKSByZXR1cm47CgoJCQkJCW9TY29wZS5fX3NvY2tldHMgPSBvU2NvcGUuX19zb2NrZXRzIHx8IHt9OwoJCQkJCW9TY29wZS5fX3NvY2tldHNbc29ja2V0LmhhbmRzaGFrZS5xdWVyeS5fbm9kZV0gPSBzb2NrZXQ7CgkJCQkJT2JqZWN0LmtleXMob1Njb3BlLl9fc29ja2V0cykuZm9yRWFjaChuID0+IHsKCQkJCQkJaWYgKCFvU2NvcGUuX19zb2NrZXRzW25dLmNvbm5lY3RlZCkgZGVsZXRlIG9TY29wZS5fX3NvY2tldHNbbl07CgkJCQkJfSk7CgkJCQkJbG9nKCdTb2NrZXRzIGNvbm5lY3RlZCBbJyArIE9iamVjdC5rZXlzKG9TY29wZS5fX3NvY2tldHMpLmxlbmd0aCArICddLCBMYXN0ZXN0OiAnICsgc29ja2V0LmhhbmRzaGFrZS5xdWVyeS5fbm9kZSArICcoJyArIHNvY2tldC5pZCArICcpJyk7CgkJCQkJb1Njb3BlLl9fc29ja2V0c1tzb2NrZXQuaGFuZHNoYWtlLnF1ZXJ5Ll9ub2RlXS5vbih0aGlzLm5hbWUoKSwgZSA9PiBuZXcgb1Njb3BlLkV2ZW50KCkuX2Zyb21Eb2N1bWVudChlKS5fZGVSZWZlcmVuY2UoKS5wcm9jZXNzKCkpOwoJCQkJfSwgewoJCQkJCWNvcnM6IHsKCQkJCQkJb3JpZ2luOiAiKiIsCgkJCQkJCW1ldGhvZHM6IFsiR0VUIiwgIlBPU1QiXSwKCQkJCQl9CgkJCQl9KTsKCQkJfSBlbHNlIGlmICh0eXBlb2YoQnJvYWRjYXN0Q2hhbm5lbCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQlsb2coIlN0YXJ0aW5nIEJyb2FkY2FzdENoYW5uZWwgLSAiICsgdGhpcy5TY29wZSk7CgkJCQlvU2NvcGUuX19icm9rZXIgPSBuZXcgQnJvYWRjYXN0Q2hhbm5lbCh0aGlzLlNjb3BlKTsKCQkJCW9TY29wZS5fX2Jyb2tlci5vbm1lc3NhZ2UgPSBlID0+IG5ldyBvU2NvcGUuRXZlbnQoKS5fZnJvbURvY3VtZW50KGUuZGF0YSkuX2RlUmVmZXJlbmNlKCkucHJvY2VzcygpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihuYXZpZ2F0b3Iuc2VydmljZVdvcmtlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQlsb2coIldvcmtlciBFdmVudCBQcm9jZXNzaW5nIik7CgkJCQlvU2NvcGUuX19icm9rZXIgPSBuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5jb250cm9sbGVyOwoJCQkJYWRkRXZlbnRMaXN0ZW5lcih0aGlzLm5hbWUoKSwgZSA9PiBuZXcgb1Njb3BlLkV2ZW50KCkuX2Zyb21Eb2N1bWVudChlKS5fZGVSZWZlcmVuY2UoKS5wcm9jZXNzKCkpOwoJCQl9IGVsc2UgewoJCQkJbG9nKCJObyBFdmVudCBCcmlkZ2UgYXZhaWxhYmxlIiwgdGhpcy5Ub29sLm5hbWUpOwoJCQl9CgoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10sCgkJCW5vZGU6IG5vZGUKCQl9KTsKCgkJLy8gdGFrZSBvdXQgdGhlIGludmFsaWQgbm9kZSByZXN1bHRzCgkJcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gciAmJiByLnJldCk7CgoJCS8vIGhhcyBhbnkgbm9kZSBnZW5lcmF0ZWQgYSB2YWxpZGF0aW9uIGV4Y2VwdGlvbj8KCQlsZXQgX19leCA9IHJlc3VsdHMuZmluZChyID0+IHIucmV0Ll9fZXhjZXB0aW9uKTsKCQlpZiAoX19leCkgcmV0dXJuIF9fZXgucmV0OwoKCQlyZXR1cm4gcmVzdWx0cy5sZW5ndGggPyByZXN1bHRzWzBdLnJldCA6IG51bGw7CgoJfQoKCS8qKgoJICogU3VtbWFyeS4gdHJpZ2dlci4KCSAqCgkgKiBEZXNjcmlwdGlvbi4gLgoJICoKCSAqIEBzaW5jZSAgICAgIHgueC54CgkgKiBAZGVwcmVjYXRlZCB4LngueCBVc2UgbmV3X2Z1bmN0aW9uX25hbWUoKSBpbnN0ZWFkLgoJICogQGFjY2VzcyAgICAgcHVibGljCgkgKgoJICogQGNsYXNzCgkgKiBAYXVnbWVudHMgcGFyZW50CgkgKiBAbWl4ZXMgICAgbWl4aW4KCSAqCgkgKiBAYWxpYXMgICAgcmVhbE5hbWUKCSAqIEBtZW1iZXJvZiBuYW1lc3BhY2UKCSAqCgkgKiBAc2VlICBGdW5jdGlvbi9jbGFzcyByZWxpZWQgb24KCSAqIEBsaW5rIFVSTAoJICogQGdsb2JhbAoJICoKCSAqIEBmaXJlcyAgIGV2ZW50TmFtZQoJICogQGZpcmVzICAgY2xhc3NOYW1lI2V2ZW50TmFtZQoJICogQGxpc3RlbnMgZXZlbnQ6ZXZlbnROYW1lCgkgKiBAbGlzdGVucyBjbGFzc05hbWV+ZXZlbnQ6ZXZlbnROYW1lCgkgKiBAcGFyYW0ge3R5cGV9ICAgdmFyICAgICAgICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyXSAgICAgICAgIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXI9ZGVmYXVsdF0gRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUgd2l0aCBkZWZhdWx0IHZhcmlhYmxlLgoJICogQHBhcmFtIHtPYmplY3R9IG9iamVjdFZhciAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgb2JqZWN0VmFyLmtleSBEZXNjcmlwdGlvbiBvZiBhIGtleSBpbiB0aGUgb2JqZWN0VmFyIHBhcmFtZXRlci4KCSAqCgkgKiBAeWllbGQge3R5cGV9IFlpZWxkZWQgdmFsdWUgZGVzY3JpcHRpb24uCgkgKgoJICogQHJldHVybiB7dHlwZX0gUmV0dXJuIHZhbHVlIGRlc2NyaXB0aW9uLgoJICovCglhc3luYyB0cmlnZ2VyKCkgewoKCQlsZXQgYW5zd2VyID0gbnVsbDsKCgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidHJpZ2dlciIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ0cmlnZ2VyIiwgX25vZGUsICkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidHJpZ2dlciIsICkgPT4gewoKCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkV2ZW50LnRyaWdnZXInKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQkJIjAxIjogKCgpID0+IHsKCgkJCQkJbGV0IGFuc3dlciA9CgoJCQkJCQkhdGhpcy5fc2VuZGVyX3NldCB8fCAhdGhpcy5zZW5kZXIoKQoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ3RyaWdnZXInLCAnRW50aXR5T2JqZWN0JywgMCwgImFuc3dlciIsICIwMSIsIGFuc3dlcik7CgkJCQkJcmV0dXJuIGFuc3dlcjsKCQkJCX0pKCkgPyAoJ05vIFNlbmRlcicgfHwgJ1ZhbGlkYXRpb24gRXJyb3InKSA6ICcnLAoKCQkJCSIwMiI6ICgoKSA9PiB7CgoJCQkJCWxldCBhbnN3ZXIgPQoKCQkJCQkJIXRoaXMuX3JlY2lwaWVudF9zZXQgfHwgIXRoaXMucmVjaXBpZW50KCkKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICd0cmlnZ2VyJywgJ0VudGl0eU9iamVjdCcsIDAsICJhbnN3ZXIiLCAiMDIiLCBhbnN3ZXIpOwoJCQkJCXJldHVybiBhbnN3ZXI7CgkJCQl9KSgpID8gKCdObyBwcm9jZXNzaW5nIG9mIEV2ZW50cyB3aXRob3V0IHJlY2lwaWVudCcgfHwgJ1ZhbGlkYXRpb24gRXJyb3InKSA6ICcnLAoKCQkJfTsKCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiAhZXJyb3JzW2tdKS5mb3JFYWNoKGsgPT4gZGVsZXRlIGVycm9yc1trXSk7CgkJCWlmIChPYmplY3Qua2V5cyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJy0nKSkuZm9yRWFjaChrID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0cmlnZ2VyJywgJ0VudGl0eU9iamVjdCcsIDAsIHsKCQkJCQkJW2tdOiBlcnJvcnNba10KCQkJCQl9KTsKCQkJCQlkZWxldGUgZXJyb3JzW2tdOwoJCQkJfSk7CgkJCQlpZiAoT2JqZWN0LnZhbHVlcyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJCXJldHVybiB7CgkJCQkJCV9fZXhjZXB0aW9uOiBlcnJvcnMsCgkJCQkJfTsKCQkJCX0KCQkJCXJldHVybjsKCQkJfQoKCQkJbGV0IHBheWxvYWQgPSBudWxsOwoKCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAidW5kZWZpbmVkIiAmJiBvU2NvcGUuX19zb2NrZXRzKSB7CgkJCQlpZiAob1Njb3BlLl9fc29ja2V0c1t0aGlzLnJlY2lwaWVudCgpLmNvZGUoKV0pIHsKCQkJCQlvU2NvcGUuX19zb2NrZXRzW3RoaXMucmVjaXBpZW50KCkuY29kZSgpXS5lbWl0KHRoaXMubmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQkJfSBlbHNlIHsKCQkJCQl3YXJuKCJVbmtub3duIG5vZGUgaW4gc29ja2V0cyBsaXN0ICIgKyB0aGlzLnJlY2lwaWVudCgpLl9jb2RlKTsKCQkJCX0KCQkJfSBlbHNlIGlmIChvU2NvcGUuX19icm9rZXIpIHsKCQkJCS8vbG9nKEpTT04uc3RyaW5naWZ5KGRvYywgbnVsbCwgNCkpCgkJCQlpZiAob1Njb3BlLl9fYnJva2VyLmVtaXQpIG9TY29wZS5fX2Jyb2tlci5lbWl0KHRoaXMubmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQkJaWYgKG9TY29wZS5fX2Jyb2tlci5wb3N0TWVzc2FnZSkgb1Njb3BlLl9fYnJva2VyLnBvc3RNZXNzYWdlKEpTT04uc3RyaW5naWZ5KHRoaXMuX3RvRG9jdW1lbnQoKSkpOwoJCQkJaWYgKG9TY29wZS5fX2Jyb2tlci5wdWJsaXNoKSBvU2NvcGUuX19icm9rZXIucHVibGlzaCh0aGlzLlNjb3BlLCBKU09OLnN0cmluZ2lmeSh0aGlzLl90b0RvY3VtZW50KCkpLCB7CgkJCQkJcW9zOiAwLAoJCQkJCXJldGFpbjogZmFsc2UKCQkJCX0sIGVyciA9PiBlcnIgPyBlcnJvcihlcnIpIDogbnVsbCk7CgkJCX0gZWxzZSB7CgkJCQlhd2FpdCB0aGlzLmNhcnJpZXIob1Njb3BlLl9ub2RlKS5zdG9yZSgpOwoJCQkJbG9nKCJDYW5ub3QgdHJpZ2dlciBkaXJlY3RseSwgaW5zZXJ0ZWQgdG8gVG9vbDogIiArIHRoaXMuVG9vbC50eXBlLm5hbWUgKyAiLyIgKyB0aGlzLmNvZGUoKSk7CgoJCQkJLy8gd2FpdCB1bnRpbCB0aGUgZXZlbnQgaXMgcHJvY2Vzc2VkIHdpdGggYW5vdGhlciBldmVudAoJCQkJaWYgKCF0aGlzLnJlc3BvbnNlVG8oKSkgYXdhaXQgdGhpcy5zZXRJbnRlcnZhbChhc3luYyAoIC8qcmVzcG9uc2UgcG9sbGluZyovICkgPT4gewoJCQkJCWlmICghb1Njb3BlLl9ub2RlKSByZXR1cm47CgoJCQkJCWxvZygiUG9sbGluZyAiICsgdGhpcy5Ub29sLnR5cGUubmFtZSArICIgZm9yIHJlc3BvbnNlIGV2ZW50IHRvICIgKyB0aGlzLmNvZGUoKSk7CgkJCQkJdHJ5IHsKCQkJCQkJcGF5bG9hZCA9IChhd2FpdCBuZXcgb1Njb3BlLkV2ZW50KCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkucmVzcG9uc2VUbyh0aGlzKQoJCQkJCQkJLyouc2VuZGVyKG9TY29wZS5fbm9kZSwgJyE9JykucmVjaXBpZW50KG9TY29wZS5fbm9kZSkqLwoJCQkJCQkJLmZpbmQoKSkucGF5bG9hZCgpOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCS8vIHdhcm4oZXgpOwoJCQkJCQlyZXR1cm4gdHJ1ZTsgLy8ga2VlcCBsb29waW5nCgkJCQkJfQoJCQkJfSwgMC4zKTsKCQkJfQoKCQkJaWYgKHRoaXMucmVzcG9uc2VUbygpKSB7CgkJCQlsb2coInJlc3BvbnNlVG8gaXMgc2V0IGZvciAiICsgdGhpcy5jb2RlKCkgKyAiOiAiICsgdGhpcy5yZXNwb25zZVRvKCkuY29kZSgpICsgIiwgcmV0dXJuaW5nIik7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICghcGF5bG9hZCkgcGF5bG9hZCA9IGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKCQkJCWlmICghb1Njb3BlLl9ub2RlKSByZXNvbHZlKG51bGwpOwoJCQkJbG9nKCJXYWl0aW5nIGZvciBwcm9jZXNzaW5nIG9mICIgKyB0aGlzLmNsYXNzTmFtZSgpICsgIi4iICsgdGhpcy5tZXRob2QoKSArICIoIiArIHRoaXMuY29kZSgpICsgIikiKTsKCgkJCQlsZXQgYk9uY2UgPSBmYWxzZTsgLy90aGlzLnJlY2lwaWVudCgpLl9jb2RlX3NldD90cnVlOmZhbHNlOwoJCQkJaWYgKCFiT25jZSkgewoJCQkJCXRoaXMuYXJSZXNwb25zZXMgPSB0aGlzLmFyUmVzcG9uc2VzIHx8IFtdOwoJCQkJCXRoaXMuX3dhaXQodGhpcy5fX2NvbmZpZygndHJpZ2dlci50aW1lb3V0JywgNTAwMCkpLnRoZW4oKCkgPT4gewoJCQkJCQlsb2coIlRpbWVvdXQgLSBjYW5ub3Qgd2FpdCBubyBtb3JlIG9uICIgKyB0aGlzLmNsYXNzTmFtZSgpICsgIi4iICsgdGhpcy5tZXRob2QoKSArICIoIiArIHRoaXMuY29kZSgpICsgIikiKTsKCQkJCQkJcmVzb2x2ZSh0aGlzLmFyUmVzcG9uc2VzKTsKCQkJCQl9KTsKCQkJCX0KCgkJCQlsZXQgaGFuZGxlciA9IChldiwgcmVzb2x2ZSwgcmVqZWN0KSA9PiB7CgkJCQkJbG9nKCJHb3QgcmVzcG9uc2UgZnJvbSBwcm9jZXNzKCIgKyB0aGlzLmNvZGUoKSArICIpIiwgZXYucGF5bG9hZCk7CgkJCQkJaWYgKHRoaXMucmVjaXBpZW50KCkuX2NvZGVfc2V0IC8qYk9uY2UqLyB8fCAhb1Njb3BlLl9ub2RlKSByZXR1cm4gcmVzb2x2ZShldi5wYXlsb2FkKTsKCgkJCQkJdGhpcy5hclJlc3BvbnNlcy5wdXNoKG5ldyBvU2NvcGUuRXZlbnQoKS5fZnJvbURvY3VtZW50KGV2KSk7CgkJCQl9OwoKCQkJCWlmICh0eXBlb2Yob1Njb3BlLmV2ZW50RW1pdHRlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJb1Njb3BlLmV2ZW50RW1pdHRlclsib24iICsgKGJPbmNlID8gImNlIiA6ICIiKV0odGhpcy5uYW1lKCkgKyAiLiIgKyB0aGlzLmNvZGUoKSwgZSA9PiBoYW5kbGVyKGUsIHJlc29sdmUsIHJlamVjdCkpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoYWRkRXZlbnRMaXN0ZW5lcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJYWRkRXZlbnRMaXN0ZW5lcih0aGlzLm5hbWUoKSArICIuIiArIHRoaXMuY29kZSgpLCBlID0+IGhhbmRsZXIoZS5kZXRhaWwsIHJlc29sdmUsIHJlamVjdCksIHsKCQkJCQkJb25jZTogYk9uY2UKCQkJCQl9KTsKCQkJCX0KCQkJfSk7CgoJCQlyZXR1cm4gcGF5bG9hZDsKCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXSwKCQl9KTsKCgkJLy8gdGFrZSBvdXQgdGhlIGludmFsaWQgbm9kZSByZXN1bHRzCgkJcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gciAmJiByLnJldCk7CgoJCS8vIGhhcyBhbnkgbm9kZSBnZW5lcmF0ZWQgYSB2YWxpZGF0aW9uIGV4Y2VwdGlvbj8KCQlsZXQgX19leCA9IHJlc3VsdHMuZmluZChyID0+IHIucmV0Ll9fZXhjZXB0aW9uKTsKCQlpZiAoX19leCkgcmV0dXJuIF9fZXgucmV0OwoKCQlyZXR1cm4gcmVzdWx0cy5sZW5ndGggPyByZXN1bHRzWzBdLnJldCA6IG51bGw7CgoJfQoKCS8qKgoJICogU3VtbWFyeS4gcHJvY2Vzcy4KCSAqCgkgKiBEZXNjcmlwdGlvbi4gLgoJICoKCSAqIEBzaW5jZSAgICAgIHgueC54CgkgKiBAZGVwcmVjYXRlZCB4LngueCBVc2UgbmV3X2Z1bmN0aW9uX25hbWUoKSBpbnN0ZWFkLgoJICogQGFjY2VzcyAgICAgcHVibGljCgkgKgoJICogQGNsYXNzCgkgKiBAYXVnbWVudHMgcGFyZW50CgkgKiBAbWl4ZXMgICAgbWl4aW4KCSAqCgkgKiBAYWxpYXMgICAgcmVhbE5hbWUKCSAqIEBtZW1iZXJvZiBuYW1lc3BhY2UKCSAqCgkgKiBAc2VlICBGdW5jdGlvbi9jbGFzcyByZWxpZWQgb24KCSAqIEBsaW5rIFVSTAoJICogQGdsb2JhbAoJICoKCSAqIEBmaXJlcyAgIGV2ZW50TmFtZQoJICogQGZpcmVzICAgY2xhc3NOYW1lI2V2ZW50TmFtZQoJICogQGxpc3RlbnMgZXZlbnQ6ZXZlbnROYW1lCgkgKiBAbGlzdGVucyBjbGFzc05hbWV+ZXZlbnQ6ZXZlbnROYW1lCgkgKiBAcGFyYW0ge3R5cGV9ICAgdmFyICAgICAgICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyXSAgICAgICAgIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXI9ZGVmYXVsdF0gRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUgd2l0aCBkZWZhdWx0IHZhcmlhYmxlLgoJICogQHBhcmFtIHtPYmplY3R9IG9iamVjdFZhciAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgb2JqZWN0VmFyLmtleSBEZXNjcmlwdGlvbiBvZiBhIGtleSBpbiB0aGUgb2JqZWN0VmFyIHBhcmFtZXRlci4KCSAqCgkgKiBAeWllbGQge3R5cGV9IFlpZWxkZWQgdmFsdWUgZGVzY3JpcHRpb24uCgkgKgoJICogQHJldHVybiB7dHlwZX0gUmV0dXJuIHZhbHVlIGRlc2NyaXB0aW9uLgoJICovCglhc3luYyBwcm9jZXNzKCkgewoKCQlsZXQgYW5zd2VyID0gbmV3IHNhbGVzbm93LkV2ZW50KCk7CgoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInByb2Nlc3MiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAicHJvY2VzcyIsIF9ub2RlLCApID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInByb2Nlc3MiLCApID0+IHsKCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5FdmVudC5wcm9jZXNzJyk7CgoJCQl2YXIgZXJyb3JzID0gewoKCQkJCSIwMSI6ICgoKSA9PiB7CgoJCQkJCWxldCBhbnN3ZXIgPQoKCQkJCQkJIXRoaXMuX3NlbmRlcl9zZXQgfHwgIXRoaXMuc2VuZGVyKCkKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdwcm9jZXNzJywgJ0VudGl0eU9iamVjdCcsIDAsICJhbnN3ZXIiLCAiMDEiLCBhbnN3ZXIpOwoJCQkJCXJldHVybiBhbnN3ZXI7CgkJCQl9KSgpID8gKCdObyBTZW5kZXInIHx8ICdWYWxpZGF0aW9uIEVycm9yJykgOiAnJywKCgkJCQkiMDIiOiAoKCkgPT4gewoKCQkJCQlsZXQgYW5zd2VyID0KCgkJCQkJCSF0aGlzLl9yZWNpcGllbnRfc2V0IHx8ICF0aGlzLnJlY2lwaWVudCgpCgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAncHJvY2VzcycsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgIjAyIiwgYW5zd2VyKTsKCQkJCQlyZXR1cm4gYW5zd2VyOwoJCQkJfSkoKSA/ICgnTm8gUmVjaXBpZW50JyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQkJIjA0IjogKCgpID0+IHsKCgkJCQkJbGV0IGFuc3dlciA9CgoJCQkJCQlvU2NvcGUuX25vZGUuX3NhbWVOb2RlKHRoaXMuc2VuZGVyKCkpCgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAncHJvY2VzcycsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgIjA0IiwgYW5zd2VyKTsKCQkJCQlyZXR1cm4gYW5zd2VyOwoJCQkJfSkoKSA/ICgnU2VudCBieSBteXNlbGYnIHx8ICdWYWxpZGF0aW9uIEVycm9yJykgOiAnJywKCgkJCQkiMDUiOiAoKCkgPT4gewoKCQkJCQlsZXQgYW5zd2VyID0KCgkJCQkJCXRoaXMucmVjaXBpZW50KCkuX2NvZGVfc2V0ICYmICFvU2NvcGUuX25vZGUuX3NhbWVOb2RlKHRoaXMucmVjaXBpZW50KCkpICYmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgfHwgKG9TY29wZS5fX3NvY2tldHMgJiYgIW9TY29wZS5fX3NvY2tldHNbdGhpcy5yZWNpcGllbnQoKS5jb2RlKCldKSkKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdwcm9jZXNzJywgJ0VudGl0eU9iamVjdCcsIDAsICJhbnN3ZXIiLCAiMDUiLCBhbnN3ZXIpOwoJCQkJCXJldHVybiBhbnN3ZXI7CgkJCQl9KSgpID8gKCdJZ25vcm5pbmcgcmVjaXBpZW50JyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3Byb2Nlc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgewoJCQkJCQlba106IGVycm9yc1trXQoJCQkJCX0pOwoJCQkJCWRlbGV0ZSBlcnJvcnNba107CgkJCQl9KTsKCQkJCWlmIChPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIHsKCQkJCQkJX19leGNlcHRpb246IGVycm9ycywKCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIW9TY29wZS5fbm9kZS5wYXJlbnQoKS5hZGRyZXNzKCkpIHRoaXMuc2VuZGVyKCkuc3RvcmUoKTsKCgkJCWlmICh0aGlzLnJlc3BvbnNlVG8oKSkgewoJCQkJLy8gcmVzcG9uZGluZyB0byBhIHByZXZpb3VzIGV2ZW50CgkJCQlsb2coIkRpc3BhdGNoaW5nIGZvciAiICsgdGhpcy5yZXNwb25zZVRvKCkuY29kZSgpKTsKCQkJCWlmICh0eXBlb2YoZGlzcGF0Y2hFdmVudCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQodGhpcy5uYW1lKCkgKyAiLiIgKyB0aGlzLnJlc3BvbnNlVG8oKS5jb2RlKCksIHsKCQkJCQkJZGV0YWlsOiB0aGlzLl90b0RvY3VtZW50KHRydWUsIHRydWUpCgkJCQkJfSkpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2Yob1Njb3BlLmV2ZW50RW1pdHRlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJbG9nKCJEaXNwYXRjaGVkIHRocm91Z2ggZXZlbnRFbWl0dGVyIikKCQkJCQlvU2NvcGUuZXZlbnRFbWl0dGVyLmVtaXQodGhpcy5uYW1lKCkgKyAiLiIgKyB0aGlzLnJlc3BvbnNlVG8oKS5jb2RlKCksIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSwgdHJ1ZSkpOwoJCQkJfQoJCQl9IGVsc2UgaWYgKCFvU2NvcGUuX25vZGUuX3NhbWVOb2RlKHRoaXMucmVjaXBpZW50KCkpKSB7CgkJCQlsb2coIkV2ZW50IG5vdCBhZGRyZXNzZWQgdG8gbWUsIGNoZWNraW5nLi4uIiwgdGhpcy5yZWNpcGllbnQoKS5jb2RlKCkpOwoJCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAidW5kZWZpbmVkIiAmJiBvU2NvcGUuX19zb2NrZXRzICYmIG9TY29wZS5fX3NvY2tldHNbdGhpcy5yZWNpcGllbnQoKS5jb2RlKCldKSB7CgkJCQkJbG9nKCJGb3J3YXJkaW5nIHRvIHRoZSByZWdpc3RlcmVkIG5vZGUiLCB0aGlzLnJlY2lwaWVudCgpLmNvZGUoKSk7CgkJCQkJcmV0dXJuIGF3YWl0IHRoaXMuZm9yd2FyZCgpOwoJCQkJfSBlbHNlIGlmICghdGhpcy5yZWNpcGllbnQoKS5fY29kZV9zZXQpIHsKCQkJCQkvLyByZWNpcGllbnQgaXMgYSBxdWVyeSB0byBtYXRjaCBub2RlcwoJCQkJCWxvZygiUXVlcnk6IFdobyBzaG91bGQgcGljayB0aGlzIHVwPyIpOwoJCQkJCWxldCBxTm9kZXMgPSBhd2FpdCB0aGlzLnJlY2lwaWVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmZpbmRBbGwoKTsKCQkJCQlsZXQgbXlOb2RlcyA9IFtvU2NvcGUuX25vZGVdOwoJCQkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gInVuZGVmaW5lZCIgJiYgb1Njb3BlLl9fc29ja2V0cykgbXlOb2RlcyA9IG15Tm9kZXMuY29uY2F0KE9iamVjdC5rZXlzKG9TY29wZS5fX3NvY2tldHMpLm1hcChzID0+IG5ldyBvU2NvcGUuTm9kZSgpLmNvZGUocykpKTsKCQkJCQlxTm9kZXMgPSBxTm9kZXMuZmlsdGVyKHIgPT4gbXlOb2Rlcy5maW5kKG4gPT4gbi5fc2FtZU5vZGUocikpKS5maWx0ZXIobiA9PiAhbi5fc2FtZU5vZGUodGhpcy5zZW5kZXIoKSkpOwoJCQkJCWlmICghcU5vZGVzLmxlbmd0aCkgewoJCQkJCQlsb2coIlF1ZXJ5OiBObyBtYXRjaGVzIGZvdW5kLCBpZ25vcmluZy4uLiIpOwoJCQkJCQlpZiAodHlwZW9mKHJlamVjdCkgIT09ICJ1bmRlZmluZWQiKSByZWplY3QoKTsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJZm9yIGF3YWl0IChjb25zdCByIG9mIHFOb2RlcykgewoJCQkJCQlsZXQgZXZGcm9tID0gbmV3IG9TY29wZS5FdmVudCgpLmNhcnJpZXIob1Njb3BlLl9ub2RlKS5zZW5kZXIocikucmVzcG9uc2VUbyh0aGlzKTsKCQkJCQkJaWYgKHRoaXMuX2NsYXNzTmFtZV9zZXQpIGV2RnJvbS5jbGFzc05hbWUodGhpcy5jbGFzc05hbWUoKSk7CgoJCQkJCQlsb2coImludm9raW5nICIgKyByLmNvZGUoKSArICIgYW5kIHJlcGx5aW5nIHRvICIgKyB0aGlzLnNlbmRlcigpLmNvZGUoKSk7CgkJCQkJCWxldCBwYXlsb2FkID0gYXdhaXQgb1Njb3BlLl9ub2RlLl9pbnZva2VOb2RlKHIsIHRoaXMubWV0aG9kKCksIHRoaXMucGF5bG9hZCgpLCB0aGlzLl9jbGFzc05hbWVfc2V0ID8gbmV3IG9TY29wZS5FdmVudCgpLmNsYXNzTmFtZSh0aGlzLmNsYXNzTmFtZSgpKSA6IHVuZGVmaW5lZCwgdHJ1ZSk7CgkJCQkJCS8vIGxvZygiUGF5bG9hZCBbIiArIHIuY29kZSgpICsgIl0iLCBwYXlsb2FkKTsKCQkJCQkJYXdhaXQgdGhpcy5faW52b2tlTm9kZSh0aGlzLnNlbmRlcigpLCB0aGlzLm1ldGhvZCgpLCBwYXlsb2FkLCBldkZyb20pOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJd2FybigiTm8ga25vd24gbm9kZSB0byBmb3J3YXJkIHRvIiwgb1Njb3BlLl9ub2RlLmNvZGUoKSwgdGhpcy5yZWNpcGllbnQoKS5jb2RlKCkpOwoJCQkJCXJldHVybiBudWxsOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJbG9nKCJFeGVjdXRpbmcgRXZlbnQgbG9jYWxseTogIiArIHRoaXMuY2xhc3NOYW1lKCkgKyAiLiIgKyB0aGlzLm1ldGhvZCgpICsgIigpIC0gIiArIHRoaXMuY29kZSgpKTsKCgkJCQlsZXQgZXZUbyA9IHRoaXMuX2NsYXNzTmFtZV9zZXQgPyBuZXcgb1Njb3BlLkV2ZW50KCkuY2xhc3NOYW1lKHRoaXMuY2xhc3NOYW1lKCkpIDogdW5kZWZpbmVkOwoJCQkJcmV0dXJuIGF3YWl0IHRoaXMuX2ludm9rZU5vZGUodGhpcy5zZW5kZXIoKSwgdGhpcy5tZXRob2QoKSwgYXdhaXQgdGhpcy5faW52b2tlTm9kZShvU2NvcGUuX25vZGUsIHRoaXMubWV0aG9kKCksIHRoaXMucGF5bG9hZCgpLCBldlRvLCB0cnVlKSwgZXZUby5yZXNwb25zZVRvKHRoaXMpKTsKCQkJfQoKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdLAoJCX0pOwoKCQkvLyB0YWtlIG91dCB0aGUgaW52YWxpZCBub2RlIHJlc3VsdHMKCQlyZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByICYmIHIucmV0KTsKCgkJLy8gaGFzIGFueSBub2RlIGdlbmVyYXRlZCBhIHZhbGlkYXRpb24gZXhjZXB0aW9uPwoJCWxldCBfX2V4ID0gcmVzdWx0cy5maW5kKHIgPT4gci5yZXQuX19leGNlcHRpb24pOwoJCWlmIChfX2V4KSByZXR1cm4gX19leC5yZXQ7CgoJCXJldHVybiByZXN1bHRzLmxlbmd0aCA/IHJlc3VsdHNbMF0ucmV0IDogbnVsbDsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgoJCQkJCS8vIGlmKHRoaXNbJ18nK2ZpZWxkKydfc2V0J10gJiYgKHR5cGVvZih0aGlzWydfJytmaWVsZF0pPT09J3VuZGVmaW5lZCcgfHwgdGhpc1snXycrZmllbGRdPT1udWxsKSkgcmV0dXJuOwoJCQkJCS8vIGlmKHR5cGVvZihlYU9iaik9PT0ndW5kZWZpbmVkJykgcmV0dXJuOyAvLyB3aHk/CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlyZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoImNsYXNzTmFtZSIsIG9iaiwgdGhpcy5jbGFzc05hbWUoKSk7CgoJCV9vcHRpb25zKCJtZXRob2QiLCBvYmosIHRoaXMubWV0aG9kKCkpOwoKCQlfb3B0aW9ucygicGF5bG9hZCIsIG9iaiwgdGhpcy5wYXlsb2FkKCkpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgImRmZWI1YzIzLWY5MGItNGE4ZC04MzQ5LTAwYmZjYjI0NmY2MCIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5FdmVudCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRXZlbnQgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRXZlbnRbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRXZlbnRbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5FdmVudFtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkV2ZW50W2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkV2ZW50W2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5FdmVudFtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlpZiAoIXRoaXMuY2FycmllcigpIHx8ICh0aGlzLmNhcnJpZXIoKQoKCQkJCSYmCgkJCQkhdGhpcy5jYXJyaWVyKCkubm9kZV9Db25maWdzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmNhcnJpZXIoKS5jYXJyaWVyX0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jYXJyaWVyKCkuc2VuZGVyX0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jYXJyaWVyKCkucmVjaXBpZW50X0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jYXJyaWVyKCkuYmFja3VwX05vZGVzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmNhcnJpZXIoKS5wYXJlbnRfTm9kZXMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuY2FycmllcigpLm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJjYXJyaWVyIiwgb2JqLCB0aGlzLmNhcnJpZXIoKSk7CgkJfQoKCQlpZiAoIXRoaXMuc2VuZGVyKCkgfHwgKHRoaXMuc2VuZGVyKCkKCgkJCQkmJgoJCQkJIXRoaXMuc2VuZGVyKCkubm9kZV9Db25maWdzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnNlbmRlcigpLmNhcnJpZXJfRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnNlbmRlcigpLnNlbmRlcl9FdmVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuc2VuZGVyKCkucmVjaXBpZW50X0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5zZW5kZXIoKS5iYWNrdXBfTm9kZXMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuc2VuZGVyKCkucGFyZW50X05vZGVzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnNlbmRlcigpLm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJzZW5kZXIiLCBvYmosIHRoaXMuc2VuZGVyKCkpOwoJCX0KCgkJaWYgKCF0aGlzLnJlY2lwaWVudCgpIHx8ICh0aGlzLnJlY2lwaWVudCgpCgoJCQkJJiYKCQkJCSF0aGlzLnJlY2lwaWVudCgpLm5vZGVfQ29uZmlncygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5yZWNpcGllbnQoKS5jYXJyaWVyX0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5yZWNpcGllbnQoKS5zZW5kZXJfRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnJlY2lwaWVudCgpLnJlY2lwaWVudF9FdmVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMucmVjaXBpZW50KCkuYmFja3VwX05vZGVzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnJlY2lwaWVudCgpLnBhcmVudF9Ob2RlcygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5yZWNpcGllbnQoKS5ub2RlX05vZGVfR3JvdXBfTWVtYmVycygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygicmVjaXBpZW50Iiwgb2JqLCB0aGlzLnJlY2lwaWVudCgpKTsKCQl9CgoJCWlmICghdGhpcy5yZXNwb25zZVRvKCkgfHwgKHRoaXMucmVzcG9uc2VUbygpCgoJCQkJJiYKCQkJCSF0aGlzLnJlc3BvbnNlVG8oKS5yZXNwb25zZVRvX0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygicmVzcG9uc2VUbyIsIG9iaiwgdGhpcy5yZXNwb25zZVRvKCkpOwoJCX0KCgkJX29wdGlvbnMoInJlc3BvbnNlVG9fRXZlbnRzIiwgb2JqLCB0aGlzLnJlc3BvbnNlVG9fRXZlbnRzKCkpOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydjbGFzc05hbWUnLCAnbWV0aG9kJywgJ3BheWxvYWQnLCAnY2FycmllcicsICdzZW5kZXInLCAncmVjaXBpZW50JywgJ3Jlc3BvbnNlVG8nLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3Jlc3BvbnNlVG9fRXZlbnRzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJFdmVudCIgJiYgKG0udGFyZ2V0IHx8IG0ub3V0U2NyaXB0KSAmJiBtLmFjdGl2ZSAmJiBtLmVuYWJsZWQgJiYgKChtLnRvb2wgJiYgbS50b29sLm5hbWUgPT0gdGhpcy5Ub29sLm5hbWUpIHx8IChtLnR5cGUgJiYgbS50eXBlLm5hbWUgPT0gdGhpcy5Ub29sLnR5cGUubmFtZSkpICYmICghbS5zb3VyY2UgfHwgKG0uc291cmNlICYmIC8qIW0ub3V0U2NyaXB0ICYmKi8gdGhpc1snXycgKyBtLnNvdXJjZSArICdfc2V0J10pKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLm91dFNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcywgb1Njb3BlLCBtYXApID0+IHske20ub3V0U2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20ub3V0U2NyaXB0fSl9YCkodGhpcywgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0uc291cmNlKSB7CgkJCQlpZiAobS5zb3VyY2UuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzKSA9PiB7cmV0dXJuIF90aGlzLiR7bS5zb3VyY2V9O31gKSh0aGlzKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0uc291cmNlLCB0aGlzKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS50YXJnZXQpIG9ialttLnRhcmdldF0gPSByZXQ7CgkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCVttLnRhcmdldCB8fCBtLnNvdXJjZV06IHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXQoJCQl9KTsKCQl9KTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQkvLyB1c2UgdGhpcy5fbWFwKCkgd2l0aCByZXZlcnNlCgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjbGFzc05hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygibWV0aG9kIiwgb2JqKTsKCgkJX29wdGlvbnMoInBheWxvYWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJkZmViNWMyMy1mOTBiLTRhOGQtODM0OS0wMGJmY2IyNDZmNjAiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRXZlbnQgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkV2ZW50IHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkV2ZW50W2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkV2ZW50W2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRXZlbnRbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5FdmVudFtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5FdmVudFtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcyk7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRXZlbnRbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiY2FycmllciIsIG9iaik7CgoJCV9vcHRpb25zKCJzZW5kZXIiLCBvYmopOwoKCQlfb3B0aW9ucygicmVjaXBpZW50Iiwgb2JqKTsKCgkJX29wdGlvbnMoInJlc3BvbnNlVG8iLCBvYmopOwoKCQlfb3B0aW9ucygicmVzcG9uc2VUb19FdmVudHMiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydjbGFzc05hbWUnLCAnbWV0aG9kJywgJ3BheWxvYWQnLCAnY2FycmllcicsICdzZW5kZXInLCAncmVjaXBpZW50JywgJ3Jlc3BvbnNlVG8nLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3Jlc3BvbnNlVG9fRXZlbnRzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJFdmVudCIgJiYgKG0uc291cmNlIHx8IG0uaW5TY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5pblNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmosIG9TY29wZSwgbWFwKSA9PiB7JHttLmluU2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20uaW5TY3JpcHR9KX1gKShvYmosIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnRhcmdldCkgewoJCQkJaWYgKG0udGFyZ2V0LmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmopID0+IHtyZXR1cm4gb2JqLiR7bS50YXJnZXR9O31gKShvYmopOwoJCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqW20udGFyZ2V0XSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0udGFyZ2V0LCBvYmopOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0uc291cmNlKSB7CgkJCQlpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXRoaXNbbS5zb3VyY2VdKHJldCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXNbbS5zb3VyY2VdID0gcmV0OwoJCQkJfQoJCQl9CgkJfSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuRXZlbnQpIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuRXZlbnQgPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJFdmVudCIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQljbGFzc05hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNsYXNzTmFtZSA9IHYgPT0gcXVlcnkuY2xhc3NOYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NsYXNzTmFtZV9zZXQgJiYgIXF1ZXJ5Ll9jbGFzc05hbWVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNsYXNzTmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jbGFzc05hbWVfc2V0ICYmIHF1ZXJ5Ll9jbGFzc05hbWVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jbGFzc05hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbWV0aG9kOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5tZXRob2QgPSB2ID09IHF1ZXJ5Lm1ldGhvZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9tZXRob2Rfc2V0ICYmICFxdWVyeS5fbWV0aG9kX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5tZXRob2QgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbWV0aG9kX3NldCAmJiBxdWVyeS5fbWV0aG9kX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubWV0aG9kID0gZmFsc2U7CgkJCQl9LAoKCQkJCXBheWxvYWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnBheWxvYWQgPSB2ID09IHF1ZXJ5LnBheWxvYWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcGF5bG9hZF9zZXQgJiYgIXF1ZXJ5Ll9wYXlsb2FkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5wYXlsb2FkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3BheWxvYWRfc2V0ICYmIHF1ZXJ5Ll9wYXlsb2FkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucGF5bG9hZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljYXJyaWVyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jYXJyaWVyID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5jYXJyaWVyKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NhcnJpZXJfc2V0ICYmICFxdWVyeS5fY2Fycmllcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY2FycmllciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jYXJyaWVyX3NldCAmJiBxdWVyeS5fY2Fycmllcl9zZXQpIHx8CgoJCQkJCQkodGhpcy5jYXJyaWVyKCkgJiYgIXRoaXMuY2FycmllcigpLl9tYXRjaGVzKHF1ZXJ5LmNhcnJpZXIoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNhcnJpZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJc2VuZGVyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5zZW5kZXIgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LnNlbmRlcigpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9zZW5kZXJfc2V0ICYmICFxdWVyeS5fc2VuZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5zZW5kZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fc2VuZGVyX3NldCAmJiBxdWVyeS5fc2VuZGVyX3NldCkgfHwKCgkJCQkJCSh0aGlzLnNlbmRlcigpICYmICF0aGlzLnNlbmRlcigpLl9tYXRjaGVzKHF1ZXJ5LnNlbmRlcigpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouc2VuZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCXJlY2lwaWVudDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucmVjaXBpZW50ID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5yZWNpcGllbnQoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcmVjaXBpZW50X3NldCAmJiAhcXVlcnkuX3JlY2lwaWVudF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVjaXBpZW50ID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3JlY2lwaWVudF9zZXQgJiYgcXVlcnkuX3JlY2lwaWVudF9zZXQpIHx8CgoJCQkJCQkodGhpcy5yZWNpcGllbnQoKSAmJiAhdGhpcy5yZWNpcGllbnQoKS5fbWF0Y2hlcyhxdWVyeS5yZWNpcGllbnQoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlY2lwaWVudCA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZXNwb25zZVRvOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZXNwb25zZVRvID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5yZXNwb25zZVRvKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3Jlc3BvbnNlVG9fc2V0ICYmICFxdWVyeS5fcmVzcG9uc2VUb19zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVzcG9uc2VUbyA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZXNwb25zZVRvX3NldCAmJiBxdWVyeS5fcmVzcG9uc2VUb19zZXQpIHx8CgoJCQkJCQkodGhpcy5yZXNwb25zZVRvKCkgJiYgIXRoaXMucmVzcG9uc2VUbygpLl9tYXRjaGVzKHF1ZXJ5LnJlc3BvbnNlVG8oKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlc3BvbnNlVG8gPSBmYWxzZTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCXJlc3BvbnNlVG9fRXZlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnJlc3BvbnNlVG9fRXZlbnRzID0gdi5tYXAoX3YgPT4gcXVlcnkucmVzcG9uc2VUb19FdmVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWNhcnJpZXI6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBjYXJyaWVyIik7CgkJCQkJb2JqLmNhcnJpZXIgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQlzZW5kZXI6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBzZW5kZXIiKTsKCQkJCQlvYmouc2VuZGVyID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJcmVjaXBpZW50OiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgcmVjaXBpZW50Iik7CgkJCQkJb2JqLnJlY2lwaWVudCA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCXJlc3BvbnNlVG86IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciByZXNwb25zZVRvIik7CgkJCQkJb2JqLnJlc3BvbnNlVG8gPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQlyZXNwb25zZVRvX0V2ZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5yZXNwb25zZVRvX0V2ZW50cyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fY2xhc3NOYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX21ldGhvZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9wYXlsb2FkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NhcnJpZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fc2VuZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlY2lwaWVudF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZXNwb25zZVRvX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJY2FycmllcjogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLmNhcnJpZXIocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCXNlbmRlcjogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLnNlbmRlcihyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJcmVjaXBpZW50OiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMucmVjaXBpZW50KHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlyZXNwb25zZVRvOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMucmVzcG9uc2VUbyhyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJcmVzcG9uc2VUb19FdmVudHM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5yZXNwb25zZVRvX0V2ZW50cygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCWNsYXNzTmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NsYXNzTmFtZScsIHVuZGVmaW5lZCkgOiAiY2xhc3NOYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NsYXNzTmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY2xhc3NOYW1lKHJlZik7CgoJCQl9LAoKCQkJbWV0aG9kOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbWV0aG9kJywgdW5kZWZpbmVkKSA6ICJtZXRob2QiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbWV0aG9kX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5tZXRob2QocmVmKTsKCgkJCX0sCgoJCQlwYXlsb2FkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncGF5bG9hZCcsIHVuZGVmaW5lZCkgOiAicGF5bG9hZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9wYXlsb2FkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5wYXlsb2FkKHJlZik7CgoJCQl9LAoKCQkJY2FycmllcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NhcnJpZXInLCB1bmRlZmluZWQpIDogImNhcnJpZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY2Fycmllcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5jYXJyaWVyKCkgfHwgbmV3IHNhbGVzbm93Lk5vZGUoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLmNhcnJpZXIob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSBjYXJyaWVyIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQlzZW5kZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzZW5kZXInLCB1bmRlZmluZWQpIDogInNlbmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9zZW5kZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMuc2VuZGVyKCkgfHwgbmV3IHNhbGVzbm93Lk5vZGUoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLnNlbmRlcihvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIHNlbmRlciIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJcmVjaXBpZW50OiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVjaXBpZW50JywgdW5kZWZpbmVkKSA6ICJyZWNpcGllbnQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVjaXBpZW50X2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLnJlY2lwaWVudCgpIHx8IG5ldyBzYWxlc25vdy5Ob2RlKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5yZWNpcGllbnQob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSByZWNpcGllbnQiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCXJlc3BvbnNlVG86IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZXNwb25zZVRvJywgdW5kZWZpbmVkKSA6ICJyZXNwb25zZVRvIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3Jlc3BvbnNlVG9fY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMucmVzcG9uc2VUbygpIHx8IG5ldyBzYWxlc25vdy5FdmVudCgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMucmVzcG9uc2VUbyhvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIHJlc3BvbnNlVG8iLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvZGUocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kYXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoJCQkJCWlmICh0eXBlb2YobW9tZW50KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZWYgPSBuZXcgRGF0ZShyZWYpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmVmID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpKTsKCQkJCX0KCQkJCXRoaXMuZGF0ZShyZWYpOwoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm5hbWUocmVmKTsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZW1hcmtfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnJlbWFyayhyZWYpOwoKCQkJfSwKCgkJCXJlc3BvbnNlVG9fRXZlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVzcG9uc2VUb19FdmVudHMnLCB1bmRlZmluZWQpIDogInJlc3BvbnNlVG9fRXZlbnRzIikpID0+IHRoaXMucmVzcG9uc2VUb19FdmVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkV2ZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddID0gdiwKCgkJCSJjbGFzc05hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKSA6ICJjbGFzc05hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY2xhc3NOYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jbGFzc05hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJtZXRob2QiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbWV0aG9kJywgdW5kZWZpbmVkKSA6ICJtZXRob2QiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbWV0aG9kX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9tZXRob2RfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJwYXlsb2FkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3BheWxvYWQnLCB1bmRlZmluZWQpIDogInBheWxvYWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcGF5bG9hZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcGF5bG9hZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNhcnJpZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY2FycmllcicsIHVuZGVmaW5lZCkgOiAiY2FycmllciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX2NhcnJpZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NhcnJpZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJzZW5kZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnc2VuZGVyJywgdW5kZWZpbmVkKSA6ICJzZW5kZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl9zZW5kZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3NlbmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlY2lwaWVudCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZWNpcGllbnQnLCB1bmRlZmluZWQpIDogInJlY2lwaWVudCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX3JlY2lwaWVudF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVjaXBpZW50X2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVzcG9uc2VUbyI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZXNwb25zZVRvJywgdW5kZWZpbmVkKSA6ICJyZXNwb25zZVRvIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fcmVzcG9uc2VUb19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVzcG9uc2VUb19jb29wOwoJCQkJfQoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQkJcmVzcG9uc2VUb19FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZXNwb25zZVRvX0V2ZW50cycsIHVuZGVmaW5lZCkgOiAicmVzcG9uc2VUb19FdmVudHMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fcmVzcG9uc2VUb19FdmVudHNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCglieU5vZGUoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX2NhcnJpZXIiXSAmJiAoYVsiX2NhcnJpZXIiXS5FcXVhbHMgPyBhWyJfY2FycmllciJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfY2FycmllciJdLCByKSkpIHsKCQkJCQlyLl9jYXJyaWVyX0V2ZW50cy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5Tm9kZShhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfc2VuZGVyIl0gJiYgKGFbIl9zZW5kZXIiXS5FcXVhbHMgPyBhWyJfc2VuZGVyIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9zZW5kZXIiXSwgcikpKSB7CgkJCQkJci5fc2VuZGVyX0V2ZW50cy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5Tm9kZShhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfcmVjaXBpZW50Il0gJiYgKGFbIl9yZWNpcGllbnQiXS5FcXVhbHMgPyBhWyJfcmVjaXBpZW50Il0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9yZWNpcGllbnQiXSwgcikpKSB7CgkJCQkJci5fcmVjaXBpZW50X0V2ZW50cy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5RXZlbnQoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX3Jlc3BvbnNlVG8iXSAmJiAoYVsiX3Jlc3BvbnNlVG8iXS5FcXVhbHMgPyBhWyJfcmVzcG9uc2VUbyJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfcmVzcG9uc2VUbyJdLCByKSkpIHsKCQkJCQlyLl9yZXNwb25zZVRvX0V2ZW50cy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gZmFsc2U7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5wYXlsb2FkID0ge307CgkJCWlmICghdGhpcy5fcGF5bG9hZF9zZXQpIGVycm9yLnBheWxvYWRbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLnBheWxvYWQpLmxlbmd0aCkgZGVsZXRlIGVycm9yLnBheWxvYWQ7CgkJfQoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gZmFsc2U7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5zZW5kZXIgPSB7fTsKCQkJaWYgKCF0aGlzLl9zZW5kZXJfc2V0KSBlcnJvci5zZW5kZXJbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIXRoaXMuc2VuZGVyKCkpIGVycm9yLnNlbmRlclsiMDIiXSA9ICJFbXB0eSBWYWx1ZSI7CgkJCWlmICh0aGlzLnNlbmRlcigpICYmIGJTeW5jICYmICF0aGlzLnNlbmRlcigpLl9fc3luY19vbigpKSBlcnJvci5zZW5kZXJbIjAzIl0gPSAiTm90IGluIFN5bmMiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5zZW5kZXIpLmxlbmd0aCkgZGVsZXRlIGVycm9yLnNlbmRlcjsKCQl9CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSBmYWxzZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLm5hbWUgPSB7fTsKCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgZXJyb3IubmFtZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IubmFtZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IubmFtZTsKCQl9CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkV2ZW50LnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5FdmVudChudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuY29kZSh0aGlzLmNvZGUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHsKCQkJCQl0aGlzLmNvZGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gKCkgPT4gdGhpcy5fdXVpZCgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9jYXJyaWVyX3NldCAmJiB0aGlzLmNhcnJpZXIoKSAmJiAhKGF3YWl0IHRoaXMuY2FycmllcigpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX2NhcnJpZXIoKTsKCgkJCQkJaWYgKHRoaXMuX3NlbmRlcl9zZXQgJiYgdGhpcy5zZW5kZXIoKSAmJiAhKGF3YWl0IHRoaXMuc2VuZGVyKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfc2VuZGVyKCk7CgoJCQkJCWlmICh0aGlzLl9yZWNpcGllbnRfc2V0ICYmIHRoaXMucmVjaXBpZW50KCkgJiYgIShhd2FpdCB0aGlzLnJlY2lwaWVudCgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX3JlY2lwaWVudCgpOwoKCQkJCQlpZiAodGhpcy5fcmVzcG9uc2VUb19zZXQgJiYgdGhpcy5yZXNwb25zZVRvKCkgJiYgIShhd2FpdCB0aGlzLnJlc3BvbnNlVG8oKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9yZXNwb25zZVRvKCk7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fX2Fzc2VydFZhbGlkKHRydWUpKSByZXR1cm4gbnVsbDsKCgkJCQkvL2F3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8gaW4gY2FzZSBUb29sIGNoYW5nZXMKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgQWJvdXQgdG8gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9YCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgRmluaXNoZWQgSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9IElkPVske3RoaXMuSWR9XWApOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMucmVzcG9uc2VUb19FdmVudHMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuRXZlbnQuaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuRXZlbnQudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5FdmVudC5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCk7CgkJCQlyZXQgPSByZXQuY29udGVudCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5FdmVudChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93Lk5vZGUgPSBjbGFzcyBOb2RlIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUXNLaTVmYkc5aFpGUnZiMnh6TENvdVlYVjBhRU52WkdVc1JYWmxiblF1YkdsemRHVnVMRVYyWlc1MExuQnliMk5sYzNNc1JYWmxiblF1ZEhKcFoyZGxjaUo5YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUp1YjBSbGRHVmpkQ0k2ZEhKMVpTd2lhVzVwZEM1bGJtUnpJam95TENKcGJtbDBMbXh2YjNBaU9qQXVOU3dpZEc5dmJITXVjM1J2Y21VaU9tWmhiSE5sTENKa1pYUmxZM1JRWVhKbGJuUXVTVkFpT2lJeE9ESXVNVFk0TGpjd0xqZ3lJaXdpWkdWMFpXTjBVR0Z5Wlc1MExtTnZaR1VpT2lKbE9HUmxNRFpsTTJWa1l6UTBNMkZsT1dSbVpURmtaVFZsWXpVeVlUUmlaaUlzSW5ObFkzSmxkQ0k2SW05VFMzZG5Xakp6UzBaUFZFbEtZMkpCWmxWSlVUUkRhamx4YzBnME9HNXNJaXdpY0d4aGVXZHliM1Z1WkNJNmRISjFaU3dpWjFKUVF5STZkSEoxWlN3aWMzUnZjbVV1YzJWdWMybDBhWFpwZEhraU9qRXNJbU52YlhCaGJua2lPaUp5WlhOMWJXVWlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKUFFYVjBhRk5oYm1RaUxDSkhhWFJJZFdJaVhRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLk1hcHBpbmdzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgVzEwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoKCQkvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUKCQl0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307CgkJdGhpcy5Ub29sID0gdG9vbDsKCQl0aGlzLklkID0gaWQ7CgoJCXRoaXMuVmFsdWVFbnRpdGllcyA9IFtdOwoKCQl0aGlzLkRhdGUgPSBudWxsOwoKCQl0aGlzLmNsZWFyX1RISVMoKTsKCQl0aGlzLkVudGl0eVZhbHVlcyA9IFtdOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFkZHJlc3MiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2FkZHJlc3MoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJiYWNrdXAiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2JhY2t1cCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInBhcmVudCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcGFyZW50KCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicG9ydCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcG9ydCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9ubGluZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb25saW5lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAic2VjdXJlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9zZWN1cmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJ0eXBlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl90eXBlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgkJdGhpcy5jbGVhcl9ub2RlX0NvbmZpZ3MoKTsKCgkJdGhpcy5jbGVhcl9jYXJyaWVyX0V2ZW50cygpOwoKCQl0aGlzLmNsZWFyX3NlbmRlcl9FdmVudHMoKTsKCgkJdGhpcy5jbGVhcl9yZWNpcGllbnRfRXZlbnRzKCk7CgoJCXRoaXMuY2xlYXJfYmFja3VwX05vZGVzKCk7CgoJCXRoaXMuY2xlYXJfcGFyZW50X05vZGVzKCk7CgoJCXRoaXMuY2xlYXJfbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJOb2RlIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQkvLyBpZih0aGlzLl9iYWNrdXBfc2V0ICYmIHRoaXMuX2JhY2t1cCkgdGhpcy5fYmFja3VwLlRvb2wgPSB0b29sOwoKCQkvLyBpZih0aGlzLl9wYXJlbnRfc2V0ICYmIHRoaXMuX3BhcmVudCkgdGhpcy5fcGFyZW50LlRvb2wgPSB0b29sOwoKCQkvLyBpZih0aGlzLl90eXBlX3NldCAmJiB0aGlzLl90eXBlKSB0aGlzLl90eXBlLlRvb2wgPSB0b29sOwoKCQkvLyAodGhpcy5ub2RlX0NvbmZpZ3MoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQkvLyAodGhpcy5jYXJyaWVyX0V2ZW50cygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCS8vICh0aGlzLnNlbmRlcl9FdmVudHMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQkvLyAodGhpcy5yZWNpcGllbnRfRXZlbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJLy8gKHRoaXMuYmFja3VwX05vZGVzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJLy8gKHRoaXMucGFyZW50X05vZGVzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJLy8gKHRoaXMubm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWRkcmVzcyAqKi8KCWFkZHJlc3ModiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hZGRyZXNzX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWRkcmVzcyIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWRkcmVzcyAhPSB2KSB7CgkJCQl0aGlzLl9hZGRyZXNzX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hZGRyZXNzID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FkZHJlc3MpOwoJCX0KCX0KCgljbGVhcl9hZGRyZXNzKCkgewoJCXRoaXMuX2FkZHJlc3Nfc2V0ID0gbnVsbDsKCQl0aGlzLl9hZGRyZXNzID0gbnVsbDsKCQl0aGlzLl9hZGRyZXNzX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhZGRyZXNzICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYmFja3VwICoqLwoJYmFja3VwKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYmFja3VwX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYmFja3VwIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnODgwZDlmNjQtYTAxZS00YTk2LTg1ZDMtN2NkMTIwYzg5YmJiJyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnTm9kZScpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdiYWNrdXAnLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICI4ODBkOWY2NC1hMDFlLTRhOTYtODVkMy03Y2QxMjBjODliYmIiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiTm9kZSIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9iYWNrdXAgIT0gdikgewoJCQkJdGhpcy5fYmFja3VwX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnYmFja3VwJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9iYWNrdXAgPyB0aGlzLl9iYWNrdXAuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX2JhY2t1cF9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fYmFja3VwID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2JhY2t1cCk7CgkJfQoJfQoKCWNsZWFyX2JhY2t1cCgpIHsKCQl0aGlzLl9iYWNrdXBfc2V0ID0gbnVsbDsKCQl0aGlzLl9iYWNrdXAgPSBudWxsOwoJCXRoaXMuX2JhY2t1cF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYmFja3VwICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcGFyZW50ICoqLwoJcGFyZW50KHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcGFyZW50X2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicGFyZW50Iik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnODgwZDlmNjQtYTAxZS00YTk2LTg1ZDMtN2NkMTIwYzg5YmJiJyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnTm9kZScpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdwYXJlbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICI4ODBkOWY2NC1hMDFlLTRhOTYtODVkMy03Y2QxMjBjODliYmIiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiTm9kZSIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9wYXJlbnQgIT0gdikgewoJCQkJdGhpcy5fcGFyZW50X3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAncGFyZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9wYXJlbnQgPyB0aGlzLl9wYXJlbnQuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX3BhcmVudF9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fcGFyZW50ID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3BhcmVudCk7CgkJfQoJfQoKCWNsZWFyX3BhcmVudCgpIHsKCQl0aGlzLl9wYXJlbnRfc2V0ID0gbnVsbDsKCQl0aGlzLl9wYXJlbnQgPSBudWxsOwoJCXRoaXMuX3BhcmVudF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcGFyZW50ICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcG9ydCAqKi8KCXBvcnQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9wb3J0X2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicG9ydCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3BvcnQgIT0gdikgewoJCQkJdGhpcy5fcG9ydF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcG9ydCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9wb3J0KTsKCQl9Cgl9CgoJY2xlYXJfcG9ydCgpIHsKCQl0aGlzLl9wb3J0X3NldCA9IG51bGw7CgkJdGhpcy5fcG9ydCA9IG51bGw7CgkJdGhpcy5fcG9ydF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcG9ydCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9ubGluZSAqKi8KCW9ubGluZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29ubGluZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9ubGluZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb25saW5lICE9IHYpIHsKCQkJCXRoaXMuX29ubGluZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb25saW5lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vbmxpbmUpOwoJCX0KCX0KCgljbGVhcl9vbmxpbmUoKSB7CgkJdGhpcy5fb25saW5lX3NldCA9IG51bGw7CgkJdGhpcy5fb25saW5lID0gbnVsbDsKCQl0aGlzLl9vbmxpbmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9ubGluZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHNlY3VyZSAqKi8KCXNlY3VyZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3NlY3VyZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInNlY3VyZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3NlY3VyZSAhPSB2KSB7CgkJCQl0aGlzLl9zZWN1cmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3NlY3VyZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fc2VjdXJlKTsKCQl9Cgl9CgoJY2xlYXJfc2VjdXJlKCkgewoJCXRoaXMuX3NlY3VyZV9zZXQgPSBudWxsOwoJCXRoaXMuX3NlY3VyZSA9IG51bGw7CgkJdGhpcy5fc2VjdXJlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBzZWN1cmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0eXBlICoqLwoJdHlwZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3R5cGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJ0eXBlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnYTdjNjhmMDctNjJiMy00ZjJjLWI2NDQtOGU2ZmY5NzE1NmRkJyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnTm9kZSBUeXBlJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3R5cGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICJhN2M2OGYwNy02MmIzLTRmMmMtYjY0NC04ZTZmZjk3MTU2ZGQiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiTm9kZSBUeXBlIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3R5cGUgIT0gdikgewoJCQkJdGhpcy5fdHlwZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3R5cGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX3R5cGUgPyB0aGlzLl90eXBlLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl90eXBlX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl90eXBlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3R5cGUpOwoJCX0KCX0KCgljbGVhcl90eXBlKCkgewoJCXRoaXMuX3R5cGVfc2V0ID0gbnVsbDsKCQl0aGlzLl90eXBlID0gbnVsbDsKCQl0aGlzLl90eXBlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0eXBlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igbm9kZV9Db25maWdzICoqLwoJbm9kZV9Db25maWdzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9ub2RlX0NvbmZpZ3M7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzg0Y2U0Mzg4LTFiM2QtNDFiNy04ZGFiLTQzYjVhZjFkNGUzMScgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnQ29uZmlnJykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9ub2RlX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ25vZGVfQ29uZmlncycsICdFbnRpdHlPYmplY3QnLCAxLCAibm9kZSBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiQ29uZmlnIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnbm9kZV9Db25maWdzJywgJ0VudGl0eU9iamVjdCcsIDEsICJub2RlIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiQ29uZmlnIik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92Lm5vZGUodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fbm9kZV9Db25maWdzLnB1c2goLi4udik7CgkJdGhpcy5fbm9kZV9Db25maWdzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9ub2RlX0NvbmZpZ3NfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX25vZGVfQ29uZmlncygpIHsKCQl0aGlzLl9ub2RlX0NvbmZpZ3Nfc2V0ID0gbnVsbDsKCQl0aGlzLl9ub2RlX0NvbmZpZ3MgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9ub2RlX0NvbmZpZ3NfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBub2RlX0NvbmZpZ3MgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjYXJyaWVyX0V2ZW50cyAqKi8KCWNhcnJpZXJfRXZlbnRzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9jYXJyaWVyX0V2ZW50czsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnZGZlYjVjMjMtZjkwYi00YThkLTgzNDktMDBiZmNiMjQ2ZjYwJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdFdmVudCcpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fY2Fycmllcl9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjYXJyaWVyX0V2ZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAiY2FycmllciBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiRXZlbnQiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjYXJyaWVyX0V2ZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAiY2FycmllciBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkV2ZW50Iik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LmNhcnJpZXIodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fY2Fycmllcl9FdmVudHMucHVzaCguLi52KTsKCQl0aGlzLl9jYXJyaWVyX0V2ZW50c19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fY2Fycmllcl9FdmVudHNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX2NhcnJpZXJfRXZlbnRzKCkgewoJCXRoaXMuX2NhcnJpZXJfRXZlbnRzX3NldCA9IG51bGw7CgkJdGhpcy5fY2Fycmllcl9FdmVudHMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9jYXJyaWVyX0V2ZW50c19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNhcnJpZXJfRXZlbnRzICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc2VuZGVyX0V2ZW50cyAqKi8KCXNlbmRlcl9FdmVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX3NlbmRlcl9FdmVudHM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2RmZWI1YzIzLWY5MGItNGE4ZC04MzQ5LTAwYmZjYjI0NmY2MCcgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnRXZlbnQnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX3NlbmRlcl9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZW5kZXJfRXZlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJzZW5kZXIgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkV2ZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2VuZGVyX0V2ZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAic2VuZGVyIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiRXZlbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3Yuc2VuZGVyKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX3NlbmRlcl9FdmVudHMucHVzaCguLi52KTsKCQl0aGlzLl9zZW5kZXJfRXZlbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9zZW5kZXJfRXZlbnRzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9zZW5kZXJfRXZlbnRzKCkgewoJCXRoaXMuX3NlbmRlcl9FdmVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9zZW5kZXJfRXZlbnRzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fc2VuZGVyX0V2ZW50c19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHNlbmRlcl9FdmVudHMgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZWNpcGllbnRfRXZlbnRzICoqLwoJcmVjaXBpZW50X0V2ZW50cyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fcmVjaXBpZW50X0V2ZW50czsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnZGZlYjVjMjMtZjkwYi00YThkLTgzNDktMDBiZmNiMjQ2ZjYwJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdFdmVudCcpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fcmVjaXBpZW50X3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3JlY2lwaWVudF9FdmVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgInJlY2lwaWVudCBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiRXZlbnQiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdyZWNpcGllbnRfRXZlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJyZWNpcGllbnQgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJFdmVudCIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5yZWNpcGllbnQodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fcmVjaXBpZW50X0V2ZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX3JlY2lwaWVudF9FdmVudHNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX3JlY2lwaWVudF9FdmVudHNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX3JlY2lwaWVudF9FdmVudHMoKSB7CgkJdGhpcy5fcmVjaXBpZW50X0V2ZW50c19zZXQgPSBudWxsOwoJCXRoaXMuX3JlY2lwaWVudF9FdmVudHMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9yZWNpcGllbnRfRXZlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVjaXBpZW50X0V2ZW50cyAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGJhY2t1cF9Ob2RlcyAqKi8KCWJhY2t1cF9Ob2Rlcyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fYmFja3VwX05vZGVzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICc4ODBkOWY2NC1hMDFlLTRhOTYtODVkMy03Y2QxMjBjODliYmInICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ05vZGUnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX2JhY2t1cF9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdiYWNrdXBfTm9kZXMnLCAnRW50aXR5T2JqZWN0JywgMSwgImJhY2t1cCBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiTm9kZSIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2JhY2t1cF9Ob2RlcycsICdFbnRpdHlPYmplY3QnLCAxLCAiYmFja3VwIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiTm9kZSIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5iYWNrdXAodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fYmFja3VwX05vZGVzLnB1c2goLi4udik7CgkJdGhpcy5fYmFja3VwX05vZGVzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9iYWNrdXBfTm9kZXNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX2JhY2t1cF9Ob2RlcygpIHsKCQl0aGlzLl9iYWNrdXBfTm9kZXNfc2V0ID0gbnVsbDsKCQl0aGlzLl9iYWNrdXBfTm9kZXMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9iYWNrdXBfTm9kZXNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBiYWNrdXBfTm9kZXMgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBwYXJlbnRfTm9kZXMgKiovCglwYXJlbnRfTm9kZXModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX3BhcmVudF9Ob2RlczsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnODgwZDlmNjQtYTAxZS00YTk2LTg1ZDMtN2NkMTIwYzg5YmJiJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdOb2RlJykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9wYXJlbnRfc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAncGFyZW50X05vZGVzJywgJ0VudGl0eU9iamVjdCcsIDEsICJwYXJlbnQgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIk5vZGUiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdwYXJlbnRfTm9kZXMnLCAnRW50aXR5T2JqZWN0JywgMSwgInBhcmVudCBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIk5vZGUiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YucGFyZW50KHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX3BhcmVudF9Ob2Rlcy5wdXNoKC4uLnYpOwoJCXRoaXMuX3BhcmVudF9Ob2Rlc19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fcGFyZW50X05vZGVzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9wYXJlbnRfTm9kZXMoKSB7CgkJdGhpcy5fcGFyZW50X05vZGVzX3NldCA9IG51bGw7CgkJdGhpcy5fcGFyZW50X05vZGVzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fcGFyZW50X05vZGVzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcGFyZW50X05vZGVzICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMgKiovCglub2RlX05vZGVfR3JvdXBfTWVtYmVycyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzU4MmJmZGI0LTY1NzMtNDhlZi1iZTcwLTMxNWMwZWM0MmU3ZicgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnTm9kZSBHcm91cCBNZW1iZXInKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX25vZGVfc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMnLCAnRW50aXR5T2JqZWN0JywgMSwgIm5vZGUgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIk5vZGVfR3JvdXBfTWVtYmVyIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMnLCAnRW50aXR5T2JqZWN0JywgMSwgIm5vZGUgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJOb2RlX0dyb3VwX01lbWJlciIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5ub2RlKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzLnB1c2goLi4udik7CgkJdGhpcy5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9ub2RlX05vZGVfR3JvdXBfTWVtYmVycygpIHsKCQl0aGlzLl9ub2RlX05vZGVfR3JvdXBfTWVtYmVyc19zZXQgPSBudWxsOwoJCXRoaXMuX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBub2RlX05vZGVfR3JvdXBfTWVtYmVycyAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX2FkZHJlc3Nfc2V0LAoKCQkJdGhpcy5fYmFja3VwX3NldCwKCgkJCXRoaXMuX3BhcmVudF9zZXQsCgoJCQl0aGlzLl9wb3J0X3NldCwKCgkJCXRoaXMuX29ubGluZV9zZXQsCgoJCQl0aGlzLl9zZWN1cmVfc2V0LAoKCQkJdGhpcy5fdHlwZV9zZXQsCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fbm9kZV9Db25maWdzX3NldCwKCgkJCXRoaXMuX2NhcnJpZXJfRXZlbnRzX3NldCwKCgkJCXRoaXMuX3NlbmRlcl9FdmVudHNfc2V0LAoKCQkJdGhpcy5fcmVjaXBpZW50X0V2ZW50c19zZXQsCgoJCQl0aGlzLl9iYWNrdXBfTm9kZXNfc2V0LAoKCQkJdGhpcy5fcGFyZW50X05vZGVzX3NldCwKCgkJCXRoaXMuX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX2FkZHJlc3Nfc2V0ID0gdGhpcy5fYWRkcmVzc19zZXQ7CgkJcmV0Ll9hZGRyZXNzX2Nvb3AgPSB0aGlzLl9hZGRyZXNzX2Nvb3A7CgkJcmV0LmFkZHJlc3MgPSB0aGlzLmFkZHJlc3MoKSA/IHRoaXMuYWRkcmVzcygpIDogdGhpcy5hZGRyZXNzKCk7CgoJCXJldC5fYmFja3VwX3NldCA9IHRoaXMuX2JhY2t1cF9zZXQ7CgkJcmV0Ll9iYWNrdXBfY29vcCA9IHRoaXMuX2JhY2t1cF9jb29wOwoJCXJldC5iYWNrdXAgPSB0aGlzLmJhY2t1cCgpID8gdGhpcy5iYWNrdXAoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5iYWNrdXAoKTsKCgkJcmV0Ll9wYXJlbnRfc2V0ID0gdGhpcy5fcGFyZW50X3NldDsKCQlyZXQuX3BhcmVudF9jb29wID0gdGhpcy5fcGFyZW50X2Nvb3A7CgkJcmV0LnBhcmVudCA9IHRoaXMucGFyZW50KCkgPyB0aGlzLnBhcmVudCgpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLnBhcmVudCgpOwoKCQlyZXQuX3BvcnRfc2V0ID0gdGhpcy5fcG9ydF9zZXQ7CgkJcmV0Ll9wb3J0X2Nvb3AgPSB0aGlzLl9wb3J0X2Nvb3A7CgkJcmV0LnBvcnQgPSB0aGlzLnBvcnQoKSA/IHRoaXMucG9ydCgpIDogdGhpcy5wb3J0KCk7CgoJCXJldC5fb25saW5lX3NldCA9IHRoaXMuX29ubGluZV9zZXQ7CgkJcmV0Ll9vbmxpbmVfY29vcCA9IHRoaXMuX29ubGluZV9jb29wOwoJCXJldC5vbmxpbmUgPSB0aGlzLm9ubGluZSgpID8gdGhpcy5vbmxpbmUoKSA6IHRoaXMub25saW5lKCk7CgoJCXJldC5fc2VjdXJlX3NldCA9IHRoaXMuX3NlY3VyZV9zZXQ7CgkJcmV0Ll9zZWN1cmVfY29vcCA9IHRoaXMuX3NlY3VyZV9jb29wOwoJCXJldC5zZWN1cmUgPSB0aGlzLnNlY3VyZSgpID8gdGhpcy5zZWN1cmUoKSA6IHRoaXMuc2VjdXJlKCk7CgoJCXJldC5fdHlwZV9zZXQgPSB0aGlzLl90eXBlX3NldDsKCQlyZXQuX3R5cGVfY29vcCA9IHRoaXMuX3R5cGVfY29vcDsKCQlyZXQudHlwZSA9IHRoaXMudHlwZSgpID8gdGhpcy50eXBlKCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMudHlwZSgpOwoKCQlyZXQuX2FjdGl2ZV9zZXQgPSB0aGlzLl9hY3RpdmVfc2V0OwoJCXJldC5fYWN0aXZlX2Nvb3AgPSB0aGlzLl9hY3RpdmVfY29vcDsKCQlyZXQuYWN0aXZlID0gdGhpcy5hY3RpdmUoKSA/IHRoaXMuYWN0aXZlKCkgOiB0aGlzLmFjdGl2ZSgpOwoKCQlyZXQuX2VuYWJsZWRfc2V0ID0gdGhpcy5fZW5hYmxlZF9zZXQ7CgkJcmV0Ll9lbmFibGVkX2Nvb3AgPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJcmV0LmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKSA/IHRoaXMuZW5hYmxlZCgpIDogdGhpcy5lbmFibGVkKCk7CgoJCXJldC5fY29kZV9zZXQgPSB0aGlzLl9jb2RlX3NldDsKCQlyZXQuX2NvZGVfY29vcCA9IHRoaXMuX2NvZGVfY29vcDsKCQlyZXQuY29kZSA9IHRoaXMuY29kZSgpID8gdGhpcy5jb2RlKCkgOiB0aGlzLmNvZGUoKTsKCgkJcmV0Ll9vcmRlcl9zZXQgPSB0aGlzLl9vcmRlcl9zZXQ7CgkJcmV0Ll9vcmRlcl9jb29wID0gdGhpcy5fb3JkZXJfY29vcDsKCQlyZXQub3JkZXIgPSB0aGlzLm9yZGVyKCkgPyB0aGlzLm9yZGVyKCkgOiB0aGlzLm9yZGVyKCk7CgoJCXJldC5fZGF0ZV9zZXQgPSB0aGlzLl9kYXRlX3NldDsKCQlyZXQuX2RhdGVfY29vcCA9IHRoaXMuX2RhdGVfY29vcDsKCQlyZXQuZGF0ZSA9IHRoaXMuZGF0ZSgpID8gdGhpcy5kYXRlKCkgOiB0aGlzLmRhdGUoKTsKCgkJcmV0Ll9uYW1lX3NldCA9IHRoaXMuX25hbWVfc2V0OwoJCXJldC5fbmFtZV9jb29wID0gdGhpcy5fbmFtZV9jb29wOwoJCXJldC5uYW1lID0gdGhpcy5uYW1lKCkgPyB0aGlzLm5hbWUoKSA6IHRoaXMubmFtZSgpOwoKCQlyZXQuX3JlbWFya19zZXQgPSB0aGlzLl9yZW1hcmtfc2V0OwoJCXJldC5fcmVtYXJrX2Nvb3AgPSB0aGlzLl9yZW1hcmtfY29vcDsKCQlyZXQucmVtYXJrID0gdGhpcy5yZW1hcmsoKSA/IHRoaXMucmVtYXJrKCkgOiB0aGlzLnJlbWFyaygpOwoKCQlyZXQubm9kZV9Db25maWdzID0gdGhpcy5ub2RlX0NvbmZpZ3MoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldC5jYXJyaWVyX0V2ZW50cyA9IHRoaXMuY2Fycmllcl9FdmVudHMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldC5zZW5kZXJfRXZlbnRzID0gdGhpcy5zZW5kZXJfRXZlbnRzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXQucmVjaXBpZW50X0V2ZW50cyA9IHRoaXMucmVjaXBpZW50X0V2ZW50cygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0LmJhY2t1cF9Ob2RlcyA9IHRoaXMuYmFja3VwX05vZGVzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXQucGFyZW50X05vZGVzID0gdGhpcy5wYXJlbnRfTm9kZXMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldC5ub2RlX05vZGVfR3JvdXBfTWVtYmVycyA9IHRoaXMubm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImFkZHJlc3MiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWRkcmVzcycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImJhY2t1cCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdiYWNrdXAnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJwYXJlbnQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncGFyZW50JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkicG9ydCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwb3J0JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib25saW5lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29ubGluZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInNlY3VyZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzZWN1cmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJ0eXBlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQlub2RlX0NvbmZpZ3M6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdub2RlX05vZGVzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJY2Fycmllcl9FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYXJyaWVyX05vZGVzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJc2VuZGVyX0V2ZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3NlbmRlcl9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCXJlY2lwaWVudF9FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZWNpcGllbnRfTm9kZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQliYWNrdXBfTm9kZXM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdiYWNrdXBfTm9kZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQlwYXJlbnRfTm9kZXM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwYXJlbnRfTm9kZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQlub2RlX05vZGVfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25vZGVfTm9kZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAiYmFja3VwIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBiYWNrdXAnLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5iYWNrdXBfTm9kZXModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJwYXJlbnQiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIHBhcmVudCcsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuTm9kZSgpLnBhcmVudF9Ob2Rlcyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInR5cGUiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIHR5cGUnLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93Lk5vZGVfVHlwZSgpLnR5cGVfTm9kZXModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCAmJiBldmVudC5jbGFzc05hbWUoKSAmJiBldmVudC5jbGFzc05hbWUoKSAhPSAnTm9kZScpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCXJldHVybiBuZXcgc2FsZXNub3dbZXZlbnQuY2xhc3NOYW1lKCldKCkuX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdyk7CgkJCX0KCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJCWNhc2UgInVwZGF0ZUFQSSI6IHsKCgkJCQkJZGF0YS5zY3JpcHQgPSBkYXRhLnNjcmlwdCA/IGRhdGEuc2NyaXB0CgoJCQkJCQk6CgkJCQkJCXVuZGVmaW5lZDsKCgkJCQkJZGF0YS5maWxlbmFtZSA9IGRhdGEuZmlsZW5hbWUgPyBkYXRhLmZpbGVuYW1lCgoJCQkJCQk6CgkJCQkJCXVuZGVmaW5lZDsKCgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJY2FzZSAiaW5pdCI6IHsKCgkJCQkJZGF0YS5vbmxpbmUgPSBkYXRhLm9ubGluZSA/IGRhdGEub25saW5lCgoJCQkJCQk6CgkJCQkJCXVuZGVmaW5lZDsKCgkJCQkJZGF0YS5jb2RlID0gZGF0YS5jb2RlID8gZGF0YS5jb2RlCgoJCQkJCQk6CgkJCQkJCXVuZGVmaW5lZDsKCgkJCQkJZGF0YS51aWQgPSBkYXRhLnVpZCA/IGRhdGEudWlkCgoJCQkJCQk6CgkJCQkJCXVuZGVmaW5lZDsKCgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJY2FzZSAiYXV0aENvZGUiOiB7CgoJCQkJCWRhdGEuY29kZSA9IGRhdGEuY29kZSA/IGRhdGEuY29kZQoKCQkJCQkJOgoJCQkJCQl1bmRlZmluZWQ7CgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCWNhc2UgImRhcnRBUEkiOiB7CgoJCQkJCWRhdGEuc2NvcGUgPSBkYXRhLnNjb3BlID8gZGF0YS5zY29wZQoKCQkJCQkJOgoJCQkJCQl1bmRlZmluZWQ7CgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCWNhc2UgInJlc3RhcnQiOiB7CgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCWNhc2UgInN0YXR1cyI6IHsKCgkJCQkJYnJlYWs7CgkJCQl9CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL05vZGUvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQkJZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOwoJCQkJZGVsZXRlIGRhdGEuX190aGlzLm9ubGluZTsKCgkJCX0KCgkJCS8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/PwoKCQkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJCXRyeSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0pIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7bWV0aG9kfWApOwoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCWxldCBfaWQgPSBudWxsOwoJCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBkYXRhLCBtZXRob2QsIHt9KTsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRhdGEpID09PSAnc3RyaW5nJykgewoJCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUoZGF0YSk7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IGRhdGEuX190aGlzLmNvZGUgfHwgZGF0YS5pZCB8fCBkYXRhLklEOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJCWlmIChkYXRhLklkICYmIGRhdGEuSWQgPT0gZGF0YS5JZCkgewoJCQkJCQlfaWQgPSBkYXRhLklkOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQkJfSBlbHNlIGlmIChkYXRhLkVudGl0eUNsYXNzKSB7CgkJCQkJCV9pZCA9IGRhdGEuRW50aXR5Q2xhc3MuSWQgfHwgZGF0YS5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjg4MGQ5ZjY0LWEwMWUtNGE5Ni04NWQzLTdjZDEyMGM4OWJiYiIgfHwgIk5VTEwiOwoJCQkJCX0KCQkJCX0KCgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVttZXRob2RdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlW21ldGhvZF0gfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlW21ldGhvZF1bX2lkXSB8fCB7fTsKCgkJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goe30sIHsKCQkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQkJfSk7CgoJCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVttZXRob2RdW19pZF1bX2hhc2hdOwoJCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiA1KSkgewoJCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gbWV0aG9kIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJCXYucmV1c2VkKys7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhKTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnTm9kZScpLnNlbmRlcihzYWxlc25vdy5fbm9kZSkuY2FycmllcihzYWxlc25vdy5fbm9kZSkucGF5bG9hZChkYXRhKTsKCQkJaWYgKGV2ZW50KSB7CgkJCQlpZiAoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7CgkJCQlpZiAoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7CgkJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7CgkJCQlpZiAoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7CgkJCX0KCQkJcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOwoKCQkJaWYgKHR5cGVvZihyZXQpID09PSAic3RyaW5nIikgewoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChleCkge30KCQkJfQoJCQlyZXR1cm4gcmV0OwoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgInVwZGF0ZUFQSSI6IHsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiaW5pdCI6IHsKCgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5Ob2RlKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJhdXRoQ29kZSI6IHsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiZGFydEFQSSI6IHsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAicmVzdGFydCI6IHsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAic3RhdHVzIjogewoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5Ob2RlKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5Ob2RlKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJ1cGRhdGVBUEkiOiB7CgoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zY3JpcHQpOwoKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZmlsZW5hbWUpOwoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJpbml0IjogewoKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub25saW5lKTsKCgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmNvZGUpOwoKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMudWlkKTsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiYXV0aENvZGUiOiB7CgoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5jb2RlKTsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiZGFydEFQSSI6IHsKCgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnNjb3BlKTsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAicmVzdGFydCI6IHsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAic3RhdHVzIjogewoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBOb2RlLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgTm9kZS5faW52b2tlOiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLAoJCQkJCSdvYmonOiBvYmoKCQkJCX0KCQkJfTsKCQl9IGVsc2UgewoJCQlyZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOwoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQl9CgoJCWlmIChyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbikgewoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0ge307CgkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCXJldCA9IHJldC5tYXAociA9PiB7CgkJCQkJaWYgKHIgJiYgci5fdG9Eb2N1bWVudCkgewoJCQkJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlLl90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGUuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIk5vZGUiKTsKCgl9CgoJX19zeW5jX29uKGQpIHsKCQl0aGlzLl9fX3N5bmNfb24gPSB0aGlzLl9fX3N5bmNfb24gfHwge307CgoJCWlmIChkKSB7CgkJCXRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV0gPSBkOwoKCQkJaWYgKHRoaXMuX2JhY2t1cF9zZXQgJiYgdGhpcy5iYWNrdXAoKSkgdGhpcy5iYWNrdXAoKS5fX3N5bmNfb24oZCk7CgoJCQlpZiAodGhpcy5fcGFyZW50X3NldCAmJiB0aGlzLnBhcmVudCgpKSB0aGlzLnBhcmVudCgpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl90eXBlX3NldCAmJiB0aGlzLnR5cGUoKSkgdGhpcy50eXBlKCkuX19zeW5jX29uKGQpOwoKCQkJLy8gdGhpcy5ub2RlX05vZGVzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCS8vIHRoaXMuY2Fycmllcl9Ob2RlcygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQkvLyB0aGlzLnNlbmRlcl9Ob2RlcygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQkvLyB0aGlzLnJlY2lwaWVudF9Ob2RlcygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQkvLyB0aGlzLmJhY2t1cF9Ob2RlcygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQkvLyB0aGlzLnBhcmVudF9Ob2RlcygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQkvLyB0aGlzLm5vZGVfTm9kZXMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Ob2RlKHRoaXMuSWQpCgoJCQkuYWRkcmVzcyh0aGlzLmFkZHJlc3MoKSwgdGhpcy5fYWRkcmVzc19jb29wKQoKCQkJLmJhY2t1cCh0aGlzLmJhY2t1cCgpLCB0aGlzLl9iYWNrdXBfY29vcCkKCgkJCS5wYXJlbnQodGhpcy5wYXJlbnQoKSwgdGhpcy5fcGFyZW50X2Nvb3ApCgoJCQkucG9ydCh0aGlzLnBvcnQoKSwgdGhpcy5fcG9ydF9jb29wKQoKCQkJLm9ubGluZSh0aGlzLm9ubGluZSgpLCB0aGlzLl9vbmxpbmVfY29vcCkKCgkJCS5zZWN1cmUodGhpcy5zZWN1cmUoKSwgdGhpcy5fc2VjdXJlX2Nvb3ApCgoJCQkudHlwZSh0aGlzLnR5cGUoKSwgdGhpcy5fdHlwZV9jb29wKQoKCQkJLmFjdGl2ZSh0aGlzLmFjdGl2ZSgpLCB0aGlzLl9hY3RpdmVfY29vcCkKCgkJCS5lbmFibGVkKHRoaXMuZW5hYmxlZCgpLCB0aGlzLl9lbmFibGVkX2Nvb3ApCgoJCQkuY29kZSh0aGlzLmNvZGUoKSwgdGhpcy5fY29kZV9jb29wKQoKCQkJLm9yZGVyKHRoaXMub3JkZXIoKSwgdGhpcy5fb3JkZXJfY29vcCkKCgkJCS5kYXRlKHRoaXMuZGF0ZSgpLCB0aGlzLl9kYXRlX2Nvb3ApCgoJCQkubmFtZSh0aGlzLm5hbWUoKSwgdGhpcy5fbmFtZV9jb29wKQoKCQkJLnJlbWFyayh0aGlzLnJlbWFyaygpLCB0aGlzLl9yZW1hcmtfY29vcCkKCgkJCS5ub2RlX0NvbmZpZ3ModGhpcy5ub2RlX0NvbmZpZ3MoKSwgdGhpcy5fbm9kZV9Db25maWdzX2Nvb3ApCgoJCQkuY2Fycmllcl9FdmVudHModGhpcy5jYXJyaWVyX0V2ZW50cygpLCB0aGlzLl9jYXJyaWVyX0V2ZW50c19jb29wKQoKCQkJLnNlbmRlcl9FdmVudHModGhpcy5zZW5kZXJfRXZlbnRzKCksIHRoaXMuX3NlbmRlcl9FdmVudHNfY29vcCkKCgkJCS5yZWNpcGllbnRfRXZlbnRzKHRoaXMucmVjaXBpZW50X0V2ZW50cygpLCB0aGlzLl9yZWNpcGllbnRfRXZlbnRzX2Nvb3ApCgoJCQkuYmFja3VwX05vZGVzKHRoaXMuYmFja3VwX05vZGVzKCksIHRoaXMuX2JhY2t1cF9Ob2Rlc19jb29wKQoKCQkJLnBhcmVudF9Ob2Rlcyh0aGlzLnBhcmVudF9Ob2RlcygpLCB0aGlzLl9wYXJlbnRfTm9kZXNfY29vcCkKCgkJCS5ub2RlX05vZGVfR3JvdXBfTWVtYmVycyh0aGlzLm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKCksIHRoaXMuX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQlvYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ05vZGUnOwoJCXRvb2wgPSB0b29sIHx8IHRoaXMuVG9vbDsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJOb2RlIjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCQkJCXJldCA9IHJldC50b0xvd2VyQ2FzZSgpOwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCQl0cnkgewoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgPyAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gb3B0aW9ucy50b29sIHx8IHQgPT0gb3B0aW9ucy50b29sKSA6IHRoaXMuVG9vbDsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sIHx8IHt9OwoKCQkJbGV0IG5JRCA9IHNhbGVzbm93Ll9ub2RlID8gc2FsZXNub3cuX25vZGUuY29kZSgpIDogImRlZmF1bHQiOwoKCQkJbGV0IHJldCA9IG51bGxWYWx1ZTsKCQkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0ID0gbnVsbDsKCgkJCS8vIHRvb2xfQ29uZmlnczogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBkb25lCgkJCWxldCB0Y29uZiA9IChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiBjLm5vZGUgJiYgYy5ub2RlLmNvZGUgPT0gbklEKS5jb25jYXQoKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmICFjLm5vZGUpKTsKCQkJaWYgKHRjb25mLmxlbmd0aCkgewoJCQkJcmV0ID0gdGNvbmZbMF0udmFsdWU7CgkJCQl0cnkgewoJCQkJCVsxLCAyLCAzXS5mb3JFYWNoKGEgPT4gcmV0ID0gSlNPTi5wYXJzZShyZXQpKTsKCQkJCX0gY2F0Y2ggKGpleCkge30KCQkJfQoKCQkJLy8gbW9kZWwgQ29uZmlnOiBDb25maWcgaXMgY2xhc3MgbGV2ZWwsIG5vZGUgbm90IHBvc3NpYmxlIC0gcGVuZGluZwoJCQlsZXQgbWNvbmYgPSB0aGlzLkNvbmZpZyA/IHRoaXMuQ29uZmlnW25dIDogdW5kZWZpbmVkOwoJCQlpZiAodHlwZW9mKG1jb25mKSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IG1jb25mOwoKCQkJLy8gY29tbWFuZCBsaW5lOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiBnbG9iYWwubWluaW1pc3QpIHsKCQkJCXJldCA9IGdsb2JhbC5taW5pbWlzdChwcm9jZXNzLmFyZ3Yuc2xpY2UoMikpW25dIHx8IHJldDsKCQkJfQoKCQkJLy8gcmVxdWVzdDogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCXJldCA9IHRoaXMuJF9SRVFVRVNUKG4pIHx8IHJldDsKCgkJCWlmIChvcHRpb25zLm5ld1ZhbHVlKSB7CgkJCQlsZXQgdGMgPSB0Y29uZi5sZW5ndGggPyB0Y29uZlswXSA6IHt9OwoJCQkJdGMubm9kZSA9IHsKCQkJCQljb2RlOiBvcHRpb25zLm5vZGUuY29kZSgpCgkJCQl9OwoJCQkJdGMudmFsdWUgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQkJdGMubmFtZSA9IG47CgkJCQlpZiAoIXRjb25mLmxlbmd0aCkgewoJCQkJCW9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MucHVzaCh0Yyk7CgkJCQl9CgkJCQlyZXQgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQl9CgoJCQkvLyBjb25maWcgcmVwbGFjZW1lbnQKCQkJaWYgKHR5cGVvZihyZXQpID09PSAnc3RyaW5nJykocmV0Lm1hdGNoKG5ldyBSZWdFeHAoYHt7KFtefV0rKX19YCwgImciKSkgfHwgW10pLmZvckVhY2gobSA9PiByZXQgPSByZXQucmVwbGFjZShtLCB0aGlzLl9fY29uZmlnKG0ucmVwbGFjZSgne3snLCAnJykucmVwbGFjZSgnfX0nLCAnJyksIG51bGwsIG9wdGlvbnMpKSk7CgoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fY29uZmlnJywgJ0VudGl0eU9iamVjdCcsIDEsIG4sIG51bGxWYWx1ZSwgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncywgZXgpOwoJCX0KCX0KCgkvKioKCSAqIFN1bW1hcnkuIHVwZGF0ZUFQSS4KCSAqCgkgKiBEZXNjcmlwdGlvbi4gLgoJICoKCSAqIEBzaW5jZSAgICAgIHgueC54CgkgKiBAZGVwcmVjYXRlZCB4LngueCBVc2UgbmV3X2Z1bmN0aW9uX25hbWUoKSBpbnN0ZWFkLgoJICogQGFjY2VzcyAgICAgcHVibGljCgkgKgoJICogQGNsYXNzCgkgKiBAYXVnbWVudHMgcGFyZW50CgkgKiBAbWl4ZXMgICAgbWl4aW4KCSAqCgkgKiBAYWxpYXMgICAgcmVhbE5hbWUKCSAqIEBtZW1iZXJvZiBuYW1lc3BhY2UKCSAqCgkgKiBAc2VlICBGdW5jdGlvbi9jbGFzcyByZWxpZWQgb24KCSAqIEBsaW5rIFVSTAoJICogQGdsb2JhbAoJICoKCSAqIEBmaXJlcyAgIGV2ZW50TmFtZQoJICogQGZpcmVzICAgY2xhc3NOYW1lI2V2ZW50TmFtZQoJICogQGxpc3RlbnMgZXZlbnQ6ZXZlbnROYW1lCgkgKiBAbGlzdGVucyBjbGFzc05hbWV+ZXZlbnQ6ZXZlbnROYW1lCgkgKiBAcGFyYW0ge3R5cGV9ICAgdmFyICAgICAgICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyXSAgICAgICAgIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXI9ZGVmYXVsdF0gRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUgd2l0aCBkZWZhdWx0IHZhcmlhYmxlLgoJICogQHBhcmFtIHtPYmplY3R9IG9iamVjdFZhciAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgb2JqZWN0VmFyLmtleSBEZXNjcmlwdGlvbiBvZiBhIGtleSBpbiB0aGUgb2JqZWN0VmFyIHBhcmFtZXRlci4KCSAqCgkgKiBAeWllbGQge3R5cGV9IFlpZWxkZWQgdmFsdWUgZGVzY3JpcHRpb24uCgkgKgoJICogQHJldHVybiB7dHlwZX0gUmV0dXJuIHZhbHVlIGRlc2NyaXB0aW9uLgoJICovCglhc3luYyB1cGRhdGVBUEkoc2NyaXB0LCBmaWxlbmFtZSkgewoKCQlsZXQgYW5zd2VyID0gZmFsc2U7CgoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZUFQSSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGVBUEkiLCBfbm9kZSwgc2NyaXB0LCBmaWxlbmFtZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlQVBJIiwgc2NyaXB0LCBmaWxlbmFtZSkgPT4gewoKCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGUudXBkYXRlQVBJJyk7CgoJCQl2YXIgZXJyb3JzID0gewoKCQkJCSJzY3JpcHQtcmVxdWlyZWQiOiAoKHNjcmlwdCwgZmlsZW5hbWUpID0+IHsKCgkJCQkJbGV0IGFuc3dlciA9CgoJCQkJCQl0eXBlb2Yoc2NyaXB0KSA9PT0gJ3VuZGVmaW5lZCcKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGVBUEknLCAnRW50aXR5T2JqZWN0JywgMCwgImFuc3dlciIsICJzY3JpcHQtcmVxdWlyZWQiLCBhbnN3ZXIpOwoJCQkJCXJldHVybiBhbnN3ZXI7CgkJCQl9KShzY3JpcHQsIGZpbGVuYW1lKSA/ICgnc2NyaXB0IGlzIGEgcmVxdWlyZWQgUGFyYW1ldGVyJyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZUFQSScsICdFbnRpdHlPYmplY3QnLCAwLCB7CgkJCQkJCVtrXTogZXJyb3JzW2tdCgkJCQkJfSk7CgkJCQkJZGVsZXRlIGVycm9yc1trXTsKCQkJCX0pOwoJCQkJaWYgKE9iamVjdC52YWx1ZXMoZXJyb3JzKS5sZW5ndGgpIHsKCQkJCQlyZXR1cm4gewoJCQkJCQlfX2V4Y2VwdGlvbjogZXJyb3JzLAoJCQkJCX07CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCS8vIG5vZGVqcwoJCQkJcmV0dXJuIGF3YWl0IGdsb2JhbC51dGlsLnByb21pc2lmeShnbG9iYWwuZnMud3JpdGVGaWxlKShmaWxlbmFtZSwgdGhpcy5fYXRvYihzY3JpcHQpKTsKCQkJfSBlbHNlIHsKCQkJCWxvZygiQnJvd3NlcnMgZG8gbm90IHdyaXRlIHRvIGZpbGVzIGZvciBub3ciKTsKCQkJfQoJCQlyZXR1cm4gdHJ1ZTsKCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXSwKCQkJc2NyaXB0OiBzY3JpcHQsCgkJCWZpbGVuYW1lOiBmaWxlbmFtZQoJCX0pOwoKCQkvLyB0YWtlIG91dCB0aGUgaW52YWxpZCBub2RlIHJlc3VsdHMKCQlyZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByICYmIHIucmV0KTsKCgkJLy8gaGFzIGFueSBub2RlIGdlbmVyYXRlZCBhIHZhbGlkYXRpb24gZXhjZXB0aW9uPwoJCWxldCBfX2V4ID0gcmVzdWx0cy5maW5kKHIgPT4gci5yZXQuX19leGNlcHRpb24pOwoJCWlmIChfX2V4KSByZXR1cm4gX19leC5yZXQ7CgoJCXJldHVybiByZXN1bHRzLmxlbmd0aCA/IHJlc3VsdHNbMF0ucmV0IDogbnVsbDsKCgl9CgoJLyoqCgkgKiBTdW1tYXJ5LiBpbml0LgoJICoKCSAqIERlc2NyaXB0aW9uLiAuCgkgKgoJICogQHNpbmNlICAgICAgeC54LngKCSAqIEBkZXByZWNhdGVkIHgueC54IFVzZSBuZXdfZnVuY3Rpb25fbmFtZSgpIGluc3RlYWQuCgkgKiBAYWNjZXNzICAgICBwdWJsaWMKCSAqCgkgKiBAY2xhc3MKCSAqIEBhdWdtZW50cyBwYXJlbnQKCSAqIEBtaXhlcyAgICBtaXhpbgoJICoKCSAqIEBhbGlhcyAgICByZWFsTmFtZQoJICogQG1lbWJlcm9mIG5hbWVzcGFjZQoJICoKCSAqIEBzZWUgIEZ1bmN0aW9uL2NsYXNzIHJlbGllZCBvbgoJICogQGxpbmsgVVJMCgkgKiBAZ2xvYmFsCgkgKgoJICogQGZpcmVzICAgZXZlbnROYW1lCgkgKiBAZmlyZXMgICBjbGFzc05hbWUjZXZlbnROYW1lCgkgKiBAbGlzdGVucyBldmVudDpldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGNsYXNzTmFtZX5ldmVudDpldmVudE5hbWUKCSAqIEBwYXJhbSB7dHlwZX0gICB2YXIgICAgICAgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXJdICAgICAgICAgRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUuCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcj1kZWZhdWx0XSBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZSB3aXRoIGRlZmF1bHQgdmFyaWFibGUuCgkgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0VmFyICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBvYmplY3RWYXIua2V5IERlc2NyaXB0aW9uIG9mIGEga2V5IGluIHRoZSBvYmplY3RWYXIgcGFyYW1ldGVyLgoJICoKCSAqIEB5aWVsZCB7dHlwZX0gWWllbGRlZCB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqCgkgKiBAcmV0dXJuIHt0eXBlfSBSZXR1cm4gdmFsdWUgZGVzY3JpcHRpb24uCgkgKi8KCWFzeW5jIGluaXQob25saW5lLCBjb2RlLCB1aWQpIHsKCgkJbGV0IGFuc3dlciA9IG5ldyBzYWxlc25vdy5Ob2RlKCk7CgoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluaXQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5pdCIsIF9ub2RlLCBvbmxpbmUsIGNvZGUsIHVpZCkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5pdCIsIG9ubGluZSwgY29kZSwgdWlkKSA9PiB7CgoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZS5pbml0Jyk7CgoJCQl2YXIgZXJyb3JzID0gewoKCQkJfTsKCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiAhZXJyb3JzW2tdKS5mb3JFYWNoKGsgPT4gZGVsZXRlIGVycm9yc1trXSk7CgkJCWlmIChPYmplY3Qua2V5cyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJy0nKSkuZm9yRWFjaChrID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbml0JywgJ0VudGl0eU9iamVjdCcsIDAsIHsKCQkJCQkJW2tdOiBlcnJvcnNba10KCQkJCQl9KTsKCQkJCQlkZWxldGUgZXJyb3JzW2tdOwoJCQkJfSk7CgkJCQlpZiAoT2JqZWN0LnZhbHVlcyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJCXJldHVybiB7CgkJCQkJCV9fZXhjZXB0aW9uOiBlcnJvcnMsCgkJCQkJfTsKCQkJCX0KCQkJCXJldHVybjsKCQkJfQoKCQkJLy8gZGVmYXVsdHMKCQkJb25saW5lID0gb25saW5lIHx8IHRoaXMuX19jb25maWcoJ2luaXQubG9vcCcpOwoJCQlvU2NvcGUuX25vZGVzID0gb1Njb3BlLl9ub2RlcyB8fCB7fTsKCgkJCS8vIGNvZGUgYW5kIHR5cGUgZGV0ZWN0aW9uCgkJCWxldCBuID0gbnVsbDsKCQkJaWYgKCF1aWQgJiYgb1Njb3BlLl9ub2RlKSB7CgkJCQluID0gb1Njb3BlLl9ub2RlOwoJCQl9IGVsc2UgaWYgKHVpZCAmJiB0eXBlb2YodWlkKSA9PT0gJ3N0cmluZycpIHsKCQkJCW4gPSBvU2NvcGUuX25vZGVzW3VpZF07CgkJCX0KCgkJCWxldCBpcCA9IHRoaXMuaXBBZGRyZXNzKCk7CgkJCWlwID0gWyIxODIuMTY4LjcwLjgyIiwgIjE5Mi4xNjguMS4yNTMiXS5pbmRleE9mKGlwKSA+PSAwID8gIjE5NS4xMTIuMjE1LjIxOCIgOiBpcDsKCQkJbiA9IG4gfHwgbmV3IG9TY29wZS5Ob2RlKCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuc2VjdXJlKHRoaXMuc2VjdXJlKCkpLmNvZGUodGhpcy5fX2NvbmZpZygnQ29kZScpIHx8ICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgPyBnbG9iYWwubWFjaGluZWlkLm1hY2hpbmVJZFN5bmModHJ1ZSkgOiBudWxsKSB8fCB0aGlzLl9fY29uZmlnKCd0ZXN0LmNvZGUnKSB8fCAoKHR5cGVvZih1aWQpID09PSAnc3RyaW5nJykgPyB1aWQgOiBudWxsKSB8fCAoKHR5cGVvZih1dWlkKSAhPT0gInVuZGVmaW5lZCIpID8gKCAvKnVpZCA9ICovIHV1aWQoKSkgOiBudWxsKSB8fCAoMTAgKiBNYXRoLnJhbmRvbSgpKSkudHlwZShuZXcgb1Njb3BlLk5vZGVfVHlwZSgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLm5hbWUodHlwZW9mKGdsb2JhbCkgIT09ICJ1bmRlZmluZWQiID8gIk5vZGVKUyIgOiAiQnJvd3NlciIpLmR5bmFtaWModHlwZW9mKGdsb2JhbCkgPT09ICJ1bmRlZmluZWQiKSkucG9ydCh0aGlzLl9fY29uZmlnKCdwb3J0JykgfHwgMzAwMCkuYWRkcmVzcyhpcCk7CgoJCQlpZiAobi50eXBlKCkuZHluYW1pYygpKSB7CgkJCQkvLyB3aXRoIGR5bmFtaWMgbm9kZXMgd2UgbmVlZCB0byBjaGVjayBpZiB0aGVyZSBpcyBhIG5vZGUgdGhhdCBpcyBubyBsb25nZXIgb25saW5lLCBhbmQgYmluZCB0aGlzIGluc3RhbmNlIHRvIGl0IChub2RlIHJlY3ljbGluZykKCQkJCS8vIGEgZHluYW1pYyBub2RlIGlzIG5vIGxvbmdlciBvbmxpbmUgaWYgaXQgZmFpbHMgdG8gcmVwb3J0IGl0cyBsYXN0IG9ubGluZSBwcmVzZW5jZSBhZnRlciA1IG1pbnV0ZXMgPz8/CgkJCQkvLyBnZXQgYSBwb29sIG9mIGFsbCBub2RlcyB0aGF0IGFyZSBubyBsb25nZXIgb25saW5lLCBiaW5kIHRvIHRoZSBvbGRlc3Qgb25lCgoJCQkJbGV0IGRlYWROb2RlcyA9IGF3YWl0IG5ldyBvU2NvcGUuTm9kZSgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUobnVsbCwgIiE9IikudHlwZShuLnR5cGUoKSkuc2VjdXJlKG4uc2VjdXJlKCkpLm9ubGluZShuZXcgRGF0ZSh0aGlzLnNyKCkuc2VydmVyRGF0ZSgpIC0gMTAgKiAob25saW5lIHx8IDUpICogNjAwMDApLCAiPD0iKS5maW5kQWxsKCk7CgoJCQkJaWYgKGRlYWROb2Rlcy5sZW5ndGgpIHsKCQkJCQlkZWFkTm9kZXMuc29ydCgoYSwgYikgPT4gYS5fb25saW5lIC0gYi5fb25saW5lKTsKCQkJCQlkZWFkTm9kZXMgPSBkZWFkTm9kZXMuZmlsdGVyKGRuID0+ICFvU2NvcGUuX25vZGVzW2RuLmNvZGUoKV0pOwoJCQkJCW4gPSBkZWFkTm9kZXNbMF07CgkJCQkJbG9nKCJSZXVzaW5nIERlYWQgTm9kZSAiICsgbi5jb2RlKCkpOwoJCQkJfQoJCQl9CgoJCQlpZiAodWlkKSB7CgkJCQlvU2NvcGUuX25vZGVzW3VpZF0gPSBvU2NvcGUuX25vZGVzW3VpZF0gfHwgbjsKCQkJCW4gPSBvU2NvcGUuX25vZGVzW3VpZF07CgkJCX0KCgkJCWlmIChPYmplY3Qua2V5cyhvU2NvcGUuX25vZGVzKS5sZW5ndGggPD0gMSkgewoJCQkJb1Njb3BlLl9ub2RlID0gbjsKCQkJfSBlbHNlIHsKCQkJCWRlbGV0ZSBvU2NvcGUuX25vZGU7CgkJCX0KCgkJCW9TY29wZS5ub2RlSW5pdENhbGxzID0gb1Njb3BlLm5vZGVJbml0Q2FsbHMgfHwgMDsKCgkJCXRoaXMuc2V0SW50ZXJ2YWwoYXN5bmMgKHNjb3BlLCB1aWQsIG9ubGluZSkgPT4gewoJCQkJc2NvcGUubm9kZUluaXRDYWxscysrCgkJCQlsb2coIkNhbGwgIyIgKyBzY29wZS5ub2RlSW5pdENhbGxzICsgIiBvZiAiICsgdGhpcy5fX2NvbmZpZygnaW5pdC5lbmRzJykpOwoKCQkJCWxldCBfbiA9IG51bGw7CgkJCQlpZiAodWlkICYmIHNjb3BlLl9ub2RlcykgewoJCQkJCV9uID0gc2NvcGUuX25vZGVzW3VpZF07CgkJCQl9CgoJCQkJX24gPSBfbiB8fCBzY29wZS5fbm9kZTsKCgkJCQlpZiAoX24pIHsKCQkJCQlsZXQgcElQID0gX24uX19jb25maWcoJ25vRGV0ZWN0JykgPyBudWxsIDogX24uX19jb25maWcoImRldGVjdFBhcmVudC5JUCIpOwoKCQkJCQlpZiAocElQKSB7CgkJCQkJCS8vIG5vZGUgaGFzIGEgcHJlLWNvbmZpZ3VyZWQgcGFyZW50CgkJCQkJCV9uLnBhcmVudChuZXcgb1Njb3BlLk5vZGUoKS5hZGRyZXNzKHBJUCkucG9ydCh0aGlzLl9fY29uZmlnKCdwb3J0JykgfHwgMzAwMCkuY29kZShfbi5fX2NvbmZpZygnZGV0ZWN0UGFyZW50LmNvZGUnKSkudHlwZShuZXcgb1Njb3BlLk5vZGVfVHlwZSgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLm5hbWUoIk5vZGVKUyIpKS5zZWN1cmUoX24uc2VjdXJlKCkpKTsKCQkJCQkJYXdhaXQgX24uX2F1dGhvcml6ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCS8vIG5vZGUgaGFzIG5vIHBhcmVudCwgYnV0IGEgcGFyZW50IHF1ZXJ5IQoJCQkJCQlfbi5wYXJlbnQobmV3IG9TY29wZS5Ob2RlKCkudHlwZShuZXcgb1Njb3BlLk5vZGVfVHlwZSgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLm5hbWUoJ05vZGVKUycpKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5vbmxpbmUobmV3IERhdGUodGhpcy5zcigpLnNlcnZlckRhdGUoKSAtIChvbmxpbmUgfHwgNSkgKiA2MDAwMCksICI+PSIpLmNvZGUoX24uX2NvZGUsICchPScpLmFkZHJlc3MoJycsICchPScpLnBvcnQoJycsICchPScpLnBhcmVudChudWxsKSk7CgkJCQkJfQoKCQkJCQlpZiAodGhpcy5fbG9hZFRvb2xzKSBhd2FpdCB0aGlzLl9sb2FkVG9vbHModGhpcy5fX2NvbmZpZygndG9vbHMuc3RvcmUnLCB0cnVlKSk7CgoJCQkJCWlmIChvU2NvcGUuRXZlbnQpIHsKCQkJCQkJaWYgKHRoaXMuX19jb25maWcoJ2V2ZW50LnBvbGxpbmcuZGlzYWJsZWQnLCB0cnVlKSkgewoJCQkJCQkJYXdhaXQgbmV3IG9TY29wZS5FdmVudCgpLm5hbWUodGhpcy5fX2NvbmZpZygnZXZlbnQnKSB8fCBgJHt0aGlzLlNjb3BlfS5FdmVudGApLmxpc3Rlbihfbik7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlsb2coIlBvbGxpbmcgRXZlbnRzOiAiICsgKHRoaXMuVG9vbC50eXBlID8gdGhpcy5Ub29sLnR5cGUubmFtZSA6ICcnKSk7CgoJCQkJCQkJbGV0IG1lID0gbmV3IG9TY29wZS5Ob2RlKCkuY29kZShvU2NvcGUuX25vZGUuY29kZSgpKTsKCQkJCQkJCWxldCBubWUgPSBuZXcgb1Njb3BlLk5vZGUoKS5jb2RlKG9TY29wZS5fbm9kZS5jb2RlKCksICchPScpOwoJCQkJCQkJbGV0IGV2ID0gbmV3IG9TY29wZS5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLnNlbmRlcihtZSwgJ05PVCBJTicpLnJlY2lwaWVudChtZSkucmVzcG9uc2VUbyhudWxsKTsKCQkJCQkJCWxldCBuZXYgPSBuZXcgb1Njb3BlLkV2ZW50KCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuc2VuZGVyKG1lKS5yZWNpcGllbnQobWUsICdOT1QgSU4nKS5yZXNwb25zZVRvKG51bGwsICdOT1QgSU4nKTsKCQkJCQkJCWxldCBxZXYgPSBldi5yZXNwb25zZVRvX0V2ZW50cyhbbmV2XSwgJ05PVCBJTicpOwoKCQkJCQkJCWZvciBhd2FpdCAoY29uc3QgZSBvZiAoYXdhaXQgcWV2LmZpbmRBbGwoKSkpIHsKCQkJCQkJCQlhd2FpdCBlLnByb2Nlc3MoKTsKCQkJCQkJCX0KCQkJCQkJfQoJCQkJCX0KCQkJCQlpZiAob1Njb3BlLlRyYW5zYWN0aW9uICYmICF0aGlzLl9fY29uZmlnKCdoaXN0b3J5LnBvbGxpbmcuZGlzYWJsZWQnLCB0cnVlKSkgewoJCQkJCQlsb2coIlBvbGxpbmcgVHJhbnNhY3Rpb25zOiAiICsgKHRoaXMuVG9vbC50eXBlID8gdGhpcy5Ub29sLnR5cGUubmFtZSA6ICcnKSk7CgkJCQkJCShhd2FpdCBuZXcgb1Njb3BlLlRyYW5zYWN0aW9uKCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuc3RhdGUobmV3IG9TY29wZS5UcmFuYWN0aW9uU3RhdGUoKS5uYW1lKCJsb2FkZWQiKSkuc2NvcGUodGhpcy5TY29wZSkuY29kZShvU2NvcGUuX25vZGUuY29kZSgpKSkucHJvY2VzcygpOwoJCQkJCX0KCQkJCX0KCgkJCQlpZiAoIV9uIHx8ICFfbi5fY29kZV9zZXQpIHsKCQkJCQlsb2coIkV4aXRpbmcgT25saW5lIEludGVydmFsLi4uIGluaXQoKSBzaG91bGQgYmUgY2FsbGVkIGFnYWluLiIpOwoJCQkJCV9uID0gdW5kZWZpbmVkOwoJCQkJfQoKCQkJCWlmICh0eXBlb2Yob25saW5lKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIW9ubGluZSB8fCBvbmxpbmUgPCAwKSB7CgkJCQkJbG9nKCJOb3QgaW4gb25saW5lIG1vZGUuLi4gZXhpdGluZy4iKTsKCQkJCQlfbiA9IHVuZGVmaW5lZDsKCQkJCX0KCgkJCQlpZiAoc2NvcGUubm9kZUluaXRDYWxscyA+PSB0aGlzLl9fY29uZmlnKCdpbml0LmVuZHMnLCAyKSkgewoJCQkJCWxvZygiRXhjZWVkZWQgY2FsbHMgbGltaXQuLi4gZXhpdGluZy4iKTsKCQkJCQlfbiA9IHVuZGVmaW5lZDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9uKSA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCQkvL2xvZygiRXhpdCBjbGVhbnVwLi4uIik7CgkJCQkJaWYgKG9TY29wZS5fX2Jyb2tlcikgewoJCQkJCQlpZiAob1Njb3BlLl9fYnJva2VyLmRpc2Nvbm5lY3QpIG9TY29wZS5fX2Jyb2tlci5kaXNjb25uZWN0KCk7CgkJCQkJCWlmIChvU2NvcGUuX19icm9rZXIuY2xvc2UpIG9TY29wZS5fX2Jyb2tlci5jbG9zZSgpOwoJCQkJCQlpZiAob1Njb3BlLl9fYnJva2VyLmVuZCkgb1Njb3BlLl9fYnJva2VyLmVuZCgpOwoJCQkJCX0KCQkJCQlyZXR1cm4gZmFsc2U7CgkJCQl9CgoJCQkJb1Njb3BlLlRvb2xzLmZvckVhY2godCA9PiB7CgkJCQkJbGV0IHN0YXRlID0gdGhpcy5fX2NvbmZpZyh0aGlzLl9fY29uZmlnKCdvYXV0aC5yZWRpcmVjdC5zdGF0ZScsIG51bGwsIHsKCQkJCQkJdG9vbDogdAoJCQkJCX0pKTsKCQkJCQlsZXQgY29kZSA9IHRoaXMuX19jb25maWcodGhpcy5fX2NvbmZpZygnb2F1dGgucmVkaXJlY3QuY29kZScsIG51bGwsIHsKCQkJCQkJdG9vbDogdAoJCQkJCX0pKTsKCQkJCQlpZiAoIXN0YXRlIHx8ICFjb2RlKSByZXR1cm47CgkJCQkJaWYgKCFvU2NvcGUuX25vZGUucGFyZW50KCkgfHwgIW9TY29wZS5fbm9kZS5fcGFyZW50Ll9zYW1lTm9kZShvU2NvcGUuX25vZGUucGFyZW50KCkpKSB7CgkJCQkJCWxvZygnbmV3IHBhcmVudCcsIHN0YXRlKTsKCQkJCQkJb1Njb3BlLl9ub2RlLnBhcmVudChuZXcgb1Njb3BlLk5vZGUoKS5jb2RlKHN0YXRlKSk7CgkJCQkJfQoJCQkJCXRoaXMuYXV0aENvZGUoY29kZSk7CgkJCQl9KTsKCgkJCQlhd2FpdCBfbi5vbmxpbmUodGhpcy5zcigpLnNlcnZlckRhdGUoKSkuc3RvcmUoKTsKCQkJCWxvZyhgKCR7X24uX2FkZHJlc3N9OiR7X24uX3BvcnR9KVske19uLl9jb2RlfS8ke19uLklkfV0gaXMgb25saW5lWyR7b25saW5lfV1gKTsKCgkJCQkvL2xvZygibm9kZXMiLCBKU09OLnN0cmluZ2lmeSgoYXdhaXQgbmV3IG9TY29wZS5Ob2RlKCkuZmluZEFsbCgpKS5tYXAobiA9PiBuLl90b0RvY3VtZW50KCkpLCBudWxsLCA0KSk7CgoJCQkJcmV0dXJuIHRydWU7CgkJCX0sIG9ubGluZSwgb1Njb3BlLCB1aWQsIG9ubGluZSk7CgoJCQlyZXR1cm4gbjsKCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXSwKCQkJb25saW5lOiBvbmxpbmUsCgkJCWNvZGU6IGNvZGUsCgkJCXVpZDogdWlkCgkJfSk7CgoJCS8vIHRha2Ugb3V0IHRoZSBpbnZhbGlkIG5vZGUgcmVzdWx0cwoJCXJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIgJiYgci5yZXQpOwoKCQkvLyBoYXMgYW55IG5vZGUgZ2VuZXJhdGVkIGEgdmFsaWRhdGlvbiBleGNlcHRpb24/CgkJbGV0IF9fZXggPSByZXN1bHRzLmZpbmQociA9PiByLnJldC5fX2V4Y2VwdGlvbik7CgkJaWYgKF9fZXgpIHJldHVybiBfX2V4LnJldDsKCgkJcmV0dXJuIHJlc3VsdHMubGVuZ3RoID8gcmVzdWx0c1swXS5yZXQgOiBudWxsOwoKCX0KCgkvKioKCSAqIFN1bW1hcnkuIGF1dGhDb2RlLgoJICoKCSAqIERlc2NyaXB0aW9uLiAuCgkgKgoJICogQHNpbmNlICAgICAgeC54LngKCSAqIEBkZXByZWNhdGVkIHgueC54IFVzZSBuZXdfZnVuY3Rpb25fbmFtZSgpIGluc3RlYWQuCgkgKiBAYWNjZXNzICAgICBwdWJsaWMKCSAqCgkgKiBAY2xhc3MKCSAqIEBhdWdtZW50cyBwYXJlbnQKCSAqIEBtaXhlcyAgICBtaXhpbgoJICoKCSAqIEBhbGlhcyAgICByZWFsTmFtZQoJICogQG1lbWJlcm9mIG5hbWVzcGFjZQoJICoKCSAqIEBzZWUgIEZ1bmN0aW9uL2NsYXNzIHJlbGllZCBvbgoJICogQGxpbmsgVVJMCgkgKiBAZ2xvYmFsCgkgKgoJICogQGZpcmVzICAgZXZlbnROYW1lCgkgKiBAZmlyZXMgICBjbGFzc05hbWUjZXZlbnROYW1lCgkgKiBAbGlzdGVucyBldmVudDpldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGNsYXNzTmFtZX5ldmVudDpldmVudE5hbWUKCSAqIEBwYXJhbSB7dHlwZX0gICB2YXIgICAgICAgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXJdICAgICAgICAgRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUuCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcj1kZWZhdWx0XSBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZSB3aXRoIGRlZmF1bHQgdmFyaWFibGUuCgkgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0VmFyICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBvYmplY3RWYXIua2V5IERlc2NyaXB0aW9uIG9mIGEga2V5IGluIHRoZSBvYmplY3RWYXIgcGFyYW1ldGVyLgoJICoKCSAqIEB5aWVsZCB7dHlwZX0gWWllbGRlZCB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqCgkgKiBAcmV0dXJuIHt0eXBlfSBSZXR1cm4gdmFsdWUgZGVzY3JpcHRpb24uCgkgKi8KCWFzeW5jIGF1dGhDb2RlKGNvZGUpIHsKCgkJbGV0IGFuc3dlciA9IGZhbHNlOwoKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJhdXRoQ29kZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJhdXRoQ29kZSIsIF9ub2RlLCBjb2RlKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlLl9wYXJlbnQpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImF1dGhDb2RlIiwgY29kZSkgPT4gewoKCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGUuYXV0aENvZGUnKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQkJImNvZGUtcmVxdWlyZWQiOiAoKGNvZGUpID0+IHsKCgkJCQkJbGV0IGFuc3dlciA9CgoJCQkJCQl0eXBlb2YoY29kZSkgPT09ICd1bmRlZmluZWQnCgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnYXV0aENvZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgImFuc3dlciIsICJjb2RlLXJlcXVpcmVkIiwgYW5zd2VyKTsKCQkJCQlyZXR1cm4gYW5zd2VyOwoJCQkJfSkoY29kZSkgPyAoJ2NvZGUgaXMgYSByZXF1aXJlZCBQYXJhbWV0ZXInIHx8ICdWYWxpZGF0aW9uIEVycm9yJykgOiAnJywKCgkJCQkiLTAxIjogKChjb2RlKSA9PiB7CgoJCQkJCWxldCBhbnN3ZXIgPQoKCQkJCQkJIWNvZGUKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdhdXRoQ29kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgIi0wMSIsIGFuc3dlcik7CgkJCQkJcmV0dXJuIGFuc3dlcjsKCQkJCX0pKGNvZGUpID8gKCdjb2RlIGlzIGVtcHR5JyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2F1dGhDb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIHsKCQkJCQkJW2tdOiBlcnJvcnNba10KCQkJCQl9KTsKCQkJCQlkZWxldGUgZXJyb3JzW2tdOwoJCQkJfSk7CgkJCQlpZiAoT2JqZWN0LnZhbHVlcyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJCXJldHVybiB7CgkJCQkJCV9fZXhjZXB0aW9uOiBlcnJvcnMsCgkJCQkJfTsKCQkJCX0KCQkJCXJldHVybjsKCQkJfQoKCQkJbG9nKCJHT1QgSEVSRSIsIG9TY29wZS5fbm9kZS5jb2RlKCksIGNvZGUpOwoKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdLAoJCQljb2RlOiBjb2RlCgkJfSk7CgoJCS8vIHRha2Ugb3V0IHRoZSBpbnZhbGlkIG5vZGUgcmVzdWx0cwoJCXJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIgJiYgci5yZXQpOwoKCQkvLyBoYXMgYW55IG5vZGUgZ2VuZXJhdGVkIGEgdmFsaWRhdGlvbiBleGNlcHRpb24/CgkJbGV0IF9fZXggPSByZXN1bHRzLmZpbmQociA9PiByLnJldC5fX2V4Y2VwdGlvbik7CgkJaWYgKF9fZXgpIHJldHVybiBfX2V4LnJldDsKCgkJcmV0dXJuIHJlc3VsdHMubGVuZ3RoID8gcmVzdWx0c1swXS5yZXQgOiBudWxsOwoKCX0KCgkvKioKCSAqIFN1bW1hcnkuIGRhcnRBUEkuCgkgKgoJICogRGVzY3JpcHRpb24uIC4KCSAqCgkgKiBAc2luY2UgICAgICB4LngueAoJICogQGRlcHJlY2F0ZWQgeC54LnggVXNlIG5ld19mdW5jdGlvbl9uYW1lKCkgaW5zdGVhZC4KCSAqIEBhY2Nlc3MgICAgIHB1YmxpYwoJICoKCSAqIEBjbGFzcwoJICogQGF1Z21lbnRzIHBhcmVudAoJICogQG1peGVzICAgIG1peGluCgkgKgoJICogQGFsaWFzICAgIHJlYWxOYW1lCgkgKiBAbWVtYmVyb2YgbmFtZXNwYWNlCgkgKgoJICogQHNlZSAgRnVuY3Rpb24vY2xhc3MgcmVsaWVkIG9uCgkgKiBAbGluayBVUkwKCSAqIEBnbG9iYWwKCSAqCgkgKiBAZmlyZXMgICBldmVudE5hbWUKCSAqIEBmaXJlcyAgIGNsYXNzTmFtZSNldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGV2ZW50OmV2ZW50TmFtZQoJICogQGxpc3RlbnMgY2xhc3NOYW1lfmV2ZW50OmV2ZW50TmFtZQoJICogQHBhcmFtIHt0eXBlfSAgIHZhciAgICAgICAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcl0gICAgICAgICBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyPWRlZmF1bHRdIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlIHdpdGggZGVmYXVsdCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3RWYXIgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIG9iamVjdFZhci5rZXkgRGVzY3JpcHRpb24gb2YgYSBrZXkgaW4gdGhlIG9iamVjdFZhciBwYXJhbWV0ZXIuCgkgKgoJICogQHlpZWxkIHt0eXBlfSBZaWVsZGVkIHZhbHVlIGRlc2NyaXB0aW9uLgoJICoKCSAqIEByZXR1cm4ge3R5cGV9IFJldHVybiB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqLwoJYXN5bmMgZGFydEFQSShzY29wZSkgewoKCQlsZXQgYW5zd2VyID0gbnVsbDsKCgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZGFydEFQSSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJkYXJ0QVBJIiwgX25vZGUsIHNjb3BlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJkYXJ0QVBJIiwgc2NvcGUpID0+IHsKCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlLmRhcnRBUEknKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2RhcnRBUEknLCAnRW50aXR5T2JqZWN0JywgMCwgewoJCQkJCQlba106IGVycm9yc1trXQoJCQkJCX0pOwoJCQkJCWRlbGV0ZSBlcnJvcnNba107CgkJCQl9KTsKCQkJCWlmIChPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIHsKCQkJCQkJX19leGNlcHRpb246IGVycm9ycywKCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlyZXR1cm4gKGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNTdG9yZWRTY3JpcHRGaW5kIiwgbnVsbCwgewoJCQkJTmFtZTogIkRBUlRBUEk6OiIgKyAoc2NvcGUgfHwgb1Njb3BlLl9ub2RlLlNjb3BlKQoJCQl9KSkuU2NyaXB0OwoKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdLAoJCQlzY29wZTogc2NvcGUKCQl9KTsKCgkJLy8gdGFrZSBvdXQgdGhlIGludmFsaWQgbm9kZSByZXN1bHRzCgkJcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gciAmJiByLnJldCk7CgoJCS8vIGhhcyBhbnkgbm9kZSBnZW5lcmF0ZWQgYSB2YWxpZGF0aW9uIGV4Y2VwdGlvbj8KCQlsZXQgX19leCA9IHJlc3VsdHMuZmluZChyID0+IHIucmV0Ll9fZXhjZXB0aW9uKTsKCQlpZiAoX19leCkgcmV0dXJuIF9fZXgucmV0OwoKCQlyZXR1cm4gcmVzdWx0cy5sZW5ndGggPyByZXN1bHRzWzBdLnJldCA6IG51bGw7CgoJfQoKCS8qKgoJICogU3VtbWFyeS4gcmVzdGFydC4KCSAqCgkgKiBEZXNjcmlwdGlvbi4gLgoJICoKCSAqIEBzaW5jZSAgICAgIHgueC54CgkgKiBAZGVwcmVjYXRlZCB4LngueCBVc2UgbmV3X2Z1bmN0aW9uX25hbWUoKSBpbnN0ZWFkLgoJICogQGFjY2VzcyAgICAgcHVibGljCgkgKgoJICogQGNsYXNzCgkgKiBAYXVnbWVudHMgcGFyZW50CgkgKiBAbWl4ZXMgICAgbWl4aW4KCSAqCgkgKiBAYWxpYXMgICAgcmVhbE5hbWUKCSAqIEBtZW1iZXJvZiBuYW1lc3BhY2UKCSAqCgkgKiBAc2VlICBGdW5jdGlvbi9jbGFzcyByZWxpZWQgb24KCSAqIEBsaW5rIFVSTAoJICogQGdsb2JhbAoJICoKCSAqIEBmaXJlcyAgIGV2ZW50TmFtZQoJICogQGZpcmVzICAgY2xhc3NOYW1lI2V2ZW50TmFtZQoJICogQGxpc3RlbnMgZXZlbnQ6ZXZlbnROYW1lCgkgKiBAbGlzdGVucyBjbGFzc05hbWV+ZXZlbnQ6ZXZlbnROYW1lCgkgKiBAcGFyYW0ge3R5cGV9ICAgdmFyICAgICAgICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyXSAgICAgICAgIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXI9ZGVmYXVsdF0gRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUgd2l0aCBkZWZhdWx0IHZhcmlhYmxlLgoJICogQHBhcmFtIHtPYmplY3R9IG9iamVjdFZhciAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgb2JqZWN0VmFyLmtleSBEZXNjcmlwdGlvbiBvZiBhIGtleSBpbiB0aGUgb2JqZWN0VmFyIHBhcmFtZXRlci4KCSAqCgkgKiBAeWllbGQge3R5cGV9IFlpZWxkZWQgdmFsdWUgZGVzY3JpcHRpb24uCgkgKgoJICogQHJldHVybiB7dHlwZX0gUmV0dXJuIHZhbHVlIGRlc2NyaXB0aW9uLgoJICovCglhc3luYyByZXN0YXJ0KCkgewoKCQlsZXQgYW5zd2VyID0gZmFsc2U7CgoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInJlc3RhcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAicmVzdGFydCIsIF9ub2RlLCApID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInJlc3RhcnQiLCApID0+IHsKCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlLnJlc3RhcnQnKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3Jlc3RhcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgewoJCQkJCQlba106IGVycm9yc1trXQoJCQkJCX0pOwoJCQkJCWRlbGV0ZSBlcnJvcnNba107CgkJCQl9KTsKCQkJCWlmIChPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIHsKCQkJCQkJX19leGNlcHRpb246IGVycm9ycywKCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJLy8gV2hlbiBOb2RlSlMgZXhpdHMKCQkJCXByb2Nlc3Mub24oImV4aXQiLCBmdW5jdGlvbigpIHsKCgkJCQkJcmVxdWlyZSgiY2hpbGRfcHJvY2VzcyIpLnNwYXduKHByb2Nlc3MuYXJndi5zaGlmdCgpLCBwcm9jZXNzLmFyZ3YsIHsKCQkJCQkJY3dkOiBwcm9jZXNzLmN3ZCgpLAoJCQkJCQlkZXRhY2hlZDogdHJ1ZSwKCQkJCQkJc3RkaW86ICJpbmhlcml0IgoJCQkJCX0pOwoJCQkJfSk7CgkJCQlwcm9jZXNzLmV4aXQoKTsKCQkJfSwgMTAwMCk7CgoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10sCgkJfSk7CgoJCS8vIHRha2Ugb3V0IHRoZSBpbnZhbGlkIG5vZGUgcmVzdWx0cwoJCXJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIgJiYgci5yZXQpOwoKCQkvLyBoYXMgYW55IG5vZGUgZ2VuZXJhdGVkIGEgdmFsaWRhdGlvbiBleGNlcHRpb24/CgkJbGV0IF9fZXggPSByZXN1bHRzLmZpbmQociA9PiByLnJldC5fX2V4Y2VwdGlvbik7CgkJaWYgKF9fZXgpIHJldHVybiBfX2V4LnJldDsKCgkJcmV0dXJuIHJlc3VsdHMubGVuZ3RoID8gcmVzdWx0c1swXS5yZXQgOiBudWxsOwoKCX0KCgkvKioKCSAqIFN1bW1hcnkuIHN0YXR1cy4KCSAqCgkgKiBEZXNjcmlwdGlvbi4gLgoJICoKCSAqIEBzaW5jZSAgICAgIHgueC54CgkgKiBAZGVwcmVjYXRlZCB4LngueCBVc2UgbmV3X2Z1bmN0aW9uX25hbWUoKSBpbnN0ZWFkLgoJICogQGFjY2VzcyAgICAgcHVibGljCgkgKgoJICogQGNsYXNzCgkgKiBAYXVnbWVudHMgcGFyZW50CgkgKiBAbWl4ZXMgICAgbWl4aW4KCSAqCgkgKiBAYWxpYXMgICAgcmVhbE5hbWUKCSAqIEBtZW1iZXJvZiBuYW1lc3BhY2UKCSAqCgkgKiBAc2VlICBGdW5jdGlvbi9jbGFzcyByZWxpZWQgb24KCSAqIEBsaW5rIFVSTAoJICogQGdsb2JhbAoJICoKCSAqIEBmaXJlcyAgIGV2ZW50TmFtZQoJICogQGZpcmVzICAgY2xhc3NOYW1lI2V2ZW50TmFtZQoJICogQGxpc3RlbnMgZXZlbnQ6ZXZlbnROYW1lCgkgKiBAbGlzdGVucyBjbGFzc05hbWV+ZXZlbnQ6ZXZlbnROYW1lCgkgKiBAcGFyYW0ge3R5cGV9ICAgdmFyICAgICAgICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyXSAgICAgICAgIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXI9ZGVmYXVsdF0gRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUgd2l0aCBkZWZhdWx0IHZhcmlhYmxlLgoJICogQHBhcmFtIHtPYmplY3R9IG9iamVjdFZhciAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgb2JqZWN0VmFyLmtleSBEZXNjcmlwdGlvbiBvZiBhIGtleSBpbiB0aGUgb2JqZWN0VmFyIHBhcmFtZXRlci4KCSAqCgkgKiBAeWllbGQge3R5cGV9IFlpZWxkZWQgdmFsdWUgZGVzY3JpcHRpb24uCgkgKgoJICogQHJldHVybiB7dHlwZX0gUmV0dXJuIHZhbHVlIGRlc2NyaXB0aW9uLgoJICovCglhc3luYyBzdGF0dXMoKSB7CgoJCWxldCBhbnN3ZXIgPSBudWxsOwoKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdGF0dXMiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RhdHVzIiwgX25vZGUsICkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RhdHVzIiwgKSA9PiB7CgoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZS5zdGF0dXMnKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0YXR1cycsICdFbnRpdHlPYmplY3QnLCAwLCB7CgkJCQkJCVtrXTogZXJyb3JzW2tdCgkJCQkJfSk7CgkJCQkJZGVsZXRlIGVycm9yc1trXTsKCQkJCX0pOwoJCQkJaWYgKE9iamVjdC52YWx1ZXMoZXJyb3JzKS5sZW5ndGgpIHsKCQkJCQlyZXR1cm4gewoJCQkJCQlfX2V4Y2VwdGlvbjogZXJyb3JzLAoJCQkJCX07CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJCXJldHVybiB7CgkJCQlfbm9kZTogb1Njb3BlLl9ub2RlID8gb1Njb3BlLl9ub2RlLl9jb2RlIDogbnVsbCwKCQkJCXZlcnNpb246IG9TY29wZS5fX3NjcmlwdC5EYXRlLnRvSVNPU3RyaW5nKCksCgkJCQl0aW1lOiB0aGlzLnNyKCkuc2VydmVyRGF0ZSgpLnRvSVNPU3RyaW5nKCksCgkJCX07CgoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10sCgkJfSk7CgoJCS8vIHRha2Ugb3V0IHRoZSBpbnZhbGlkIG5vZGUgcmVzdWx0cwoJCXJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIgJiYgci5yZXQpOwoKCQkvLyBoYXMgYW55IG5vZGUgZ2VuZXJhdGVkIGEgdmFsaWRhdGlvbiBleGNlcHRpb24/CgkJbGV0IF9fZXggPSByZXN1bHRzLmZpbmQociA9PiByLnJldC5fX2V4Y2VwdGlvbik7CgkJaWYgKF9fZXgpIHJldHVybiBfX2V4LnJldDsKCgkJcmV0dXJuIHJlc3VsdHMubGVuZ3RoID8gcmVzdWx0c1swXS5yZXQgOiBudWxsOwoKCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCgkJCQkJLy8gaWYodGhpc1snXycrZmllbGQrJ19zZXQnXSAmJiAodHlwZW9mKHRoaXNbJ18nK2ZpZWxkXSk9PT0ndW5kZWZpbmVkJyB8fCB0aGlzWydfJytmaWVsZF09PW51bGwpKSByZXR1cm47CgkJCQkJLy8gaWYodHlwZW9mKGVhT2JqKT09PSd1bmRlZmluZWQnKSByZXR1cm47IC8vIHdoeT8KCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCXJldHVybiBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiYWRkcmVzcyIsIG9iaiwgdGhpcy5hZGRyZXNzKCkpOwoKCQlfb3B0aW9ucygicG9ydCIsIG9iaiwgdGhpcy5wb3J0KCkpOwoKCQlfb3B0aW9ucygib25saW5lIiwgb2JqLCB0aGlzLm9ubGluZSgpKTsKCgkJX29wdGlvbnMoInNlY3VyZSIsIG9iaiwgdGhpcy5zZWN1cmUoKSk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiODgwZDlmNjQtYTAxZS00YTk2LTg1ZDMtN2NkMTIwYzg5YmJiIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGUgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGUgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlpZiAoIXRoaXMuYmFja3VwKCkgfHwgKHRoaXMuYmFja3VwKCkKCgkJCQkmJgoJCQkJIXRoaXMuYmFja3VwKCkubm9kZV9Db25maWdzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmJhY2t1cCgpLmNhcnJpZXJfRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmJhY2t1cCgpLnNlbmRlcl9FdmVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuYmFja3VwKCkucmVjaXBpZW50X0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5iYWNrdXAoKS5iYWNrdXBfTm9kZXMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuYmFja3VwKCkucGFyZW50X05vZGVzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmJhY2t1cCgpLm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJiYWNrdXAiLCBvYmosIHRoaXMuYmFja3VwKCkpOwoJCX0KCgkJaWYgKCF0aGlzLnBhcmVudCgpIHx8ICh0aGlzLnBhcmVudCgpCgoJCQkJJiYKCQkJCSF0aGlzLnBhcmVudCgpLm5vZGVfQ29uZmlncygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5wYXJlbnQoKS5jYXJyaWVyX0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5wYXJlbnQoKS5zZW5kZXJfRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnBhcmVudCgpLnJlY2lwaWVudF9FdmVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMucGFyZW50KCkuYmFja3VwX05vZGVzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnBhcmVudCgpLnBhcmVudF9Ob2RlcygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5wYXJlbnQoKS5ub2RlX05vZGVfR3JvdXBfTWVtYmVycygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygicGFyZW50Iiwgb2JqLCB0aGlzLnBhcmVudCgpKTsKCQl9CgoJCWlmICghdGhpcy50eXBlKCkgfHwgKHRoaXMudHlwZSgpCgoJCQkJJiYKCQkJCSF0aGlzLnR5cGUoKS50eXBlX05vZGVzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJ0eXBlIiwgb2JqLCB0aGlzLnR5cGUoKSk7CgkJfQoKCQlfb3B0aW9ucygibm9kZV9Db25maWdzIiwgb2JqLCB0aGlzLm5vZGVfQ29uZmlncygpKTsKCgkJX29wdGlvbnMoImNhcnJpZXJfRXZlbnRzIiwgb2JqLCB0aGlzLmNhcnJpZXJfRXZlbnRzKCkpOwoKCQlfb3B0aW9ucygic2VuZGVyX0V2ZW50cyIsIG9iaiwgdGhpcy5zZW5kZXJfRXZlbnRzKCkpOwoKCQlfb3B0aW9ucygicmVjaXBpZW50X0V2ZW50cyIsIG9iaiwgdGhpcy5yZWNpcGllbnRfRXZlbnRzKCkpOwoKCQlfb3B0aW9ucygiYmFja3VwX05vZGVzIiwgb2JqLCB0aGlzLmJhY2t1cF9Ob2RlcygpKTsKCgkJX29wdGlvbnMoInBhcmVudF9Ob2RlcyIsIG9iaiwgdGhpcy5wYXJlbnRfTm9kZXMoKSk7CgoJCV9vcHRpb25zKCJub2RlX05vZGVfR3JvdXBfTWVtYmVycyIsIG9iaiwgdGhpcy5ub2RlX05vZGVfR3JvdXBfTWVtYmVycygpKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWRkcmVzcycsICdiYWNrdXAnLCAncGFyZW50JywgJ3BvcnQnLCAnb25saW5lJywgJ3NlY3VyZScsICd0eXBlJywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydub2RlX0NvbmZpZ3MnLCAnY2Fycmllcl9FdmVudHMnLCAnc2VuZGVyX0V2ZW50cycsICdyZWNpcGllbnRfRXZlbnRzJywgJ2JhY2t1cF9Ob2RlcycsICdwYXJlbnRfTm9kZXMnLCAnbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIk5vZGUiICYmIChtLnRhcmdldCB8fCBtLm91dFNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSAmJiAoIW0uc291cmNlIHx8IChtLnNvdXJjZSAmJiAvKiFtLm91dFNjcmlwdCAmJiovIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX3NldCddKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5vdXRTY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMsIG9TY29wZSwgbWFwKSA9PiB7JHttLm91dFNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLm91dFNjcmlwdH0pfWApKHRoaXMsIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnNvdXJjZSkgewoJCQkJaWYgKG0uc291cmNlLmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcykgPT4ge3JldHVybiBfdGhpcy4ke20uc291cmNlfTt9YCkodGhpcyk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnNvdXJjZSwgdGhpcyk7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0udGFyZ2V0KSBvYmpbbS50YXJnZXRdID0gcmV0OwoJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQlbbS50YXJnZXQgfHwgbS5zb3VyY2VdOiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10KCQkJfSk7CgkJfSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJLy8gdXNlIHRoaXMuX21hcCgpIHdpdGggcmV2ZXJzZQoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWRkcmVzcyIsIG9iaik7CgoJCV9vcHRpb25zKCJwb3J0Iiwgb2JqKTsKCgkJX29wdGlvbnMoIm9ubGluZSIsIG9iaik7CgoJCV9vcHRpb25zKCJzZWN1cmUiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI4ODBkOWY2NC1hMDFlLTRhOTYtODVkMy03Y2QxMjBjODliYmIiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoImJhY2t1cCIsIG9iaik7CgoJCV9vcHRpb25zKCJwYXJlbnQiLCBvYmopOwoKCQlfb3B0aW9ucygidHlwZSIsIG9iaik7CgoJCV9vcHRpb25zKCJub2RlX0NvbmZpZ3MiLCBvYmopOwoKCQlfb3B0aW9ucygiY2Fycmllcl9FdmVudHMiLCBvYmopOwoKCQlfb3B0aW9ucygic2VuZGVyX0V2ZW50cyIsIG9iaik7CgoJCV9vcHRpb25zKCJyZWNpcGllbnRfRXZlbnRzIiwgb2JqKTsKCgkJX29wdGlvbnMoImJhY2t1cF9Ob2RlcyIsIG9iaik7CgoJCV9vcHRpb25zKCJwYXJlbnRfTm9kZXMiLCBvYmopOwoKCQlfb3B0aW9ucygibm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhZGRyZXNzJywgJ2JhY2t1cCcsICdwYXJlbnQnLCAncG9ydCcsICdvbmxpbmUnLCAnc2VjdXJlJywgJ3R5cGUnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ25vZGVfQ29uZmlncycsICdjYXJyaWVyX0V2ZW50cycsICdzZW5kZXJfRXZlbnRzJywgJ3JlY2lwaWVudF9FdmVudHMnLCAnYmFja3VwX05vZGVzJywgJ3BhcmVudF9Ob2RlcycsICdub2RlX05vZGVfR3JvdXBfTWVtYmVycyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaikpOwoKCQlmYWxzZSAmJiBbXS5jb25jYXQodGhpcy5Ub29sLnR5cGUudHlwZV9NYXBwaW5ncyB8fCBbXSkuY29uY2F0KHRoaXMuVG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5maWx0ZXIobSA9PiBtLmNsYXNzTmFtZSA9PSAiTm9kZSIgJiYgKG0uc291cmNlIHx8IG0uaW5TY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5pblNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmosIG9TY29wZSwgbWFwKSA9PiB7JHttLmluU2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20uaW5TY3JpcHR9KX1gKShvYmosIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnRhcmdldCkgewoJCQkJaWYgKG0udGFyZ2V0LmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmopID0+IHtyZXR1cm4gb2JqLiR7bS50YXJnZXR9O31gKShvYmopOwoJCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqW20udGFyZ2V0XSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0udGFyZ2V0LCBvYmopOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0uc291cmNlKSB7CgkJCQlpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXRoaXNbbS5zb3VyY2VdKHJldCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXNbbS5zb3VyY2VdID0gcmV0OwoJCQkJfQoJCQl9CgkJfSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTm9kZSkgcmV0dXJuOwoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5Ob2RlID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiTm9kZSIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlhZGRyZXNzOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hZGRyZXNzID0gdiA9PSBxdWVyeS5hZGRyZXNzKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FkZHJlc3Nfc2V0ICYmICFxdWVyeS5fYWRkcmVzc19zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWRkcmVzcyA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hZGRyZXNzX3NldCAmJiBxdWVyeS5fYWRkcmVzc19zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFkZHJlc3MgPSBmYWxzZTsKCQkJCX0sCgoJCQkJYmFja3VwOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5iYWNrdXAgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LmJhY2t1cCgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9iYWNrdXBfc2V0ICYmICFxdWVyeS5fYmFja3VwX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5iYWNrdXAgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYmFja3VwX3NldCAmJiBxdWVyeS5fYmFja3VwX3NldCkgfHwKCgkJCQkJCSh0aGlzLmJhY2t1cCgpICYmICF0aGlzLmJhY2t1cCgpLl9tYXRjaGVzKHF1ZXJ5LmJhY2t1cCgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYmFja3VwID0gZmFsc2U7CgkJCQl9LAoKCQkJCXBhcmVudDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucGFyZW50ID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5wYXJlbnQoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcGFyZW50X3NldCAmJiAhcXVlcnkuX3BhcmVudF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucGFyZW50ID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3BhcmVudF9zZXQgJiYgcXVlcnkuX3BhcmVudF9zZXQpIHx8CgoJCQkJCQkodGhpcy5wYXJlbnQoKSAmJiAhdGhpcy5wYXJlbnQoKS5fbWF0Y2hlcyhxdWVyeS5wYXJlbnQoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnBhcmVudCA9IGZhbHNlOwoJCQkJfSwKCgkJCQlwb3J0OiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5wb3J0ID0gdiA9PSBxdWVyeS5wb3J0KCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3BvcnRfc2V0ICYmICFxdWVyeS5fcG9ydF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucG9ydCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9wb3J0X3NldCAmJiBxdWVyeS5fcG9ydF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnBvcnQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb25saW5lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vbmxpbmUgPSB2ID09IHF1ZXJ5Lm9ubGluZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vbmxpbmVfc2V0ICYmICFxdWVyeS5fb25saW5lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vbmxpbmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb25saW5lX3NldCAmJiBxdWVyeS5fb25saW5lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub25saW5lID0gZmFsc2U7CgkJCQl9LAoKCQkJCXNlY3VyZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouc2VjdXJlID0gdiA9PSBxdWVyeS5zZWN1cmUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fc2VjdXJlX3NldCAmJiAhcXVlcnkuX3NlY3VyZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouc2VjdXJlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3NlY3VyZV9zZXQgJiYgcXVlcnkuX3NlY3VyZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnNlY3VyZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQl0eXBlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai50eXBlID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS50eXBlKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3R5cGVfc2V0ICYmICFxdWVyeS5fdHlwZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudHlwZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl90eXBlX3NldCAmJiBxdWVyeS5fdHlwZV9zZXQpIHx8CgoJCQkJCQkodGhpcy50eXBlKCkgJiYgIXRoaXMudHlwZSgpLl9tYXRjaGVzKHF1ZXJ5LnR5cGUoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnR5cGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5vZGVfQ29uZmlnczogKG9iaiwgdikgPT4gewoJCQkJCW9iai5ub2RlX0NvbmZpZ3MgPSB2Lm1hcChfdiA9PiBxdWVyeS5ub2RlX0NvbmZpZ3MoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCQljYXJyaWVyX0V2ZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5jYXJyaWVyX0V2ZW50cyA9IHYubWFwKF92ID0+IHF1ZXJ5LmNhcnJpZXJfRXZlbnRzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQkJc2VuZGVyX0V2ZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5zZW5kZXJfRXZlbnRzID0gdi5tYXAoX3YgPT4gcXVlcnkuc2VuZGVyX0V2ZW50cygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJCXJlY2lwaWVudF9FdmVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoucmVjaXBpZW50X0V2ZW50cyA9IHYubWFwKF92ID0+IHF1ZXJ5LnJlY2lwaWVudF9FdmVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCQliYWNrdXBfTm9kZXM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouYmFja3VwX05vZGVzID0gdi5tYXAoX3YgPT4gcXVlcnkuYmFja3VwX05vZGVzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQkJcGFyZW50X05vZGVzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnBhcmVudF9Ob2RlcyA9IHYubWFwKF92ID0+IHF1ZXJ5LnBhcmVudF9Ob2RlcygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJCW5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzID0gdi5tYXAoX3YgPT4gcXVlcnkubm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWJhY2t1cDogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIGJhY2t1cCIpOwoJCQkJCW9iai5iYWNrdXAgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQlwYXJlbnQ6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBwYXJlbnQiKTsKCQkJCQlvYmoucGFyZW50ID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJdHlwZTogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIHR5cGUiKTsKCQkJCQlvYmoudHlwZSA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCW5vZGVfQ29uZmlnczogKG9iaiwgdikgPT4gewoJCQkJCW9iai5ub2RlX0NvbmZpZ3MgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJCWNhcnJpZXJfRXZlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmNhcnJpZXJfRXZlbnRzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCQlzZW5kZXJfRXZlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnNlbmRlcl9FdmVudHMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJCXJlY2lwaWVudF9FdmVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoucmVjaXBpZW50X0V2ZW50cyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQkJYmFja3VwX05vZGVzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmJhY2t1cF9Ob2RlcyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQkJcGFyZW50X05vZGVzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnBhcmVudF9Ob2RlcyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQkJbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoubm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX2FkZHJlc3Nfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fYmFja3VwX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3BhcmVudF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9wb3J0X3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29ubGluZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9zZWN1cmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fdHlwZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWJhY2t1cDogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLmJhY2t1cChyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJcGFyZW50OiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMucGFyZW50KHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQl0eXBlOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMudHlwZShyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJbm9kZV9Db25maWdzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMubm9kZV9Db25maWdzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCWNhcnJpZXJfRXZlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuY2Fycmllcl9FdmVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJc2VuZGVyX0V2ZW50czogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLnNlbmRlcl9FdmVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJcmVjaXBpZW50X0V2ZW50czogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLnJlY2lwaWVudF9FdmVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJYmFja3VwX05vZGVzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuYmFja3VwX05vZGVzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCXBhcmVudF9Ob2RlczogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLnBhcmVudF9Ob2RlcygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQlub2RlX05vZGVfR3JvdXBfTWVtYmVyczogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ107CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJYWRkcmVzczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FkZHJlc3MnLCB1bmRlZmluZWQpIDogImFkZHJlc3MiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWRkcmVzc19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWRkcmVzcyhyZWYpOwoKCQkJfSwKCgkJCWJhY2t1cDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2JhY2t1cCcsIHVuZGVmaW5lZCkgOiAiYmFja3VwIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2JhY2t1cF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5iYWNrdXAoKSB8fCBuZXcgc2FsZXNub3cuTm9kZSgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuYmFja3VwKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgYmFja3VwIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQlwYXJlbnQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdwYXJlbnQnLCB1bmRlZmluZWQpIDogInBhcmVudCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9wYXJlbnRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMucGFyZW50KCkgfHwgbmV3IHNhbGVzbm93Lk5vZGUoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLnBhcmVudChvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIHBhcmVudCIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJcG9ydDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3BvcnQnLCB1bmRlZmluZWQpIDogInBvcnQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcG9ydF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucG9ydChyZWYpOwoKCQkJfSwKCgkJCW9ubGluZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29ubGluZScsIHVuZGVmaW5lZCkgOiAib25saW5lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29ubGluZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLm9ubGluZShyZWYpOwoKCQkJfSwKCgkJCXNlY3VyZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3NlY3VyZScsIHVuZGVmaW5lZCkgOiAic2VjdXJlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3NlY3VyZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuc2VjdXJlKHJlZik7CgoJCQl9LAoKCQkJdHlwZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpIDogInR5cGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fdHlwZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy50eXBlKCkgfHwgbmV3IHNhbGVzbm93Lk5vZGVfVHlwZSgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMudHlwZShvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIHR5cGUiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvZGUocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kYXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoJCQkJCWlmICh0eXBlb2YobW9tZW50KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZWYgPSBuZXcgRGF0ZShyZWYpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmVmID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpKTsKCQkJCX0KCQkJCXRoaXMuZGF0ZShyZWYpOwoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm5hbWUocmVmKTsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZW1hcmtfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnJlbWFyayhyZWYpOwoKCQkJfSwKCgkJCW5vZGVfQ29uZmlnczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25vZGVfTm9kZXMnLCB1bmRlZmluZWQpIDogIm5vZGVfQ29uZmlncyIpKSA9PiB0aGlzLm5vZGVfQ29uZmlncyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuQ29uZmlnKCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCQljYXJyaWVyX0V2ZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NhcnJpZXJfTm9kZXMnLCB1bmRlZmluZWQpIDogImNhcnJpZXJfRXZlbnRzIikpID0+IHRoaXMuY2Fycmllcl9FdmVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkV2ZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCQlzZW5kZXJfRXZlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnc2VuZGVyX05vZGVzJywgdW5kZWZpbmVkKSA6ICJzZW5kZXJfRXZlbnRzIikpID0+IHRoaXMuc2VuZGVyX0V2ZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuRXZlbnQoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJCXJlY2lwaWVudF9FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZWNpcGllbnRfTm9kZXMnLCB1bmRlZmluZWQpIDogInJlY2lwaWVudF9FdmVudHMiKSkgPT4gdGhpcy5yZWNpcGllbnRfRXZlbnRzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5FdmVudCgpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQkJYmFja3VwX05vZGVzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYmFja3VwX05vZGVzJywgdW5kZWZpbmVkKSA6ICJiYWNrdXBfTm9kZXMiKSkgPT4gdGhpcy5iYWNrdXBfTm9kZXMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJCXBhcmVudF9Ob2RlczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3BhcmVudF9Ob2RlcycsIHVuZGVmaW5lZCkgOiAicGFyZW50X05vZGVzIikpID0+IHRoaXMucGFyZW50X05vZGVzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5Ob2RlKCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCQlub2RlX05vZGVfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25vZGVfTm9kZXMnLCB1bmRlZmluZWQpIDogIm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzIikpID0+IHRoaXMubm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93Lk5vZGVfR3JvdXBfTWVtYmVyKCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddID0gdiwKCgkJCSJhZGRyZXNzIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FkZHJlc3MnLCB1bmRlZmluZWQpIDogImFkZHJlc3MiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWRkcmVzc19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWRkcmVzc19jb29wOwoJCQkJfQoJCQl9LAoKCQkJImJhY2t1cCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdiYWNrdXAnLCB1bmRlZmluZWQpIDogImJhY2t1cCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX2JhY2t1cF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYmFja3VwX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicGFyZW50IjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3BhcmVudCcsIHVuZGVmaW5lZCkgOiAicGFyZW50IikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fcGFyZW50X2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9wYXJlbnRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJwb3J0IjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3BvcnQnLCB1bmRlZmluZWQpIDogInBvcnQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcG9ydF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcG9ydF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9ubGluZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvbmxpbmUnLCB1bmRlZmluZWQpIDogIm9ubGluZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9vbmxpbmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29ubGluZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInNlY3VyZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzZWN1cmUnLCB1bmRlZmluZWQpIDogInNlY3VyZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9zZWN1cmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3NlY3VyZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInR5cGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkgOiAidHlwZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX3R5cGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3R5cGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCW5vZGVfQ29uZmlnczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25vZGVfTm9kZXMnLCB1bmRlZmluZWQpIDogIm5vZGVfQ29uZmlncyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9ub2RlX0NvbmZpZ3NfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25vZGVfQ29uZmlnc19jb29wOwoJCQkJfQoJCQl9LAoKCQkJY2Fycmllcl9FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjYXJyaWVyX05vZGVzJywgdW5kZWZpbmVkKSA6ICJjYXJyaWVyX0V2ZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9jYXJyaWVyX0V2ZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY2Fycmllcl9FdmVudHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJCXNlbmRlcl9FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzZW5kZXJfTm9kZXMnLCB1bmRlZmluZWQpIDogInNlbmRlcl9FdmVudHMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fc2VuZGVyX0V2ZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fc2VuZGVyX0V2ZW50c19jb29wOwoJCQkJfQoJCQl9LAoKCQkJcmVjaXBpZW50X0V2ZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlY2lwaWVudF9Ob2RlcycsIHVuZGVmaW5lZCkgOiAicmVjaXBpZW50X0V2ZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9yZWNpcGllbnRfRXZlbnRzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZWNpcGllbnRfRXZlbnRzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQliYWNrdXBfTm9kZXM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdiYWNrdXBfTm9kZXMnLCB1bmRlZmluZWQpIDogImJhY2t1cF9Ob2RlcyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9iYWNrdXBfTm9kZXNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2JhY2t1cF9Ob2Rlc19jb29wOwoJCQkJfQoJCQl9LAoKCQkJcGFyZW50X05vZGVzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncGFyZW50X05vZGVzJywgdW5kZWZpbmVkKSA6ICJwYXJlbnRfTm9kZXMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fcGFyZW50X05vZGVzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9wYXJlbnRfTm9kZXNfY29vcDsKCQkJCX0KCQkJfSwKCgkJCW5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbm9kZV9Ob2RlcycsIHVuZGVmaW5lZCkgOiAibm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCglieU5vZGUoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX2JhY2t1cCJdICYmIChhWyJfYmFja3VwIl0uRXF1YWxzID8gYVsiX2JhY2t1cCJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfYmFja3VwIl0sIHIpKSkgewoJCQkJCXIuX2JhY2t1cF9Ob2Rlcy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5Tm9kZShhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfcGFyZW50Il0gJiYgKGFbIl9wYXJlbnQiXS5FcXVhbHMgPyBhWyJfcGFyZW50Il0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9wYXJlbnQiXSwgcikpKSB7CgkJCQkJci5fcGFyZW50X05vZGVzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlOb2RlX1R5cGUoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX3R5cGUiXSAmJiAoYVsiX3R5cGUiXS5FcXVhbHMgPyBhWyJfdHlwZSJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfdHlwZSJdLCByKSkpIHsKCQkJCQlyLl90eXBlX05vZGVzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSBmYWxzZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLnR5cGUgPSB7fTsKCQkJaWYgKCF0aGlzLl90eXBlX3NldCkgZXJyb3IudHlwZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghdGhpcy50eXBlKCkpIGVycm9yLnR5cGVbIjAyIl0gPSAiRW1wdHkgVmFsdWUiOwoJCQlpZiAodGhpcy50eXBlKCkgJiYgYlN5bmMgJiYgIXRoaXMudHlwZSgpLl9fc3luY19vbigpKSBlcnJvci50eXBlWyIwMyJdID0gIk5vdCBpbiBTeW5jIjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IudHlwZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IudHlwZTsKCQl9CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSB0cnVlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IuY29kZSA9IHt9OwoJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSBlcnJvci5jb2RlWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5jb2RlKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5jb2RlOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZS5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuTm9kZShudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuY29kZSh0aGlzLmNvZGUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fdHlwZV9zZXQpIHsKCQkJCQl0aGlzLnR5cGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gKCkgPT4gbmV3IG9TY29wZS5Ob2RlX1R5cGUoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5uYW1lKHR5cGVvZihnbG9iYWwpICE9PSAidW5kZWZpbmVkIiA/ICJOb2RlSlMiIDogIkJyb3dzZXIiKS5keW5hbWljKHR5cGVvZihnbG9iYWwpID09PSAidW5kZWZpbmVkIik7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSB7CgkJCQkJdGhpcy5hY3RpdmUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSB7CgkJCQkJdGhpcy5lbmFibGVkKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgewoJCQkJCXRoaXMuZGF0ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSBuZXcgRGF0ZSgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9iYWNrdXBfc2V0ICYmIHRoaXMuYmFja3VwKCkgJiYgIShhd2FpdCB0aGlzLmJhY2t1cCgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX2JhY2t1cCgpOwoKCQkJCQlpZiAodGhpcy5fcGFyZW50X3NldCAmJiB0aGlzLnBhcmVudCgpICYmICEoYXdhaXQgdGhpcy5wYXJlbnQoKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9wYXJlbnQoKTsKCgkJCQkJaWYgKHRoaXMuX3R5cGVfc2V0ICYmIHRoaXMudHlwZSgpICYmICEoYXdhaXQgdGhpcy50eXBlKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfdHlwZSgpOwoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9ub2RlX0NvbmZpZ3Nfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5ub2RlX0NvbmZpZ3MoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuX2NhcnJpZXJfRXZlbnRzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuY2Fycmllcl9FdmVudHMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuX3NlbmRlcl9FdmVudHNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5zZW5kZXJfRXZlbnRzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICh0aGlzLl9yZWNpcGllbnRfRXZlbnRzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMucmVjaXBpZW50X0V2ZW50cygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAodGhpcy5fYmFja3VwX05vZGVzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuYmFja3VwX05vZGVzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICh0aGlzLl9wYXJlbnRfTm9kZXNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5wYXJlbnRfTm9kZXMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMubm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZS5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlLnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZS5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCk7CgkJCQlyZXQgPSByZXQuY29udGVudCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5Ob2RlKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuTm9kZV9Hcm91cCA9IGNsYXNzIE5vZGVfR3JvdXAgZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRc0tpNWZiRzloWkZSdmIyeHpMQ291WVhWMGFFTnZaR1VzUlhabGJuUXViR2x6ZEdWdUxFVjJaVzUwTG5CeWIyTmxjM01zUlhabGJuUXVkSEpwWjJkbGNpSjlgKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5Sk9iMlJsSWpwN0ltNXZSR1YwWldOMElqcDBjblZsTENKcGJtbDBMbVZ1WkhNaU9qSXNJbWx1YVhRdWJHOXZjQ0k2TUM0MUxDSjBiMjlzY3k1emRHOXlaU0k2Wm1Gc2MyVXNJbVJsZEdWamRGQmhjbVZ1ZEM1SlVDSTZJakU0TWk0eE5qZ3VOekF1T0RJaUxDSmtaWFJsWTNSUVlYSmxiblF1WTI5a1pTSTZJbVU0WkdVd05tVXpaV1JqTkRRellXVTVaR1psTVdSbE5XVmpOVEpoTkdKbUlpd2ljMlZqY21WMElqb2liMU5MZDJkYU1uTkxSazlVU1VwallrRm1WVWxSTkVOcU9YRnpTRFE0Ym13aUxDSndiR0Y1WjNKdmRXNWtJanAwY25WbExDSm5VbEJESWpwMGNuVmxMQ0p6ZEc5eVpTNXpaVzV6YVhScGRtbDBlU0k2TVN3aVkyOXRjR0Z1ZVNJNkluSmxjM1Z0WlNKOUxDSkZkbVZ1ZENJNmV5SjBjbWxuWjJWeUxuUnBiV1Z2ZFhRaU9qRXdNREF3TENKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjBzSWxSdmIyd2lPbnNpWjJsMGFIVmlMblJ2YjJ4eklqb2lhSFIwY0hNNkx5OXlZWGN1WjJsMGFIVmlkWE5sY21OdmJuUmxiblF1WTI5dEwyWmhaR2x1TDJaaFpHbHVMbWRwZEdoMVlpNXBieTl0WVhOMFpYSXZJaXdpYzJWamNtVjBJam9pYjFOTGQyZGFNbk5MUms5VVNVcGpZa0ZtVlVsUk5FTnFPWEZ6U0RRNGJtd2lMQ0p3YkdGNVozSnZkVzVrSWpwMGNuVmxMQ0puVWxCRElqcDBjblZsTENKemRHOXlaUzV6Wlc1emFYUnBkbWwwZVNJNk1Td2lZMjl0Y0dGdWVTSTZJbkpsYzNWdFpTSjlMQ0p6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpWYzJWeUlqcDdJbDloZFhSb2IzSnBlbVV1ZFhObGNtNWhiV1VpT2lKbVlXUnBJaXdpWDJGMWRHaHZjbWw2WlM1d1lYTnpkMjl5WkNJNklqRXlNeUlzSWw5aGRYUm9iM0pwZW1VdWRHVnpkRlZ6WlhJaU9uc2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0puWlc1a1pYSWlPbnNpWTI5a1pTSTZJazBpTENKdVlXMWxJam9pVFdGc1pTSjlMQ0pqYjJSbElqb2labUZrYVNJc0ltNWhiV1VpT2lKR1lXUnBJbjE5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpQUVhWMGFGTmhibVFpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgkJdGhpcy5jbGVhcl9ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJOb2RlIEdyb3VwIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQkvLyAodGhpcy5ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzICoqLwoJZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzU4MmJmZGI0LTY1NzMtNDhlZi1iZTcwLTMxNWMwZWM0MmU3ZicgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnTm9kZSBHcm91cCBNZW1iZXInKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX2dyb3VwX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dyb3VwX05vZGVfR3JvdXBfTWVtYmVycycsICdFbnRpdHlPYmplY3QnLCAxLCAiZ3JvdXAgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIk5vZGVfR3JvdXBfTWVtYmVyIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzJywgJ0VudGl0eU9iamVjdCcsIDEsICJncm91cCBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIk5vZGVfR3JvdXBfTWVtYmVyIik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92Lmdyb3VwKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX2dyb3VwX05vZGVfR3JvdXBfTWVtYmVycy5wdXNoKC4uLnYpOwoJCXRoaXMuX2dyb3VwX05vZGVfR3JvdXBfTWVtYmVyc19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMoKSB7CgkJdGhpcy5fZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzX3NldCA9IG51bGw7CgkJdGhpcy5fZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJCXRoaXMuX2dyb3VwX05vZGVfR3JvdXBfTWVtYmVyc19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0Lmdyb3VwX05vZGVfR3JvdXBfTWVtYmVycyA9IHRoaXMuZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQlncm91cF9Ob2RlX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cF9Ob2RlX0dyb3VwcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCAmJiBldmVudC5jbGFzc05hbWUoKSAmJiBldmVudC5jbGFzc05hbWUoKSAhPSAnTm9kZV9Hcm91cCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCXJldHVybiBuZXcgc2FsZXNub3dbZXZlbnQuY2xhc3NOYW1lKCldKCkuX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdyk7CgkJCX0KCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9Ob2RlX0dyb3VwLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7CgoJCQl9CgoJCQkvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8KCgkJCWxldCB2ID0gdW5kZWZpbmVkOwoJCQl0cnkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke21ldGhvZH1gKTsKCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQlsZXQgX2lkID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgZGF0YSwgbWV0aG9kLCB7fSk7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIHsKCQkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKGRhdGEpOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSBkYXRhLl9fdGhpcy5jb2RlIHx8IGRhdGEuaWQgfHwgZGF0YS5JRDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCQlpZiAoZGF0YS5JZCAmJiBkYXRhLklkID09IGRhdGEuSWQpIHsKCQkJCQkJX2lkID0gZGF0YS5JZDsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5FbnRpdHlDbGFzcykgewoJCQkJCQlfaWQgPSBkYXRhLkVudGl0eUNsYXNzLklkIHx8IGRhdGEuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJmOTMzNDJmYS01YTA4LTRjZDItYTY0Mi1iZGYyMjdhYjZjOWUiIHx8ICJOVUxMIjsKCQkJCQl9CgkJCQl9CgoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXAgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXAgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBbbWV0aG9kXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cFttZXRob2RdIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwW21ldGhvZF1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cFttZXRob2RdW19pZF0gfHwge307CgoJCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKHt9LCB7CgkJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJCX0pOwoKCQkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBbbWV0aG9kXVtfaWRdW19oYXNoXTsKCQkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogNSkpIHsKCQkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIG1ldGhvZCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCQl2LnJldXNlZCsrOwoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0KCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSk7CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBbbWV0aG9kXVtfaWRdW19oYXNoXSA9IHsKCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeSh7fSksCgkJCQkJb2JqOiBkYXRhLAoJCQkJCXJldXNlZDogMCwKCQkJCX07CgkJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZGF0YSwgbWV0aG9kLCB7fSwgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBUcmlnZ2VycmluZyAke21ldGhvZH0gdG8gJHtuLmNvZGUoKX0gJHtKU09OLnN0cmluZ2lmeShkYXRhLG51bGwsNCl9YCk7CgoJCQlsZXQgZXYgPSBuZXcgc2FsZXNub3cuRXZlbnQoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSh0aGlzLl9fY29uZmlnKCdldmVudCcpIHx8ICdzYWxlc25vdy5FdmVudCcpLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnJlY2lwaWVudChuKS5tZXRob2QobWV0aG9kKS5jbGFzc05hbWUoJ05vZGVfR3JvdXAnKS5zZW5kZXIoc2FsZXNub3cuX25vZGUpLmNhcnJpZXIoc2FsZXNub3cuX25vZGUpLnBheWxvYWQoZGF0YSk7CgkJCWlmIChldmVudCkgewoJCQkJaWYgKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOwoJCQkJaWYgKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOwoJCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJaWYgKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOwoJCQl9CgkJCXJldCA9IGF3YWl0IGV2LnRyaWdnZXIoKTsKCgkJCWlmICh0eXBlb2YocmV0KSA9PT0gInN0cmluZyIpIHsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCX0KCQkJcmV0dXJuIHJldDsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5Ob2RlX0dyb3VwKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5Ob2RlX0dyb3VwKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX25vZGUpIHsKCQkJLy8gcHJvYmFibHkgc2hvdWxkIG5vdCBiZSBwcm9jZXNzZWQgaGVyZSwgYnV0IHJhdGhlciBjb25zdW1lZCBhcyBwYXJ0IG9mIHRoZSBleGVjdXRlKCkgbG9naWMsIHB1c2hpbmcgX19ub2RlIHRvIHRoZSBsaXN0IG9mIG15IG5vZGVzIHRvIGRlbGVnYXRlIHRvIT8KCQkJbGV0IHRuID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX19ub2RlKS5fZGVSZWZlcmVuY2UoKTsKCQkJZGVsZXRlIF9wYXJhbXMuX19ub2RlOwoJCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93Lk5vZGVfR3JvdXAoKS5faW52b2tlTm9kZSh0biwgbWV0aG9kLCBfcGFyYW1zKTsKCQl9CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYE5vZGVfR3JvdXAuX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBOb2RlX0dyb3VwLl9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXAuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZV9Hcm91cC4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiTm9kZSBHcm91cCIpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQkvLyB0aGlzLmdyb3VwX05vZGVfR3JvdXBzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuTm9kZV9Hcm91cCh0aGlzLklkKQoKCQkJLmFjdGl2ZSh0aGlzLmFjdGl2ZSgpLCB0aGlzLl9hY3RpdmVfY29vcCkKCgkJCS5lbmFibGVkKHRoaXMuZW5hYmxlZCgpLCB0aGlzLl9lbmFibGVkX2Nvb3ApCgoJCQkuY29kZSh0aGlzLmNvZGUoKSwgdGhpcy5fY29kZV9jb29wKQoKCQkJLm9yZGVyKHRoaXMub3JkZXIoKSwgdGhpcy5fb3JkZXJfY29vcCkKCgkJCS5kYXRlKHRoaXMuZGF0ZSgpLCB0aGlzLl9kYXRlX2Nvb3ApCgoJCQkubmFtZSh0aGlzLm5hbWUoKSwgdGhpcy5fbmFtZV9jb29wKQoKCQkJLnJlbWFyayh0aGlzLnJlbWFyaygpLCB0aGlzLl9yZW1hcmtfY29vcCkKCgkJCS5ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnModGhpcy5ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMoKSwgdGhpcy5fZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQlvYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ05vZGVfR3JvdXAnOwoJCXRvb2wgPSB0b29sIHx8IHRoaXMuVG9vbDsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJOb2RlX0dyb3VwIjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCQkJCXJldCA9IHJldC50b0xvd2VyQ2FzZSgpOwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCQl0cnkgewoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgPyAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gb3B0aW9ucy50b29sIHx8IHQgPT0gb3B0aW9ucy50b29sKSA6IHRoaXMuVG9vbDsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sIHx8IHt9OwoKCQkJbGV0IG5JRCA9IHNhbGVzbm93Ll9ub2RlID8gc2FsZXNub3cuX25vZGUuY29kZSgpIDogImRlZmF1bHQiOwoKCQkJbGV0IHJldCA9IG51bGxWYWx1ZTsKCQkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0ID0gbnVsbDsKCgkJCS8vIHRvb2xfQ29uZmlnczogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBkb25lCgkJCWxldCB0Y29uZiA9IChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiBjLm5vZGUgJiYgYy5ub2RlLmNvZGUgPT0gbklEKS5jb25jYXQoKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmICFjLm5vZGUpKTsKCQkJaWYgKHRjb25mLmxlbmd0aCkgewoJCQkJcmV0ID0gdGNvbmZbMF0udmFsdWU7CgkJCQl0cnkgewoJCQkJCVsxLCAyLCAzXS5mb3JFYWNoKGEgPT4gcmV0ID0gSlNPTi5wYXJzZShyZXQpKTsKCQkJCX0gY2F0Y2ggKGpleCkge30KCQkJfQoKCQkJLy8gbW9kZWwgQ29uZmlnOiBDb25maWcgaXMgY2xhc3MgbGV2ZWwsIG5vZGUgbm90IHBvc3NpYmxlIC0gcGVuZGluZwoJCQlsZXQgbWNvbmYgPSB0aGlzLkNvbmZpZyA/IHRoaXMuQ29uZmlnW25dIDogdW5kZWZpbmVkOwoJCQlpZiAodHlwZW9mKG1jb25mKSAhPT0gInVuZGVmaW5lZCIpIHJldCA9IG1jb25mOwoKCQkJLy8gY29tbWFuZCBsaW5lOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyAmJiBnbG9iYWwubWluaW1pc3QpIHsKCQkJCXJldCA9IGdsb2JhbC5taW5pbWlzdChwcm9jZXNzLmFyZ3Yuc2xpY2UoMikpW25dIHx8IHJldDsKCQkJfQoKCQkJLy8gcmVxdWVzdDogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCXJldCA9IHRoaXMuJF9SRVFVRVNUKG4pIHx8IHJldDsKCgkJCWlmIChvcHRpb25zLm5ld1ZhbHVlKSB7CgkJCQlsZXQgdGMgPSB0Y29uZi5sZW5ndGggPyB0Y29uZlswXSA6IHt9OwoJCQkJdGMubm9kZSA9IHsKCQkJCQljb2RlOiBvcHRpb25zLm5vZGUuY29kZSgpCgkJCQl9OwoJCQkJdGMudmFsdWUgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQkJdGMubmFtZSA9IG47CgkJCQlpZiAoIXRjb25mLmxlbmd0aCkgewoJCQkJCW9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MucHVzaCh0Yyk7CgkJCQl9CgkJCQlyZXQgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQl9CgoJCQkvLyBjb25maWcgcmVwbGFjZW1lbnQKCQkJaWYgKHR5cGVvZihyZXQpID09PSAnc3RyaW5nJykocmV0Lm1hdGNoKG5ldyBSZWdFeHAoYHt7KFtefV0rKX19YCwgImciKSkgfHwgW10pLmZvckVhY2gobSA9PiByZXQgPSByZXQucmVwbGFjZShtLCB0aGlzLl9fY29uZmlnKG0ucmVwbGFjZSgne3snLCAnJykucmVwbGFjZSgnfX0nLCAnJyksIG51bGwsIG9wdGlvbnMpKSk7CgoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fY29uZmlnJywgJ0VudGl0eU9iamVjdCcsIDEsIG4sIG51bGxWYWx1ZSwgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncywgZXgpOwoJCX0KCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCgkJCQkJLy8gaWYodGhpc1snXycrZmllbGQrJ19zZXQnXSAmJiAodHlwZW9mKHRoaXNbJ18nK2ZpZWxkXSk9PT0ndW5kZWZpbmVkJyB8fCB0aGlzWydfJytmaWVsZF09PW51bGwpKSByZXR1cm47CgkJCQkJLy8gaWYodHlwZW9mKGVhT2JqKT09PSd1bmRlZmluZWQnKSByZXR1cm47IC8vIHdoeT8KCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCXJldHVybiBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgImY5MzM0MmZhLTVhMDgtNGNkMi1hNjQyLWJkZjIyN2FiNmM5ZSIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cFtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiBvYmosCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIG9iaiwgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIl9USElTIiwgb2JqLCB0aGlzLl9USElTKTsKCgkJX29wdGlvbnMoImdyb3VwX05vZGVfR3JvdXBfTWVtYmVycyIsIG9iaiwgdGhpcy5ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMoKSk7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIk5vZGVfR3JvdXAiICYmIChtLnRhcmdldCB8fCBtLm91dFNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSAmJiAoIW0uc291cmNlIHx8IChtLnNvdXJjZSAmJiAvKiFtLm91dFNjcmlwdCAmJiovIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX3NldCddKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5vdXRTY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMsIG9TY29wZSwgbWFwKSA9PiB7JHttLm91dFNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLm91dFNjcmlwdH0pfWApKHRoaXMsIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnNvdXJjZSkgewoJCQkJaWYgKG0uc291cmNlLmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcykgPT4ge3JldHVybiBfdGhpcy4ke20uc291cmNlfTt9YCkodGhpcyk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnNvdXJjZSwgdGhpcyk7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0udGFyZ2V0KSBvYmpbbS50YXJnZXRdID0gcmV0OwoJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQlbbS50YXJnZXQgfHwgbS5zb3VyY2VdOiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10KCQkJfSk7CgkJfSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJLy8gdXNlIHRoaXMuX21hcCgpIHdpdGggcmV2ZXJzZQoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJmOTMzNDJmYS01YTA4LTRjZDItYTY0Mi1iZGYyMjdhYjZjOWUiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cCB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cFtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoImdyb3VwX05vZGVfR3JvdXBfTWVtYmVycyIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIk5vZGVfR3JvdXAiICYmIChtLnNvdXJjZSB8fCBtLmluU2NyaXB0KSAmJiBtLmFjdGl2ZSAmJiBtLmVuYWJsZWQgJiYgKChtLnRvb2wgJiYgbS50b29sLm5hbWUgPT0gdGhpcy5Ub29sLm5hbWUpIHx8IChtLnR5cGUgJiYgbS50eXBlLm5hbWUgPT0gdGhpcy5Ub29sLnR5cGUubmFtZSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0uaW5TY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAob2JqLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5pblNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLmluU2NyaXB0fSl9YCkob2JqLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS50YXJnZXQpIHsKCQkJCWlmIChtLnRhcmdldC5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAob2JqKSA9PiB7cmV0dXJuIG9iai4ke20udGFyZ2V0fTt9YCkob2JqKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKG9ialttLnRhcmdldF0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gb2JqW20udGFyZ2V0XSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnRhcmdldCwgb2JqKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gb2JqW20udGFyZ2V0XTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnNvdXJjZSkgewoJCQkJaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQl0aGlzW20uc291cmNlXShyZXQpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzW20uc291cmNlXSA9IHJldDsKCQkJCX0KCQkJfQoJCX0pOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLk5vZGVfR3JvdXApIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTm9kZV9Hcm91cCA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIk5vZGUgR3JvdXAiKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCWdyb3VwX05vZGVfR3JvdXBfTWVtYmVyczogKG9iaiwgdikgPT4gewoJCQkJCW9iai5ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMgPSB2Lm1hcChfdiA9PiBxdWVyeS5ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWdyb3VwX05vZGVfR3JvdXBfTWVtYmVyczogKG9iaiwgdikgPT4gewoJCQkJCW9iai5ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ107CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXBfTm9kZV9Hcm91cHMnLCB1bmRlZmluZWQpIDogImdyb3VwX05vZGVfR3JvdXBfTWVtYmVycyIpKSA9PiB0aGlzLmdyb3VwX05vZGVfR3JvdXBfTWVtYmVycyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuTm9kZV9Hcm91cF9NZW1iZXIoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX1RISVM6IChvYmosIHYpID0+IHsKCQkJCWlmIChiVG9vbCkgcmV0dXJuOwoJCQkJb2JqLlRISVMgPSB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQlvYmouT1BFUkFUT1JTLlRISVMgPSB0aGlzLl9USElTX2Nvb3A7CgkJCX0sCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ10gPSB2LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQkJZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXBfTm9kZV9Hcm91cHMnLCB1bmRlZmluZWQpIDogImdyb3VwX05vZGVfR3JvdXBfTWVtYmVycyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2dyb3VwX05vZGVfR3JvdXBfTWVtYmVyc19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSB0cnVlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZV9Hcm91cC5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuTm9kZV9Hcm91cChudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMubmFtZSh0aGlzLm5hbWUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZV9Hcm91cC5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlX0dyb3VwLnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZV9Hcm91cC5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCk7CgkJCQlyZXQgPSByZXQuY29udGVudCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5Ob2RlX0dyb3VwKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuTm9kZV9Hcm91cF9NZW1iZXIgPSBjbGFzcyBOb2RlX0dyb3VwX01lbWJlciBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFzS2k1ZmJHOWhaRlJ2YjJ4ekxDb3VZWFYwYUVOdlpHVXNSWFpsYm5RdWJHbHpkR1Z1TEVWMlpXNTBMbkJ5YjJObGMzTXNSWFpsYm5RdWRISnBaMmRsY2lKOWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKT2IyUmxJanA3SW01dlJHVjBaV04wSWpwMGNuVmxMQ0pwYm1sMExtVnVaSE1pT2pJc0ltbHVhWFF1Ykc5dmNDSTZNQzQxTENKMGIyOXNjeTV6ZEc5eVpTSTZabUZzYzJVc0ltUmxkR1ZqZEZCaGNtVnVkQzVKVUNJNklqRTRNaTR4TmpndU56QXVPRElpTENKa1pYUmxZM1JRWVhKbGJuUXVZMjlrWlNJNkltVTRaR1V3Tm1VelpXUmpORFF6WVdVNVpHWmxNV1JsTldWak5USmhOR0ptSWl3aWMyVmpjbVYwSWpvaWIxTkxkMmRhTW5OTFJrOVVTVXBqWWtGbVZVbFJORU5xT1hGelNEUTRibXdpTENKd2JHRjVaM0p2ZFc1a0lqcDBjblZsTENKblVsQkRJanAwY25WbExDSnpkRzl5WlM1elpXNXphWFJwZG1sMGVTSTZNU3dpWTI5dGNHRnVlU0k2SW5KbGMzVnRaU0o5TENKRmRtVnVkQ0k2ZXlKMGNtbG5aMlZ5TG5ScGJXVnZkWFFpT2pFd01EQXdMQ0p6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMHNJbFJ2YjJ3aU9uc2laMmwwYUhWaUxuUnZiMnh6SWpvaWFIUjBjSE02THk5eVlYY3VaMmwwYUhWaWRYTmxjbU52Ym5SbGJuUXVZMjl0TDJaaFpHbHVMMlpoWkdsdUxtZHBkR2gxWWk1cGJ5OXRZWE4wWlhJdklpd2ljMlZqY21WMElqb2liMU5MZDJkYU1uTkxSazlVU1VwallrRm1WVWxSTkVOcU9YRnpTRFE0Ym13aUxDSndiR0Y1WjNKdmRXNWtJanAwY25WbExDSm5VbEJESWpwMGNuVmxMQ0p6ZEc5eVpTNXpaVzV6YVhScGRtbDBlU0k2TVN3aVkyOXRjR0Z1ZVNJNkluSmxjM1Z0WlNKOUxDSnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlBRWFYwYUZOaGJtUWlMQ0pIYVhSSWRXSWlYUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJncm91cCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZ3JvdXAoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJub2RlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9ub2RlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJOb2RlIEdyb3VwIE1lbWJlciIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJLy8gaWYodGhpcy5fZ3JvdXBfc2V0ICYmIHRoaXMuX2dyb3VwKSB0aGlzLl9ncm91cC5Ub29sID0gdG9vbDsKCgkJLy8gaWYodGhpcy5fbm9kZV9zZXQgJiYgdGhpcy5fbm9kZSkgdGhpcy5fbm9kZS5Ub29sID0gdG9vbDsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJVEhJUyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsKCQlpZiAoIXYpIHJldHVybiB0aGlzOwoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCQl0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KSA9PT0gJ29iamVjdCcgJiYgX3YuRW50aXR5Q2xhc3MgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSA9PSB0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGUgPT0gdGhpcy5TY29wZSk7CgkJaWYgKGNvKSB0aGlzLl9USElTX2Nvb3AgPSBjbzsKCQlyZXR1cm4gdGhpczsKCX0KCgljbGVhcl9USElTKCkgewoJCXRoaXMuX1RISVMgPSBbXTsKCQl0aGlzLl9USElTX2Nvb3AgPSAnJzsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGdyb3VwICoqLwoJZ3JvdXAodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9ncm91cF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImdyb3VwIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnZjkzMzQyZmEtNWEwOC00Y2QyLWE2NDItYmRmMjI3YWI2YzllJyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnTm9kZSBHcm91cCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdncm91cCcsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgImY5MzM0MmZhLTVhMDgtNGNkMi1hNjQyLWJkZjIyN2FiNmM5ZSIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJOb2RlIEdyb3VwIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2dyb3VwICE9IHYpIHsKCQkJCXRoaXMuX2dyb3VwX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ3JvdXAnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX2dyb3VwID8gdGhpcy5fZ3JvdXAuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX2dyb3VwX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9ncm91cCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9ncm91cCk7CgkJfQoJfQoKCWNsZWFyX2dyb3VwKCkgewoJCXRoaXMuX2dyb3VwX3NldCA9IG51bGw7CgkJdGhpcy5fZ3JvdXAgPSBudWxsOwoJCXRoaXMuX2dyb3VwX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBncm91cCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5vZGUgKiovCglub2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbm9kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5vZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc4ODBkOWY2NC1hMDFlLTRhOTYtODVkMy03Y2QxMjBjODliYmInICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdOb2RlJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ25vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICI4ODBkOWY2NC1hMDFlLTRhOTYtODVkMy03Y2QxMjBjODliYmIiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiTm9kZSIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9ub2RlICE9IHYpIHsKCQkJCXRoaXMuX25vZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdub2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9ub2RlID8gdGhpcy5fbm9kZS5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fbm9kZV9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fbm9kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9ub2RlKTsKCQl9Cgl9CgoJY2xlYXJfbm9kZSgpIHsKCQl0aGlzLl9ub2RlX3NldCA9IG51bGw7CgkJdGhpcy5fbm9kZSA9IG51bGw7CgkJdGhpcy5fbm9kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igbm9kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX2dyb3VwX3NldCwKCgkJCXRoaXMuX25vZGVfc2V0LAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX2dyb3VwX3NldCA9IHRoaXMuX2dyb3VwX3NldDsKCQlyZXQuX2dyb3VwX2Nvb3AgPSB0aGlzLl9ncm91cF9jb29wOwoJCXJldC5ncm91cCA9IHRoaXMuZ3JvdXAoKSA/IHRoaXMuZ3JvdXAoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5ncm91cCgpOwoKCQlyZXQuX25vZGVfc2V0ID0gdGhpcy5fbm9kZV9zZXQ7CgkJcmV0Ll9ub2RlX2Nvb3AgPSB0aGlzLl9ub2RlX2Nvb3A7CgkJcmV0Lm5vZGUgPSB0aGlzLm5vZGUoKSA/IHRoaXMubm9kZSgpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLm5vZGUoKTsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkiZ3JvdXAiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJub2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAiZ3JvdXAiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIGdyb3VwJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Ob2RlX0dyb3VwKCkuZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAibm9kZSIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3Igbm9kZScsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuTm9kZSgpLm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkgIT0gJ05vZGVfR3JvdXBfTWVtYmVyJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL05vZGVfR3JvdXBfTWVtYmVyLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7CgoJCQl9CgoJCQkvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8KCgkJCWxldCB2ID0gdW5kZWZpbmVkOwoJCQl0cnkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke21ldGhvZH1gKTsKCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQlsZXQgX2lkID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgZGF0YSwgbWV0aG9kLCB7fSk7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIHsKCQkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKGRhdGEpOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSBkYXRhLl9fdGhpcy5jb2RlIHx8IGRhdGEuaWQgfHwgZGF0YS5JRDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCQlpZiAoZGF0YS5JZCAmJiBkYXRhLklkID09IGRhdGEuSWQpIHsKCQkJCQkJX2lkID0gZGF0YS5JZDsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5FbnRpdHlDbGFzcykgewoJCQkJCQlfaWQgPSBkYXRhLkVudGl0eUNsYXNzLklkIHx8IGRhdGEuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI1ODJiZmRiNC02NTczLTQ4ZWYtYmU3MC0zMTVjMGVjNDJlN2YiIHx8ICJOVUxMIjsKCQkJCQl9CgkJCQl9CgoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlciB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXJbbWV0aG9kXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXJbbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXJbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlclttZXRob2RdW19pZF0gfHwge307CgoJCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKHt9LCB7CgkJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJCX0pOwoKCQkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyW21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlclttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnTm9kZV9Hcm91cF9NZW1iZXInKS5zZW5kZXIoc2FsZXNub3cuX25vZGUpLmNhcnJpZXIoc2FsZXNub3cuX25vZGUpLnBheWxvYWQoZGF0YSk7CgkJCWlmIChldmVudCkgewoJCQkJaWYgKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOwoJCQkJaWYgKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOwoJCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJaWYgKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOwoJCQl9CgkJCXJldCA9IGF3YWl0IGV2LnRyaWdnZXIoKTsKCgkJCWlmICh0eXBlb2YocmV0KSA9PT0gInN0cmluZyIpIHsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCX0KCQkJcmV0dXJuIHJldDsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5Ob2RlX0dyb3VwX01lbWJlcihudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuTm9kZV9Hcm91cF9NZW1iZXIobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuTm9kZV9Hcm91cF9NZW1iZXIoKS5faW52b2tlTm9kZSh0biwgbWV0aG9kLCBfcGFyYW1zKTsKCQl9CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYE5vZGVfR3JvdXBfTWVtYmVyLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgTm9kZV9Hcm91cF9NZW1iZXIuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXIuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZV9Hcm91cF9NZW1iZXIuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIk5vZGUgR3JvdXAgTWVtYmVyIik7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCWlmICh0aGlzLl9ncm91cF9zZXQgJiYgdGhpcy5ncm91cCgpKSB0aGlzLmdyb3VwKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX25vZGVfc2V0ICYmIHRoaXMubm9kZSgpKSB0aGlzLm5vZGUoKS5fX3N5bmNfb24oZCk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93Lk5vZGVfR3JvdXBfTWVtYmVyKHRoaXMuSWQpCgoJCQkuZ3JvdXAodGhpcy5ncm91cCgpLCB0aGlzLl9ncm91cF9jb29wKQoKCQkJLm5vZGUodGhpcy5ub2RlKCksIHRoaXMuX25vZGVfY29vcCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQlvYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ05vZGVfR3JvdXBfTWVtYmVyJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiTm9kZV9Hcm91cF9NZW1iZXIiOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoJCQkJcmV0ID0gcmV0LnRvTG93ZXJDYXNlKCk7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMgPSB7fSkgewoJCXRyeSB7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCA/IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSBvcHRpb25zLnRvb2wgfHwgdCA9PSBvcHRpb25zLnRvb2wpIDogdGhpcy5Ub29sOwoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgfHwge307CgoJCQlsZXQgbklEID0gc2FsZXNub3cuX25vZGUgPyBzYWxlc25vdy5fbm9kZS5jb2RlKCkgOiAiZGVmYXVsdCI7CgoJCQlsZXQgcmV0ID0gbnVsbFZhbHVlOwoJCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXQgPSBudWxsOwoKCQkJLy8gdG9vbF9Db25maWdzOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIGRvbmUKCQkJbGV0IHRjb25mID0gKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmIGMubm9kZSAmJiBjLm5vZGUuY29kZSA9PSBuSUQpLmNvbmNhdCgob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgIWMubm9kZSkpOwoJCQlpZiAodGNvbmYubGVuZ3RoKSB7CgkJCQlyZXQgPSB0Y29uZlswXS52YWx1ZTsKCQkJCXRyeSB7CgkJCQkJWzEsIDIsIDNdLmZvckVhY2goYSA9PiByZXQgPSBKU09OLnBhcnNlKHJldCkpOwoJCQkJfSBjYXRjaCAoamV4KSB7fQoJCQl9CgoJCQkvLyBtb2RlbCBDb25maWc6IENvbmZpZyBpcyBjbGFzcyBsZXZlbCwgbm9kZSBub3QgcG9zc2libGUgLSBwZW5kaW5nCgkJCWxldCBtY29uZiA9IHRoaXMuQ29uZmlnID8gdGhpcy5Db25maWdbbl0gOiB1bmRlZmluZWQ7CgkJCWlmICh0eXBlb2YobWNvbmYpICE9PSAidW5kZWZpbmVkIikgcmV0ID0gbWNvbmY7CgoJCQkvLyBjb21tYW5kIGxpbmU6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnICYmIGdsb2JhbC5taW5pbWlzdCkgewoJCQkJcmV0ID0gZ2xvYmFsLm1pbmltaXN0KHByb2Nlc3MuYXJndi5zbGljZSgyKSlbbl0gfHwgcmV0OwoJCQl9CgoJCQkvLyByZXF1ZXN0OiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJcmV0ID0gdGhpcy4kX1JFUVVFU1QobikgfHwgcmV0OwoKCQkJaWYgKG9wdGlvbnMubmV3VmFsdWUpIHsKCQkJCWxldCB0YyA9IHRjb25mLmxlbmd0aCA/IHRjb25mWzBdIDoge307CgkJCQl0Yy5ub2RlID0gewoJCQkJCWNvZGU6IG9wdGlvbnMubm9kZS5jb2RlKCkKCQkJCX07CgkJCQl0Yy52YWx1ZSA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCQl0Yy5uYW1lID0gbjsKCQkJCWlmICghdGNvbmYubGVuZ3RoKSB7CgkJCQkJb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncy5wdXNoKHRjKTsKCQkJCX0KCQkJCXJldCA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCX0KCgkJCS8vIGNvbmZpZyByZXBsYWNlbWVudAoJCQlpZiAodHlwZW9mKHJldCkgPT09ICdzdHJpbmcnKShyZXQubWF0Y2gobmV3IFJlZ0V4cChge3soW159XSspfX1gLCAiZyIpKSB8fCBbXSkuZm9yRWFjaChtID0+IHJldCA9IHJldC5yZXBsYWNlKG0sIHRoaXMuX19jb25maWcobS5yZXBsYWNlKCd7eycsICcnKS5yZXBsYWNlKCd9fScsICcnKSwgbnVsbCwgb3B0aW9ucykpKTsKCgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19jb25maWcnLCAnRW50aXR5T2JqZWN0JywgMSwgbiwgbnVsbFZhbHVlLCBvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLCBleCk7CgkJfQoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJCQkvLyBpZih0aGlzWydfJytmaWVsZCsnX3NldCddICYmICh0eXBlb2YodGhpc1snXycrZmllbGRdKT09PSd1bmRlZmluZWQnIHx8IHRoaXNbJ18nK2ZpZWxkXT09bnVsbCkpIHJldHVybjsKCQkJCQkvLyBpZih0eXBlb2YoZWFPYmopPT09J3VuZGVmaW5lZCcpIHJldHVybjsgLy8gd2h5PwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiNTgyYmZkYjQtNjU3My00OGVmLWJlNzAtMzE1YzBlYzQyZTdmIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlciB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlcltmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlcltmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXJbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXJbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCWlmICghdGhpcy5ncm91cCgpIHx8ICh0aGlzLmdyb3VwKCkKCgkJCQkmJgoJCQkJIXRoaXMuZ3JvdXAoKS5ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoImdyb3VwIiwgb2JqLCB0aGlzLmdyb3VwKCkpOwoJCX0KCgkJaWYgKCF0aGlzLm5vZGUoKSB8fCAodGhpcy5ub2RlKCkKCgkJCQkmJgoJCQkJIXRoaXMubm9kZSgpLm5vZGVfQ29uZmlncygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5ub2RlKCkuY2Fycmllcl9FdmVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMubm9kZSgpLnNlbmRlcl9FdmVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMubm9kZSgpLnJlY2lwaWVudF9FdmVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMubm9kZSgpLmJhY2t1cF9Ob2RlcygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5ub2RlKCkucGFyZW50X05vZGVzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLm5vZGUoKS5ub2RlX05vZGVfR3JvdXBfTWVtYmVycygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygibm9kZSIsIG9iaiwgdGhpcy5ub2RlKCkpOwoJCX0KCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnZ3JvdXAnLCAnbm9kZScsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJOb2RlX0dyb3VwX01lbWJlciIgJiYgKG0udGFyZ2V0IHx8IG0ub3V0U2NyaXB0KSAmJiBtLmFjdGl2ZSAmJiBtLmVuYWJsZWQgJiYgKChtLnRvb2wgJiYgbS50b29sLm5hbWUgPT0gdGhpcy5Ub29sLm5hbWUpIHx8IChtLnR5cGUgJiYgbS50eXBlLm5hbWUgPT0gdGhpcy5Ub29sLnR5cGUubmFtZSkpICYmICghbS5zb3VyY2UgfHwgKG0uc291cmNlICYmIC8qIW0ub3V0U2NyaXB0ICYmKi8gdGhpc1snXycgKyBtLnNvdXJjZSArICdfc2V0J10pKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLm91dFNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChfdGhpcywgb1Njb3BlLCBtYXApID0+IHske20ub3V0U2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20ub3V0U2NyaXB0fSl9YCkodGhpcywgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0uc291cmNlKSB7CgkJCQlpZiAobS5zb3VyY2UuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzKSA9PiB7cmV0dXJuIF90aGlzLiR7bS5zb3VyY2V9O31gKSh0aGlzKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IHRoaXNbbS5zb3VyY2VdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0uc291cmNlLCB0aGlzKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS50YXJnZXQpIG9ialttLnRhcmdldF0gPSByZXQ7CgkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIG0uc291cmNlICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCVttLnRhcmdldCB8fCBtLnNvdXJjZV06IHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXQoJCQl9KTsKCQl9KTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQkvLyB1c2UgdGhpcy5fbWFwKCkgd2l0aCByZXZlcnNlCgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjU4MmJmZGI0LTY1NzMtNDhlZi1iZTcwLTMxNWMwZWM0MmU3ZiIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlciA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXIgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXJbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXJbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlcltmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlcltmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJncm91cCIsIG9iaik7CgoJCV9vcHRpb25zKCJub2RlIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnZ3JvdXAnLCAnbm9kZScsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJOb2RlX0dyb3VwX01lbWJlciIgJiYgKG0uc291cmNlIHx8IG0uaW5TY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkpLmZvckVhY2gobSA9PiB7CgkJCWxldCByZXQgPSBudWxsOwoJCQlpZiAobS5pblNjcmlwdCkgewoJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmosIG9TY29wZSwgbWFwKSA9PiB7JHttLmluU2NyaXB0LmluY2x1ZGVzKCdyZXR1cm4gJyk/Jyc6J3JldHVybiAnfSgke20uaW5TY3JpcHR9KX1gKShvYmosIHNhbGVzbm93LCBtKTsKCQkJfSBlbHNlIGlmIChtLnRhcmdldCkgewoJCQkJaWYgKG0udGFyZ2V0LmluZGV4T2YoJy4nKSA+IC0xKSB7CgkJCQkJcmV0ID0gdGhpcy5ydW5TY3JpcHQoYChvYmopID0+IHtyZXR1cm4gb2JqLiR7bS50YXJnZXR9O31gKShvYmopOwoJCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqW20udGFyZ2V0XSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdKCk7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihEb3RPYmplY3QpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCXJldCA9IERvdE9iamVjdC5waWNrKG0udGFyZ2V0LCBvYmopOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSBvYmpbbS50YXJnZXRdOwoJCQkJfQoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAnZnVuY3Rpb24nKSByZXQgPSByZXQoKTsKCQkJfQoKCQkJaWYgKG0uc291cmNlKSB7CgkJCQlpZiAodHlwZW9mKHRoaXNbbS5zb3VyY2VdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXRoaXNbbS5zb3VyY2VdKHJldCk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXNbbS5zb3VyY2VdID0gcmV0OwoJCQkJfQoJCQl9CgkJfSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTm9kZV9Hcm91cF9NZW1iZXIpIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTm9kZV9Hcm91cF9NZW1iZXIgPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJOb2RlIEdyb3VwIE1lbWJlciIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlncm91cDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZ3JvdXAgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5Lmdyb3VwKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2dyb3VwX3NldCAmJiAhcXVlcnkuX2dyb3VwX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5ncm91cCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9ncm91cF9zZXQgJiYgcXVlcnkuX2dyb3VwX3NldCkgfHwKCgkJCQkJCSh0aGlzLmdyb3VwKCkgJiYgIXRoaXMuZ3JvdXAoKS5fbWF0Y2hlcyhxdWVyeS5ncm91cCgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZ3JvdXAgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbm9kZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubm9kZSA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkubm9kZSgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9ub2RlX3NldCAmJiAhcXVlcnkuX25vZGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5vZGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbm9kZV9zZXQgJiYgcXVlcnkuX25vZGVfc2V0KSB8fAoKCQkJCQkJKHRoaXMubm9kZSgpICYmICF0aGlzLm5vZGUoKS5fbWF0Y2hlcyhxdWVyeS5ub2RlKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5ub2RlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWFjdGl2ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouYWN0aXZlID0gdiA9PSBxdWVyeS5hY3RpdmUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fYWN0aXZlX3NldCAmJiAhcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2FjdGl2ZV9zZXQgJiYgcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5lbmFibGVkID0gdiA9PSBxdWVyeS5lbmFibGVkKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ICYmICFxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9lbmFibGVkX3NldCAmJiBxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY29kZSA9IHYgPT0gcXVlcnkuY29kZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jb2RlX3NldCAmJiAhcXVlcnkuX2NvZGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY29kZV9zZXQgJiYgcXVlcnkuX2NvZGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vcmRlciA9IHYgPT0gcXVlcnkub3JkZXIoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fb3JkZXJfc2V0ICYmICFxdWVyeS5fb3JkZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX29yZGVyX3NldCAmJiBxdWVyeS5fb3JkZXJfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5kYXRlID0gdiA9PSBxdWVyeS5kYXRlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2RhdGVfc2V0ICYmICFxdWVyeS5fZGF0ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9kYXRlX3NldCAmJiBxdWVyeS5fZGF0ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubmFtZSA9IHYgPT0gcXVlcnkubmFtZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9uYW1lX3NldCAmJiAhcXVlcnkuX25hbWVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbmFtZV9zZXQgJiYgcXVlcnkuX25hbWVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gZmFsc2U7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucmVtYXJrID0gdiA9PSBxdWVyeS5yZW1hcmsoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcmVtYXJrX3NldCAmJiAhcXVlcnkuX3JlbWFya19zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3JlbWFya19zZXQgJiYgcXVlcnkuX3JlbWFya19zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IGZhbHNlOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWdyb3VwOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgZ3JvdXAiKTsKCQkJCQlvYmouZ3JvdXAgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQlub2RlOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3Igbm9kZSIpOwoJCQkJCW9iai5ub2RlID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fZ3JvdXBfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbm9kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWdyb3VwOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMuZ3JvdXAocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCW5vZGU6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5ub2RlKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCWdyb3VwOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpIDogImdyb3VwIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2dyb3VwX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLmdyb3VwKCkgfHwgbmV3IHNhbGVzbm93Lk5vZGVfR3JvdXAoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLmdyb3VwKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgZ3JvdXAiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCW5vZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKSA6ICJub2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25vZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMubm9kZSgpIHx8IG5ldyBzYWxlc25vdy5Ob2RlKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5ub2RlKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2Ugbm9kZSIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQl9LCAiX2Zyb21Eb2N1bWVudCIpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSB7CgkJbGV0IHJldCA9IHt9OwoKCQlpZiAoIWJUb29sKSB7CgkJCXJldC5fX2dlbmVyYXRlZCA9IG5ldyBEYXRlKCk7CgkJCWlmICh0aGlzLlRvb2wubmFtZSkgewoJCQkJcmV0Ll9fdG9vbCA9IHsKCQkJCQluYW1lOiB0aGlzLlRvb2wubmFtZSwKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlpZiAoc2FsZXNub3cuX25vZGUpIHsKCQkJCXJldC5fX25vZGUgPSB7CgkJCQkJY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogYkZ1bGwsCgkJCU51bGw6IGJOdWxsLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXSA9IHYsCgoJCQkiZ3JvdXAiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpIDogImdyb3VwIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fZ3JvdXBfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2dyb3VwX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibm9kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKSA6ICJub2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fbm9kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbm9kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJYnlOb2RlX0dyb3VwKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9ncm91cCJdICYmIChhWyJfZ3JvdXAiXS5FcXVhbHMgPyBhWyJfZ3JvdXAiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX2dyb3VwIl0sIHIpKSkgewoJCQkJCXIuX2dyb3VwX05vZGVfR3JvdXBfTWVtYmVycy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5Tm9kZShhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfbm9kZSJdICYmIChhWyJfbm9kZSJdLkVxdWFscyA/IGFbIl9ub2RlIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9ub2RlIl0sIHIpKSkgewoJCQkJCXIuX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSB0cnVlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IuZ3JvdXAgPSB7fTsKCQkJaWYgKCF0aGlzLl9ncm91cF9zZXQpIGVycm9yLmdyb3VwWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCF0aGlzLmdyb3VwKCkpIGVycm9yLmdyb3VwWyIwMiJdID0gIkVtcHR5IFZhbHVlIjsKCQkJaWYgKHRoaXMuZ3JvdXAoKSAmJiBiU3luYyAmJiAhdGhpcy5ncm91cCgpLl9fc3luY19vbigpKSBlcnJvci5ncm91cFsiMDMiXSA9ICJOb3QgaW4gU3luYyI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLmdyb3VwKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5ncm91cDsKCQl9CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSB0cnVlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3Iubm9kZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25vZGVfc2V0KSBlcnJvci5ub2RlWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCF0aGlzLm5vZGUoKSkgZXJyb3Iubm9kZVsiMDIiXSA9ICJFbXB0eSBWYWx1ZSI7CgkJCWlmICh0aGlzLm5vZGUoKSAmJiBiU3luYyAmJiAhdGhpcy5ub2RlKCkuX19zeW5jX29uKCkpIGVycm9yLm5vZGVbIjAzIl0gPSAiTm90IGluIFN5bmMiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5ub2RlKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5ub2RlOwoJCX0KCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IHRydWU7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlX0dyb3VwX01lbWJlci5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuTm9kZV9Hcm91cF9NZW1iZXIobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLmdyb3VwKHRoaXMuZ3JvdXAoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5ub2RlKHRoaXMubm9kZSgpLCAnPScpOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLm5hbWUodGhpcy5uYW1lKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX2dyb3VwX3NldCAmJiB0aGlzLmdyb3VwKCkgJiYgIShhd2FpdCB0aGlzLmdyb3VwKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfZ3JvdXAoKTsKCgkJCQkJaWYgKHRoaXMuX25vZGVfc2V0ICYmIHRoaXMubm9kZSgpICYmICEoYXdhaXQgdGhpcy5ub2RlKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfbm9kZSgpOwoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGVfR3JvdXBfTWVtYmVyLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGVfR3JvdXBfTWVtYmVyLnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZV9Hcm91cF9NZW1iZXIuZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2ApOwoJCQkJcmV0ID0gcmV0LmNvbnRlbnQgPyBbSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSldIDogW107CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5tYXAociA9PiBuZXcgc2FsZXNub3cuTm9kZV9Hcm91cF9NZW1iZXIobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoKCX0KCn07CgpzYWxlc25vdy5Ob2RlX1R5cGUgPSBjbGFzcyBOb2RlX1R5cGUgZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRc0tpNWZiRzloWkZSdmIyeHpMQ291WVhWMGFFTnZaR1VzUlhabGJuUXViR2x6ZEdWdUxFVjJaVzUwTG5CeWIyTmxjM01zUlhabGJuUXVkSEpwWjJkbGNpSjlgKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5Sk9iMlJsSWpwN0ltNXZSR1YwWldOMElqcDBjblZsTENKcGJtbDBMbVZ1WkhNaU9qSXNJbWx1YVhRdWJHOXZjQ0k2TUM0MUxDSjBiMjlzY3k1emRHOXlaU0k2Wm1Gc2MyVXNJbVJsZEdWamRGQmhjbVZ1ZEM1SlVDSTZJakU0TWk0eE5qZ3VOekF1T0RJaUxDSmtaWFJsWTNSUVlYSmxiblF1WTI5a1pTSTZJbVU0WkdVd05tVXpaV1JqTkRRellXVTVaR1psTVdSbE5XVmpOVEpoTkdKbUlpd2ljMlZqY21WMElqb2liMU5MZDJkYU1uTkxSazlVU1VwallrRm1WVWxSTkVOcU9YRnpTRFE0Ym13aUxDSndiR0Y1WjNKdmRXNWtJanAwY25WbExDSm5VbEJESWpwMGNuVmxMQ0p6ZEc5eVpTNXpaVzV6YVhScGRtbDBlU0k2TVN3aVkyOXRjR0Z1ZVNJNkluSmxjM1Z0WlNKOUxDSkZkbVZ1ZENJNmV5SjBjbWxuWjJWeUxuUnBiV1Z2ZFhRaU9qRXdNREF3TENKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjBzSWxSdmIyd2lPbnNpWjJsMGFIVmlMblJ2YjJ4eklqb2lhSFIwY0hNNkx5OXlZWGN1WjJsMGFIVmlkWE5sY21OdmJuUmxiblF1WTI5dEwyWmhaR2x1TDJaaFpHbHVMbWRwZEdoMVlpNXBieTl0WVhOMFpYSXZJaXdpYzJWamNtVjBJam9pYjFOTGQyZGFNbk5MUms5VVNVcGpZa0ZtVlVsUk5FTnFPWEZ6U0RRNGJtd2lMQ0p3YkdGNVozSnZkVzVrSWpwMGNuVmxMQ0puVWxCRElqcDBjblZsTENKemRHOXlaUzV6Wlc1emFYUnBkbWwwZVNJNk1Td2lZMjl0Y0dGdWVTSTZJbkpsYzNWdFpTSjlMQ0p6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpWYzJWeUlqcDdJbDloZFhSb2IzSnBlbVV1ZFhObGNtNWhiV1VpT2lKbVlXUnBJaXdpWDJGMWRHaHZjbWw2WlM1d1lYTnpkMjl5WkNJNklqRXlNeUlzSWw5aGRYUm9iM0pwZW1VdWRHVnpkRlZ6WlhJaU9uc2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0puWlc1a1pYSWlPbnNpWTI5a1pTSTZJazBpTENKdVlXMWxJam9pVFdGc1pTSjlMQ0pqYjJSbElqb2labUZrYVNJc0ltNWhiV1VpT2lKR1lXUnBJbjE5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpQUVhWMGFGTmhibVFpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZHluYW1pYyIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZHluYW1pYygpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfdHlwZV9Ob2RlcygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIk5vZGUgVHlwZSIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJLy8gKHRoaXMudHlwZV9Ob2RlcygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkeW5hbWljICoqLwoJZHluYW1pYyh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2R5bmFtaWNfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkeW5hbWljIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZHluYW1pYyAhPSB2KSB7CgkJCQl0aGlzLl9keW5hbWljX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9keW5hbWljID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9keW5hbWljKTsKCQl9Cgl9CgoJY2xlYXJfZHluYW1pYygpIHsKCQl0aGlzLl9keW5hbWljX3NldCA9IG51bGw7CgkJdGhpcy5fZHluYW1pYyA9IG51bGw7CgkJdGhpcy5fZHluYW1pY19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZHluYW1pYyAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHR5cGVfTm9kZXMgKiovCgl0eXBlX05vZGVzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl90eXBlX05vZGVzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICc4ODBkOWY2NC1hMDFlLTRhOTYtODVkMy03Y2QxMjBjODliYmInICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ05vZGUnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX3R5cGVfc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndHlwZV9Ob2RlcycsICdFbnRpdHlPYmplY3QnLCAxLCAidHlwZSBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiTm9kZSIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3R5cGVfTm9kZXMnLCAnRW50aXR5T2JqZWN0JywgMSwgInR5cGUgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJOb2RlIik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LnR5cGUodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fdHlwZV9Ob2Rlcy5wdXNoKC4uLnYpOwoJCXRoaXMuX3R5cGVfTm9kZXNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX3R5cGVfTm9kZXNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX3R5cGVfTm9kZXMoKSB7CgkJdGhpcy5fdHlwZV9Ob2Rlc19zZXQgPSBudWxsOwoJCXRoaXMuX3R5cGVfTm9kZXMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl90eXBlX05vZGVzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdHlwZV9Ob2RlcyAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX2R5bmFtaWNfc2V0LAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJCXRoaXMuX3R5cGVfTm9kZXNfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fZHluYW1pY19zZXQgPSB0aGlzLl9keW5hbWljX3NldDsKCQlyZXQuX2R5bmFtaWNfY29vcCA9IHRoaXMuX2R5bmFtaWNfY29vcDsKCQlyZXQuZHluYW1pYyA9IHRoaXMuZHluYW1pYygpID8gdGhpcy5keW5hbWljKCkgOiB0aGlzLmR5bmFtaWMoKTsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0LnR5cGVfTm9kZXMgPSB0aGlzLnR5cGVfTm9kZXMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImR5bmFtaWMiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZHluYW1pYycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCXR5cGVfTm9kZXM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlX05vZGVfVHlwZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkgIT0gJ05vZGVfVHlwZScpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCXJldHVybiBuZXcgc2FsZXNub3dbZXZlbnQuY2xhc3NOYW1lKCldKCkuX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdyk7CgkJCX0KCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9Ob2RlX1R5cGUvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQkJZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOwoJCQkJZGVsZXRlIGRhdGEuX190aGlzLm9ubGluZTsKCgkJCX0KCgkJCS8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/PwoKCQkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJCXRyeSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0pIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7bWV0aG9kfWApOwoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCWxldCBfaWQgPSBudWxsOwoJCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBkYXRhLCBtZXRob2QsIHt9KTsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRhdGEpID09PSAnc3RyaW5nJykgewoJCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUoZGF0YSk7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IGRhdGEuX190aGlzLmNvZGUgfHwgZGF0YS5pZCB8fCBkYXRhLklEOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJCWlmIChkYXRhLklkICYmIGRhdGEuSWQgPT0gZGF0YS5JZCkgewoJCQkJCQlfaWQgPSBkYXRhLklkOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQkJfSBlbHNlIGlmIChkYXRhLkVudGl0eUNsYXNzKSB7CgkJCQkJCV9pZCA9IGRhdGEuRW50aXR5Q2xhc3MuSWQgfHwgZGF0YS5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgImE3YzY4ZjA3LTYyYjMtNGYyYy1iNjQ0LThlNmZmOTcxNTZkZCIgfHwgIk5VTEwiOwoJCQkJCX0KCQkJCX0KCgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGUgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfVHlwZVttZXRob2RdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGVbbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW21ldGhvZF1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW21ldGhvZF1bX2lkXSB8fCB7fTsKCgkJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goe30sIHsKCQkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQkJfSk7CgoJCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGVbbWV0aG9kXVtfaWRdW19oYXNoXSA9IHsKCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeSh7fSksCgkJCQkJb2JqOiBkYXRhLAoJCQkJCXJldXNlZDogMCwKCQkJCX07CgkJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZGF0YSwgbWV0aG9kLCB7fSwgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBUcmlnZ2VycmluZyAke21ldGhvZH0gdG8gJHtuLmNvZGUoKX0gJHtKU09OLnN0cmluZ2lmeShkYXRhLG51bGwsNCl9YCk7CgoJCQlsZXQgZXYgPSBuZXcgc2FsZXNub3cuRXZlbnQoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSh0aGlzLl9fY29uZmlnKCdldmVudCcpIHx8ICdzYWxlc25vdy5FdmVudCcpLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnJlY2lwaWVudChuKS5tZXRob2QobWV0aG9kKS5jbGFzc05hbWUoJ05vZGVfVHlwZScpLnNlbmRlcihzYWxlc25vdy5fbm9kZSkuY2FycmllcihzYWxlc25vdy5fbm9kZSkucGF5bG9hZChkYXRhKTsKCQkJaWYgKGV2ZW50KSB7CgkJCQlpZiAoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7CgkJCQlpZiAoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7CgkJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7CgkJCQlpZiAoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7CgkJCX0KCQkJcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOwoKCQkJaWYgKHR5cGVvZihyZXQpID09PSAic3RyaW5nIikgewoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChleCkge30KCQkJfQoJCQlyZXR1cm4gcmV0OwoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93Lk5vZGVfVHlwZShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuTm9kZV9UeXBlKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX25vZGUpIHsKCQkJLy8gcHJvYmFibHkgc2hvdWxkIG5vdCBiZSBwcm9jZXNzZWQgaGVyZSwgYnV0IHJhdGhlciBjb25zdW1lZCBhcyBwYXJ0IG9mIHRoZSBleGVjdXRlKCkgbG9naWMsIHB1c2hpbmcgX19ub2RlIHRvIHRoZSBsaXN0IG9mIG15IG5vZGVzIHRvIGRlbGVnYXRlIHRvIT8KCQkJbGV0IHRuID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX19ub2RlKS5fZGVSZWZlcmVuY2UoKTsKCQkJZGVsZXRlIF9wYXJhbXMuX19ub2RlOwoJCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93Lk5vZGVfVHlwZSgpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOwoJCX0KCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgTm9kZV9UeXBlLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgTm9kZV9UeXBlLl9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfVHlwZS5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlX1R5cGUuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIk5vZGUgVHlwZSIpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQkvLyB0aGlzLnR5cGVfTm9kZV9UeXBlcygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93Lk5vZGVfVHlwZSh0aGlzLklkKQoKCQkJLmR5bmFtaWModGhpcy5keW5hbWljKCksIHRoaXMuX2R5bmFtaWNfY29vcCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkudHlwZV9Ob2Rlcyh0aGlzLnR5cGVfTm9kZXMoKSwgdGhpcy5fdHlwZV9Ob2Rlc19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCW9ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdOb2RlX1R5cGUnOwoJCXRvb2wgPSB0b29sIHx8IHRoaXMuVG9vbDsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJOb2RlX1R5cGUiOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoJCQkJcmV0ID0gcmV0LnRvTG93ZXJDYXNlKCk7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMgPSB7fSkgewoJCXRyeSB7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCA/IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSBvcHRpb25zLnRvb2wgfHwgdCA9PSBvcHRpb25zLnRvb2wpIDogdGhpcy5Ub29sOwoJCQlvcHRpb25zLnRvb2wgPSBvcHRpb25zLnRvb2wgfHwge307CgoJCQlsZXQgbklEID0gc2FsZXNub3cuX25vZGUgPyBzYWxlc25vdy5fbm9kZS5jb2RlKCkgOiAiZGVmYXVsdCI7CgoJCQlsZXQgcmV0ID0gbnVsbFZhbHVlOwoJCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXQgPSBudWxsOwoKCQkJLy8gdG9vbF9Db25maWdzOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIGRvbmUKCQkJbGV0IHRjb25mID0gKG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MgfHwgW10pLmZpbHRlcihjID0+IGMubmFtZSA9PSBuICYmIGMubm9kZSAmJiBjLm5vZGUuY29kZSA9PSBuSUQpLmNvbmNhdCgob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgIWMubm9kZSkpOwoJCQlpZiAodGNvbmYubGVuZ3RoKSB7CgkJCQlyZXQgPSB0Y29uZlswXS52YWx1ZTsKCQkJCXRyeSB7CgkJCQkJWzEsIDIsIDNdLmZvckVhY2goYSA9PiByZXQgPSBKU09OLnBhcnNlKHJldCkpOwoJCQkJfSBjYXRjaCAoamV4KSB7fQoJCQl9CgoJCQkvLyBtb2RlbCBDb25maWc6IENvbmZpZyBpcyBjbGFzcyBsZXZlbCwgbm9kZSBub3QgcG9zc2libGUgLSBwZW5kaW5nCgkJCWxldCBtY29uZiA9IHRoaXMuQ29uZmlnID8gdGhpcy5Db25maWdbbl0gOiB1bmRlZmluZWQ7CgkJCWlmICh0eXBlb2YobWNvbmYpICE9PSAidW5kZWZpbmVkIikgcmV0ID0gbWNvbmY7CgoJCQkvLyBjb21tYW5kIGxpbmU6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnICYmIGdsb2JhbC5taW5pbWlzdCkgewoJCQkJcmV0ID0gZ2xvYmFsLm1pbmltaXN0KHByb2Nlc3MuYXJndi5zbGljZSgyKSlbbl0gfHwgcmV0OwoJCQl9CgoJCQkvLyByZXF1ZXN0OiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJcmV0ID0gdGhpcy4kX1JFUVVFU1QobikgfHwgcmV0OwoKCQkJaWYgKG9wdGlvbnMubmV3VmFsdWUpIHsKCQkJCWxldCB0YyA9IHRjb25mLmxlbmd0aCA/IHRjb25mWzBdIDoge307CgkJCQl0Yy5ub2RlID0gewoJCQkJCWNvZGU6IG9wdGlvbnMubm9kZS5jb2RlKCkKCQkJCX07CgkJCQl0Yy52YWx1ZSA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCQl0Yy5uYW1lID0gbjsKCQkJCWlmICghdGNvbmYubGVuZ3RoKSB7CgkJCQkJb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncy5wdXNoKHRjKTsKCQkJCX0KCQkJCXJldCA9IG9wdGlvbnMubmV3VmFsdWU7CgkJCX0KCgkJCS8vIGNvbmZpZyByZXBsYWNlbWVudAoJCQlpZiAodHlwZW9mKHJldCkgPT09ICdzdHJpbmcnKShyZXQubWF0Y2gobmV3IFJlZ0V4cChge3soW159XSspfX1gLCAiZyIpKSB8fCBbXSkuZm9yRWFjaChtID0+IHJldCA9IHJldC5yZXBsYWNlKG0sIHRoaXMuX19jb25maWcobS5yZXBsYWNlKCd7eycsICcnKS5yZXBsYWNlKCd9fScsICcnKSwgbnVsbCwgb3B0aW9ucykpKTsKCgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19jb25maWcnLCAnRW50aXR5T2JqZWN0JywgMSwgbiwgbnVsbFZhbHVlLCBvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLCBleCk7CgkJfQoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJCQkvLyBpZih0aGlzWydfJytmaWVsZCsnX3NldCddICYmICh0eXBlb2YodGhpc1snXycrZmllbGRdKT09PSd1bmRlZmluZWQnIHx8IHRoaXNbJ18nK2ZpZWxkXT09bnVsbCkpIHJldHVybjsKCQkJCQkvLyBpZih0eXBlb2YoZWFPYmopPT09J3VuZGVmaW5lZCcpIHJldHVybjsgLy8gd2h5PwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJkeW5hbWljIiwgb2JqLCB0aGlzLmR5bmFtaWMoKSk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiYTdjNjhmMDctNjJiMy00ZjJjLWI2NDQtOGU2ZmY5NzE1NmRkIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfVHlwZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfVHlwZVtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGVbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGVbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGVbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGVbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiBvYmosCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIG9iaiwgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIl9USElTIiwgb2JqLCB0aGlzLl9USElTKTsKCgkJX29wdGlvbnMoInR5cGVfTm9kZXMiLCBvYmosIHRoaXMudHlwZV9Ob2RlcygpKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnZHluYW1pYycsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsndHlwZV9Ob2RlcyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlmYWxzZSAmJiBbXS5jb25jYXQodGhpcy5Ub29sLnR5cGUudHlwZV9NYXBwaW5ncyB8fCBbXSkuY29uY2F0KHRoaXMuVG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5maWx0ZXIobSA9PiBtLmNsYXNzTmFtZSA9PSAiTm9kZV9UeXBlIiAmJiAobS50YXJnZXQgfHwgbS5vdXRTY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkgJiYgKCFtLnNvdXJjZSB8fCAobS5zb3VyY2UgJiYgLyohbS5vdXRTY3JpcHQgJiYqLyB0aGlzWydfJyArIG0uc291cmNlICsgJ19zZXQnXSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0ub3V0U2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5vdXRTY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5vdXRTY3JpcHR9KX1gKSh0aGlzLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS5zb3VyY2UpIHsKCQkJCWlmIChtLnNvdXJjZS5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMpID0+IHtyZXR1cm4gX3RoaXMuJHttLnNvdXJjZX07fWApKHRoaXMpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS5zb3VyY2UsIHRoaXMpOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnRhcmdldCkgb2JqW20udGFyZ2V0XSA9IHJldDsKCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJW20udGFyZ2V0IHx8IG0uc291cmNlXTogdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddCgkJCX0pOwoJCX0pOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCS8vIHVzZSB0aGlzLl9tYXAoKSB3aXRoIHJldmVyc2UKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoImR5bmFtaWMiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJhN2M2OGYwNy02MmIzLTRmMmMtYjY0NC04ZTZmZjk3MTU2ZGQiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGUgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfVHlwZVtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfVHlwZVtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfVHlwZVtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGVbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfVHlwZVtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJ0eXBlX05vZGVzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnZHluYW1pYycsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsndHlwZV9Ob2RlcyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaikpOwoKCQlmYWxzZSAmJiBbXS5jb25jYXQodGhpcy5Ub29sLnR5cGUudHlwZV9NYXBwaW5ncyB8fCBbXSkuY29uY2F0KHRoaXMuVG9vbC50b29sX01hcHBpbmdzIHx8IFtdKS5maWx0ZXIobSA9PiBtLmNsYXNzTmFtZSA9PSAiTm9kZV9UeXBlIiAmJiAobS5zb3VyY2UgfHwgbS5pblNjcmlwdCkgJiYgbS5hY3RpdmUgJiYgbS5lbmFibGVkICYmICgobS50b29sICYmIG0udG9vbC5uYW1lID09IHRoaXMuVG9vbC5uYW1lKSB8fCAobS50eXBlICYmIG0udHlwZS5uYW1lID09IHRoaXMuVG9vbC50eXBlLm5hbWUpKSkuZm9yRWFjaChtID0+IHsKCQkJbGV0IHJldCA9IG51bGw7CgkJCWlmIChtLmluU2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaiwgb1Njb3BlLCBtYXApID0+IHske20uaW5TY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5pblNjcmlwdH0pfWApKG9iaiwgc2FsZXNub3csIG0pOwoJCQl9IGVsc2UgaWYgKG0udGFyZ2V0KSB7CgkJCQlpZiAobS50YXJnZXQuaW5kZXhPZignLicpID4gLTEpIHsKCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKG9iaikgPT4ge3JldHVybiBvYmouJHttLnRhcmdldH07fWApKG9iaik7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmpbbS50YXJnZXRdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS50YXJnZXQsIG9iaik7CgkJCQl9IGVsc2UgewoJCQkJCXJldCA9IG9ialttLnRhcmdldF07CgkJCQl9CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICdmdW5jdGlvbicpIHJldCA9IHJldCgpOwoJCQl9CgoJCQlpZiAobS5zb3VyY2UpIHsKCQkJCWlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0ocmV0KTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpc1ttLnNvdXJjZV0gPSByZXQ7CgkJCQl9CgkJCX0KCQl9KTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5Ob2RlX1R5cGUpIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTm9kZV9UeXBlID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiTm9kZSBUeXBlIikgcmV0dXJuIGZhbHNlOwoKCQkJbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJCUZ1bGw6IHRydWUsCgkJCQlOdWxsOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5faWQgPSB0aGlzLklkID09IHF1ZXJ5LklkLAoKCQkJCWR5bmFtaWM6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmR5bmFtaWMgPSB2ID09IHF1ZXJ5LmR5bmFtaWMoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZHluYW1pY19zZXQgJiYgIXF1ZXJ5Ll9keW5hbWljX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5keW5hbWljID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2R5bmFtaWNfc2V0ICYmIHF1ZXJ5Ll9keW5hbWljX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZHluYW1pYyA9IGZhbHNlOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQkJdHlwZV9Ob2RlczogKG9iaiwgdikgPT4gewoJCQkJCW9iai50eXBlX05vZGVzID0gdi5tYXAoX3YgPT4gcXVlcnkudHlwZV9Ob2RlcygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJdHlwZV9Ob2RlczogKG9iaiwgdikgPT4gewoJCQkJCW9iai50eXBlX05vZGVzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl9keW5hbWljX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJdHlwZV9Ob2RlczogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLnR5cGVfTm9kZXMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlkeW5hbWljOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZHluYW1pYycsIHVuZGVmaW5lZCkgOiAiZHluYW1pYyIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9keW5hbWljX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5keW5hbWljKHJlZik7CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJdHlwZV9Ob2RlczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3R5cGVfTm9kZV9UeXBlcycsIHVuZGVmaW5lZCkgOiAidHlwZV9Ob2RlcyIpKSA9PiB0aGlzLnR5cGVfTm9kZXMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX1RISVM6IChvYmosIHYpID0+IHsKCQkJCWlmIChiVG9vbCkgcmV0dXJuOwoJCQkJb2JqLlRISVMgPSB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQlvYmouT1BFUkFUT1JTLlRISVMgPSB0aGlzLl9USElTX2Nvb3A7CgkJCX0sCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJ10gPSB2LAoKCQkJImR5bmFtaWMiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZHluYW1pYycsIHVuZGVmaW5lZCkgOiAiZHluYW1pYyIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9keW5hbWljX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9keW5hbWljX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3JkZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGw7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIG9ialtlYUNvZGVdID0gb2JqW2VhQ29kZV0ucmVwbGFjZSgvXC5bMC05XSpaL2csICcnKTsKCgkJCQlpZiAodGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGF0ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9uYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9uYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3JlbWFya19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQl0eXBlX05vZGVzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndHlwZV9Ob2RlX1R5cGVzJywgdW5kZWZpbmVkKSA6ICJ0eXBlX05vZGVzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX3R5cGVfTm9kZXNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3R5cGVfTm9kZXNfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gdHJ1ZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLm5hbWUgPSB7fTsKCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgZXJyb3IubmFtZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IubmFtZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IubmFtZTsKCQl9CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGVfVHlwZS5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuTm9kZV9UeXBlKG51bGwsIHRoaXMuVG9vbCk7CgoJCQkJbGV0IGJGaW5kID0gZmFsc2U7CgkJCQlpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLklkID0gdGhpcy5JZDsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5uYW1lKHRoaXMubmFtZSgpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSB7CgkJCQkJdGhpcy5hY3RpdmUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSB7CgkJCQkJdGhpcy5lbmFibGVkKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgewoJCQkJCXRoaXMuZGF0ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSBuZXcgRGF0ZSgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fX2Fzc2VydFZhbGlkKHRydWUpKSByZXR1cm4gbnVsbDsKCgkJCQkvL2F3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8gaW4gY2FzZSBUb29sIGNoYW5nZXMKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgQWJvdXQgdG8gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9YCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgRmluaXNoZWQgSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9IElkPVske3RoaXMuSWR9XWApOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX3R5cGVfTm9kZXNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy50eXBlX05vZGVzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGVfVHlwZS5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlX1R5cGUudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlX1R5cGUuZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2ApOwoJCQkJcmV0ID0gcmV0LmNvbnRlbnQgPyBbSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSldIDogW107CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5tYXAociA9PiBuZXcgc2FsZXNub3cuTm9kZV9UeXBlKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuTWFwcGluZyA9IGNsYXNzIE1hcHBpbmcgZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRc0tpNWZiRzloWkZSdmIyeHpMQ291WVhWMGFFTnZaR1VzUlhabGJuUXViR2x6ZEdWdUxFVjJaVzUwTG5CeWIyTmxjM01zUlhabGJuUXVkSEpwWjJkbGNpSjlgKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5Sk9iMlJsSWpwN0ltNXZSR1YwWldOMElqcDBjblZsTENKcGJtbDBMbVZ1WkhNaU9qSXNJbWx1YVhRdWJHOXZjQ0k2TUM0MUxDSjBiMjlzY3k1emRHOXlaU0k2Wm1Gc2MyVXNJbVJsZEdWamRGQmhjbVZ1ZEM1SlVDSTZJakU0TWk0eE5qZ3VOekF1T0RJaUxDSmtaWFJsWTNSUVlYSmxiblF1WTI5a1pTSTZJbVU0WkdVd05tVXpaV1JqTkRRellXVTVaR1psTVdSbE5XVmpOVEpoTkdKbUlpd2ljMlZqY21WMElqb2liMU5MZDJkYU1uTkxSazlVU1VwallrRm1WVWxSTkVOcU9YRnpTRFE0Ym13aUxDSndiR0Y1WjNKdmRXNWtJanAwY25WbExDSm5VbEJESWpwMGNuVmxMQ0p6ZEc5eVpTNXpaVzV6YVhScGRtbDBlU0k2TVN3aVkyOXRjR0Z1ZVNJNkluSmxjM1Z0WlNKOUxDSkZkbVZ1ZENJNmV5SjBjbWxuWjJWeUxuUnBiV1Z2ZFhRaU9qRXdNREF3TENKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjBzSWxSdmIyd2lPbnNpWjJsMGFIVmlMblJ2YjJ4eklqb2lhSFIwY0hNNkx5OXlZWGN1WjJsMGFIVmlkWE5sY21OdmJuUmxiblF1WTI5dEwyWmhaR2x1TDJaaFpHbHVMbWRwZEdoMVlpNXBieTl0WVhOMFpYSXZJaXdpYzJWamNtVjBJam9pYjFOTGQyZGFNbk5MUms5VVNVcGpZa0ZtVlVsUk5FTnFPWEZ6U0RRNGJtd2lMQ0p3YkdGNVozSnZkVzVrSWpwMGNuVmxMQ0puVWxCRElqcDBjblZsTENKemRHOXlaUzV6Wlc1emFYUnBkbWwwZVNJNk1Td2lZMjl0Y0dGdWVTSTZJbkpsYzNWdFpTSjlMQ0p6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpWYzJWeUlqcDdJbDloZFhSb2IzSnBlbVV1ZFhObGNtNWhiV1VpT2lKbVlXUnBJaXdpWDJGMWRHaHZjbWw2WlM1d1lYTnpkMjl5WkNJNklqRXlNeUlzSWw5aGRYUm9iM0pwZW1VdWRHVnpkRlZ6WlhJaU9uc2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0puWlc1a1pYSWlPbnNpWTI5a1pTSTZJazBpTENKdVlXMWxJam9pVFdGc1pTSjlMQ0pqYjJSbElqb2labUZrYVNJc0ltNWhiV1VpT2lKR1lXUnBJbjE5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpQUVhWMGFGTmhibVFpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3JkZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29yZGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY2xhc3NOYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jbGFzc05hbWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJzY29wZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfc2NvcGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb250ZXh0IiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb250ZXh0KCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAic291cmNlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9zb3VyY2UoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJ0YXJnZXQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3RhcmdldCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9wZXJhdG9yIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcGVyYXRvcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImluU2NyaXB0IiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9pblNjcmlwdCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm91dFNjcmlwdCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3V0U2NyaXB0KCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAidG9vbCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfdG9vbCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInR5cGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3R5cGUoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJNYXBwaW5nIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQkvLyBpZih0aGlzLl90b29sX3NldCAmJiB0aGlzLl90b29sKSB0aGlzLl90b29sLlRvb2wgPSB0b29sOwoKCQkvLyBpZih0aGlzLl90eXBlX3NldCAmJiB0aGlzLl90eXBlKSB0aGlzLl90eXBlLlRvb2wgPSB0b29sOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjbGFzc05hbWUgKiovCgljbGFzc05hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jbGFzc05hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjbGFzc05hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NsYXNzTmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9jbGFzc05hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NsYXNzTmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jbGFzc05hbWUpOwoJCX0KCX0KCgljbGVhcl9jbGFzc05hbWUoKSB7CgkJdGhpcy5fY2xhc3NOYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fY2xhc3NOYW1lID0gbnVsbDsKCQl0aGlzLl9jbGFzc05hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNsYXNzTmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHNjb3BlICoqLwoJc2NvcGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9zY29wZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInNjb3BlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9zY29wZSAhPSB2KSB7CgkJCQl0aGlzLl9zY29wZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fc2NvcGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fc2NvcGUpOwoJCX0KCX0KCgljbGVhcl9zY29wZSgpIHsKCQl0aGlzLl9zY29wZV9zZXQgPSBudWxsOwoJCXRoaXMuX3Njb3BlID0gbnVsbDsKCQl0aGlzLl9zY29wZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc2NvcGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb250ZXh0ICoqLwoJY29udGV4dCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvbnRleHRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb250ZXh0Iik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb250ZXh0ICE9IHYpIHsKCQkJCXRoaXMuX2NvbnRleHRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvbnRleHQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29udGV4dCk7CgkJfQoJfQoKCWNsZWFyX2NvbnRleHQoKSB7CgkJdGhpcy5fY29udGV4dF9zZXQgPSBudWxsOwoJCXRoaXMuX2NvbnRleHQgPSBudWxsOwoJCXRoaXMuX2NvbnRleHRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvbnRleHQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBzb3VyY2UgKiovCglzb3VyY2UodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9zb3VyY2VfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJzb3VyY2UiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3NvdXJjZSAhPSB2KSB7CgkJCQl0aGlzLl9zb3VyY2Vfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3NvdXJjZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9zb3VyY2UpOwoJCX0KCX0KCgljbGVhcl9zb3VyY2UoKSB7CgkJdGhpcy5fc291cmNlX3NldCA9IG51bGw7CgkJdGhpcy5fc291cmNlID0gbnVsbDsKCQl0aGlzLl9zb3VyY2VfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHNvdXJjZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHRhcmdldCAqKi8KCXRhcmdldCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3RhcmdldF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInRhcmdldCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fdGFyZ2V0ICE9IHYpIHsKCQkJCXRoaXMuX3RhcmdldF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fdGFyZ2V0ID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3RhcmdldCk7CgkJfQoJfQoKCWNsZWFyX3RhcmdldCgpIHsKCQl0aGlzLl90YXJnZXRfc2V0ID0gbnVsbDsKCQl0aGlzLl90YXJnZXQgPSBudWxsOwoJCXRoaXMuX3RhcmdldF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdGFyZ2V0ICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3BlcmF0b3IgKiovCglvcGVyYXRvcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29wZXJhdG9yX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3BlcmF0b3IiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29wZXJhdG9yICE9IHYpIHsKCQkJCXRoaXMuX29wZXJhdG9yX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcGVyYXRvciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcGVyYXRvcik7CgkJfQoJfQoKCWNsZWFyX29wZXJhdG9yKCkgewoJCXRoaXMuX29wZXJhdG9yX3NldCA9IG51bGw7CgkJdGhpcy5fb3BlcmF0b3IgPSBudWxsOwoJCXRoaXMuX29wZXJhdG9yX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcGVyYXRvciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGluU2NyaXB0ICoqLwoJaW5TY3JpcHQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9pblNjcmlwdF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImluU2NyaXB0Iik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9pblNjcmlwdCAhPSB2KSB7CgkJCQl0aGlzLl9pblNjcmlwdF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5faW5TY3JpcHQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2luU2NyaXB0KTsKCQl9Cgl9CgoJY2xlYXJfaW5TY3JpcHQoKSB7CgkJdGhpcy5faW5TY3JpcHRfc2V0ID0gbnVsbDsKCQl0aGlzLl9pblNjcmlwdCA9IG51bGw7CgkJdGhpcy5faW5TY3JpcHRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGluU2NyaXB0ICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3V0U2NyaXB0ICoqLwoJb3V0U2NyaXB0KHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3V0U2NyaXB0X2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3V0U2NyaXB0Iik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vdXRTY3JpcHQgIT0gdikgewoJCQkJdGhpcy5fb3V0U2NyaXB0X3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vdXRTY3JpcHQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX291dFNjcmlwdCk7CgkJfQoJfQoKCWNsZWFyX291dFNjcmlwdCgpIHsKCQl0aGlzLl9vdXRTY3JpcHRfc2V0ID0gbnVsbDsKCQl0aGlzLl9vdXRTY3JpcHQgPSBudWxsOwoJCXRoaXMuX291dFNjcmlwdF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3V0U2NyaXB0ICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdG9vbCAqKi8KCXRvb2wodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl90b29sX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgidG9vbCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzY5ZTAyYjQ1LWJjMjAtNDc3Yi1hZWRiLWNkNzI3ODZiNGNmZCcgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ1Rvb2wnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjY5ZTAyYjQ1LWJjMjAtNDc3Yi1hZWRiLWNkNzI3ODZiNGNmZCIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJUb29sIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3Rvb2wgIT0gdikgewoJCQkJdGhpcy5fdG9vbF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3Rvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX3Rvb2wgPyB0aGlzLl90b29sLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl90b29sX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl90b29sID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3Rvb2wpOwoJCX0KCX0KCgljbGVhcl90b29sKCkgewoJCXRoaXMuX3Rvb2xfc2V0ID0gbnVsbDsKCQl0aGlzLl90b29sID0gbnVsbDsKCQl0aGlzLl90b29sX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0b29sICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdHlwZSAqKi8KCXR5cGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl90eXBlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgidHlwZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2YxNjA3NTkxLTMwNDktNDc4Zi05ODlmLThlNjkyMDVhZmMxYicgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ1Rvb2wgVHlwZScpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0eXBlJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiZjE2MDc1OTEtMzA0OS00NzhmLTk4OWYtOGU2OTIwNWFmYzFiIiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIlRvb2wgVHlwZSIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl90eXBlICE9IHYpIHsKCQkJCXRoaXMuX3R5cGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0eXBlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl90eXBlID8gdGhpcy5fdHlwZS5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fdHlwZV9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fdHlwZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl90eXBlKTsKCQl9Cgl9CgoJY2xlYXJfdHlwZSgpIHsKCQl0aGlzLl90eXBlX3NldCA9IG51bGw7CgkJdGhpcy5fdHlwZSA9IG51bGw7CgkJdGhpcy5fdHlwZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdHlwZSAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX2FjdGl2ZV9zZXQsCgoJCQl0aGlzLl9lbmFibGVkX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2NsYXNzTmFtZV9zZXQsCgoJCQl0aGlzLl9zY29wZV9zZXQsCgoJCQl0aGlzLl9jb250ZXh0X3NldCwKCgkJCXRoaXMuX3NvdXJjZV9zZXQsCgoJCQl0aGlzLl90YXJnZXRfc2V0LAoKCQkJdGhpcy5fb3BlcmF0b3Jfc2V0LAoKCQkJdGhpcy5faW5TY3JpcHRfc2V0LAoKCQkJdGhpcy5fb3V0U2NyaXB0X3NldCwKCgkJCXRoaXMuX3Rvb2xfc2V0LAoKCQkJdGhpcy5fdHlwZV9zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9jbGFzc05hbWVfc2V0ID0gdGhpcy5fY2xhc3NOYW1lX3NldDsKCQlyZXQuX2NsYXNzTmFtZV9jb29wID0gdGhpcy5fY2xhc3NOYW1lX2Nvb3A7CgkJcmV0LmNsYXNzTmFtZSA9IHRoaXMuY2xhc3NOYW1lKCkgPyB0aGlzLmNsYXNzTmFtZSgpIDogdGhpcy5jbGFzc05hbWUoKTsKCgkJcmV0Ll9zY29wZV9zZXQgPSB0aGlzLl9zY29wZV9zZXQ7CgkJcmV0Ll9zY29wZV9jb29wID0gdGhpcy5fc2NvcGVfY29vcDsKCQlyZXQuc2NvcGUgPSB0aGlzLnNjb3BlKCkgPyB0aGlzLnNjb3BlKCkgOiB0aGlzLnNjb3BlKCk7CgoJCXJldC5fY29udGV4dF9zZXQgPSB0aGlzLl9jb250ZXh0X3NldDsKCQlyZXQuX2NvbnRleHRfY29vcCA9IHRoaXMuX2NvbnRleHRfY29vcDsKCQlyZXQuY29udGV4dCA9IHRoaXMuY29udGV4dCgpID8gdGhpcy5jb250ZXh0KCkgOiB0aGlzLmNvbnRleHQoKTsKCgkJcmV0Ll9zb3VyY2Vfc2V0ID0gdGhpcy5fc291cmNlX3NldDsKCQlyZXQuX3NvdXJjZV9jb29wID0gdGhpcy5fc291cmNlX2Nvb3A7CgkJcmV0LnNvdXJjZSA9IHRoaXMuc291cmNlKCkgPyB0aGlzLnNvdXJjZSgpIDogdGhpcy5zb3VyY2UoKTsKCgkJcmV0Ll90YXJnZXRfc2V0ID0gdGhpcy5fdGFyZ2V0X3NldDsKCQlyZXQuX3RhcmdldF9jb29wID0gdGhpcy5fdGFyZ2V0X2Nvb3A7CgkJcmV0LnRhcmdldCA9IHRoaXMudGFyZ2V0KCkgPyB0aGlzLnRhcmdldCgpIDogdGhpcy50YXJnZXQoKTsKCgkJcmV0Ll9vcGVyYXRvcl9zZXQgPSB0aGlzLl9vcGVyYXRvcl9zZXQ7CgkJcmV0Ll9vcGVyYXRvcl9jb29wID0gdGhpcy5fb3BlcmF0b3JfY29vcDsKCQlyZXQub3BlcmF0b3IgPSB0aGlzLm9wZXJhdG9yKCkgPyB0aGlzLm9wZXJhdG9yKCkgOiB0aGlzLm9wZXJhdG9yKCk7CgoJCXJldC5faW5TY3JpcHRfc2V0ID0gdGhpcy5faW5TY3JpcHRfc2V0OwoJCXJldC5faW5TY3JpcHRfY29vcCA9IHRoaXMuX2luU2NyaXB0X2Nvb3A7CgkJcmV0LmluU2NyaXB0ID0gdGhpcy5pblNjcmlwdCgpID8gdGhpcy5pblNjcmlwdCgpIDogdGhpcy5pblNjcmlwdCgpOwoKCQlyZXQuX291dFNjcmlwdF9zZXQgPSB0aGlzLl9vdXRTY3JpcHRfc2V0OwoJCXJldC5fb3V0U2NyaXB0X2Nvb3AgPSB0aGlzLl9vdXRTY3JpcHRfY29vcDsKCQlyZXQub3V0U2NyaXB0ID0gdGhpcy5vdXRTY3JpcHQoKSA/IHRoaXMub3V0U2NyaXB0KCkgOiB0aGlzLm91dFNjcmlwdCgpOwoKCQlyZXQuX3Rvb2xfc2V0ID0gdGhpcy5fdG9vbF9zZXQ7CgkJcmV0Ll90b29sX2Nvb3AgPSB0aGlzLl90b29sX2Nvb3A7CgkJcmV0LnRvb2wgPSB0aGlzLnRvb2woKSA/IHRoaXMudG9vbCgpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLnRvb2woKTsKCgkJcmV0Ll90eXBlX3NldCA9IHRoaXMuX3R5cGVfc2V0OwoJCXJldC5fdHlwZV9jb29wID0gdGhpcy5fdHlwZV9jb29wOwoJCXJldC50eXBlID0gdGhpcy50eXBlKCkgPyB0aGlzLnR5cGUoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy50eXBlKCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImNsYXNzTmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbGFzc05hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJzY29wZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzY29wZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImNvbnRleHQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGV4dCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInNvdXJjZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzb3VyY2UnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJ0YXJnZXQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndGFyZ2V0JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3BlcmF0b3IiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3BlcmF0b3InLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJpblNjcmlwdCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdpblNjcmlwdCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm91dFNjcmlwdCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvdXRTY3JpcHQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJ0b29sIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJ0eXBlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJ0b29sIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciB0b29sJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Ub29sKCkudG9vbF9NYXBwaW5ncyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInR5cGUiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIHR5cGUnLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93LlRvb2xfVHlwZSgpLnR5cGVfTWFwcGluZ3ModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCAmJiBldmVudC5jbGFzc05hbWUoKSAmJiBldmVudC5jbGFzc05hbWUoKSAhPSAnTWFwcGluZycpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCXJldHVybiBuZXcgc2FsZXNub3dbZXZlbnQuY2xhc3NOYW1lKCldKCkuX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdyk7CgkJCX0KCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9NYXBwaW5nLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7CgoJCQl9CgoJCQkvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8KCgkJCWxldCB2ID0gdW5kZWZpbmVkOwoJCQl0cnkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke21ldGhvZH1gKTsKCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQlsZXQgX2lkID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgZGF0YSwgbWV0aG9kLCB7fSk7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIHsKCQkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKGRhdGEpOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSBkYXRhLl9fdGhpcy5jb2RlIHx8IGRhdGEuaWQgfHwgZGF0YS5JRDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCQlpZiAoZGF0YS5JZCAmJiBkYXRhLklkID09IGRhdGEuSWQpIHsKCQkJCQkJX2lkID0gZGF0YS5JZDsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5FbnRpdHlDbGFzcykgewoJCQkJCQlfaWQgPSBkYXRhLkVudGl0eUNsYXNzLklkIHx8IGRhdGEuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJmZWI2NzE1Ni1mNzRmLTQ4MzYtOTRhMi0xNGI5ZjIwMDM5ODgiIHx8ICJOVUxMIjsKCQkJCQl9CgkJCQl9CgoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk1hcHBpbmcgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk1hcHBpbmcgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk1hcHBpbmdbbWV0aG9kXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZ1ttZXRob2RdIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nW21ldGhvZF1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZ1ttZXRob2RdW19pZF0gfHwge307CgoJCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKHt9LCB7CgkJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJCX0pOwoKCQkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk1hcHBpbmdbbWV0aG9kXVtfaWRdW19oYXNoXTsKCQkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogNSkpIHsKCQkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIG1ldGhvZCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCQl2LnJldXNlZCsrOwoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0KCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSk7CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk1hcHBpbmdbbWV0aG9kXVtfaWRdW19oYXNoXSA9IHsKCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeSh7fSksCgkJCQkJb2JqOiBkYXRhLAoJCQkJCXJldXNlZDogMCwKCQkJCX07CgkJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZGF0YSwgbWV0aG9kLCB7fSwgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBUcmlnZ2VycmluZyAke21ldGhvZH0gdG8gJHtuLmNvZGUoKX0gJHtKU09OLnN0cmluZ2lmeShkYXRhLG51bGwsNCl9YCk7CgoJCQlsZXQgZXYgPSBuZXcgc2FsZXNub3cuRXZlbnQoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSh0aGlzLl9fY29uZmlnKCdldmVudCcpIHx8ICdzYWxlc25vdy5FdmVudCcpLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnJlY2lwaWVudChuKS5tZXRob2QobWV0aG9kKS5jbGFzc05hbWUoJ01hcHBpbmcnKS5zZW5kZXIoc2FsZXNub3cuX25vZGUpLmNhcnJpZXIoc2FsZXNub3cuX25vZGUpLnBheWxvYWQoZGF0YSk7CgkJCWlmIChldmVudCkgewoJCQkJaWYgKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOwoJCQkJaWYgKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOwoJCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJaWYgKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOwoJCQl9CgkJCXJldCA9IGF3YWl0IGV2LnRyaWdnZXIoKTsKCgkJCWlmICh0eXBlb2YocmV0KSA9PT0gInN0cmluZyIpIHsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCX0KCQkJcmV0dXJuIHJldDsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5NYXBwaW5nKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5NYXBwaW5nKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX25vZGUpIHsKCQkJLy8gcHJvYmFibHkgc2hvdWxkIG5vdCBiZSBwcm9jZXNzZWQgaGVyZSwgYnV0IHJhdGhlciBjb25zdW1lZCBhcyBwYXJ0IG9mIHRoZSBleGVjdXRlKCkgbG9naWMsIHB1c2hpbmcgX19ub2RlIHRvIHRoZSBsaXN0IG9mIG15IG5vZGVzIHRvIGRlbGVnYXRlIHRvIT8KCQkJbGV0IHRuID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX19ub2RlKS5fZGVSZWZlcmVuY2UoKTsKCQkJZGVsZXRlIF9wYXJhbXMuX19ub2RlOwoJCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93Lk1hcHBpbmcoKS5faW52b2tlTm9kZSh0biwgbWV0aG9kLCBfcGFyYW1zKTsKCQl9CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYE1hcHBpbmcuX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBNYXBwaW5nLl9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLk1hcHBpbmcuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuTWFwcGluZy4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiTWFwcGluZyIpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQlpZiAodGhpcy5fdG9vbF9zZXQgJiYgdGhpcy50b29sKCkpIHRoaXMudG9vbCgpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl90eXBlX3NldCAmJiB0aGlzLnR5cGUoKSkgdGhpcy50eXBlKCkuX19zeW5jX29uKGQpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5NYXBwaW5nKHRoaXMuSWQpCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuY2xhc3NOYW1lKHRoaXMuY2xhc3NOYW1lKCksIHRoaXMuX2NsYXNzTmFtZV9jb29wKQoKCQkJLnNjb3BlKHRoaXMuc2NvcGUoKSwgdGhpcy5fc2NvcGVfY29vcCkKCgkJCS5jb250ZXh0KHRoaXMuY29udGV4dCgpLCB0aGlzLl9jb250ZXh0X2Nvb3ApCgoJCQkuc291cmNlKHRoaXMuc291cmNlKCksIHRoaXMuX3NvdXJjZV9jb29wKQoKCQkJLnRhcmdldCh0aGlzLnRhcmdldCgpLCB0aGlzLl90YXJnZXRfY29vcCkKCgkJCS5vcGVyYXRvcih0aGlzLm9wZXJhdG9yKCksIHRoaXMuX29wZXJhdG9yX2Nvb3ApCgoJCQkuaW5TY3JpcHQodGhpcy5pblNjcmlwdCgpLCB0aGlzLl9pblNjcmlwdF9jb29wKQoKCQkJLm91dFNjcmlwdCh0aGlzLm91dFNjcmlwdCgpLCB0aGlzLl9vdXRTY3JpcHRfY29vcCkKCgkJCS50b29sKHRoaXMudG9vbCgpLCB0aGlzLl90b29sX2Nvb3ApCgoJCQkudHlwZSh0aGlzLnR5cGUoKSwgdGhpcy5fdHlwZV9jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCW9ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdNYXBwaW5nJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiTWFwcGluZyI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgkJCQlyZXQgPSByZXQudG9Mb3dlckNhc2UoKTsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucyA9IHt9KSB7CgkJdHJ5IHsKCQkJb3B0aW9ucy50b29sID0gb3B0aW9ucy50b29sID8gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IG9wdGlvbnMudG9vbCB8fCB0ID09IG9wdGlvbnMudG9vbCkgOiB0aGlzLlRvb2w7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCB8fCB7fTsKCgkJCWxldCBuSUQgPSBzYWxlc25vdy5fbm9kZSA/IHNhbGVzbm93Ll9ub2RlLmNvZGUoKSA6ICJkZWZhdWx0IjsKCgkJCWxldCByZXQgPSBudWxsVmFsdWU7CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldCA9IG51bGw7CgoJCQkvLyB0b29sX0NvbmZpZ3M6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gZG9uZQoJCQlsZXQgdGNvbmYgPSAob3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyB8fCBbXSkuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgYy5ub2RlICYmIGMubm9kZS5jb2RlID09IG5JRCkuY29uY2F0KChvcHRpb25zLnRvb2wudG9vbF9Db25maWdzIHx8IFtdKS5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiAhYy5ub2RlKSk7CgkJCWlmICh0Y29uZi5sZW5ndGgpIHsKCQkJCXJldCA9IHRjb25mWzBdLnZhbHVlOwoJCQkJdHJ5IHsKCQkJCQlbMSwgMiwgM10uZm9yRWFjaChhID0+IHJldCA9IEpTT04ucGFyc2UocmV0KSk7CgkJCQl9IGNhdGNoIChqZXgpIHt9CgkJCX0KCgkJCS8vIG1vZGVsIENvbmZpZzogQ29uZmlnIGlzIGNsYXNzIGxldmVsLCBub2RlIG5vdCBwb3NzaWJsZSAtIHBlbmRpbmcKCQkJbGV0IG1jb25mID0gdGhpcy5Db25maWcgPyB0aGlzLkNvbmZpZ1tuXSA6IHVuZGVmaW5lZDsKCQkJaWYgKHR5cGVvZihtY29uZikgIT09ICJ1bmRlZmluZWQiKSByZXQgPSBtY29uZjsKCgkJCS8vIGNvbW1hbmQgbGluZTogYWxsb3cgY2xhc3MtbGV2ZWwgYW5kIG5vZGUtbGV2ZWwgLSBwZW5kaW5nCgkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgZ2xvYmFsLm1pbmltaXN0KSB7CgkJCQlyZXQgPSBnbG9iYWwubWluaW1pc3QocHJvY2Vzcy5hcmd2LnNsaWNlKDIpKVtuXSB8fCByZXQ7CgkJCX0KCgkJCS8vIHJlcXVlc3Q6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlyZXQgPSB0aGlzLiRfUkVRVUVTVChuKSB8fCByZXQ7CgoJCQlpZiAob3B0aW9ucy5uZXdWYWx1ZSkgewoJCQkJbGV0IHRjID0gdGNvbmYubGVuZ3RoID8gdGNvbmZbMF0gOiB7fTsKCQkJCXRjLm5vZGUgPSB7CgkJCQkJY29kZTogb3B0aW9ucy5ub2RlLmNvZGUoKQoJCQkJfTsKCQkJCXRjLnZhbHVlID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJCXRjLm5hbWUgPSBuOwoJCQkJaWYgKCF0Y29uZi5sZW5ndGgpIHsKCQkJCQlvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLnB1c2godGMpOwoJCQkJfQoJCQkJcmV0ID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJfQoKCQkJLy8gY29uZmlnIHJlcGxhY2VtZW50CgkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3N0cmluZycpKHJldC5tYXRjaChuZXcgUmVnRXhwKGB7eyhbXn1dKyl9fWAsICJnIikpIHx8IFtdKS5mb3JFYWNoKG0gPT4gcmV0ID0gcmV0LnJlcGxhY2UobSwgdGhpcy5fX2NvbmZpZyhtLnJlcGxhY2UoJ3t7JywgJycpLnJlcGxhY2UoJ319JywgJycpLCBudWxsLCBvcHRpb25zKSkpOwoKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2NvbmZpZycsICdFbnRpdHlPYmplY3QnLCAxLCBuLCBudWxsVmFsdWUsIG9wdGlvbnMudG9vbC50b29sX0NvbmZpZ3MsIGV4KTsKCQl9Cgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgoJCQkJCS8vIGlmKHRoaXNbJ18nK2ZpZWxkKydfc2V0J10gJiYgKHR5cGVvZih0aGlzWydfJytmaWVsZF0pPT09J3VuZGVmaW5lZCcgfHwgdGhpc1snXycrZmllbGRdPT1udWxsKSkgcmV0dXJuOwoJCQkJCS8vIGlmKHR5cGVvZihlYU9iaik9PT0ndW5kZWZpbmVkJykgcmV0dXJuOyAvLyB3aHk/CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlyZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImNsYXNzTmFtZSIsIG9iaiwgdGhpcy5jbGFzc05hbWUoKSk7CgoJCV9vcHRpb25zKCJzY29wZSIsIG9iaiwgdGhpcy5zY29wZSgpKTsKCgkJX29wdGlvbnMoImNvbnRleHQiLCBvYmosIHRoaXMuY29udGV4dCgpKTsKCgkJX29wdGlvbnMoInNvdXJjZSIsIG9iaiwgdGhpcy5zb3VyY2UoKSk7CgoJCV9vcHRpb25zKCJ0YXJnZXQiLCBvYmosIHRoaXMudGFyZ2V0KCkpOwoKCQlfb3B0aW9ucygib3BlcmF0b3IiLCBvYmosIHRoaXMub3BlcmF0b3IoKSk7CgoJCV9vcHRpb25zKCJpblNjcmlwdCIsIG9iaiwgdGhpcy5pblNjcmlwdCgpKTsKCgkJX29wdGlvbnMoIm91dFNjcmlwdCIsIG9iaiwgdGhpcy5vdXRTY3JpcHQoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJmZWI2NzE1Ni1mNzRmLTQ4MzYtOTRhMi0xNGI5ZjIwMDM5ODgiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZyA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZyB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk1hcHBpbmdbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZ1tmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCWlmICghdGhpcy50b29sKCkgfHwgKHRoaXMudG9vbCgpCgoJCQkJJiYKCQkJCSF0aGlzLnRvb2woKS50b29sX0NvbmZpZ3MoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMudG9vbCgpLnRvb2xfTWFwcGluZ3MoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoInRvb2wiLCBvYmosIHRoaXMudG9vbCgpKTsKCQl9CgoJCWlmICghdGhpcy50eXBlKCkgfHwgKHRoaXMudHlwZSgpCgoJCQkJJiYKCQkJCSF0aGlzLnR5cGUoKS50eXBlX1Rvb2xzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnR5cGUoKS50eXBlX01hcHBpbmdzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJ0eXBlIiwgb2JqLCB0aGlzLnR5cGUoKSk7CgkJfQoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhY3RpdmUnLCAnZW5hYmxlZCcsICdvcmRlcicsICdjbGFzc05hbWUnLCAnc2NvcGUnLCAnY29udGV4dCcsICdzb3VyY2UnLCAndGFyZ2V0JywgJ29wZXJhdG9yJywgJ2luU2NyaXB0JywgJ291dFNjcmlwdCcsICd0b29sJywgJ3R5cGUnXSkuY29uY2F0KFsnJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCWZhbHNlICYmIFtdLmNvbmNhdCh0aGlzLlRvb2wudHlwZS50eXBlX01hcHBpbmdzIHx8IFtdKS5jb25jYXQodGhpcy5Ub29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmZpbHRlcihtID0+IG0uY2xhc3NOYW1lID09ICJNYXBwaW5nIiAmJiAobS50YXJnZXQgfHwgbS5vdXRTY3JpcHQpICYmIG0uYWN0aXZlICYmIG0uZW5hYmxlZCAmJiAoKG0udG9vbCAmJiBtLnRvb2wubmFtZSA9PSB0aGlzLlRvb2wubmFtZSkgfHwgKG0udHlwZSAmJiBtLnR5cGUubmFtZSA9PSB0aGlzLlRvb2wudHlwZS5uYW1lKSkgJiYgKCFtLnNvdXJjZSB8fCAobS5zb3VyY2UgJiYgLyohbS5vdXRTY3JpcHQgJiYqLyB0aGlzWydfJyArIG0uc291cmNlICsgJ19zZXQnXSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0ub3V0U2NyaXB0KSB7CgkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKF90aGlzLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5vdXRTY3JpcHQuaW5jbHVkZXMoJ3JldHVybiAnKT8nJzoncmV0dXJuICd9KCR7bS5vdXRTY3JpcHR9KX1gKSh0aGlzLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS5zb3VyY2UpIHsKCQkJCWlmIChtLnNvdXJjZS5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAoX3RoaXMpID0+IHtyZXR1cm4gX3RoaXMuJHttLnNvdXJjZX07fWApKHRoaXMpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpc1ttLnNvdXJjZV0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gdGhpc1ttLnNvdXJjZV0oKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKERvdE9iamVjdCkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0gRG90T2JqZWN0LnBpY2sobS5zb3VyY2UsIHRoaXMpOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSB0aGlzW20uc291cmNlXTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnRhcmdldCkgb2JqW20udGFyZ2V0XSA9IHJldDsKCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgbS5zb3VyY2UgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJW20udGFyZ2V0IHx8IG0uc291cmNlXTogdGhpc1snXycgKyBtLnNvdXJjZSArICdfY29vcCddCgkJCX0pOwoJCX0pOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCS8vIHVzZSB0aGlzLl9tYXAoKSB3aXRoIHJldmVyc2UKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImNsYXNzTmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJzY29wZSIsIG9iaik7CgoJCV9vcHRpb25zKCJjb250ZXh0Iiwgb2JqKTsKCgkJX29wdGlvbnMoInNvdXJjZSIsIG9iaik7CgoJCV9vcHRpb25zKCJ0YXJnZXQiLCBvYmopOwoKCQlfb3B0aW9ucygib3BlcmF0b3IiLCBvYmopOwoKCQlfb3B0aW9ucygiaW5TY3JpcHQiLCBvYmopOwoKCQlfb3B0aW9ucygib3V0U2NyaXB0Iiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJmZWI2NzE1Ni1mNzRmLTQ4MzYtOTRhMi0xNGI5ZjIwMDM5ODgiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZyA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZyB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk1hcHBpbmdbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZ1tmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoInRvb2wiLCBvYmopOwoKCQlfb3B0aW9ucygidHlwZSIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FjdGl2ZScsICdlbmFibGVkJywgJ29yZGVyJywgJ2NsYXNzTmFtZScsICdzY29wZScsICdjb250ZXh0JywgJ3NvdXJjZScsICd0YXJnZXQnLCAnb3BlcmF0b3InLCAnaW5TY3JpcHQnLCAnb3V0U2NyaXB0JywgJ3Rvb2wnLCAndHlwZSddKS5jb25jYXQoWycnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJZmFsc2UgJiYgW10uY29uY2F0KHRoaXMuVG9vbC50eXBlLnR5cGVfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0aGlzLlRvb2wudG9vbF9NYXBwaW5ncyB8fCBbXSkuZmlsdGVyKG0gPT4gbS5jbGFzc05hbWUgPT0gIk1hcHBpbmciICYmIChtLnNvdXJjZSB8fCBtLmluU2NyaXB0KSAmJiBtLmFjdGl2ZSAmJiBtLmVuYWJsZWQgJiYgKChtLnRvb2wgJiYgbS50b29sLm5hbWUgPT0gdGhpcy5Ub29sLm5hbWUpIHx8IChtLnR5cGUgJiYgbS50eXBlLm5hbWUgPT0gdGhpcy5Ub29sLnR5cGUubmFtZSkpKS5mb3JFYWNoKG0gPT4gewoJCQlsZXQgcmV0ID0gbnVsbDsKCQkJaWYgKG0uaW5TY3JpcHQpIHsKCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAob2JqLCBvU2NvcGUsIG1hcCkgPT4geyR7bS5pblNjcmlwdC5pbmNsdWRlcygncmV0dXJuICcpPycnOidyZXR1cm4gJ30oJHttLmluU2NyaXB0fSl9YCkob2JqLCBzYWxlc25vdywgbSk7CgkJCX0gZWxzZSBpZiAobS50YXJnZXQpIHsKCQkJCWlmIChtLnRhcmdldC5pbmRleE9mKCcuJykgPiAtMSkgewoJCQkJCXJldCA9IHRoaXMucnVuU2NyaXB0KGAob2JqKSA9PiB7cmV0dXJuIG9iai4ke20udGFyZ2V0fTt9YCkob2JqKTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKG9ialttLnRhcmdldF0pID09PSAnZnVuY3Rpb24nKSB7CgkJCQkJcmV0ID0gb2JqW20udGFyZ2V0XSgpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoRG90T2JqZWN0KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQlyZXQgPSBEb3RPYmplY3QucGljayhtLnRhcmdldCwgb2JqKTsKCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gb2JqW20udGFyZ2V0XTsKCQkJCX0KCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gJ2Z1bmN0aW9uJykgcmV0ID0gcmV0KCk7CgkJCX0KCgkJCWlmIChtLnNvdXJjZSkgewoJCQkJaWYgKHR5cGVvZih0aGlzW20uc291cmNlXSkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQl0aGlzW20uc291cmNlXShyZXQpOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzW20uc291cmNlXSA9IHJldDsKCQkJCX0KCQkJfQoJCX0pOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLk1hcHBpbmcpIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTWFwcGluZyA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIk1hcHBpbmciKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY2xhc3NOYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jbGFzc05hbWUgPSB2ID09IHF1ZXJ5LmNsYXNzTmFtZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jbGFzc05hbWVfc2V0ICYmICFxdWVyeS5fY2xhc3NOYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jbGFzc05hbWUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY2xhc3NOYW1lX3NldCAmJiBxdWVyeS5fY2xhc3NOYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY2xhc3NOYW1lID0gZmFsc2U7CgkJCQl9LAoKCQkJCXNjb3BlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5zY29wZSA9IHYgPT0gcXVlcnkuc2NvcGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fc2NvcGVfc2V0ICYmICFxdWVyeS5fc2NvcGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnNjb3BlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3Njb3BlX3NldCAmJiBxdWVyeS5fc2NvcGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5zY29wZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb250ZXh0OiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb250ZXh0ID0gdiA9PSBxdWVyeS5jb250ZXh0KCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvbnRleHRfc2V0ICYmICFxdWVyeS5fY29udGV4dF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29udGV4dCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb250ZXh0X3NldCAmJiBxdWVyeS5fY29udGV4dF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvbnRleHQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJc291cmNlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5zb3VyY2UgPSB2ID09IHF1ZXJ5LnNvdXJjZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9zb3VyY2Vfc2V0ICYmICFxdWVyeS5fc291cmNlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5zb3VyY2UgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fc291cmNlX3NldCAmJiBxdWVyeS5fc291cmNlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouc291cmNlID0gZmFsc2U7CgkJCQl9LAoKCQkJCXRhcmdldDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoudGFyZ2V0ID0gdiA9PSBxdWVyeS50YXJnZXQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fdGFyZ2V0X3NldCAmJiAhcXVlcnkuX3RhcmdldF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudGFyZ2V0ID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3RhcmdldF9zZXQgJiYgcXVlcnkuX3RhcmdldF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnRhcmdldCA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcGVyYXRvcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3BlcmF0b3IgPSB2ID09IHF1ZXJ5Lm9wZXJhdG9yKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29wZXJhdG9yX3NldCAmJiAhcXVlcnkuX29wZXJhdG9yX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcGVyYXRvciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcGVyYXRvcl9zZXQgJiYgcXVlcnkuX29wZXJhdG9yX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3BlcmF0b3IgPSBmYWxzZTsKCQkJCX0sCgoJCQkJaW5TY3JpcHQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmluU2NyaXB0ID0gdiA9PSBxdWVyeS5pblNjcmlwdCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9pblNjcmlwdF9zZXQgJiYgIXF1ZXJ5Ll9pblNjcmlwdF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouaW5TY3JpcHQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5faW5TY3JpcHRfc2V0ICYmIHF1ZXJ5Ll9pblNjcmlwdF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmluU2NyaXB0ID0gZmFsc2U7CgkJCQl9LAoKCQkJCW91dFNjcmlwdDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3V0U2NyaXB0ID0gdiA9PSBxdWVyeS5vdXRTY3JpcHQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fb3V0U2NyaXB0X3NldCAmJiAhcXVlcnkuX291dFNjcmlwdF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3V0U2NyaXB0ID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX291dFNjcmlwdF9zZXQgJiYgcXVlcnkuX291dFNjcmlwdF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm91dFNjcmlwdCA9IGZhbHNlOwoJCQkJfSwKCgkJCQl0b29sOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai50b29sID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS50b29sKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3Rvb2xfc2V0ICYmICFxdWVyeS5fdG9vbF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudG9vbCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl90b29sX3NldCAmJiBxdWVyeS5fdG9vbF9zZXQpIHx8CgoJCQkJCQkodGhpcy50b29sKCkgJiYgIXRoaXMudG9vbCgpLl9tYXRjaGVzKHF1ZXJ5LnRvb2woKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnRvb2wgPSBmYWxzZTsKCQkJCX0sCgoJCQkJdHlwZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoudHlwZSA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkudHlwZSgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl90eXBlX3NldCAmJiAhcXVlcnkuX3R5cGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnR5cGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fdHlwZV9zZXQgJiYgcXVlcnkuX3R5cGVfc2V0KSB8fAoKCQkJCQkJKHRoaXMudHlwZSgpICYmICF0aGlzLnR5cGUoKS5fbWF0Y2hlcyhxdWVyeS50eXBlKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai50eXBlID0gZmFsc2U7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJdG9vbDogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIHRvb2wiKTsKCQkJCQlvYmoudG9vbCA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCXR5cGU6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciB0eXBlIik7CgkJCQkJb2JqLnR5cGUgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcmRlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jbGFzc05hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fc2NvcGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29udGV4dF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9zb3VyY2Vfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fdGFyZ2V0X3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29wZXJhdG9yX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2luU2NyaXB0X3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX291dFNjcmlwdF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl90b29sX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3R5cGVfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXRvb2w6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy50b29sKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQl0eXBlOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMudHlwZShyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQljbGFzc05hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjbGFzc05hbWUnLCB1bmRlZmluZWQpIDogImNsYXNzTmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jbGFzc05hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNsYXNzTmFtZShyZWYpOwoKCQkJfSwKCgkJCXNjb3BlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnc2NvcGUnLCB1bmRlZmluZWQpIDogInNjb3BlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3Njb3BlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5zY29wZShyZWYpOwoKCQkJfSwKCgkJCWNvbnRleHQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb250ZXh0JywgdW5kZWZpbmVkKSA6ICJjb250ZXh0IikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvbnRleHRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvbnRleHQocmVmKTsKCgkJCX0sCgoJCQlzb3VyY2U6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzb3VyY2UnLCB1bmRlZmluZWQpIDogInNvdXJjZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9zb3VyY2VfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnNvdXJjZShyZWYpOwoKCQkJfSwKCgkJCXRhcmdldDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3RhcmdldCcsIHVuZGVmaW5lZCkgOiAidGFyZ2V0IikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3RhcmdldF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMudGFyZ2V0KHJlZik7CgoJCQl9LAoKCQkJb3BlcmF0b3I6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcGVyYXRvcicsIHVuZGVmaW5lZCkgOiAib3BlcmF0b3IiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3BlcmF0b3JfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9wZXJhdG9yKHJlZik7CgoJCQl9LAoKCQkJaW5TY3JpcHQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdpblNjcmlwdCcsIHVuZGVmaW5lZCkgOiAiaW5TY3JpcHQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5faW5TY3JpcHRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmluU2NyaXB0KHJlZik7CgoJCQl9LAoKCQkJb3V0U2NyaXB0OiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3V0U2NyaXB0JywgdW5kZWZpbmVkKSA6ICJvdXRTY3JpcHQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3V0U2NyaXB0X2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vdXRTY3JpcHQocmVmKTsKCgkJCX0sCgoJCQl0b29sOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndG9vbCcsIHVuZGVmaW5lZCkgOiAidG9vbCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl90b29sX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLnRvb2woKSB8fCBuZXcgc2FsZXNub3cuVG9vbCgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMudG9vbChvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIHRvb2wiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCXR5cGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSA6ICJ0eXBlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3R5cGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMudHlwZSgpIHx8IG5ldyBzYWxlc25vdy5Ub29sX1R5cGUoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLnR5cGUob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSB0eXBlIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCddID0gdiwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3JkZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjbGFzc05hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKSA6ICJjbGFzc05hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY2xhc3NOYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jbGFzc05hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJzY29wZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzY29wZScsIHVuZGVmaW5lZCkgOiAic2NvcGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fc2NvcGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3Njb3BlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29udGV4dCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb250ZXh0JywgdW5kZWZpbmVkKSA6ICJjb250ZXh0IikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvbnRleHRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvbnRleHRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJzb3VyY2UiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnc291cmNlJywgdW5kZWZpbmVkKSA6ICJzb3VyY2UiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fc291cmNlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9zb3VyY2VfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJ0YXJnZXQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndGFyZ2V0JywgdW5kZWZpbmVkKSA6ICJ0YXJnZXQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fdGFyZ2V0X2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl90YXJnZXRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcGVyYXRvciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcGVyYXRvcicsIHVuZGVmaW5lZCkgOiAib3BlcmF0b3IiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3BlcmF0b3JfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29wZXJhdG9yX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiaW5TY3JpcHQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnaW5TY3JpcHQnLCB1bmRlZmluZWQpIDogImluU2NyaXB0IikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2luU2NyaXB0X2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9pblNjcmlwdF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm91dFNjcmlwdCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvdXRTY3JpcHQnLCB1bmRlZmluZWQpIDogIm91dFNjcmlwdCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vdXRTY3JpcHRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX291dFNjcmlwdF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInRvb2wiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndG9vbCcsIHVuZGVmaW5lZCkgOiAidG9vbCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX3Rvb2xfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3Rvb2xfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJ0eXBlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpIDogInR5cGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl90eXBlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl90eXBlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCglieVRvb2woYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX3Rvb2wiXSAmJiAoYVsiX3Rvb2wiXS5FcXVhbHMgPyBhWyJfdG9vbCJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfdG9vbCJdLCByKSkpIHsKCQkJCQlyLl90b29sX01hcHBpbmdzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlUb29sX1R5cGUoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX3R5cGUiXSAmJiAoYVsiX3R5cGUiXS5FcXVhbHMgPyBhWyJfdHlwZSJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfdHlwZSJdLCByKSkpIHsKCQkJCQlyLl90eXBlX01hcHBpbmdzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLklkOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk1hcHBpbmcuc3RvcmUnKTsgLy8gb3IgaW5zaWRlIGV4ZWN1dGU/CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJbGV0IGJVcGRhdGUgPSBmYWxzZTsKCQkJbGV0IGJJbnNlcnQgPSBmYWxzZTsKCgkJCWlmICghdGhpcy5fX3N5bmNfb24oKSkgewoJCQkJbGV0IF90aGlzID0gbmV3IHNhbGVzbm93Lk1hcHBpbmcobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIk9BdXRoU2FuZCIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX3Rvb2xfc2V0ICYmIHRoaXMudG9vbCgpICYmICEoYXdhaXQgdGhpcy50b29sKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfdG9vbCgpOwoKCQkJCQlpZiAodGhpcy5fdHlwZV9zZXQgJiYgdGhpcy50eXBlKCkgJiYgIShhd2FpdCB0aGlzLnR5cGUoKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl90eXBlKCk7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fX2Fzc2VydFZhbGlkKHRydWUpKSByZXR1cm4gbnVsbDsKCgkJCQkvL2F3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8gaW4gY2FzZSBUb29sIGNoYW5nZXMKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgQWJvdXQgdG8gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9YCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgRmluaXNoZWQgSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9IElkPVske3RoaXMuSWR9XWApOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTWFwcGluZy5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5NYXBwaW5nLnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiT0F1dGhTYW5kIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTWFwcGluZy5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJPQXV0aFNhbmQiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCk7CgkJCQlyZXQgPSByZXQuY29udGVudCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5NYXBwaW5nKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKCmlmKHR5cGVvZihtb2R1bGUpIT09InVuZGVmaW5lZCIpIG1vZHVsZS5leHBvcnRzLnNhbGVzbm93ID0gc2FsZXNub3c7CgppZih0eXBlb2Yod2luZG93KSE9PSd1bmRlZmluZWQnICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKT09PSd1bmRlZmluZWQnKXsKICAgIChhc3luYyAoKSA9PiB7CiAgICAgICAgbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LlVzZXIoKTsKCQlmb3IgYXdhaXQgKGNvbnN0IGwgb2Ygc2FsZXNub3cuaHJlZnMubWFwKG4gPT4gbi5saWIpKSB7CgkJCWF3YWl0IF90aGlzLnJlcXVpcmUobCwgc2FsZXNub3cuaHJlZnMpOwoJCX0KCQlpZihzYWxlc25vdy5Ob2RlKSBuZXcgc2FsZXNub3cuTm9kZSgpLmluaXQoKTsKCQlhd2FpdCBfdGhpcy5pbml0KCk7CiAgICB9KSgpOwp9"></script></head><body><ul id="LogHTML">HTML Node Testing...</div></body></html>
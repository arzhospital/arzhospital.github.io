<html><head><script type="text/javascript" src="data:text/javascript;base64,aWYodHlwZW9mKGdsb2JhbCkhPT0idW5kZWZpbmVkIikgZ2xvYmFsLkZsYXR0ZWQgPSByZXF1aXJlKCdmbGF0dGVkJyk7CgpsZXQgX19nID0gdHlwZW9mKGdsb2JhbCk9PT0idW5kZWZpbmVkIj93aW5kb3c6Z2xvYmFsOwoKbGV0IHNhbGVzbm93ID0gewogICAgX19zY3JpcHQ6IHsKICAgICAgICBEYXRlOiBuZXcgRGF0ZSgnMjAyMy0wOC0xMFQxOTo1ODowMC4wMDBaJyksCiAgICB9LAogICAgX19zZWNyZXQ6IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikhPT0idW5kZWZpbmVkIik/dGhpcy5fYXRvYjoodHlwZW9mKF9GckVNRCkhPT0idW5kZWZpbmVkIj9fRnJFTUQuX2F0b2I6YXRvYikpKGBJbUl6Wm1RME5tUTNMV0k0WW1RdE5HVmhPQzA0WldRekxUVmxNR1kyTm1Fd01Ua3hOeUk9YCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSksCiAgICBfX21haW5DbGFzczogJ1VzZXInLAoKICAgIGhyZWZzOiBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShgVzNzaWJHbGlJam9pVEc5blNGUk5UQ0lzSW5OeVl5STZJbWgwZEhCek9pOHZZMlJ1TG1welpHVnNhWFp5TG01bGRDOXVjRzB2WTI5dWMyOXNaUzFzYjJjdGFIUnRiRUF5TGpBdU1pOWpiMjV6YjJ4bExXeHZaeTFvZEcxc0xtMXBiaTVxY3lJc0ltTmhZMmhsSWpwMGNuVmxMQ0owYjI5c2N5STZXMTBzSW14dllXUWlPaUp0YjJSMWJHVnpJRDArSUdSdlkzVnRaVzUwTG1kbGRFVnNaVzFsYm5SQ2VVbGtLRndpVEc5blNGUk5URndpS1NBL0lFTnZibk52YkdWTWIyZElWRTFNTG1OdmJtNWxZM1FvWkc5amRXMWxiblF1WjJWMFJXeGxiV1Z1ZEVKNVNXUW9YQ0pNYjJkSVZFMU1YQ0lwS1NBNklDY25JaXdpY21WeGRXbHlaWE1pT2x0ZGZTeDdJbXhwWWlJNklsTlJURXBUSWl3aWMzSmpJanBiSW1oMGRIQnpPaTh2WTJSdWFuTXVZMnh2ZFdSbWJHRnlaUzVqYjIwdllXcGhlQzlzYVdKekwzTnhiQzVxY3k4eExqZ3VNQzl6Y1d3dGQyRnpiUzV0YVc0dWFuTWlYU3dpWTJGamFHVWlPblJ5ZFdVc0lteHZZV1FpT2lKaGMzbHVZeUJ0YjJSMWJHVnpJRDArSUh0Y2NseHVYSFJjZEhkcGJtUnZkeTVUVVV3Z1BTQmhkMkZwZENCcGJtbDBVM0ZzU25Nb2UxeHlYRzVjZEZ4MFhIUnNiMk5oZEdWR2FXeGxPaUJtYVd4bElEMCtJR0JvZEhSd2N6b3ZMMk5rYm1wekxtTnNiM1ZrWm14aGNtVXVZMjl0TDJGcVlYZ3ZiR2xpY3k5emNXd3Vhbk12TVM0NExqQXZKSHRtYVd4bGZXQmNjbHh1WEhSY2RIMHBPMXh5WEc1Y2RIMGlMQ0owYjI5c2N5STZXeUpUY1d4RVFpSmRMQ0p5WlhGMWFYSmxjeUk2VzExOUxIc2liR2xpSWpvaVpHOTBMVzlpYW1WamRDSXNJbk55WXlJNkltaDBkSEJ6T2k4dlkyUnVMbXB6WkdWc2FYWnlMbTVsZEM5dWNHMHZaRzkwTFc5aWFtVmpkRUF5TGpFdU5DOXBibVJsZUM1dGFXNHVhbk1pTENKallXTm9aU0k2ZEhKMVpTd2lkRzl2YkhNaU9sdGRMQ0p5WlhGMWFYSmxjeUk2VzExOUxIc2liR2xpSWpvaVFYaHBiM01pTENKemNtTWlPaUpvZEhSd2N6b3ZMM1Z1Y0d0bkxtTnZiUzloZUdsdmN5OWthWE4wTDJGNGFXOXpMbTFwYmk1cWN5SXNJbU5oWTJobElqcDBjblZsTENKMGIyOXNjeUk2VzEwc0luSmxjWFZwY21WeklqcGJYWDFkYCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSksCgoKICAgIF9fVG9vbHM6IFsKICAgIEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykhPT0idW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikhPT0idW5kZWZpbmVkIik/dGhpcy5fYXRvYjoodHlwZW9mKF9GckVNRCkhPT0idW5kZWZpbmVkIj9fRnJFTUQuX2F0b2I6YXRvYikpKGBleUowZVhCbElqcDdJbTVoYldVaU9pSlRjV3hFUWlJc0luUjVjR1ZmVFdGd2NHbHVaM01pT2x0N0ltRmpkR2wyWlNJNlptRnNjMlVzSW1OdmJuUmxlSFFpT2lJb1hGeGlYRngzS3lraUxDSmpiR0Z6YzA1aGJXVWlPaUlvWEZ4aVhGeDNLeWtpTENKemIzVnlZMlVpT2lJb1hGeGlYRngzS3lraUxDSjBZWEpuWlhRaU9pSW9iWFFzSUhNcElEMCtJSE11ZEc5TWIzZGxja05oYzJVb0tTSXNJbVZ1WVdKc1pXUWlPblJ5ZFdVc0luUjVjR1VpT25zaWJtRnRaU0k2SWxOeGJFUkNJbjE5WFN3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSjBlWEJsWDBOdmJtWnBaM01pT2x0ZGZTd2lkRzl2YkY5RGIyNW1hV2R6SWpwYmV5SnVZVzFsSWpvaVpHRjBZV0poYzJVaUxDSjJZV3gxWlNJNklsd2lPbTFsYlc5eWVUcGNJaUlzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaWMyVnlkbVZ5SWl3aWRtRnNkV1VpT2lKY0lteHZZMkZzYUc5emRGd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKMWMyVnlibUZ0WlNJc0luWmhiSFZsSWpvaVhDSnliMjkwWENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbkJoYzNOM2IzSmtJaXdpZG1Gc2RXVWlPaUpjSW5KdmIzUmNJaUlzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaVkzSmxZWFJsSWl3aWRtRnNkV1VpT2lJeUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUpUZVc1alJXNTBhWFI1UVhSMGNtbGlkWFJsY3lJc0luWmhiSFZsSWpvaWRISjFaU0lzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaVUzbHVZMVI1Y0dWa1FYUjBjbWxpZFhSbGN5SXNJblpoYkhWbElqb2lkSEoxWlNJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2lkSGx3WlNJc0luWmhiSFZsSWpvaVhDSnpjV3hwZEdWY0lpSXNJbTV2WkdVaU9uc2lZMjlrWlNJNklqSmxaVGhqT0RnNE0yRmxOQ0lzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZabUZzYzJVc0luUjVjR1VpT25zaWJtRnRaU0k2SWs1dlpHVktVeUo5Zlgwc2V5SnVZVzFsSWpvaWRIbHdaU0lzSW5aaGJIVmxJam9pWENKemNXeHBkR1ZjSWlJc0ltNXZaR1VpT25zaVkyOWtaU0k2SW1VNFpHVXdObVV6WldSak5EUXpZV1U1WkdabE1XUmxOV1ZqTlRKaE5HSm1JaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcG1ZV3h6WlN3aWRIbHdaU0k2ZXlKdVlXMWxJam9pVG05a1pVcFRJbjE5ZlN4N0ltNWhiV1VpT2lKMGVYQmxJaXdpZG1Gc2RXVWlPaUpjSW5OeGJHbDBaVndpSW4xZExDSnVZVzFsSWpvaVUzRnNSRUlpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdVc0luUnZiMnhmVFdGd2NHbHVaM01pT2x0ZGZRPT1gKSwgKGtleSx2YWx1ZSk9PntpZih0eXBlb2YodmFsdWUpPT09InN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKT4wKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7IHJldHVybiB2YWx1ZTt9KSxKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpIT09InVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpIT09InVuZGVmaW5lZCIpP3RoaXMuX2F0b2I6KHR5cGVvZihfRnJFTUQpIT09InVuZGVmaW5lZCI/X0ZyRU1ELl9hdG9iOmF0b2IpKShgZXlKMGVYQmxJanA3SW01aGJXVWlPaUpUWVd4bGMwWnZjbU5sSWl3aWRIbHdaVjlEYjI1bWFXZHpJanBiZXlKdVlXMWxJam9pY21WemRDNTFjbXd1WjNGc0lpd2lkbUZzZFdVaU9pSmNJbWgwZEhCek9pOHZlM3RwYm5OMFlXNWpaWDE5TG0xNUxuTmhiR1Z6Wm05eVkyVXVZMjl0TDNObGNuWnBZMlZ6TDJSaGRHRXZkbnQ3ZG1WeWMybHZibjE5TDJkeVlYQm9jV3hjSWlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2ljbVZ6ZEM1MWNtd2lMQ0oyWVd4MVpTSTZJbHdpYUhSMGNITTZMeTk3ZTJsdWMzUmhibU5sZlgwdWJYa3VjMkZzWlhObWIzSmpaUzVqYjIwdmMyVnlkbWxqWlhNdlpHRjBZUzkyZTN0MlpYSnphVzl1ZlgwdmMyOWlhbVZqZEhNdmUzdDBUbUZ0WlgxOUwzdDdTV1I5ZlZ3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmVjBzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlN3aWRIbHdaVjlOWVhCd2FXNW5jeUk2VzExOUxDSjBiMjlzWDBOdmJtWnBaM01pT2x0N0ltNWhiV1VpT2lKcGJuTjBZVzVqWlNJc0luWmhiSFZsSWpvaVhDSmtNM1l3TURBd01EQTRZMlkzZFdGaExXUmxkaTFsWkZ3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUoyWlhKemFXOXVJaXdpYzJOeWFYQjBJam9pSnpNNExqQW5JaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKMFlXSnNaU0lzSW5OamNtbHdkQ0k2SW5ST1lXMWxJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKSlpDSXNJbk5qY21sd2RDSTZJbDkwYUdsekxsOWZhV1FpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdWOUxIc2libUZ0WlNJNklsTjVibU5GYm5ScGRIbEJkSFJ5YVdKMWRHVnpJaXdpZG1Gc2RXVWlPaUowY25WbElpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUpUZVc1alZIbHdaV1JCZEhSeWFXSjFkR1Z6SWl3aWRtRnNkV1VpT2lKbVlXeHpaU0lzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaWJHbDJaU0lzSW5aaGJIVmxJam9pZEhKMVpTSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaWDBzZXlKdVlXMWxJam9pYjJGMWRHZ3VZMnhwWlc1MFgybGtJaXdpZG1Gc2RXVWlPaUpjSWpOTlZrYzVZbWhyY2s0dWRITnRWMTl6TGpWVmNVZDNjMnRaUnpnd1pXWm1VVFZuVjBOa1YzRlFUSGhtUTNoelltNXNlRjh3TGk1UGVGTkJSUzVrTVhOWk0xRlljMWwxUW1KNVpuY3pNbTB5YTNaS05VeGNJaUlzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaWIyRjFkR2d1WTJ4cFpXNTBYM05sWTNKbGRDSXNJblpoYkhWbElqb2lYQ0pGUWtVNFEwUkJOMEV4TUVJMU5ESTNRMFkyTkRZd1F6RkRRekUyTlRZMVJFWXlOVEV5UWpjeFFUSTNOVE5EUmprM1JqRTVOekpGUlRNM09EWkZOa05GWENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbTloZFhSb0xteHZaMmx1SWl3aWRtRnNkV1VpT2lKY0ltWmhaR2xBYm1GdGJXOTFjaTVqYjIxY0lpSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaWDBzZXlKdVlXMWxJam9pYjJGMWRHZ3VjR0Z6YzNkdmNtUWlMQ0oyWVd4MVpTSTZJbHdpTEZjeUxsTkRSalUrZVVwVE9UNGhPRndpSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTeDdJbTVoYldVaU9pSnZZWFYwYUM1b2IzTjBJaXdpZG1Gc2RXVWlPaUpjSW50N2FXNXpkR0Z1WTJWOWZTNXRlUzV6WVd4bGMyWnZjbU5sTG1OdmJWd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKdllYVjBhQzV6WTI5d1pTSXNJblpoYkhWbElqb2lYQ0ptZFd4c1hDSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5TEhzaWJtRnRaU0k2SW05aGRYUm9MbUYxZEdodmNtbDZaUzVqYjI1MFpXNTBYM1I1Y0dVaUxDSjJZV3gxWlNJNklsd2lZWEJ3YkdsallYUnBiMjR2ZUMxM2QzY3RabTl5YlMxMWNteGxibU52WkdWa1hDSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5TEhzaWJtRnRaU0k2SW05aGRYUm9MbUYxZEdodmNtbDZaUzVvWldGa1pYSnpJaXdpZG1Gc2RXVWlPaUpjSW50Y1hGd2lRWFYwYUMxU1pYRjFaWE4wTFZSNWNHVmNYRndpT2lCY1hGd2lUbUZ0WldRdFZYTmxjbHhjWENKOVhDSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5TEhzaWJtRnRaU0k2SW05aGRYUm9MbUYxZEdodmNtbDZaUzVpYjJSNUlpd2lkbUZzZFdVaU9pSmNJbkpsYzNCdmJuTmxYM1I1Y0dVOVkyOWtaVjlqY21Wa1pXNTBhV0ZzY3laamJHbGxiblJmYVdROWUzdHZZWFYwYUM1amJHbGxiblJmYVdSOWZTWnlaV1JwY21WamRGOTFjbWs5ZTN0dllYVjBhQzV5WldScGNtVmpkQzUxY21sOWZWd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKdllYVjBhQzVoZFhSb2IzSnBlbVV1YldWMGFHOWtJaXdpZG1Gc2RXVWlPaUpjSW1kbGRGd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlN4N0ltNWhiV1VpT2lKdllYVjBhQzVoZFhSb2IzSnBlbVV1ZFhKcElpd2lkbUZzZFdVaU9pSmNJbWgwZEhCek9pOHZlM3R2WVhWMGFDNW9iM04wZlgwdmMyVnlkbWxqWlhNdmIyRjFkR2d5TDJGMWRHaHZjbWw2WlQ5eVpYTndiMjV6WlY5MGVYQmxQV052WkdVbVkyeHBaVzUwWDJsa1BYdDdiMkYxZEdndVkyeHBaVzUwWDJsa2ZYMG1jMk52Y0dVOWUzdHZZWFYwYUM1elkyOXdaWDE5Sm5OMFlYUmxQWHQ3YjJGMWRHZ3VZWFYwYUc5eWFYcGxMbk4wWVhSbGZYMG1jbVZrYVhKbFkzUmZkWEpwUFh0N2IyRjFkR2d1Y21Wa2FYSmxZM1F1ZFhKcGZYMWNJaUlzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaWIyRjFkR2d1Y21Wa2FYSmxZM1F1ZFhKcElpd2lkbUZzZFdVaU9pSmNJbWgwZEhCek9pOHZZWEo2YUc5emNHbDBZV3d1WjJsMGFIVmlMbWx2TDNOaGJHVnpibTkzTDF3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUp2WVhWMGFDNXlaV1JwY21WamRDNWpiMlJsSWl3aWRtRnNkV1VpT2lKY0ltTnZaR1ZjSWlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2liMkYxZEdndWNtVmthWEpsWTNRdWMzUmhkR1VpTENKMllXeDFaU0k2SWx3aWMzUmhkR1ZjSWlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2liMkYxZEdndWRYTmxjbWx1Wm04dWRYSnBJaXdpZG1Gc2RXVWlPaUpjSW1oMGRIQnpPaTh2ZTN0dllYVjBhQzVvYjNOMGZYMHZkWE5sY21sdVptOWNJaUlzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaWIyRjFkR2d1ZEc5clpXNHVkWEpwSWl3aWRtRnNkV1VpT2lKY0ltaDBkSEJ6T2k4dmUzdHZZWFYwYUM1b2IzTjBmWDB2YzJWeWRtbGpaWE12YjJGMWRHZ3lMM1J2YTJWdVhDSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5TEhzaWJtRnRaU0k2SW05aGRYUm9MblJ2YTJWdUxtSnZaSGtpTENKMllXeDFaU0k2SWx3aVozSmhiblJmZEhsd1pUMTdlMjloZFhSb0xuUnZhMlZ1TG1keVlXNTBYM1I1Y0dWOWZTWmpiMlJsUFh0N2IyRjFkR2d1WVhWMGFHOXlhWHBsTG1OdlpHVjlmU1pqYkdsbGJuUmZhV1E5ZTN0dllYVjBhQzVqYkdsbGJuUmZhV1I5ZlNaamJHbGxiblJmYzJWamNtVjBQWHQ3YjJGMWRHZ3VZMnhwWlc1MFgzTmxZM0psZEgxOUpuSmxaR2x5WldOMFgzVnlhVDE3ZTI5aGRYUm9MbkpsWkdseVpXTjBMblZ5YVgxOVhDSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5TEhzaWJtRnRaU0k2SW05aGRYUm9MblJ2YTJWdUxtMWxkR2h2WkNJc0luWmhiSFZsSWpvaVhDSlFUMU5VWENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbTloZFhSb0xuUnZhMlZ1TG1OdmJuUmxiblJmZEhsd1pTSXNJblpoYkhWbElqb2lYQ0poY0hCc2FXTmhkR2x2Ymk5NExYZDNkeTFtYjNKdExYVnliR1Z1WTI5a1pXUmNJaUlzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaWIyRjFkR2d1ZEc5clpXNHVaM0poYm5SZmRIbHdaU0lzSW5aaGJIVmxJam9pWENKaGRYUm9iM0pwZW1GMGFXOXVYMk52WkdWY0lpSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaWDBzZXlKdVlXMWxJam9pYjJGMWRHZ3VkRzlyWlc0dWNtVnpjRzl1YzJVdWRHOXJaVzVmZEhsd1pTSXNJblpoYkhWbElqb2lYQ0owYjJ0bGJsOTBlWEJsWENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbTloZFhSb0xuUnZhMlZ1TG5KbGMzQnZibk5sTG1WNGNHbHlaWE5mYVc0aUxDSjJZV3gxWlNJNklsd2laWGh3YVhKbGMxOXBibHdpSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTeDdJbTVoYldVaU9pSnZZWFYwYUM1MGIydGxiaTV5WlhOd2IyNXpaUzVoWTJObGMzTmZkRzlyWlc0aUxDSjJZV3gxWlNJNklsd2lZV05qWlhOelgzUnZhMlZ1WENJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVjlMSHNpYm1GdFpTSTZJbTloZFhSb0xuUnZhMlZ1TG5KbGMzQnZibk5sTG5KbFpuSmxjMmhmZEc5clpXNGlMQ0oyWVd4MVpTSTZJbHdpY21WbWNtVnphRjkwYjJ0bGJsd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlYwc0ltNWhiV1VpT2lKVFlXeGxjMFp2Y21ObElpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0owYjI5c1gwMWhjSEJwYm1keklqcGJYWDA9YCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSksSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSE9PSJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSE9PSJ1bmRlZmluZWQiKT90aGlzLl9hdG9iOih0eXBlb2YoX0ZyRU1EKSE9PSJ1bmRlZmluZWQiP19GckVNRC5fYXRvYjphdG9iKSkoYGV5SjBlWEJsSWpwN0ltNWhiV1VpT2lKSGFYUklkV0lpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdVc0luUjVjR1ZmUTI5dVptbG5jeUk2VzEwc0luUjVjR1ZmVFdGd2NHbHVaM01pT2x0ZGZTd2lkRzl2YkY5RGIyNW1hV2R6SWpwYmV5SnVZVzFsSWpvaWNtVndiM05wZEc5eWVTSXNJblpoYkhWbElqb2lYQ0poY25wb2IzTndhWFJoYkM1bmFYUm9kV0l1YVc5Y0lpSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaWDBzZXlKdVlXMWxJam9pYjNkdVpYSWlMQ0oyWVd4MVpTSTZJbHdpWVhKNmFHOXpjR2wwWVd4Y0lpSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaWDBzZXlKdVlXMWxJam9pZFhKc0lpd2lkbUZzZFdVaU9pSmNJbWgwZEhCek9pOHZZWEJwTG1kcGRHaDFZaTVqYjIwdmNtVndiM012ZTN0dmQyNWxjbjE5TDN0N2NtVndiM05wZEc5eWVYMTlMMk52Ym5SbGJuUnpMMXdpSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTeDdJbTVoYldVaU9pSnZZWFYwYUM1aFkyTmxjM05mZEc5clpXNGlMQ0oyWVd4MVpTSTZJbHdpWjJsMGFIVmlYM0JoZEY4eE1VRk1SRk5WV2xFd1JrOVhOVk5PVkZnemIycHZYMjlDV1dwR09USkJabTVQYW10TmNrbFZiMGg2YlRsSmVHRlRRbFJPTm5ZeWNXMVlWamx6UWsxclFsZ3pWRWswVWsxTU5rWkpRVVV6WTBvMFhDSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5TEhzaWJtRnRaU0k2SW1OeVpXRjBaU0lzSW5aaGJIVmxJam9pTWlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2lVM2x1WTBWdWRHbDBlVUYwZEhKcFluVjBaWE1pTENKMllXeDFaU0k2SW5SeWRXVWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5TEhzaWJtRnRaU0k2SWxONWJtTlVlWEJsWkVGMGRISnBZblYwWlhNaUxDSjJZV3gxWlNJNkltWmhiSE5sSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZWMHNJbTVoYldVaU9pSkhhWFJJZFdJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVXNJblJ2YjJ4ZlRXRndjR2x1WjNNaU9sdGRmUT09YCksIChrZXksdmFsdWUpPT57aWYodHlwZW9mKHZhbHVlKT09PSJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+Iik+MCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOyByZXR1cm4gdmFsdWU7fSksSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSE9PSJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSE9PSJ1bmRlZmluZWQiKT90aGlzLl9hdG9iOih0eXBlb2YoX0ZyRU1EKSE9PSJ1bmRlZmluZWQiP19GckVNRC5fYXRvYjphdG9iKSkoYGV5SnVZVzFsSWpvaVUwNVBWMDlQUWlJc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaUxDSjBlWEJsWDBOdmJtWnBaM01pT2x0N0ltNWhiV1VpT2lKdFlYQXVVM1JoZEdVdVkyOWtaU0lzSW5aaGJIVmxJam9pWENKN1hGeGNJakZjWEZ3aU9pQmNYRndpUVZ4Y1hDSXNJRnhjWENJeVhGeGNJam9nWEZ4Y0lrSmNYRndpTENCY1hGd2lNMXhjWENJNklGeGNYQ0pEWEZ4Y0luMWNJaUlzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaWJXRndMbEJ5YVc5eWFYUjVMbU52WkdVaUxDSjJZV3gxWlNJNklsd2llMXhjWENJeFhGeGNJam9nWEZ4Y0lrTnlhWFJwWTJGc1hGeGNJaXdnWEZ4Y0lqSmNYRndpT2lCY1hGd2lTR2xuYUZ4Y1hDSXNJRnhjWENJelhGeGNJam9nWEZ4Y0lrMWxaR2wxYlZ4Y1hDSXNJRnhjWENJMFhGeGNJam9nWEZ4Y0lreHZkMXhjWENKOVhDSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5TEhzaWJtRnRaU0k2SW5KbGMzUmhjR2t1ZFhKc0lpd2lkbUZzZFdVaU9pSmNJbWgwZEhCek9pOHZlM3RwYm5OMFlXNWpaWDE5TG5ObGNuWnBZMlV0Ym05M0xtTnZiUzloY0drdmJtOTNMM1JoWW14bEwxd2lJaXdpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsZlYwc0luUjVjR1ZmVFdGd2NHbHVaM01pT2x0N0ltTnZiblJsZUhRaU9pSW9YRnhpWEZ4M0t5a2lMQ0pqYkdGemMwNWhiV1VpT2lJb1hGeGlYRngzS3lraUxDSnpiM1Z5WTJVaU9pSW9YRnhpWEZ4M0t5a2lMQ0owWVhKblpYUWlPaUlvYlhRc0lITXBJRDArSUhNdWRHOU1iM2RsY2tOaGMyVW9LU0lzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlN3aWRIbHdaU0k2ZXlKdVlXMWxJam9pVTJWeWRtbGpaVTV2ZHlKOWZTeDdJbU52Ym5SbGVIUWlPaUpGYm5ScGRIbEJkSFJ5YVdKMWRHVWlMQ0pqYkdGemMwNWhiV1VpT2lKZUtFbHVZMmxrWlc1MGZGQnliMkpzWlcwcEpDSXNJbk52ZFhKalpTSTZJbU52WkdVaUxDSjBZWEpuWlhRaU9pSnVkVzFpWlhJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVXNJblI1Y0dVaU9uc2libUZ0WlNJNklsTmxjblpwWTJWT2IzY2lmWDBzZXlKamIyNTBaWGgwSWpvaVJXNTBhWFI1UVhSMGNtbGlkWFJsSWl3aVkyeGhjM05PWVcxbElqb2lYaWhKYm1OcFpHVnVkSHhRY205aWJHVnRLU1FpTENKemIzVnlZMlVpT2lKdVlXMWxJaXdpZEdGeVoyVjBJam9pYzJodmNuUmZaR1Z6WTNKcGNIUnBiMjRpTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdVc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaWZYMHNleUpqYjI1MFpYaDBJam9pUlc1MGFYUjVRWFIwY21saWRYUmxJaXdpWTJ4aGMzTk9ZVzFsSWpvaVhpaEpibU5wWkdWdWRIeFFjbTlpYkdWdEtTUWlMQ0p6YjNWeVkyVWlPaUp5WlcxaGNtc2lMQ0owWVhKblpYUWlPaUprWlhOamNtbHdkR2x2YmlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpTd2lkSGx3WlNJNmV5SnVZVzFsSWpvaVUyVnlkbWxqWlU1dmR5SjlmU3g3SW1OdmJuUmxlSFFpT2lKRmJuUnBkSGxCZEhSeWFXSjFkR1VpTENKamJHRnpjMDVoYldVaU9pSkpibU5wWkdWdWRDSXNJbk52ZFhKalpTSTZJbU52WkdVaUxDSjBZWEpuWlhRaU9pSnVkVzFpWlhJaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVXNJblI1Y0dVaU9uc2libUZ0WlNJNklsTmxjblpwWTJWT2IzY2lmWDBzZXlKamIyNTBaWGgwSWpvaVhpaGZabkp2YlVSdlkzVnRaVzUwZkY5MGIwUnZZM1Z0Wlc1MEtTUWlMQ0pqYkdGemMwNWhiV1VpT2lKZUtFbHVZMmxrWlc1MGZGQnliMkpzWlcwcEpDSXNJbk52ZFhKalpTSTZJbDRvYzNSaGRHVjhjSEpwYjNKcGRIa3BKQ0lzSW05MWRFTnZibVJwZEdsdmJpSTZJblI1Y0dWdlppaHZZbXBHY205dEtUMDlQU2R2WW1wbFkzUW5JaXdpYVc1RGIyNWthWFJwYjI0aU9pSjBlWEJsYjJZb2IySnFSbkp2YlZ0amIyUmxYU2s5UFQwbmMzUnlhVzVuSnlJc0ltOTFkRk5qY21sd2RDSTZJbTlpYWxSdlcyTnZaR1ZkSUQwZ1gzUm9hWE11WDJac2FYQW9YM1JvYVhNdVgxOWpiMjVtYVdjb0oyMWhjQzRuSzJOdlpHVlVlWEJsS3ljdVkyOWtaU2NzSUc1MWJHd3NJSHQwYjI5c09pQjBiMjlzZlNrcFcyOWlha1p5YjIwdVkyOWtaU2dwWFNJc0ltbHVVMk55YVhCMElqb2liMkpxVkc5YlkyOWtaVjBnUFNCN1kyOWtaVG9nWDNSb2FYTXVYMTlqYjI1bWFXY29KMjFoY0M0bksyTnZaR1ZVZVhCbEt5Y3VZMjlrWlNjc0lHNTFiR3dzSUh0MGIyOXNPaUIwYjI5c2ZTbGJiMkpxUm5KdmJWdGpiMlJsWFYxOUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0owZVhCbElqcDdJbTVoYldVaU9pSlRaWEoyYVdObFRtOTNJbjE5WFN3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTd2lkRzl2YkY5TllYQndhVzVuY3lJNlczc2lZMnhoYzNOT1lXMWxJam9pVlhObGNpSXNJblJoY21kbGRDSTZJblZ6WlhKZmJtRnRaU0lzSW5OdmRYSmpaU0k2SWtsa0lpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0owYjI5c0lqcDdJbTVoYldVaU9pSlRUazlYVDA5Q0luMTlMSHNpWTJ4aGMzTk9ZVzFsSWpvaVRXOWtaV3hmUTJGMFpXZHZjbmtpTENKemIzVnlZMlVpT2lKTmIyUmxiRjlEWVhSbFoyOXllU0lzSW5SaGNtZGxkQ0k2SW1OdFpHSmZiVzlrWld4ZlkyRjBaV2R2Y25raUxDSmpiMjUwWlhoMElqb2lSVzUwYVhSNVEyeGhjM01pTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdVc0luUnZiMndpT25zaWJtRnRaU0k2SWxOT1QxZFBUMElpZlgwc2V5SmpiR0Z6YzA1aGJXVWlPaUpCYzNObGRDSXNJbk52ZFhKalpTSTZJa0Z6YzJWMElpd2lkR0Z5WjJWMElqb2lZV3h0WDJGemMyVjBJaXdpWTI5dWRHVjRkQ0k2SWtWdWRHbDBlVU5zWVhOeklpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0owYjI5c0lqcDdJbTVoYldVaU9pSlRUazlYVDA5Q0luMTlMSHNpWTJ4aGMzTk9ZVzFsSWpvaVRXOWtaV3hmUTJGMFpXZHZjbmtpTENKMFlYSm5aWFFpT2lKaGMzTmxkRjlqYkdGemN5SXNJbk52ZFhKalpTSTZJbU5zWVhOeld5NTNYU29pTENKdmRYUlRZM0pwY0hRaU9pSnZZbXBVYnk1aGMzTmxkRjlqYkdGemN5QTlJRzlpYWtaeWIyMWJZMjlrWlYwN0lpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0owYjI5c0lqcDdJbTVoYldVaU9pSlRUazlYVDA5Q0luMTlMSHNpWTJ4aGMzTk9ZVzFsSWpvaVFYTnpaWFFpTENKMFlYSm5aWFFpT2lKcGJuTjBZV3hzWDNOMFlYUjFjeUlzSW5OdmRYSmpaU0k2SW5OMFlYUjFjMXN1ZDEwcUlpd2liM1YwVTJOeWFYQjBJam9pYjJKcVZHOHVhVzV6ZEdGc2JGOXpkR0YwZFhNZ1BTQnZZbXBHY205dFcyTnZaR1ZkT3lJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpTd2lkRzl2YkNJNmV5SnVZVzFsSWpvaVUwNVBWMDlQUWlKOWZTeDdJbU5zWVhOelRtRnRaU0k2SWsxdlpHVnNYME5oZEdWbmIzSjVJaXdpZEdGeVoyVjBJam9pYm1GdFpTSXNJbk52ZFhKalpTSTZJbTVoYldVaUxDSmhZM1JwZG1VaU9uUnlkV1VzSW1WdVlXSnNaV1FpT25SeWRXVXNJblJ2YjJ3aU9uc2libUZ0WlNJNklsTk9UMWRQVDBJaWZYMHNleUpqYkdGemMwNWhiV1VpT2lKTmIyUmxiRjlEWVhSbFoyOXllU0lzSW5SaGNtZGxkQ0k2SW5CaGNtVnVkRjlqWVhSbGIyZHllU0lzSW5OdmRYSmpaU0k2SW5CaGNtVnVkQ0lzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlN3aWRHOXZiQ0k2ZXlKdVlXMWxJam9pVTA1UFYwOVBRaUo5ZlN4N0ltTnNZWE56VG1GdFpTSTZJa1YyWlc1MElpd2ljMjkxY21ObElqb2ljbVZqYVhCcFpXNTBJaXdpZEdGeVoyVjBJam9pYm05a1pTSXNJbTkxZEZOamNtbHdkQ0k2SWlkQlVFbFRSVkpXUlZJNkp5QXJJRjkwYUdsekxsTmpiM0JsSUNzZ0p6b25JQ3NnS0Y5MGFHbHpMbkpsWTJsd2FXVnVkQ2dwSUh4OElIdDlLUzVqYjJSbEtDa2lMQ0pwYmxOamNtbHdkQ0k2SW05aWFpNXViMlJsTG5Od2JHbDBLQ2M2SnlrdWJHVnVaM1JvUFQweFAyNTFiR3c2Ym1WM0lHOVRZMjl3WlM1T2IyUmxLQ2t1WTI5a1pTaHZZbW91Ym05a1pTNXpjR3hwZENnbk9pY3BXekpkS1NJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpTd2lkRzl2YkNJNmV5SnVZVzFsSWpvaVUwNVBWMDlQUWlKOWZWMHNJblJ2YjJ4ZlEyOXVabWxuY3lJNlczc2libUZ0WlNJNkltbHVjM1JoYm1ObElpd2lkbUZzZFdVaU9pSmNJbVJsZGpFM01ETXdORndpSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTeDdJbTVoYldVaU9pSjFjMlZ5Ym1GdFpTSXNJblpoYkhWbElqb2lYQ0owZFY5dWIyUmxhbk5jSWlJc0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpYMHNleUp1WVcxbElqb2liR2wyWlNJc0luWmhiSFZsSWpvaWRISjFaU0lzSW1GamRHbDJaU0k2ZEhKMVpTd2laVzVoWW14bFpDSTZkSEoxWlgwc2V5SnVZVzFsSWpvaWNHRnpjM2R2Y21RaUxDSjJZV3gxWlNJNklsd2lLRGg0TTBkVFJXcHdSazB6VGsxeVVGUmRjSGxiYTFJOGF6UlFaR3BKT1ZjdE0wbG9NaWg2ZlNrNk5TZ29YV0kyTGs1UVN6aDFQVEUvUWw4ME56RXRYMWh0V1N0NVUyMUJlMk0wYmkwckxGNXdkbEl4Vm5OVVVIRW9KRmN1Y0NROFR6dFlQMXdpSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTeDdJbTVoYldVaU9pSnplWE5mY0hKdmNHVnlkR2xsY3k1bmJHbGtaUzV6ZVhNdVpHRjBaVjltYjNKdFlYUWlMQ0oyWVd4MVpTSTZJbHdpZVhsNWVTMU5UUzFrWkZ3aUlpd2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxmU3g3SW01aGJXVWlPaUp6ZVhOZmNISnZjR1Z5ZEdsbGN5NW5iR2xrWlM1emVYTXVkR2x0WlY5bWIzSnRZWFFpTENKMllXeDFaU0k2SWx3aVNFZzZiVzA2YzNOY0lpSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaWDBzZXlKdVlXMWxJam9pYzNselgzQnliM0JsY25ScFpYTXVaMnhwWkdVdWMzbHpMbVJsWm1GMWJIUXVkSG9pTENKMllXeDFaU0k2SWx3aVJYVnliM0JsTDBKbGNteHBibHdpSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTeDdJbTVoYldVaU9pSmpjbVZoZEdVaUxDSjJZV3gxWlNJNklqSWlMQ0poWTNScGRtVWlPblJ5ZFdVc0ltVnVZV0pzWldRaU9uUnlkV1Y5TEhzaWJtRnRaU0k2SWxONWJtTkZiblJwZEhsQmRIUnlhV0oxZEdWeklpd2lkbUZzZFdVaU9pSjBjblZsSWl3aVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbGZTeDdJbTVoYldVaU9pSlRlVzVqVkhsd1pXUkJkSFJ5YVdKMWRHVnpJaXdpZG1Gc2RXVWlPaUptWVd4elpTSXNJbUZqZEdsMlpTSTZkSEoxWlN3aVpXNWhZbXhsWkNJNmRISjFaWDFkTENKaFkzUnBkbVVpT25SeWRXVXNJbVZ1WVdKc1pXUWlPblJ5ZFdWOWApLCAoa2V5LHZhbHVlKT0+e2lmKHR5cGVvZih2YWx1ZSk9PT0ic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpPjApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsgcmV0dXJuIHZhbHVlO30pLAogICAgXSwKCn07CgoKCmRlbGV0ZSBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSTsKc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgPSBjbGFzcyBHZW5lcmljU2VydmljZUFQSSB7Cglhc3luYyBzZXRJbnRlcnZhbChmdW4sIG1pbnV0ZXMsIC4uLmFyZ3MpIHsKCQlsZXQgZk5hbWUgPSBmdW4udG9TdHJpbmcoKS5zcGxpdCgnKScpWzBdICsgJyknOwoJCXRyeSB7CgkJCS8vIHRoaXMuX190aW1lKGAke2ZOYW1lfS5Mb29wYCk7CgoJCQl0aGlzLl9fdGltZShgJHtmTmFtZX0uQ2FsbGApOwoJCQlsZXQgcmV0ID0gYXdhaXQgZnVuKC4uLmFyZ3MuY29uY2F0KFtuZXcgRGF0ZSgpXSkpOwoKCQkJdGhpcy5sb2coYHtDYWxsOiBgICsgdGhpcy5fX3RpbWUoYCR7Zk5hbWV9LkNhbGxgKSArIGAsIExvb3A6IGAgKyB0aGlzLl9fdGltZShgJHtmTmFtZX0uTG9vcGApICsgJ30nLCAnc2V0SW50ZXJ2YWwnLCBmTmFtZSk7CgkJCWlmICghcmV0KSB7CgkJCQl0aGlzLmxvZyhgZGlkIG5vdCByZXR1cm4gdHJ1ZSwgZXhpdGluZyBsb29wZXIgKCR7dGhpcy5fX3RpbWUoZk5hbWUpfSlgLCAnc2V0SW50ZXJ2YWwnLCBmTmFtZSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh0aGlzLl9fdGltZShmTmFtZSksICdzZXRJbnRlcnZhbCcsIGZOYW1lLCAyLCBleCk7CgkJCWNvbnNvbGUudHJhY2UoKTsKCQl9CgkJaWYgKCFOdW1iZXIobWludXRlcykpIHsKCQkJdGhpcy5sb2codGhpcy5fX3RpbWUoZk5hbWUpLCAnc2V0SW50ZXJ2YWwnLCBmTmFtZSwgMCwgIk5vdCByZXBlYXRpbmcuIE1pbnV0ZXMgaXMgIiArIG1pbnV0ZXMpOwoJCQlyZXR1cm47CgkJfQoJCWF3YWl0IG5ldyBQcm9taXNlKHIgPT4gc2V0VGltZW91dChyLCBtaW51dGVzICogNjAgKiAxMDAwKSk7CgkJYXdhaXQgdGhpcy5zZXRJbnRlcnZhbChmdW4sIG1pbnV0ZXMsIC4uLmFyZ3MpOwoJfQoKCWFzeW5jIF9leGVjdXRlKHNjb3BlLCBtLCBmUm91dGVyLCBmU2NyaXB0LCBvUGFyYW1zID0ge30pIHsKCQlsZXQgX19iZWZvcmVSdWxlcyA9IG9QYXJhbXMuX19iZWZvcmVSdWxlcyB8fCBbXTsKCQlsZXQgX19hZnRlclJ1bGVzID0gb1BhcmFtcy5fX2FmdGVyUnVsZXMgfHwgW107CgkJZGVsZXRlIG9QYXJhbXMuX19iZWZvcmVSdWxlczsKCQlkZWxldGUgb1BhcmFtcy5fX2FmdGVyUnVsZXM7CgoJCV9fYmVmb3JlUnVsZXMuY29uY2F0KF9fYWZ0ZXJSdWxlcykuZm9yRWFjaChyID0+IHIuU2NyaXB0ID0gdGhpcy5ydW5TY3JpcHQoYGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBzY29wZSwgbm9kZSR7T2JqZWN0LmtleXMob1BhcmFtcykubGVuZ3RoPycsICc6Jyd9JHtPYmplY3Qua2V5cyhvUGFyYW1zKS5qb2luKCcsJyl9KSA9PiB7JHtyLlNjcmlwdH19YCkpOwoKCQlsZXQgbFBhcmFtcyA9IE9iamVjdC5lbnRyaWVzKG9QYXJhbXMpLm1hcCh4ID0+IHhbMV0pOwoJCWxldCByZXN1bHRzID0gW107CgoJCWlmICh0aGlzLkRTQ29ubmVjdCkgYXdhaXQgdGhpcy5EU0Nvbm5lY3QoKTsKCgkJbGV0IG5vZGVzID0gW107CgkJaWYgKCFzY29wZS5fbm9kZSB8fCAhZlJvdXRlcikgewoJCQlub2Rlcy5wdXNoKG51bGwpOwoJCX0gZWxzZSB7CgkJCWlmIChzY29wZS5fbm9kZSkgewoJCQkJaWYgKGF3YWl0IHRoaXMuX1NjcmlwdChmUm91dGVyLCBtLCAnUm91dGVyJywgc2NvcGUsIHNjb3BlLl9ub2RlLCAuLi5sUGFyYW1zKSkgewoJCQkJCW5vZGVzLnB1c2goc2NvcGUuX25vZGUpOwoJCQkJfQoKCQkJCXRoaXMuX2ZpeE5vZGUoc2NvcGUpOwoKCQkJCWlmIChzY29wZS5fbm9kZS5fcGFyZW50ICYmIChhd2FpdCB0aGlzLl9TY3JpcHQoZlJvdXRlciwgbSwgJ1JvdXRlcicsIHNjb3BlLCBzY29wZS5fbm9kZS5fcGFyZW50LCAuLi5sUGFyYW1zKSkpIHsKCQkJCQkvLyB0aGlzLmxvZyhzY29wZS5fbm9kZS5fcGFyZW50LCAnX2V4ZWN1dGUnLCAnYWRkaW5nIHBhcmVudCcpOwoJCQkJCW5vZGVzLnB1c2goc2NvcGUuX25vZGUuX3BhcmVudCk7CgkJCQl9IGVsc2UgaWYgKHNjb3BlLkV2ZW50ICYmIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAhPT0gIkV2ZW50IikgewoJCQkJCS8vIG5vZGVzLnB1c2gobmV3IHNjb3BlLk5vZGUoKSk7CgkJCQl9CgoJCQkJdGhpcy5fZml4Tm9kZShzY29wZSk7CgkJCQlmb3IgYXdhaXQgKGNvbnN0IGNuIG9mIHNjb3BlLl9ub2RlLnBhcmVudF9Ob2RlcygpKSB7CgkJCQkJaWYgKGF3YWl0IHRoaXMuX1NjcmlwdChmUm91dGVyLCBtLCAnU2NyaXB0Jywgc2NvcGUsIGNuLCAuLi5sUGFyYW1zKSkgewoJCQkJCQkvLyB0aGlzLmxvZyhjbiwgJ19leGVjdXRlJywgJ2FkZGluZyBjaGlsZCBub2RlJyk7CgkJCQkJCW5vZGVzLnB1c2goY24pOwoJCQkJCX0KCQkJCX0KCQkJfQoKCQkJLy8gcmVtb3ZlIGFueSBudWxscwoJCQlub2RlcyA9IG5vZGVzLmZsYXQoKS5maWx0ZXIobiA9PiBuKTsKCgkJCWlmICghbm9kZXMubGVuZ3RoKSB7CgkJCQlub2Rlcy5wdXNoKHNjb3BlLl9ub2RlKTsKCQkJfQoKCQkJLy8gdGhpcy5sb2cobm9kZXMubGVuZ3RoLCAnX2V4ZWN1dGUnLCAnbm9kZXMubGVuZ3RoJyk7CgkJfQoKCQlmb3IgYXdhaXQgKGNvbnN0IG4gb2Ygbm9kZXMpIHsKCQkJdGhpcy5fZml4Tm9kZShzY29wZSk7CgkJCWxldCBuUmV0ID0gbnVsbDsKCQkJdGhpcy5sb2coYCR7bX0gQCAke24/LmNvZGUoKSB8fCAnTE9DQUwnfWAsICdfZXhlY3V0ZScsIGAke3RoaXMuRW50aXR5Q2xhc3MuTmFtZX1gKTsKCQkJaWYgKCFuIHx8IHRoaXMuX3NhbWVOb2RlKHNjb3BlLl9ub2RlLCBuKSkgewoJCQkJLy8gbG9jYWwgc2NyaXB0CgkJCQlmb3IgYXdhaXQgKGNvbnN0IHIgb2YgX19iZWZvcmVSdWxlcykgewoJCQkJCWF3YWl0IHRoaXMuX1NjcmlwdChyLlNjcmlwdCwgbSwgci5OYW1lIHx8ICdCZWZvcmVSdWxlJywgc2NvcGUsIG51bGwsIC4uLmxQYXJhbXMpOwoJCQkJfQoKCQkJCW5SZXQgPSBhd2FpdCB0aGlzLl9TY3JpcHQoZlNjcmlwdCwgbSwgJ1NjcmlwdCcsIHNjb3BlLCAuLi5sUGFyYW1zKTsKCgkJCQlmb3IgYXdhaXQgKGNvbnN0IHIgb2YgX19hZnRlclJ1bGVzKSB7CgkJCQkJYXdhaXQgdGhpcy5fU2NyaXB0KHIuU2NyaXB0LCBtLCByLk5hbWUgfHwgJ0FmdGVyUnVsZScsIHNjb3BlLCBudWxsLCAuLi5sUGFyYW1zKTsKCQkJCX0KCQkJfSBlbHNlIHsKCQkJCW5SZXQgPSBhd2FpdCB0aGlzLl9pbnZva2VOb2RlKG4sIG0sIG9QYXJhbXMpOwoJCQl9CgoJCQlyZXN1bHRzLnB1c2goewoJCQkJbm9kZTogbiwKCQkJCXJldDogblJldAoJCQl9KTsKCQl9CgkJLy8gdGhpcy5sb2cocmVzdWx0cywgJ19leGVjdXRlJywgJ1Jlc3VsdHMnKTsKCgkJbGV0IGVycm9ycyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gci5yZXQgJiYgci5yZXQuX19leGNlcHRpb24pIC8qLmZpbHRlcihyID0+ICF0aGlzLl9zYW1lTm9kZShzY29wZS5fbm9kZSwgci5ub2RlKSkqLyAubWFwKHIgPT4gKHsKCQkJbm9kZTogci5ub2RlID8gewoJCQkJY29kZTogci5ub2RlLmNvZGUoKSwKCQkJCWFkZHJlc3M6IHIubm9kZS5hZGRyZXNzKCkKCQkJfSA6IG51bGwsCgkJCV9fZXhjZXB0aW9uOiByLnJldC5fX2V4Y2VwdGlvbgoJCX0pKTsKCQlpZiAoZXJyb3JzLmxlbmd0aCkgewoJCQl0aGlzLmxvZygiX2V4ZWN1dGUiLCBtLCAiZXJyb3JzIiwgMSwgZXJyb3JzKTsKCQl9CgoJCXJldHVybiByZXN1bHRzOwoJfQoKCV9zYW1lTm9kZShuMSwgbjIpIHsKCQlpZiAodHlwZW9mKG4yKSA9PT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKG4xKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJbjIgPSBuMTsKCQkJbjEgPSB0aGlzOwoJCX0KCgkJaWYgKCFuMSB8fCAhbjIpIHJldHVybiBmYWxzZTsKCgkJaWYgKHR5cGVvZihuMS5fY29kZSkgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZihuMi5fY29kZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gZmFsc2U7CgoJCWlmIChuMS5jb25zdHJ1Y3Rvci5uYW1lICE9ICJOb2RlIiB8fCBuMi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJOb2RlIikgewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoKCQlpZiAobjEuX2NvZGVfY29vcCB8fCBuMi5fY29kZV9jb29wKSByZXR1cm4gZmFsc2U7CgoJCWlmIChuMS5fY29kZSA9PSBuMi5fY29kZSkgcmV0dXJuIHRydWU7CgoJCXJldHVybiB0aGlzLkVxdWFscyhuMSwgbjIpOwoJfQoKCV9maXhOb2RlKHNjb3BlKSB7CgkJLy8gb24gTm9kZUpTIGZvciBzb21lIHJlYXNvbiwgX25vZGUgaXMgc29tZXRpbWVzIGFuIGFycmF5IQoJCXRyeSB7CgkJCXNjb3BlID0gc2NvcGUgfHwgdGhpcy5fX3Njb3BlKCk7CgkJCWlmIChBcnJheS5pc0FycmF5KHNjb3BlLl9ub2RlKSkgc2NvcGUuX25vZGUgPSBzY29wZS5fbm9kZVswXTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZygnX2ZpeE5vZGUnLCB0eXBlb2YodGhpcyksIDEsIGV4LCB0aGlzLmNvbnN0cnVjdG9yLm5hbWUpOwoJCX0KCX0KCglsb2cob2JqLCBtLCB0eXBlLCBsZXZlbCwgLi4ubXNnKSB7CgkJdHJ5IHsKCQkJbGV0IGRlYnVnID0gdGhpcy5EZWJ1ZzsKCQkJbGV0IGxldmVscyA9IFsiaW5mbyIsICJ3YXJuIiwgImVycm9yIiwgImNyaXRpY2FsIl07CgoJCQlkZWJ1ZyA9IGRlYnVnIHx8IE9iamVjdC5mcm9tRW50cmllcyhuZXcgTWFwKGxldmVscy5tYXAobCA9PiBbbCwgJyonXSkpKTsKCgkJCWxldCBmdW5jdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCAuLi5sZXZlbHMubWFwKGwgPT4gKHsKCQkJCVtsXTogZGVidWdbbF0gPyBkZWJ1Z1tsXS5zcGxpdCgnLCcpIDogW10KCQkJfSkpKTsKCgkJCWxldCBjc3MgPSAnYmFja2dyb3VuZDogIzAwZmYwMDsgY29sb3I6ICMwMDgwMDAnOwoJCQlsZXQgZmcgPSAnXHgxYlszMm0nOwoJCQlzd2l0Y2ggKE51bWJlcihsZXZlbCkpIHsKCQkJCWNhc2UgMToKCQkJCQljc3MgPSAnYmFja2dyb3VuZDogI2ZmZmYwMDsgY29sb3I6ICMwMDAwODAnOwoJCQkJCWZnID0gJ1x4MWJbMzNtJzsKCQkJCQlicmVhazsKCQkJCWNhc2UgMjoKCQkJCQljc3MgPSAnYmFja2dyb3VuZDogI2IyMjIyMjsgY29sb3I6ICNmZmZmZmYnOwoJCQkJCWZnID0gJ1x4MWJbMzFtJzsKCQkJCQlicmVhazsKCQkJCWNhc2UgMzoKCQkJCQljc3MgPSAnYmFja2dyb3VuZDogI2IyMjIyMjsgY29sb3I6ICNmZmZmZmYnOwoJCQkJCWZnID0gJ1x4MWJbMzFtW0NSSVRJQ0FMXSc7CgkJCQkJYnJlYWs7CgkJCX0KCgkJCWlmIChmdW5jdGlvbnNbbGV2ZWxzW051bWJlcihsZXZlbCkgfHwgMF1dLmV2ZXJ5KGYgPT4gIVsnKi4qJywgJyouJyArIG0sICcqJywgbSwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lICsgJy4nICsgbSwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lICsgJy4qJ10uaW5jbHVkZXMoZikpKSB7CgkJCQkvLyBjb25zb2xlLmxvZygnbm8gbWV0aG9kJywgZnVuY3Rpb25zLCBmdW5jdGlvbnNbbGV2ZWxzW051bWJlcihsZXZlbCkgfHwgMF1dLCBtLCBbJyouKicsICcqLicgKyBtLCAnKicsIG0sIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSArICcuJyArIG0sIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSArICcuKiddKTsKCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJykgewoJCQkJY29uc29sZS5sb2coZmcgKyAiJXNceDFiWzBtIiwgYCR7dHlwZSB8fCAnPHR5cGU+J306ICR7dGhpcy5TY29wZX0uJHt0aGlzLkVudGl0eUNsYXNzLk5hbWV9LiR7bSB8fCAnPG1ldGhvZD4nfSgpYCwgLi4uKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJyA/IChtc2cgfHwgW10pIDogW29ial0uY29uY2F0KG1zZyB8fCBbXSkpKTsKCQkJfSBlbHNlIHsKCQkJCWNvbnNvbGUubG9nKGAlYyAke3R5cGUgfHwgJzx0eXBlPid9OiAke3RoaXMuU2NvcGV9LiR7dGhpcy5FbnRpdHlDbGFzcy5OYW1lfS4ke20gfHwgJzxtZXRob2Q+J30oKWAsIGNzcywgLi4uKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJyA/IChtc2cgfHwgW10pIDogW29ial0uY29uY2F0KG1zZyB8fCBbXSkpKTsKCQkJfQoJCX0gY2F0Y2ggKGV4KSB7CgkJCWNvbnNvbGUubG9nKGV4KTsKCQkJLy90aGlzLmxvZyhleCwgbSwgdHlwZSwgMyk7CgkJfQoJfQoKCWFzeW5jIF9TY3JpcHQoc2NyaXB0LCBtLCB0eXBlLCBzY29wZSwgLi4uc2ZBcmdzKSB7CgkJaWYgKHR5cGVvZihzY3JpcHQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoKCQlyZXR1cm4gYXdhaXQgKGFzeW5jICh0eXBlLCAuLi5zQXJncykgPT4gewoJCQlsZXQgbG9nID0gKG9iaiwgLi4ubXNnKSA9PiB0aGlzLmxvZyhvYmosIG0sIHR5cGUsIDAsIC4uLm1zZyk7CgkJCWxldCB3YXJuID0gKG9iaiwgLi4ubXNnKSA9PiB0aGlzLmxvZyhvYmosIG0sIHR5cGUsIDEsIC4uLm1zZyk7CgkJCWxldCBlcnJvciA9IChvYmosIC4uLm1zZykgPT4gdGhpcy5sb2cob2JqLCBtLCB0eXBlLCAyLCAuLi5tc2cpOwoKCQkJdHJ5IHsKCQkJCWxldCByZXQgPSBudWxsOwoKCQkJCWlmICh0eXBlb2Yoc2NyaXB0KSA9PT0gJ3N0cmluZycpIHNjcmlwdCA9IHRoaXMucnVuU2NyaXB0KHNjcmlwdCk7CgkJCQlpZiAodHlwZW9mKHNjcmlwdCkgPT09ICdmdW5jdGlvbicpIHsKCQkJCQlyZXQgPSBhd2FpdCBzY3JpcHQobG9nLCB3YXJuLCBlcnJvciwgc2NvcGUsIG0sIC4uLnNBcmdzKTsKCQkJCX0KCgkJCQl0aGlzLl9maXhOb2RlKCk7CgkJCQlyZXR1cm4gcmV0OwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCWVycm9yKGV4LCAyLCAuLi5zQXJncywgc2NyaXB0KTsKCQkJCX0gZWxzZSB7CgkJCQkJZXJyb3IoZXgsIDIpOwoJCQkJfQoJCQl9CgkJfSkodHlwZSwgLi4uc2ZBcmdzKTsKCX0KfTsKCgpzYWxlc25vdy5Vc2VyID0gY2xhc3MgVXNlciBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFzS2k1ZmNtVnpkQ3dxTGw5c2IyRmtWRzl2YkhNaWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmZZWFYwYUc5eWFYcGxMblZ6WlhKdVlXMWxJam9pWm1Ga2FTSXNJbDloZFhSb2IzSnBlbVV1Y0dGemMzZHZjbVFpT2lJeE1qTWlMQ0pmWVhWMGFHOXlhWHBsTG5SbGMzUlZjMlZ5SWpwN0ltRmpkR2wyWlNJNmRISjFaU3dpWlc1aFlteGxaQ0k2ZEhKMVpTd2laMlZ1WkdWeUlqcDdJbU52WkdVaU9pSk5JaXdpYm1GdFpTSTZJazFoYkdVaWZTd2lZMjlrWlNJNkltWmhaR2tpTENKdVlXMWxJam9pUm1Ga2FTSjlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc2V5SnVZVzFsSWpvaVUwNVBWMDlQUWlJc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaWZYMHNJbE5oYkdWelJtOXlZMlVpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAidXNlcm5hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3VzZXJuYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicGFzc3dvcmQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3Bhc3N3b3JkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZGVwYXJ0bWVudCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZGVwYXJ0bWVudCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfbWFuYWdlcl9EZXBhcnRtZW50cygpOwoKCQl0aGlzLmNsZWFyX2NhbGxlcl9JbmNpZGVudHMoKTsKCgkJdGhpcy5jbGVhcl9jb250YWN0X0luY2lkZW50cygpOwoKCQl0aGlzLmNsZWFyX3VzZXJfR3JvdXBfTWVtYmVycygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIlVzZXIiLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCS8vIGlmKHRoaXMuX2RlcGFydG1lbnRfc2V0ICYmIHRoaXMuX2RlcGFydG1lbnQpIHRoaXMuX2RlcGFydG1lbnQuVG9vbCA9IHRvb2w7CgoJCS8vICh0aGlzLm1hbmFnZXJfRGVwYXJ0bWVudHMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQkvLyAodGhpcy5jYWxsZXJfSW5jaWRlbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJLy8gKHRoaXMuY29udGFjdF9JbmNpZGVudHMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQkvLyAodGhpcy51c2VyX0dyb3VwX01lbWJlcnMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdXNlcm5hbWUgKiovCgl1c2VybmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3VzZXJuYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgidXNlcm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3VzZXJuYW1lICE9IHYpIHsKCQkJCXRoaXMuX3VzZXJuYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl91c2VybmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl91c2VybmFtZSk7CgkJfQoJfQoKCWNsZWFyX3VzZXJuYW1lKCkgewoJCXRoaXMuX3VzZXJuYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fdXNlcm5hbWUgPSBudWxsOwoJCXRoaXMuX3VzZXJuYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB1c2VybmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHBhc3N3b3JkICoqLwoJcGFzc3dvcmQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9wYXNzd29yZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInBhc3N3b3JkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9wYXNzd29yZCAhPSB2KSB7CgkJCQl0aGlzLl9wYXNzd29yZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcGFzc3dvcmQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcGFzc3dvcmQpOwoJCX0KCX0KCgljbGVhcl9wYXNzd29yZCgpIHsKCQl0aGlzLl9wYXNzd29yZF9zZXQgPSBudWxsOwoJCXRoaXMuX3Bhc3N3b3JkID0gbnVsbDsKCQl0aGlzLl9wYXNzd29yZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcGFzc3dvcmQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkZXBhcnRtZW50ICoqLwoJZGVwYXJ0bWVudCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RlcGFydG1lbnRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkZXBhcnRtZW50Iik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnZWNkY2M0MmMtMjg3MS00ODllLWIwNmItYzRiNDk4YWRkZDdmJyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnRGVwYXJ0bWVudCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdkZXBhcnRtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiZWNkY2M0MmMtMjg3MS00ODllLWIwNmItYzRiNDk4YWRkZDdmIiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIkRlcGFydG1lbnQiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGVwYXJ0bWVudCAhPSB2KSB7CgkJCQl0aGlzLl9kZXBhcnRtZW50X3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZGVwYXJ0bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fZGVwYXJ0bWVudCA/IHRoaXMuX2RlcGFydG1lbnQuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX2RlcGFydG1lbnRfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX2RlcGFydG1lbnQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGVwYXJ0bWVudCk7CgkJfQoJfQoKCWNsZWFyX2RlcGFydG1lbnQoKSB7CgkJdGhpcy5fZGVwYXJ0bWVudF9zZXQgPSBudWxsOwoJCXRoaXMuX2RlcGFydG1lbnQgPSBudWxsOwoJCXRoaXMuX2RlcGFydG1lbnRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRlcGFydG1lbnQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoJY29kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb2RlICE9IHYpIHsKCQkJCXRoaXMuX2NvZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29kZSk7CgkJfQoJfQoKCWNsZWFyX2NvZGUoKSB7CgkJdGhpcy5fY29kZV9zZXQgPSBudWxsOwoJCXRoaXMuX2NvZGUgPSBudWxsOwoJCXRoaXMuX2NvZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCglkYXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImRhdGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJyA/IF92IDogKG5ldyBEYXRlKF92KSk7CgkJCQlpZiAoaXNOYU4oX3YuZ2V0VGltZSgpKSkgX3YgPSBudWxsOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuRGF0ZVZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RhdGUgIT0gdikgewoJCQkJdGhpcy5fZGF0ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkRhdGVWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGF0ZSk7CgkJfQoJfQoKCWNsZWFyX2RhdGUoKSB7CgkJdGhpcy5fZGF0ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2RhdGUgPSBudWxsOwoJCXRoaXMuX2RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoJbmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9uYW1lICE9IHYpIHsKCQkJCXRoaXMuX25hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX25hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbmFtZSk7CgkJfQoJfQoKCWNsZWFyX25hbWUoKSB7CgkJdGhpcy5fbmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX25hbWUgPSBudWxsOwoJCXRoaXMuX25hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCglyZW1hcmsodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9yZW1hcmtfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZW1hcmsiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3JlbWFyayAhPSB2KSB7CgkJCQl0aGlzLl9yZW1hcmtfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3JlbWFyayA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcmVtYXJrKTsKCQl9Cgl9CgoJY2xlYXJfcmVtYXJrKCkgewoJCXRoaXMuX3JlbWFya19zZXQgPSBudWxsOwoJCXRoaXMuX3JlbWFyayA9IG51bGw7CgkJdGhpcy5fcmVtYXJrX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBtYW5hZ2VyX0RlcGFydG1lbnRzICoqLwoJbWFuYWdlcl9EZXBhcnRtZW50cyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50czsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnZWNkY2M0MmMtMjg3MS00ODllLWIwNmItYzRiNDk4YWRkZDdmJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdEZXBhcnRtZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9tYW5hZ2VyX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ21hbmFnZXJfRGVwYXJ0bWVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgIm1hbmFnZXIgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkRlcGFydG1lbnQiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdtYW5hZ2VyX0RlcGFydG1lbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJtYW5hZ2VyIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiRGVwYXJ0bWVudCIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5tYW5hZ2VyKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHMucHVzaCguLi52KTsKCQl0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9tYW5hZ2VyX0RlcGFydG1lbnRzKCkgewoJCXRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50c19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG1hbmFnZXJfRGVwYXJ0bWVudHMgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjYWxsZXJfSW5jaWRlbnRzICoqLwoJY2FsbGVyX0luY2lkZW50cyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fY2FsbGVyX0luY2lkZW50czsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnZDc1ZDUwMGQtMmY3NS00ZTYxLWIzYTUtZDQ1OWZlMjYyNGM0JyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdJbmNpZGVudCcpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fY2FsbGVyX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NhbGxlcl9JbmNpZGVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgImNhbGxlciBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiSW5jaWRlbnQiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjYWxsZXJfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJjYWxsZXIgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJJbmNpZGVudCIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5jYWxsZXIodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fY2FsbGVyX0luY2lkZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX2NhbGxlcl9JbmNpZGVudHNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX2NhbGxlcl9JbmNpZGVudHNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX2NhbGxlcl9JbmNpZGVudHMoKSB7CgkJdGhpcy5fY2FsbGVyX0luY2lkZW50c19zZXQgPSBudWxsOwoJCXRoaXMuX2NhbGxlcl9JbmNpZGVudHMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9jYWxsZXJfSW5jaWRlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY2FsbGVyX0luY2lkZW50cyAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvbnRhY3RfSW5jaWRlbnRzICoqLwoJY29udGFjdF9JbmNpZGVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICdkNzVkNTAwZC0yZjc1LTRlNjEtYjNhNS1kNDU5ZmUyNjI0YzQnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0luY2lkZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9jb250YWN0X3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NvbnRhY3RfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJjb250YWN0IGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJJbmNpZGVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NvbnRhY3RfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJjb250YWN0IG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiSW5jaWRlbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YuY29udGFjdCh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9jb250YWN0X0luY2lkZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9jb250YWN0X0luY2lkZW50c19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfY29udGFjdF9JbmNpZGVudHMoKSB7CgkJdGhpcy5fY29udGFjdF9JbmNpZGVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb250YWN0X0luY2lkZW50cyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX2NvbnRhY3RfSW5jaWRlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29udGFjdF9JbmNpZGVudHMgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB1c2VyX0dyb3VwX01lbWJlcnMgKiovCgl1c2VyX0dyb3VwX01lbWJlcnModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyczsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnMmZmNGQ5NTItM2UwNy00MTQwLThjMDItYjliMTViMjhiMTQ2JyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdHcm91cCBNZW1iZXInKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX3VzZXJfc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXNlcl9Hcm91cF9NZW1iZXJzJywgJ0VudGl0eU9iamVjdCcsIDEsICJ1c2VyIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJHcm91cF9NZW1iZXIiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1c2VyX0dyb3VwX01lbWJlcnMnLCAnRW50aXR5T2JqZWN0JywgMSwgInVzZXIgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJHcm91cF9NZW1iZXIiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YudXNlcih0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl91c2VyX0dyb3VwX01lbWJlcnMucHVzaCguLi52KTsKCQl0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfdXNlcl9Hcm91cF9NZW1iZXJzKCkgewoJCXRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19zZXQgPSBudWxsOwoJCXRoaXMuX3VzZXJfR3JvdXBfTWVtYmVycyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHVzZXJfR3JvdXBfTWVtYmVycyAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX3VzZXJuYW1lX3NldCwKCgkJCXRoaXMuX3Bhc3N3b3JkX3NldCwKCgkJCXRoaXMuX2RlcGFydG1lbnRfc2V0LAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJCXRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfc2V0LAoKCQkJdGhpcy5fY2FsbGVyX0luY2lkZW50c19zZXQsCgoJCQl0aGlzLl9jb250YWN0X0luY2lkZW50c19zZXQsCgoJCQl0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fdXNlcm5hbWVfc2V0ID0gdGhpcy5fdXNlcm5hbWVfc2V0OwoJCXJldC5fdXNlcm5hbWVfY29vcCA9IHRoaXMuX3VzZXJuYW1lX2Nvb3A7CgkJcmV0LnVzZXJuYW1lID0gdGhpcy51c2VybmFtZSgpID8gdGhpcy51c2VybmFtZSgpIDogdGhpcy51c2VybmFtZSgpOwoKCQlyZXQuX3Bhc3N3b3JkX3NldCA9IHRoaXMuX3Bhc3N3b3JkX3NldDsKCQlyZXQuX3Bhc3N3b3JkX2Nvb3AgPSB0aGlzLl9wYXNzd29yZF9jb29wOwoJCXJldC5wYXNzd29yZCA9IHRoaXMucGFzc3dvcmQoKSA/IHRoaXMucGFzc3dvcmQoKSA6IHRoaXMucGFzc3dvcmQoKTsKCgkJcmV0Ll9kZXBhcnRtZW50X3NldCA9IHRoaXMuX2RlcGFydG1lbnRfc2V0OwoJCXJldC5fZGVwYXJ0bWVudF9jb29wID0gdGhpcy5fZGVwYXJ0bWVudF9jb29wOwoJCXJldC5kZXBhcnRtZW50ID0gdGhpcy5kZXBhcnRtZW50KCkgPyB0aGlzLmRlcGFydG1lbnQoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5kZXBhcnRtZW50KCk7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5tYW5hZ2VyX0RlcGFydG1lbnRzID0gdGhpcy5tYW5hZ2VyX0RlcGFydG1lbnRzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXQuY2FsbGVyX0luY2lkZW50cyA9IHRoaXMuY2FsbGVyX0luY2lkZW50cygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0LmNvbnRhY3RfSW5jaWRlbnRzID0gdGhpcy5jb250YWN0X0luY2lkZW50cygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0LnVzZXJfR3JvdXBfTWVtYmVycyA9IHRoaXMudXNlcl9Hcm91cF9NZW1iZXJzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJ1c2VybmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VybmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInBhc3N3b3JkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZGVwYXJ0bWVudCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJbWFuYWdlcl9EZXBhcnRtZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXJfVXNlcnMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQljYWxsZXJfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2FsbGVyX1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJY29udGFjdF9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250YWN0X1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJdXNlcl9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcl9Vc2VycycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCWlmICghdXNlcm5hbWUgJiYgIXBhc3N3b3JkICYmICFzYWxlc25vdy5fX3Rva2VuICYmIHRoaXMuVGVzdFsnX2F1dGhvcml6ZS51c2VybmFtZSddKSB7CgkJCXVzZXJuYW1lID0gdGhpcy5UZXN0WydfYXV0aG9yaXplLnVzZXJuYW1lJ107CgkJCXBhc3N3b3JkID0gdGhpcy5UZXN0WydfYXV0aG9yaXplLnBhc3N3b3JkJ107CgkJfQoKCQlpZiAoYlNlcnZlcikgewoJCQlpZiAodXNlcm5hbWUgJiYgIXNhbGVzbm93Ll90ZXN0VXNlcikgewoJCQkJc2FsZXNub3cuX3Rlc3RVc2VyID0gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZnJvbURvY3VtZW50KHRoaXMuVGVzdFsnX2F1dGhvcml6ZS50ZXN0VXNlciddIHx8IHt9KS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS51c2VybmFtZSh1c2VybmFtZSkucGFzc3dvcmQocGFzc3dvcmQpLnN0b3JlKCk7CgkJCX0KCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMudXNlcm5hbWUodXNlcm5hbWUsICc9JykucGFzc3dvcmQocGFzc3dvcmQsICc9JykuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuZmluZCgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfYXV0aG9yaXplJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXJ2ZXI6ICIgKyBiU2VydmVyICsgIiwgT2JqOiIsIHJldCk7CgoJCQlpZiAocmV0KSB7CgkJCQlpZiAodHlwZW9mKGpzb253ZWJ0b2tlbikgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJcmV0ID0ganNvbndlYnRva2VuLnNpZ24ocmV0Ll90b0RvY3VtZW50KCksIHRoaXMuX19jb25maWcoJ3NlY3JldCcpLCB7CgkJCQkJCWV4cGlyZXNJbjogJzE4MDBzJwoJCQkJCX0pOwoJCQkJfSBlbHNlIHsKCQkJCQlyZXQgPSB0aGlzLl9idG9hKEpTT04uc3RyaW5naWZ5KHJldC5fdG9Eb2N1bWVudCgpKSk7CgkJCQl9CgkJCX0KCgkJCXJldCA9IHsKCQkJCWFjY2Vzc190b2tlbjogcmV0LAoJCQl9OwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfYXV0aG9yaXplJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXJ2ZXI6ICIgKyBiU2VydmVyICsgIiwgdG9rZW46ICIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBlbHNlIHsKCQkJbGV0IGNsaWVudF9pZCA9IHRoaXMuX19jb25maWcoJ2NsaWVudF9pZCcpOwoJCQlsZXQgY2xpZW50X3NlY3JldCA9IHRoaXMuX19jb25maWcoJ3NlY3JldCcpOwoKCQkJaWYgKCF1c2VybmFtZSAmJiAhcGFzc3dvcmQgJiYgc2FsZXNub3cuX190b2tlbikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2F1dGhvcml6ZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gdXNlcm5hbWUvcGFzc3dvcmQgYW5kIHRva2VuIGFscmVhZHkgZXhpc3RzIik7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXNhbGVzbm93Ll9fdG9rZW4gPSBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLnVzZXJuYW1lKHVzZXJuYW1lKS5wYXNzd29yZChwYXNzd29yZCkuYXV0aG9yaXplKCk7CgoJCX0KCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJkZXBhcnRtZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBkZXBhcnRtZW50Jywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5EZXBhcnRtZW50KCkuZGVwYXJ0bWVudF9Vc2Vycyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX3NlcnZlcihvcHRpb25zID0ge30pIHsKCQlpZiAob3B0aW9ucy5jbGVhckNvbnNvbGUgJiYgdHlwZW9mKGNsZWFyKSAhPT0gJ3VuZGVmaW5lZCcpIGNsZWFyKCk7CgoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgc2FsZXNub3cuaHJlZnMpIHsKCQkJZm9yIGF3YWl0IChjb25zdCBsIG9mIHNhbGVzbm93LmhyZWZzLm1hcChuID0+IG4ubGliKSkgewoJCQkJYXdhaXQgdGhpcy5yZXF1aXJlKGwsIHNhbGVzbm93LmhyZWZzKTsKCQkJfQoJCX0KCgkJbGV0IHNlY3VyZSA9IHRoaXMuX19jb25maWcoJ3NlY3VyZScpOwoJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gZ2xvYmFscwoJCQl2YXIgZ2xvYmFsTW9kdWxlcyA9IHsKCQkJCWV4cHJlc3M6ICdleHByZXNzJywKCQkJCWh0dHBzOiAnaHR0cHMnLAoJCQkJaHR0cDogJ2h0dHAnLAoJCQkJc2VsZnNpZ25lZDogJ3NlbGZzaWduZWQnLAoJCQkJdXRpbDogJ3V0aWwnLAoJCQkJY29yczogJ2NvcnMnLAoJCQkJYm9keVBhcnNlcjogJ2JvZHktcGFyc2VyJywKCQkJCWF4aW9zOiAnYXhpb3MnLAoJCQkJLy9jcnlwdG86ICdjcnlwdG8nLAoJCQkJZnM6ICdmcycsCgkJCQlvczogJ29zJywKCQkJCURvdE9iamVjdDogJ2RvdC1vYmplY3QnLAoKCQkJCW1pbmltaXN0OiAnbWluaW1pc3QnLAoKCQkJCW1hY2hpbmVpZDogJ25vZGUtbWFjaGluZS1pZCcsCgkJCQljaGlsZF9wcm9jZXNzOiAnY2hpbGRfcHJvY2VzcycsCgoJCQkJZXZlbnRzOiAnZXZlbnRzJywKCQkJCXNvY2tldGlvOiAnc29ja2V0LmlvJywKCQkJCW1xdHQ6ICdtcXR0JywKCgkJCQlqc29ud2VidG9rZW46ICdqc29ud2VidG9rZW4nLAoKCQkJCXNxbGl0ZTogJ3NxbGl0ZTMnLAoJCQkJbXlzcWw6ICdteXNxbCcsCgoJCQl9OwoKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX3NlcnZlcicsICdFbnRpdHlPYmplY3QnLCAwLCAibnBtIGluc3RhbGwgIiArIE9iamVjdC52YWx1ZXMoZ2xvYmFsTW9kdWxlcykuam9pbignICcpKTsKCQkJbGV0IG1pc3NpbmdHbG9iYWxNb2R1bGVzID0gT2JqZWN0LmVudHJpZXMoZ2xvYmFsTW9kdWxlcykubWFwKGUgPT4gewoJCQkJdHJ5IHsKCQkJCQlnbG9iYWxbZVswXV0gPSByZXF1aXJlKGVbMV0pOwoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc2VydmVyJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJCQlyZXR1cm4gZVsxXTsKCQkJCX0KCQkJfSkuZmlsdGVyKGUgPT4gZSk7CgkJCWlmIChtaXNzaW5nR2xvYmFsTW9kdWxlcy5sZW5ndGgpIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19zZXJ2ZXInLCAnRW50aXR5T2JqZWN0JywgMSwgIm5wbSBpbnN0YWxsICIgKyBtaXNzaW5nR2xvYmFsTW9kdWxlcy5qb2luKCcgJykpOwoJCX0KCgkJaWYgKG9wdGlvbnMuaW5pdE5vZGUpIHNhbGVzbm93Ll9ub2RlID0gYXdhaXQgbmV3IHNhbGVzbm93Lk5vZGUoKS5zZWN1cmUoc2VjdXJlKS5pbml0KHRoaXMuX19jb25maWcoJ2luaXQubG9vcCcpIHx8IDAuNSk7CgoJCWlmIChvcHRpb25zLmluaXRTZWxmKSB7CgkJCWlmICh0aGlzLmluaXQpIHsKCQkJCWF3YWl0IHRoaXMuX3dhaXQoNTAwKTsKCQkJCWlmIChvcHRpb25zLmxvYWRUb29scykgYXdhaXQgdGhpcy5fbG9hZFRvb2xzKG9wdGlvbnMuc2F2ZVRvb2xzKTsKCgkJCQlhd2FpdCB0aGlzLmluaXQoKTsKCgkJCQlsZXQgc3FsVG9vbCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQuX19kbWxTdGF0ZW1lbnRzKTsKCQkJCWlmIChvcHRpb25zLmNvcHlETUwgJiYgc3FsVG9vbCkgewoJCQkJCWxldCBkbWxzID0gc3FsVG9vbC5fX2RtbFN0YXRlbWVudHM7CgkJCQkJaWYgKHNxbFRvb2wudHlwZS5uYW1lID09ICdTcWxEQicpIGRtbHMgPSBbIC8qIkN1c3RvbWVycyIsICJPcmRlcnMiLCAiU2hpcHBpbmdzIiwgKi8gImRlbW8iXS5tYXAodCA9PiBgZHJvcCB0YWJsZSBpZiBleGlzdHMgJHt0fWApLmNvbmNhdChkbWxzKTsKCQkJCQlfRnJFTUQuX2NvcHlUZXh0VG9DbGlwYm9hcmQoZG1scy5qb2luKCc7XG4nKSk7CgkJCQl9CgkJCX0KCQl9CgoJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gcmVmcmVzaCBzY3JpcHQKCQkJdGhpcy5zZXRJbnRlcnZhbChhc3luYyAocykgPT4gYXdhaXQgdGhpcy5fcmVmcmVzaEFQSShzLCAnYXBpc2VydmVyLmpzJyksIDAuNSwgcHJvY2Vzcy5hcmd2LnNsaWNlKDIpLmxlbmd0aCA/IHByb2Nlc3MuYXJndi5zbGljZSgyKVswXSA6ICdzYWxlc25vdycpOwoKCQkJY29uc3QgYXBwID0gZXhwcmVzcygpOwoKCQkJYXBwLnVzZShjb3JzKCkpOwoKCQkJYXBwLnVzZShleHByZXNzLnVybGVuY29kZWQoewoJCQkJZXh0ZW5kZWQ6IHRydWUsCgkJCQlsaW1pdDogJzUwbWInCgkJCX0pKTsKCQkJYXBwLnVzZShib2R5UGFyc2VyLmpzb24oewoJCQkJdmVyaWZ5OiAocmVxLCByZXMsIGJ1ZikgPT4gcmVxLnJhd0JvZHkgPSBidWYKCQkJfSkpOwoKCQkJZ2xvYmFsLmF1dGhlbnRpY2F0ZSA9IGFzeW5jIChyZXEsIHJlcywgbmV4dCkgPT4gewoJCQkJY29uc3QgYXV0aEhlYWRlciA9IHJlcS5oZWFkZXJzWydhdXRob3JpemF0aW9uJ107CgkJCQljb25zdCB0b2tlbiA9IGF1dGhIZWFkZXIgJiYgYXV0aEhlYWRlci5zcGxpdCgnICcpWzFdOwoKCQkJCWlmICh0b2tlbiA9PSBudWxsKSByZXR1cm4gcmVzLnNlbmRTdGF0dXMoNDAxKTsKCgkJCQlqc29ud2VidG9rZW4udmVyaWZ5KHRva2VuLCB0aGlzLl9fY29uZmlnKCdzZWNyZXQnKSwgKGVyciwgb2JqKSA9PiB7CgkJCQkJaWYgKGVycikgcmV0dXJuIHJlcy5zZW5kU3RhdHVzKDQwMyk7CgoJCQkJCXJlcS5fX2F1dGhvcml6YXRpb24gPSBvYmo7CgkJCQkJbmV4dCgpOwoJCQkJfSk7CgkJCX07CgoJCQlhcHAucG9zdCgnL21ldGhvZC9Vc2VyL2F1dGhvcml6ZScsIChyZXEsIHJlcykgPT4gdGhpcy5faW5ib3VuZENhbGwocmVxLCByZXMsICJVc2VyIiwgImF1dGhvcml6ZSIpKTsKCQkJYXBwLmdldCgnL21ldGhvZC9Vc2VyL2F1dGhvcml6ZScsIChyZXEsIHJlcykgPT4gdGhpcy5faW5ib3VuZENhbGwocmVxLCByZXMsICJVc2VyIiwgImF1dGhvcml6ZSIpKTsKCgkJCWFwcC5wb3N0KCcvbWV0aG9kLzpjbGFzcy86bWV0aG9kJywgZ2xvYmFsLmF1dGhlbnRpY2F0ZSwgKHJlcSwgcmVzKSA9PiB0aGlzLl9pbmJvdW5kQ2FsbChyZXEsIHJlcykpOwoJCQlhcHAuZ2V0KCcvbWV0aG9kLzpjbGFzcy86bWV0aG9kJywgZ2xvYmFsLmF1dGhlbnRpY2F0ZSwgKHJlcSwgcmVzKSA9PiB0aGlzLl9pbmJvdW5kQ2FsbChyZXEsIHJlcykpOwoKCQkJaWYgKHRoaXMuX19jb25maWcoJ2VtYWlsLmhvc3QnKSkgewoJCQkJc2FsZXNub3cudHJhbnNwb3J0ZXIgPSBub2RlbWFpbGVyLmNyZWF0ZVRyYW5zcG9ydCh7CgkJCQkJc2VydmljZTogdGhpcy5fX2NvbmZpZygnZW1haWwuaG9zdCcpLAoJCQkJCWF1dGg6IHRoaXMuX19jb25maWcoJ2VtYWlsLnVzZXInKSA/IHsKCQkJCQkJdXNlcjogdGhpcy5fX2NvbmZpZygnZW1haWwudXNlcicpLAoJCQkJCQlwYXNzOiB0aGlzLl9fY29uZmlnKCdlbWFpbC5wYXNzd29yZCcpLAoJCQkJCX0gOiB1bmRlZmluZWQsCgkJCQl9KTsKCgkJCQkvKgoJCQkJYXdhaXQgc2FsZXNub3cudHJhbnNwb3J0ZXIuc2VuZE1haWwoewoJCQkJICAgIGZyb206IHRoaXMuX19jb25maWcoJ2VtYWlsLnNlbmRlcicpLAoJCQkJICAgIHRvLAoJCQkJICAgIHN1YmplY3QsCgkJCQkgICAgdGV4dCwKCQkJCX0pOwoJCQkJKi8KCQkJfQoKCQkJbGV0IHBvcnQgPSBzYWxlc25vdy5fbm9kZSA/IChzYWxlc25vdy5fbm9kZS5wb3J0KCkgfHwgMzAwMCkgOiAzMDAwOwoJCQlsZXQgYWRkcmVzcyA9ICIwLjAuMC4wIjsKCgkJCWlmICh0aGlzLl9fY29uZmlnKCdDT1JTUHJveHknKSkgewoJCQkJY29yc19wcm94eS5jcmVhdGVTZXJ2ZXIoewoJCQkJCW9yaWdpbldoaXRlbGlzdDogW10sIC8vIEFsbG93IGFsbCBvcmlnaW5zCgkJCQkJcmVxdWlyZUhlYWRlcjogWydvcmlnaW4nLCAneC1yZXF1ZXN0ZWQtd2l0aCddLAoJCQkJCXJlbW92ZUhlYWRlcnM6IFsnY29va2llJywgJ2Nvb2tpZTInXQoJCQkJfSkubGlzdGVuKDgwMDAsIGFkZHJlc3MsIGZ1bmN0aW9uKCkgewoJCQkJCWNvbnNvbGUubG9nKCdSdW5uaW5nIENPUlMgQW55d2hlcmUgb24gJyArIGFkZHJlc3MgKyAnOicgKyAnODAwMCcpOwoJCQkJfSk7CgkJCX0KCgkJCWxldCBsaXN0ZW4gPSBhc3luYyAoKSA9PiB0aGlzLmxvZyh1bmRlZmluZWQsICdfc2VydmVyJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzYWxlc25vd1ske3RoaXMuaXBBZGRyZXNzKCl9XSBsaXN0ZW5pbmcgYXQgaHR0cCR7c2VjdXJlPydzJzonJ306Ly8ke2FkZHJlc3N9OiR7cG9ydH1gKTsKCQkJaWYgKHNlY3VyZSkgewoJCQkJbGV0IGNlcnQgPSBudWxsOwoJCQkJaWYgKHRoaXMuX19jb25maWcoJ3NlY3VyZS5wcml2YXRlJykpIHsKCQkJCQljZXJ0ID0gewoJCQkJCQlwcml2YXRlOiAoYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUodGhpcy5fX2NvbmZpZygnc2VjdXJlLnByaXZhdGUnKSkpLAoJCQkJCQljZXJ0OiAoYXdhaXQgZnMucHJvbWlzZXMucmVhZEZpbGUodGhpcy5fX2NvbmZpZygnc2VjdXJlLmNlcnQnKSkpLAoJCQkJCX07CgkJCQl9IGVsc2UgewoJCQkJCWNlcnQgPSBzZWxmc2lnbmVkLmdlbmVyYXRlKFt7CgkJCQkJCW5hbWU6ICdjb21tb25OYW1lJywKCQkJCQkJdmFsdWU6ICduYW1tb3VyLmNvbScKCQkJCQl9XSwgewoJCQkJCQlkYXlzOiAzNjUKCQkJCQl9KTsKCQkJCX0KCQkJCWdsb2JhbC5leFNlcnZlciA9IGh0dHBzLmNyZWF0ZVNlcnZlcih7CgkJCQkJa2V5OiBjZXJ0LnByaXZhdGUsCgkJCQkJY2VydDogY2VydC5jZXJ0CgkJCQl9LCBhcHApLmxpc3Rlbihwb3J0LCBhZGRyZXNzLCBsaXN0ZW4pOwoJCQl9IGVsc2UgewoJCQkJZ2xvYmFsLmV4U2VydmVyID0gaHR0cC5jcmVhdGVTZXJ2ZXIoYXBwKS5saXN0ZW4ocG9ydCwgYWRkcmVzcywgbGlzdGVuKTsKCQkJfQoJCX0KCX0KCglhc3luYyBfaW5ib3VuZENhbGwocmVxLCByZXMsIGNOYW1lLCBtTmFtZSkgewoJCWxldCByZXQgPSB7fTsKCQl0cnkgewoJCQlyZXQgPSBhd2FpdCBuZXcgc2FsZXNub3dbcmVxLnBhcmFtcy5jbGFzcyB8fCBjTmFtZV0oKS5faW52b2tlKHJlcS5wYXJhbXMubWV0aG9kIHx8IG1OYW1lLCByZXEuYm9keSwgcmVxLnF1ZXJ5LCByZXEuX19hdXRob3JpemF0aW9uKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW5ib3VuZENhbGwnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQlyZXQgPSB7CgkJCQlFeGNlcHRpb246ICJFeGNlcHRpb246ICIgKyBleCwKCQkJfTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJlcS5xdWVyeVsianNvbiJdICE9ICJ0cnVlIiAmJiByZXEuYm9keSAmJiByZXEuYm9keS5fX2ZsYXR0ZWQpIHJldCA9IHsKCQkJX19mbGF0dGVkOiBGbGF0dGVkLnN0cmluZ2lmeShyZXQpCgkJfTsKCgkJaWYgKHJldCAmJiB0eXBlb2YocmV0KSA9PT0gIm51bWJlciIpIHJldCA9IHJldC50b1N0cmluZygpOwoJCXJlcy5zZW5kKHJldCk7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpICE9ICdVc2VyJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQkJY2FzZSAiaW5pdCI6IHsKCgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJY2FzZSAiYXV0aG9yaXplIjogewoKCQkJCQlicmVhazsKCQkJCX0KCgkJCX0KCQl9CgoJCWlmICghbiB8fCBzYWxlc25vdy5fbm9kZS5fc2FtZU5vZGUobikpIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkNhbGxiYWNrIik7CgkJCXJldCA9IGF3YWl0IHRoaXMuX2ludm9rZShtZXRob2QsIGRhdGEpOwoJCX0gZWxzZSBpZiAobi5hZGRyZXNzKCkgJiYgbi5fc2FtZU5vZGUobikgLyphY3R1YWwgbm9kZSovICkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBuLl9hZGRyZXNzLCBuLl9wb3J0LCBtZXRob2QpOwoJCQl0cnkgewoJCQkJbGV0IGNvbmZpZyA9IHsKCQkJCQloZWFkZXJzOiB7fSwKCQkJCX07CgkJCQlpZiAoc2FsZXNub3cuX190b2tlbikgY29uZmlnLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGAke3NhbGVzbm93Ll9fdG9rZW4udG9rZW5fdHlwZX0gJHtzYWxlc25vdy5fX3Rva2VuLmFjY2Vzc190b2tlbn1gOwoJCQkJcmV0ID0gYXdhaXQgYXhpb3MucG9zdChgaHR0cCR7bi5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHtuLmFkZHJlc3MoKX06JHtuLnBvcnQoKSB8fCAzMDAwfS9tZXRob2QvVXNlci8ke21ldGhvZH1gLCBkYXRhLCBjb25maWcpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQl9CgkJfSBlbHNlIHsKCgkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMuX19nZW5lcmF0ZWQ7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMub25saW5lOwoKCQkJfQoKCQkJLy93aHkgZG8gd2UgbmVlZCB0aGlzPz8/CgoJCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQkJdHJ5IHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHttZXRob2R9YCk7CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJbGV0IF9pZCA9IG51bGw7CgkJCQlpZiAodHlwZW9mKGRhdGEpID09PSAndW5kZWZpbmVkJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIGRhdGEsIG1ldGhvZCwge30pOwoJCQkJCXJldHVybiBkYXRhOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoZGF0YSkgPT09ICdzdHJpbmcnKSB7CgkJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShkYXRhKTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gZGF0YS5fX3RoaXMuY29kZSB8fCBkYXRhLmlkIHx8IGRhdGEuSUQ7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQkJaWYgKGRhdGEuSWQgJiYgZGF0YS5JZCA9PSBkYXRhLklkKSB7CgkJCQkJCV9pZCA9IGRhdGEuSWQ7CgkJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCQl9IGVsc2UgaWYgKGRhdGEuRW50aXR5Q2xhc3MpIHsKCQkJCQkJX2lkID0gZGF0YS5FbnRpdHlDbGFzcy5JZCB8fCBkYXRhLkVudGl0eUNsYXNzLk5hbWU7CgkJCQkJfSBlbHNlIHsKCQkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiMDI2NDVjNWMtYmUwNC00ZGFiLTkxYjQtZjhjODViZTk0YTZlIiB8fCAiTlVMTCI7CgkJCQkJfQoJCQkJfQoKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW21ldGhvZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVXNlclttZXRob2RdW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbbWV0aG9kXVtfaWRdIHx8IHt9OwoKCQkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaCh7fSwgewoJCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCQl9KTsKCgkJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW21ldGhvZF1bX2lkXVtfaGFzaF0gPSB7CgkJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoe30pLAoJCQkJCW9iajogZGF0YSwKCQkJCQlyZXVzZWQ6IDAsCgkJCQl9OwoJCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0gPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGRhdGEsIG1ldGhvZCwge30sIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBgVHJpZ2dlcnJpbmcgJHttZXRob2R9IHRvICR7bi5jb2RlKCl9ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSxudWxsLDQpfWApOwoKCQkJbGV0IGV2ID0gbmV3IHNhbGVzbm93LkV2ZW50KCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuY29kZSh0aGlzLl91dWlkKCkpLm5hbWUodGhpcy5fX2NvbmZpZygnZXZlbnQnKSB8fCAnc2FsZXNub3cuRXZlbnQnKS5kYXRlKHRoaXMuc2VydmVyRGF0ZSgpKS5yZWNpcGllbnQobikubWV0aG9kKG1ldGhvZCkuY2xhc3NOYW1lKCdVc2VyJykuc2VuZGVyKHNhbGVzbm93Ll9ub2RlKS5jYXJyaWVyKHNhbGVzbm93Ll9ub2RlKS5wYXlsb2FkKGRhdGEpOwoJCQlpZiAoZXZlbnQpIHsKCQkJCWlmIChldmVudC5fcmVzcG9uc2VUb19zZXQpIGV2LnJlc3BvbnNlVG8oZXZlbnQucmVzcG9uc2VUbygpKTsKCQkJCWlmIChldmVudC5fc2VuZGVyX3NldCkgZXYuc2VuZGVyKGV2ZW50LnNlbmRlcigpKTsKCQkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCkgZXYuY2xhc3NOYW1lKGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCWlmIChldmVudC5fY2Fycmllcl9zZXQgfHwgZXZlbnQuX3NlbmRlcl9zZXQpIGV2LmNhcnJpZXIoZXZlbnQuY2FycmllcigpIHx8IGV2ZW50LnNlbmRlcigpKTsKCQkJfQoJCQlyZXQgPSBhd2FpdCBldi50cmlnZ2VyKCk7CgoJCQlpZiAodHlwZW9mKHJldCkgPT09ICJzdHJpbmciKSB7CgkJCQl0cnkgewoJCQkJCXJldCA9IEpTT04ucGFyc2UocmV0KTsKCQkJCX0gY2F0Y2ggKGV4KSB7fQoJCQl9CgkJCXJldHVybiByZXQ7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5pdCI6IHsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiYXV0aG9yaXplIjogewoKCQkJCXNhbGVzbm93Ll9fdG9rZW4gPSB7CgkJCQkJdG9rZW5fdHlwZTogIkJlYXJlciIsCgkJCQkJYWNjZXNzX3Rva2VuOiByZXQKCQkJCX07CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LlVzZXIobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93LlVzZXIobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOwoJCX0KCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5pdCI6IHsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiYXV0aG9yaXplIjogewoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBVc2VyLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgVXNlci5faW52b2tlOiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLAoJCQkJCSdvYmonOiBvYmoKCQkJCX0KCQkJfTsKCQl9IGVsc2UgewoJCQlyZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOwoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJaWYgKGZhbHNlICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQlyZXQgPSB7CgkJCQkJX19leGNlcHRpb246IHsKCQkJCQkJJy00JzogIlVuY29tbWl0dGVkIHRyYW5zYWN0aW9uczogIiArIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uc3Fscy5sZW5ndGgsCgkJCQkJCSdvYmonOiBvYmoKCQkJCQl9CgkJCQl9CgkJCX0KCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQl9CgoJCWlmIChyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbikgewoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0ge307CgkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCXJldCA9IHJldC5tYXAociA9PiB7CgkJCQkJaWYgKHIgJiYgci5fdG9Eb2N1bWVudCkgewoJCQkJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyLl90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93LlVzZXIuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglfcGFyc2VDb2RlU3RhdGUodCkgewoKCQlsZXQgc3RhdGUgPSB0aGlzLl9fY29uZmlnKHRoaXMuX19jb25maWcoJ29hdXRoLnJlZGlyZWN0LnN0YXRlJywgbnVsbCwgewoJCQl0b29sOiB0CgkJfSkpOwoJCWxldCBjb2RlID0gdGhpcy5fX2NvbmZpZyh0aGlzLl9fY29uZmlnKCdvYXV0aC5yZWRpcmVjdC5jb2RlJywgbnVsbCwgewoJCQl0b29sOiB0CgkJfSkpOwoJCWlmICghc3RhdGUgfHwgIWNvZGUpIHJldHVybjsKCQlzdGF0ZSA9IEpTT04ucGFyc2UodGhpcy5fYXRvYihzdGF0ZSkpOwoJCWlmIChzdGF0ZS50b29sICE9PSB0Lm5hbWUpIHJldHVybjsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3BhcnNlQ29kZVN0YXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHT1QgQ09ERSAiICsgY29kZSArICIgZm9yIG5vZGUgIiArIHN0YXRlLm5jb2RlICsgIiB3aXRoIHRvb2wgIiArIHN0YXRlLnRvb2wpOwoJCWlmICghc2FsZXNub3cuX25vZGUucGFyZW50KCkgfHwgIXNhbGVzbm93Ll9ub2RlLl9wYXJlbnQuX3NhbWVOb2RlKHNhbGVzbm93Ll9ub2RlLnBhcmVudCgpKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcGFyc2VDb2RlU3RhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgJ25ldyBwYXJlbnQnLCBzdGF0ZS5uY29kZSk7CgkJCXNhbGVzbm93Ll9ub2RlLnBhcmVudChuZXcgc2FsZXNub3cuTm9kZSgpLmNvZGUoc3RhdGUubmNvZGUpKTsKCQl9CgkJc2FsZXNub3cuX25vZGUuYXV0aENvZGUoY29kZSwgbmV3IHNhbGVzbm93LlRvb2woKS5uYW1lKHN0YXRlLnRvb2wpKTsKCQl3aW5kb3cuY2xvc2UoKTsKCgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlpZiAoc2FsZXNub3cuVG9vbHMgJiYgc2FsZXNub3cuVG9vbHMubGVuZ3RoKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19sb2FkVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMCwgYFske3NvdXJjZX1dOiBUb29scyBhbHJlYWR5IGxvYWRlZGApOwoJCQlyZXR1cm4gc2FsZXNub3cuVG9vbHM7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbG9hZFRvb2xzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBbJHtzb3VyY2V9XTogTG9hZGluZyB0b29scy4uLmApOwoKCQlkZWxldGUgc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3M7CgoJCWlmIChzYWxlc25vdy5fbm9kZSAmJiBzYWxlc25vdy5fbm9kZS5fcGFyZW50X3NldCAmJiBzYWxlc25vdy5fbm9kZS5wYXJlbnQoKS5fc2FtZU5vZGUoc2FsZXNub3cuX25vZGUucGFyZW50KCkpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19sb2FkVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMCwgYFske3NvdXJjZX1dOiBMb2FkaW5nIGZyb20gbm9kZSBwYXJlbnRgKTsKCQkJbGV0IHJldCA9IHNhbGVzbm93LlRvb2wgPyAoYXdhaXQgbmV3IHNhbGVzbm93LlRvb2woKS4gLypub2RlKHNhbGVzbm93Ll9ub2RlKS4qLyBmaW5kQWxsKDIpKS5tYXAodCA9PiB0Ll90b0RvY3VtZW50KCkpIDogbnVsbDsKCQkJaWYgKHJldCAmJiByZXQubGVuZ3RoKSB7CgkJCQlzYWxlc25vdy5Ub29scyA9IHJldDsKCQkJCXJldHVybiByZXQ7CgkJCX0KCQl9CgoJCWxldCB0b29scyA9IFt7CgkJCXR5cGU6IHsKCQkJCW5hbWU6ICJTcWxEQiIsCgkJCX0sCgkJCXRvb2xfQ29uZmlnczogW3sKCQkJCW5hbWU6ICJjcmVhdGUiLAoJCQkJdmFsdWU6IDMsCgkJCX0sIHsKCQkJCW5hbWU6ICJ0eXBlIiwKCQkJCXZhbHVlOiAic3FsaXRlIiwKCQkJfSwgewoJCQkJbmFtZTogIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIiwKCQkJCXZhbHVlOiB0cnVlLAoJCQl9LCB7CgkJCQluYW1lOiAiU3luY1R5cGVkQXR0cmlidXRlcyIsCgkJCQl2YWx1ZTogdHJ1ZSwKCQkJfV0KCQl9XTsKCgkJdHJ5IHsKCQkJbGV0IGZOYW1lID0gIkFQSVNFUlZFUl9fbG9hZFRvb2xzLmpzb24iOwoJCQlpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnICYmIGZzLmV4aXN0c1N5bmMoZk5hbWUpKSB0b29scyA9IHRoaXMucnVuU2NyaXB0KGF3YWl0IGZzLnByb21pc2VzLnJlYWRGaWxlKGZOYW1lKSkgfHwgdG9vbHM7CgkJCWlmICh0aGlzLl9fY29uZmlnKCJnaXRodWIudG9vbHMiKSkgdG9vbHMgPSB0aGlzLnJ1blNjcmlwdChhd2FpdCBheGlvcy5nZXQodGhpcy5fX2NvbmZpZygiZ2l0aHViLnRvb2xzIikgKyBmTmFtZSwgewoJCQkJdmFsaWRhdGVTdGF0dXM6IHN0YXR1cyA9PiBzdGF0dXMgPCA1MDAKCQkJfSkuZGF0YSkgfHwgdG9vbHM7CgoJCQlsZXQgdERhdGEgPSBudWxsOwoJCQlpZiAodGhpcy5zcigpKSB0RGF0YSA9IGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNTdG9yZWRTY3JpcHRGaW5kIiwgbnVsbCwgewoJCQkJTmFtZTogZk5hbWUsCgkJCQlBY3RpdmU6IHRydWUsCgkJCQlFbmFibGVkOiB0cnVlCgkJCX0pOwoJCQlpZiAoIXREYXRhKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbG9hZFRvb2xzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBbJHtzb3VyY2V9XTogVG9vbHMgbm90IGluIENNU2ApOwoJCQl9IGVsc2UgewoJCQkJdG9vbHMgPSB0aGlzLnJ1blNjcmlwdCh0RGF0YS5TY3JpcHQpIHx8IHRvb2xzOwoJCQl9CgoJCQl0b29scyA9IHNhbGVzbm93Ll9fVG9vbHMgfHwgdG9vbHM7CgkJCWRlbGV0ZSBzYWxlc25vdy5fX1Rvb2xzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19sb2FkVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCX0KCgkJdG9vbHMuZmlsdGVyKHQgPT4gdHlwZW9mKHQuYWN0aXZlKSA9PT0gInVuZGVmaW5lZCIgfHwgKHR5cGVvZih0LmFjdGl2ZSkgPT09ICJ1bmRlZmluZWQiICYmIHQuYWN0aXZlKSkuZm9yRWFjaCh0ID0+IHsKCQkJdC5uYW1lID0gdC5uYW1lIHx8IHQudHlwZS5uYW1lOwoKCQkJdC5hY3RpdmUgPSB0eXBlb2YodC5hY3RpdmUpICE9PSAndW5kZWZpbmVkJyA/IHQuYWN0aXZlIDogdHJ1ZTsKCQkJdC5lbmFibGVkID0gdHlwZW9mKHQuZW5hYmxlZCkgIT09ICd1bmRlZmluZWQnID8gdC5lbmFibGVkIDogdHJ1ZTsKCQkJdC50eXBlLmFjdGl2ZSA9IHR5cGVvZih0LnR5cGUuYWN0aXZlKSAhPT0gJ3VuZGVmaW5lZCcgPyB0LnR5cGUuYWN0aXZlIDogdHJ1ZTsKCQkJdC50eXBlLmVuYWJsZWQgPSB0eXBlb2YodC50eXBlLmVuYWJsZWQpICE9PSAndW5kZWZpbmVkJyA/IHQudHlwZS5lbmFibGVkIDogdHJ1ZTsKCgkJCXQudG9vbF9Db25maWdzID0gdC50b29sX0NvbmZpZ3MgfHwgW107CgkJCXQudG9vbF9Db25maWdzLmZvckVhY2goYyA9PiB7CgkJCQljLmFjdGl2ZSA9IHR5cGVvZihjLmFjdGl2ZSkgIT09ICd1bmRlZmluZWQnID8gYy5hY3RpdmUgOiB0cnVlOwoJCQkJYy5lbmFibGVkID0gdHlwZW9mKGMuZW5hYmxlZCkgIT09ICd1bmRlZmluZWQnID8gYy5lbmFibGVkIDogdHJ1ZTsKCQkJfSk7CgoJCQl0LnR5cGUudHlwZV9Db25maWdzID0gdC50eXBlLnR5cGVfQ29uZmlncyB8fCBbXTsKCQkJdC50eXBlLnR5cGVfQ29uZmlncy5mb3JFYWNoKGMgPT4gewoJCQkJYy5hY3RpdmUgPSB0eXBlb2YoYy5hY3RpdmUpICE9PSAndW5kZWZpbmVkJyA/IGMuYWN0aXZlIDogdHJ1ZTsKCQkJCWMuZW5hYmxlZCA9IHR5cGVvZihjLmVuYWJsZWQpICE9PSAndW5kZWZpbmVkJyA/IGMuZW5hYmxlZCA6IHRydWU7CgkJCX0pOwoKCQkJdC50eXBlLnR5cGVfTWFwcGluZ3MgPSB0LnR5cGUudHlwZV9NYXBwaW5ncyB8fCBbXTsKCQkJdC50eXBlLnR5cGVfTWFwcGluZ3MuZm9yRWFjaChtID0+IHsKCQkJCW0uYWN0aXZlID0gdHlwZW9mKG0uYWN0aXZlKSAhPT0gJ3VuZGVmaW5lZCcgPyBtLmFjdGl2ZSA6IHRydWU7CgkJCQltLmVuYWJsZWQgPSB0eXBlb2YobS5lbmFibGVkKSAhPT0gJ3VuZGVmaW5lZCcgPyBtLmVuYWJsZWQgOiB0cnVlOwoJCQkJbS50eXBlID0gewoJCQkJCW5hbWU6IHQudHlwZS5uYW1lCgkJCQl9OwoJCQl9KTsKCgkJCXQudG9vbF9NYXBwaW5ncyA9IHQudG9vbF9NYXBwaW5ncyB8fCBbXTsKCQkJdC50b29sX01hcHBpbmdzLmZvckVhY2gobSA9PiB7CgkJCQltLmFjdGl2ZSA9IHR5cGVvZihtLmFjdGl2ZSkgIT09ICd1bmRlZmluZWQnID8gbS5hY3RpdmUgOiB0cnVlOwoJCQkJbS5lbmFibGVkID0gdHlwZW9mKG0uZW5hYmxlZCkgIT09ICd1bmRlZmluZWQnID8gbS5lbmFibGVkIDogdHJ1ZTsKCQkJCW0udG9vbCA9IHsKCQkJCQluYW1lOiB0Lm5hbWUKCQkJCX07CgkJCX0pOwoJCX0pOwoJCXRvb2xzID0gdG9vbHMuZmlsdGVyKHQgPT4gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzSWxOT1QxZFBUMElpTENKVFlXeGxjMFp2Y21ObElpd2lSMmwwU0hWaUlsMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KS5maW5kKF90ID0+ICh0eXBlb2YoX3QpID09PSAnc3RyaW5nJyA/IF90IDogX3QubmFtZSkgPT0gdC5uYW1lKSk7CgoJCXRvb2xzLmZvckVhY2godCA9PiBbJ3Rvb2xfQ29uZmlncycsICd0eXBlLnR5cGVfQ29uZmlncyddLmZvckVhY2goc0NvbmZpZyA9PiB7CgkJCURvdE9iamVjdC5zZXQoc0NvbmZpZywgRG90T2JqZWN0LnBpY2soc0NvbmZpZywgdCkuZmlsdGVyKGMgPT4gdHlwZW9mKGMudmFsdWUpICE9PSAib2JqZWN0IikuY29uY2F0KERvdE9iamVjdC5waWNrKHNDb25maWcsIHQpLmZpbHRlcihjID0+IHR5cGVvZihjLnZhbHVlKSA9PT0gIm9iamVjdCIpLm1hcChjID0+IE9iamVjdC5rZXlzKGMudmFsdWUpLm1hcChuY29kZSA9PiB7CgkJCQlsZXQgX2MgPSB7CgkJCQkJbmFtZTogYy5uYW1lLAoJCQkJCXZhbHVlOiBjLnZhbHVlW25jb2RlXSwKCQkJCX07CgkJCQlpZiAobmNvZGUgIT0gImRlZmF1bHQiKSB7CgkJCQkJX2Mubm9kZSA9IHsKCQkJCQkJY29kZTogbmNvZGUsCgkJCQkJCWFjdGl2ZTogdHJ1ZSwKCQkJCQkJZW5hYmxlZDogZmFsc2UsIC8vIG90aGVyd2lzZSBpdCBzdGFydHMgZ2V0dGluZyBldmVudHMKCQkJCQkJdHlwZTogewoJCQkJCQkJbmFtZTogIk5vZGVKUyIsCgkJCQkJCX0KCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuIF9jOwoJCQl9KS5mbGF0KCkpLmZsYXQoKSksIHQpOwoJCQlEb3RPYmplY3QucGljayhzQ29uZmlnLCB0KS5mb3JFYWNoKGMgPT4gYy52YWx1ZSA9IEpTT04uc3RyaW5naWZ5KGMudmFsdWUpKTsKCQl9KSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19sb2FkVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMCwgYFske3NvdXJjZX1dOiBUb29scyBhcmUgJHt0b29scy5sZW5ndGh9YCk7CgoJCXNhbGVzbm93LlRvb2xzID0gdG9vbHM7CgoJCWlmIChzYWxlc25vdy5fbm9kZSAmJiBiU3RvcmUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2xvYWRUb29scycsICdFbnRpdHlPYmplY3QnLCAwLCAiU2F2aW5nIFRvb2xzIiwgc2FsZXNub3cuX25vZGUuY29kZSgpLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpOwoJCQlmb3IgYXdhaXQgKGNvbnN0IHQgb2YgdG9vbHMpIHsKCQkJCXQudG9vbF9NYXBwaW5ncy5mb3JFYWNoKG0gPT4gZGVsZXRlIG0udG9vbCk7CgkJCQl0LnR5cGUudHlwZV9NYXBwaW5ncy5mb3JFYWNoKG0gPT4gZGVsZXRlIG0udHlwZSk7CgoJCQkJYXdhaXQgbmV3IHNhbGVzbm93LlRvb2woKS5fZnJvbURvY3VtZW50KHQpLnN0b3JlKCk7CgkJCX0KCQl9CgoJCXNhbGVzbm93LlRvb2xzLmZpbHRlcih0ID0+ICF0LmF4aW9zKS5mb3JFYWNoKHQgPT4gewoJCQl0LmF4aW9zID0gYXhpb3MuY3JlYXRlKCk7CgkJCXQuYXhpb3MuaW50ZXJjZXB0b3JzLnJlcXVlc3QudXNlKGFzeW5jIGNvbmZpZyA9PiB7CgkJCQl0cnkgewoJCQkJCWNvbmZpZy5tZXRhID0gY29uZmlnLm1ldGEgfHwge307CgkJCQkJY29uZmlnLm1ldGEuY291bnRlciA9IDQ7CgoJCQkJCWxldCB0b2tlblVyaSA9IHRoaXMuX19jb25maWcoIm9hdXRoLnRva2VuLnVyaSIsIG51bGwsIHsKCQkJCQkJdG9vbDogdAoJCQkJCX0pOwoJCQkJCWxldCByZWZyZXNoVXJpID0gdGhpcy5fX2NvbmZpZygib2F1dGgucmVmcmVzaC51cmkiLCBudWxsLCB7CgkJCQkJCXRvb2w6IHQKCQkJCQl9KTsKCQkJCQlsZXQgYXV0aFVyaSA9IHRoaXMuX19jb25maWcoIm9hdXRoLmF1dGhvcml6ZS51cmkiLCBudWxsLCB7CgkJCQkJCXRvb2w6IHQKCQkJCQl9KTsKCQkJCQlsZXQgdG9rZW4gPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdG9rZW4iLCBudWxsLCB7CgkJCQkJCXRvb2w6IHQsCgkJCQkJCW5vZGU6IHNhbGVzbm93Ll9ub2RlCgkJCQkJfSk7CgkJCQkJaWYgKCFjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uICYmIFt0b2tlblVyaSwgcmVmcmVzaFVyaSwgYXV0aFVyaV0uaW5kZXhPZihjb25maWcudXJsKSA8IDApIHsKCQkJCQkJaWYgKCF0b2tlbiAmJiBzYWxlc25vdy5fbm9kZSkgewoJCQkJCQkJbGV0IGF1dGhDb2RlID0gdGhpcy5fX2NvbmZpZygnb2F1dGguYXV0aG9yaXplLmNvZGUnLCBudWxsLCB7CgkJCQkJCQkJdG9vbDogdAoJCQkJCQkJfSk7CgkJCQkJCQlsZXQgYXV0aE1ldGhvZCA9IHRoaXMuX19jb25maWcoJ29hdXRoLmF1dGhvcml6ZS5tZXRob2QnLCBudWxsLCB7CgkJCQkJCQkJdG9vbDogdAoJCQkJCQkJfSk7CgoJCQkJCQkJaWYgKCFhdXRoQ29kZSAmJiBhdXRoTWV0aG9kID09ICJnZXQiKSB7CgkJCQkJCQkJLy8gY3JlYXRlIG9yIGxvYWQgYSBuZXcgb2F1dGggc3RhdGUKCQkJCQkJCQl0aGlzLl9fY29uZmlnKCJvYXV0aC5hdXRob3JpemUuc3RhdGUiLCBudWxsLCB7CgkJCQkJCQkJCXRvb2w6IHQsCgkJCQkJCQkJCW5vZGU6IHNhbGVzbm93Ll9ub2RlLAoJCQkJCQkJCQluZXdWYWx1ZTogdGhpcy5fYnRvYShKU09OLnN0cmluZ2lmeSh7CgkJCQkJCQkJCQl0b29sOiB0Lm5hbWUsCgkJCQkJCQkJCQluY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQkJCQkJCX0pKQoJCQkJCQkJCX0pOwoJCQkJCQkJCS8vIGF1dGhvcml6ZSBhbmQgZ2V0IHRoZSBhdXRoIGNvZGUKCQkJCQkJCQlhdXRoVXJpID0gdGhpcy5fX2NvbmZpZygib2F1dGguYXV0aG9yaXplLnVyaSIsIG51bGwsIHsKCQkJCQkJCQkJdG9vbDogdAoJCQkJCQkJCX0pOwoJCQkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19sb2FkVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMCwgImF1dGhVcmkiLCBhdXRoVXJpKTsKCQkJCQkJCQl3aW5kb3cub3BlbihhdXRoVXJpKTsKCQkJCQkJCQlhd2FpdCB0aGlzLnNldEludGVydmFsKHRvb2wgPT4gc2FsZXNub3cuX25vZGUgJiYgY29uZmlnLm1ldGEuY291bnRlci0tICYmICEoYXV0aENvZGUgPSB0aGlzLl9fY29uZmlnKCdvYXV0aC5hdXRob3JpemUuY29kZScsIG51bGwsIHsKCQkJCQkJCQkJdG9vbDogdAoJCQkJCQkJCX0pKSwgMC4xLCB0KTsKCQkJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbG9hZFRvb2xzJywgJ0VudGl0eU9iamVjdCcsIDAsICJEb25lIExvb3BpbmciLCBhdXRoQ29kZSk7CgkJCQkJCQkJaWYgKCFhdXRoQ29kZSkgYXV0aE1ldGhvZCA9IHVuZGVmaW5lZDsKCQkJCQkJCX0KCgkJCQkJCQlpZiAoYXV0aE1ldGhvZCkgewoJCQkJCQkJCWxldCBmbG93ID0gKCFhdXRoQ29kZSAmJiBhdXRoTWV0aG9kID09ICdwb3N0JykgPyAnYXV0aG9yaXplJyA6ICd0b2tlbic7CgkJCQkJCQkJLy8gZ2V0IHRoZSB0b2tlbgoJCQkJCQkJCS8vIHRoZSB0b2tlblVyaWwgbWlnaHQgaGF2ZSBhIGRlcGVuZGVuY3kgb24gdGhlIGF1dGhvcml6YXRpb24gY29kZQoJCQkJCQkJCXRva2VuVXJpID0gdGhpcy5fX2NvbmZpZyhgb2F1dGguJHtmbG93fS51cmlgLCBudWxsLCB7CgkJCQkJCQkJCXRvb2w6IHQKCQkJCQkJCQl9KTsKCQkJCQkJCQlsZXQgdGNvbmZpZyA9IHsKCQkJCQkJCQkJdXJsOiB0b2tlblVyaSwKCQkJCQkJCQkJbWV0aG9kOiB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke2Zsb3d9Lm1ldGhvZGAsICdwb3N0JywgewoJCQkJCQkJCQkJdG9vbDogdAoJCQkJCQkJCQl9KSwKCQkJCQkJCQkJaGVhZGVyczogT2JqZWN0LmFzc2lnbih7CgkJCQkJCQkJCQkiQ29udGVudC1UeXBlIjogdGhpcy5fX2NvbmZpZyhgb2F1dGguJHtmbG93fS5jb250ZW50X3R5cGVgLCAidGV4dC9qc29uIiwgewoJCQkJCQkJCQkJCXRvb2w6IHQKCQkJCQkJCQkJCX0pLAoJCQkJCQkJCQkJIkF1dGhvcml6YXRpb24iOiAiQmFzaWMgIiArIHRoaXMuX2J0b2EodGhpcy5fX2NvbmZpZygib2F1dGgubG9naW4iLCBudWxsLCB7CgkJCQkJCQkJCQkJdG9vbDogdAoJCQkJCQkJCQkJfSkgKyAiOiIgKyB0aGlzLl9fY29uZmlnKCJvYXV0aC5wYXNzd29yZCIsIG51bGwsIHsKCQkJCQkJCQkJCQl0b29sOiB0CgkJCQkJCQkJCQl9KSksCgkJCQkJCQkJCX0sIHRoaXMuX19jb25maWcoYG9hdXRoLiR7Zmxvd30uaGVhZGVyc2AsICJ7fSIsIHsKCQkJCQkJCQkJCXRvb2w6IHQKCQkJCQkJCQkJfSkpLAoJCQkJCQkJCQlkYXRhOiB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke2Zsb3d9LmJvZHlgLCBudWxsLCB7CgkJCQkJCQkJCQl0b29sOiB0CgkJCQkJCQkJCX0pLAoJCQkJCQkJCX07CgkJCQkJCQkJbGV0IHRyZXMgPSBhd2FpdCB0LmF4aW9zKHRjb25maWcpOwoJCQkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19sb2FkVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMCwgIlRva2VuIGZldGNoZWQiLCBmbG93LCB0Y29uZmlnLCB0cmVzLmRhdGEpOwoJCQkJCQkJCVsnYWNjZXNzX3Rva2VuJywgJ3Rva2VuX3R5cGUnLCAnZXhwaXJlc19pbicsICdyZWZyZXNoX3Rva2VuJ10uZm9yRWFjaCh0YSA9PiB0aGlzLl9fY29uZmlnKGBvYXV0aC4ke3RhfWAsIG51bGwsIHsKCQkJCQkJCQkJdG9vbDogdCwKCQkJCQkJCQkJbm9kZTogc2FsZXNub3cuX25vZGUsCgkJCQkJCQkJCW5ld1ZhbHVlOiB0cmVzLmRhdGFbdGhpcy5fX2NvbmZpZyhgb2F1dGgudG9rZW4ucmVzcG9uc2UuJHt0YX1gLCB0YSwgewoJCQkJCQkJCQkJdG9vbDogdAoJCQkJCQkJCQl9KV0KCQkJCQkJCQl9KSk7CgkJCQkJCQkJdG9rZW4gPSB0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdG9rZW4iLCBudWxsLCB7CgkJCQkJCQkJCXRvb2w6IHQsCgkJCQkJCQkJCW5vZGU6IHNhbGVzbm93Ll9ub2RlCgkJCQkJCQkJfSk7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJaWYgKHRva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gdGhpcy5fX2NvbmZpZygib2F1dGgudG9rZW5fdHlwZSIsICJCZWFyZXIiLCB7CgkJCQkJCQl0b29sOiB0CgkJCQkJCX0pICsgIiAiICsgdG9rZW47CgkJCQkJfQoJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbG9hZFRvb2xzJywgJ0VudGl0eU9iamVjdCcsIDIsICJheGlvcy5yZXF1ZXN0IiwgZXgpOwoJCQkJfQoJCQkJcmV0dXJuIGNvbmZpZzsKCQkJfSwgYXN5bmMgZXJyb3IgPT4ge30pOwoJCQl0LmF4aW9zLmludGVyY2VwdG9ycy5yZXNwb25zZS51c2UocmVzcG9uc2UgPT4gewoJCQkJcmV0dXJuIHJlc3BvbnNlOwoJCQl9LCBhc3luYyBlcnJvciA9PiB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbG9hZFRvb2xzJywgJ0VudGl0eU9iamVjdCcsIDAsICJheGlvcyByZXNwb25zZSBlcnJvciIsIGVycm9yKTsKCQkJCXRyeSB7CgkJCQkJY29uc3Qgb3JpZ2luYWxSZXF1ZXN0ID0gZXJyb3IuY29uZmlnOwoJCQkJCWlmICh0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdG9rZW4iLCBudWxsLCB7CgkJCQkJCQl0b29sOiB0CgkJCQkJCX0pICYmIGVycm9yLnJlc3BvbnNlICYmIGVycm9yLnJlc3BvbnNlLnN0YXR1cyA9PT0gNDAxICYmICFvcmlnaW5hbFJlcXVlc3QuX3JldHJ5ICYmIG9yaWdpbmFsUmVxdWVzdC5oZWFkZXJzLkF1dGhvcml6YXRpb24uaW5kZXhPZih0aGlzLl9fY29uZmlnKCJvYXV0aC5hY2Nlc3NfdG9rZW4iLCBudWxsLCB7CgkJCQkJCQl0b29sOiB0CgkJCQkJCX0pKSA+IDApIHsKCQkJCQkJb3JpZ2luYWxSZXF1ZXN0Ll9yZXRyeSA9IHRydWU7CgkJCQkJCS8vIGF3YWl0IChnZXQgdGhlIHRva2VuIG9yIHJlZnJlc2ggaXQpCgoJCQkJCQlvcmlnaW5hbFJlcXVlc3QuaGVhZGVycy5BdXRob3JpemF0aW9uID0gdGhpcy5fX2NvbmZpZygib2F1dGguYWNjZXNzX3R5cGUiLCAiQmVhcmVyIiwgewoJCQkJCQkJdG9vbDogdAoJCQkJCQl9KSArICIgIiArIHRoaXMuX19jb25maWcoIm9hdXRoLmFjY2Vzc190b2tlbiIsIG51bGwsIHsKCQkJCQkJCXRvb2w6IHQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiB0LmF4aW9zKG9yaWdpbmFsUmVxdWVzdCk7CgkJCQkJfQoJCQkJCXJldHVybiBQcm9taXNlLnJlamVjdChlcnJvcik7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19sb2FkVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMiwgIlJlc3AgSW50ZXJjZXB0b3IiLCBleCwgZXJyb3IpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCgkJcmV0dXJuIHRvb2xzOwoKCX0KCglfcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCA9ICd7eycsIHBvc3RmaXggPSAnfX0nKSB7CgoJCXRyeSB7CgkJCWlmICh0eXBlb2Yoc3RyKSAhPT0gJ3N0cmluZycpIHJldHVybiBzdHI7CgkJCWxldCByZXggPSBgJHtwcmVmaXh9KFteJHtwb3N0Zml4fV0rKSR7cG9zdGZpeH1gOwoJCQkoc3RyLm1hdGNoKG5ldyBSZWdFeHAocmV4LCAiZyIpKSB8fCBbXSkuZm9yRWFjaChtID0+IHN0ciA9IHN0ci5yZXBsYWNlKG0sIG0gPT4gZnVuKG0ucmVwbGFjZShwcmVmaXgsICcnKS5yZXBsYWNlKHBvc3RmaXgsICcnKSkpKTsKCgkJCXJldHVybiBzdHI7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3BhcmFtZXRyaXplJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCWlmICh0aGlzLl9kZXBhcnRtZW50X3NldCAmJiB0aGlzLmRlcGFydG1lbnQoKSkgdGhpcy5kZXBhcnRtZW50KCkuX19zeW5jX29uKGQpOwoKCQkJLy8gdGhpcy5tYW5hZ2VyX1VzZXJzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCS8vIHRoaXMuY2FsbGVyX1VzZXJzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCS8vIHRoaXMuY29udGFjdF9Vc2VycygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQkvLyB0aGlzLnVzZXJfVXNlcnMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKHRoaXMuSWQpCgoJCQkudXNlcm5hbWUodGhpcy51c2VybmFtZSgpLCB0aGlzLl91c2VybmFtZV9jb29wKQoKCQkJLnBhc3N3b3JkKHRoaXMucGFzc3dvcmQoKSwgdGhpcy5fcGFzc3dvcmRfY29vcCkKCgkJCS5kZXBhcnRtZW50KHRoaXMuZGVwYXJ0bWVudCgpLCB0aGlzLl9kZXBhcnRtZW50X2Nvb3ApCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5jb2RlKHRoaXMuY29kZSgpLCB0aGlzLl9jb2RlX2Nvb3ApCgoJCQkub3JkZXIodGhpcy5vcmRlcigpLCB0aGlzLl9vcmRlcl9jb29wKQoKCQkJLmRhdGUodGhpcy5kYXRlKCksIHRoaXMuX2RhdGVfY29vcCkKCgkJCS5uYW1lKHRoaXMubmFtZSgpLCB0aGlzLl9uYW1lX2Nvb3ApCgoJCQkucmVtYXJrKHRoaXMucmVtYXJrKCksIHRoaXMuX3JlbWFya19jb29wKQoKCQkJLm1hbmFnZXJfRGVwYXJ0bWVudHModGhpcy5tYW5hZ2VyX0RlcGFydG1lbnRzKCksIHRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfY29vcCkKCgkJCS5jYWxsZXJfSW5jaWRlbnRzKHRoaXMuY2FsbGVyX0luY2lkZW50cygpLCB0aGlzLl9jYWxsZXJfSW5jaWRlbnRzX2Nvb3ApCgoJCQkuY29udGFjdF9JbmNpZGVudHModGhpcy5jb250YWN0X0luY2lkZW50cygpLCB0aGlzLl9jb250YWN0X0luY2lkZW50c19jb29wKQoKCQkJLnVzZXJfR3JvdXBfTWVtYmVycyh0aGlzLnVzZXJfR3JvdXBfTWVtYmVycygpLCB0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQkvL29iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkvL29ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdVc2VyJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgkJY29kZVR5cGUgPSBjb2RlVHlwZSB8fCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUprWlhCaGNuUnRaVzUwSWpvaVJHVndZWEowYldWdWRDSjlgKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KVtjb2RlXTsKCgkJdHJ5IHsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqRnJvbSkpIHJldHVybiBvYmpGcm9tLm1hcChvID0+IHRoaXMuX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgbywgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpKTsKCgkJCWxldCBzRmllbGQgPSBiUmV2ZXJzZSA/ICd0YXJnZXQnIDogJ3NvdXJjZSc7CgkJCWxldCBzU2NyaXB0ID0gKGJSZXZlcnNlID8gJ291dCcgOiAnaW4nKSArICdTY3JpcHQnOwoJCQlsZXQgc0NvbmQgPSAoYlJldmVyc2UgPyAnb3V0JyA6ICdpbicpICsgJ0NvbmRpdGlvbic7CgkJCWxldCB0RmllbGQgPSBiUmV2ZXJzZSA/ICdzb3VyY2UnIDogJ3RhcmdldCc7CgkJCWxldCB0U2NyaXB0ID0gKGJSZXZlcnNlID8gJ2luJyA6ICdvdXQnKSArICdTY3JpcHQnOwoJCQlsZXQgdENvbmQgPSAoYlJldmVyc2UgPyAnaW4nIDogJ291dCcpICsgJ0NvbmRpdGlvbic7CgoJCQlsZXQgX21hdGNoID0gKHMsIHIpID0+IHsKCQkJCWxldCBhbnN3ZXIgPSBzLm1hdGNoKG5ldyBSZWdFeHAociwgJ2cnKSk7CgkJCQlyZXR1cm4gcyA9PSByIHx8ICgoYW5zd2VyICYmIGFuc3dlci5sZW5ndGgpID8gdHJ1ZSA6IGZhbHNlKTsKCQkJfQoKCQkJbGV0IHRlc3QgPSBtID0+ICh7CgkJCQl2YWxpZDogbS5hY3RpdmUgJiYgbS5lbmFibGVkLAoJCQkJY29udGV4dDogX21hdGNoKGNvbnRleHQsIG0uY29udGV4dCksCgkJCQljbGFzczogX21hdGNoKGNsYXNzTmFtZSwgbS5jbGFzc05hbWUpLAoJCQkJc0ZpZWxkOiB0eXBlb2YoY29kZSkgPT09ICd1bmRlZmluZWQnIHx8IF9tYXRjaChjb2RlLCBtW3NGaWVsZF0pLAoJCQkJc1NjcmlwdDogdHlwZW9mKGNvZGUpID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YobVtzU2NyaXB0XSkgIT09ICd1bmRlZmluZWQnLAoJCQkJdGFyZ2V0OiAobVt0RmllbGRdIHx8IG1bdFNjcmlwdF0pICE9IG51bGwsCgkJCQl0ZXh0OiBjb2RlICsgJywnICsgc0ZpZWxkICsgJywnICsgdEZpZWxkLAoJCQl9KTsKCgkJCWxldCBtcyA9ICh0b29sLnRvb2xfTWFwcGluZ3MgfHwgW10pLmNvbmNhdCh0b29sLnR5cGUudHlwZV9NYXBwaW5ncyB8fCBbXSk7CgoJCQltcyA9IG1zLmZpbHRlcihtID0+IHRlc3QobSkudmFsaWQgJiYgdGVzdChtKS5jb250ZXh0ICYmIHRlc3QobSkuY2xhc3MgJiYgKHRlc3QobSkuc0ZpZWxkIHx8IHRlc3QobSkuc1NjcmlwdCkgJiYgdGVzdChtKS50YXJnZXQpLnNvcnQobSA9PiAtbS5vcmRlcik7CgkJCWlmIChtcy5sZW5ndGgpIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXAnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7Y2xhc3NOYW1lfS4ke2NvZGV9YCwgdGhpcy5fYmVhdXRpZnkobXMubWFwKG0gPT4gKHsKCQkJCW0sCgkJCQl0ZXN0OiB0ZXN0KG0pCgkJCX0pKSwgJ2phdmFzY3JpcHQnKSk7CgoJCQltcy5maWx0ZXIobSA9PiBtW3NGaWVsZF0gJiYgbVt0RmllbGRdKS5mb3JFYWNoKG0gPT4gewoJCQkJaWYgKG0uY29udGV4dCA9PSAnRW50aXR5Q2xhc3MnKSB7fSBlbHNlIGlmICh0eXBlb2YobVt0RmllbGRdKSA9PT0gJ2Z1bmN0aW9uJykgewoJCQkJCS8vIHJlcGxhY2UKCQkJCQlpZiAodHlwZW9mKGNvZGUpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQljb2RlID0gY29kZS5yZXBsYWNlKG5ldyBSZWdFeHAobVtzRmllbGRdLCAnZycpLCBtW3RGaWVsZF0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCS8vRG90T2JqZWN0LmNvcHkobVtzRmllbGRdLCBtW3RGaWVsZF0sIG9iakZyb20sIG9ialRvKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCWlmICh0eXBlb2YoY29kZSkgIT09ICd1bmRlZmluZWQnKSB7CgkJCQkJCWNvZGUgPSBtW3RGaWVsZF07CgkJCQkJfSBlbHNlIHsKCQkJCQkJRG90T2JqZWN0LmNvcHkobVtzRmllbGRdLCBtW3RGaWVsZF0sIG9iakZyb20sIG9ialRvKTsKCQkJCQl9CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWFwJywgJ0VudGl0eU9iamVjdCcsIDAsIGBbJHtjb250ZXh0fV0vJHtjbGFzc05hbWV9LiR7Y29kZX06ICR7bVtzRmllbGRdfSA9PiAke21bdEZpZWxkXX1gKTsKCQkJfSk7CgkJCW1zLmZvckVhY2gobSA9PiB7CgoJCQkJaWYgKG1bdFNjcmlwdF0pIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWFwJywgJ0VudGl0eU9iamVjdCcsIDAsIGBbJHttLmNvbnRleHR9XS8ke20uY2xhc3NOYW1lfS4ke2NvZGV9KCR7dFNjcmlwdH0pOiAke21bdFNjcmlwdF19YCwgbSk7CgkJCQkJdGhpcy5fU2NyaXB0KGBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgc2NvcGUsIG1ldGhvZCwgbSwgb2JqRnJvbSwgb2JqVG8sIGNvZGUsIF90aGlzLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKSA9PiB7aWYoCigob1Njb3BlKSA9PiB7CiAgICBsZXQgcmV0ID0gJHttW3RDb25kXX07CiAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewogICAgICAgIHJldCA9IHJldChvU2NvcGUpOwogICAgfQogICAgcmV0dXJuIHJldDsKfSkoc2FsZXNub3cpCil7JHttW3RTY3JpcHRdfX19YCwgdFNjcmlwdCwgJ01hcHBpbmcnLCBzYWxlc25vdywgbSwgb2JqRnJvbSwgb2JqVG8sIGNvZGUsIHRoaXMsIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpOwoJCQkJfQoKCQkJfSk7CgoJCQlpZiAodHlwZW9mKGNvZGUpID09PSAndW5kZWZpbmVkJykgewoJCQkJcmV0dXJuIG9ialRvOwoJCQl9CgoJCQlyZXR1cm4gY29kZTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWFwJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJVc2VyIjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucyA9IHt9KSB7CgoJCXRyeSB7CgkJCW9wdGlvbnMudG9vbCA9IG9wdGlvbnMudG9vbCA/ICgoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gb3B0aW9ucy50b29sIHx8IHQgPT0gb3B0aW9ucy50b29sKSB8fCB7fSkgOiB0aGlzLlRvb2w7CgkJCW9wdGlvbnMuX2NsYXNzID0gb3B0aW9ucy5fY2xhc3MgfHwgJ1VzZXInOwoKCQkJbGV0IG5JRCA9IHNhbGVzbm93Ll9ub2RlID8gc2FsZXNub3cuX25vZGUuY29kZSgpIDogImRlZmF1bHQiOwoKCQkJbGV0IHJldCA9IG51bGxWYWx1ZTsKCQkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0ID0gbnVsbDsKCgkJCS8vIHRvb2xfQ29uZmlncywgdHlwZV9Db25maWdzOiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIGRvbmUKCQkJaWYgKG9wdGlvbnMudG9vbC50eXBlLnR5cGVfQ29uZmlncyB8fCBvcHRpb25zLnRvb2wudG9vbF9Db25maWdzKSB7CgkJCQlsZXQgY2ZzID0gW10uY29uY2F0KG9wdGlvbnMudG9vbC50eXBlLnR5cGVfQ29uZmlncywgb3B0aW9ucy50b29sLnRvb2xfQ29uZmlncyk7CgkJCQlsZXQgdGNvbmYgPSBjZnMuZmlsdGVyKGMgPT4gYy5uYW1lID09IG4gJiYgYy5ub2RlICYmIGMubm9kZS5jb2RlID09IG5JRCkuY29uY2F0KGNmcy5maWx0ZXIoYyA9PiBjLm5hbWUgPT0gbiAmJiAhYy5ub2RlKSk7CgkJCQlpZiAodGNvbmYubGVuZ3RoKSB7CgkJCQkJaWYgKHRjb25mWzBdLnNjcmlwdCkgewoJCQkJCQlyZXQgPSB0aGlzLnJ1blNjcmlwdChgKCR7T2JqZWN0LmtleXMob3B0aW9ucykuam9pbignLCAnKX0pID0+ICR7dGNvbmZbMF0uc2NyaXB0fWApKC4uLk9iamVjdC52YWx1ZXMob3B0aW9ucykpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJldCA9IHRjb25mWzBdLnZhbHVlOwoJCQkJCQl0cnkgewoJCQkJCQkJWzEsIDIsIDNdLmZvckVhY2goYSA9PiByZXQgPSBKU09OLnBhcnNlKHJldCkpOwoJCQkJCQl9IGNhdGNoIChqZXgpIHt9CgkJCQkJfQoJCQkJfQoJCQkJaWYgKG9wdGlvbnMubmV3VmFsdWUpIHsKCQkJCQlsZXQgdGMgPSB0Y29uZi5sZW5ndGggPyB0Y29uZlswXSA6IHt9OwoJCQkJCWlmIChvcHRpb25zLm5vZGUpIHRjLm5vZGUgPSB7CgkJCQkJCWNvZGU6IG9wdGlvbnMubm9kZS5jb2RlKCkKCQkJCQl9OwoJCQkJCXRjLnZhbHVlID0gb3B0aW9ucy5uZXdWYWx1ZTsKCQkJCQl0Yy5uYW1lID0gbjsKCQkJCQlpZiAoIXRjb25mLmxlbmd0aCkgewoJCQkJCQlvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLnB1c2godGMpOwoJCQkJCX0KCQkJCQlyZXQgPSBvcHRpb25zLm5ld1ZhbHVlOwoJCQkJfQoJCQl9CgoJCQkvLyBtb2RlbCBDb25maWc6IENvbmZpZyBpcyBjbGFzcyBsZXZlbCwgbm9kZSBub3QgcG9zc2libGUgLSBwZW5kaW5nCgkJCWxldCBtY29uZiA9IG5ldyBzYWxlc25vd1tvcHRpb25zLl9jbGFzc10oKS5Db25maWdbbl07CgkJCWlmICh0eXBlb2YobWNvbmYpICE9PSAidW5kZWZpbmVkIikgcmV0ID0gbWNvbmY7CgoJCQkvLyBjb21tYW5kIGxpbmU6IGFsbG93IGNsYXNzLWxldmVsIGFuZCBub2RlLWxldmVsIC0gcGVuZGluZwoJCQlpZiAodHlwZW9mKGdsb2JhbCkgIT09ICd1bmRlZmluZWQnICYmIGdsb2JhbC5taW5pbWlzdCkgewoJCQkJcmV0ID0gZ2xvYmFsLm1pbmltaXN0KHByb2Nlc3MuYXJndi5zbGljZSgyKSlbbl0gfHwgcmV0OwoJCQl9CgoJCQkvLyByZXF1ZXN0OiBhbGxvdyBjbGFzcy1sZXZlbCBhbmQgbm9kZS1sZXZlbCAtIHBlbmRpbmcKCQkJcmV0ID0gdGhpcy4kX1JFUVVFU1QobikgfHwgcmV0OwoKCQkJLy8gY29uZmlnIHJlcGxhY2VtZW50CgkJCXJldCA9IHRoaXMuX3BhcmFtZXRyaXplKHJldCwgcCA9PiB0aGlzLl9fY29uZmlnKHAsIG51bGwsIG9wdGlvbnMpKTsKCgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19jb25maWcnLCAnRW50aXR5T2JqZWN0JywgMSwgbiwgbnVsbFZhbHVlLCBvcHRpb25zLnRvb2wudG9vbF9Db25maWdzLCBleCk7CgkJfQoKCX0KCgkvKioKCSAqIFN1bW1hcnkuIGluaXQuCgkgKgoJICogRGVzY3JpcHRpb24uIC4KCSAqCgkgKiBAc2luY2UgICAgICB4LngueAoJICogQGRlcHJlY2F0ZWQgeC54LnggVXNlIG5ld19mdW5jdGlvbl9uYW1lKCkgaW5zdGVhZC4KCSAqIEBhY2Nlc3MgICAgIHB1YmxpYwoJICoKCSAqIEBjbGFzcwoJICogQGF1Z21lbnRzIHBhcmVudAoJICogQG1peGVzICAgIG1peGluCgkgKgoJICogQGFsaWFzICAgIHJlYWxOYW1lCgkgKiBAbWVtYmVyb2YgbmFtZXNwYWNlCgkgKgoJICogQHNlZSAgRnVuY3Rpb24vY2xhc3MgcmVsaWVkIG9uCgkgKiBAbGluayBVUkwKCSAqIEBnbG9iYWwKCSAqCgkgKiBAZmlyZXMgICBldmVudE5hbWUKCSAqIEBmaXJlcyAgIGNsYXNzTmFtZSNldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGV2ZW50OmV2ZW50TmFtZQoJICogQGxpc3RlbnMgY2xhc3NOYW1lfmV2ZW50OmV2ZW50TmFtZQoJICogQHBhcmFtIHt0eXBlfSAgIHZhciAgICAgICAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcl0gICAgICAgICBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyPWRlZmF1bHRdIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlIHdpdGggZGVmYXVsdCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3RWYXIgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIG9iamVjdFZhci5rZXkgRGVzY3JpcHRpb24gb2YgYSBrZXkgaW4gdGhlIG9iamVjdFZhciBwYXJhbWV0ZXIuCgkgKgoJICogQHlpZWxkIHt0eXBlfSBZaWVsZGVkIHZhbHVlIGRlc2NyaXB0aW9uLgoJICoKCSAqIEByZXR1cm4ge3R5cGV9IFJldHVybiB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqLwoJYXN5bmMgaW5pdCgpIHsKCgkJbGV0IGFuc3dlciA9IG51bGw7CgoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluaXQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5pdCIsIF9ub2RlLCApID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluaXQiLCApID0+IHsKCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Vc2VyLmluaXQnKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQkJIjAxIjogKCgpID0+IHsKCgkJCQkJbGV0IGFuc3dlciA9CgoJCQkJCQl0eXBlb2Yod2luZG93KSA9PT0gJ3VuZGVmaW5lZCcKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdpbml0JywgJ0VudGl0eU9iamVjdCcsIDAsICJhbnN3ZXIiLCAiMDEiLCBhbnN3ZXIpOwoJCQkJCXJldHVybiBhbnN3ZXI7CgkJCQl9KSgpID8gKCdOb3QgcnVubmluZyBpbiBhIGJyb3dzZXInIHx8ICdWYWxpZGF0aW9uIEVycm9yJykgOiAnJywKCgkJCX07CgkJCU9iamVjdC5rZXlzKGVycm9ycykuZmlsdGVyKGsgPT4gIWVycm9yc1trXSkuZm9yRWFjaChrID0+IGRlbGV0ZSBlcnJvcnNba10pOwoJCQlpZiAoT2JqZWN0LmtleXMoZXJyb3JzKS5sZW5ndGgpIHsKCQkJCU9iamVjdC5rZXlzKGVycm9ycykuZmlsdGVyKGsgPT4gay5zdGFydHNXaXRoKCctJykpLmZvckVhY2goayA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnaW5pdCcsICdFbnRpdHlPYmplY3QnLCAwLCB7CgkJCQkJCVtrXTogZXJyb3JzW2tdCgkJCQkJfSk7CgkJCQkJZGVsZXRlIGVycm9yc1trXTsKCQkJCX0pOwoJCQkJaWYgKE9iamVjdC52YWx1ZXMoZXJyb3JzKS5sZW5ndGgpIHsKCQkJCQlyZXR1cm4gewoJCQkJCQlfX2V4Y2VwdGlvbjogZXJyb3JzLAoJCQkJCX07CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJCWxldCBjb2RlID0gJzEyMyc7CgkJCWlmICh0aGlzLnNyKCkuYkxvY2FsKSB7CgkJCQlsZXQgbyA9IG5ldyBvU2NvcGUuSW5jaWRlbnQobnVsbCwgJ1NOT1dPT0InKS5fZnJvbURvY3VtZW50KHsKCQkJCQludW1iZXI6ICJJTkMwMDA5MDA5IiwKCQkJCQlzdGF0ZTogIjEiLAoJCQkJCXByaW9yaXR5OiAiNCIsCgkJCQkJZGVzY3JpcHRpb246ICJ3aGF0IgoJCQkJfSwgdHJ1ZSk7CgkJCQkvL2xvZyhvLl90b0RvY3VtZW50KCkpO2xvZyhvLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCQlvLlRvb2wgPSAiU2FsZXNGb3JjZSI7CgoJCQkJYXdhaXQgbmV3IG9TY29wZS5Vc2VyKGNvZGUsICdHaXRIdWInKS5uYW1lKCdUZW1wIFVzZXInKS5jb2RlKCd0bXAnKS5yZW1hcmsoby5fdG9TRlF1ZXJ5KG51bGwsIG51bGwsIHRydWUpKS5lbmFibGVkKHRydWUpLnN0b3JlKCk7CgkJCX0gZWxzZSB7CgkJCQlsZXQgbGFzdFEgPSBudWxsOwoJCQkJdGhpcy5zZXRJbnRlcnZhbChhc3luYyB1ID0+IHsKCQkJCQl1ID0gYXdhaXQgdS5maW5kKCk7CgkJCQkJaWYgKHUucmVtYXJrKCkgIT0gbGFzdFEpIHsKCQkJCQkJbGFzdFEgPSB1LnJlbWFyaygpOwoJCQkJCQlhd2FpdCBuZXcgb1Njb3BlLlVzZXIobnVsbCwgJ1NhbGVzRm9yY2UnKS5fcmVzdChudWxsLCBudWxsLCBsYXN0USwgbnVsbCwgewoJCQkJCQkJdXJsOiAncmVzdC51cmwuZ3FsJwoJCQkJCQl9KTsKCQkJCQl9CgkJCQkJaWYgKCF1LmVuYWJsZWQoKSkgbG9nKCJFeGl0aW5nIFF1ZXJ5IGxvb3AiKTsKCQkJCQlyZXR1cm4gdS5lbmFibGVkKCk7CgkJCQl9LCAwLjUsIG5ldyBvU2NvcGUuVXNlcihjb2RlLCAnR2l0SHViJykpOwoJCQl9CgoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10sCgkJfSk7CgoJCS8vIHRha2Ugb3V0IHRoZSBpbnZhbGlkIG5vZGUgcmVzdWx0cwoJCXJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIgJiYgci5yZXQpOwoKCQkvLyBoYXMgYW55IG5vZGUgZ2VuZXJhdGVkIGEgdmFsaWRhdGlvbiBleGNlcHRpb24/CgkJbGV0IF9fZXggPSByZXN1bHRzLmZpbmQociA9PiByLnJldC5fX2V4Y2VwdGlvbik7CgkJaWYgKF9fZXgpIHJldHVybiBfX2V4LnJldDsKCgkJcmV0dXJuIHJlc3VsdHMubGVuZ3RoID8gcmVzdWx0c1swXS5yZXQgOiBudWxsOwoKCX0KCgkvKioKCSAqIFN1bW1hcnkuIGF1dGhvcml6ZS4KCSAqCgkgKiBEZXNjcmlwdGlvbi4gLgoJICoKCSAqIEBzaW5jZSAgICAgIHgueC54CgkgKiBAZGVwcmVjYXRlZCB4LngueCBVc2UgbmV3X2Z1bmN0aW9uX25hbWUoKSBpbnN0ZWFkLgoJICogQGFjY2VzcyAgICAgcHVibGljCgkgKgoJICogQGNsYXNzCgkgKiBAYXVnbWVudHMgcGFyZW50CgkgKiBAbWl4ZXMgICAgbWl4aW4KCSAqCgkgKiBAYWxpYXMgICAgcmVhbE5hbWUKCSAqIEBtZW1iZXJvZiBuYW1lc3BhY2UKCSAqCgkgKiBAc2VlICBGdW5jdGlvbi9jbGFzcyByZWxpZWQgb24KCSAqIEBsaW5rIFVSTAoJICogQGdsb2JhbAoJICoKCSAqIEBmaXJlcyAgIGV2ZW50TmFtZQoJICogQGZpcmVzICAgY2xhc3NOYW1lI2V2ZW50TmFtZQoJICogQGxpc3RlbnMgZXZlbnQ6ZXZlbnROYW1lCgkgKiBAbGlzdGVucyBjbGFzc05hbWV+ZXZlbnQ6ZXZlbnROYW1lCgkgKiBAcGFyYW0ge3R5cGV9ICAgdmFyICAgICAgICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyXSAgICAgICAgIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXI9ZGVmYXVsdF0gRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUgd2l0aCBkZWZhdWx0IHZhcmlhYmxlLgoJICogQHBhcmFtIHtPYmplY3R9IG9iamVjdFZhciAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgb2JqZWN0VmFyLmtleSBEZXNjcmlwdGlvbiBvZiBhIGtleSBpbiB0aGUgb2JqZWN0VmFyIHBhcmFtZXRlci4KCSAqCgkgKiBAeWllbGQge3R5cGV9IFlpZWxkZWQgdmFsdWUgZGVzY3JpcHRpb24uCgkgKgoJICogQHJldHVybiB7dHlwZX0gUmV0dXJuIHZhbHVlIGRlc2NyaXB0aW9uLgoJICovCglhc3luYyBhdXRob3JpemUoKSB7CgoJCWxldCBhbnN3ZXIgPSBudWxsOwoKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJhdXRob3JpemUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiYXV0aG9yaXplIiwgX25vZGUsICkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiYXV0aG9yaXplIiwgKSA9PiB7CgoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuVXNlci5hdXRob3JpemUnKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQkJIjAxIjogKCgpID0+IHsKCgkJCQkJbGV0IGFuc3dlciA9CgoJCQkJCQkhdGhpcy5fdXNlcm5hbWVfc2V0CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnYXV0aG9yaXplJywgJ0VudGl0eU9iamVjdCcsIDAsICJhbnN3ZXIiLCAiMDEiLCBhbnN3ZXIpOwoJCQkJCXJldHVybiBhbnN3ZXI7CgkJCQl9KSgpID8gKCdVc2VybmFtZSBub3QgU2V0JyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQkJIjAyIjogKCgpID0+IHsKCgkJCQkJbGV0IGFuc3dlciA9CgoJCQkJCQkhdGhpcy5fcGFzc3dvcmRfc2V0CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnYXV0aG9yaXplJywgJ0VudGl0eU9iamVjdCcsIDAsICJhbnN3ZXIiLCAiMDIiLCBhbnN3ZXIpOwoJCQkJCXJldHVybiBhbnN3ZXI7CgkJCQl9KSgpID8gKCdQYXNzd29yZCBub3QgU2V0JyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2F1dGhvcml6ZScsICdFbnRpdHlPYmplY3QnLCAwLCB7CgkJCQkJCVtrXTogZXJyb3JzW2tdCgkJCQkJfSk7CgkJCQkJZGVsZXRlIGVycm9yc1trXTsKCQkJCX0pOwoJCQkJaWYgKE9iamVjdC52YWx1ZXMoZXJyb3JzKS5sZW5ndGgpIHsKCQkJCQlyZXR1cm4gewoJCQkJCQlfX2V4Y2VwdGlvbjogZXJyb3JzLAoJCQkJCX07CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJCXJldHVybiBhd2FpdCB0aGlzLl9hdXRob3JpemUobnVsbCwgbnVsbCwgdHJ1ZSkKCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXSwKCQl9KTsKCgkJLy8gdGFrZSBvdXQgdGhlIGludmFsaWQgbm9kZSByZXN1bHRzCgkJcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gciAmJiByLnJldCk7CgoJCS8vIGhhcyBhbnkgbm9kZSBnZW5lcmF0ZWQgYSB2YWxpZGF0aW9uIGV4Y2VwdGlvbj8KCQlsZXQgX19leCA9IHJlc3VsdHMuZmluZChyID0+IHIucmV0Ll9fZXhjZXB0aW9uKTsKCQlpZiAoX19leCkgcmV0dXJuIF9fZXgucmV0OwoKCQlyZXR1cm4gcmVzdWx0cy5sZW5ndGggPyByZXN1bHRzWzBdLnJldCA6IG51bGw7CgoJfQoKCWFzeW5jIF9yZXN0KHROYW1lID0gdGhpcy5fbkNvZGUoKSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMgPSB7fSkgewoKCQl0cnkgewoJCQlsZXQgSWQgPSB0aGlzLklkOwoJCQlsZXQgY29uZmlnID0gewoJCQkJdXJsOiB0aGlzLl9fY29uZmlnKG9wdGlvbnMudXJsIHx8ICdyZXN0YXBpLnVybCcsIG51bGwsIE9iamVjdC5hc3NpZ24ob3B0aW9ucywgewoJCQkJCXROYW1lLAoJCQkJCV90aGlzOiB0aGlzLl90b0RvY3VtZW50KHRydWUpCgkJCQl9KSksCgkJCQltZXRob2Q6IG1ldGhvZCA/IG1ldGhvZCA6IChkYXRhID8gInBvc3QiIDogImdldCIpLAoJCQkJcGFyYW1zOiBwYXJhbXMsCgkJCQlkYXRhOiBkYXRhLAoJCQl9OwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcmVzdCcsICdFbnRpdHlPYmplY3QnLCAwLCBjb25maWcpOwoJCQlsZXQgcmV0ID0gW107CgkJCWlmICh0aGlzLl9fY29uZmlnKCdsaXZlJywgdHJ1ZSkpIHJldCA9IChhd2FpdCB0aGlzLlRvb2wuYXhpb3MoY29uZmlnKSkuZGF0YS5yZXN1bHQ7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19yZXN0JywgJ0VudGl0eU9iamVjdCcsIDAsIEpTT04uc3RyaW5naWZ5KHJldCwgbnVsbCwgNCkpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19yZXN0JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncGFzc3dvcmQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICBgCgkJfTsKCQlyZXQuc3FsICs9ICcvKlVzZXIqLyk7XG4nOwoKCQlyZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiB0cnVlLAoJCQlOdWxsOiB0cnVlLAoJCQkvL0lkOiAob2JqLCB2KSA9PiBvYmouc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWWAsCgoJCQkidXNlcm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkicGFzc3dvcmQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncGFzc3dvcmQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncGFzc3dvcmQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZGVwYXJ0bWVudCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RlcGFydG1lbnQnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCW1hbmFnZXJfRGVwYXJ0bWVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdtYW5hZ2VyX1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJCWNhbGxlcl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYWxsZXJfVXNlcnMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQkJY29udGFjdF9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250YWN0X1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJCXVzZXJfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXJfVXNlcnMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypVc2VyKi8pO1xuJzsKCgkJcmV0LnNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQocmV0LnNxbCkgOiByZXQuc3FsOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TUUxUYWJsZScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQuc3FsKTsKCQlyZXR1cm4gcmV0LnNxbDsKCX0KCglfZnJvbVNRTFRhYmxlKHRhYmxlLCBmaWVsZHMpIHsKCQkvLyB0YWJsZSBpcyBhIGpzb24gYXJyYXkKCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInVzZXJuYW1lIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy51c2VybmFtZSh0YWJsZVsidXNlcm5hbWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicGFzc3dvcmQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnBhc3N3b3JkKHRhYmxlWyJwYXNzd29yZCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkZXBhcnRtZW50IikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5kZXBhcnRtZW50KHRhYmxlWyJkZXBhcnRtZW50Il0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuYWN0aXZlKHRhYmxlWyJhY3RpdmUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZW5hYmxlZCh0YWJsZVsiZW5hYmxlZCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5jb2RlKHRhYmxlWyJjb2RlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5vcmRlcih0YWJsZVsib3JkZXIiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZGF0ZSh0YWJsZVsiZGF0ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5uYW1lKHRhYmxlWyJuYW1lIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucmVtYXJrKHRhYmxlWyJyZW1hcmsiXSk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBfc3FsKHNxbCwgc291cmNlID0gdGhpcykgewoKCQlpZiAoIXRoaXMuVG9vbC5kYiB8fCAhc3FsIHx8ICFzcWwudHJpbSgpKSB7CgkJCWlmICghdGhpcy5Ub29sLmRiKSB0aGlzLmxvZyh1bmRlZmluZWQsICdfc3FsJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCwgIiA8PT1TS0lQUEVEPT0+Iik7CgkJCXJldHVybiBbXTsKCQl9CgoJCWlmIChzcWwuaW5kZXhPZignO1xuJykgPiAwKSB7CgkJCWZvciBhd2FpdCAoY29uc3Qgc3FsUyBvZiBzcWwuc3BsaXQoJztcbicpKSB7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsUy50cmltKCkpOwoJCQl9CgkJCXJldHVybjsKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQl0cnkgewoJCQlyZXQgPSBhd2FpdCBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7CgkJCQlsZXQgX3Jlc29sdmUgPSAoX3JldCwgX3NxbCkgPT4gewoJCQkJCWlmIChfc3FsICYmIF9zcWwuaW5kZXhPZignc2VsZWN0JykpIHRoaXMuVG9vbC5fX2RtbFN0YXRlbWVudHMucHVzaChfc3FsKTsKCQkJCQlyZXR1cm4gcmVzb2x2ZShfcmV0KTsKCQkJCX0KCgkJCQlsZXQgZGIgPSB0aGlzLlRvb2wuZGI7CgkJCQlsZXQgdHlwZSA9IHRoaXMuX19jb25maWcoJ3R5cGUnKTsKCgkJCQlsZXQgZnVuID0gIiI7CgoJCQkJLy8gUXVlcnkgbGlzdCBvZiBzdGF0ZW1lbnQgc3RhcnRpbmcga2V5d29yZHMgICAgICAgIAoJCQkJbGV0IHFMaXN0ID0gWyJzZWxlY3QiLCAiaW5zZXJ0IiwgInVwZGF0ZSIsICJkZWxldGUiXTsKCQkJCWlmICh0aGlzLl9fY29uZmlnKCdkYXRhYmFzZS50cmFuc2FjdGlvbnMnLCB0cnVlKSkgewoJCQkJCXFMaXN0ID0gcUxpc3QuY29uY2F0KFsiYmVnaW4iLCAic3RhcnQiLCAiY29tbWl0Il0pOwoJCQkJfQoJCQkJbGV0IGJRdWVyeSA9IHFMaXN0LmluZGV4T2Yoc3FsLnN1YnN0cmluZygwLCBzcWwuaW5kZXhPZignICcpKS50cmltKCkudG9Mb3dlckNhc2UoKSkgPj0gMDsKCgkJCQlpZiAoYlF1ZXJ5KSB7CgkJCQkJLy8gcXVlcnkKCQkJCQlpZiAodHlwZSA9PSAnbXlzcWwnKSBmdW4gPSAncXVlcnknOwoJCQkJCWlmICh0eXBlID09ICdzcWxpdGUnKSBmdW4gPSAnYWxsJzsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gRE1MCgkJCQkJaWYgKHR5cGUgPT0gJ215c3FsJykgZnVuID0gJ3F1ZXJ5JzsKCQkJCQlpZiAodHlwZSA9PSAnc3FsaXRlJykgZnVuID0gJ3J1bic7CgoJCQkJCXRoaXMuVG9vbC5kbWxDYWNoZSA9IHRoaXMuVG9vbC5kbWxDYWNoZSB8fCB7fTsKCQkJCQlpZiAodGhpcy5Ub29sLmRtbENhY2hlW3RoaXMuaGFzaENvZGUoc3FsKV0pIHJldHVybiBfcmVzb2x2ZSgwKTsKCQkJCQl0aGlzLlRvb2wuZG1sQ2FjaGVbdGhpcy5oYXNoQ29kZShzcWwpXSA9IHNxbDsKCQkJCX0KCQkJCWlmICh0eXBlID09ICdzcWxpdGUnICYmIHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJykgZnVuID0gIiI7CgkJCQlpZiAoZnVuICYmICFkYltmdW5dKSBmdW4gPSAiIjsKCgkJCQlzcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCkgOiBzcWw7CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3NxbCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHt0eXBlfS4ke2Z1bn1gLCBzcWwpOwoJCQkJaWYgKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24pIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uc3Fscy5wdXNoKHNxbCk7CgoJCQkJaWYgKGZ1bikgewoJCQkJCWxldCByZXQgPSBkYltmdW5dKHNxbCwgW10sIChlcnJvciwgcm93cykgPT4gewoJCQkJCQlpZiAoZXJyb3IpIHsKCQkJCQkJCXJlamVjdChlcnJvcik7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlfcmVzb2x2ZShyb3dzLCBzcWwpOwoJCQkJCQl9CgkJCQkJfSk7CgkJCQl9IGVsc2UgaWYgKHR5cGUgPT0gJ3Nub3dmbGFrZScpIHsKCQkJCQl0aGlzLlRvb2wuZGIuZXhlY3V0ZSh7CgkJCQkJCXNxbFRleHQ6IHNxbCwKCQkJCQkJY29tcGxldGU6IGZ1bmN0aW9uKGVyciwgc3RtdCwgcm93cykgewoJCQkJCQkJaWYgKGVycikgewoJCQkJCQkJCXJlamVjdChlcnIpOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlfcmVzb2x2ZShyb3dzLCBzcWwpOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfSk7CgkJCQl9IGVsc2UgaWYgKHR5cGUgPT0gJ3NxbGl0ZScpIHsKCQkJCQkvLyBzcWxpdGUgaW4gdGhlIGJyb3dzZXIKCQkJCQl0cnkgewoJCQkJCQlsZXQgcmV0ID0gbnVsbDsKCQkJCQkJcmV0ID0gZGIuZXhlYyhzcWwpOwoJCQkJCQlpZiAoIXJldCB8fCAhcmV0Lmxlbmd0aCkgcmV0dXJuIF9yZXNvbHZlKHJldCwgc3FsKTsKCgkJCQkJCXJldCA9IHJldFswXS52YWx1ZXMubWFwKHIgPT4gT2JqZWN0LmZyb21FbnRyaWVzKG5ldyBNYXAocmV0WzBdLmNvbHVtbnMubWFwKChjLCBpKSA9PiBbYywgcltpXV0pKSkpOwoJCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfc3FsJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJCQkJCV9yZXNvbHZlKHJldCwgc3FsKTsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQlyZWplY3QoZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3NxbCcsICdFbnRpdHlPYmplY3QnLCAyLCBgCkVSUk9SOgoke2V4fQoKV2hpbGUgU2VuZGluZyBRdWVyeSAKJHtzcWx9CmApOwoJCX0KCgkJLy90aGlzIGlzIG5vdCBlbm91Z2guIFdlIHNlbGVjdCBvdXRlciBqb2lucywgc28gc3ViLWF0dHJpYnV0ZXMgd2lsbCBiZSBhbHNvIG51bGwuIEVpdGhlciByZWN1cnNpdmUgb3IgdG8gaWdub3JlIHdoZW4gdXNlZCwgZm9yIGV4YW1wbGUgdGhyb3VnaCBfdG9Eb2N1bWVudAoJCWZhbHNlICYmIHJldC5mb3JFYWNoKHIgPT4gewoJCQlPYmplY3Qua2V5cyhyKS5mb3JFYWNoKGsgPT4gewoJCQkJaWYgKHJba10gPT0gbnVsbCkgZGVsZXRlIHJba107CgkJCX0pOwoJCX0pOwoKCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXQubWFwKHIgPT4gRG90T2JqZWN0Lm9iamVjdChyKSk7CgkJcmV0dXJuIHJldDsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXRyeSB7CgkJCWxldCBjb25maWcgPSB7CgkJCQltZXRob2Q6IGNvbnRlbnQgPyAncHV0JyA6ICdnZXQnLAoJCQkJdXJsOiB0aGlzLl9fY29uZmlnKCd1cmwnKSArIGZpbGUsCgkJCQloZWFkZXJzOiB7CgkJCQkJJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi92bmQuZ2l0aHViK2pzb24nLAoJCQkJCSdYLUdpdEh1Yi1BcGktVmVyc2lvbic6ICcyMDIyLTExLTI4JywKCQkJCX0sCgkJCX07CgkJCWlmIChjb250ZW50KSB7CgkJCQkvLyBmaXJzdCBnZXQgdGhlIHNoYSBvZiB0aGUgZmlsZQoJCQkJaWYgKHR5cGVvZihjb250ZW50KSA9PT0gJ29iamVjdCcpIGNvbnRlbnQgPSBKU09OLnN0cmluZ2lmeShjb250ZW50LCBudWxsLCAnXHQnKTsKCQkJCWNvbmZpZy5kYXRhID0gewoJCQkJCW1lc3NhZ2U6ICJkZXBsb3llZCBieSBfZ2l0aHViKCkiLAoJCQkJCWNvbnRlbnQ6IGAke3RoaXMuX2J0b2EoY29udGVudCl9YAoJCQkJfTsKCgkJCQlsZXQgZiA9IGF3YWl0IHRoaXMuX2dpdGh1YihmaWxlKTsKCQkJCWlmIChmKSBjb25maWcuZGF0YS5zaGEgPSBmLnNoYTsKCgkJCQljb25maWcuZGF0YSA9IEpTT04uc3RyaW5naWZ5KGNvbmZpZy5kYXRhKTsKCQkJfSBlbHNlIHsKCQkJCWNvbmZpZy52YWxpZGF0ZVN0YXR1cyA9IHN0YXR1cyA9PiBzdGF0dXMgPCA1MDA7CgkJCX0KCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMuVG9vbC5heGlvcyhjb25maWcpOwoJCQlyZXQgPSByZXQgPyByZXQuZGF0YSA6IG51bGw7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19naXRodWInLCAnRW50aXR5T2JqZWN0JywgMCwgZmlsZSwgY29uZmlnLm1ldGhvZCwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZ2l0aHViJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgoJfQoKCV90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCBiU3RyaW5nKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoewoJCQlbdGhpcy5fbkNvZGUoKV06IHsKCQkJCXBhcmFtczogewoJCQkJCXdoZXJlOiB7CgkJCQkJCWFuZDogW10sCgkJCQkJCW9yOiBbXQoJCQkJCX0KCQkJCX0sCgkJCQllZGdlczogewoJCQkJCW5vZGU6IHt9CgkJCQl9CgkJCX0KCQl9LCB7CgkJCS8vT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaCh7CgkJCQlJZDogewoJCQkJCWVxOiB2CgkJCQl9CgkJCX0pLAoKCQkJdXNlcm5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VybmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlwYXNzd29yZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWRlcGFydG1lbnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQl7CgkJCQkJCQlpbnE6IHsKCQkJCQkJCQlBcGlOYW1lOiAnSWQnLAoJCQkJCQkJCVt0aGlzLl9uQ29kZSgnRGVwYXJ0bWVudCcsIHVuZGVmaW5lZCldOiB2ID8gdi5fdG9TRlF1ZXJ5KClbdGhpcy5fbkNvZGUoJ0RlcGFydG1lbnQnLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQkodiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGwpCgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJfSwgIl90b1NGUXVlcnkiKTsKCgkJLy9PYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJaWYgKGJTdHJpbmcpIHsKCQkJcmV0ID0gewoJCQkJcXVlcnk6IHsKCQkJCQlbdGhpcy5fbkNvZGUoKSArICdRdWVyeSddOiB7CgkJCQkJCXVpYXBpOiByZXQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXJldCA9IEpTT04uc3RyaW5naWZ5KHJldCwgbnVsbCwgNCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TRlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9iai5zeXNfaWQgPSB2LAoKCQkJdXNlcm5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VybmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJcGFzc3dvcmQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwYXNzd29yZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZGVwYXJ0bWVudDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RlcGFydG1lbnQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9TTlF1ZXJ5KCkgOiBudWxsOwoKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlsZXQgZCA9IGAke3YuZ2V0RnVsbFllYXIoKX0tJHsoJzAnKyh2LmdldE1vbnRoKCkrMSkpLnNsaWNlKC0yKX0tJHt2LmdldERhdGUoKX1gOwoJCQkJbGV0IHQgPSBgJHt2LmdldEhvdXJzKCl9OiR7di5nZXRNaW51dGVzKCl9OiR7di5nZXRTZWNvbmRzKCl9YDsKCQkJCWlmICgodi5nZXRIb3VycygpID09IDAgJiYgdi5nZXRNaW51dGVzKCkgPT0gMCAmJiB2LmdldFNlY29uZHMoKSA9PSAwKSB8fCB0aGlzLl9kYXRlX2Nvb3AgPT0gJz0nIHx8ICF0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBPTiR7ZH1AamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdzdGFydCcpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywnZW5kJylgOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9kYXRlX2Nvb3AgIT09ICdCRVRXRUVOJykgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9IGVsc2UgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfQoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJfSwgIl90b1NOUXVlcnkiKTsKCgkJT2JqZWN0LmtleXMocmV0Lk9QRVJBVE9SUyB8fCB7fSkuZmlsdGVyKGsgPT4gdHlwZW9mKHJldFtrXSkgIT09ICd1bmRlZmluZWQnKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gcmV0Lk9QRVJBVE9SU1trXSArIHJldFtrXSk7CgoJCWRlbGV0ZSByZXQuT1BFUkFUT1JTOwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlyZXQgPSBEb3RPYmplY3QuZG90KHJldCk7CgoJCS8vIGF2b2lkIHNlbmRpbmcgd2l0aCBubyBjb21wYXJpc29uIG9wZXJhdG9ycwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVsnPicsICc8JywgJ0JFVFdFRU4nLCAnT04nLCAnIScsICc9JywgJ1NUQVJUU1dJVEgnLCAnTElLRSddLnNvbWUocyA9PiBTdHJpbmcocmV0W2tdKS5zdGFydHNXaXRoKHMpKSkuZm9yRWFjaChrID0+IHJldFtrXSA9ICh0aGlzW2BfJHtrfV9jb29wYF0gfHwgJ1NUQVJUU1dJVEgnKSArIHJldFtrXSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgT2JqZWN0LmVudHJpZXMocmV0IHx8IHt9KS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJbGV0IF9yZXQgPSBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIGZhbHNlLCBmdW4sIGVhT2JqLCBvYmopOwoJCQkJcmV0dXJuIF9yZXQ7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoInVzZXJuYW1lIiwgb2JqLCB0aGlzLnVzZXJuYW1lKCkpOwoKCQlfb3B0aW9ucygicGFzc3dvcmQiLCBvYmosIHRoaXMucGFzc3dvcmQoKSk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiMDI2NDVjNWMtYmUwNC00ZGFiLTkxYjQtZjhjODViZTk0YTZlIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXIgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXIgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVXNlcltmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVXNlcltmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVXNlcltmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVXNlcltmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlpZiAoIXRoaXMuZGVwYXJ0bWVudCgpIHx8ICh0aGlzLmRlcGFydG1lbnQoKQoKCQkJCSYmCgkJCQkhdGhpcy5kZXBhcnRtZW50KCkuZGVwYXJ0bWVudF9Vc2VycygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygiZGVwYXJ0bWVudCIsIG9iaiwgdGhpcy5kZXBhcnRtZW50KCkpOwoJCX0KCgkJX29wdGlvbnMoIm1hbmFnZXJfRGVwYXJ0bWVudHMiLCBvYmosIHRoaXMubWFuYWdlcl9EZXBhcnRtZW50cygpKTsKCgkJX29wdGlvbnMoImNhbGxlcl9JbmNpZGVudHMiLCBvYmosIHRoaXMuY2FsbGVyX0luY2lkZW50cygpKTsKCgkJX29wdGlvbnMoImNvbnRhY3RfSW5jaWRlbnRzIiwgb2JqLCB0aGlzLmNvbnRhY3RfSW5jaWRlbnRzKCkpOwoKCQlfb3B0aW9ucygidXNlcl9Hcm91cF9NZW1iZXJzIiwgb2JqLCB0aGlzLnVzZXJfR3JvdXBfTWVtYmVycygpKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsndXNlcm5hbWUnLCAncGFzc3dvcmQnLCAnZGVwYXJ0bWVudCcsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnbWFuYWdlcl9EZXBhcnRtZW50cycsICdjYWxsZXJfSW5jaWRlbnRzJywgJ2NvbnRhY3RfSW5jaWRlbnRzJywgJ3VzZXJfR3JvdXBfTWVtYmVycyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgdHJ1ZSwgZnVuLCBvYmosIG9iaik7CgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJ1c2VybmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJwYXNzd29yZCIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjAyNjQ1YzVjLWJlMDQtNGRhYi05MWI0LWY4Yzg1YmU5NGE2ZSIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVXNlcltmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Vc2VyW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlVzZXJbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiZGVwYXJ0bWVudCIsIG9iaik7CgoJCV9vcHRpb25zKCJtYW5hZ2VyX0RlcGFydG1lbnRzIiwgb2JqKTsKCgkJX29wdGlvbnMoImNhbGxlcl9JbmNpZGVudHMiLCBvYmopOwoKCQlfb3B0aW9ucygiY29udGFjdF9JbmNpZGVudHMiLCBvYmopOwoKCQlfb3B0aW9ucygidXNlcl9Hcm91cF9NZW1iZXJzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsndXNlcm5hbWUnLCAncGFzc3dvcmQnLCAnZGVwYXJ0bWVudCcsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnbWFuYWdlcl9EZXBhcnRtZW50cycsICdjYWxsZXJfSW5jaWRlbnRzJywgJ2NvbnRhY3RfSW5jaWRlbnRzJywgJ3VzZXJfR3JvdXBfTWVtYmVycyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaikpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9EQk9iamVjdChmaWVsZHMsIGJOb1JlZikgewoJCWlmICghdGhpcy5JZCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCAiSW52YWxpZCBJRCIsIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSwgdGhpcy5Ub29sKTsKCQl9CgkJbGV0IHJldCA9IHsKCQkJW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXTogIiciICsgdGhpcy5JZCArICInIgoJCX07CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigidXNlcm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fdXNlcm5hbWVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMudXNlcm5hbWUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3VzZXJuYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicGFzc3dvcmQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcGFzc3dvcmRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucGFzc3dvcmQoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGVwYXJ0bWVudCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9kZXBhcnRtZW50X3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5kZXBhcnRtZW50KCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSArICJpZCJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fYWN0aXZlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2VuYWJsZWRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9jb2RlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNvZGUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9vcmRlcl9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5vcmRlcigpOwoKCQkJZlZhbHVlID0gdiB8fCAnMCc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9kYXRlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmRhdGUoKTsKCgkJCXRyeSB7CgkJCQlmVmFsdWUgPSAiJyIgKyAodiA/IHYudG9JU09TdHJpbmcoKSA6ICIxOTcwLTEtMSIpICsgIiciOwoJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnKSB7CgkJCQkJZlZhbHVlID0gYFNUUl9UT19EQVRFKCR7ZlZhbHVlfSwgJyVZLSVtLSVkVCVULiVmWicpYDsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gJ2RhdGV0aW1lKCcgKyBmVmFsdWUgKyAnKSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX25hbWVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMubmFtZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9yZW1hcmtfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucmVtYXJrKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9RKCkgewoJCWxldCBfbyA9ICciJzsKCQlsZXQgX3EgPSBfbzsKCgkJaWYgKFsnU2FsZXNGb3JjZSddLmluZGV4T2YodGhpcy5Ub29sLnR5cGUubmFtZSkgPT0gMCkgewoJCQlfbyA9IF9xID0gIiI7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJyB8fCB0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIHsKCQkJX28gPSBfcSA9ICdgJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3Fsc2VydmVyJykgewoJCQlfbyA9ICdbJzsKCQkJX3EgPSAnXSc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCdhcGlLZXknKSA9PSAnYWlydGFibGUnKSB7CgkJCV9vID0gJ3snOwoJCQlfcSA9ICd9JzsKCQl9CgkJdGhpcy5fX1EgPSB0aGlzLl9fUSA9PSBfbyA/IF9xIDogX287CgkJcmV0dXJuIHRoaXMuX19ROwoJfQoKCV9maWVsZEdyb3VwcyhmZ3MgPSB7fSkgewoJCXRoaXMuX19maWVsZEdyb3VwcyA9IGZnczsKCQlyZXR1cm4gdGhpczsKCX0KCglfZmllbGRBZ2dyZWdhdGVzKGZhcyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkQWdncmVnYXRlcyA9IGZhczsKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9GaWVsZHNTUUwoZmllbGRzKSB7CgoJCWZpZWxkcyA9IGZpZWxkcyB8fCBbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyksIHRoaXMuX25Db2RlKCd1c2VybmFtZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdwYXNzd29yZCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKV07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnVzZXJuYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgndXNlcm5hbWUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5wYXNzd29yZCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGVwYXJ0bWVudCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2RlcGFydG1lbnQnLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9YCk7CgoJCX0KCQlyZXR1cm4gZmllbGRzOwoJfQoKCV9mcm9tREJPYmplY3QociA9IHt9KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMuX19pbXBvcnQociwgewoJCQkJSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSwKCgkJCQl1c2VybmFtZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXJuYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMudXNlcm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlwYXNzd29yZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucGFzc3dvcmQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkZXBhcnRtZW50OiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRlcGFydG1lbnQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU51bGw6IHRydWUsCgoJCQlkZXBhcnRtZW50OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LkRlcGFydG1lbnQobnVsbCwgdGhpcy5Ub29sKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJfSwgIl90b1NlbGVjdEhlYWRlciIpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RIZWFkZXInLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9TZWxlY3RTUUwoZmllbGRzKSB7CgkJbGV0IHNxbCA9ICJzZWxlY3QgIjsKCgkJbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX1gOwoKCQlsZXQgaGVhZGVyID0gdGhpcy5fdG9TZWxlY3RIZWFkZXIoZmllbGRzKTsKCgkJc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOwoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOwoKCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcykgewoJCQkvLyB7ZmllbGQ6IGZ1bmN0aW9ufQoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMudXNlcm5hbWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnVzZXJuYW1lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd1c2VybmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5wYXNzd29yZCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMucGFzc3dvcmR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRlcGFydG1lbnQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRlcGFydG1lbnR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RlcGFydG1lbnQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJdXNlcm5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VybmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fdXNlcm5hbWVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl91c2VybmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fdXNlcm5hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX3VzZXJuYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fdXNlcm5hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX3VzZXJuYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlwYXNzd29yZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9wYXNzd29yZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX3Bhc3N3b3JkX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9wYXNzd29yZF9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fcGFzc3dvcmRfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9wYXNzd29yZF9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fcGFzc3dvcmRfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWRlcGFydG1lbnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9kZXBhcnRtZW50X3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fZGVwYXJ0bWVudF9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jb2RlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fY29kZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX29yZGVyX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fb3JkZXJfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fZGF0ZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi50b0lTT1N0cmluZykgewoJCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbGl0ZScpIHsKCQkJCQkJb2JqLnNxbCArPSAic3RyZnRpbWUoJyVzJywgJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJykiOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9iai5zcWwgKz0gIiciICsgdi50b0lTT1N0cmluZygpICsgIiciOwoJCQkJCX0KCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9uYW1lX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9yZW1hcmtfc2V0KSByZXR1cm47CgoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW1hbmFnZXJfRGVwYXJ0bWVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdtYW5hZ2VyX1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX3NldCkgcmV0dXJuOwoKCQkJCWxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCgibWFuYWdlci5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50c19jb29wID09ICchPScgfHwgdGhpcy5fbWFuYWdlcl9EZXBhcnRtZW50c19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl9tYW5hZ2VyX0RlcGFydG1lbnRzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKm1hbmFnZXJfRGVwYXJ0bWVudHMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCQljYWxsZXJfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2FsbGVyX1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jYWxsZXJfSW5jaWRlbnRzX3NldCkgcmV0dXJuOwoKCQkJCWxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCgiY2FsbGVyLmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9jYWxsZXJfSW5jaWRlbnRzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl9jYWxsZXJfSW5jaWRlbnRzX2Nvb3AgPT0gJ05PVCBJTicpIHsKCQkJCQlpbk9QID0gJ05PVCBJTic7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX2NhbGxlcl9JbmNpZGVudHNfY29vcCA9PSAnPScgfHwgdGhpcy5fY2FsbGVyX0luY2lkZW50c19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX2NhbGxlcl9JbmNpZGVudHNfY29vcCA9PSAnPT0nKSB7CgkJCQkJak9QID0gJ0lOVEVSU0VDVCc7CgkJCQl9CgoJCQkJb2JqLnNxbCArPSBgYW5kIC8qY2FsbGVyX0luY2lkZW50cyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJCWNvbnRhY3RfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGFjdF9Vc2VycycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29udGFjdF9JbmNpZGVudHNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJjb250YWN0LmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9jb250YWN0X0luY2lkZW50c19jb29wID09ICchPScgfHwgdGhpcy5fY29udGFjdF9JbmNpZGVudHNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fY29udGFjdF9JbmNpZGVudHNfY29vcCA9PSAnPScgfHwgdGhpcy5fY29udGFjdF9JbmNpZGVudHNfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl9jb250YWN0X0luY2lkZW50c19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLypjb250YWN0X0luY2lkZW50cyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJCXVzZXJfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXJfVXNlcnMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoInVzZXIuaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19jb29wID09ICchPScgfHwgdGhpcy5fdXNlcl9Hcm91cF9NZW1iZXJzX2Nvb3AgPT0gJ05PVCBJTicpIHsKCQkJCQlpbk9QID0gJ05PVCBJTic7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19jb29wID09ICc9JyB8fCB0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfY29vcCA9PSAnPT0nKSB7CgkJCQkJak9QID0gJ0lOVEVSU0VDVCc7CgkJCQl9CgoJCQkJb2JqLnNxbCArPSBgYW5kIC8qdXNlcl9Hcm91cF9NZW1iZXJzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQl9LCAiX3RvU2VsZWN0U1FMIiwgZmllbGRzKS5zcWw7CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJaWYgKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy51c2VybmFtZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd1c2VybmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnVzZXJuYW1lfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnBhc3N3b3JkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMucGFzc3dvcmR9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGVwYXJ0bWVudCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kZXBhcnRtZW50fWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jb2RlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMub3JkZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZGF0ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5uYW1lfWA7CgoJCX0KCgkJaWYgKHNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpIHsKCQkJLy8gc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSIsICJ3aGVyZSAxPTAiKTsKCQl9IGVsc2UgewoJCQlzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7CgkJfQoKCQlzcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCkgOiBzcWw7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgoJCXJldHVybiBzcWw7Cgl9CgoJX3RvUGF0aHMoKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJX1RISVM6IG9iaiA9PiB7fSwKCgkJCWRlcGFydG1lbnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkZXBhcnRtZW50JywgdW5kZWZpbmVkKSkgPT4gb2JqLmRlcGFydG1lbnQgPSB2Ll90b1BhdGhzKCksCgoJCQltYW5hZ2VyX0RlcGFydG1lbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbWFuYWdlcl9Vc2VycycsIHVuZGVmaW5lZCkpID0+IG9iai5tYW5hZ2VyX0RlcGFydG1lbnRzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCQljYWxsZXJfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2FsbGVyX1VzZXJzJywgdW5kZWZpbmVkKSkgPT4gb2JqLmNhbGxlcl9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJCWNvbnRhY3RfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGFjdF9Vc2VycycsIHVuZGVmaW5lZCkpID0+IG9iai5jb250YWN0X0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQkJdXNlcl9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcl9Vc2VycycsIHVuZGVmaW5lZCkpID0+IG9iai51c2VyX0dyb3VwX01lbWJlcnMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJfSwgIl90b1BhdGhzIik7CgkJLy8gcmV0dXJuIHJldDsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5tYXAoayA9PiAoewoJCQlba106IHJldFtrXQoJCX0pKTsKCX0KCglfdG9VcGRhdGVTUUwoZmllbGRzKSB7CgkJbGV0IHJldEZpZWxkcyA9IHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLmpvaW4oJywgJyk7CgkJbGV0IHNxbCA9IGB1cGRhdGUgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSBzZXQgYCArIE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvREJPYmplY3QoZmllbGRzKSkubWFwKHYgPT4gdGhpcy5fUSgpICsgdlswXSArIHRoaXMuX1EoKSArICI9IiArIHZbMV0pICsgYCB3aGVyZSAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgOyAvL2AgcmV0dXJuaW5nICR7cmV0RmllbGRzfWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvVXBkYXRlU1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfdG9JbnNlcnRTUUwoZmllbGRzKSB7CgkJbGV0IG9iaiA9IHRoaXMuX3RvREJPYmplY3QoZmllbGRzKTsKCQlsZXQgc3FsID0gYGluc2VydCBpbnRvICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKGAgKyBPYmplY3Qua2V5cyhvYmopLm1hcChrID0+IHRoaXMuX1EoKSArIGsgKyB0aGlzLl9RKCkpICsgIikgdmFsdWVzICgiICsgT2JqZWN0LnZhbHVlcyhvYmopICsgYClgOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0luc2VydFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5Vc2VyKSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlVzZXIgPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgc3FsID0gbmV3IHNhbGVzbm93LlVzZXIoKQoKCQkJCQkuZGVwYXJ0bWVudChuZXcgc2FsZXNub3cuRGVwYXJ0bWVudCgpKQoKCQkJCQkubWFuYWdlcl9EZXBhcnRtZW50cyhuZXcgc2FsZXNub3cuRGVwYXJ0bWVudCgpKQoKCQkJCQkuY2FsbGVyX0luY2lkZW50cyhuZXcgc2FsZXNub3cuSW5jaWRlbnQoKSkKCgkJCQkJLmNvbnRhY3RfSW5jaWRlbnRzKG5ldyBzYWxlc25vdy5JbmNpZGVudCgpKQoKCQkJCQkudXNlcl9Hcm91cF9NZW1iZXJzKG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIoKSkKCgkJCQkJLl90b1NRTFRhYmxlKGRlcHRoKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXRyeSB7CgkJCWlmICghdG9vbCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnRFNDb25uZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJUb29sIGlzIG51bGwiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJCXJldHVybjsKCQkJfSBlbHNlIGlmICghdG9vbC50eXBlKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdEU0Nvbm5lY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIlRvb2wudHlwZSBpcyBudWxsIiwgdG9vbCwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCQlyZXR1cm47CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRvb2wuZGIpICE9PSAidW5kZWZpbmVkIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnRFNDb25uZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsICJUb29sIGFscmVhZHkgY29ubmVjdGVkISIpOwoJCQkJcmV0dXJuOwoJCQl9IGVsc2UgaWYgKHNhbGVzbm93Ll9ub2RlICYmIC8qc2FsZXNub3cuX25vZGUuX3BhcmVudF9zZXQgJiYgKi8gc2FsZXNub3cuX25vZGUucGFyZW50KCkuX3NhbWVOb2RlKHNhbGVzbm93Ll9ub2RlLnBhcmVudCgpKSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnRFNDb25uZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsICJOb2RlIGhhcyBhIHZhbGlkIHBhcmVudCwgbm8gbG9jYWwgU1FMIHBvc3NpYmxlIik7CgkJCQlyZXR1cm47CgkJCX0KCgkJCXRvb2wuX19kbWxTdGF0ZW1lbnRzID0gdG9vbC5fX2RtbFN0YXRlbWVudHMgfHwgW107CgoJCQlpZiAodG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgZ2xvYmFsW3RoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB7CgkJCQkJCXRvb2w6IHRvb2wKCQkJCQl9KV0pIHsKCQkJCQlpZiAoZ2xvYmFsW3RoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB7CgkJCQkJCQl0b29sOiB0b29sCgkJCQkJCX0pXS5EYXRhYmFzZSkgewoJCQkJCQl0b29sLmRiID0gbmV3IGdsb2JhbFt0aGlzLl9fY29uZmlnKCd0eXBlJywgbnVsbCwgdG9vbCldLkRhdGFiYXNlKHRoaXMuX19jb25maWcoJ2RhdGFiYXNlJywgbnVsbCwgewoJCQkJCQkJdG9vbDogdG9vbAoJCQkJCQl9KSB8fCAiLi9zYWxlc25vdy5kYiIpOwoJCQkJCX0gZWxzZSBpZiAoZ2xvYmFsW3RoaXMuX19jb25maWcoJ3R5cGUnLCBudWxsLCB7CgkJCQkJCQl0b29sOiB0b29sCgkJCQkJCX0pXS5jcmVhdGVDb25uZWN0aW9uKSB7CgkJCQkJCXRvb2wuZGIgPSBnbG9iYWxbdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHsKCQkJCQkJCXRvb2w6IHRvb2wKCQkJCQkJfSldLmNyZWF0ZUNvbm5lY3Rpb24oewoJCQkJCQkJaG9zdDogdGhpcy5fX2NvbmZpZygnc2VydmVyJywgbnVsbCwgewoJCQkJCQkJCXRvb2w6IHRvb2wKCQkJCQkJCX0pLAoJCQkJCQkJdXNlcjogdGhpcy5fX2NvbmZpZygndXNlcm5hbWUnLCBudWxsLCB7CgkJCQkJCQkJdG9vbDogdG9vbAoJCQkJCQkJfSksCgkJCQkJCQlwYXNzd29yZDogdGhpcy5fX2NvbmZpZygncGFzc3dvcmQnLCBudWxsLCB7CgkJCQkJCQkJdG9vbDogdG9vbAoJCQkJCQkJfSksCgkJCQkJCQlkYXRhYmFzZTogdGhpcy5fX2NvbmZpZygnZGF0YWJhc2UnLCBudWxsLCB7CgkJCQkJCQkJdG9vbDogdG9vbAoJCQkJCQkJfSkgfHwgInNhbGVzbm93IiwKCQkJCQkJfSk7CgkJCQkJfQoJCQkJfSBlbHNlIGlmICh0eXBlb2YoZ2xvYmFsKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdGhpcy5fX2NvbmZpZygndHlwZScsIG51bGwsIHsKCQkJCQkJdG9vbDogdG9vbAoJCQkJCX0pID09PSAnc3FsaXRlJykgewoJCQkJCS8vIHNxbGl0ZSBpbiBicm93c2VyCgkJCQkJdG9vbC5kYiA9IG5ldyBTUUwuRGF0YWJhc2UoKTsKCQkJCX0KCgkJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7CgkJCX0KCgkJCWlmICh0b29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlpZiAodHlwZW9mKHRvb2wuc3lzX3Njb3BlKSA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCQkvLyB0b29sLnN5c19zY29wZSA9IChhd2FpdCB0aGlzLl9yZXN0KCJzeXNfYXBwIiwge3N5c19zY29wZTogdGhpcy5fX2NvbmZpZygic2NvcGUiLCBudWxsLCB7dG9vbDogdG9vbH0pIHx8ICJnbG9iYWwifSkpWzBdLnN5c19pZDsKCQkJCX0KCQkJCWlmICh0eXBlb2YodG9vbC5zeXNfcHJvcGVydGllcykgPT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJLy8gbG9hZGluZyBzb21lIHBsYXRmb3JtIHN0dWZmCgkJCQkJdG9vbC5zeXNfcHJvcGVydGllcyA9IHt9OwoJCQkJCWxldCBjb25kaXRpb24gPSBPYmplY3Qua2V5cyh0b29sLnN5c19wcm9wZXJ0aWVzKS5maWx0ZXIoayA9PiAhdG9vbC5zeXNfcHJvcGVydGllc1trXSkuam9pbignLCcpOwoJCQkJCWlmIChjb25kaXRpb24pIHsKCQkJCQkJKGF3YWl0IHRoaXMuX3Jlc3QoInN5c19wcm9wZXJ0aWVzIiwgewoJCQkJCQkJbmFtZTogIklOIiArIGNvbmRpdGlvbgoJCQkJCQl9KSkuZm9yRWFjaChyID0+IHRvb2wuc3lzX3Byb3BlcnRpZXNbci5uYW1lXSA9IHIudmFsdWUpOwoJCQkJCX0KCQkJCX0KCgkJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7CgkJCX0KCgkJCWlmICh0b29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7CgkJCX0KCgkJCWlmICh0b29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdEU0Nvbm5lY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJVc2VyIikgcmV0dXJuIGZhbHNlOwoKCQkJbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJCUZ1bGw6IHRydWUsCgkJCQlOdWxsOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5faWQgPSB0aGlzLklkID09IHF1ZXJ5LklkLAoKCQkJCXVzZXJuYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai51c2VybmFtZSA9IHYgPT0gcXVlcnkudXNlcm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fdXNlcm5hbWVfc2V0ICYmICFxdWVyeS5fdXNlcm5hbWVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnVzZXJuYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3VzZXJuYW1lX3NldCAmJiBxdWVyeS5fdXNlcm5hbWVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai51c2VybmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlwYXNzd29yZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucGFzc3dvcmQgPSB2ID09IHF1ZXJ5LnBhc3N3b3JkKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3Bhc3N3b3JkX3NldCAmJiAhcXVlcnkuX3Bhc3N3b3JkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5wYXNzd29yZCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9wYXNzd29yZF9zZXQgJiYgcXVlcnkuX3Bhc3N3b3JkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucGFzc3dvcmQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGVwYXJ0bWVudDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGVwYXJ0bWVudCA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkuZGVwYXJ0bWVudCgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kZXBhcnRtZW50X3NldCAmJiAhcXVlcnkuX2RlcGFydG1lbnRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRlcGFydG1lbnQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGVwYXJ0bWVudF9zZXQgJiYgcXVlcnkuX2RlcGFydG1lbnRfc2V0KSB8fAoKCQkJCQkJKHRoaXMuZGVwYXJ0bWVudCgpICYmICF0aGlzLmRlcGFydG1lbnQoKS5fbWF0Y2hlcyhxdWVyeS5kZXBhcnRtZW50KCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kZXBhcnRtZW50ID0gZmFsc2U7CgkJCQl9LAoKCQkJCWFjdGl2ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouYWN0aXZlID0gdiA9PSBxdWVyeS5hY3RpdmUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fYWN0aXZlX3NldCAmJiAhcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2FjdGl2ZV9zZXQgJiYgcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5lbmFibGVkID0gdiA9PSBxdWVyeS5lbmFibGVkKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ICYmICFxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9lbmFibGVkX3NldCAmJiBxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY29kZSA9IHYgPT0gcXVlcnkuY29kZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jb2RlX3NldCAmJiAhcXVlcnkuX2NvZGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY29kZV9zZXQgJiYgcXVlcnkuX2NvZGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vcmRlciA9IHYgPT0gcXVlcnkub3JkZXIoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fb3JkZXJfc2V0ICYmICFxdWVyeS5fb3JkZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX29yZGVyX3NldCAmJiBxdWVyeS5fb3JkZXJfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5kYXRlID0gdiA9PSBxdWVyeS5kYXRlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2RhdGVfc2V0ICYmICFxdWVyeS5fZGF0ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9kYXRlX3NldCAmJiBxdWVyeS5fZGF0ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubmFtZSA9IHYgPT0gcXVlcnkubmFtZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9uYW1lX3NldCAmJiAhcXVlcnkuX25hbWVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbmFtZV9zZXQgJiYgcXVlcnkuX25hbWVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gZmFsc2U7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucmVtYXJrID0gdiA9PSBxdWVyeS5yZW1hcmsoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcmVtYXJrX3NldCAmJiAhcXVlcnkuX3JlbWFya19zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3JlbWFya19zZXQgJiYgcXVlcnkuX3JlbWFya19zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IGZhbHNlOwoJCQkJfSwKCgkJCQltYW5hZ2VyX0RlcGFydG1lbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLm1hbmFnZXJfRGVwYXJ0bWVudHMgPSB2Lm1hcChfdiA9PiBxdWVyeS5tYW5hZ2VyX0RlcGFydG1lbnRzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQkJY2FsbGVyX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5jYWxsZXJfSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gcXVlcnkuY2FsbGVyX0luY2lkZW50cygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJCWNvbnRhY3RfSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmNvbnRhY3RfSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gcXVlcnkuY29udGFjdF9JbmNpZGVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCQl1c2VyX0dyb3VwX01lbWJlcnM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoudXNlcl9Hcm91cF9NZW1iZXJzID0gdi5tYXAoX3YgPT4gcXVlcnkudXNlcl9Hcm91cF9NZW1iZXJzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoZXMiKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDAsIG9NYXRjaCk7CgoJCQlyZXR1cm4gT2JqZWN0LmtleXMob01hdGNoKS5ldmVyeShrID0+IG9NYXRjaFtrXSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfbWF0Y2hpbmcocXVlcnkpIHsKCQl0cnkgewoJCQlsZXQgcmV0ID0gW107CgoJCQlsZXQgbWF0Y2hlcyA9IHRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlkZXBhcnRtZW50OiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgZGVwYXJ0bWVudCIpOwoJCQkJCW9iai5kZXBhcnRtZW50ID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJbWFuYWdlcl9EZXBhcnRtZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5tYW5hZ2VyX0RlcGFydG1lbnRzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCQljYWxsZXJfSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmNhbGxlcl9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJCWNvbnRhY3RfSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmNvbnRhY3RfSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCQl1c2VyX0dyb3VwX01lbWJlcnM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoudXNlcl9Hcm91cF9NZW1iZXJzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl91c2VybmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9wYXNzd29yZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9kZXBhcnRtZW50X3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJZGVwYXJ0bWVudDogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLmRlcGFydG1lbnQocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCW1hbmFnZXJfRGVwYXJ0bWVudHM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5tYW5hZ2VyX0RlcGFydG1lbnRzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCWNhbGxlcl9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5jYWxsZXJfSW5jaWRlbnRzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCWNvbnRhY3RfSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuY29udGFjdF9JbmNpZGVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJdXNlcl9Hcm91cF9NZW1iZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMudXNlcl9Hcm91cF9NZW1iZXJzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQl1c2VybmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3VzZXJuYW1lJywgdW5kZWZpbmVkKSA6ICJ1c2VybmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl91c2VybmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMudXNlcm5hbWUocmVmKTsKCgkJCX0sCgoJCQlwYXNzd29yZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3Bhc3N3b3JkJywgdW5kZWZpbmVkKSA6ICJwYXNzd29yZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9wYXNzd29yZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucGFzc3dvcmQocmVmKTsKCgkJCX0sCgoJCQlkZXBhcnRtZW50OiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkgOiAiZGVwYXJ0bWVudCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kZXBhcnRtZW50X2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLmRlcGFydG1lbnQoKSB8fCBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudCgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuZGVwYXJ0bWVudChvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIGRlcGFydG1lbnQiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvZGUocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kYXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoJCQkJCWlmICh0eXBlb2YobW9tZW50KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZWYgPSBuZXcgRGF0ZShyZWYpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmVmID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpKTsKCQkJCX0KCQkJCXRoaXMuZGF0ZShyZWYpOwoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm5hbWUocmVmKTsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZW1hcmtfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnJlbWFyayhyZWYpOwoKCQkJfSwKCgkJCW1hbmFnZXJfRGVwYXJ0bWVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdtYW5hZ2VyX1VzZXJzJywgdW5kZWZpbmVkKSA6ICJtYW5hZ2VyX0RlcGFydG1lbnRzIikpID0+IHRoaXMubWFuYWdlcl9EZXBhcnRtZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudCgpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQkJY2FsbGVyX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NhbGxlcl9Vc2VycycsIHVuZGVmaW5lZCkgOiAiY2FsbGVyX0luY2lkZW50cyIpKSA9PiB0aGlzLmNhbGxlcl9JbmNpZGVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCQljb250YWN0X0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvbnRhY3RfVXNlcnMnLCB1bmRlZmluZWQpIDogImNvbnRhY3RfSW5jaWRlbnRzIikpID0+IHRoaXMuY29udGFjdF9JbmNpZGVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCQl1c2VyX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd1c2VyX1VzZXJzJywgdW5kZWZpbmVkKSA6ICJ1c2VyX0dyb3VwX01lbWJlcnMiKSkgPT4gdGhpcy51c2VyX0dyb3VwX01lbWJlcnMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93Lkdyb3VwX01lbWJlcigpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQl9LCAiX2Zyb21Eb2N1bWVudCIpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSB7CgkJbGV0IHJldCA9IHt9OwoKCQlpZiAoIWJUb29sKSB7CgkJCXJldC5fX2dlbmVyYXRlZCA9IG5ldyBEYXRlKCk7CgkJCWlmICh0aGlzLlRvb2wubmFtZSkgewoJCQkJcmV0Ll9fdG9vbCA9IHsKCQkJCQluYW1lOiB0aGlzLlRvb2wubmFtZSwKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlpZiAoc2FsZXNub3cuX25vZGUpIHsKCQkJCXJldC5fX25vZGUgPSB7CgkJCQkJY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogYkZ1bGwsCgkJCU51bGw6IGJOdWxsLAoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IChvYmosIHYpID0+IHsKCQkJCWlmIChiVG9vbCkgcmV0dXJuOwoJCQkJb2JqLlRISVMgPSB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQlvYmouT1BFUkFUT1JTLlRISVMgPSB0aGlzLl9USElTX2Nvb3A7CgkJCX0sCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldID0gdiwKCgkJCSJ1c2VybmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd1c2VybmFtZScsIHVuZGVmaW5lZCkgOiAidXNlcm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fdXNlcm5hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3VzZXJuYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicGFzc3dvcmQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncGFzc3dvcmQnLCB1bmRlZmluZWQpIDogInBhc3N3b3JkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3Bhc3N3b3JkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9wYXNzd29yZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRlcGFydG1lbnQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudCcsIHVuZGVmaW5lZCkgOiAiZGVwYXJ0bWVudCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX2RlcGFydG1lbnRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RlcGFydG1lbnRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCW1hbmFnZXJfRGVwYXJ0bWVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdtYW5hZ2VyX1VzZXJzJywgdW5kZWZpbmVkKSA6ICJtYW5hZ2VyX0RlcGFydG1lbnRzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJCWNhbGxlcl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjYWxsZXJfVXNlcnMnLCB1bmRlZmluZWQpIDogImNhbGxlcl9JbmNpZGVudHMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fY2FsbGVyX0luY2lkZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY2FsbGVyX0luY2lkZW50c19jb29wOwoJCQkJfQoJCQl9LAoKCQkJY29udGFjdF9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb250YWN0X1VzZXJzJywgdW5kZWZpbmVkKSA6ICJjb250YWN0X0luY2lkZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9jb250YWN0X0luY2lkZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29udGFjdF9JbmNpZGVudHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJCXVzZXJfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3VzZXJfVXNlcnMnLCB1bmRlZmluZWQpIDogInVzZXJfR3JvdXBfTWVtYmVycyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl91c2VyX0dyb3VwX01lbWJlcnNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3VzZXJfR3JvdXBfTWVtYmVyc19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoYXN5bmMgKGZ1biwgY2FsbEJhY2spID0+IHsKCQkJCWlmICh0aGlzLnNfRXJyb3JNZXNzYWdlcyAmJiB0aGlzLnNfRXJyb3JNZXNzYWdlcy5sZW5ndGggPiAwKSB7CgkJCQkJYWxlcnQoCgkJCQkJCSdUaGUgZm9sbG93aW5nIGVycm9ycyB3ZXJlIGZvdW5kIGluIHlvdXIgZGF0YTpcbicgKwoJCQkJCQl0aGlzLnNfRXJyb3JNZXNzYWdlcwoJCQkJCSk7CgkJCQkJdGhpcy5zX0Vycm9yTWVzc2FnZXMgPSAnJzsKCQkJCQlyZXR1cm4gbnVsbDsKCQkJCX0KCgkJCQl0aGlzLmJ1aWxkVVJMKCk7CgoJCQkJaWYgKHR5cGVvZihkb2N1bWVudCkgIT09ICJ1bmRlZmluZWQiKSgKCQkJCQl0aGlzLmZMb2FkaW5nU3RhcnQgfHwKCQkJCQlmdW5jdGlvbigpIHsKCQkJCQkJaWYgKGRvY3VtZW50LmJvZHkpIGRvY3VtZW50LmJvZHkuc3R5bGUuY3Vyc29yID0gJ3dhaXQnOwoJCQkJCX0KCQkJCSkoKTsKCgkJCQl2YXIgYXJncyA9IEFycmF5KCk7CgkJCQlmb3IgKHZhciBpID0gMjsgaSA8IGFyZ3VtZW50cy5sZW5ndGg7IGkrKykgewoJCQkJCWFyZ3NbaSAtIDJdID0gYXJndW1lbnRzW2ldOwoJCQkJfQoKCQkJCXZhciBwb3N0RGF0YSA9IHRoaXMucGFyYW0oYXJncyk7CgkJCQlpZiAoZnVuLmluZGV4T2YoJy4nKSA8IDApIHsKCQkJCQlmdW4gPSB0aGlzLnN5c3RlbU5hbWUgKyAnLicgKyBmdW47CgkJCQl9IGVsc2UgaWYgKGZ1bi5pbmRleE9mKCcuJykgPT0gMCkgewoJCQkJCS8vIGEgbm9uLWxheWVyIG1ldGhvZAoJCQkJCWZ1biA9IGZ1bi5zdWJzdHJpbmcoMSk7CgkJCQl9CgoJCQkJaWYgKGNhbGxCYWNrICYmIHRoaXMuQWN0aXZlUmVxdWVzdCkgewoJCQkJCXRoaXMuQWN0aXZlUmVxdWVzdCA9IG51bGw7CgkJCQkJLy9yZXR1cm4gZmFsc2U7CgkJCQl9CgoJCQkJdmFyIGhDb2RlID0gdGhpcy5oYXNoQ29kZSgKCQkJCQlmdW4uc3Vic3RyaW5nKGZ1bi5pbmRleE9mKCcuJykgKyAxKSArIHBvc3REYXRhCgkJCQkpOwoKCQkJCXRoaXMuQ1JOTCA9IHRoaXMuQ1JOTCB8fCAiXG4iOwoJCQkJcG9zdERhdGEgKz0KCQkJCQl0aGlzLkNSTkwgKwoJCQkJCXRoaXMuQ1JOTCArCgkJCQkJJzwhLS08cGlkPicgKwoJCQkJCWhDb2RlICsKCQkJCQknPC9waWQ+LS0+JyArCgkJCQkJdGhpcy5DUk5MOwoKCQkJCWlmIChmdW4uaW5kZXhPZignY21zTWV0aG9kUmVzdWx0RmluZCcpIDwgMCkgewoJCQkJCS8vIGF2b2lkIG92ZXJ3cml0ZSBvZiBhc3luYyBjYWxscwoJCQkJCXRoaXMuQWN0aXZlUmVxdWVzdCA9IHsKCQkJCQkJVVJMOiB0aGlzLnNyVVJMICsgJyZuYW1lPScgKyBmdW4sCgkJCQkJCVBvc3REYXRhOiBwb3N0RGF0YSwKCQkJCQkJRGF0ZTogbmV3IERhdGUoKSwKCQkJCQkJQ2FsbEJhY2s6IGNhbGxCYWNrLAoJCQkJCQlDb21wYW55OiB0eXBlb2YgY29tcGFueSAhPT0gJ3VuZGVmaW5lZCcgJiYgY29tcGFueSA/IHsKCQkJCQkJCUNvZGU6IGNvbXBhbnkuQ29kZSwKCQkJCQkJfSA6IG51bGwsCgkJCQkJCVRleHRSZXNwb25zZTogbnVsbCwKCQkJCQkJaGFzaDogaENvZGUsCgkJCQkJfTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmICF0aGlzLmJMb2NhbCkgewoJCQkJCS8vIGxpdmUKCQkJCQl0cnkgewoJCQkJCQl2YXIgX3RoZVVybCA9CgkJCQkJCQkodGhpcy5TdG9yZSB8fAoJCQkJCQkJCScvc3RvcmUvJyArCgkJCQkJCQkJKHdpbmRvdy5jb21wYW55ICYmIHdpbmRvdy5jb21wYW55LkNvZGUgPwoJCQkJCQkJCQl3aW5kb3cuY29tcGFueS5Db2RlICsgJy8nIDoKCQkJCQkJCQkJJy8nKSkgKwoJCQkJCQkJaENvZGUgKwoJCQkJCQkJJy5qcz9yYW5kPScgKwoJCQkJCQkJTWF0aC5yYW5kb20oKTsKCQkJCQkJbGV0IHJlcXVlc3QgPSBhd2FpdCB0aGlzLmNhY2hlUmVzdWx0KCk7CgkJCQkJCXZhciByZXNwb25zZVRleHQgPSBudWxsOwoJCQkJCQlpZiAoIXJlcXVlc3QpIHsKCQkJCQkJCXRyeSB7CgkJCQkJCQkJcmVzcG9uc2VUZXh0ID0gYXdhaXQgJC5nZXQoX3RoZVVybCk7CgkJCQkJCQl9IGNhdGNoIChleCkge30KCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXJlc3BvbnNlVGV4dCA9IHJlcXVlc3QuVGV4dFJlc3BvbnNlOwoJCQkJCQl9CgkJCQkJCWlmICghcmVzcG9uc2VUZXh0KSB7CgkJCQkJCQljb25zb2xlLmxvZygKCQkJCQkJCQknTGl2ZSBNb2RlLCBubyByZXNwb25zZSB0ZXh0IGZvciAnICsKCQkJCQkJCQl0aGlzLkFjdGl2ZVJlcXVlc3QuaGFzaCArCgkJCQkJCQkJJyAtICcgKwoJCQkJCQkJCXRoaXMuJF9SRVFVRVNUKCduYW1lJywgdGhpcy5BY3RpdmVSZXF1ZXN0LlVSTCkKCQkJCQkJCSk7CgkJCQkJCQlyZXR1cm4gbnVsbDsKCQkJCQkJfQoKCQkJCQkJdmFyIF9yZXQgPSBudWxsOwoJCQkJCQl2YXIgX2V4Y2VwdGlvbiA9IG51bGw7CgkJCQkJCXRyeSB7CgkJCQkJCQlfcmV0ID0gdGhpcy5ydW5TUlNjcmlwdChyZXNwb25zZVRleHQpOwoJCQkJCQkJX2V4Y2VwdGlvbiA9IF9yZXQuX2V4Y2VwdGlvbjsKCQkJCQkJCWlmIChfcmV0LnNlcnZlcl90aW1lKSB7CgkJCQkJCQkJbGV0IHRkID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgLSBfcmV0LnNlcnZlcl90aW1lLmdldFRpbWUoKTsKCQkJCQkJCQl0cnkgewoJCQkJCQkJCQl3aW5kb3cudGltZURpZmZlcmVuY2UgPSB0ZDsKCQkJCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQkJCQlnbG9iYWwudGltZURpZmZlcmVuY2UgPSB0ZDsKCQkJCQkJCQl9CgkJCQkJCQl9CgkJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJCV9leGNlcHRpb24gPSBlOwoJCQkJCQl9CgoJCQkJCQlpZiAoIV9yZXQgJiYgIV9leGNlcHRpb24pIHsKCQkJCQkJCXJldHVybiBhd2FpdCBudWxsOyAvL3RoaXMuZG9IZWFkbGVzc0NhbGwoY2FsbEJhY2spOwoJCQkJCQl9IGVsc2UgewoJCQkJCQkJLy90aGlzLkFjdGl2ZVJlcXVlc3QgPSBudWxsOwoJCQkJCQkJaWYgKGNhbGxCYWNrICE9IG51bGwpIHsKCQkJCQkJCQl0cnkgewoJCQkJCQkJCQljYWxsQmFjaygKCQkJCQkJCQkJCV9yZXQucmV0IHx8IChfZXhjZXB0aW9uID8gcmVzcG9uc2VUZXh0IDogbnVsbCksCgkJCQkJCQkJCQlfZXhjZXB0aW9uCgkJCQkJCQkJCSk7CgkJCQkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkJCQl0aGlzLlNob3dFcnJvcigKCQkJCQkJCQkJCSdFcnJvciBpbiBDYWxsYmFjazpcblxuJyArCgkJCQkJCQkJCQljYWxsQmFjayArCgkJCQkJCQkJCQknXG5cbicgKwoJCQkJCQkJCQkJZS5tZXNzYWdlCgkJCQkJCQkJCSk7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQkJKAoJCQkJCQkJCXdpbmRvdy5zci5mTG9hZGluZ0VuZCB8fAoJCQkJCQkJCSgoKSA9PiB7CgkJCQkJCQkJCXRoaXMucmVzZXRDdXJzb3IoKTsKCQkJCQkJCQl9KQoJCQkJCQkJKSgpOwoJCQkJCQkJcmV0dXJuICgKCQkJCQkJCQkoX3JldCA/IF9yZXQucmV0IDogbnVsbCkgfHwKCQkJCQkJCQkoX2V4Y2VwdGlvbiA/IHJlc3BvbnNlVGV4dCA6IG51bGwpCgkJCQkJCQkpOwoJCQkJCQl9CgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQljb25zb2xlLmxvZyhlKTsKCQkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmV0dXJuIChhc3luYyAoKSA9PiB7CgkJCQkJCS8qdHJ5IHsKCQkJCQkJCWxldCBzY29wZSA9IGZ1bi5zcGxpdCgnLicpWzBdLnJlcGxhY2UoLyhbYS16MC05XSkoW0EtWl0pL2csICckMSAkMicpLnJlcGxhY2UoJyAnLCAnJykudG9Mb3dlckNhc2UoKTsKCQkJCQkJCWxldCBhcGkgPSBmdW4uc3BsaXQoJy4nKVsxXS5yZXBsYWNlKC8oW2EtejAtOV0pKFtBLVpdKS9nLCAnJDEgJDInKS5zcGxpdCgnICcpLnNsaWNlKDEsIC0xKS5qb2luKCcnKS5yZXBsYWNlKCcgJywgJycpOwoJCQkJCQkJbGV0IGZOYW1lID0gZnVuLnNwbGl0KCcuJylbMV0ucmVwbGFjZSgvKFthLXowLTldKShbQS1aXSkvZywgJyQxICQyJykuc3BsaXQoJyAnKS5zbGljZSgtMSlbMF0udG9Mb3dlckNhc2UoKS5yZXBsYWNlKCdmaW5kYWxsJywgJ2ZpbmRBbGwnKTsKCQkJCQkJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgJiYgd2luZG93W3Njb3BlXSAmJiBbJ2luc2VydCcsICdkZWxldGUnLCAndXBkYXRlJywgJ2ZpbmQnLCAnZmluZEFsbCddLmluZGV4T2YoZk5hbWUpID4gLTEpIHsKCQkJCQkJCQlsZXQgc0NhbGwgPSBgYXdhaXQgbmV3ICR7c2NvcGV9LiR7YXBpfSgpLiR7Zk5hbWV9KC4uLmFyZ3MpYDsKCQkJCQkJCQlsZXQgbyA9IG5ldyB3aW5kb3dbc2NvcGVdW2FwaV0oKTsKCQkJCQkJCQlPYmplY3Qua2V5cyhhcmdzWzBdKS5maWx0ZXIoayA9PiBrICE9PSAiT1BFUkFUT1JTIikuZm9yRWFjaChrID0+IHsKCQkJCQkJCQkJb1trLnJlcGxhY2UoLyg/Ol5cd3xbQS1aXXxcYlx3fFxzKykvZywgKG1hdGNoLCBpbmRleCkgPT4gewoJCQkJCQkJCQkJaWYgKCttYXRjaCA9PT0gMCkgcmV0dXJuICIiOwoJCQkJCQkJCQkJcmV0dXJuIGluZGV4ID09PSAwID8gbWF0Y2gudG9Mb3dlckNhc2UoKSA6IG1hdGNoLnRvVXBwZXJDYXNlKCk7CgkJCQkJCQkJCX0pXShhcmdzWzBdW2tdLCBhcmdzWzBdLk9QRVJBVE9SUz8uW2tdKTsKCQkJCQkJCQl9KTsKCQkJCQkJCQljb25zb2xlLmxvZyhzQ2FsbCwgby5fdG9Eb2N1bWVudCgpLCBhcmdzKTsKCQkJCQkJCQkvL3JldHVybiBhd2FpdCBvW2ZOYW1lXSgpOwoJCQkJCQkJfQoJCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQkJY29uc29sZS5sb2coIl8oKSBFeGNlcHRpb246ICIgKyBleCk7CgkJCQkJCX0qLwoKCQkJCQkJcmV0dXJuIGF3YWl0IHRoaXMuc2VuZFhNTCgKCQkJCQkJCXRoaXMuc3JVUkwgKyAnJm5hbWU9JyArIGZ1biwKCQkJCQkJCXBvc3REYXRhLAoJCQkJCQkJY2FsbEJhY2sKCQkJCQkJKTsKCQkJCQl9KSgpOwoJCQkJfQoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoc3JVUkwpID0+IHsKCQkJCWlmICghc3JVUkwpIHsKCQkJCQl0aGlzLnNyVVJMID0gdGhpcy4kX1JFUVVFU1QoJ3NyJyk7CgkJCQkJaWYgKCF0aGlzLnNyVVJMKSB7CgkJCQkJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJCWxldCBpcCA9IHRoaXMuaXBBZGRyZXNzKCk7CgkJCQkJCQlpZiAoaXAgJiYgKGlwLnN0YXJ0c1dpdGgoIjE4Mi4xNjguIikgfHwgaXAgPT0gIjE5Mi4xNjguMS4yNTMiIHx8IGlwID09ICcxOTUuMTEyLjIxNS4yMTgnKSkgewoJCQkJCQkJCXRoaXMuc3JVUkwgPSAiaHR0cDovLzE4Mi4xNjguNzAuODAiOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQl0aGlzLnNyVVJMID0gImh0dHA6Ly9hcnoubmFtbW91ci5jb206NzA4MCI7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJdGhpcy5zclVSTCArPSAnL21ldGhvZC9TZXJ2aWNlUm91dGVyLmFzaHgnOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5zclVSTCA9IHNyVVJMOwoJCQkJfQoJCQkJdGhpcy5zclVSTCArPSAnP3NydmVyc2lvbj0xJzsKCQkJCWlmICh0aGlzLiRfUkVRVUVTVCgnZ3ppcCcpKSB7CgkJCQkJdGhpcy5zclVSTCArPSAnJmd6aXA9JyArIHRoaXMuJF9SRVFVRVNUKCdnemlwJyk7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuc3JVUkwgKz0gJyZnemlwPXRydWUnOwoJCQkJfQoJCQkJaWYgKHRoaXMuYkNhY2hlKSB7CgkJCQkJdGhpcy5zclVSTCArPSAnJmNhY2hlPScgKyB0aGlzLmJDYWNoZTsKCQkJCX0KCQkJCWlmICghdGhpcy4kX1JFUVVFU1QoJ3JhbmQnLCB0aGlzLnNyVVJMKSkgewoJCQkJCXRoaXMuc3JVUkwgKz0gJyZyYW5kPScgKyBNYXRoLnJhbmRvbSgpOwoJCQkJfQoKCQkJCWlmICh0aGlzLmJEZWJ1ZykgewoJCQkJCXRoaXMuc3JVUkwgKz0gJyZERUJVRz10cnVlJzsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJdGhpcy5iQXN5bmMgJiYKCQkJCQl0aGlzLmJMb2NhbCAmJgoJCQkJCSF0aGlzLiRfUkVRVUVTVCgnYXN5bmMnLCB0aGlzLnNyVVJMKQoJCQkJKSB7CgkJCQkJdGhpcy5zclVSTCArPSAnJmFzeW5jPXRydWUnOwoJCQkJCWlmICh0aGlzLnJ1bkFmdGVyKSB7CgkJCQkJCXRoaXMuc3JVUkwgKz0gJyZydW5hZnRlcj0nICsgdGhpcy5ydW5BZnRlcjsKCQkJCQl9CgkJCQkJdGhpcy5iQXN5bmMgPSBmYWxzZTsKCQkJCX0KCgkJCQkvL3RoaXMuU2hvd0RlYnVnKCd0aGlzLnNyVVJMPScgKyB0aGlzLnNyVVJMKTsKCgkJCQlyZXR1cm4gdGhpcy5zclVSTDsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChrZXksIHVybCkgPT4gewoJCQkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIG51bGw7CgoJCQkJbGV0IHJldCA9IHVuZGVmaW5lZDsKCQkJCWlmICh1cmwpIHsKCQkJCQl0cnkgewoJCQkJCQlyZXQgPSBuZXcgVVJMKHVybCkuc2VhcmNoUGFyYW1zLmdldChrZXkpOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXZhciByZWdleCA9IG5ldyBSZWdFeHAoJ1tcXD98Jl0nICsga2V5ICsgJz0oW14mI10qKScpOwoJCQkJCQl2YXIgcmVzdWx0cyA9IHJlZ2V4LmV4ZWMoJz8nICsgdXJsLnNwbGl0KCc/JylbMV0pOwoJCQkJCQlyZXQgPSAocmVzdWx0cyA9PT0gbnVsbCkgPyAnJyA6IGRlY29kZVVSSUNvbXBvbmVudChyZXN1bHRzWzFdLnJlcGxhY2UoL1wrL2csICcgJykpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmV0ID0gbmV3IFVSTFNlYXJjaFBhcmFtcyh3aW5kb3cubG9jYXRpb24uc2VhcmNoKS5nZXQoa2V5KTsKCQkJCX0KCgkJCQlyZXR1cm4gcmV0ID09PSBudWxsID8gJycgOiByZXQ7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKGFyZ3MpID0+IHsKCQkJCXRoaXMuQ1JOTCA9IHRoaXMuQ1JOTCB8fCAiXG4iOwoJCQkJdmFyIHJldCA9CgkJCQkJJy8qJyArCgkJCQkJdGhpcy5DUk5MICsKCQkJCQknPCFbQ0RBVEFbJyArCgkJCQkJdGhpcy5DUk5MICsKCQkJCQknUEFSQU1FVEVSUycgKwoJCQkJCXRoaXMuQ1JOTCArCgkJCQkJJ11dPicgKwoJCQkJCXRoaXMuQ1JOTCArCgkJCQkJJyovJyArCgkJCQkJdGhpcy5DUk5MICsKCQkJCQl0aGlzLkNSTkwgKwoJCQkJCSc8cD4nICsKCQkJCQl0aGlzLkNSTkw7CgkJCQlmb3IgKHZhciBpID0gMDsgaSA8IGFyZ3MubGVuZ3RoOyBpKyspIHsKCQkJCQl2YXIgeG1sID0gdGhpcy5fdG9YTUwoYXJnc1tpXSk7CgkJCQkJaWYgKGZhbHNlKSB7CgkJCQkJCS8vIHhtbCBjb250YWlucyBjaGFyYWN0ZXJzIHRoYXQgd291bGQgbm90IGFycml2ZSBwcm9wZXJseSBhbmQgc2hvdWxkIGJlIGNvbnZlcnRlZCB0byBiYXNlNjQKCQkJCQkJeG1sID0gYnRvYSh4bWwpOwoJCQkJCX0KCQkJCQlyZXQgKz0gJzxwJyArIGkgKyAnPicgKyB0aGlzLkNSTkwgKyB4bWwgKyAnJyArIHRoaXMuQ1JOTDsKCQkJCQlyZXQgKz0gJzwvcCcgKyBpICsgJz4nICsgdGhpcy5DUk5MOwoJCQkJfQoJCQkJcmV0ICs9ICc8L3A+JyArIHRoaXMuQ1JOTDsKCQkJCXJldHVybiByZXQ7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgobywgbGV2ZWwpID0+IHsKCQkJCWlmICghbGV2ZWwpIGxldmVsID0gMDsKCQkJCXZhciBzID0gJyc7CgkJCQlpZiAobyA9PSBudWxsKSByZXR1cm4gczsKCQkJCXN3aXRjaCAodHlwZW9mIG8pIHsKCQkJCQljYXNlICdzdHJpbmcnOgoJCQkJCQlzICs9ICc8IVtDREFUQVsnICsgbyArICddXT4nOwoJCQkJCQlicmVhazsKCQkJCQljYXNlICdudW1iZXInOgoJCQkJCWNhc2UgJ2Jvb2xlYW4nOgoJCQkJCQlzICs9IG8udG9TdHJpbmcoKTsKCQkJCQkJYnJlYWs7CgkJCQkJY2FzZSAnb2JqZWN0JzoKCQkJCQkJLy8gRGF0ZQoJCQkJCQlpZiAoCgkJCQkJCQlvLmNvbnN0cnVjdG9yICYmCgkJCQkJCQlvLmNvbnN0cnVjdG9yLnRvU3RyaW5nKCkuaW5kZXhPZignZnVuY3Rpb24gRGF0ZSgpJykgPiAtMSAmJgoJCQkJCQkJby5jb25zdHJ1Y3Rvci5uYW1lID09ICJEYXRlIgoJCQkJCQkpIHsKCQkJCQkJCXZhciB5ZWFyID0gby5nZXRVVENGdWxsWWVhcigpLnRvU3RyaW5nKCk7CgkJCQkJCQl2YXIgbW9udGggPSAoby5nZXRVVENNb250aCgpICsgMSkudG9TdHJpbmcoKTsKCQkJCQkJCW1vbnRoID0gbW9udGgubGVuZ3RoID09IDEgPyAnMCcgKyBtb250aCA6IG1vbnRoOwoJCQkJCQkJdmFyIGRhdGUgPSBvLmdldFVUQ0RhdGUoKS50b1N0cmluZygpOwoJCQkJCQkJZGF0ZSA9IGRhdGUubGVuZ3RoID09IDEgPyAnMCcgKyBkYXRlIDogZGF0ZTsKCQkJCQkJCXZhciBob3VycyA9IG8uZ2V0VVRDSG91cnMoKS50b1N0cmluZygpOwoJCQkJCQkJaG91cnMgPSBob3Vycy5sZW5ndGggPT0gMSA/ICcwJyArIGhvdXJzIDogaG91cnM7CgkJCQkJCQl2YXIgbWludXRlcyA9IG8uZ2V0VVRDTWludXRlcygpLnRvU3RyaW5nKCk7CgkJCQkJCQltaW51dGVzID0gbWludXRlcy5sZW5ndGggPT0gMSA/ICcwJyArIG1pbnV0ZXMgOiBtaW51dGVzOwoJCQkJCQkJdmFyIHNlY29uZHMgPSBvLmdldFVUQ1NlY29uZHMoKS50b1N0cmluZygpOwoJCQkJCQkJc2Vjb25kcyA9IHNlY29uZHMubGVuZ3RoID09IDEgPyAnMCcgKyBzZWNvbmRzIDogc2Vjb25kczsKCQkJCQkJCXZhciBtaWxsaXNlY29uZHMgPSBvLmdldFVUQ01pbGxpc2Vjb25kcygpLnRvU3RyaW5nKCk7CgkJCQkJCQl2YXIgdHptaW51dGVzID0gTWF0aC5hYnMoby5nZXRUaW1lem9uZU9mZnNldCgpKTsKCQkJCQkJCXZhciB0emhvdXJzID0gMDsKCQkJCQkJCXdoaWxlICh0em1pbnV0ZXMgPj0gNjApIHsKCQkJCQkJCQl0emhvdXJzKys7CgkJCQkJCQkJdHptaW51dGVzIC09IDYwOwoJCQkJCQkJfQoJCQkJCQkJdHptaW51dGVzID0KCQkJCQkJCQl0em1pbnV0ZXMudG9TdHJpbmcoKS5sZW5ndGggPT0gMSA/CgkJCQkJCQkJJzAnICsgdHptaW51dGVzLnRvU3RyaW5nKCkgOgoJCQkJCQkJCXR6bWludXRlcy50b1N0cmluZygpOwoJCQkJCQkJdHpob3VycyA9CgkJCQkJCQkJdHpob3Vycy50b1N0cmluZygpLmxlbmd0aCA9PSAxID8KCQkJCQkJCQknMCcgKyB0emhvdXJzLnRvU3RyaW5nKCkgOgoJCQkJCQkJCXR6aG91cnMudG9TdHJpbmcoKTsKCQkJCQkJCXZhciB0aW1lem9uZSA9CgkJCQkJCQkJKG8uZ2V0VGltZXpvbmVPZmZzZXQoKSA8IDAgPyAnKycgOiAnLScpICsKCQkJCQkJCQl0emhvdXJzICsKCQkJCQkJCQknOicgKwoJCQkJCQkJCXR6bWludXRlczsKCQkJCQkJCS8vcyArPSB5ZWFyICsgIi0iICsgbW9udGggKyAiLSIgKyBkYXRlICsgIlQiICsgaG91cnMgKyAiOiIgKyBtaW51dGVzICsgIjoiICsgc2Vjb25kcyArICIuIiArIG1pbGxpc2Vjb25kcyArIHRpbWV6b25lOwoJCQkJCQkJcyArPQoJCQkJCQkJCW1vbnRoICsKCQkJCQkJCQknLycgKwoJCQkJCQkJCWRhdGUgKwoJCQkJCQkJCScvJyArCgkJCQkJCQkJeWVhciArCgkJCQkJCQkJJyAnICsKCQkJCQkJCQlob3VycyArCgkJCQkJCQkJJzonICsKCQkJCQkJCQltaW51dGVzICsKCQkJCQkJCQknOicgKwoJCQkJCQkJCXNlY29uZHM7CgkJCQkJCX0KCQkJCQkJLy8gQXJyYXkKCQkJCQkJZWxzZSBpZiAoCgkJCQkJCQlvLmNvbnN0cnVjdG9yICYmCgkJCQkJCQlvLmNvbnN0cnVjdG9yLnRvU3RyaW5nKCkuaW5kZXhPZignQXJyYXkoKScpID4gLTEKCQkJCQkJKSB7CgkJCQkJCQlmb3IgKHZhciBwIGluIG8pIHsKCQkJCQkJCQlpZiAocCA9PSAnT1BFUkFUT1JTJyB8fCBwID09ICdPUlMnKSBjb250aW51ZTsKCQkJCQkJCQlzICs9ICc8T2JqZWN0Pic7CgkJCQkJCQkJaWYgKCFpc05hTihwKSkgewoJCQkJCQkJCQkvLyBsaW5lYXIgYXJyYXkKCQkJCQkJCQkJaWYgKG9bcF0gPT0gbnVsbCkgewoJCQkJCQkJCQkJLy8gbnVsbCBlbnRyeSBpbiB0aGUgYXJyYXkKCQkJCQkJCQkJCXMgKz0gJzxJZD4wPC9JZD4nOwoJCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQkJL2Z1bmN0aW9uXHMrKFx3KilccypcKC9naS5leGVjKAoJCQkJCQkJCQkJCW9bcF0uY29uc3RydWN0b3IudG9TdHJpbmcoKQoJCQkJCQkJCQkJKTsKCQkJCQkJCQkJCXZhciB0eXBlID0gUmVnRXhwLiQxOwoJCQkJCQkJCQkJc3dpdGNoICh0eXBlKSB7CgkJCQkJCQkJCQkJY2FzZSAnJzoKCQkJCQkJCQkJCQkJdHlwZSA9IHR5cGVvZiBvW3BdOwoJCQkJCQkJCQkJCWNhc2UgJ1N0cmluZyc6CgkJCQkJCQkJCQkJCXR5cGUgPSAnc3RyaW5nJzsKCQkJCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJCQkJY2FzZSAnTnVtYmVyJzoKCQkJCQkJCQkJCQkJdHlwZSA9ICdpbnQnOwoJCQkJCQkJCQkJCQlicmVhazsKCQkJCQkJCQkJCQljYXNlICdCb29sZWFuJzoKCQkJCQkJCQkJCQkJdHlwZSA9ICdib29sJzsKCQkJCQkJCQkJCQkJYnJlYWs7CgkJCQkJCQkJCQkJY2FzZSAnRGF0ZSc6CgkJCQkJCQkJCQkJCXR5cGUgPSAnRGF0ZVRpbWUnOwoJCQkJCQkJCQkJCQlicmVhazsKCQkJCQkJCQkJCX0KCQkJCQkJCQkJCXMgKz0gdGhpcy5fdG9YTUwob1twXSwgbGV2ZWwrKyk7CgkJCQkJCQkJCX0KCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQkvLyBhc3NvY2lhdGl2ZSBhcnJheQoJCQkJCQkJCQlzICs9CgkJCQkJCQkJCQknPCcgKwoJCQkJCQkJCQkJcCArCgkJCQkJCQkJCQl0aGlzLmNvb3AobywgcCkgKwoJCQkJCQkJCQkJJz4nICsKCQkJCQkJCQkJCXRoaXMuX3RvWE1MKG9bcF0sIGxldmVsKyspICsKCQkJCQkJCQkJCSc8LycgKwoJCQkJCQkJCQkJcCArCgkJCQkJCQkJCQknPic7CgkJCQkJCQkJfQoJCQkJCQkJCXMgKz0gJzwvT2JqZWN0PicgKyB0aGlzLkNSTkw7CgkJCQkJCQl9CgkJCQkJCX0KCQkJCQkJLy8gT2JqZWN0IG9yIGN1c3RvbSBmdW5jdGlvbgoJCQkJCQllbHNlIHsKCQkJCQkJCWlmIChvID09IG51bGwgfHwgby5JZCA9PSAwKSB7fSBlbHNlIGlmIChmYWxzZSAmJiBvLklkKSB7CgkJCQkJCQkJLy8gdGhpcyBpcyBjcmVhdGluZyBhIHByb2JsZW0sIGJldHRlciBzZW5kIGFsbCB0aGUgb2JqZWN0CgkJCQkJCQkJLy8gZG8gbm90IHNlbmQgb3RoZXIgZGF0YSBpZiB3ZSBoYXZlIGEgdmFsdWUgZm9yIHRoZSBJZAoJCQkJCQkJCXMgKz0gJzxJZD4nICsgdGhpcy5fdG9YTUwoby5JZCwgbGV2ZWwrKykgKyAnPC9JZD4nOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQlmb3IgKHZhciBwIGluIG8pIHsKCQkJCQkJCQkJaWYgKHAgPT0gJ09QRVJBVE9SUycgfHwgcCA9PSAnT1JTJykgY29udGludWU7CgkJCQkJCQkJCXMgKz0KCQkJCQkJCQkJCSc8JyArCgkJCQkJCQkJCQlwICsKCQkJCQkJCQkJCXRoaXMuY29vcChvLCBwKSArCgkJCQkJCQkJCQl0aGlzLk9SKG8sIHApICsKCQkJCQkJCQkJCSc+JyArCgkJCQkJCQkJCQl0aGlzLl90b1hNTChvW3BdLCBsZXZlbCsrKSArCgkJCQkJCQkJCQknPC8nICsKCQkJCQkJCQkJCXAgKwoJCQkJCQkJCQkJJz4nOwoJCQkJCQkJCX0KCQkJCQkJCX0KCQkJCQkJfQoJCQkJCQlicmVhazsKCQkJCX0KCQkJCXJldHVybiBzOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChvLCBwKSA9PiB7CgkJCQlpZiAoIW8uT1BFUkFUT1JTIHx8ICFvLk9QRVJBVE9SU1twXSkgewoJCQkJCXJldHVybiAnJzsKCQkJCX0KCQkJCXJldHVybiAoCgkJCQkJIiBjb29wPSciICsKCQkJCQl0aGlzLm15UmVwbGFjZShvLk9QRVJBVE9SU1twXSwgWyc8JywgJz4nXSwgWycmbHQ7JywgJyZndDsnXSkgKwoJCQkJCSInIgoJCQkJKTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKG8sIHApID0+IHsKCQkJCXJldHVybiBvLk9SUyAmJiBvLk9SU1twXSA/CgkJCQkJIiBPUj0nIiArCgkJCQkJdGhpcy5teVJlcGxhY2Uoby5PUlNbcF0sIFsnPCcsICc+J10sIFsnJmx0OycsICcmZ3Q7J10pICsKCQkJCQkiJyIgOgoJCQkJCScnOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHMsIGZjLCByYykgPT4gewoJCQkJaWYgKHR5cGVvZiBzICE9PSAnc3RyaW5nJykgcmV0dXJuIHM7CgoJCQkJdmFyIHJldCA9ICcnOwoJCQkJZm9yICh2YXIgaSA9IDA7IGkgPCBzLmxlbmd0aDsgaSsrKSB7CgkJCQkJdmFyIHJzID0gcy5jaGFyQXQoaSk7CgkJCQkJZm9yICh2YXIgaiA9IDA7IGogPCBmYy5sZW5ndGg7IGorKykgewoJCQkJCQlpZiAocy5jaGFyQXQoaSkgPT0gZmNbal0pIHsKCQkJCQkJCXJzID0gcy5jaGFyQXQoaSkucmVwbGFjZShmY1tqXSwgcmNbal0pOwoJCQkJCQl9CgkJCQkJfQoJCQkJCXJldCArPSByczsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoYXN5bmMgKHVybCwgcG9zdERhdGEsIGNhbGxCYWNrKSA9PiB7CgkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmICF3aW5kb3cuU1IpIHdpbmRvdy5TUiA9IHRoaXM7CgoJCQkJaWYgKCh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93LmpRdWVyeSkgfHwgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YoYXhpb3MpICE9PSAidW5kZWZpbmVkIikpIHsKCQkJCQlsZXQgcmVxdWVzdCA9IGF3YWl0IHRoaXMuY2FjaGVSZXN1bHQobnVsbCwgbnVsbCwgY2FsbEJhY2spOwoJCQkJCWlmIChyZXF1ZXN0KSB7CgkJCQkJCWxldCByZXN1bHQgPSBhd2FpdCB0aGlzLnByb2Nlc3NSZXNwb25zZSgKCQkJCQkJCTQ0LAoJCQkJCQkJY2FsbEJhY2ssCgkJCQkJCQlyZXF1ZXN0LlRleHRSZXNwb25zZSwKCQkJCQkJCXVybAoJCQkJCQkpOwoJCQkJCQlyZXR1cm4gYXdhaXQgdGhpcy5wcm9jZXNzUmVzdWx0KHJlc3VsdCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJLy8ganF1ZXJ5IGNhbGwKCQkJCQkJdmFyIGFqYXggPSB7fTsKCQkJCQkJaWYgKHRoaXMuYlBvc3QgfHwgcG9zdERhdGEubGVuZ3RoID4gKHRoaXMubk1heFVSTExlbmd0aCB8fCAxMDApKSB7CgkJCQkJCQlhamF4LnVybCA9IHVybDsKCQkJCQkJCWFqYXgudHlwZSA9ICdQT1NUJzsKCQkJCQkJCWFqYXguYmVmb3JlU2VuZCA9IChyZXF1ZXN0KSA9PiB7CgkJCQkJCQkJcmVxdWVzdC5zZXRSZXF1ZXN0SGVhZGVyKAoJCQkJCQkJCQknQ29udGVudC1UeXBlJywKCQkJCQkJCQkJJ211bHRpcGFydC9mb3JtLWRhdGE7IGJvdW5kYXJ5PS0tLS0tLS0tLS0tLS0tJwoJCQkJCQkJCSk7CgkJCQkJCQl9OwoJCQkJCQkJYWpheC5kYXRhID0KCQkJCQkJCQknUE9TVERBVEE9XHJcbicgLyorICI8P3htbCB2ZXJzaW9uPVwiMS4wXCIgZW5jb2Rpbmc9XCJ1dGYtOFwiIHN0YW5kYWxvbmU9XCJ5ZXNcIj8+XHJcbiIqLyArCgkJCQkJCQkJcG9zdERhdGE7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQlhamF4LnVybCA9IHVybCArICcmUE9TVENPREU9JyArIHRoaXMudG9IZXgocG9zdERhdGEpOwoJCQkJCQkJYWpheC50eXBlID0gJ0dFVCc7CgkJCQkJCX0KCgkJCQkJCWxldCByZXQgPSBudWxsOwoJCQkJCQlpZiAodHlwZW9mKGpRdWVyeSkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCQlyZXQgPSBhd2FpdCAkLmFqYXgoYWpheCk7CgkJCQkJCX0gZWxzZSBpZiAodHlwZW9mKGF4aW9zKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJCXJldCA9IGF3YWl0IGF4aW9zKGFqYXgpOwoJCQkJCQkJcmV0ID0gcmV0LmRhdGE7CgkJCQkJCX0KCQkJCQkJcmV0ID0gYXdhaXQgdGhpcy5wcm9jZXNzUmVzdWx0KAoJCQkJCQkJdGhpcy5wcm9jZXNzUmVzcG9uc2UoNCwgY2FsbEJhY2ssIHJldCwgdXJsKQoJCQkJCQkpOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJdmFyIHhtbEhUVFAgPSB0aGlzLmdldFhtbEhUVFAoKTsKCQkJCQlpZiAoIXhtbEhUVFApIHJldHVybiBmYWxzZTsKCQkJCQlpZiAoY2FsbEJhY2sgIT0gbnVsbCkgewoJCQkJCQl3aW5kb3cueG1sSFRUUC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKCQkJCQkJCWlmICh3aW5kb3cueG1sSFRUUC5yZWFkeVN0YXRlID09IDQpIHsKCQkJCQkJCQlpZiAoJC53aGVuKSB7CgkJCQkJCQkJCSQud2hlbigKCQkJCQkJCQkJCXdpbmRvdy5TUi5wcm9jZXNzUmVzcG9uc2UoCgkJCQkJCQkJCQkJd2luZG93LnhtbEhUVFAucmVhZHlTdGF0ZSwKCQkJCQkJCQkJCQljYWxsQmFjaywKCQkJCQkJCQkJCQl3aW5kb3cueG1sSFRUUC5yZXNwb25zZVRleHQsCgkJCQkJCQkJCQkJdXJsCgkJCQkJCQkJCQkpCgkJCQkJCQkJCSkudGhlbigocmVzdWx0KSA9PiB3aW5kb3cuU1IucHJvY2Vzc1Jlc3VsdChyZXN1bHQpKTsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQl3aW5kb3cuU1IucHJvY2Vzc1Jlc3VsdCgKCQkJCQkJCQkJCXdpbmRvdy5TUi5wcm9jZXNzUmVzcG9uc2UoCgkJCQkJCQkJCQkJd2luZG93LnhtbEhUVFAucmVhZHlTdGF0ZSwKCQkJCQkJCQkJCQljYWxsQmFjaywKCQkJCQkJCQkJCQl3aW5kb3cueG1sSFRUUC5yZXNwb25zZVRleHQsCgkJCQkJCQkJCQkJdXJsCgkJCQkJCQkJCQkpCgkJCQkJCQkJCSk7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQl9OwoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuYlBvc3QgfHwgcG9zdERhdGEubGVuZ3RoID4gdGhpcy5uTWF4VVJMTGVuZ3RoKSB7CgkJCQkJCXdpbmRvdy54bWxIVFRQLm9wZW4oJ1BPU1QnLCB1cmwsIGNhbGxCYWNrICE9IG51bGwpOwoJCQkJCQl3aW5kb3cueG1sSFRUUC5zZXRSZXF1ZXN0SGVhZGVyKAoJCQkJCQkJJ0NvbnRlbnQtVHlwZScsCgkJCQkJCQknbXVsdGlwYXJ0L2Zvcm0tZGF0YTsgYm91bmRhcnk9LS0tLS0tLS0tLS0tLS0nCgkJCQkJCSk7IC8vIGZvb2wgY3Jvc3MtZG9tYWluIGNoZWNraW5nIGluIGNocm9tZQoJCQkJCQl3aW5kb3cueG1sSFRUUC5zZW5kKAoJCQkJCQkJJ1BPU1REQVRBPVxyXG4nIC8qKyAiPD94bWwgdmVyc2lvbj1cIjEuMFwiIGVuY29kaW5nPVwidXRmLThcIiBzdGFuZGFsb25lPVwieWVzXCI/PlxyXG4iKi8gKwoJCQkJCQkJcG9zdERhdGEKCQkJCQkJKTsKCQkJCQl9IGVsc2UgewoJCQkJCQl4bWxIVFRQLm9wZW4oCgkJCQkJCQknR0VUJywKCQkJCQkJCXVybCArICcmUE9TVENPREU9JyArIHRoaXMudG9IZXgocG9zdERhdGEpLAoJCQkJCQkJY2FsbEJhY2sgIT0gbnVsbAoJCQkJCQkpOwoJCQkJCQl4bWxIVFRQLnNlbmQobnVsbCk7CgkJCQkJfQoKCQkJCQlpZiAoY2FsbEJhY2sgPT0gbnVsbCAmJiB4bWxIVFRQLnJlYWR5U3RhdGUgPT0gNCkgewoJCQkJCQl2YXIgX3VybCA9IHVybCArICcmUE9TVENPREU9JyArIHRoaXMudG9IZXgocG9zdERhdGEpOwoJCQkJCQlpZiAoJC53aGVuKSB7CgkJCQkJCQlyZXR1cm4gJC53aGVuKAoJCQkJCQkJCXRoaXMucHJvY2Vzc1Jlc3BvbnNlKAoJCQkJCQkJCQl4bWxIVFRQLnJlYWR5U3RhdGUsCgkJCQkJCQkJCWNhbGxCYWNrLAoJCQkJCQkJCQl4bWxIVFRQLnJlc3BvbnNlVGV4dCwKCQkJCQkJCQkJX3VybAoJCQkJCQkJCSkKCQkJCQkJCSkudGhlbigocmVzdWx0KSA9PiB7CgkJCQkJCQkJcmV0dXJuIHRoaXMucHJvY2Vzc1Jlc3VsdChyZXN1bHQpOwoJCQkJCQkJfSk7CgkJCQkJCX0gZWxzZSB7CgkJCQkJCQl0aGlzLnByb2Nlc3NSZXN1bHQoCgkJCQkJCQkJdGhpcy5wcm9jZXNzUmVzcG9uc2UoCgkJCQkJCQkJCXhtbEhUVFAucmVhZHlTdGF0ZSwKCQkJCQkJCQkJY2FsbEJhY2ssCgkJCQkJCQkJCXhtbEhUVFAucmVzcG9uc2VUZXh0LAoJCQkJCQkJCQlfdXJsCgkJCQkJCQkJKQoJCQkJCQkJKTsKCQkJCQkJfQoJCQkJCX0KCQkJCX0KCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHJlYWR5U3RhdGUsIGNhbGxCYWNrLCByZXNwb25zZVRleHQsIHVybCkgPT4gewoJCQkJaWYgKFs0LCA0NF0uaW5kZXhPZihyZWFkeVN0YXRlKSA9PSAtMSkgcmV0dXJuOwoKCQkJCXZhciBzTWV0aG9kTmFtZSA9IHRoaXMuJF9SRVFVRVNUKCduYW1lJywgdXJsKTsKCgkJCQl0cnkgewoJCQkJCWlmIChyZWFkeVN0YXRlID09IDQpIHsKCQkJCQkJbGV0IHJlcyA9IChhc3luYyAoKSA9PiB7CgkJCQkJCQlyZXR1cm4gYXdhaXQgdGhpcy5jYWNoZVJlc3VsdChudWxsLCByZXNwb25zZVRleHQpOwoJCQkJCQl9KSgpOwoJCQkJCX0KCgkJCQkJLy9yZXQgPSBudWxsOwoJCQkJCS8vc2VydmVyX3RpbWUgPSBudWxsOwoJCQkJCS8vX2V4Y2VwdGlvbiA9IG51bGw7CgkJCQkJdmFyIGJTY3JpcHRFcnJvciA9IGZhbHNlOwoJCQkJCXZhciBfcmV0ID0gbnVsbDsKCQkJCQl0cnkgewoJCQkJCQlfcmV0ID0gdGhpcy5ydW5TUlNjcmlwdChyZXNwb25zZVRleHQpOwoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIikgdGhyb3cgZTsKCQkJCQkJYlNjcmlwdEVycm9yID0gdHJ1ZTsKCQkJCQl9CgoJCQkJCWlmIChfcmV0ICYmIF9yZXQuc2VydmVyX3RpbWUpIHsKCQkJCQkJbGV0IHRkID0gbmV3IERhdGUoKS5nZXRUaW1lKCkgLSBfcmV0LnNlcnZlcl90aW1lLmdldFRpbWUoKTsKCgkJCQkJCXRyeSB7CgkJCQkJCQl3aW5kb3cudGltZURpZmZlcmVuY2UgPSB0ZDsKCQkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJCWdsb2JhbC50aW1lRGlmZmVyZW5jZSA9IHRkOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAoX3JldCAmJiBfcmV0Ll9leGNlcHRpb24pIHsKCQkJCQkJdGhpcy5TaG93RGVidWcoX2V4Y2VwdGlvbi5NZXNzYWdlKTsKCQkJCQl9CgoJCQkJCWlmIChjYWxsQmFjayAhPSBudWxsKSB7CgkJCQkJCXZhciBjYWxsUmV0ID0gbnVsbDsKCQkJCQkJdHJ5IHsKCQkJCQkJCWNhbGxSZXQgPSBjYWxsQmFjayhfcmV0LnJldCwgX3JldC5fZXhjZXB0aW9uKTsKCQkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQkJdGhpcy5TaG93RXJyb3IoCgkJCQkJCQkJJ0Vycm9yIGluIENhbGxiYWNrOlxuXG4nICsgY2FsbEJhY2sgKyAnXG5cbicgKyBlLm1lc3NhZ2UKCQkJCQkJCSk7CgkJCQkJCX0KCQkJCQkJaWYgKAoJCQkJCQkJdHlwZW9mIF9yZXQubWV0aG9kX25hbWUgIT09ICd1bmRlZmluZWQnICYmCgkJCQkJCQl0eXBlb2Ygc01ldGhvZE5hbWUgIT09ICd1bmRlZmluZWQnICYmCgkJCQkJCQlzTWV0aG9kTmFtZSAhPSBfcmV0Lm1ldGhvZF9uYW1lCgkJCQkJCSkgewoJCQkJCQkJdGhpcy5TaG93RXJyb3IoCgkJCQkJCQkJJ01pc21hdGNoIGluIE1ldGhvZCBiZXR3ZWVuIHNlcnZlciBhbmQgY2xpZW50OlxuU2VydmVyIE1ldGhvZCBOYW1lOiAnICsKCQkJCQkJCQlfcmV0Lm1ldGhvZF9uYW1lICsKCQkJCQkJCQknXG5DbGllbnQgTWV0aG9kIE5hbWU6ICcgKwoJCQkJCQkJCXNNZXRob2ROYW1lCgkJCQkJCQkpOwoJCQkJCQl9CgkJCQkJCSgKCQkJCQkJCXRoaXMuZkxvYWRpbmdFbmQgfHwKCQkJCQkJCWZ1bmN0aW9uKCkgewoJCQkJCQkJCXdpbmRvdy5zci5yZXNldEN1cnNvcigpOwoJCQkJCQkJfQoJCQkJCQkpKCk7CgoJCQkJCQlyZXR1cm4gKAoJCQkJCQkJY2FsbFJldCB8fCBfcmV0LnJldCB8fCAoYlNjcmlwdEVycm9yID8gcmVzcG9uc2VUZXh0IDogbnVsbCkKCQkJCQkJKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiKSB0aGlzLnJlc2V0Q3Vyc29yKCk7CgkJCQkJCXJldHVybiAoX3JldCA/IF9yZXQucmV0IDogbnVsbCkgfHwgKGJTY3JpcHRFcnJvciA/IHJlc3BvbnNlVGV4dCA6IG51bGwpOwoJCQkJCX0KCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXRocm93IGU7CgkJCQkJfQoJCQkJCXRoaXMucmVzZXRDdXJzb3IoKTsKCQkJCQl0aGlzLlNob3dFcnJvcignRXJyb3IgaW4gY29kZTogJyArIGUubWVzc2FnZSArICdcbicgKyByZXNwb25zZVRleHQpOwoJCQkJfQoKCQkJCXJldHVybiBudWxsOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKGFzeW5jIChyZXMpID0+IHsKCQkJCWlmICghcmVzIHx8ICFyZXMuQ29kZSB8fCAhcmVzLlN0b3JlZE1ldGhvZCkgewoJCQkJCXRoaXMuQWN0aXZlUmVxdWVzdCA9IG51bGw7CgkJCQkJcmV0dXJuIHJlczsKCQkJCX0KCgkJCQkvLyBmb3Igc3VyZSBhIG1ldGhvZCByZXN1bHQgZnJvbSBhbiBhc3luYyBjYWxsCgkJCQlpZiAocmVzLlJlc3VsdCkgewoJCQkJCS8vIHdlIGdvdCBhIHJlc3VsdAoJCQkJCXZhciBfX3JldCA9IG51bGw7CgkJCQkJdHJ5IHsKCQkJCQkJX19yZXQgPSB0aGlzLnByb2Nlc3NSZXNwb25zZSg0LCBudWxsLCByZXMuUmVzdWx0LCBudWxsKTsKCQkJCQl9IGNhdGNoIChlKSB7CgkJCQkJCV9fcmV0ID0gcmVzLlJlc3VsdDsKCQkJCQl9CgkJCQkJdGhpcy5BY3RpdmVSZXF1ZXN0ID0gbnVsbDsKCQkJCQlyZXR1cm4gX19yZXQ7CgkJCQl9CgoJCQkJdmFyIHRpbWVvdXQgPSByZXMuUnVuQWZ0ZXIgLSByZXMuRGF0ZTsKCQkJCWlmICh0aW1lb3V0IDw9IDApIHsKCQkJCQkvLyBuZWdhdGl2ZSB0aW1lb3V0IG1lYW5zIHRoYXQgaXQgd2FzIHN1cHBvc2VkIHRvIGJlIHJ1biBidXQgZGlkIG5vdCBmb3Igc29tZSByZWFzb24gKGRlbGF5LCBmYWlsdXJlLCBldGMuLi4pCgkJCQkJLy8gc2FtZSBkYXRlIGFzIHJ1bmFmdGVyIG1lYW5zIHRoYXQgd2UgYXJlIHVzaW5nIHRoZSBpbW1lZGlhdGUgYXN5bmMgZXhlY3V0aW9uLiBpLmUuIHRoZXJlIGlzIG5vIG5lZWQgZm9yIHRoZSBydW5uZXIgdGhyZWFkIHRhc2sKCQkJCQl0aW1lb3V0ID0gMzAwMDA7CgkJCQl9IGVsc2UgaWYgKHRpbWVvdXQgPiA1ICogNjAgKiAxMDAwKSB7CgkJCQkJLy8gbW9yZSB0aGFuIHdlIGNhbiB3YWl0LCB3ZSByZXR1cm4gYSByZWZlcmVuY2UgdG8gdGhlIHJlc3VsdAoJCQkJCWNvbnNvbGUubG9nKAoJCQkJCQknV2UgY2Fubm90IHdhaXQgJyArCgkJCQkJCU1hdGguZmxvb3IodGltZW91dCAvIDEwMDApICsKCQkJCQkJJyBzZWNvbmRzLiBSZXR1cm5pbmcgcmVzdWx0LicKCQkJCQkpOwoJCQkJCXJldHVybiByZXM7CgkJCQl9CgkJCQljb25zb2xlLmxvZygKCQkJCQknTWFraW5nIHRoZSBuZXh0IGNhbGwgaW4gJyArCgkJCQkJTWF0aC5mbG9vcih0aW1lb3V0IC8gMTAwMCkgKwoJCQkJCScgc2Vjb25kcy4nCgkJCQkpOwoKCQkJCWF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIHRpbWVvdXQpKTsKCQkJCWlmICghdGhpcy5BY3RpdmVSZXF1ZXN0KSB7CgkJCQkJY29uc29sZS5sb2coJ05vIEFjdGl2ZVJlcXVlc3QsIGV4aXRpbmcuLi4nKTsKCQkJCQlyZXR1cm4gbnVsbDsKCQkJCX0KCQkJCXRyeSB7CgkJCQkJbGV0IHJldCA9IGF3YWl0ICQuYWpheCh7CgkJCQkJCXVybDogJy9tZXRob2QvYS5hc2h4P25hbWU9Q29udGVudE1hbmFnZXIuY21zTWV0aG9kUmVzdWx0RmluZCZwMD17Q29kZX0nICsKCQkJCQkJCXJlcy5Db2RlICsKCQkJCQkJCSd7L0NvZGV9e0lkfScgKwoJCQkJCQkJcmVzLklkICsKCQkJCQkJCSd7L0lkfSZyYW5kPScgKwoJCQkJCQkJTWF0aC5yYW5kb20oKSwKCQkJCQl9KTsKCQkJCQlyZXQgPSB0aGlzLnByb2Nlc3NSZXNwb25zZSg0LCBudWxsLCByZXQsIHRoaXMuQWN0aXZlUmVxdWVzdC5VUkwpOwoJCQkJCXJldCA9IGF3YWl0IHRoaXMucHJvY2Vzc1Jlc3VsdChyZXQpOwoJCQkJCXJldHVybiByZXQ7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKCdwcm9jZXNzUmVzdWx0JywgZXgpOwoJCQkJCXJldHVybiBhd2FpdCB0aGlzLl8oJ0NvbnRlbnRNYW5hZ2VyLmNtc01ldGhvZFJlc3VsdEZpbmQnLCBudWxsLCB7CgkJCQkJCUNvZGU6IHJlcy5Db2RlLAoJCQkJCQlJZDogcmVzLklkLAoJCQkJCX0pOwoJCQkJfQoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoZCkgPT4gewoJCQkJbGV0IHRkID0gMDsKCQkJCXRyeSB7CgkJCQkJdGQgPSB3aW5kb3cudGltZURpZmZlcmVuY2U7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCXRkID0gZ2xvYmFsLnRpbWVEaWZmZXJlbmNlOwoJCQkJfQoJCQkJcmV0dXJuIHRoaXMuYWRkTVNlY29uZHMoZCB8fCBuZXcgRGF0ZSgpLCAtdGQpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgobywgbXMpID0+IHsKCQkJCXJldHVybiBuZXcgRGF0ZShvLmdldFRpbWUoKSArIG1zKTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChzKSA9PiB7CgkJCQlpZiAoIXMpIHJldHVybiBudWxsOwoKCQkJCWxldCBjTGluZXMgPSBzLnNwbGl0KCdcbicpOwoJCQkJdHJ5IHsKCQkJCQlpZiAodHlwZW9mKGVzcHJpbWEpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQllc3ByaW1hLnBhcnNlKHMsIHsKCQkJCQkJCWVzNjogdHJ1ZQoJCQkJCQl9KTsKCQkJCQl9CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWlmIChjTGluZXNbZXgubGluZU51bWJlciAtIDFdLmluZGV4T2YoJ2ZvciBhd2FpdCcpIDwgMCkgewoJCQkJCQljb25zb2xlLmxvZygicnVuU2NyaXB0KCkgIiArIGV4LmRlc2NyaXB0aW9uLCBleC5saW5lTnVtYmVyLCBjTGluZXNbZXgubGluZU51bWJlciAtIDFdKTsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCQkJCX0KCgkJCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJdHJ5IHsKCQkJCQkJaWYgKHdpbmRvdy5fY29udGVudCAmJiB3aW5kb3cuX2NvbnRlbnQuZXZhbCkgewoJCQkJCQkJdmFyIG91dHB1dCA9IHdpbmRvdy5fY29udGVudC5ldmFsKHMpOwoJCQkJCQkJcmV0dXJuIG91dHB1dDsKCQkJCQkJfQoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJdGhpcy5TaG93RXJyb3IoJ0ZGIFNDUklQVDogXG4nICsgZS5tZXNzYWdlICsgJ1xuJyArIHMpOwoJCQkJCX0KCQkJCQl0cnkgewoJCQkJCQlpZiAod2luZG93LmV4ZWNTY3JpcHQpIHsKCQkJCQkJCWlmIChzLmluZGV4T2YoJ1xyXG4nKSA+IDApIHsKCQkJCQkJCQkvLyBhIG11bHRpLWxpbmUgc3RhdGVtZW50CgkJCQkJCQkJd2luZG93LmV4ZWNTY3JpcHQocyk7CgkJCQkJCQkJcmV0dXJuIG51bGw7CgkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCS8vIGEgc2luZ2xlLWxpbmUgc3RhdGVtZW50CgkJCQkJCQkJbmV3ViA9IG51bGw7CgkJCQkJCQkJdmFyIG5ld1MgPSAnbmV3ViA9ICcgKyBzOwoJCQkJCQkJCXdpbmRvdy5leGVjU2NyaXB0KG5ld1MpOwoJCQkJCQkJCXJldHVybiBuZXdWOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQl0aGlzLlNob3dFcnJvcignSUU2IFNDUklQVDogXG4nICsgZS5tZXNzYWdlICsgJ1xuJyArIHMpOwoJCQkJCX0KCgkJCQkJdHJ5IHsKCQkJCQkJaWYgKHdpbmRvdy5leGVjU2NyaXB0KSB7CgkJCQkJCQlpZiAocy5pbmRleE9mKCdcclxuJykgPiAwKSB7CgkJCQkJCQkJLy8gYSBtdWx0aS1saW5lIHN0YXRlbWVudAoJCQkJCQkJCXdpbmRvdy5leGVjU2NyaXB0KHMpOwoJCQkJCQkJCXJldHVybiBudWxsOwoJCQkJCQkJfSBlbHNlIHsKCQkJCQkJCQkvLyBhIHNpbmdsZS1saW5lIHN0YXRlbWVudAoJCQkJCQkJCW5ld1YgPSBudWxsOwoJCQkJCQkJCXZhciBuZXdTID0gJ25ld1YgPSAnICsgczsKCQkJCQkJCQlldmFsKG5ld1MpOwoJCQkJCQkJCXJldHVybiBuZXdWOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfSBjYXRjaCAoZSkgewoJCQkJCQl0aGlzLlNob3dFcnJvcignSUU3IFNDUklQVDogXG4nICsgZS5tZXNzYWdlICsgJ1xuJyArIHMpOwoJCQkJCX0KCgkJCQkJdHJ5IHsKCQkJCQkJdmFyIGZuID0gZnVuY3Rpb24oKSB7CgkJCQkJCQl2YXIgcmV0ID0gd2luZG93LmV2YWwuY2FsbCh3aW5kb3csIHMpOwoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfTsKCgkJCQkJCXJldHVybiBmbigpOwoJCQkJCX0gY2F0Y2ggKGUpIHsKCQkJCQkJdGhpcy5TaG93RXJyb3IoJ1RBRyBTQ1JJUFQ6IFxuJyArIGUubWVzc2FnZSArICdcbicgKyBzKTsKCQkJCQl9CgkJCQl9CgoJCQkJdHJ5IHsKCQkJCQlzID0gcy5yZXBsYWNlKC9uZXcgRGF0ZVwoMDAwMS9nLCAnbmV3IERhdGUoMScpOwoJCQkJCXJldHVybiBldmFsKHMpOwoJCQkJfSBjYXRjaCAoZSkgewoJCQkJCXRoaXMuU2hvd0Vycm9yKCdFVkFMIFNDUklQVDogXG4nICsgZS5tZXNzYWdlICsgJ1xuJyArIHMpOwoJCQkJfQoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChzKSA9PiB7CgkJCQlyZXR1cm4gdGhpcy5ydW5TY3JpcHQoCgkJCQkJJygoKSA9PiB7IHZhciByZXQgPSBudWxsOyAnICsKCQkJCQlzICsKCQkJCQknIGlmKHR5cGVvZih3aW5kb3cpIT09InVuZGVmaW5lZCIpe3dpbmRvdy5tZXRob2RfbmFtZSA9IG1ldGhvZF9uYW1lOyB3aW5kb3cuc2VydmVyX3RpbWUgPSBzZXJ2ZXJfdGltZTsgd2luZG93Ll9leGNlcHRpb24gPSB0eXBlb2YoX2V4Y2VwdGlvbik9PT0idW5kZWZpbmVkIj9udWxsOl9leGNlcHRpb247IHdpbmRvdy5leGVjdXRpb25fdGltZSA9IGV4ZWN1dGlvbl90aW1lO30gcmV0dXJuIHtfZXhjZXB0aW9uOiB0eXBlb2YoX2V4Y2VwdGlvbik9PT0idW5kZWZpbmVkIj9udWxsOl9leGNlcHRpb24sIG1ldGhvZF9uYW1lOiBtZXRob2RfbmFtZSwgc2VydmVyX3RpbWU6IHNlcnZlcl90aW1lLCBleGVjdXRpb25fdGltZTogZXhlY3V0aW9uX3RpbWUsIHJldDogcmV0fTt9KSgpOycKCQkJCSk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgocykgPT4gewoJCQkJdmFyIGhhc2ggPSAwLAoJCQkJCWksCgkJCQkJY2hyLAoJCQkJCWxlbjsKCQkJCWlmIChzLmxlbmd0aCA9PSAwKSByZXR1cm4gaGFzaDsKCQkJCWZvciAoaSA9IDAsIGxlbiA9IHMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsKCQkJCQljaHIgPSBzLmNoYXJDb2RlQXQoaSk7CgkJCQkJaGFzaCA9IChoYXNoIDw8IDUpIC0gaGFzaCArIGNocjsKCQkJCQloYXNoIHw9IDA7IC8vIENvbnZlcnQgdG8gMzJiaXQgaW50ZWdlcgoJCQkJfQoJCQkJcmV0dXJuIGhhc2g7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoYXIsIGZpZWxkKSA9PiB7CgkJCQlpZiAoIWFyIHx8ICFmaWVsZCkgcmV0dXJuIG51bGw7CgoJCQkJdmFyIGtleXMgPSBbXTsKCQkJCWFyLmZvckVhY2goYSA9PiB7CgkJCQkJdmFyIGtleSA9IG51bGw7CgkJCQkJZmllbGQuc3BsaXQoJy4nKS5mb3JFYWNoKGYgPT4ga2V5ID0gKGtleSB8fCBhKVtmXSk7CgkJCQkJbGV0IGsgPSBrZXlzLmZpbmQoayA9PiB0aGlzLkVxdWFscyhrLmtleSwga2V5KSk7CgkJCQkJaWYgKGspIHsKCQkJCQkJay52YWx1ZXMucHVzaChhKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlrZXlzLnB1c2goewoJCQkJCQkJa2V5OiBrZXksCgkJCQkJCQl2YWx1ZXM6IFthXSwKCQkJCQkJfSk7CgkJCQkJfQoJCQkJfSk7CgkJCQlyZXR1cm4ga2V5czsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHMsIGJJZ25vcmVEZWJ1ZykgPT4gewoJCQkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIikgewoJCQkJCWNvbnNvbGUubG9nKCJTaG93RGVidWc6ICIgKyBzKTsKCQkJCX0KCQkJCWlmICh0aGlzLmJEZWJ1ZyB8fCBiSWdub3JlRGVidWcpIHRoaXMuU2hvd01lc3NhZ2Uocyk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoYXN5bmMgKHJlcXVlc3QsIHRleHRyZXNwb25zZSkgPT4gewoJCQkJaWYgKCF0aGlzLmJDYWNoZVJlc3VsdCkgcmV0dXJuOwoJCQkJcmVxdWVzdCA9IHJlcXVlc3QgfHwgdGhpcy5BY3RpdmVSZXF1ZXN0OwoKCQkJCWlmICghcmVxdWVzdCkgewoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJdGV4dHJlc3BvbnNlICYmCgkJCQkJdGV4dHJlc3BvbnNlLmluZGV4T2YoJ3JldC5Db2RlID0gJykgPiAtMSAmJgoJCQkJCXRleHRyZXNwb25zZS5pbmRleE9mKCdyZXQuUnVuQWZ0ZXIgPSAnKSA+IC0xICYmCgkJCQkJdGV4dHJlc3BvbnNlLmluZGV4T2YoJ3JldC5SZXN1bHQgPSAiIicpID4gLTEKCQkJCSkgewoJCQkJCWNvbnNvbGUubG9nKCd0ZXh0cmVzcG9uc2UgY29udGlhbnMgaW5jb21wbGV0ZSBtZXRob2QgcmVzdWx0Jyk7CgkJCQkJcmV0dXJuIG51bGw7CgkJCQl9CgoJCQkJdmFyIHNNZXRob2QgPSB0aGlzLiRfUkVRVUVTVCgnbmFtZScsIHJlcXVlc3QuVVJMKTsKCQkJCXNNZXRob2QgPSBzTWV0aG9kLnN1YnN0cmluZyhzTWV0aG9kLmxhc3RJbmRleE9mKCcuJykgKyAxKTsKCQkJCXRyeSB7CgkJCQkJdmFyIF91c2FibGUgPSAocikgPT4gewoJCQkJCQl2YXIgaXRlbSA9CgkJCQkJCQkociAmJgoJCQkJCQkJCXIuaGFzaCA9PSByZXF1ZXN0Lmhhc2ggJiYKCQkJCQkJCQkoci5VUkwgPT0gcmVxdWVzdC5VUkwgfHwgdGhpcy4kX1JFUVVFU1QoJ25hbWUnLCByLlVSTCkgPT0gc01ldGhvZCkgJiYKCQkJCQkJCQlyLlRleHRSZXNwb25zZSAmJgoJCQkJCQkJCSh0eXBlb2Ygci5FeHBpcmVzID09PSAndW5kZWZpbmVkJyB8fAoJCQkJCQkJCQluZXcgRGF0ZShyLkV4cGlyZXMpID4gbmV3IERhdGUoKSkpID8KCQkJCQkJCXIgOgoJCQkJCQkJbnVsbDsKCQkJCQkJaWYgKHRleHRyZXNwb25zZSkgewoJCQkJCQkJaXRlbSA9IGl0ZW0gfHwgcmVxdWVzdDsKCQkJCQkJCWl0ZW0uVGV4dFJlc3BvbnNlID0gdGV4dHJlc3BvbnNlOwoJCQkJCQkJaXRlbS5FeHBpcmVzID0gbmV3IERhdGUoCgkJCQkJCQkJbmV3IERhdGUoKS5nZXRUaW1lKCkgKwoJCQkJCQkJCXBhcnNlRmxvYXQoCgkJCQkJCQkJCXRoaXMubkNhY2hlRXhwaXJlSG91cnMgfHwgdGhpcy4kX1JFUVVFU1QoJ25DYWNoZUV4cGlyZUhvdXJzJykgfHwgMQoJCQkJCQkJCSkgKgoJCQkJCQkJCTYwICoKCQkJCQkJCQk2MCAqCgkJCQkJCQkJMTAwMAoJCQkJCQkJKTsKCQkJCQkJfQoKCQkJCQkJcmV0dXJuIGl0ZW07CgkJCQkJfTsKCgkJCQkJaWYgKAoJCQkJCQl0aGlzLmJDYWNoZVJlc3VsdCA9PSAna3ZzdG9yZScgJiYKCQkJCQkJdHlwZW9mIHdpbmRvdy5jb21wYW55LnJlc3Rpb2RiU2V0dGluZ3MgIT09ICd1bmRlZmluZWQnCgkJCQkJKSB7CgkJCQkJCXZhciBhamF4ID0gKGtleSwgdmFsdWUsIGlkKSA9PiB7CgkJCQkJCQl2YXIgcmV0ID0gY29tcGFueS5yZXN0aW9kYlNldHRpbmdzKCk7CgkJCQkJCQlyZXQudXJsICs9ICdrdnN0b3JlJzsKCQkJCQkJCWlmICh2YWx1ZSkgewoJCQkJCQkJCWlmIChpZCkgewoJCQkJCQkJCQkvLyB1cGRhdGUgcmVjb3JkCgkJCQkJCQkJCXJldC51cmwgKz0gJy8nICsgaWQ7CgkJCQkJCQkJCXJldC5tZXRob2QgPSAnUFVUJzsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQkvLyBuZXcgcmVjb3JkCgkJCQkJCQkJCXJldC5tZXRob2QgPSAnUE9TVCc7CgkJCQkJCQkJfQoJCQkJCQkJCXJldC5kYXRhID0gSlNPTi5zdHJpbmdpZnkoewoJCQkJCQkJCQlrZXk6IGtleSwKCQkJCQkJCQkJdmFsdWU6IEpTT04uc3RyaW5naWZ5KHZhbHVlLCBudWxsLCA0KSwKCQkJCQkJCQl9KTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJaWYgKGlkKSB7CgkJCQkJCQkJCS8vIGRlbGV0ZSByZWNvcmQKCQkJCQkJCQkJcmV0LnVybCArPSAnLycgKyBpZDsKCQkJCQkJCQkJcmV0Lm1ldGhvZCA9ICdERUxFVEUnOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCXJldC5tZXRob2QgPSAnR0VUJzsKCQkJCQkJCQkJcmV0LnVybCArPSAnP3E9eyJrZXkiOicgKyBrZXkgKyAnfSc7CgkJCQkJCQkJfQoJCQkJCQkJfQoJCQkJCQkJLy9jb25zb2xlLmxvZygnbWV0aG9kJywgcmV0Lm1ldGhvZCk7CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9OwoKCQkJCQkJbGV0IHJlY29yZCA9IGF3YWl0ICQuYWpheChhamF4KHJlcXVlc3QuaGFzaCkpOwoJCQkJCQlsZXQgciA9CgkJCQkJCQlyZWNvcmQgJiYgcmVjb3JkLmxlbmd0aCA/CgkJCQkJCQlKU09OLnBhcnNlKHJlY29yZFswXS52YWx1ZSkgOgoJCQkJCQkJbnVsbDsKCQkJCQkJbGV0IGl0ZW0gPSBfdXNhYmxlKHIpOwoKCQkJCQkJaWYgKCFpdGVtKSB7CgkJCQkJCQlpZiAocikgewoJCQkJCQkJCWF3YWl0ICQuYWpheChhamF4KHJlcXVlc3QuaGFzaCwgbnVsbCwgcmVjb3JkWzBdLl9pZCkpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIG51bGw7CgkJCQkJCX0KCgkJCQkJCWlmICghciB8fCBpdGVtLkV4cGlyZXMgPiByLkV4cGlyZXMpIHsKCQkJCQkJCWF3YWl0ICQuYWpheCgKCQkJCQkJCQlhamF4KGl0ZW0uaGFzaCwgaXRlbSwgciA/IHJlY29yZFswXS5faWQgOiBudWxsKQoJCQkJCQkJKTsKCQkJCQkJCXJldHVybiBpdGVtOwoJCQkJCQl9CgoJCQkJCQlyZXR1cm4gaXRlbTsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuYkNhY2hlUmVzdWx0ID09ICdzcicpIHsKCQkJCQkJdmFyIGFqYXggPSAoa2V5LCB2YWx1ZSwgaWQpID0+IHsKCQkJCQkJCXZhciBtZXRob2QgPSAnRmluZCc7CgkJCQkJCQl2YXIgcmV0ID0gewoJCQkJCQkJCXVybDogJy9tZXRob2QvYS5hc2h4P25hbWU9Q29udGVudE1hbmFnZXIuY21zTWV0aG9kUmVzdWx0JywKCQkJCQkJCQlwcm9jZXNzRGF0YTogZmFsc2UsCgkJCQkJCQkJdHlwZTogJ1BPU1QnLAoJCQkJCQkJfTsKCQkJCQkJCWlmICh2YWx1ZSkgewoJCQkJCQkJCWlmIChpZCkgewoJCQkJCQkJCQkvLyB1cGRhdGUgcmVjb3JkCgkJCQkJCQkJCW1ldGhvZCA9ICdVcGRhdGUnOwoJCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJCS8vIG5ldyByZWNvcmQKCQkJCQkJCQkJbWV0aG9kID0gJ0luc2VydCc7CgkJCQkJCQkJfQoJCQkJCQkJCXJldC5iZWZvcmVTZW5kID0gKHJlcXVlc3QpID0+IHsKCQkJCQkJCQkJcmVxdWVzdC5zZXRSZXF1ZXN0SGVhZGVyKAoJCQkJCQkJCQkJJ0NvbnRlbnQtVHlwZScsCgkJCQkJCQkJCQknbXVsdGlwYXJ0L2Zvcm0tZGF0YTsgYm91bmRhcnk9LS0tLS0tLS0tLS0tLS0nCgkJCQkJCQkJCSk7CgkJCQkJCQkJfTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJcmV0LnR5cGUgPSAnR0VUJzsKCQkJCQkJCQlpZiAoaWQpIHsKCQkJCQkJCQkJLy8gZGVsZXRlIHJlY29yZAoJCQkJCQkJCQltZXRob2QgPSAnRGVsZXRlJzsKCQkJCQkJCQl9IGVsc2UgewoJCQkJCQkJCQkvLyBnZXQgcmVjb3JkCgkJCQkJCQkJCW1ldGhvZCA9ICdGaW5kJzsKCQkJCQkJCQl9CgkJCQkJCQkJbWV0aG9kICs9CgkJCQkJCQkJCScmcDA9e0NvZGV9JyArCgkJCQkJCQkJCShjb21wYW55ID8gY29tcGFueS5Db2RlICsgJy0nIDogJycpICsKCQkJCQkJCQkJa2V5ICsKCQkJCQkJCQkJJ3svQ29kZX0nOwoJCQkJCQkJfQoJCQkJCQkJcmV0LnVybCArPSBtZXRob2Q7CgkJCQkJCQlpZiAocmV0LnR5cGUgIT0gJ0dFVCcpIHsKCQkJCQkJCQlkZWxldGUgaXRlbS5Qb3N0RGF0YTsgLy8gYmVjYXVzZSB3ZSBoYXZlIHRoZSBjYWNoZSBrZXkKCQkJCQkJCQl2YXIgcDAgPSB7CgkJCQkJCQkJCUNvZGU6IChjb21wYW55ID8gY29tcGFueS5Db2RlICsgJy0nIDogJycpICsga2V5LAoJCQkJCQkJCQlDb21wbGV0ZWQ6IG5ldyBEYXRlKCksCgkJCQkJCQkJCURhdGU6IHRoaXMuQWN0aXZlUmVxdWVzdCA/CgkJCQkJCQkJCQl0aGlzLkFjdGl2ZVJlcXVlc3QuRGF0ZSA6IG5ldyBEYXRlKCksCgkJCQkJCQkJCVJlc3VsdDogYnRvYSh1bmVzY2FwZShlbmNvZGVVUklDb21wb25lbnQoSlNPTi5zdHJpbmdpZnkoaXRlbSkpKSksIC8vaXRlbS5UZXh0UmVzcG9uc2UsCgkJCQkJCQkJCVN0b3JlZE1ldGhvZDogewoJCQkJCQkJCQkJTmFtZTogc01ldGhvZCwKCQkJCQkJCQkJfSwKCQkJCQkJCQl9OwoJCQkJCQkJCWlmIChpZCkgewoJCQkJCQkJCQlwMC5JZCA9IGlkOwoJCQkJCQkJCX0KCQkJCQkJCQlyZXQuZGF0YSA9CgkJCQkJCQkJCSdQT1NUREFUQT1cclxuJyAvKisgIjw/eG1sIHZlcnNpb249XCIxLjBcIiBlbmNvZGluZz1cInV0Zi04XCIgc3RhbmRhbG9uZT1cInllc1wiPz5cclxuIiovICsKCQkJCQkJCQkJdGhpcy5wYXJhbShbcDBdKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX07CgoJCQkJCQlsZXQgcmVjb3JkID0gdGhpcy5ydW5TY3JpcHQgLypydW5TUlNjcmlwdCovKAoJCQkJCQkJJygoKSA9PiB7IHZhciByZXQgPSBudWxsOyAnICsKCQkJCQkJCShhd2FpdCAkLmFqYXgoYWpheChyZXF1ZXN0Lmhhc2gpKSkgKwoJCQkJCQkJJ3JldHVybiByZXQ7fSkoKTsnCgkJCQkJCSk7CgkJCQkJCWxldCByID0gcmVjb3JkID8gSlNPTi5wYXJzZShyZWNvcmQuUmVzdWx0KSA6IG51bGw7CgkJCQkJCWxldCBpdGVtID0gX3VzYWJsZShyKTsKCgkJCQkJCWlmICghaXRlbSkgewoJCQkJCQkJaWYgKHIpIHsKCQkJCQkJCQl0cnkgewoJCQkJCQkJCQlhd2FpdCAkLmFqYXgoYWpheChyZXF1ZXN0Lmhhc2gsIG51bGwsIHJlY29yZC5JZCkpOwoJCQkJCQkJCX0gY2F0Y2ggKGV4KSB7fQoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIG51bGw7CgkJCQkJCX0KCgkJCQkJCWlmICghciB8fCBpdGVtLkV4cGlyZXMgPiByLkV4cGlyZXMpIHsKCQkJCQkJCWF3YWl0ICQuYWpheCgKCQkJCQkJCQlhamF4KGl0ZW0uaGFzaCwgaXRlbSwgciAmJiByZWNvcmQgPyByZWNvcmQuSWQgOiBudWxsKQoJCQkJCQkJKTsKCQkJCQkJCXJldHVybiBpdGVtOwoJCQkJCQl9CgoJCQkJCQlyZXR1cm4gaXRlbTsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuYkNhY2hlUmVzdWx0ID09ICdnaXRodWInKSB7CgkJCQkJCWlmIChyZXF1ZXN0LlVSTC5pbmRleE9mKCdjbXNNZXRob2RSZXN1bHQnKSA+PSAwKSByZXR1cm4gbnVsbDsKCQkJCQkJbGV0IHJlcyA9IG51bGw7CgkJCQkJCXRyeSB7CgkJCQkJCQlyZXMgPSBhd2FpdCAkLmFqYXgoewoJCQkJCQkJCXVybDogJ2h0dHBzOi8vYXJ6aG9zcGl0YWwuZ2l0aHViLmlvLycgKwoJCQkJCQkJCQljb21wYW55LlN0b3JlICsKCQkJCQkJCQkJJy8nICsKCQkJCQkJCQkJcmVxdWVzdC5oYXNoICsKCQkJCQkJCQkJJy5qcycsCgkJCQkJCQkJZGF0YVR5cGU6ICdqc29ucCcsCgkJCQkJCQkJcHJvY2Vzc1Jlc3VsdDogZmFsc2UsCgkJCQkJCQl9KTsKCQkJCQkJCXJldHVybiB7CgkJCQkJCQkJVGV4dFJlc3BvbnNlOiByZXMsCgkJCQkJCQl9OwoJCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQkJY29uc29sZS5sb2coJ0VSUk9SUzonLCBleCk7CgkJCQkJCQlyZXR1cm4gbnVsbDsKCQkJCQkJfQoJCQkJCX0gZWxzZSBpZiAodGhpcy5iQ2FjaGVSZXN1bHQgPT0gJ2xvY2FsJykgewoJCQkJCQl2YXIgc3JDYWNoZSA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKCdzckNhY2hlJyk7CgkJCQkJCWlmIChzckNhY2hlID09IG51bGwpIHsKCQkJCQkJCXNyQ2FjaGUgPSB7CgkJCQkJCQkJUmVxdWVzdHM6IHt9LAoJCQkJCQkJfTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCXNyQ2FjaGUgPSBKU09OLnBhcnNlKHNyQ2FjaGUpOwoJCQkJCQl9CgoJCQkJCQl2YXIgciA9IHNyQ2FjaGUuUmVxdWVzdHNbcmVxdWVzdC5oYXNoXTsKCQkJCQkJdmFyIGl0ZW0gPSBfdXNhYmxlKHIpOwoKCQkJCQkJaWYgKCFpdGVtKSB7CgkJCQkJCQlkZWxldGUgc3JDYWNoZS5SZXF1ZXN0c1tyZXF1ZXN0Lmhhc2hdOwoJCQkJCQkJbG9jYWxTdG9yYWdlLnNldEl0ZW0oJ3NyQ2FjaGUnLCBKU09OLnN0cmluZ2lmeShzckNhY2hlKSk7CgkJCQkJCQlyZXR1cm4gbnVsbDsKCQkJCQkJfQoKCQkJCQkJaWYgKCFyIHx8IGl0ZW0uRXhwaXJlcyA+IHIuRXhwaXJlcykgewoJCQkJCQkJc3JDYWNoZS5SZXF1ZXN0c1tpdGVtLmhhc2hdID0gaXRlbTsKCQkJCQkJCWxvY2FsU3RvcmFnZS5zZXRJdGVtKCdzckNhY2hlJywgSlNPTi5zdHJpbmdpZnkoc3JDYWNoZSkpOwoJCQkJCQkJcmV0dXJuIGl0ZW07CgkJCQkJCX0KCgkJCQkJCXJldHVybiBpdGVtOwoJCQkJCX0KCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJY29uc29sZS5sb2coZXgpOwoJCQkJCXRocm93IGV4OwoJCQkJfQoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHMpID0+IHsKCQkJCWlmICh0eXBlb2YgcyAhPT0gJ3N0cmluZycpIHJldHVybiBzOwoKCQkJCXZhciBhcnIxID0gW107CgkJCQlmb3IgKHZhciBuID0gMCwgbCA9IHMubGVuZ3RoOyBuIDwgbDsgbisrKSB7CgkJCQkJdmFyIGhleCA9IE51bWJlcihzLmNoYXJDb2RlQXQobikpLnRvU3RyaW5nKDE2KTsKCQkJCQlhcnIxLnB1c2goaGV4KTsKCQkJCX0KCQkJCXJldHVybiBhcnIxLmpvaW4oJycpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKHMpID0+IHsKCQkJCWNvbnNvbGUubG9nKHMpOwoJCQkJaWYgKHRoaXMuYlNob3dFcnJvcnMpIHRoaXMuU2hvd01lc3NhZ2Uocyk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKG8xLCBvMikgPT4gewoJCQkJaWYgKG8xID09IG8yKSByZXR1cm4gdHJ1ZTsKCgkJCQlpZiAoCgkJCQkJbzEgJiYKCQkJCQlvMS5fX09CSkVDVElEICYmCgkJCQkJbzIgJiYKCQkJCQlvMi5fX09CSkVDVElEICYmCgkJCQkJbzEuX19PQkpFQ1RJRCA9PSBvMi5fX09CSkVDVElECgkJCQkpCgkJCQkJcmV0dXJuIHRydWU7CgkJCQlpZiAobzEgJiYgbzEuX19ST1dJRCAmJiBvMiAmJiBvMi5fX1JPV0lEICYmIG8xLl9fUk9XSUQgPT0gbzIuX19ST1dJRCkKCQkJCQlyZXR1cm4gdHJ1ZTsKCQkJCWlmIChvMSAmJiBvMS5JZCAmJiBvMiAmJiBvMi5JZCAmJiBvMS5JZCA9PSBvMi5JZCkgcmV0dXJuIHRydWU7CgoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKCgpID0+IHsKCQkJCXRyeSB7CgkJCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIG51bGw7CgkJCQkJaWYgKHR5cGVvZihnbG9iYWwpID09PSAndW5kZWZpbmVkJyB8fCB0eXBlb2YoZ2xvYmFsLm9zKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkJLy8gY29uc29sZS5sb2coImlwQWRkcmVzcygpOiBJbnZhbGlkIGdsb2JhbCBvciBnbG9iYWwub3Mgbm90IGRlZmluZWQiKTsKCQkJCQkJcmV0dXJuIG51bGw7CgkJCQkJfQoJCQkJCXJldHVybiBbXS5jb25jYXQoLi4uT2JqZWN0LnZhbHVlcyhnbG9iYWwub3MubmV0d29ya0ludGVyZmFjZXMoKSkpLmZpbmQoKGRldGFpbHMpID0+IGRldGFpbHMuZmFtaWx5ID09PSAnSVB2NCcgJiYgIWRldGFpbHMuaW50ZXJuYWwpLmFkZHJlc3M7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCWNvbnNvbGUubG9nKCJpcEFkZHJlc3MoKTogIiArIGV4KTsKCQkJCQlyZXR1cm4gbnVsbDsKCQkJCX0KCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKGVhKSA9PiB7CgkJCQl0cnkgewoJCQkJCWlmIChlYS5FbnRpdHlUeXBlKSByZXR1cm4gIkVudGl0eSI7CgkJCQkJcmV0dXJuIE9iamVjdC5rZXlzKGVhKS5maWx0ZXIoayA9PiAhay5pbmRleE9mKCJJcyIpICYmIGsgIT09ICJJc1VuaXF1ZSIpLmZpbmQoayA9PiBlYVtrXSkucmVwbGFjZSgnSXMnLCAnJyk7CgkJCQl9IGNhdGNoIChleCkgewoJCQkJCXJldHVybiBudWxsOwoJCQkJfQoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChhKSA9PiB7CgkJCQlyZXR1cm4gYS5maWx0ZXIoKGFnLCBpKSA9PiAhYS5maW5kKChfYWcsIF9pKSA9PiBfYWcuTmFtZSA9PSBhZy5OYW1lICYmIF9pID4gaSAmJiBpID09IF9pKSk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2ZsaXAoKSAqLwoJX2ZsaXAoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9mbGlwKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgob2JqKSA9PiB7CgkJCQlyZXR1cm4gT2JqZWN0LmZyb21FbnRyaWVzKE9iamVjdC5lbnRyaWVzKG9iaikubWFwKChbaywgdl0pID0+IFt2LCBrXSkpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9mbGlwKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKGFzeW5jIChzY29wZSwgZmlsZW5hbWUpID0+IHsKCQkJCWxldCBvU2NvcGUgPSB0aGlzLl9fc2NvcGUoc2NvcGUpOwoKCQkJCWxldCBzID0gewoJCQkJCUVuYWJsZWQ6IHRydWUsCgkJCQkJTmFtZTogIkFQSVNFUlZFUjo6IiArIHNjb3BlLAoJCQkJfTsKCQkJCWlmIChvU2NvcGUuX19zY3JpcHQgJiYgb1Njb3BlLl9fc2NyaXB0LkRhdGUpIHsKCQkJCQlzLkRhdGUgPSBvU2NvcGUuX19zY3JpcHQuRGF0ZTsKCQkJCQlzLk9QRVJBVE9SUyA9IHsKCQkJCQkJRGF0ZTogIj4iCgkJCQkJfQoJCQkJfQoJCQkJbGV0IHNjcmlwdCA9IGF3YWl0IHRoaXMuc3IoKS5fKGBDb250ZW50TWFuYWdlci5jbXNTdG9yZWRTY3JpcHRGaW5kYCwgbnVsbCwgcyk7CgkJCQlpZiAoc2NyaXB0ICYmIHNjcmlwdC5TY3JpcHQpIHsKCQkJCQlzY3JpcHQuU2NyaXB0ID0gdGhpcy5fYXRvYihzY3JpcHQuU2NyaXB0KTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gY29uc29sZS5sb2coIl9yZWZyZXNoQVBJOiBzY3JpcHQgaXMgbnVsbCIpOwoJCQkJCXJldHVybiAxOwoJCQkJfQoKCQkJCWlmICghb1Njb3BlIHx8ICFvU2NvcGUuX19zY3JpcHQgfHwgKHNjcmlwdCAmJiBzY3JpcHQuU2NyaXB0ICYmICgoc2NyaXB0LkRhdGUuZ2V0VGltZSgpIC0gb1Njb3BlLl9fc2NyaXB0LkRhdGUuZ2V0VGltZSgpKSAvIDEwMDApID4gNSkpIHsKCQkJCQlpZiAoZmlsZW5hbWUpIHsKCQkJCQkJY29uc29sZS5sb2coIlsiICsgc2NvcGUgKyAiXSBOZXcgVXBkYXRlZCBWZXJzaW9uLCBvdmVyd3JpdHRpbmcgIiArIGZpbGVuYW1lLCBzY3JpcHQuRGF0ZSwgKG9TY29wZSAmJiBvU2NvcGUuX19zY3JpcHQpID8gb1Njb3BlLl9fc2NyaXB0LkRhdGUgOiBudWxsKTsKCQkJCQl9CgoJCQkJCWlmIChmaWxlbmFtZSAmJiB0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQkJYXdhaXQgZ2xvYmFsLnV0aWwucHJvbWlzaWZ5KGdsb2JhbC5mcy53cml0ZUZpbGUpKGZpbGVuYW1lLCBzY3JpcHQuU2NyaXB0KTsKCQkJCQl9IGVsc2UgaWYgKGZpbGVuYW1lKSB7CgkJCQkJCWF3YWl0IHRoaXMuc3IoKS5fKCdDb250ZW50TWFuYWdlci5jbXNTYXZlRmlsZUJvZHknLCBudWxsLCBmaWxlbmFtZSwgdGhpcy5fYnRvYShzY3JpcHQuU2NyaXB0KSk7CgkJCQkJfQoKCQkJCQlpZiAoIW9TY29wZSkgcmV0dXJuOwoJCQkJCW9TY29wZS5fX3NjcmlwdCA9IHNjcmlwdDsKCQkJCX0gZWxzZSB7CgkJCQkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAndW5kZWZpbmVkJykKCQkJCQkJY29uc29sZS5sb2coYFske3Njb3BlfV0gU2FtZSBvciBvbGRlciB2ZXJzaW9uLCBza2lwcGluZyB1cGRhdGVgLCBzY3JpcHQgPyBzY3JpcHQuRGF0ZSA6IG51bGwsIG9TY29wZS5fX3NjcmlwdCA/IG9TY29wZS5fX3NjcmlwdC5EYXRlIDogbnVsbCk7CgkJCQl9CgoJCQkJZGVsZXRlIG9TY29wZS5fX3NjcmlwdC5TY3JpcHQ7CgkJCQlyZXR1cm4gb1Njb3BlLl9fc2NyaXB0OwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChzY29wZSkgPT4gewoJCQkJbGV0IHJldCA9ICh0eXBlb2Yod2luZG93KSAhPT0gJ3VuZGVmaW5lZCcgPyB3aW5kb3cgOiBnbG9iYWwpOwoJCQkJaWYgKHNjb3BlKSByZXQgPSByZXRbc2NvcGVdOwoJCQkJcmV0dXJuIHJldDsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKCgpID0+IHsKCQkJCXJldHVybiAodHlwZW9mKHdpbmRvdykgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5TUikgPyB3aW5kb3cuU1IgOiB0aGlzOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChhKSA9PiB7CgkJCQlyZXR1cm4gdHlwZW9mKGF0b2IpID09PSAidW5kZWZpbmVkIiA/IEJ1ZmZlci5mcm9tKGEsICdiYXNlNjQnKS50b1N0cmluZygnYmluYXJ5JykgOiBhdG9iKGEpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChiKSA9PiB7CgkJCQlyZXR1cm4gdHlwZW9mKGJ0b2EpID09PSAidW5kZWZpbmVkIiA/IEJ1ZmZlci5mcm9tKGIpLnRvU3RyaW5nKCdiYXNlNjQnKSA6IGJ0b2EodW5lc2NhcGUoZW5jb2RlVVJJQ29tcG9uZW50KGIpKSk7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoKG5hbWUgPSAiZ2xvYmFsIikgPT4gewoJCQkJbGV0IGQgPSBuZXcgRGF0ZSgpIHx8IHRoaXMuc3IoKS5zZXJ2ZXJEYXRlKCk7CgkJCQl0aGlzLl9fc2NvcGUoKS5fX3RpbWVzID0gdGhpcy5fX3Njb3BlKCkuX190aW1lcyB8fCB7fTsKCQkJCXRoaXMuX19zY29wZSgpLl9fdGltZXNbbmFtZV0gPSB0aGlzLl9fc2NvcGUoKS5fX3RpbWVzW25hbWVdIHx8IGQ7CgoJCQkJbGV0IHMgPSBNYXRoLnJvdW5kKCgoZCAtIHRoaXMuX19zY29wZSgpLl9fdGltZXNbbmFtZV0pIC8gMTAwMCkgKiAxMDAsIDIpIC8gMTAwOwoJCQkJdGhpcy5fX3Njb3BlKCkuX190aW1lc1tuYW1lXSA9IGQ7CgkJCQlyZXR1cm4gKHMgKyAncycpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIChhc3luYyAobXMpID0+IHsKCQkJCWF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCBtcykpOwoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChlYSwgZGJUeXBlKSA9PiB7CgkJCQlsZXQgdHlwZSA9IHR5cGVvZihlYSkgPT09ICJzdHJpbmciID8gZWEgOiB0aGlzLl9hdHRyKGVhKTsKCQkJCXN3aXRjaCAodHlwZSkgewoJCQkJCWNhc2UgIlN0cmluZyI6CgkJCQkJCXJldHVybiAiVkFSQ0hBUigyNTUpIjsKCQkJCQljYXNlICJUZXh0IjoKCQkJCQljYXNlICJPYmplY3QiOgoJCQkJCQlyZXR1cm4gYCR7ZGJUeXBlPT0nc3FsaXRlJz8nVkFSQ0hBUic6J1RFWFQnfSg0MDAwKWA7CgkJCQkJY2FzZSAiQm9vbCI6CgkJCQkJCXJldHVybiAiVElOWUlOVCI7IC8vQklUCgkJCQkJY2FzZSAiRGF0ZSI6CgkJCQkJCXJldHVybiAiREFURVRJTUUiOwoJCQkJCWNhc2UgIkludCI6CgkJCQkJCXJldHVybiAiSU5URUdFUiI7CgkJCQkJY2FzZSAiTG9uZyI6CgkJCQkJCXJldHVybiAiQklHSU5UIjsKCQkJCQljYXNlICJFbnRpdHkiOgoJCQkJCQlyZXR1cm4gIlZBUkNIQVIoMjU1KSI7CgkJCQkJY2FzZSAiSW1hZ2UiOgoJCQkJCWNhc2UgIkZpbGUiOgoJCQkJCQlyZXR1cm4gIkJMT0IiOwoJCQkJCWRlZmF1bHQ6CgkJCQkJCXJldHVybiB0eXBlICsgIig0MCkiOwoJCQkJfQoJCQl9KSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gKChpZCwgbGVuKSA9PiB7CgkJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCQlpZiAoIXJldCAmJiB0eXBlb2YoZ2xvYmFsKSAhPT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKGNyeXB0bykgIT09ICd1bmRlZmluZWQnKSByZXQgPSBjcnlwdG8ucmFuZG9tVVVJRCgpOwoJCQkJaWYgKCFyZXQgJiYgdHlwZW9mKHV1aWR2NCkgIT09ICJ1bmRlZmluZWQiKSByZXQgPSB1dWlkdjQoKTsKCgkJCQlpZiAoIXJldCkgcmV0ID0gKCgoaWQgPyBOdW1iZXIoaWQpIDogbmV3IERhdGUoKS5nZXRUaW1lKCkgLyAxMCkgfCAwKS50b1N0cmluZygxNikpICsgJ3h4eHh4eHh4eHh4eHh4eHgnLnJlcGxhY2UoL1t4XS9nLCAoKSA9PiB7CgkJCQkJcmV0dXJuICgoaWQgPyBpZCA6IE1hdGgucmFuZG9tKCkpICogMTYgfCAwKS50b1N0cmluZygxNik7CgkJCQl9KS50b0xvd2VyQ2FzZSgpLnN1YnN0cmluZygwLCBsZW4gfHwgMjQpLnJlcGxhY2UoL1wtL2csICcnKTsKCgkJCQkvL2xldCBwb29sID0gKHRoaXMuX19zY29wZSgpLl9fdXVpZFBvb2wgPSB0aGlzLl9fc2NvcGUoKS5fX3V1aWRQb29sIHx8IFtdKTsKCQkJCS8vaWYgKHBvb2wuZmluZCh1ID0+IHUgPT0gcmV0KSkgcmV0dXJuIHRoaXMuX3V1aWQoaWQsIGxlbik7CgkJCQkvL3Bvb2wucHVzaChyZXQpOwoKCQkJCXJldHVybiByZXQ7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiAoYXN5bmMgKGxpYk5hbWUsIGhyZWZzKSA9PiB7CgkJCQlmb3IgYXdhaXQgKGNvbnN0IG4gb2YgKGhyZWZzIHx8IHRoaXMuaHJlZnMpLmZpbHRlcihsID0+IGwubGliID09PSBsaWJOYW1lICYmIHRoaXMuX2luY2x1ZGUobCkpKSB7CgkJCQkJbi5yZXF1aXJlcyA9IG4ucmVxdWlyZXMgfHwgW107CgkJCQkJZm9yIGF3YWl0IChjb25zdCByIG9mIG4ucmVxdWlyZXMuZmlsdGVyKHIgPT4gciAhPSBsaWJOYW1lKSkgewoJCQkJCQlhd2FpdCB0aGlzLnJlcXVpcmUociwgaHJlZnMpOwoJCQkJCX0KCgkJCQkJaWYgKHR5cGVvZih0aGlzLl9jc3MpICE9PSAndW5kZWZpbmVkJykgewoJCQkJCQlmb3IgKGNvbnN0IGMgb2YgQXJyYXkuaXNBcnJheShuLmNzcykgPyBuLmNzcyA6IFtuLmNzc10pIHsKCQkJCQkJCXRoaXMuX2NzcyhjKTsKCQkJCQkJfQoJCQkJCX0KCQkJCQl2YXIgbW9kdWxlcyA9IFtdOwoJCQkJCWZvciBhd2FpdCAoY29uc3QgcyBvZiBBcnJheS5pc0FycmF5KG4uc3JjKSA/IG4uc3JjIDogW24uc3JjXSkgewoJCQkJCQl0cnkgewoJCQkJCQkJaWYgKHMuTmFtZSkgewoJCQkJCQkJCS8vIHN0b3JlZCBzY3JpcHQKCQkJCQkJCQlsZXQgX3NjID0gYXdhaXQgc3IuXygiQ29udGVudE1hbmFnZXIuY21zU3RvcmVkU2NyaXB0RmluZCIsIG51bGwsIHMpOwoJCQkJCQkJCWF3YWl0IHNyLnJ1blNjcmlwdChfc2MuU2NyaXB0KTsKCQkJCQkJCX0gZWxzZSBpZiAobi5tb2R1bGUpIHsKCQkJCQkJCQltb2R1bGVzLnB1c2goYXdhaXQgaW1wb3J0KHMpKTsKCQkJCQkJCX0gZWxzZSBpZiAodHlwZW9mKCQpICE9PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YoJC5hamF4KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCgkJCQkJCQkJYXdhaXQgJC5hamF4KHsKCQkJCQkJCQkJdXJsOiBuLmNhY2hlID8gcyA6IHRoaXMucmFuZFVSTChzKSwKCQkJCQkJCQkJZGF0YVR5cGU6ICJzY3JpcHQiLAoJCQkJCQkJCQljYWNoZTogbi5jYWNoZSA/ICdmb3JjZS1jYWNoZScgOiAnZGVmYXVsdCcKCQkJCQkJCQl9KTsKCQkJCQkJCX0gZWxzZSB7CgkJCQkJCQkJYXdhaXQgbmV3IFByb21pc2UociA9PiB7CgkJCQkJCQkJCWxldCBzY3JpcHQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTsKCQkJCQkJCQkJc2NyaXB0Lm9ubG9hZCA9ICgpID0+IHIoKTsKCQkJCQkJCQkJc2NyaXB0LnNyYyA9IHM7CgkJCQkJCQkJCShkb2N1bWVudC5ib2R5IHx8IGRvY3VtZW50LmhlYWQpLmFwcGVuZENoaWxkKHNjcmlwdCk7CgkJCQkJCQkJfSk7CgkJCQkJCQl9CgkJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCQljb25zb2xlLmxvZygicmVxdWlyZVsiICsgbi5saWIgKyAiXSBFeGNlcHRpb246ICIgKyBleCwgcyk7CgkJCQkJCX0KCQkJCQl9CgkJCQkJaWYgKG4ubG9hZCkgewoJCQkJCQl0cnkgewoJCQkJCQkJYXdhaXQgbi5sb2FkKG1vZHVsZXMpOwoJCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQkJY29uc29sZS5sb2coIkV4Y2VwdGlvbiBpbiBsb2FkKCkgb2YgIiArIG4ubGliLCBleCk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9CgkJCQljb25zb2xlLmxvZygicmVxdWlyZVsiICsgbGliTmFtZSArICJdIik7CgkJCX0pKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgoX2hyZWYpID0+IHsKCQkJCXJldHVybiAhKF9ocmVmLmRpc2FibGVkIHx8IChfaHJlZi50eXBlICYmIHRoaXMuaXNNb2JpbGUoKSAmJiBfaHJlZi50eXBlICE9ICJtb2JpbGUiKSB8fCAoX2hyZWYudHlwZSAmJiAhdGhpcy5pc01vYmlsZSgpICYmIF9ocmVmLnR5cGUgPT0gIm1vYmlsZSIpKTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuICgodmFsdWUsIHR5cGUpID0+IHsKCQkJCXRyeSB7CgkJCQkJaWYgKHR5cGVvZihiZWF1dGlmaWVyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJdmFyIG9wdGlvbnMgPSB7CgkJCQkJCQkiaW5kZW50X3NpemUiOiAiMSIsCgkJCQkJCQkiaW5kZW50X2NoYXIiOiAiXHQiLAoJCQkJCQkJIm1heF9wcmVzZXJ2ZV9uZXdsaW5lcyI6ICIyIiwKCQkJCQkJCSJwcmVzZXJ2ZV9uZXdsaW5lcyI6IHRydWUsCgkJCQkJCQkia2VlcF9hcnJheV9pbmRlbnRhdGlvbiI6IGZhbHNlLAoJCQkJCQkJImJyZWFrX2NoYWluZWRfbWV0aG9kcyI6IGZhbHNlLAoJCQkJCQkJImluZGVudF9zY3JpcHRzIjogIm5vcm1hbCIsCgkJCQkJCQkiYnJhY2Vfc3R5bGUiOiAiY29sbGFwc2UiLAoJCQkJCQkJInNwYWNlX2JlZm9yZV9jb25kaXRpb25hbCI6IHRydWUsCgkJCQkJCQkidW5lc2NhcGVfc3RyaW5ncyI6IGZhbHNlLAoJCQkJCQkJImpzbGludF9oYXBweSI6IGZhbHNlLAoJCQkJCQkJImVuZF93aXRoX25ld2xpbmUiOiBmYWxzZSwKCQkJCQkJCSJ3cmFwX2xpbmVfbGVuZ3RoIjogIjAiLAoJCQkJCQkJImluZGVudF9pbm5lcl9odG1sIjogZmFsc2UsCgkJCQkJCQkiY29tbWFfZmlyc3QiOiBmYWxzZSwKCQkJCQkJCSJlNHgiOiB0cnVlLAoJCQkJCQkJImluZGVudF9lbXB0eV9saW5lcyI6IGZhbHNlCgkJCQkJCX07CgkJCQkJCWlmIChbJ2NzaGFycCcsICdqYXZhc2NyaXB0J10uaW5kZXhPZih0eXBlKSA+IC0xKSB7CgkJCQkJCQl2YWx1ZSA9IGJlYXV0aWZpZXIuanModHlwZW9mKHZhbHVlKSAhPT0gJ3N0cmluZycgPyBKU09OLnN0cmluZ2lmeSh2YWx1ZSkgOiB2YWx1ZSwgb3B0aW9ucyk7CgkJCQkJCX0gZWxzZSBpZiAoWydodG1sJ10uaW5kZXhPZih0eXBlKSA+IC0xKSB7CgkJCQkJCQl2YWx1ZSA9IGJlYXV0aWZpZXIuaHRtbCh2YWx1ZSwgb3B0aW9ucyk7CgkJCQkJCX0KCQkJCQl9CgkJCQl9IGNhdGNoIChleCkge30KCQkJCXJldHVybiB2YWx1ZTsKCQkJfSkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJYnlEZXBhcnRtZW50KGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9kZXBhcnRtZW50Il0gJiYgKGFbIl9kZXBhcnRtZW50Il0uRXF1YWxzID8gYVsiX2RlcGFydG1lbnQiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX2RlcGFydG1lbnQiXSwgcikpKSB7CgkJCQkJci5fZGVwYXJ0bWVudF9Vc2Vycy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gZmFsc2U7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Vc2VyLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5Vc2VyKG51bGwsIHRoaXMuVG9vbCk7CgoJCQkJbGV0IGJGaW5kID0gZmFsc2U7CgkJCQlpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLklkID0gdGhpcy5JZDsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy51c2VybmFtZSh0aGlzLnVzZXJuYW1lKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuY29kZSh0aGlzLmNvZGUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fZGVwYXJ0bWVudF9zZXQgJiYgdGhpcy5kZXBhcnRtZW50KCkgJiYgIShhd2FpdCB0aGlzLmRlcGFydG1lbnQoKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9kZXBhcnRtZW50KCk7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fX2Fzc2VydFZhbGlkKHRydWUpKSByZXR1cm4gbnVsbDsKCgkJCQkvL2F3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8gaW4gY2FzZSBUb29sIGNoYW5nZXMKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgQWJvdXQgdG8gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9YCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgRmluaXNoZWQgSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9IElkPVske3RoaXMuSWR9XWApOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX21hbmFnZXJfRGVwYXJ0bWVudHNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5tYW5hZ2VyX0RlcGFydG1lbnRzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICh0aGlzLl9jYWxsZXJfSW5jaWRlbnRzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuY2FsbGVyX0luY2lkZW50cygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAodGhpcy5fY29udGFjdF9JbmNpZGVudHNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5jb250YWN0X0luY2lkZW50cygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAodGhpcy5fdXNlcl9Hcm91cF9NZW1iZXJzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMudXNlcl9Hcm91cF9NZW1iZXJzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQkJaWYgKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uT3duZXIgPT0gdGhpcykgewoJCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGBDT01NSVQke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/JyBUUkFOU0FDVElPTic6Jyd9YCk7CgkJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCA9IG5ldyBEYXRlKCk7CgkJCQkJCX0KCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlVzZXIuaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b0luc2VydFNRTCgpKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luc2VydCcsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXRoaXMuX2Zyb21Eb2N1bWVudChhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCWxldCBvYmogPSB7fTsKCgkJCQlpZiAodGhpcy5fdXNlcm5hbWVfc2V0KSB7CgoJCQkJCW9iai51c2VybmFtZSA9IHRoaXMudXNlcm5hbWUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX3Bhc3N3b3JkX3NldCkgewoKCQkJCQlvYmoucGFzc3dvcmQgPSB0aGlzLnBhc3N3b3JkKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9kZXBhcnRtZW50X3NldCkgewoKCQkJCQlvYmouZGVwYXJ0bWVudCA9IHRoaXMuX2RlcGFydG1lbnQuSWQ7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9hY3RpdmVfc2V0KSB7CgoJCQkJCW9iai5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9zZXQpIHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2NvZGVfc2V0KSB7CgoJCQkJCW9iai5jb2RlID0gdGhpcy5jb2RlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9vcmRlcl9zZXQpIHsKCgkJCQkJb2JqLm9yZGVyID0gdGhpcy5vcmRlcigpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZGF0ZV9zZXQpIHsKCgkJCQkJb2JqLmRhdGUgPSB0aGlzLmRhdGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX25hbWVfc2V0KSB7CgoJCQkJCW9iai5uYW1lID0gdGhpcy5uYW1lKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9yZW1hcmtfc2V0KSB7CgoJCQkJCW9iai5yZW1hcmsgPSB0aGlzLnJlbWFyaygpOwoKCQkJCX0KCgkJCQlsb2coIlNlbmRpbmcgdG8gU0YiLCBvYmopOwoKCQkJCWxldCByZXMgPSBhd2FpdCB0aGlzLlRvb2wuZGIuc29iamVjdCgiVXNlciIpLmNyZWF0ZShvYmopOwoJCQkJdGhpcy5JZCA9IHJlcy5pZDsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlVzZXIudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Vc2VyLmZpbmRBbGwnKTsKCgkJCS8vIGF2b2lkcyBjeWNsaWMgcXVlcmllcwoJCQlvYmpzID0gKG9ianMgfHwgW10pLm1hcChvID0+IG8uX2Nsb25lKCkpOwoKCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLz8/CgoJCQlsZXQgcmV0ID0gW107IC8vIGEganNvbiBhcnJheQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTChmaWVsZHMsIG9ianMpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgewoJCQkJCXN5c3Bhcm1fcXVlcnk6IE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvU05RdWVyeShmaWVsZHMsIG9ianMpKS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCB0cnVlKSwgbnVsbCwgewoJCQkJCXVybDogJ3Jlc3QudXJsLmdxbCcKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2ApOwoJCQkJcmV0ID0gcmV0LmNvbnRlbnQgPyBbSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSldIDogW107CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5tYXAociA9PiBuZXcgc2FsZXNub3cuVXNlcihudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQl0cnkgewoJCQlpZiAoZGVwdGggPiAxKSB7CgkJCQlmb3IgYXdhaXQgKGNvbnN0IHIgb2YgcmV0KSB7CgoJCQkJCWlmIChyLl9kZXBhcnRtZW50X3NldCkgewoJCQkJCQlyLmRlcGFydG1lbnQoYXdhaXQgci5fZGVwYXJ0bWVudC5maW5kKGRlcHRoIC0gMSkpOwoJCQkJCX0KCgkJCQkJci5tYW5hZ2VyX0RlcGFydG1lbnRzKGF3YWl0IG5ldyBzYWxlc25vdy5EZXBhcnRtZW50KG51bGwsIHIuVG9vbCkubWFuYWdlcihyKS5maW5kQWxsKGRlcHRoIC0gMSkpOwoKCQkJCQlyLmNhbGxlcl9JbmNpZGVudHMoYXdhaXQgbmV3IHNhbGVzbm93LkluY2lkZW50KG51bGwsIHIuVG9vbCkuY2FsbGVyKHIpLmZpbmRBbGwoZGVwdGggLSAxKSk7CgoJCQkJCXIuY29udGFjdF9JbmNpZGVudHMoYXdhaXQgbmV3IHNhbGVzbm93LkluY2lkZW50KG51bGwsIHIuVG9vbCkuY29udGFjdChyKS5maW5kQWxsKGRlcHRoIC0gMSkpOwoKCQkJCQlyLnVzZXJfR3JvdXBfTWVtYmVycyhhd2FpdCBuZXcgc2FsZXNub3cuR3JvdXBfTWVtYmVyKG51bGwsIHIuVG9vbCkudXNlcihyKS5maW5kQWxsKGRlcHRoIC0gMSkpOwoKCQkJCX0KCQkJfQoKCQkJbGV0IHJlZnMgPSBbXTsKCQkJaWYgKCFBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IFtyZXRdOwoKCQkJcmVmcy5wdXNoKC4uLnJldC5maWx0ZXIociA9PiByLkVudGl0eUNsYXNzKSk7CgkJCWZvciBhd2FpdCAoY29uc3QgbyBvZiAob2JqcyB8fCBbXSkpIHsKCQkJCWxldCBvZmEgPSBbXTsKCQkJCWlmIChvLl90b0VNU09iamVjdCkgewoJCQkJCW9mYSA9IGF3YWl0IHRoaXMuX2Zyb21FTVNWYWx1ZXMoYXdhaXQgby5fdG9FTVNPYmplY3QodHJ1ZSwgdHJ1ZSkuZmluZEFsbChkZXB0aCkpOwoJCQkJfSBlbHNlIHsKCQkJCQlvZmEgPSBhd2FpdCBvLmZpbmRBbGwoZGVwdGgpOwoJCQkJfQoJCQkJcmVmcy5wdXNoKC4uLm9mYSk7CgkJCX0KCQkJcmVmcyA9IHJlZnMuZmlsdGVyKHIgPT4gcik7CgkJCXJlZnMuZm9yRWFjaChyID0+IHsKCQkJCWZvciAodmFyIHAgaW4gcikgewoJCQkJCWlmIChwLnN0YXJ0c1dpdGgoJ18nKSAmJiByW3BdICYmIHJbcCArICJfc2V0Il0gJiYgcltwXS5JZCAmJiByZWZzLmZpbmQobyA9PiBvLklkID09IHJbcF0uSWQpKSB7CgkJCQkJCXJbcC5zdWJzdHJpbmcoMSldKHJlZnMuZmluZChvID0+IG8uSWQgPT0gcltwXS5JZCkpOwoJCQkJCX0KCQkJCX0KCQkJfSk7CgoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19maW5kUmVmZXJlbmNlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoKCX0KCn07CgpzYWxlc25vdy5EZXBhcnRtZW50ID0gY2xhc3MgRGVwYXJ0bWVudCBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFzS2k1ZmNtVnpkQ3dxTGw5c2IyRmtWRzl2YkhNaWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc2V5SnVZVzFsSWpvaVUwNVBWMDlQUWlJc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaWZYMHNJbE5oYkdWelJtOXlZMlVpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibWFuYWdlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbWFuYWdlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfZGVwYXJ0bWVudF9Vc2VycygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIkRlcGFydG1lbnQiLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCS8vIGlmKHRoaXMuX21hbmFnZXJfc2V0ICYmIHRoaXMuX21hbmFnZXIpIHRoaXMuX21hbmFnZXIuVG9vbCA9IHRvb2w7CgoJCS8vICh0aGlzLmRlcGFydG1lbnRfVXNlcnMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbWFuYWdlciAqKi8KCW1hbmFnZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9tYW5hZ2VyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibWFuYWdlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzAyNjQ1YzVjLWJlMDQtNGRhYi05MWI0LWY4Yzg1YmU5NGE2ZScgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ1VzZXInKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnbWFuYWdlcicsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjAyNjQ1YzVjLWJlMDQtNGRhYi05MWI0LWY4Yzg1YmU5NGE2ZSIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJVc2VyIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX21hbmFnZXIgIT0gdikgewoJCQkJdGhpcy5fbWFuYWdlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ21hbmFnZXInLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX21hbmFnZXIgPyB0aGlzLl9tYW5hZ2VyLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9tYW5hZ2VyX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9tYW5hZ2VyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX21hbmFnZXIpOwoJCX0KCX0KCgljbGVhcl9tYW5hZ2VyKCkgewoJCXRoaXMuX21hbmFnZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9tYW5hZ2VyID0gbnVsbDsKCQl0aGlzLl9tYW5hZ2VyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBtYW5hZ2VyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGVwYXJ0bWVudF9Vc2VycyAqKi8KCWRlcGFydG1lbnRfVXNlcnModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX2RlcGFydG1lbnRfVXNlcnM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzAyNjQ1YzVjLWJlMDQtNGRhYi05MWI0LWY4Yzg1YmU5NGE2ZScgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnVXNlcicpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fZGVwYXJ0bWVudF9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdkZXBhcnRtZW50X1VzZXJzJywgJ0VudGl0eU9iamVjdCcsIDEsICJkZXBhcnRtZW50IGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJVc2VyIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZGVwYXJ0bWVudF9Vc2VycycsICdFbnRpdHlPYmplY3QnLCAxLCAiZGVwYXJ0bWVudCBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIlVzZXIiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YuZGVwYXJ0bWVudCh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9kZXBhcnRtZW50X1VzZXJzLnB1c2goLi4udik7CgkJdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfZGVwYXJ0bWVudF9Vc2VycygpIHsKCQl0aGlzLl9kZXBhcnRtZW50X1VzZXJzX3NldCA9IG51bGw7CgkJdGhpcy5fZGVwYXJ0bWVudF9Vc2VycyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX2RlcGFydG1lbnRfVXNlcnNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkZXBhcnRtZW50X1VzZXJzICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fbWFuYWdlcl9zZXQsCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9tYW5hZ2VyX3NldCA9IHRoaXMuX21hbmFnZXJfc2V0OwoJCXJldC5fbWFuYWdlcl9jb29wID0gdGhpcy5fbWFuYWdlcl9jb29wOwoJCXJldC5tYW5hZ2VyID0gdGhpcy5tYW5hZ2VyKCkgPyB0aGlzLm1hbmFnZXIoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5tYW5hZ2VyKCk7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5kZXBhcnRtZW50X1VzZXJzID0gdGhpcy5kZXBhcnRtZW50X1VzZXJzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJtYW5hZ2VyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQlkZXBhcnRtZW50X1VzZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudF9EZXBhcnRtZW50cycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJtYW5hZ2VyIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBtYW5hZ2VyJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Vc2VyKCkubWFuYWdlcl9EZXBhcnRtZW50cyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpICE9ICdEZXBhcnRtZW50JykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL0RlcGFydG1lbnQvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQkJZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOwoJCQkJZGVsZXRlIGRhdGEuX190aGlzLm9ubGluZTsKCgkJCX0KCgkJCS8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/PwoKCQkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJCXRyeSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0pIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7bWV0aG9kfWApOwoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCWxldCBfaWQgPSBudWxsOwoJCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBkYXRhLCBtZXRob2QsIHt9KTsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRhdGEpID09PSAnc3RyaW5nJykgewoJCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUoZGF0YSk7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IGRhdGEuX190aGlzLmNvZGUgfHwgZGF0YS5pZCB8fCBkYXRhLklEOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJCWlmIChkYXRhLklkICYmIGRhdGEuSWQgPT0gZGF0YS5JZCkgewoJCQkJCQlfaWQgPSBkYXRhLklkOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQkJfSBlbHNlIGlmIChkYXRhLkVudGl0eUNsYXNzKSB7CgkJCQkJCV9pZCA9IGRhdGEuRW50aXR5Q2xhc3MuSWQgfHwgZGF0YS5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgImVjZGNjNDJjLTI4NzEtNDg5ZS1iMDZiLWM0YjQ5OGFkZGQ3ZiIgfHwgIk5VTEwiOwoJCQkJCX0KCQkJCX0KCgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudCB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFttZXRob2RdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W21ldGhvZF0gfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnRbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W21ldGhvZF1bX2lkXSB8fCB7fTsKCgkJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goe30sIHsKCQkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQkJfSk7CgoJCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFttZXRob2RdW19pZF1bX2hhc2hdOwoJCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiA1KSkgewoJCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gbWV0aG9kIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJCXYucmV1c2VkKys7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhKTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnRGVwYXJ0bWVudCcpLnNlbmRlcihzYWxlc25vdy5fbm9kZSkuY2FycmllcihzYWxlc25vdy5fbm9kZSkucGF5bG9hZChkYXRhKTsKCQkJaWYgKGV2ZW50KSB7CgkJCQlpZiAoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7CgkJCQlpZiAoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7CgkJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7CgkJCQlpZiAoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7CgkJCX0KCQkJcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOwoKCQkJaWYgKHR5cGVvZihyZXQpID09PSAic3RyaW5nIikgewoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChleCkge30KCQkJfQoJCQlyZXR1cm4gcmV0OwoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LkRlcGFydG1lbnQobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93LkRlcGFydG1lbnQobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudCgpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOwoJCX0KCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgRGVwYXJ0bWVudC5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYERlcGFydG1lbnQuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudC5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5EZXBhcnRtZW50LicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJX3BhcnNlQ29kZVN0YXRlKHQpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3BhcnNlQ29kZVN0YXRlKHQpOwoKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIkRlcGFydG1lbnQiKTsKCgl9CgoJX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXggPSAne3snLCBwb3N0Zml4ID0gJ319JykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCwgcG9zdGZpeCk7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCWlmICh0aGlzLl9tYW5hZ2VyX3NldCAmJiB0aGlzLm1hbmFnZXIoKSkgdGhpcy5tYW5hZ2VyKCkuX19zeW5jX29uKGQpOwoKCQkJLy8gdGhpcy5kZXBhcnRtZW50X0RlcGFydG1lbnRzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuRGVwYXJ0bWVudCh0aGlzLklkKQoKCQkJLm1hbmFnZXIodGhpcy5tYW5hZ2VyKCksIHRoaXMuX21hbmFnZXJfY29vcCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkuZGVwYXJ0bWVudF9Vc2Vycyh0aGlzLmRlcGFydG1lbnRfVXNlcnMoKSwgdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSkgewoJCWNvbnRleHQgPSBjb250ZXh0IHx8ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCS8vb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCS8vb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ0RlcGFydG1lbnQnOwoJCXRvb2wgPSB0b29sIHx8IHRoaXMuVG9vbDsKCQljb2RlVHlwZSA9IGNvZGVUeXBlIHx8IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnRZVzVoWjJWeUlqb2lWWE5sY2lKOWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pW2NvZGVdOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJEZXBhcnRtZW50IjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucyA9IHt9KSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fY29uZmlnKG4sIG51bGxWYWx1ZSwgT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucyB8fCB7fSwgewoJCQlfY2xhc3M6ICdEZXBhcnRtZW50JwoJCX0pKTsKCgl9CgoJYXN5bmMgX3Jlc3QodE5hbWUgPSB0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyA9IHt9KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcih1bmRlZmluZWQsIHRoaXMuVG9vbCkuX3Jlc3QodGhpcy5fbkNvZGUoKSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMpOwoKCX0KCglfdG9TUUxUYWJsZSgpIHsKCQlsZXQgcmV0ID0gewoJCQlzcWw6IGBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9ICgKICAgICAgICAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgYAoJCX07CgkJcmV0LnNxbCArPSAnLypEZXBhcnRtZW50Ki8pO1xuJzsKCgkJcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogdHJ1ZSwKCQkJTnVsbDogdHJ1ZSwKCQkJLy9JZDogKG9iaiwgdikgPT4gb2JqLnNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVlgLAoKCQkJIm1hbmFnZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbWFuYWdlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdtYW5hZ2VyJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQlkZXBhcnRtZW50X1VzZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudF9EZXBhcnRtZW50cycsIHVuZGVmaW5lZCkpID0+IG9iai5zcWwgPSB2Lm1hcChfdiA9PiBfdi5fdG9TUUxUYWJsZSgpKSArIG9iai5zcWwsCgoJCX0sICJfdG9TUUxUYWJsZSIpOwoKCQkvLyByZXQuc3FsICs9ICcvKkRlcGFydG1lbnQqLyk7XG4nOwoKCQlyZXQuc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChyZXQuc3FsKSA6IHJldC5zcWw7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NRTFRhYmxlJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldC5zcWwpOwoJCXJldHVybiByZXQuc3FsOwoJfQoKCV9mcm9tU1FMVGFibGUodGFibGUsIGZpZWxkcykgewoJCS8vIHRhYmxlIGlzIGEganNvbiBhcnJheQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibWFuYWdlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubWFuYWdlcih0YWJsZVsibWFuYWdlciJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbChzcWwsIHRoaXMpOwoKCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIGJTdHJpbmcpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7CgkJCVt0aGlzLl9uQ29kZSgpXTogewoJCQkJcGFyYW1zOiB7CgkJCQkJd2hlcmU6IHsKCQkJCQkJYW5kOiBbXSwKCQkJCQkJb3I6IFtdCgkJCQkJfQoJCQkJfSwKCQkJCWVkZ2VzOiB7CgkJCQkJbm9kZToge30KCQkJCX0KCQkJfQoJCX0sIHsKCQkJLy9PUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKHsKCQkJCUlkOiB7CgkJCQkJZXE6IHYKCQkJCX0KCQkJfSksCgoJCQltYW5hZ2VyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbWFuYWdlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJewoJCQkJCQkJaW5xOiB7CgkJCQkJCQkJQXBpTmFtZTogJ0lkJywKCQkJCQkJCQlbdGhpcy5fbkNvZGUoJ1VzZXInLCB1bmRlZmluZWQpXTogdiA/IHYuX3RvU0ZRdWVyeSgpW3RoaXMuX25Db2RlKCdVc2VyJywgdW5kZWZpbmVkKV0ucGFyYW1zLndoZXJlLmFuZCA6IFtdLAoJCQkJCQkJfSwKCQkJCQkJfQoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsKQoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCX0sICJfdG9TRlF1ZXJ5Iik7CgoJCS8vT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCWlmIChiU3RyaW5nKSB7CgkJCXJldCA9IHsKCQkJCXF1ZXJ5OiB7CgkJCQkJW3RoaXMuX25Db2RlKCkgKyAnUXVlcnknXTogewoJCQkJCQl1aWFwaTogcmV0CgkJCQkJfQoJCQkJfQoJCQl9OwoJCQlyZXQgPSBKU09OLnN0cmluZ2lmeShyZXQsIG51bGwsIDQpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU0ZRdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU05RdWVyeShmaWVsZHMsIG9ianMpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlPUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmouc3lzX2lkID0gdiwKCgkJCW1hbmFnZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdtYW5hZ2VyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJbGV0IGQgPSBgJHt2LmdldEZ1bGxZZWFyKCl9LSR7KCcwJysodi5nZXRNb250aCgpKzEpKS5zbGljZSgtMil9LSR7di5nZXREYXRlKCl9YDsKCQkJCWxldCB0ID0gYCR7di5nZXRIb3VycygpfToke3YuZ2V0TWludXRlcygpfToke3YuZ2V0U2Vjb25kcygpfWA7CgkJCQlpZiAoKHYuZ2V0SG91cnMoKSA9PSAwICYmIHYuZ2V0TWludXRlcygpID09IDAgJiYgdi5nZXRTZWNvbmRzKCkgPT0gMCkgfHwgdGhpcy5fZGF0ZV9jb29wID09ICc9JyB8fCAhdGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgT04ke2R9QGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9Jywnc3RhcnQnKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ2VuZCcpYDsKCQkJCX0gZWxzZSBpZiAodGhpcy5fZGF0ZV9jb29wICE9PSAnQkVUV0VFTicpIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0KCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCX0sICJfdG9TTlF1ZXJ5Iik7CgoJCU9iamVjdC5rZXlzKHJldC5PUEVSQVRPUlMgfHwge30pLmZpbHRlcihrID0+IHR5cGVvZihyZXRba10pICE9PSAndW5kZWZpbmVkJykuZm9yRWFjaChrID0+IHJldFtrXSA9IHJldC5PUEVSQVRPUlNba10gKyByZXRba10pOwoKCQlkZWxldGUgcmV0Lk9QRVJBVE9SUzsKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJcmV0ID0gRG90T2JqZWN0LmRvdChyZXQpOwoKCQkvLyBhdm9pZCBzZW5kaW5nIHdpdGggbm8gY29tcGFyaXNvbiBvcGVyYXRvcnMKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFbJz4nLCAnPCcsICdCRVRXRUVOJywgJ09OJywgJyEnLCAnPScsICdTVEFSVFNXSVRIJywgJ0xJS0UnXS5zb21lKHMgPT4gU3RyaW5nKHJldFtrXSkuc3RhcnRzV2l0aChzKSkpLmZvckVhY2goayA9PiByZXRba10gPSAodGhpc1tgXyR7a31fY29vcGBdIHx8ICdTVEFSVFNXSVRIJykgKyByZXRba10pOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIE9iamVjdC5lbnRyaWVzKHJldCB8fCB7fSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCWxldCBfcmV0ID0gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCBmYWxzZSwgZnVuLCBlYU9iaiwgb2JqKTsKCQkJCXJldHVybiBfcmV0OwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiZWNkY2M0MmMtMjg3MS00ODllLWIwNmItYzRiNDk4YWRkZDdmIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnQgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnQgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnRbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlpZiAoIXRoaXMubWFuYWdlcigpIHx8ICh0aGlzLm1hbmFnZXIoKQoKCQkJCSYmCgkJCQkhdGhpcy5tYW5hZ2VyKCkubWFuYWdlcl9EZXBhcnRtZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5tYW5hZ2VyKCkuY2FsbGVyX0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5tYW5hZ2VyKCkuY29udGFjdF9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMubWFuYWdlcigpLnVzZXJfR3JvdXBfTWVtYmVycygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygibWFuYWdlciIsIG9iaiwgdGhpcy5tYW5hZ2VyKCkpOwoJCX0KCgkJX29wdGlvbnMoImRlcGFydG1lbnRfVXNlcnMiLCBvYmosIHRoaXMuZGVwYXJ0bWVudF9Vc2VycygpKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnbWFuYWdlcicsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnZGVwYXJ0bWVudF9Vc2VycyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgdHJ1ZSwgZnVuLCBvYmosIG9iaik7CgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgImVjZGNjNDJjLTI4NzEtNDg5ZS1iMDZiLWM0YjQ5OGFkZGQ3ZiIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50IHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnRbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuRGVwYXJ0bWVudFtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnRbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5EZXBhcnRtZW50W2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnRbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkRlcGFydG1lbnRbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygibWFuYWdlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkZXBhcnRtZW50X1VzZXJzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnbWFuYWdlcicsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnZGVwYXJ0bWVudF9Vc2VycyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaikpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9EQk9iamVjdChmaWVsZHMsIGJOb1JlZikgewoJCWlmICghdGhpcy5JZCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCAiSW52YWxpZCBJRCIsIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSwgdGhpcy5Ub29sKTsKCQl9CgkJbGV0IHJldCA9IHsKCQkJW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXTogIiciICsgdGhpcy5JZCArICInIgoJCX07CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibWFuYWdlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9tYW5hZ2VyX3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5tYW5hZ2VyKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdtYW5hZ2VyJywgdW5kZWZpbmVkKSArICJpZCJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fYWN0aXZlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2VuYWJsZWRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9jb2RlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNvZGUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9vcmRlcl9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5vcmRlcigpOwoKCQkJZlZhbHVlID0gdiB8fCAnMCc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9kYXRlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmRhdGUoKTsKCgkJCXRyeSB7CgkJCQlmVmFsdWUgPSAiJyIgKyAodiA/IHYudG9JU09TdHJpbmcoKSA6ICIxOTcwLTEtMSIpICsgIiciOwoJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnKSB7CgkJCQkJZlZhbHVlID0gYFNUUl9UT19EQVRFKCR7ZlZhbHVlfSwgJyVZLSVtLSVkVCVULiVmWicpYDsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gJ2RhdGV0aW1lKCcgKyBmVmFsdWUgKyAnKSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX25hbWVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMubmFtZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9yZW1hcmtfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucmVtYXJrKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9RKCkgewoJCWxldCBfbyA9ICciJzsKCQlsZXQgX3EgPSBfbzsKCgkJaWYgKFsnU2FsZXNGb3JjZSddLmluZGV4T2YodGhpcy5Ub29sLnR5cGUubmFtZSkgPT0gMCkgewoJCQlfbyA9IF9xID0gIiI7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJyB8fCB0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIHsKCQkJX28gPSBfcSA9ICdgJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3Fsc2VydmVyJykgewoJCQlfbyA9ICdbJzsKCQkJX3EgPSAnXSc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCdhcGlLZXknKSA9PSAnYWlydGFibGUnKSB7CgkJCV9vID0gJ3snOwoJCQlfcSA9ICd9JzsKCQl9CgkJdGhpcy5fX1EgPSB0aGlzLl9fUSA9PSBfbyA/IF9xIDogX287CgkJcmV0dXJuIHRoaXMuX19ROwoJfQoKCV9maWVsZEdyb3VwcyhmZ3MgPSB7fSkgewoJCXRoaXMuX19maWVsZEdyb3VwcyA9IGZnczsKCQlyZXR1cm4gdGhpczsKCX0KCglfZmllbGRBZ2dyZWdhdGVzKGZhcyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkQWdncmVnYXRlcyA9IGZhczsKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9GaWVsZHNTUUwoZmllbGRzKSB7CgoJCWZpZWxkcyA9IGZpZWxkcyB8fCBbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyksIHRoaXMuX25Db2RlKCdtYW5hZ2VyJywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKV07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm1hbmFnZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdtYW5hZ2VyJywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0sCgoJCQkJbWFuYWdlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5tYW5hZ2VyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb2RlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5kYXRlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5uYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucmVtYXJrKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlOdWxsOiB0cnVlLAoKCQkJbWFuYWdlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Vc2VyKG51bGwsIHRoaXMuVG9vbCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCX0sICJfdG9TZWxlY3RIZWFkZXIiKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0SGVhZGVyJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU2VsZWN0U1FMKGZpZWxkcykgewoJCWxldCBzcWwgPSAic2VsZWN0ICI7CgoJCWxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9YDsKCgkJbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7CgoJCXNxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsKCgkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpIHsKCQkJLy8ge2ZpZWxkOiBmdW5jdGlvbn0KCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm1hbmFnZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm1hbmFnZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJbWFuYWdlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX21hbmFnZXJfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9tYW5hZ2VyX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jb2RlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fb3JkZXJfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vcmRlcl9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9kYXRlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LnRvSVNPU3RyaW5nKSB7CgkJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3FsaXRlJykgewoJCQkJCQlvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbmFtZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX25hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3JlbWFya19zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZGVwYXJ0bWVudF9Vc2VyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RlcGFydG1lbnRfRGVwYXJ0bWVudHMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2RlcGFydG1lbnRfVXNlcnNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJkZXBhcnRtZW50LmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9kZXBhcnRtZW50X1VzZXJzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl9kZXBhcnRtZW50X1VzZXJzX2Nvb3AgPT0gJ05PVCBJTicpIHsKCQkJCQlpbk9QID0gJ05PVCBJTic7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX2RlcGFydG1lbnRfVXNlcnNfY29vcCA9PSAnPScgfHwgdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX2RlcGFydG1lbnRfVXNlcnNfY29vcCA9PSAnPT0nKSB7CgkJCQkJak9QID0gJ0lOVEVSU0VDVCc7CgkJCQl9CgoJCQkJb2JqLnNxbCArPSBgYW5kIC8qZGVwYXJ0bWVudF9Vc2VycyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJfSwgIl90b1NlbGVjdFNRTCIsIGZpZWxkcykuc3FsOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCWlmIChPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubWFuYWdlcikgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdtYW5hZ2VyJywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5tYW5hZ2VyfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jb2RlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMub3JkZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZGF0ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5uYW1lfWA7CgoJCX0KCgkJaWYgKHNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpIHsKCQkJLy8gc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSIsICJ3aGVyZSAxPTAiKTsKCQl9IGVsc2UgewoJCQlzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7CgkJfQoKCQlzcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCkgOiBzcWw7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgoJCXJldHVybiBzcWw7Cgl9CgoJX3RvUGF0aHMoKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJX1RISVM6IG9iaiA9PiB7fSwKCgkJCW1hbmFnZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdtYW5hZ2VyJywgdW5kZWZpbmVkKSkgPT4gb2JqLm1hbmFnZXIgPSB2Ll90b1BhdGhzKCksCgoJCQlkZXBhcnRtZW50X1VzZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudF9EZXBhcnRtZW50cycsIHVuZGVmaW5lZCkpID0+IG9iai5kZXBhcnRtZW50X1VzZXJzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuRGVwYXJ0bWVudCkgcmV0dXJuOwoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5EZXBhcnRtZW50ID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5EZXBhcnRtZW50KCkKCgkJCQkJLm1hbmFnZXIobmV3IHNhbGVzbm93LlVzZXIoKSkKCgkJCQkJLmRlcGFydG1lbnRfVXNlcnMobmV3IHNhbGVzbm93LlVzZXIoKSkKCgkJCQkJLl90b1NRTFRhYmxlKGRlcHRoKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJEZXBhcnRtZW50IikgcmV0dXJuIGZhbHNlOwoKCQkJbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJCUZ1bGw6IHRydWUsCgkJCQlOdWxsOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5faWQgPSB0aGlzLklkID09IHF1ZXJ5LklkLAoKCQkJCW1hbmFnZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm1hbmFnZXIgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5Lm1hbmFnZXIoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbWFuYWdlcl9zZXQgJiYgIXF1ZXJ5Ll9tYW5hZ2VyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5tYW5hZ2VyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX21hbmFnZXJfc2V0ICYmIHF1ZXJ5Ll9tYW5hZ2VyX3NldCkgfHwKCgkJCQkJCSh0aGlzLm1hbmFnZXIoKSAmJiAhdGhpcy5tYW5hZ2VyKCkuX21hdGNoZXMocXVlcnkubWFuYWdlcigpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubWFuYWdlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGVwYXJ0bWVudF9Vc2VyczogKG9iaiwgdikgPT4gewoJCQkJCW9iai5kZXBhcnRtZW50X1VzZXJzID0gdi5tYXAoX3YgPT4gcXVlcnkuZGVwYXJ0bWVudF9Vc2VycygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJbWFuYWdlcjogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIG1hbmFnZXIiKTsKCQkJCQlvYmoubWFuYWdlciA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCWRlcGFydG1lbnRfVXNlcnM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouZGVwYXJ0bWVudF9Vc2VycyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fbWFuYWdlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCW1hbmFnZXI6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5tYW5hZ2VyKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlkZXBhcnRtZW50X1VzZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuZGVwYXJ0bWVudF9Vc2VycygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV07CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJbWFuYWdlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ21hbmFnZXInLCB1bmRlZmluZWQpIDogIm1hbmFnZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbWFuYWdlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5tYW5hZ2VyKCkgfHwgbmV3IHNhbGVzbm93LlVzZXIoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLm1hbmFnZXIob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSBtYW5hZ2VyIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb2RlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jb2RlKHJlZik7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3JkZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9yZGVyKHJlZik7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLmRhdGUocmVmKTsKCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9uYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5uYW1lKHJlZik7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVtYXJrX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5yZW1hcmsocmVmKTsKCgkJCX0sCgoJCQlkZXBhcnRtZW50X1VzZXJzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGVwYXJ0bWVudF9EZXBhcnRtZW50cycsIHVuZGVmaW5lZCkgOiAiZGVwYXJ0bWVudF9Vc2VycyIpKSA9PiB0aGlzLmRlcGFydG1lbnRfVXNlcnMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSA9IHYsCgoJCQkibWFuYWdlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdtYW5hZ2VyJywgdW5kZWZpbmVkKSA6ICJtYW5hZ2VyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fbWFuYWdlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbWFuYWdlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQkJZGVwYXJ0bWVudF9Vc2VyczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RlcGFydG1lbnRfRGVwYXJ0bWVudHMnLCB1bmRlZmluZWQpIDogImRlcGFydG1lbnRfVXNlcnMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGVwYXJ0bWVudF9Vc2Vyc19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9mbGlwKCkgKi8KCV9mbGlwKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fZmxpcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9mbGlwKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2ZsaXAoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJYnlVc2VyKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9tYW5hZ2VyIl0gJiYgKGFbIl9tYW5hZ2VyIl0uRXF1YWxzID8gYVsiX21hbmFnZXIiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX21hbmFnZXIiXSwgcikpKSB7CgkJCQkJci5fbWFuYWdlcl9EZXBhcnRtZW50cy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gdHJ1ZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLm5hbWUgPSB7fTsKCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgZXJyb3IubmFtZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IubmFtZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IubmFtZTsKCQl9CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkRlcGFydG1lbnQuc3RvcmUnKTsgLy8gb3IgaW5zaWRlIGV4ZWN1dGU/CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJbGV0IGJVcGRhdGUgPSBmYWxzZTsKCQkJbGV0IGJJbnNlcnQgPSBmYWxzZTsKCgkJCWlmICghdGhpcy5fX3N5bmNfb24oKSkgewoJCQkJbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LkRlcGFydG1lbnQobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLm5hbWUodGhpcy5uYW1lKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCWlmICh0eXBlb2Yoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgPT09ICJ1bmRlZmluZWQiIHx8IHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQkJCWF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsKCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiA9IHsKCQkJCQkJCU93bmVyOiB0aGlzLAoJCQkJCQkJc3FsczogW10sCgkJCQkJCQlzdGFydDogbmV3IERhdGUoKSwKCQkJCQkJCWVuZDogbnVsbAoJCQkJCQl9OwoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX21hbmFnZXJfc2V0ICYmIHRoaXMubWFuYWdlcigpICYmICEoYXdhaXQgdGhpcy5tYW5hZ2VyKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfbWFuYWdlcigpOwoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9kZXBhcnRtZW50X1VzZXJzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuZGVwYXJ0bWVudF9Vc2VycygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBpbnNlcnQoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5EZXBhcnRtZW50Lmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl0aGlzLl9mcm9tRG9jdW1lbnQoYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlsZXQgb2JqID0ge307CgoJCQkJaWYgKHRoaXMuX21hbmFnZXJfc2V0KSB7CgoJCQkJCW9iai5tYW5hZ2VyID0gdGhpcy5fbWFuYWdlci5JZDsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9zZXQpIHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9lbmFibGVkX3NldCkgewoKCQkJCQlvYmouZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fY29kZV9zZXQpIHsKCgkJCQkJb2JqLmNvZGUgPSB0aGlzLmNvZGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX29yZGVyX3NldCkgewoKCQkJCQlvYmoub3JkZXIgPSB0aGlzLm9yZGVyKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9kYXRlX3NldCkgewoKCQkJCQlvYmouZGF0ZSA9IHRoaXMuZGF0ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fbmFtZV9zZXQpIHsKCgkJCQkJb2JqLm5hbWUgPSB0aGlzLm5hbWUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX3JlbWFya19zZXQpIHsKCgkJCQkJb2JqLnJlbWFyayA9IHRoaXMucmVtYXJrKCk7CgoJCQkJfQoKCQkJCWxvZygiU2VuZGluZyB0byBTRiIsIG9iaik7CgoJCQkJbGV0IHJlcyA9IGF3YWl0IHRoaXMuVG9vbC5kYi5zb2JqZWN0KCJEZXBhcnRtZW50IikuY3JlYXRlKG9iaik7CgkJCQl0aGlzLklkID0gcmVzLmlkOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuRGVwYXJ0bWVudC51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1VwZGF0ZVNRTCgpKTsKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTCgpKTsKCQkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IHJldFswXTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkRlcGFydG1lbnQuZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCB7CgkJCQkJc3lzcGFybV9xdWVyeTogT2JqZWN0LmVudHJpZXModGhpcy5fdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykpLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKQoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIHRydWUpLCBudWxsLCB7CgkJCQkJdXJsOiAncmVzdC51cmwuZ3FsJwoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCk7CgkJCQlyZXQgPSByZXQuY29udGVudCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5EZXBhcnRtZW50KG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuUHJpb3JpdHkgPSBjbGFzcyBQcmlvcml0eSBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFzS2k1ZmNtVnpkQ3dxTGw5c2IyRmtWRzl2YkhNaWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc2V5SnVZVzFsSWpvaVUwNVBWMDlQUWlJc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaWZYMHNJbE5oYkdWelJtOXlZMlVpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgkJdGhpcy5jbGVhcl9wcmlvcml0eV9JbmNpZGVudHMoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJQcmlvcml0eSIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJLy8gKHRoaXMucHJpb3JpdHlfSW5jaWRlbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJVEhJUyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsKCQlpZiAoIXYpIHJldHVybiB0aGlzOwoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCQl0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KSA9PT0gJ29iamVjdCcgJiYgX3YuRW50aXR5Q2xhc3MgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSA9PSB0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGUgPT0gdGhpcy5TY29wZSk7CgkJaWYgKGNvKSB0aGlzLl9USElTX2Nvb3AgPSBjbzsKCQlyZXR1cm4gdGhpczsKCX0KCgljbGVhcl9USElTKCkgewoJCXRoaXMuX1RISVMgPSBbXTsKCQl0aGlzLl9USElTX2Nvb3AgPSAnJzsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHByaW9yaXR5X0luY2lkZW50cyAqKi8KCXByaW9yaXR5X0luY2lkZW50cyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICdkNzVkNTAwZC0yZjc1LTRlNjEtYjNhNS1kNDU5ZmUyNjI0YzQnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0luY2lkZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9wcmlvcml0eV9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdwcmlvcml0eV9JbmNpZGVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgInByaW9yaXR5IGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJJbmNpZGVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3ByaW9yaXR5X0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAicHJpb3JpdHkgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJJbmNpZGVudCIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5wcmlvcml0eSh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9wcmlvcml0eV9JbmNpZGVudHMucHVzaCguLi52KTsKCQl0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfcHJpb3JpdHlfSW5jaWRlbnRzKCkgewoJCXRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19zZXQgPSBudWxsOwoJCXRoaXMuX3ByaW9yaXR5X0luY2lkZW50cyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHByaW9yaXR5X0luY2lkZW50cyAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX2FjdGl2ZV9zZXQsCgoJCQl0aGlzLl9lbmFibGVkX3NldCwKCgkJCXRoaXMuX2NvZGVfc2V0LAoKCQkJdGhpcy5fb3JkZXJfc2V0LAoKCQkJdGhpcy5fZGF0ZV9zZXQsCgoJCQl0aGlzLl9uYW1lX3NldCwKCgkJCXRoaXMuX3JlbWFya19zZXQsCgoJCQl0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5wcmlvcml0eV9JbmNpZGVudHMgPSB0aGlzLnByaW9yaXR5X0luY2lkZW50cygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJcHJpb3JpdHlfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncHJpb3JpdHlfUHJpb3JpdHlzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX3RvSGFzaCIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMuTm9Db2RlID8gb0hhc2ggOiB0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7Cgl9CgoJYXN5bmMgX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOwoKCX0KCglfcWxTZWxlY3Rpb25zKHNTZXQpIHsKCQlsZXQgcmV0ID0gW107CgkJaWYgKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7CgoJCXNTZXQuc2VsZWN0aW9ucy5maWx0ZXIocyA9PiBzLnNlbGVjdGlvblNldCkuZm9yRWFjaChzID0+IHsKCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpICE9ICdQcmlvcml0eScpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCXJldHVybiBuZXcgc2FsZXNub3dbZXZlbnQuY2xhc3NOYW1lKCldKCkuX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdyk7CgkJCX0KCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9Qcmlvcml0eS8ke21ldGhvZH1gLCBkYXRhLCBjb25maWcpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQl9CgkJfSBlbHNlIHsKCgkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMuX19nZW5lcmF0ZWQ7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMub25saW5lOwoKCQkJfQoKCQkJLy93aHkgZG8gd2UgbmVlZCB0aGlzPz8/CgoJCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQkJdHJ5IHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHttZXRob2R9YCk7CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJbGV0IF9pZCA9IG51bGw7CgkJCQlpZiAodHlwZW9mKGRhdGEpID09PSAndW5kZWZpbmVkJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIGRhdGEsIG1ldGhvZCwge30pOwoJCQkJCXJldHVybiBkYXRhOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoZGF0YSkgPT09ICdzdHJpbmcnKSB7CgkJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShkYXRhKTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gZGF0YS5fX3RoaXMuY29kZSB8fCBkYXRhLmlkIHx8IGRhdGEuSUQ7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQkJaWYgKGRhdGEuSWQgJiYgZGF0YS5JZCA9PSBkYXRhLklkKSB7CgkJCQkJCV9pZCA9IGRhdGEuSWQ7CgkJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCQl9IGVsc2UgaWYgKGRhdGEuRW50aXR5Q2xhc3MpIHsKCQkJCQkJX2lkID0gZGF0YS5FbnRpdHlDbGFzcy5JZCB8fCBkYXRhLkVudGl0eUNsYXNzLk5hbWU7CgkJCQkJfSBlbHNlIHsKCQkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiZDZhMTE4ZjctMDQzNy00OThlLWJmODEtMjc5YmQ1YjcxZDU3IiB8fCAiTlVMTCI7CgkJCQkJfQoJCQkJfQoKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHkgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W21ldGhvZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W21ldGhvZF0gfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W21ldGhvZF1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbbWV0aG9kXVtfaWRdIHx8IHt9OwoKCQkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaCh7fSwgewoJCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCQl9KTsKCgkJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVttZXRob2RdW19pZF1bX2hhc2hdOwoJCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiA1KSkgewoJCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gbWV0aG9kIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJCXYucmV1c2VkKys7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhKTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbbWV0aG9kXVtfaWRdW19oYXNoXSA9IHsKCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeSh7fSksCgkJCQkJb2JqOiBkYXRhLAoJCQkJCXJldXNlZDogMCwKCQkJCX07CgkJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZGF0YSwgbWV0aG9kLCB7fSwgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBUcmlnZ2VycmluZyAke21ldGhvZH0gdG8gJHtuLmNvZGUoKX0gJHtKU09OLnN0cmluZ2lmeShkYXRhLG51bGwsNCl9YCk7CgoJCQlsZXQgZXYgPSBuZXcgc2FsZXNub3cuRXZlbnQoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSh0aGlzLl9fY29uZmlnKCdldmVudCcpIHx8ICdzYWxlc25vdy5FdmVudCcpLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnJlY2lwaWVudChuKS5tZXRob2QobWV0aG9kKS5jbGFzc05hbWUoJ1ByaW9yaXR5Jykuc2VuZGVyKHNhbGVzbm93Ll9ub2RlKS5jYXJyaWVyKHNhbGVzbm93Ll9ub2RlKS5wYXlsb2FkKGRhdGEpOwoJCQlpZiAoZXZlbnQpIHsKCQkJCWlmIChldmVudC5fcmVzcG9uc2VUb19zZXQpIGV2LnJlc3BvbnNlVG8oZXZlbnQucmVzcG9uc2VUbygpKTsKCQkJCWlmIChldmVudC5fc2VuZGVyX3NldCkgZXYuc2VuZGVyKGV2ZW50LnNlbmRlcigpKTsKCQkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCkgZXYuY2xhc3NOYW1lKGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCWlmIChldmVudC5fY2Fycmllcl9zZXQgfHwgZXZlbnQuX3NlbmRlcl9zZXQpIGV2LmNhcnJpZXIoZXZlbnQuY2FycmllcigpIHx8IGV2ZW50LnNlbmRlcigpKTsKCQkJfQoJCQlyZXQgPSBhd2FpdCBldi50cmlnZ2VyKCk7CgoJCQlpZiAodHlwZW9mKHJldCkgPT09ICJzdHJpbmciKSB7CgkJCQl0cnkgewoJCQkJCXJldCA9IEpTT04ucGFyc2UocmV0KTsKCQkJCX0gY2F0Y2ggKGV4KSB7fQoJCQl9CgkJCXJldHVybiByZXQ7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5zZXJ0IjoKCQkJY2FzZSAidXBkYXRlIjoKCQkJY2FzZSAic3RvcmUiOgoJCQljYXNlICJkZWxldGUiOgoJCQljYXNlICJmaW5kIjogewoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuUHJpb3JpdHkobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93LlByaW9yaXR5KG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX25vZGUpIHsKCQkJLy8gcHJvYmFibHkgc2hvdWxkIG5vdCBiZSBwcm9jZXNzZWQgaGVyZSwgYnV0IHJhdGhlciBjb25zdW1lZCBhcyBwYXJ0IG9mIHRoZSBleGVjdXRlKCkgbG9naWMsIHB1c2hpbmcgX19ub2RlIHRvIHRoZSBsaXN0IG9mIG15IG5vZGVzIHRvIGRlbGVnYXRlIHRvIT8KCQkJbGV0IHRuID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX19ub2RlKS5fZGVSZWZlcmVuY2UoKTsKCQkJZGVsZXRlIF9wYXJhbXMuX19ub2RlOwoJCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlByaW9yaXR5KCkuX2ludm9rZU5vZGUodG4sIG1ldGhvZCwgX3BhcmFtcyk7CgkJfQoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBQcmlvcml0eS5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYFByaW9yaXR5Ll9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQlpZiAoZmFsc2UgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCXJldCA9IHsKCQkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCQknLTQnOiAiVW5jb21taXR0ZWQgdHJhbnNhY3Rpb25zOiAiICsgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5zcWxzLmxlbmd0aCwKCQkJCQkJJ29iaic6IG9iagoJCQkJCX0KCQkJCX0KCQkJfQoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5Ll90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93LlByaW9yaXR5LicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJX3BhcnNlQ29kZVN0YXRlKHQpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3BhcnNlQ29kZVN0YXRlKHQpOwoKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIlByaW9yaXR5Iik7CgoJfQoKCV9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4ID0gJ3t7JywgcG9zdGZpeCA9ICd9fScpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXgsIHBvc3RmaXgpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQkvLyB0aGlzLnByaW9yaXR5X1ByaW9yaXR5cygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlByaW9yaXR5KHRoaXMuSWQpCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5jb2RlKHRoaXMuY29kZSgpLCB0aGlzLl9jb2RlX2Nvb3ApCgoJCQkub3JkZXIodGhpcy5vcmRlcigpLCB0aGlzLl9vcmRlcl9jb29wKQoKCQkJLmRhdGUodGhpcy5kYXRlKCksIHRoaXMuX2RhdGVfY29vcCkKCgkJCS5uYW1lKHRoaXMubmFtZSgpLCB0aGlzLl9uYW1lX2Nvb3ApCgoJCQkucmVtYXJrKHRoaXMucmVtYXJrKCksIHRoaXMuX3JlbWFya19jb29wKQoKCQkJLnByaW9yaXR5X0luY2lkZW50cyh0aGlzLnByaW9yaXR5X0luY2lkZW50cygpLCB0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQkvL29iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkvL29ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdQcmlvcml0eSc7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoJCWNvZGVUeXBlID0gY29kZVR5cGUgfHwgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZTMwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pW2NvZGVdOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJQcmlvcml0eSI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMgPSB7fSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX2NvbmZpZyhuLCBudWxsVmFsdWUsIE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMgfHwge30sIHsKCQkJX2NsYXNzOiAnUHJpb3JpdHknCgkJfSkpOwoKCX0KCglhc3luYyBfcmVzdCh0TmFtZSA9IHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKHVuZGVmaW5lZCwgdGhpcy5Ub29sKS5fcmVzdCh0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyk7CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qUHJpb3JpdHkqLyk7XG4nOwoKCQlyZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiB0cnVlLAoJCQlOdWxsOiB0cnVlLAoJCQkvL0lkOiAob2JqLCB2KSA9PiBvYmouc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWWAsCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJcHJpb3JpdHlfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncHJpb3JpdHlfUHJpb3JpdHlzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJfSwgIl90b1NRTFRhYmxlIik7CgoJCS8vIHJldC5zcWwgKz0gJy8qUHJpb3JpdHkqLyk7XG4nOwoKCQlyZXQuc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChyZXQuc3FsKSA6IHJldC5zcWw7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NRTFRhYmxlJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldC5zcWwpOwoJCXJldHVybiByZXQuc3FsOwoJfQoKCV9mcm9tU1FMVGFibGUodGFibGUsIGZpZWxkcykgewoJCS8vIHRhYmxlIGlzIGEganNvbiBhcnJheQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5hY3RpdmUodGFibGVbImFjdGl2ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5lbmFibGVkKHRhYmxlWyJlbmFibGVkIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvZGUodGFibGVbImNvZGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9yZGVyKHRhYmxlWyJvcmRlciJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5kYXRlKHRhYmxlWyJkYXRlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm5hbWUodGFibGVbIm5hbWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5yZW1hcmsodGFibGVbInJlbWFyayJdKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIF9zcWwoc3FsLCBzb3VyY2UgPSB0aGlzKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWwoc3FsLCB0aGlzKTsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCBiU3RyaW5nKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoewoJCQlbdGhpcy5fbkNvZGUoKV06IHsKCQkJCXBhcmFtczogewoJCQkJCXdoZXJlOiB7CgkJCQkJCWFuZDogW10sCgkJCQkJCW9yOiBbXQoJCQkJCX0KCQkJCX0sCgkJCQllZGdlczogewoJCQkJCW5vZGU6IHt9CgkJCQl9CgkJCX0KCQl9LCB7CgkJCS8vT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaCh7CgkJCQlJZDogewoJCQkJCWVxOiB2CgkJCQl9CgkJCX0pLAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQkodiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGwpCgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJfSwgIl90b1NGUXVlcnkiKTsKCgkJLy9PYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJaWYgKGJTdHJpbmcpIHsKCQkJcmV0ID0gewoJCQkJcXVlcnk6IHsKCQkJCQlbdGhpcy5fbkNvZGUoKSArICdRdWVyeSddOiB7CgkJCQkJCXVpYXBpOiByZXQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXJldCA9IEpTT04uc3RyaW5naWZ5KHJldCwgbnVsbCwgNCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TRlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9iai5zeXNfaWQgPSB2LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCWxldCBkID0gYCR7di5nZXRGdWxsWWVhcigpfS0keygnMCcrKHYuZ2V0TW9udGgoKSsxKSkuc2xpY2UoLTIpfS0ke3YuZ2V0RGF0ZSgpfWA7CgkJCQlsZXQgdCA9IGAke3YuZ2V0SG91cnMoKX06JHt2LmdldE1pbnV0ZXMoKX06JHt2LmdldFNlY29uZHMoKX1gOwoJCQkJaWYgKCh2LmdldEhvdXJzKCkgPT0gMCAmJiB2LmdldE1pbnV0ZXMoKSA9PSAwICYmIHYuZ2V0U2Vjb25kcygpID09IDApIHx8IHRoaXMuX2RhdGVfY29vcCA9PSAnPScgfHwgIXRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9ialtlYUNvZGVdID0gYE9OJHtkfUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ3N0YXJ0JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdlbmQnKWA7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX2RhdGVfY29vcCAhPT0gJ0JFVFdFRU4nKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQl9LCAiX3RvU05RdWVyeSIpOwoKCQlPYmplY3Qua2V5cyhyZXQuT1BFUkFUT1JTIHx8IHt9KS5maWx0ZXIoayA9PiB0eXBlb2YocmV0W2tdKSAhPT0gJ3VuZGVmaW5lZCcpLmZvckVhY2goayA9PiByZXRba10gPSByZXQuT1BFUkFUT1JTW2tdICsgcmV0W2tdKTsKCgkJZGVsZXRlIHJldC5PUEVSQVRPUlM7CgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCXJldCA9IERvdE9iamVjdC5kb3QocmV0KTsKCgkJLy8gYXZvaWQgc2VuZGluZyB3aXRoIG5vIGNvbXBhcmlzb24gb3BlcmF0b3JzCgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhWyc+JywgJzwnLCAnQkVUV0VFTicsICdPTicsICchJywgJz0nLCAnU1RBUlRTV0lUSCcsICdMSUtFJ10uc29tZShzID0+IFN0cmluZyhyZXRba10pLnN0YXJ0c1dpdGgocykpKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gKHRoaXNbYF8ke2t9X2Nvb3BgXSB8fCAnU1RBUlRTV0lUSCcpICsgcmV0W2tdKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCBPYmplY3QuZW50cmllcyhyZXQgfHwge30pLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlsZXQgX3JldCA9IG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgZmFsc2UsIGZ1biwgZWFPYmosIG9iaik7CgkJCQlyZXR1cm4gX3JldDsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgImQ2YTExOGY3LTA0MzctNDk4ZS1iZjgxLTI3OWJkNWI3MWQ1NyIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHkgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlfb3B0aW9ucygicHJpb3JpdHlfSW5jaWRlbnRzIiwgb2JqLCB0aGlzLnByaW9yaXR5X0luY2lkZW50cygpKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3ByaW9yaXR5X0luY2lkZW50cyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgdHJ1ZSwgZnVuLCBvYmosIG9iaik7CgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgImQ2YTExOGY3LTA0MzctNDk4ZS1iZjgxLTI3OWJkNWI3MWQ1NyIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHkgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUHJpb3JpdHlbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlByaW9yaXR5W2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Qcmlvcml0eVtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJwcmlvcml0eV9JbmNpZGVudHMiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsncHJpb3JpdHlfSW5jaWRlbnRzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RCT2JqZWN0KGZpZWxkcywgYk5vUmVmKSB7CgkJaWYgKCF0aGlzLklkKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJJbnZhbGlkIElEIiwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lLCB0aGlzLlRvb2wpOwoJCX0KCQlsZXQgcmV0ID0gewoJCQlbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldOiAiJyIgKyB0aGlzLklkICsgIiciCgkJfTsKCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fYWN0aXZlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2VuYWJsZWRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9jb2RlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNvZGUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9vcmRlcl9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5vcmRlcigpOwoKCQkJZlZhbHVlID0gdiB8fCAnMCc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9kYXRlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmRhdGUoKTsKCgkJCXRyeSB7CgkJCQlmVmFsdWUgPSAiJyIgKyAodiA/IHYudG9JU09TdHJpbmcoKSA6ICIxOTcwLTEtMSIpICsgIiciOwoJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnKSB7CgkJCQkJZlZhbHVlID0gYFNUUl9UT19EQVRFKCR7ZlZhbHVlfSwgJyVZLSVtLSVkVCVULiVmWicpYDsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gJ2RhdGV0aW1lKCcgKyBmVmFsdWUgKyAnKSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX25hbWVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMubmFtZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9yZW1hcmtfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucmVtYXJrKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9RKCkgewoJCWxldCBfbyA9ICciJzsKCQlsZXQgX3EgPSBfbzsKCgkJaWYgKFsnU2FsZXNGb3JjZSddLmluZGV4T2YodGhpcy5Ub29sLnR5cGUubmFtZSkgPT0gMCkgewoJCQlfbyA9IF9xID0gIiI7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJyB8fCB0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIHsKCQkJX28gPSBfcSA9ICdgJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3Fsc2VydmVyJykgewoJCQlfbyA9ICdbJzsKCQkJX3EgPSAnXSc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCdhcGlLZXknKSA9PSAnYWlydGFibGUnKSB7CgkJCV9vID0gJ3snOwoJCQlfcSA9ICd9JzsKCQl9CgkJdGhpcy5fX1EgPSB0aGlzLl9fUSA9PSBfbyA/IF9xIDogX287CgkJcmV0dXJuIHRoaXMuX19ROwoJfQoKCV9maWVsZEdyb3VwcyhmZ3MgPSB7fSkgewoJCXRoaXMuX19maWVsZEdyb3VwcyA9IGZnczsKCQlyZXR1cm4gdGhpczsKCX0KCglfZmllbGRBZ2dyZWdhdGVzKGZhcyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkQWdncmVnYXRlcyA9IGZhczsKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9GaWVsZHNTUUwoZmllbGRzKSB7CgoJCWZpZWxkcyA9IGZpZWxkcyB8fCBbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyksIHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpXTsKCQlmaWVsZHMgPSBBcnJheS5pc0FycmF5KGZpZWxkcykgPyBmaWVsZHMgOiBbZmllbGRzXTsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQkvLyB7ZmllbGQ6IG9yZGVyfQoJCQlmaWVsZHMgPSBbXTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX1gKTsKCgkJfQoJCXJldHVybiBmaWVsZHM7Cgl9CgoJX2Zyb21EQk9iamVjdChyID0ge30pIHsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5fX2ltcG9ydChyLCB7CgkJCQlJZDogb2JqID0+IHRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldLAoKCQkJCWFjdGl2ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmFjdGl2ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZW5hYmxlZChvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuY29kZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5vcmRlcihvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZGF0ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMubmFtZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnJlbWFyayhvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJfSwgIl9mcm9tREJPYmplY3QiKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX3RvU2VsZWN0SGVhZGVyKGZpZWxkcykgewoJCWxldCByZXQgPSB7CgkJCXRhYmxlOiB0aGlzLl9uQ29kZSgpLAoJCQlmaWVsZHM6IERvdE9iamVjdC5vYmplY3QoT2JqZWN0LmZyb21FbnRyaWVzKHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLm1hcChmID0+IFtmLCBmXSkpKSwKCQkJam9pbnM6IHt9LAoJCX07CgoJCWlmIChmaWVsZHMpIHJldHVybiByZXQ7CgoJCXJldC5qb2lucyA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJTnVsbDogdHJ1ZSwKCgkJfSwgIl90b1NlbGVjdEhlYWRlciIpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RIZWFkZXInLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9TZWxlY3RTUUwoZmllbGRzKSB7CgkJbGV0IHNxbCA9ICJzZWxlY3QgIjsKCgkJbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX1gOwoKCQlsZXQgaGVhZGVyID0gdGhpcy5fdG9TZWxlY3RIZWFkZXIoZmllbGRzKTsKCgkJc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOwoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOwoKCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcykgewoJCQkvLyB7ZmllbGQ6IGZ1bmN0aW9ufQoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jb2RlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fb3JkZXJfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vcmRlcl9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9kYXRlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LnRvSVNPU3RyaW5nKSB7CgkJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3FsaXRlJykgewoJCQkJCQlvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbmFtZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX25hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3JlbWFya19zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJcHJpb3JpdHlfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncHJpb3JpdHlfUHJpb3JpdHlzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJwcmlvcml0eS5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX3ByaW9yaXR5X0luY2lkZW50c19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLypwcmlvcml0eV9JbmNpZGVudHMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCX0sICJfdG9TZWxlY3RTUUwiLCBmaWVsZHMpLnNxbDsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQlpZiAoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jb2RlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMub3JkZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZGF0ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5uYW1lfWA7CgoJCX0KCgkJaWYgKHNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpIHsKCQkJLy8gc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSIsICJ3aGVyZSAxPTAiKTsKCQl9IGVsc2UgewoJCQlzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7CgkJfQoKCQlzcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCkgOiBzcWw7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgoJCXJldHVybiBzcWw7Cgl9CgoJX3RvUGF0aHMoKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJX1RISVM6IG9iaiA9PiB7fSwKCgkJCXByaW9yaXR5X0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3ByaW9yaXR5X1ByaW9yaXR5cycsIHVuZGVmaW5lZCkpID0+IG9iai5wcmlvcml0eV9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJfSwgIl90b1BhdGhzIik7CgkJLy8gcmV0dXJuIHJldDsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5tYXAoayA9PiAoewoJCQlba106IHJldFtrXQoJCX0pKTsKCX0KCglfdG9VcGRhdGVTUUwoZmllbGRzKSB7CgkJbGV0IHJldEZpZWxkcyA9IHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLmpvaW4oJywgJyk7CgkJbGV0IHNxbCA9IGB1cGRhdGUgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSBzZXQgYCArIE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvREJPYmplY3QoZmllbGRzKSkubWFwKHYgPT4gdGhpcy5fUSgpICsgdlswXSArIHRoaXMuX1EoKSArICI9IiArIHZbMV0pICsgYCB3aGVyZSAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgOyAvL2AgcmV0dXJuaW5nICR7cmV0RmllbGRzfWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvVXBkYXRlU1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfdG9JbnNlcnRTUUwoZmllbGRzKSB7CgkJbGV0IG9iaiA9IHRoaXMuX3RvREJPYmplY3QoZmllbGRzKTsKCQlsZXQgc3FsID0gYGluc2VydCBpbnRvICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKGAgKyBPYmplY3Qua2V5cyhvYmopLm1hcChrID0+IHRoaXMuX1EoKSArIGsgKyB0aGlzLl9RKCkpICsgIikgdmFsdWVzICgiICsgT2JqZWN0LnZhbHVlcyhvYmopICsgYClgOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0luc2VydFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5Qcmlvcml0eSkgcmV0dXJuOwoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5Qcmlvcml0eSA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCBzcWwgPSBuZXcgc2FsZXNub3cuUHJpb3JpdHkoKQoKCQkJCQkucHJpb3JpdHlfSW5jaWRlbnRzKG5ldyBzYWxlc25vdy5JbmNpZGVudCgpKQoKCQkJCQkuX3RvU1FMVGFibGUoZGVwdGgpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQkJCWF3YWl0IHRoaXMuX3NxbChzcWwpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIlByaW9yaXR5IikgcmV0dXJuIGZhbHNlOwoKCQkJbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJCUZ1bGw6IHRydWUsCgkJCQlOdWxsOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5faWQgPSB0aGlzLklkID09IHF1ZXJ5LklkLAoKCQkJCWFjdGl2ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouYWN0aXZlID0gdiA9PSBxdWVyeS5hY3RpdmUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fYWN0aXZlX3NldCAmJiAhcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2FjdGl2ZV9zZXQgJiYgcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5lbmFibGVkID0gdiA9PSBxdWVyeS5lbmFibGVkKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ICYmICFxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9lbmFibGVkX3NldCAmJiBxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY29kZSA9IHYgPT0gcXVlcnkuY29kZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jb2RlX3NldCAmJiAhcXVlcnkuX2NvZGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY29kZV9zZXQgJiYgcXVlcnkuX2NvZGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vcmRlciA9IHYgPT0gcXVlcnkub3JkZXIoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fb3JkZXJfc2V0ICYmICFxdWVyeS5fb3JkZXJfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX29yZGVyX3NldCAmJiBxdWVyeS5fb3JkZXJfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IGZhbHNlOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5kYXRlID0gdiA9PSBxdWVyeS5kYXRlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2RhdGVfc2V0ICYmICFxdWVyeS5fZGF0ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9kYXRlX3NldCAmJiBxdWVyeS5fZGF0ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoubmFtZSA9IHYgPT0gcXVlcnkubmFtZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9uYW1lX3NldCAmJiAhcXVlcnkuX25hbWVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbmFtZV9zZXQgJiYgcXVlcnkuX25hbWVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gZmFsc2U7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucmVtYXJrID0gdiA9PSBxdWVyeS5yZW1hcmsoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcmVtYXJrX3NldCAmJiAhcXVlcnkuX3JlbWFya19zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3JlbWFya19zZXQgJiYgcXVlcnkuX3JlbWFya19zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IGZhbHNlOwoJCQkJfSwKCgkJCQlwcmlvcml0eV9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoucHJpb3JpdHlfSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gcXVlcnkucHJpb3JpdHlfSW5jaWRlbnRzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoZXMiKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDAsIG9NYXRjaCk7CgoJCQlyZXR1cm4gT2JqZWN0LmtleXMob01hdGNoKS5ldmVyeShrID0+IG9NYXRjaFtrXSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfbWF0Y2hpbmcocXVlcnkpIHsKCQl0cnkgewoJCQlsZXQgcmV0ID0gW107CgoJCQlsZXQgbWF0Y2hlcyA9IHRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlwcmlvcml0eV9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoucHJpb3JpdHlfSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXByaW9yaXR5X0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLnByaW9yaXR5X0luY2lkZW50cygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV07CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJcHJpb3JpdHlfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncHJpb3JpdHlfUHJpb3JpdHlzJywgdW5kZWZpbmVkKSA6ICJwcmlvcml0eV9JbmNpZGVudHMiKSkgPT4gdGhpcy5wcmlvcml0eV9JbmNpZGVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0gPSB2LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQkJcHJpb3JpdHlfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncHJpb3JpdHlfUHJpb3JpdHlzJywgdW5kZWZpbmVkKSA6ICJwcmlvcml0eV9JbmNpZGVudHMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9wcmlvcml0eV9JbmNpZGVudHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fZmxpcCgpICovCglfZmxpcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmxpcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9mbGlwKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gZmFsc2U7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Qcmlvcml0eS5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuUHJpb3JpdHkobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLmNvZGUodGhpcy5jb2RlKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCWlmICh0eXBlb2Yoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgPT09ICJ1bmRlZmluZWQiIHx8IHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQkJCWF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsKCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiA9IHsKCQkJCQkJCU93bmVyOiB0aGlzLAoJCQkJCQkJc3FsczogW10sCgkJCQkJCQlzdGFydDogbmV3IERhdGUoKSwKCQkJCQkJCWVuZDogbnVsbAoJCQkJCQl9OwoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBGaW5pc2hlZCBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0gSWQ9WyR7dGhpcy5JZH1dYCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fcHJpb3JpdHlfSW5jaWRlbnRzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMucHJpb3JpdHlfSW5jaWRlbnRzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQkJaWYgKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uT3duZXIgPT0gdGhpcykgewoJCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGBDT01NSVQke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/JyBUUkFOU0FDVElPTic6Jyd9YCk7CgkJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCA9IG5ldyBEYXRlKCk7CgkJCQkJCX0KCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlByaW9yaXR5Lmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl0aGlzLl9mcm9tRG9jdW1lbnQoYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlsZXQgb2JqID0ge307CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9zZXQpIHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9lbmFibGVkX3NldCkgewoKCQkJCQlvYmouZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fY29kZV9zZXQpIHsKCgkJCQkJb2JqLmNvZGUgPSB0aGlzLmNvZGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX29yZGVyX3NldCkgewoKCQkJCQlvYmoub3JkZXIgPSB0aGlzLm9yZGVyKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9kYXRlX3NldCkgewoKCQkJCQlvYmouZGF0ZSA9IHRoaXMuZGF0ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fbmFtZV9zZXQpIHsKCgkJCQkJb2JqLm5hbWUgPSB0aGlzLm5hbWUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX3JlbWFya19zZXQpIHsKCgkJCQkJb2JqLnJlbWFyayA9IHRoaXMucmVtYXJrKCk7CgoJCQkJfQoKCQkJCWxvZygiU2VuZGluZyB0byBTRiIsIG9iaik7CgoJCQkJbGV0IHJlcyA9IGF3YWl0IHRoaXMuVG9vbC5kYi5zb2JqZWN0KCJQcmlvcml0eSIpLmNyZWF0ZShvYmopOwoJCQkJdGhpcy5JZCA9IHJlcy5pZDsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlByaW9yaXR5LnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvVXBkYXRlU1FMKCkpOwoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKCkpOwoJCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0WzBdOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuUHJpb3JpdHkuZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCB7CgkJCQkJc3lzcGFybV9xdWVyeTogT2JqZWN0LmVudHJpZXModGhpcy5fdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykpLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKQoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIHRydWUpLCBudWxsLCB7CgkJCQkJdXJsOiAncmVzdC51cmwuZ3FsJwoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCk7CgkJCQlyZXQgPSByZXQuY29udGVudCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5Qcmlvcml0eShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93LlJlYXNvbiA9IGNsYXNzIFJlYXNvbiBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFzS2k1ZmNtVnpkQ3dxTGw5c2IyRmtWRzl2YkhNaWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc2V5SnVZVzFsSWpvaVUwNVBWMDlQUWlJc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaWZYMHNJbE5oYkdWelJtOXlZMlVpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgkJdGhpcy5jbGVhcl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiUmVhc29uIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQkvLyAodGhpcy5jbG9zZV9yZWFzb25fSW5jaWRlbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJVEhJUyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsKCQlpZiAoIXYpIHJldHVybiB0aGlzOwoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCQl0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KSA9PT0gJ29iamVjdCcgJiYgX3YuRW50aXR5Q2xhc3MgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSA9PSB0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGUgPT0gdGhpcy5TY29wZSk7CgkJaWYgKGNvKSB0aGlzLl9USElTX2Nvb3AgPSBjbzsKCQlyZXR1cm4gdGhpczsKCX0KCgljbGVhcl9USElTKCkgewoJCXRoaXMuX1RISVMgPSBbXTsKCQl0aGlzLl9USElTX2Nvb3AgPSAnJzsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNsb3NlX3JlYXNvbl9JbmNpZGVudHMgKiovCgljbG9zZV9yZWFzb25fSW5jaWRlbnRzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICdkNzVkNTAwZC0yZjc1LTRlNjEtYjNhNS1kNDU5ZmUyNjI0YzQnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0luY2lkZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9jbG9zZV9yZWFzb25fc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnY2xvc2VfcmVhc29uX0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAiY2xvc2VfcmVhc29uIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJJbmNpZGVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2Nsb3NlX3JlYXNvbl9JbmNpZGVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgImNsb3NlX3JlYXNvbiBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkluY2lkZW50Iik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LmNsb3NlX3JlYXNvbih0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzLnB1c2goLi4udik7CgkJdGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfY2xvc2VfcmVhc29uX0luY2lkZW50cygpIHsKCQl0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX3NldCA9IG51bGw7CgkJdGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50cyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjbG9zZV9yZWFzb25fSW5jaWRlbnRzICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJCXRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5jbG9zZV9yZWFzb25fSW5jaWRlbnRzID0gdGhpcy5jbG9zZV9yZWFzb25fSW5jaWRlbnRzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQljbG9zZV9yZWFzb25fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uX1JlYXNvbnMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkgIT0gJ1JlYXNvbicpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCXJldHVybiBuZXcgc2FsZXNub3dbZXZlbnQuY2xhc3NOYW1lKCldKCkuX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdyk7CgkJCX0KCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9SZWFzb24vJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQkJZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOwoJCQkJZGVsZXRlIGRhdGEuX190aGlzLm9ubGluZTsKCgkJCX0KCgkJCS8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/PwoKCQkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJCXRyeSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0pIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7bWV0aG9kfWApOwoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCWxldCBfaWQgPSBudWxsOwoJCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBkYXRhLCBtZXRob2QsIHt9KTsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRhdGEpID09PSAnc3RyaW5nJykgewoJCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUoZGF0YSk7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IGRhdGEuX190aGlzLmNvZGUgfHwgZGF0YS5pZCB8fCBkYXRhLklEOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJCWlmIChkYXRhLklkICYmIGRhdGEuSWQgPT0gZGF0YS5JZCkgewoJCQkJCQlfaWQgPSBkYXRhLklkOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQkJfSBlbHNlIGlmIChkYXRhLkVudGl0eUNsYXNzKSB7CgkJCQkJCV9pZCA9IGRhdGEuRW50aXR5Q2xhc3MuSWQgfHwgZGF0YS5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjdmOTcyOTFjLTIyZTQtNGM4My1iMmM1LWE0YTQzYzk1YmRiZSIgfHwgIk5VTEwiOwoJCQkJCX0KCQkJCX0KCgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uID0gc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb24gfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvblttZXRob2RdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW21ldGhvZF1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW21ldGhvZF1bX2lkXSB8fCB7fTsKCgkJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goe30sIHsKCQkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQkJfSk7CgoJCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bbWV0aG9kXVtfaWRdW19oYXNoXSA9IHsKCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeSh7fSksCgkJCQkJb2JqOiBkYXRhLAoJCQkJCXJldXNlZDogMCwKCQkJCX07CgkJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZGF0YSwgbWV0aG9kLCB7fSwgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBUcmlnZ2VycmluZyAke21ldGhvZH0gdG8gJHtuLmNvZGUoKX0gJHtKU09OLnN0cmluZ2lmeShkYXRhLG51bGwsNCl9YCk7CgoJCQlsZXQgZXYgPSBuZXcgc2FsZXNub3cuRXZlbnQoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSh0aGlzLl9fY29uZmlnKCdldmVudCcpIHx8ICdzYWxlc25vdy5FdmVudCcpLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnJlY2lwaWVudChuKS5tZXRob2QobWV0aG9kKS5jbGFzc05hbWUoJ1JlYXNvbicpLnNlbmRlcihzYWxlc25vdy5fbm9kZSkuY2FycmllcihzYWxlc25vdy5fbm9kZSkucGF5bG9hZChkYXRhKTsKCQkJaWYgKGV2ZW50KSB7CgkJCQlpZiAoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7CgkJCQlpZiAoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7CgkJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7CgkJCQlpZiAoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7CgkJCX0KCQkJcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOwoKCQkJaWYgKHR5cGVvZihyZXQpID09PSAic3RyaW5nIikgewoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChleCkge30KCQkJfQoJCQlyZXR1cm4gcmV0OwoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LlJlYXNvbihudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuUmVhc29uKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX25vZGUpIHsKCQkJLy8gcHJvYmFibHkgc2hvdWxkIG5vdCBiZSBwcm9jZXNzZWQgaGVyZSwgYnV0IHJhdGhlciBjb25zdW1lZCBhcyBwYXJ0IG9mIHRoZSBleGVjdXRlKCkgbG9naWMsIHB1c2hpbmcgX19ub2RlIHRvIHRoZSBsaXN0IG9mIG15IG5vZGVzIHRvIGRlbGVnYXRlIHRvIT8KCQkJbGV0IHRuID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX19ub2RlKS5fZGVSZWZlcmVuY2UoKTsKCQkJZGVsZXRlIF9wYXJhbXMuX19ub2RlOwoJCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlJlYXNvbigpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOwoJCX0KCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgUmVhc29uLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgUmVhc29uLl9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQlpZiAoZmFsc2UgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCXJldCA9IHsKCQkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCQknLTQnOiAiVW5jb21taXR0ZWQgdHJhbnNhY3Rpb25zOiAiICsgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5zcWxzLmxlbmd0aCwKCQkJCQkJJ29iaic6IG9iagoJCQkJCX0KCQkJCX0KCQkJfQoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbi5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5SZWFzb24uJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglfcGFyc2VDb2RlU3RhdGUodCkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyc2VDb2RlU3RhdGUodCk7CgoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiUmVhc29uIik7CgoJfQoKCV9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4ID0gJ3t7JywgcG9zdGZpeCA9ICd9fScpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXgsIHBvc3RmaXgpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQkvLyB0aGlzLmNsb3NlX3JlYXNvbl9SZWFzb25zKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuUmVhc29uKHRoaXMuSWQpCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5jb2RlKHRoaXMuY29kZSgpLCB0aGlzLl9jb2RlX2Nvb3ApCgoJCQkub3JkZXIodGhpcy5vcmRlcigpLCB0aGlzLl9vcmRlcl9jb29wKQoKCQkJLmRhdGUodGhpcy5kYXRlKCksIHRoaXMuX2RhdGVfY29vcCkKCgkJCS5uYW1lKHRoaXMubmFtZSgpLCB0aGlzLl9uYW1lX2Nvb3ApCgoJCQkucmVtYXJrKHRoaXMucmVtYXJrKCksIHRoaXMuX3JlbWFya19jb29wKQoKCQkJLmNsb3NlX3JlYXNvbl9JbmNpZGVudHModGhpcy5jbG9zZV9yZWFzb25fSW5jaWRlbnRzKCksIHRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQkvL29iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkvL29ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdSZWFzb24nOwoJCXRvb2wgPSB0b29sIHx8IHRoaXMuVG9vbDsKCQljb2RlVHlwZSA9IGNvZGVUeXBlIHx8IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGUzMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KVtjb2RlXTsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiUmVhc29uIjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucyA9IHt9KSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fY29uZmlnKG4sIG51bGxWYWx1ZSwgT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucyB8fCB7fSwgewoJCQlfY2xhc3M6ICdSZWFzb24nCgkJfSkpOwoKCX0KCglhc3luYyBfcmVzdCh0TmFtZSA9IHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKHVuZGVmaW5lZCwgdGhpcy5Ub29sKS5fcmVzdCh0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyk7CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qUmVhc29uKi8pO1xuJzsKCgkJcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogdHJ1ZSwKCQkJTnVsbDogdHJ1ZSwKCQkJLy9JZDogKG9iaiwgdikgPT4gb2JqLnNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVlgLAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCWNsb3NlX3JlYXNvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb25fUmVhc29ucycsIHVuZGVmaW5lZCkpID0+IG9iai5zcWwgPSB2Lm1hcChfdiA9PiBfdi5fdG9TUUxUYWJsZSgpKSArIG9iai5zcWwsCgoJCX0sICJfdG9TUUxUYWJsZSIpOwoKCQkvLyByZXQuc3FsICs9ICcvKlJlYXNvbiovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbChzcWwsIHRoaXMpOwoKCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIGJTdHJpbmcpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7CgkJCVt0aGlzLl9uQ29kZSgpXTogewoJCQkJcGFyYW1zOiB7CgkJCQkJd2hlcmU6IHsKCQkJCQkJYW5kOiBbXSwKCQkJCQkJb3I6IFtdCgkJCQkJfQoJCQkJfSwKCQkJCWVkZ2VzOiB7CgkJCQkJbm9kZToge30KCQkJCX0KCQkJfQoJCX0sIHsKCQkJLy9PUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKHsKCQkJCUlkOiB7CgkJCQkJZXE6IHYKCQkJCX0KCQkJfSksCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCSh2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbCkKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQl9LCAiX3RvU0ZRdWVyeSIpOwoKCQkvL09iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlpZiAoYlN0cmluZykgewoJCQlyZXQgPSB7CgkJCQlxdWVyeTogewoJCQkJCVt0aGlzLl9uQ29kZSgpICsgJ1F1ZXJ5J106IHsKCQkJCQkJdWlhcGk6IHJldAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJcmV0ID0gSlNPTi5zdHJpbmdpZnkocmV0LCBudWxsLCA0KTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NGUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqLnN5c19pZCA9IHYsCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJbGV0IGQgPSBgJHt2LmdldEZ1bGxZZWFyKCl9LSR7KCcwJysodi5nZXRNb250aCgpKzEpKS5zbGljZSgtMil9LSR7di5nZXREYXRlKCl9YDsKCQkJCWxldCB0ID0gYCR7di5nZXRIb3VycygpfToke3YuZ2V0TWludXRlcygpfToke3YuZ2V0U2Vjb25kcygpfWA7CgkJCQlpZiAoKHYuZ2V0SG91cnMoKSA9PSAwICYmIHYuZ2V0TWludXRlcygpID09IDAgJiYgdi5nZXRTZWNvbmRzKCkgPT0gMCkgfHwgdGhpcy5fZGF0ZV9jb29wID09ICc9JyB8fCAhdGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgT04ke2R9QGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9Jywnc3RhcnQnKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ2VuZCcpYDsKCQkJCX0gZWxzZSBpZiAodGhpcy5fZGF0ZV9jb29wICE9PSAnQkVUV0VFTicpIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0KCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCX0sICJfdG9TTlF1ZXJ5Iik7CgoJCU9iamVjdC5rZXlzKHJldC5PUEVSQVRPUlMgfHwge30pLmZpbHRlcihrID0+IHR5cGVvZihyZXRba10pICE9PSAndW5kZWZpbmVkJykuZm9yRWFjaChrID0+IHJldFtrXSA9IHJldC5PUEVSQVRPUlNba10gKyByZXRba10pOwoKCQlkZWxldGUgcmV0Lk9QRVJBVE9SUzsKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJcmV0ID0gRG90T2JqZWN0LmRvdChyZXQpOwoKCQkvLyBhdm9pZCBzZW5kaW5nIHdpdGggbm8gY29tcGFyaXNvbiBvcGVyYXRvcnMKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFbJz4nLCAnPCcsICdCRVRXRUVOJywgJ09OJywgJyEnLCAnPScsICdTVEFSVFNXSVRIJywgJ0xJS0UnXS5zb21lKHMgPT4gU3RyaW5nKHJldFtrXSkuc3RhcnRzV2l0aChzKSkpLmZvckVhY2goayA9PiByZXRba10gPSAodGhpc1tgXyR7a31fY29vcGBdIHx8ICdTVEFSVFNXSVRIJykgKyByZXRba10pOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIE9iamVjdC5lbnRyaWVzKHJldCB8fCB7fSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCWxldCBfcmV0ID0gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCBmYWxzZSwgZnVuLCBlYU9iaiwgb2JqKTsKCQkJCXJldHVybiBfcmV0OwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiN2Y5NzI5MWMtMjJlNC00YzgzLWIyYzUtYTRhNDNjOTViZGJlIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiBvYmosCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIG9iaiwgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIl9USElTIiwgb2JqLCB0aGlzLl9USElTKTsKCgkJX29wdGlvbnMoImNsb3NlX3JlYXNvbl9JbmNpZGVudHMiLCBvYmosIHRoaXMuY2xvc2VfcmVhc29uX0luY2lkZW50cygpKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ2Nsb3NlX3JlYXNvbl9JbmNpZGVudHMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIHRydWUsIGZ1biwgb2JqLCBvYmopOwoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI3Zjk3MjkxYy0yMmU0LTRjODMtYjJjNS1hNGE0M2M5NWJkYmUiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uID0gc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb24gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuUmVhc29uW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5SZWFzb25bZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlJlYXNvbltmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJjbG9zZV9yZWFzb25fSW5jaWRlbnRzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ2Nsb3NlX3JlYXNvbl9JbmNpZGVudHMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV06ICInIiArIHRoaXMuSWQgKyAiJyIKCQl9OwoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9hY3RpdmVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYWN0aXZlKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZW5hYmxlZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5lbmFibGVkKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvZGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29kZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2RhdGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZGF0ZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5uYW1lKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3JlbWFya19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5yZW1hcmsoKTsKCgkJCWZWYWx1ZSA9ICInIiArICgodiAmJiB2LnJlcGxhY2UpID8gdi5yZXBsYWNlKC9cJy9nLCAiXCdcJyIpIDogdikgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX1EoKSB7CgkJbGV0IF9vID0gJyInOwoJCWxldCBfcSA9IF9vOwoKCQlpZiAoWydTYWxlc0ZvcmNlJ10uaW5kZXhPZih0aGlzLlRvb2wudHlwZS5uYW1lKSA9PSAwKSB7CgkJCV9vID0gX3EgPSAiIjsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgewoJCQlfbyA9IF9xID0gJ2AnOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxzZXJ2ZXInKSB7CgkJCV9vID0gJ1snOwoJCQlfcSA9ICddJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ2FwaUtleScpID09ICdhaXJ0YWJsZScpIHsKCQkJX28gPSAneyc7CgkJCV9xID0gJ30nOwoJCX0KCQl0aGlzLl9fUSA9IHRoaXMuX19RID09IF9vID8gX3EgOiBfbzsKCQlyZXR1cm4gdGhpcy5fX1E7Cgl9CgoJX2ZpZWxkR3JvdXBzKGZncyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOwoJCXJldHVybiB0aGlzOwoJfQoKCV9maWVsZEFnZ3JlZ2F0ZXMoZmFzID0ge30pIHsKCQl0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOwoJCXJldHVybiB0aGlzOwoJfQoKCV90b0ZpZWxkc1NRTChmaWVsZHMpIHsKCgkJZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKSwgdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCldOwoJCWZpZWxkcyA9IEFycmF5LmlzQXJyYXkoZmllbGRzKSA/IGZpZWxkcyA6IFtmaWVsZHNdOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCS8vIHtmaWVsZDogb3JkZXJ9CgkJCWZpZWxkcyA9IFtdOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb2RlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5kYXRlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5uYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucmVtYXJrKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlOdWxsOiB0cnVlLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCX0KCgkJc3FsICs9IGAgZnJvbSAke3RQcmVmfSBgOwoKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gYGxlZnQgam9pbiAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX0ke3RoaXMuX1EoKX0gYXMgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0gb24gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtrfWlkJHt0aGlzLl9RKCl9PSR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGApOwoKCQlzcWwgKz0gYCB3aGVyZSAxPTFgOwoKCQlzcWwgPSB0aGlzLl9fZXhwb3J0KHsKCQkJc3FsOiBzcWwKCQl9LCB7CgkJCV9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgPyBbJ0lkJ10gOiB1bmRlZmluZWQsCgkJCU51bGw6IHRydWUsCgkJCV9USElTOiBvYmogPT4gewoJCQkJaWYgKCF0aGlzLl9USElTIHx8ICF0aGlzLl9USElTLmxlbmd0aCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCh0Ll9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnKSkuam9pbignIFVOSU9OIEFMTCAnKSArICIpIjsKCQkJfSwKCQkJSWQ6IG9iaiA9PiBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2AsCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvZGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2RhdGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVtYXJrX3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljbG9zZV9yZWFzb25fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uX1JlYXNvbnMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJjbG9zZV9yZWFzb24uaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX2Nsb3NlX3JlYXNvbl9JbmNpZGVudHNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19jb29wID09ICc9JyB8fCB0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLypjbG9zZV9yZWFzb25fSW5jaWRlbnRzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQl9LCAiX3RvU2VsZWN0U1FMIiwgZmllbGRzKS5zcWw7CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJaWYgKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWR9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuY29kZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMubmFtZX1gOwoKCQl9CgoJCWlmIChzcWwuZW5kc1dpdGgoIndoZXJlIDE9MSIpKSB7CgkJCS8vIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEiLCAid2hlcmUgMT0wIik7CgkJfSBlbHNlIHsKCQkJc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSBhbmQgIiwgIndoZXJlICIpOwoJCX0KCgkJc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpIDogc3FsOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoKCQlyZXR1cm4gc3FsOwoJfQoKCV90b1BhdGhzKCkgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCV9USElTOiBvYmogPT4ge30sCgoJCQljbG9zZV9yZWFzb25fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uX1JlYXNvbnMnLCB1bmRlZmluZWQpKSA9PiBvYmouY2xvc2VfcmVhc29uX0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQl9LCAiX3RvUGF0aHMiKTsKCQkvLyByZXR1cm4gcmV0OwoJCXJldHVybiBPYmplY3Qua2V5cyhyZXQpLm1hcChrID0+ICh7CgkJCVtrXTogcmV0W2tdCgkJfSkpOwoJfQoKCV90b1VwZGF0ZVNRTChmaWVsZHMpIHsKCQlsZXQgcmV0RmllbGRzID0gdGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkuam9pbignLCAnKTsKCQlsZXQgc3FsID0gYHVwZGF0ZSAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IHNldCBgICsgT2JqZWN0LmVudHJpZXModGhpcy5fdG9EQk9iamVjdChmaWVsZHMpKS5tYXAodiA9PiB0aGlzLl9RKCkgKyB2WzBdICsgdGhpcy5fUSgpICsgIj0iICsgdlsxXSkgKyBgIHdoZXJlICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2A7IC8vYCByZXR1cm5pbmcgJHtyZXRGaWVsZHN9YDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9VcGRhdGVTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV90b0luc2VydFNRTChmaWVsZHMpIHsKCQlsZXQgb2JqID0gdGhpcy5fdG9EQk9iamVjdChmaWVsZHMpOwoJCWxldCBzcWwgPSBgaW5zZXJ0IGludG8gJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoYCArIE9iamVjdC5rZXlzKG9iaikubWFwKGsgPT4gdGhpcy5fUSgpICsgayArIHRoaXMuX1EoKSkgKyAiKSB2YWx1ZXMgKCIgKyBPYmplY3QudmFsdWVzKG9iaikgKyBgKWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvSW5zZXJ0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlJlYXNvbikgcmV0dXJuOwoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5SZWFzb24gPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgc3FsID0gbmV3IHNhbGVzbm93LlJlYXNvbigpCgoJCQkJCS5jbG9zZV9yZWFzb25fSW5jaWRlbnRzKG5ldyBzYWxlc25vdy5JbmNpZGVudCgpKQoKCQkJCQkuX3RvU1FMVGFibGUoZGVwdGgpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQkJCWF3YWl0IHRoaXMuX3NxbChzcWwpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIlJlYXNvbiIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY2xvc2VfcmVhc29uX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5jbG9zZV9yZWFzb25fSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gcXVlcnkuY2xvc2VfcmVhc29uX0luY2lkZW50cygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJY2xvc2VfcmVhc29uX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5jbG9zZV9yZWFzb25fSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWNsb3NlX3JlYXNvbl9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5jbG9zZV9yZWFzb25fSW5jaWRlbnRzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb2RlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jb2RlKHJlZik7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3JkZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9yZGVyKHJlZik7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLmRhdGUocmVmKTsKCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9uYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5uYW1lKHJlZik7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVtYXJrX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5yZW1hcmsocmVmKTsKCgkJCX0sCgoJCQljbG9zZV9yZWFzb25fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uX1JlYXNvbnMnLCB1bmRlZmluZWQpIDogImNsb3NlX3JlYXNvbl9JbmNpZGVudHMiKSkgPT4gdGhpcy5jbG9zZV9yZWFzb25fSW5jaWRlbnRzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5JbmNpZGVudCgpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQl9LCAiX2Zyb21Eb2N1bWVudCIpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSB7CgkJbGV0IHJldCA9IHt9OwoKCQlpZiAoIWJUb29sKSB7CgkJCXJldC5fX2dlbmVyYXRlZCA9IG5ldyBEYXRlKCk7CgkJCWlmICh0aGlzLlRvb2wubmFtZSkgewoJCQkJcmV0Ll9fdG9vbCA9IHsKCQkJCQluYW1lOiB0aGlzLlRvb2wubmFtZSwKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlpZiAoc2FsZXNub3cuX25vZGUpIHsKCQkJCXJldC5fX25vZGUgPSB7CgkJCQkJY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogYkZ1bGwsCgkJCU51bGw6IGJOdWxsLAoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IChvYmosIHYpID0+IHsKCQkJCWlmIChiVG9vbCkgcmV0dXJuOwoJCQkJb2JqLlRISVMgPSB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQlvYmouT1BFUkFUT1JTLlRISVMgPSB0aGlzLl9USElTX2Nvb3A7CgkJCX0sCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldID0gdiwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCWNsb3NlX3JlYXNvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb25fUmVhc29ucycsIHVuZGVmaW5lZCkgOiAiY2xvc2VfcmVhc29uX0luY2lkZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2ZsaXAoKSAqLwoJX2ZsaXAoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9mbGlwKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fZmxpcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuX25hbWU7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IGZhbHNlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuUmVhc29uLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5SZWFzb24obnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLmNvZGUodGhpcy5jb2RlKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCWlmICh0eXBlb2Yoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgPT09ICJ1bmRlZmluZWQiIHx8IHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQkJCWF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsKCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiA9IHsKCQkJCQkJCU93bmVyOiB0aGlzLAoJCQkJCQkJc3FsczogW10sCgkJCQkJCQlzdGFydDogbmV3IERhdGUoKSwKCQkJCQkJCWVuZDogbnVsbAoJCQkJCQl9OwoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBGaW5pc2hlZCBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0gSWQ9WyR7dGhpcy5JZH1dYCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fY2xvc2VfcmVhc29uX0luY2lkZW50c19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLmNsb3NlX3JlYXNvbl9JbmNpZGVudHMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCQlpZiAoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5Pd25lciA9PSB0aGlzKSB7CgkJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYENPTU1JVCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nIFRSQU5TQUNUSU9OJzonJ31gKTsKCQkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kID0gbmV3IERhdGUoKTsKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuUmVhc29uLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl0aGlzLl9mcm9tRG9jdW1lbnQoYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlsZXQgb2JqID0ge307CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9zZXQpIHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9lbmFibGVkX3NldCkgewoKCQkJCQlvYmouZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fY29kZV9zZXQpIHsKCgkJCQkJb2JqLmNvZGUgPSB0aGlzLmNvZGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX29yZGVyX3NldCkgewoKCQkJCQlvYmoub3JkZXIgPSB0aGlzLm9yZGVyKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9kYXRlX3NldCkgewoKCQkJCQlvYmouZGF0ZSA9IHRoaXMuZGF0ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fbmFtZV9zZXQpIHsKCgkJCQkJb2JqLm5hbWUgPSB0aGlzLm5hbWUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX3JlbWFya19zZXQpIHsKCgkJCQkJb2JqLnJlbWFyayA9IHRoaXMucmVtYXJrKCk7CgoJCQkJfQoKCQkJCWxvZygiU2VuZGluZyB0byBTRiIsIG9iaik7CgoJCQkJbGV0IHJlcyA9IGF3YWl0IHRoaXMuVG9vbC5kYi5zb2JqZWN0KCJSZWFzb24iKS5jcmVhdGUob2JqKTsKCQkJCXRoaXMuSWQgPSByZXMuaWQ7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5SZWFzb24udXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5SZWFzb24uZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCB7CgkJCQkJc3lzcGFybV9xdWVyeTogT2JqZWN0LmVudHJpZXModGhpcy5fdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykpLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKQoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIHRydWUpLCBudWxsLCB7CgkJCQkJdXJsOiAncmVzdC51cmwuZ3FsJwoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCk7CgkJCQlyZXQgPSByZXQuY29udGVudCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5SZWFzb24obnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoKCX0KCn07CgpzYWxlc25vdy5TeW1wdG9tID0gY2xhc3MgU3ltcHRvbSBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFzS2k1ZmNtVnpkQ3dxTGw5c2IyRmtWRzl2YkhNaWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc2V5SnVZVzFsSWpvaVUwNVBWMDlQUWlJc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaWZYMHNJbE5oYkdWelJtOXlZMlVpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgkJdGhpcy5jbGVhcl9zeW1wdG9tX0luY2lkZW50cygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIlN5bXB0b20iLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCS8vICh0aGlzLnN5bXB0b21fSW5jaWRlbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJVEhJUyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsKCQlpZiAoIXYpIHJldHVybiB0aGlzOwoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCQl0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KSA9PT0gJ29iamVjdCcgJiYgX3YuRW50aXR5Q2xhc3MgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSA9PSB0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGUgPT0gdGhpcy5TY29wZSk7CgkJaWYgKGNvKSB0aGlzLl9USElTX2Nvb3AgPSBjbzsKCQlyZXR1cm4gdGhpczsKCX0KCgljbGVhcl9USElTKCkgewoJCXRoaXMuX1RISVMgPSBbXTsKCQl0aGlzLl9USElTX2Nvb3AgPSAnJzsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHN5bXB0b21fSW5jaWRlbnRzICoqLwoJc3ltcHRvbV9JbmNpZGVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX3N5bXB0b21fSW5jaWRlbnRzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICdkNzVkNTAwZC0yZjc1LTRlNjEtYjNhNS1kNDU5ZmUyNjI0YzQnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0luY2lkZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9zeW1wdG9tX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N5bXB0b21fSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJzeW1wdG9tIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJJbmNpZGVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N5bXB0b21fSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJzeW1wdG9tIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiSW5jaWRlbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3Yuc3ltcHRvbSh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9zeW1wdG9tX0luY2lkZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX3N5bXB0b21fSW5jaWRlbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9zeW1wdG9tX0luY2lkZW50c19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfc3ltcHRvbV9JbmNpZGVudHMoKSB7CgkJdGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9zeW1wdG9tX0luY2lkZW50cyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX3N5bXB0b21fSW5jaWRlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc3ltcHRvbV9JbmNpZGVudHMgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5zeW1wdG9tX0luY2lkZW50cyA9IHRoaXMuc3ltcHRvbV9JbmNpZGVudHMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCXN5bXB0b21fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3ltcHRvbV9TeW1wdG9tcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCAmJiBldmVudC5jbGFzc05hbWUoKSAmJiBldmVudC5jbGFzc05hbWUoKSAhPSAnU3ltcHRvbScpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCXJldHVybiBuZXcgc2FsZXNub3dbZXZlbnQuY2xhc3NOYW1lKCldKCkuX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdyk7CgkJCX0KCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9TeW1wdG9tLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7CgoJCQl9CgoJCQkvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8KCgkJCWxldCB2ID0gdW5kZWZpbmVkOwoJCQl0cnkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke21ldGhvZH1gKTsKCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQlsZXQgX2lkID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgZGF0YSwgbWV0aG9kLCB7fSk7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIHsKCQkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKGRhdGEpOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSBkYXRhLl9fdGhpcy5jb2RlIHx8IGRhdGEuaWQgfHwgZGF0YS5JRDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCQlpZiAoZGF0YS5JZCAmJiBkYXRhLklkID09IGRhdGEuSWQpIHsKCQkJCQkJX2lkID0gZGF0YS5JZDsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5FbnRpdHlDbGFzcykgewoJCQkJCQlfaWQgPSBkYXRhLkVudGl0eUNsYXNzLklkIHx8IGRhdGEuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJjZmU5NTY2YS04ZmRkLTQ3MGEtODcwYS1kZGNiYzkwYjMxNDciIHx8ICJOVUxMIjsKCQkJCQl9CgkJCQl9CgoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b20gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b20gfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bbWV0aG9kXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVttZXRob2RdIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW21ldGhvZF1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVttZXRob2RdW19pZF0gfHwge307CgoJCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKHt9LCB7CgkJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJCX0pOwoKCQkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bbWV0aG9kXVtfaWRdW19oYXNoXTsKCQkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogNSkpIHsKCQkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIG1ldGhvZCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCQl2LnJldXNlZCsrOwoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0KCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSk7CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bbWV0aG9kXVtfaWRdW19oYXNoXSA9IHsKCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeSh7fSksCgkJCQkJb2JqOiBkYXRhLAoJCQkJCXJldXNlZDogMCwKCQkJCX07CgkJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZGF0YSwgbWV0aG9kLCB7fSwgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBUcmlnZ2VycmluZyAke21ldGhvZH0gdG8gJHtuLmNvZGUoKX0gJHtKU09OLnN0cmluZ2lmeShkYXRhLG51bGwsNCl9YCk7CgoJCQlsZXQgZXYgPSBuZXcgc2FsZXNub3cuRXZlbnQoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSh0aGlzLl9fY29uZmlnKCdldmVudCcpIHx8ICdzYWxlc25vdy5FdmVudCcpLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnJlY2lwaWVudChuKS5tZXRob2QobWV0aG9kKS5jbGFzc05hbWUoJ1N5bXB0b20nKS5zZW5kZXIoc2FsZXNub3cuX25vZGUpLmNhcnJpZXIoc2FsZXNub3cuX25vZGUpLnBheWxvYWQoZGF0YSk7CgkJCWlmIChldmVudCkgewoJCQkJaWYgKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOwoJCQkJaWYgKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOwoJCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJaWYgKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOwoJCQl9CgkJCXJldCA9IGF3YWl0IGV2LnRyaWdnZXIoKTsKCgkJCWlmICh0eXBlb2YocmV0KSA9PT0gInN0cmluZyIpIHsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCX0KCQkJcmV0dXJuIHJldDsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5TeW1wdG9tKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5TeW1wdG9tKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX25vZGUpIHsKCQkJLy8gcHJvYmFibHkgc2hvdWxkIG5vdCBiZSBwcm9jZXNzZWQgaGVyZSwgYnV0IHJhdGhlciBjb25zdW1lZCBhcyBwYXJ0IG9mIHRoZSBleGVjdXRlKCkgbG9naWMsIHB1c2hpbmcgX19ub2RlIHRvIHRoZSBsaXN0IG9mIG15IG5vZGVzIHRvIGRlbGVnYXRlIHRvIT8KCQkJbGV0IHRuID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX19ub2RlKS5fZGVSZWZlcmVuY2UoKTsKCQkJZGVsZXRlIF9wYXJhbXMuX19ub2RlOwoJCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlN5bXB0b20oKS5faW52b2tlTm9kZSh0biwgbWV0aG9kLCBfcGFyYW1zKTsKCQl9CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYFN5bXB0b20uX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBTeW1wdG9tLl9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQlpZiAoZmFsc2UgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCXJldCA9IHsKCQkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCQknLTQnOiAiVW5jb21taXR0ZWQgdHJhbnNhY3Rpb25zOiAiICsgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5zcWxzLmxlbmd0aCwKCQkJCQkJJ29iaic6IG9iagoJCQkJCX0KCQkJCX0KCQkJfQoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b20uX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuU3ltcHRvbS4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9wYXJzZUNvZGVTdGF0ZSh0KSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9wYXJzZUNvZGVTdGF0ZSh0KTsKCgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlIHx8ICJTeW1wdG9tIik7CgoJfQoKCV9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4ID0gJ3t7JywgcG9zdGZpeCA9ICd9fScpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXgsIHBvc3RmaXgpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQkvLyB0aGlzLnN5bXB0b21fU3ltcHRvbXMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5TeW1wdG9tKHRoaXMuSWQpCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5jb2RlKHRoaXMuY29kZSgpLCB0aGlzLl9jb2RlX2Nvb3ApCgoJCQkub3JkZXIodGhpcy5vcmRlcigpLCB0aGlzLl9vcmRlcl9jb29wKQoKCQkJLmRhdGUodGhpcy5kYXRlKCksIHRoaXMuX2RhdGVfY29vcCkKCgkJCS5uYW1lKHRoaXMubmFtZSgpLCB0aGlzLl9uYW1lX2Nvb3ApCgoJCQkucmVtYXJrKHRoaXMucmVtYXJrKCksIHRoaXMuX3JlbWFya19jb29wKQoKCQkJLnN5bXB0b21fSW5jaWRlbnRzKHRoaXMuc3ltcHRvbV9JbmNpZGVudHMoKSwgdGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQkvL29iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkvL29ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdTeW1wdG9tJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgkJY29kZVR5cGUgPSBjb2RlVHlwZSB8fCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBlMzA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSlbY29kZV07CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIlN5bXB0b20iOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19jb25maWcobiwgbnVsbFZhbHVlLCBPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zIHx8IHt9LCB7CgkJCV9jbGFzczogJ1N5bXB0b20nCgkJfSkpOwoKCX0KCglhc3luYyBfcmVzdCh0TmFtZSA9IHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKHVuZGVmaW5lZCwgdGhpcy5Ub29sKS5fcmVzdCh0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyk7CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qU3ltcHRvbSovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQlzeW1wdG9tX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N5bXB0b21fU3ltcHRvbXMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypTeW1wdG9tKi8pO1xuJzsKCgkJcmV0LnNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQocmV0LnNxbCkgOiByZXQuc3FsOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TUUxUYWJsZScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQuc3FsKTsKCQlyZXR1cm4gcmV0LnNxbDsKCX0KCglfZnJvbVNRTFRhYmxlKHRhYmxlLCBmaWVsZHMpIHsKCQkvLyB0YWJsZSBpcyBhIGpzb24gYXJyYXkKCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuYWN0aXZlKHRhYmxlWyJhY3RpdmUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZW5hYmxlZCh0YWJsZVsiZW5hYmxlZCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5jb2RlKHRhYmxlWyJjb2RlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5vcmRlcih0YWJsZVsib3JkZXIiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZGF0ZSh0YWJsZVsiZGF0ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5uYW1lKHRhYmxlWyJuYW1lIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucmVtYXJrKHRhYmxlWyJyZW1hcmsiXSk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBfc3FsKHNxbCwgc291cmNlID0gdGhpcykgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsKHNxbCwgdGhpcyk7CgoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgYlN0cmluZykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHsKCQkJW3RoaXMuX25Db2RlKCldOiB7CgkJCQlwYXJhbXM6IHsKCQkJCQl3aGVyZTogewoJCQkJCQlhbmQ6IFtdLAoJCQkJCQlvcjogW10KCQkJCQl9CgkJCQl9LAoJCQkJZWRnZXM6IHsKCQkJCQlub2RlOiB7fQoJCQkJfQoJCQl9CgkJfSwgewoJCQkvL09QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goewoJCQkJSWQ6IHsKCQkJCQllcTogdgoJCQkJfQoJCQl9KSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsKQoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCX0sICJfdG9TRlF1ZXJ5Iik7CgoJCS8vT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCWlmIChiU3RyaW5nKSB7CgkJCXJldCA9IHsKCQkJCXF1ZXJ5OiB7CgkJCQkJW3RoaXMuX25Db2RlKCkgKyAnUXVlcnknXTogewoJCQkJCQl1aWFwaTogcmV0CgkJCQkJfQoJCQkJfQoJCQl9OwoJCQlyZXQgPSBKU09OLnN0cmluZ2lmeShyZXQsIG51bGwsIDQpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU0ZRdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU05RdWVyeShmaWVsZHMsIG9ianMpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlPUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmouc3lzX2lkID0gdiwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlsZXQgZCA9IGAke3YuZ2V0RnVsbFllYXIoKX0tJHsoJzAnKyh2LmdldE1vbnRoKCkrMSkpLnNsaWNlKC0yKX0tJHt2LmdldERhdGUoKX1gOwoJCQkJbGV0IHQgPSBgJHt2LmdldEhvdXJzKCl9OiR7di5nZXRNaW51dGVzKCl9OiR7di5nZXRTZWNvbmRzKCl9YDsKCQkJCWlmICgodi5nZXRIb3VycygpID09IDAgJiYgdi5nZXRNaW51dGVzKCkgPT0gMCAmJiB2LmdldFNlY29uZHMoKSA9PSAwKSB8fCB0aGlzLl9kYXRlX2Nvb3AgPT0gJz0nIHx8ICF0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBPTiR7ZH1AamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdzdGFydCcpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywnZW5kJylgOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9kYXRlX2Nvb3AgIT09ICdCRVRXRUVOJykgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9IGVsc2UgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfQoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJfSwgIl90b1NOUXVlcnkiKTsKCgkJT2JqZWN0LmtleXMocmV0Lk9QRVJBVE9SUyB8fCB7fSkuZmlsdGVyKGsgPT4gdHlwZW9mKHJldFtrXSkgIT09ICd1bmRlZmluZWQnKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gcmV0Lk9QRVJBVE9SU1trXSArIHJldFtrXSk7CgoJCWRlbGV0ZSByZXQuT1BFUkFUT1JTOwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlyZXQgPSBEb3RPYmplY3QuZG90KHJldCk7CgoJCS8vIGF2b2lkIHNlbmRpbmcgd2l0aCBubyBjb21wYXJpc29uIG9wZXJhdG9ycwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVsnPicsICc8JywgJ0JFVFdFRU4nLCAnT04nLCAnIScsICc9JywgJ1NUQVJUU1dJVEgnLCAnTElLRSddLnNvbWUocyA9PiBTdHJpbmcocmV0W2tdKS5zdGFydHNXaXRoKHMpKSkuZm9yRWFjaChrID0+IHJldFtrXSA9ICh0aGlzW2BfJHtrfV9jb29wYF0gfHwgJ1NUQVJUU1dJVEgnKSArIHJldFtrXSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgT2JqZWN0LmVudHJpZXMocmV0IHx8IHt9KS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJbGV0IF9yZXQgPSBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIGZhbHNlLCBmdW4sIGVhT2JqLCBvYmopOwoJCQkJcmV0dXJuIF9yZXQ7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqLCB0aGlzLmNvZGUoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmosIHRoaXMuZGF0ZSgpKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmosIHRoaXMubmFtZSgpKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaiwgdGhpcy5yZW1hcmsoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJjZmU5NTY2YS04ZmRkLTQ3MGEtODcwYS1kZGNiYzkwYjMxNDciIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCV9vcHRpb25zKCJzeW1wdG9tX0luY2lkZW50cyIsIG9iaiwgdGhpcy5zeW1wdG9tX0luY2lkZW50cygpKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3N5bXB0b21fSW5jaWRlbnRzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCB0cnVlLCBmdW4sIG9iaiwgb2JqKTsKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmopOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiY2ZlOTU2NmEtOGZkZC00NzBhLTg3MGEtZGRjYmM5MGIzMTQ3IiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b20gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b20gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TeW1wdG9tW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN5bXB0b21bZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcyk7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3ltcHRvbVtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJzeW1wdG9tX0luY2lkZW50cyIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydzeW1wdG9tX0luY2lkZW50cyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaikpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9EQk9iamVjdChmaWVsZHMsIGJOb1JlZikgewoJCWlmICghdGhpcy5JZCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCAiSW52YWxpZCBJRCIsIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSwgdGhpcy5Ub29sKTsKCQl9CgkJbGV0IHJldCA9IHsKCQkJW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXTogIiciICsgdGhpcy5JZCArICInIgoJCX07CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2FjdGl2ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hY3RpdmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9lbmFibGVkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY29kZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jb2RlKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fb3JkZXJfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMub3JkZXIoKTsKCgkJCWZWYWx1ZSA9IHYgfHwgJzAnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZGF0ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5kYXRlKCk7CgoJCQl0cnkgewoJCQkJZlZhbHVlID0gIiciICsgKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiAiMTk3MC0xLTEiKSArICInIjsKCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJykgewoJCQkJCWZWYWx1ZSA9IGBTVFJfVE9fREFURSgke2ZWYWx1ZX0sICclWS0lbS0lZFQlVC4lZlonKWA7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9ICdkYXRldGltZSgnICsgZlZhbHVlICsgJyknOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9uYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm5hbWUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcmVtYXJrX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnJlbWFyaygpOwoKCQkJZlZhbHVlID0gIiciICsgKCh2ICYmIHYucmVwbGFjZSkgPyB2LnJlcGxhY2UoL1wnL2csICJcJ1wnIikgOiB2KSArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmIChbJ1NhbGVzRm9yY2UnXS5pbmRleE9mKHRoaXMuVG9vbC50eXBlLm5hbWUpID09IDApIHsKCQkJX28gPSBfcSA9ICIiOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXRoaXMuX19RID0gdGhpcy5fX1EgPT0gX28gPyBfcSA6IF9vOwoJCXJldHVybiB0aGlzLl9fUTsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKV07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9YCk7CgoJCX0KCQlyZXR1cm4gZmllbGRzOwoJfQoKCV9mcm9tREJPYmplY3QociA9IHt9KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMuX19pbXBvcnQociwgewoJCQkJSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU51bGw6IHRydWUsCgoJCX0sICJfdG9TZWxlY3RIZWFkZXIiKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0SGVhZGVyJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU2VsZWN0U1FMKGZpZWxkcykgewoJCWxldCBzcWwgPSAic2VsZWN0ICI7CgoJCWxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9YDsKCgkJbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7CgoJCXNxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsKCgkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpIHsKCQkJLy8ge2ZpZWxkOiBmdW5jdGlvbn0KCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJfQoKCQlzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7CgoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCk7CgoJCXNxbCArPSBgIHdoZXJlIDE9MWA7CgoJCXNxbCA9IHRoaXMuX19leHBvcnQoewoJCQlzcWw6IHNxbAoJCX0sIHsKCQkJX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSA/IFsnSWQnXSA6IHVuZGVmaW5lZCwKCQkJTnVsbDogdHJ1ZSwKCQkJX1RISVM6IG9iaiA9PiB7CgkJCQlpZiAoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKHQuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOwoJCQl9LAoJCQlJZDogb2JqID0+IG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jb2RlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fY29kZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX29yZGVyX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fb3JkZXJfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fZGF0ZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi50b0lTT1N0cmluZykgewoJCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbGl0ZScpIHsKCQkJCQkJb2JqLnNxbCArPSAic3RyZnRpbWUoJyVzJywgJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJykiOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9iai5zcWwgKz0gIiciICsgdi50b0lTT1N0cmluZygpICsgIiciOwoJCQkJCX0KCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9uYW1lX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9yZW1hcmtfc2V0KSByZXR1cm47CgoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXN5bXB0b21fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3ltcHRvbV9TeW1wdG9tcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJzeW1wdG9tLmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9zeW1wdG9tX0luY2lkZW50c19jb29wID09ICchPScgfHwgdGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfY29vcCA9PSAnPScgfHwgdGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl9zeW1wdG9tX0luY2lkZW50c19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLypzeW1wdG9tX0luY2lkZW50cyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJfSwgIl90b1NlbGVjdFNRTCIsIGZpZWxkcykuc3FsOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCWlmIChPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJc3ltcHRvbV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzeW1wdG9tX1N5bXB0b21zJywgdW5kZWZpbmVkKSkgPT4gb2JqLnN5bXB0b21fSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuU3ltcHRvbSkgcmV0dXJuOwoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5TeW1wdG9tID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5TeW1wdG9tKCkKCgkJCQkJLnN5bXB0b21fSW5jaWRlbnRzKG5ldyBzYWxlc25vdy5JbmNpZGVudCgpKQoKCQkJCQkuX3RvU1FMVGFibGUoZGVwdGgpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQkJCWF3YWl0IHRoaXMuX3NxbChzcWwpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIlN5bXB0b20iKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCXN5bXB0b21fSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnN5bXB0b21fSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gcXVlcnkuc3ltcHRvbV9JbmNpZGVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXN5bXB0b21fSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnN5bXB0b21fSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXN5bXB0b21fSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuc3ltcHRvbV9JbmNpZGVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvZGUocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kYXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoJCQkJCWlmICh0eXBlb2YobW9tZW50KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZWYgPSBuZXcgRGF0ZShyZWYpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmVmID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpKTsKCQkJCX0KCQkJCXRoaXMuZGF0ZShyZWYpOwoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm5hbWUocmVmKTsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZW1hcmtfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnJlbWFyayhyZWYpOwoKCQkJfSwKCgkJCXN5bXB0b21fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnc3ltcHRvbV9TeW1wdG9tcycsIHVuZGVmaW5lZCkgOiAic3ltcHRvbV9JbmNpZGVudHMiKSkgPT4gdGhpcy5zeW1wdG9tX0luY2lkZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuSW5jaWRlbnQoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSA9IHYsCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3JkZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGw7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIG9ialtlYUNvZGVdID0gb2JqW2VhQ29kZV0ucmVwbGFjZSgvXC5bMC05XSpaL2csICcnKTsKCgkJCQlpZiAodGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGF0ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9uYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9uYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3JlbWFya19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQlzeW1wdG9tX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3N5bXB0b21fU3ltcHRvbXMnLCB1bmRlZmluZWQpIDogInN5bXB0b21fSW5jaWRlbnRzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX3N5bXB0b21fSW5jaWRlbnRzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9zeW1wdG9tX0luY2lkZW50c19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9mbGlwKCkgKi8KCV9mbGlwKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fZmxpcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9mbGlwKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2ZsaXAoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSBmYWxzZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLm5hbWUgPSB7fTsKCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgZXJyb3IubmFtZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IubmFtZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IubmFtZTsKCQl9CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlN5bXB0b20uc3RvcmUnKTsgLy8gb3IgaW5zaWRlIGV4ZWN1dGU/CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJbGV0IGJVcGRhdGUgPSBmYWxzZTsKCQkJbGV0IGJJbnNlcnQgPSBmYWxzZTsKCgkJCWlmICghdGhpcy5fX3N5bmNfb24oKSkgewoJCQkJbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LlN5bXB0b20obnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLmNvZGUodGhpcy5jb2RlKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCWlmICh0eXBlb2Yoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgPT09ICJ1bmRlZmluZWQiIHx8IHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQkJCWF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsKCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiA9IHsKCQkJCQkJCU93bmVyOiB0aGlzLAoJCQkJCQkJc3FsczogW10sCgkJCQkJCQlzdGFydDogbmV3IERhdGUoKSwKCQkJCQkJCWVuZDogbnVsbAoJCQkJCQl9OwoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBGaW5pc2hlZCBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0gSWQ9WyR7dGhpcy5JZH1dYCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fc3ltcHRvbV9JbmNpZGVudHNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5zeW1wdG9tX0luY2lkZW50cygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBpbnNlcnQoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5TeW1wdG9tLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl0aGlzLl9mcm9tRG9jdW1lbnQoYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlsZXQgb2JqID0ge307CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9zZXQpIHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9lbmFibGVkX3NldCkgewoKCQkJCQlvYmouZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fY29kZV9zZXQpIHsKCgkJCQkJb2JqLmNvZGUgPSB0aGlzLmNvZGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX29yZGVyX3NldCkgewoKCQkJCQlvYmoub3JkZXIgPSB0aGlzLm9yZGVyKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9kYXRlX3NldCkgewoKCQkJCQlvYmouZGF0ZSA9IHRoaXMuZGF0ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fbmFtZV9zZXQpIHsKCgkJCQkJb2JqLm5hbWUgPSB0aGlzLm5hbWUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX3JlbWFya19zZXQpIHsKCgkJCQkJb2JqLnJlbWFyayA9IHRoaXMucmVtYXJrKCk7CgoJCQkJfQoKCQkJCWxvZygiU2VuZGluZyB0byBTRiIsIG9iaik7CgoJCQkJbGV0IHJlcyA9IGF3YWl0IHRoaXMuVG9vbC5kYi5zb2JqZWN0KCJTeW1wdG9tIikuY3JlYXRlKG9iaik7CgkJCQl0aGlzLklkID0gcmVzLmlkOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuU3ltcHRvbS51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1VwZGF0ZVNRTCgpKTsKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTCgpKTsKCQkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IHJldFswXTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlN5bXB0b20uZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCB7CgkJCQkJc3lzcGFybV9xdWVyeTogT2JqZWN0LmVudHJpZXModGhpcy5fdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykpLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKQoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIHRydWUpLCBudWxsLCB7CgkJCQkJdXJsOiAncmVzdC51cmwuZ3FsJwoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCk7CgkJCQlyZXQgPSByZXQuY29udGVudCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5TeW1wdG9tKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuSW5jaWRlbnQgPSBjbGFzcyBJbmNpZGVudCBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFzS2k1ZmNtVnpkQ3dxTGw5c2IyRmtWRzl2YkhNaWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc2V5SnVZVzFsSWpvaVUwNVBWMDlQUWlJc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaWZYMHNJbE5oYkdWelJtOXlZMlVpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibG9jYXRpb24iLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2xvY2F0aW9uKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZ3JvdXAiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2dyb3VwKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAic3RhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3N0YXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAic3ltcHRvbSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfc3ltcHRvbSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNsb3NlX3JlYXNvbiIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY2xvc2VfcmVhc29uKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicHJpb3JpdHkiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3ByaW9yaXR5KCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY2FsbGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jYWxsZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb250YWN0IiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb250YWN0KCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJJbmNpZGVudCIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJLy8gaWYodGhpcy5fbG9jYXRpb25fc2V0ICYmIHRoaXMuX2xvY2F0aW9uKSB0aGlzLl9sb2NhdGlvbi5Ub29sID0gdG9vbDsKCgkJLy8gaWYodGhpcy5fZ3JvdXBfc2V0ICYmIHRoaXMuX2dyb3VwKSB0aGlzLl9ncm91cC5Ub29sID0gdG9vbDsKCgkJLy8gaWYodGhpcy5fc3RhdGVfc2V0ICYmIHRoaXMuX3N0YXRlKSB0aGlzLl9zdGF0ZS5Ub29sID0gdG9vbDsKCgkJLy8gaWYodGhpcy5fc3ltcHRvbV9zZXQgJiYgdGhpcy5fc3ltcHRvbSkgdGhpcy5fc3ltcHRvbS5Ub29sID0gdG9vbDsKCgkJLy8gaWYodGhpcy5fY2xvc2VfcmVhc29uX3NldCAmJiB0aGlzLl9jbG9zZV9yZWFzb24pIHRoaXMuX2Nsb3NlX3JlYXNvbi5Ub29sID0gdG9vbDsKCgkJLy8gaWYodGhpcy5fcHJpb3JpdHlfc2V0ICYmIHRoaXMuX3ByaW9yaXR5KSB0aGlzLl9wcmlvcml0eS5Ub29sID0gdG9vbDsKCgkJLy8gaWYodGhpcy5fY2FsbGVyX3NldCAmJiB0aGlzLl9jYWxsZXIpIHRoaXMuX2NhbGxlci5Ub29sID0gdG9vbDsKCgkJLy8gaWYodGhpcy5fY29udGFjdF9zZXQgJiYgdGhpcy5fY29udGFjdCkgdGhpcy5fY29udGFjdC5Ub29sID0gdG9vbDsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJVEhJUyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsKCQlpZiAoIXYpIHJldHVybiB0aGlzOwoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCQl0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KSA9PT0gJ29iamVjdCcgJiYgX3YuRW50aXR5Q2xhc3MgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSA9PSB0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGUgPT0gdGhpcy5TY29wZSk7CgkJaWYgKGNvKSB0aGlzLl9USElTX2Nvb3AgPSBjbzsKCQlyZXR1cm4gdGhpczsKCX0KCgljbGVhcl9USElTKCkgewoJCXRoaXMuX1RISVMgPSBbXTsKCQl0aGlzLl9USElTX2Nvb3AgPSAnJzsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGxvY2F0aW9uICoqLwoJbG9jYXRpb24odiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9sb2NhdGlvbl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImxvY2F0aW9uIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnMmJjMWE2ZjUtOWM5ZC00N2Q2LTgyMDUtZmVjZThiOTQ1ZTIzJyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnTG9jYXRpb24nKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnbG9jYXRpb24nLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICIyYmMxYTZmNS05YzlkLTQ3ZDYtODIwNS1mZWNlOGI5NDVlMjMiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiTG9jYXRpb24iKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbG9jYXRpb24gIT0gdikgewoJCQkJdGhpcy5fbG9jYXRpb25fc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdsb2NhdGlvbicsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fbG9jYXRpb24gPyB0aGlzLl9sb2NhdGlvbi5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fbG9jYXRpb25fc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX2xvY2F0aW9uID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2xvY2F0aW9uKTsKCQl9Cgl9CgoJY2xlYXJfbG9jYXRpb24oKSB7CgkJdGhpcy5fbG9jYXRpb25fc2V0ID0gbnVsbDsKCQl0aGlzLl9sb2NhdGlvbiA9IG51bGw7CgkJdGhpcy5fbG9jYXRpb25fY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGxvY2F0aW9uICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXAgKiovCglncm91cCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2dyb3VwX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZ3JvdXAiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICdkYTE3MGE0MC02NDZiLTRhZDItODBhYi04ZGFkYmU0NDViOGUnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdHcm91cCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdncm91cCcsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgImRhMTcwYTQwLTY0NmItNGFkMi04MGFiLThkYWRiZTQ0NWI4ZSIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJHcm91cCIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9ncm91cCAhPSB2KSB7CgkJCQl0aGlzLl9ncm91cF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dyb3VwJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9ncm91cCA/IHRoaXMuX2dyb3VwLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9ncm91cF9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fZ3JvdXAgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZ3JvdXApOwoJCX0KCX0KCgljbGVhcl9ncm91cCgpIHsKCQl0aGlzLl9ncm91cF9zZXQgPSBudWxsOwoJCXRoaXMuX2dyb3VwID0gbnVsbDsKCQl0aGlzLl9ncm91cF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXAgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBzdGF0ZSAqKi8KCXN0YXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fc3RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJzdGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzVhMmE0Mzk5LTM4YTYtNDVmZi05NDc5LTM4OTcxMzYwZTgxYScgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ1N0YXRlJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0YXRlJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiNWEyYTQzOTktMzhhNi00NWZmLTk0NzktMzg5NzEzNjBlODFhIiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIlN0YXRlIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3N0YXRlICE9IHYpIHsKCQkJCXRoaXMuX3N0YXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX3N0YXRlID8gdGhpcy5fc3RhdGUuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX3N0YXRlX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9zdGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9zdGF0ZSk7CgkJfQoJfQoKCWNsZWFyX3N0YXRlKCkgewoJCXRoaXMuX3N0YXRlX3NldCA9IG51bGw7CgkJdGhpcy5fc3RhdGUgPSBudWxsOwoJCXRoaXMuX3N0YXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBzdGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHN5bXB0b20gKiovCglzeW1wdG9tKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fc3ltcHRvbV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInN5bXB0b20iKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICdjZmU5NTY2YS04ZmRkLTQ3MGEtODcwYS1kZGNiYzkwYjMxNDcnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdTeW1wdG9tJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N5bXB0b20nLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICJjZmU5NTY2YS04ZmRkLTQ3MGEtODcwYS1kZGNiYzkwYjMxNDciLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiU3ltcHRvbSIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9zeW1wdG9tICE9IHYpIHsKCQkJCXRoaXMuX3N5bXB0b21fc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzeW1wdG9tJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9zeW1wdG9tID8gdGhpcy5fc3ltcHRvbS5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fc3ltcHRvbV9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fc3ltcHRvbSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9zeW1wdG9tKTsKCQl9Cgl9CgoJY2xlYXJfc3ltcHRvbSgpIHsKCQl0aGlzLl9zeW1wdG9tX3NldCA9IG51bGw7CgkJdGhpcy5fc3ltcHRvbSA9IG51bGw7CgkJdGhpcy5fc3ltcHRvbV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc3ltcHRvbSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNsb3NlX3JlYXNvbiAqKi8KCWNsb3NlX3JlYXNvbih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2Nsb3NlX3JlYXNvbl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNsb3NlX3JlYXNvbiIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzdmOTcyOTFjLTIyZTQtNGM4My1iMmM1LWE0YTQzYzk1YmRiZScgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ1JlYXNvbicpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjbG9zZV9yZWFzb24nLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICI3Zjk3MjkxYy0yMmU0LTRjODMtYjJjNS1hNGE0M2M5NWJkYmUiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiUmVhc29uIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2Nsb3NlX3JlYXNvbiAhPSB2KSB7CgkJCQl0aGlzLl9jbG9zZV9yZWFzb25fc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjbG9zZV9yZWFzb24nLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX2Nsb3NlX3JlYXNvbiA/IHRoaXMuX2Nsb3NlX3JlYXNvbi5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fY2xvc2VfcmVhc29uX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9jbG9zZV9yZWFzb24gPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY2xvc2VfcmVhc29uKTsKCQl9Cgl9CgoJY2xlYXJfY2xvc2VfcmVhc29uKCkgewoJCXRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQgPSBudWxsOwoJCXRoaXMuX2Nsb3NlX3JlYXNvbiA9IG51bGw7CgkJdGhpcy5fY2xvc2VfcmVhc29uX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjbG9zZV9yZWFzb24gKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBwcmlvcml0eSAqKi8KCXByaW9yaXR5KHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcHJpb3JpdHlfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJwcmlvcml0eSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2Q2YTExOGY3LTA0MzctNDk4ZS1iZjgxLTI3OWJkNWI3MWQ1NycgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ1ByaW9yaXR5JykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3ByaW9yaXR5JywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiZDZhMTE4ZjctMDQzNy00OThlLWJmODEtMjc5YmQ1YjcxZDU3IiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIlByaW9yaXR5Iik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3ByaW9yaXR5ICE9IHYpIHsKCQkJCXRoaXMuX3ByaW9yaXR5X3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAncHJpb3JpdHknLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX3ByaW9yaXR5ID8gdGhpcy5fcHJpb3JpdHkuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX3ByaW9yaXR5X3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9wcmlvcml0eSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9wcmlvcml0eSk7CgkJfQoJfQoKCWNsZWFyX3ByaW9yaXR5KCkgewoJCXRoaXMuX3ByaW9yaXR5X3NldCA9IG51bGw7CgkJdGhpcy5fcHJpb3JpdHkgPSBudWxsOwoJCXRoaXMuX3ByaW9yaXR5X2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBwcmlvcml0eSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNhbGxlciAqKi8KCWNhbGxlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NhbGxlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNhbGxlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzAyNjQ1YzVjLWJlMDQtNGRhYi05MWI0LWY4Yzg1YmU5NGE2ZScgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ1VzZXInKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnY2FsbGVyJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiMDI2NDVjNWMtYmUwNC00ZGFiLTkxYjQtZjhjODViZTk0YTZlIiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIlVzZXIiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY2FsbGVyICE9IHYpIHsKCQkJCXRoaXMuX2NhbGxlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NhbGxlcicsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fY2FsbGVyID8gdGhpcy5fY2FsbGVyLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9jYWxsZXJfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX2NhbGxlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jYWxsZXIpOwoJCX0KCX0KCgljbGVhcl9jYWxsZXIoKSB7CgkJdGhpcy5fY2FsbGVyX3NldCA9IG51bGw7CgkJdGhpcy5fY2FsbGVyID0gbnVsbDsKCQl0aGlzLl9jYWxsZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNhbGxlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvbnRhY3QgKiovCgljb250YWN0KHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29udGFjdF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvbnRhY3QiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICcwMjY0NWM1Yy1iZTA0LTRkYWItOTFiNC1mOGM4NWJlOTRhNmUnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdVc2VyJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NvbnRhY3QnLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICIwMjY0NWM1Yy1iZTA0LTRkYWItOTFiNC1mOGM4NWJlOTRhNmUiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiVXNlciIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb250YWN0ICE9IHYpIHsKCQkJCXRoaXMuX2NvbnRhY3Rfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjb250YWN0JywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9jb250YWN0ID8gdGhpcy5fY29udGFjdC5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fY29udGFjdF9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fY29udGFjdCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb250YWN0KTsKCQl9Cgl9CgoJY2xlYXJfY29udGFjdCgpIHsKCQl0aGlzLl9jb250YWN0X3NldCA9IG51bGw7CgkJdGhpcy5fY29udGFjdCA9IG51bGw7CgkJdGhpcy5fY29udGFjdF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29udGFjdCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX2xvY2F0aW9uX3NldCwKCgkJCXRoaXMuX2dyb3VwX3NldCwKCgkJCXRoaXMuX3N0YXRlX3NldCwKCgkJCXRoaXMuX3N5bXB0b21fc2V0LAoKCQkJdGhpcy5fY2xvc2VfcmVhc29uX3NldCwKCgkJCXRoaXMuX3ByaW9yaXR5X3NldCwKCgkJCXRoaXMuX2NhbGxlcl9zZXQsCgoJCQl0aGlzLl9jb250YWN0X3NldCwKCgkJCXRoaXMuX2FjdGl2ZV9zZXQsCgoJCQl0aGlzLl9lbmFibGVkX3NldCwKCgkJCXRoaXMuX2NvZGVfc2V0LAoKCQkJdGhpcy5fb3JkZXJfc2V0LAoKCQkJdGhpcy5fZGF0ZV9zZXQsCgoJCQl0aGlzLl9uYW1lX3NldCwKCgkJCXRoaXMuX3JlbWFya19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9sb2NhdGlvbl9zZXQgPSB0aGlzLl9sb2NhdGlvbl9zZXQ7CgkJcmV0Ll9sb2NhdGlvbl9jb29wID0gdGhpcy5fbG9jYXRpb25fY29vcDsKCQlyZXQubG9jYXRpb24gPSB0aGlzLmxvY2F0aW9uKCkgPyB0aGlzLmxvY2F0aW9uKCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMubG9jYXRpb24oKTsKCgkJcmV0Ll9ncm91cF9zZXQgPSB0aGlzLl9ncm91cF9zZXQ7CgkJcmV0Ll9ncm91cF9jb29wID0gdGhpcy5fZ3JvdXBfY29vcDsKCQlyZXQuZ3JvdXAgPSB0aGlzLmdyb3VwKCkgPyB0aGlzLmdyb3VwKCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMuZ3JvdXAoKTsKCgkJcmV0Ll9zdGF0ZV9zZXQgPSB0aGlzLl9zdGF0ZV9zZXQ7CgkJcmV0Ll9zdGF0ZV9jb29wID0gdGhpcy5fc3RhdGVfY29vcDsKCQlyZXQuc3RhdGUgPSB0aGlzLnN0YXRlKCkgPyB0aGlzLnN0YXRlKCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMuc3RhdGUoKTsKCgkJcmV0Ll9zeW1wdG9tX3NldCA9IHRoaXMuX3N5bXB0b21fc2V0OwoJCXJldC5fc3ltcHRvbV9jb29wID0gdGhpcy5fc3ltcHRvbV9jb29wOwoJCXJldC5zeW1wdG9tID0gdGhpcy5zeW1wdG9tKCkgPyB0aGlzLnN5bXB0b20oKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5zeW1wdG9tKCk7CgoJCXJldC5fY2xvc2VfcmVhc29uX3NldCA9IHRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQ7CgkJcmV0Ll9jbG9zZV9yZWFzb25fY29vcCA9IHRoaXMuX2Nsb3NlX3JlYXNvbl9jb29wOwoJCXJldC5jbG9zZV9yZWFzb24gPSB0aGlzLmNsb3NlX3JlYXNvbigpID8gdGhpcy5jbG9zZV9yZWFzb24oKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5jbG9zZV9yZWFzb24oKTsKCgkJcmV0Ll9wcmlvcml0eV9zZXQgPSB0aGlzLl9wcmlvcml0eV9zZXQ7CgkJcmV0Ll9wcmlvcml0eV9jb29wID0gdGhpcy5fcHJpb3JpdHlfY29vcDsKCQlyZXQucHJpb3JpdHkgPSB0aGlzLnByaW9yaXR5KCkgPyB0aGlzLnByaW9yaXR5KCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMucHJpb3JpdHkoKTsKCgkJcmV0Ll9jYWxsZXJfc2V0ID0gdGhpcy5fY2FsbGVyX3NldDsKCQlyZXQuX2NhbGxlcl9jb29wID0gdGhpcy5fY2FsbGVyX2Nvb3A7CgkJcmV0LmNhbGxlciA9IHRoaXMuY2FsbGVyKCkgPyB0aGlzLmNhbGxlcigpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLmNhbGxlcigpOwoKCQlyZXQuX2NvbnRhY3Rfc2V0ID0gdGhpcy5fY29udGFjdF9zZXQ7CgkJcmV0Ll9jb250YWN0X2Nvb3AgPSB0aGlzLl9jb250YWN0X2Nvb3A7CgkJcmV0LmNvbnRhY3QgPSB0aGlzLmNvbnRhY3QoKSA/IHRoaXMuY29udGFjdCgpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLmNvbnRhY3QoKTsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkibG9jYXRpb24iOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJncm91cCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJInN0YXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N0YXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkic3ltcHRvbSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkiY2xvc2VfcmVhc29uIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJInByaW9yaXR5IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3ByaW9yaXR5JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkiY2FsbGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJImNvbnRhY3QiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJsb2NhdGlvbiIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgbG9jYXRpb24nLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93LkxvY2F0aW9uKCkubG9jYXRpb25fSW5jaWRlbnRzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAiZ3JvdXAiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIGdyb3VwJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Hcm91cCgpLmdyb3VwX0luY2lkZW50cyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInN0YXRlIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBzdGF0ZScsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuU3RhdGUoKS5zdGF0ZV9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJzeW1wdG9tIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBzeW1wdG9tJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5TeW1wdG9tKCkuc3ltcHRvbV9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJjbG9zZV9yZWFzb24iKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIGNsb3NlX3JlYXNvbicsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuUmVhc29uKCkuY2xvc2VfcmVhc29uX0luY2lkZW50cyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInByaW9yaXR5IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBwcmlvcml0eScsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuUHJpb3JpdHkoKS5wcmlvcml0eV9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJjYWxsZXIiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIGNhbGxlcicsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuVXNlcigpLmNhbGxlcl9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJjb250YWN0IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBjb250YWN0Jywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Vc2VyKCkuY29udGFjdF9JbmNpZGVudHModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCAmJiBldmVudC5jbGFzc05hbWUoKSAmJiBldmVudC5jbGFzc05hbWUoKSAhPSAnSW5jaWRlbnQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiRGVsZWdhdGluZyBpbnZva2F0aW9uIHRvICIgKyBldmVudC5jbGFzc05hbWUoKSk7CgkJCQlyZXR1cm4gbmV3IHNhbGVzbm93W2V2ZW50LmNsYXNzTmFtZSgpXSgpLl9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpOwoJCQl9CgoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQlkYXRhLl9fdGhpcyA9IGRhdGEuX190aGlzIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkJc3dpdGNoIChtZXRob2QpIHsKCgkJCQljYXNlICJ0ZXN0U3luYyI6IHsKCgkJCQkJYnJlYWs7CgkJCQl9CgoJCQkJY2FzZSAiaW5Qcm9ncmVzcyI6IHsKCgkJCQkJZGF0YS5yZWFzb24gPSBkYXRhLnJlYXNvbiA/IGRhdGEucmVhc29uCgoJCQkJCQk6CgkJCQkJCXVuZGVmaW5lZDsKCgkJCQkJYnJlYWs7CgkJCQl9CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL0luY2lkZW50LyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7CgoJCQl9CgoJCQkvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8KCgkJCWxldCB2ID0gdW5kZWZpbmVkOwoJCQl0cnkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke21ldGhvZH1gKTsKCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQlsZXQgX2lkID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgZGF0YSwgbWV0aG9kLCB7fSk7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIHsKCQkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKGRhdGEpOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSBkYXRhLl9fdGhpcy5jb2RlIHx8IGRhdGEuaWQgfHwgZGF0YS5JRDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCQlpZiAoZGF0YS5JZCAmJiBkYXRhLklkID09IGRhdGEuSWQpIHsKCQkJCQkJX2lkID0gZGF0YS5JZDsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5FbnRpdHlDbGFzcykgewoJCQkJCQlfaWQgPSBkYXRhLkVudGl0eUNsYXNzLklkIHx8IGRhdGEuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJkNzVkNTAwZC0yZjc1LTRlNjEtYjNhNS1kNDU5ZmUyNjI0YzQiIHx8ICJOVUxMIjsKCQkJCQl9CgkJCQl9CgoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudCB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbbWV0aG9kXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFttZXRob2RdW19pZF0gfHwge307CgoJCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKHt9LCB7CgkJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJCX0pOwoKCQkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnSW5jaWRlbnQnKS5zZW5kZXIoc2FsZXNub3cuX25vZGUpLmNhcnJpZXIoc2FsZXNub3cuX25vZGUpLnBheWxvYWQoZGF0YSk7CgkJCWlmIChldmVudCkgewoJCQkJaWYgKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOwoJCQkJaWYgKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOwoJCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJaWYgKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOwoJCQl9CgkJCXJldCA9IGF3YWl0IGV2LnRyaWdnZXIoKTsKCgkJCWlmICh0eXBlb2YocmV0KSA9PT0gInN0cmluZyIpIHsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCX0KCQkJcmV0dXJuIHJldDsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJ0ZXN0U3luYyI6IHsKCgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5JbmNpZGVudChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiaW5Qcm9ncmVzcyI6IHsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiaW5zZXJ0IjoKCQkJY2FzZSAidXBkYXRlIjoKCQkJY2FzZSAic3RvcmUiOgoJCQljYXNlICJkZWxldGUiOgoJCQljYXNlICJmaW5kIjogewoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuSW5jaWRlbnQobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93LkluY2lkZW50KG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX25vZGUpIHsKCQkJLy8gcHJvYmFibHkgc2hvdWxkIG5vdCBiZSBwcm9jZXNzZWQgaGVyZSwgYnV0IHJhdGhlciBjb25zdW1lZCBhcyBwYXJ0IG9mIHRoZSBleGVjdXRlKCkgbG9naWMsIHB1c2hpbmcgX19ub2RlIHRvIHRoZSBsaXN0IG9mIG15IG5vZGVzIHRvIGRlbGVnYXRlIHRvIT8KCQkJbGV0IHRuID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX19ub2RlKS5fZGVSZWZlcmVuY2UoKTsKCQkJZGVsZXRlIF9wYXJhbXMuX19ub2RlOwoJCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LkluY2lkZW50KCkuX2ludm9rZU5vZGUodG4sIG1ldGhvZCwgX3BhcmFtcyk7CgkJfQoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJ0ZXN0U3luYyI6IHsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiaW5Qcm9ncmVzcyI6IHsKCgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnJlYXNvbik7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYEluY2lkZW50Ll9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgSW5jaWRlbnQuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnQuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuSW5jaWRlbnQuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglfcGFyc2VDb2RlU3RhdGUodCkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyc2VDb2RlU3RhdGUodCk7CgoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiSW5jaWRlbnQiKTsKCgl9CgoJX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXggPSAne3snLCBwb3N0Zml4ID0gJ319JykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCwgcG9zdGZpeCk7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCWlmICh0aGlzLl9sb2NhdGlvbl9zZXQgJiYgdGhpcy5sb2NhdGlvbigpKSB0aGlzLmxvY2F0aW9uKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX2dyb3VwX3NldCAmJiB0aGlzLmdyb3VwKCkpIHRoaXMuZ3JvdXAoKS5fX3N5bmNfb24oZCk7CgoJCQlpZiAodGhpcy5fc3RhdGVfc2V0ICYmIHRoaXMuc3RhdGUoKSkgdGhpcy5zdGF0ZSgpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl9zeW1wdG9tX3NldCAmJiB0aGlzLnN5bXB0b20oKSkgdGhpcy5zeW1wdG9tKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQgJiYgdGhpcy5jbG9zZV9yZWFzb24oKSkgdGhpcy5jbG9zZV9yZWFzb24oKS5fX3N5bmNfb24oZCk7CgoJCQlpZiAodGhpcy5fcHJpb3JpdHlfc2V0ICYmIHRoaXMucHJpb3JpdHkoKSkgdGhpcy5wcmlvcml0eSgpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl9jYWxsZXJfc2V0ICYmIHRoaXMuY2FsbGVyKCkpIHRoaXMuY2FsbGVyKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX2NvbnRhY3Rfc2V0ICYmIHRoaXMuY29udGFjdCgpKSB0aGlzLmNvbnRhY3QoKS5fX3N5bmNfb24oZCk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93LkluY2lkZW50KHRoaXMuSWQpCgoJCQkubG9jYXRpb24odGhpcy5sb2NhdGlvbigpLCB0aGlzLl9sb2NhdGlvbl9jb29wKQoKCQkJLmdyb3VwKHRoaXMuZ3JvdXAoKSwgdGhpcy5fZ3JvdXBfY29vcCkKCgkJCS5zdGF0ZSh0aGlzLnN0YXRlKCksIHRoaXMuX3N0YXRlX2Nvb3ApCgoJCQkuc3ltcHRvbSh0aGlzLnN5bXB0b20oKSwgdGhpcy5fc3ltcHRvbV9jb29wKQoKCQkJLmNsb3NlX3JlYXNvbih0aGlzLmNsb3NlX3JlYXNvbigpLCB0aGlzLl9jbG9zZV9yZWFzb25fY29vcCkKCgkJCS5wcmlvcml0eSh0aGlzLnByaW9yaXR5KCksIHRoaXMuX3ByaW9yaXR5X2Nvb3ApCgoJCQkuY2FsbGVyKHRoaXMuY2FsbGVyKCksIHRoaXMuX2NhbGxlcl9jb29wKQoKCQkJLmNvbnRhY3QodGhpcy5jb250YWN0KCksIHRoaXMuX2NvbnRhY3RfY29vcCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJLy9vYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJLy9vYmpUbyA9IG9ialRvIHx8IHt9OwoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAnSW5jaWRlbnQnOwoJCXRvb2wgPSB0b29sIHx8IHRoaXMuVG9vbDsKCQljb2RlVHlwZSA9IGNvZGVUeXBlIHx8IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnNiMk5oZEdsdmJpSTZJa3h2WTJGMGFXOXVJaXdpWjNKdmRYQWlPaUpIY205MWNDSXNJbk4wWVhSbElqb2lVM1JoZEdVaUxDSnplVzF3ZEc5dElqb2lVM2x0Y0hSdmJTSXNJbU5zYjNObFgzSmxZWE52YmlJNklsSmxZWE52YmlJc0luQnlhVzl5YVhSNUlqb2lVSEpwYjNKcGRIa2lMQ0pqWVd4c1pYSWlPaUpWYzJWeUlpd2lZMjl1ZEdGamRDSTZJbFZ6WlhJaWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KVtjb2RlXTsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiSW5jaWRlbnQiOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19jb25maWcobiwgbnVsbFZhbHVlLCBPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zIHx8IHt9LCB7CgkJCV9jbGFzczogJ0luY2lkZW50JwoJCX0pKTsKCgl9CgoJLyoqCgkgKiBTdW1tYXJ5LiB0ZXN0U3luYy4KCSAqCgkgKiBEZXNjcmlwdGlvbi4gLgoJICoKCSAqIEBzaW5jZSAgICAgIHgueC54CgkgKiBAZGVwcmVjYXRlZCB4LngueCBVc2UgbmV3X2Z1bmN0aW9uX25hbWUoKSBpbnN0ZWFkLgoJICogQGFjY2VzcyAgICAgcHVibGljCgkgKgoJICogQGNsYXNzCgkgKiBAYXVnbWVudHMgcGFyZW50CgkgKiBAbWl4ZXMgICAgbWl4aW4KCSAqCgkgKiBAYWxpYXMgICAgcmVhbE5hbWUKCSAqIEBtZW1iZXJvZiBuYW1lc3BhY2UKCSAqCgkgKiBAc2VlICBGdW5jdGlvbi9jbGFzcyByZWxpZWQgb24KCSAqIEBsaW5rIFVSTAoJICogQGdsb2JhbAoJICoKCSAqIEBmaXJlcyAgIGV2ZW50TmFtZQoJICogQGZpcmVzICAgY2xhc3NOYW1lI2V2ZW50TmFtZQoJICogQGxpc3RlbnMgZXZlbnQ6ZXZlbnROYW1lCgkgKiBAbGlzdGVucyBjbGFzc05hbWV+ZXZlbnQ6ZXZlbnROYW1lCgkgKiBAcGFyYW0ge3R5cGV9ICAgdmFyICAgICAgICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyXSAgICAgICAgIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXI9ZGVmYXVsdF0gRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUgd2l0aCBkZWZhdWx0IHZhcmlhYmxlLgoJICogQHBhcmFtIHtPYmplY3R9IG9iamVjdFZhciAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgb2JqZWN0VmFyLmtleSBEZXNjcmlwdGlvbiBvZiBhIGtleSBpbiB0aGUgb2JqZWN0VmFyIHBhcmFtZXRlci4KCSAqCgkgKiBAeWllbGQge3R5cGV9IFlpZWxkZWQgdmFsdWUgZGVzY3JpcHRpb24uCgkgKgoJICogQHJldHVybiB7dHlwZX0gUmV0dXJuIHZhbHVlIGRlc2NyaXB0aW9uLgoJICovCglhc3luYyB0ZXN0U3luYygpIHsKCgkJbGV0IGFuc3dlciA9IG5ldyBzYWxlc25vdy5JbmNpZGVudCgpOwoKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ0ZXN0U3luYyIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ0ZXN0U3luYyIsIF9ub2RlLCApID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInRlc3RTeW5jIiwgKSA9PiB7CgoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuSW5jaWRlbnQudGVzdFN5bmMnKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3Rlc3RTeW5jJywgJ0VudGl0eU9iamVjdCcsIDAsIHsKCQkJCQkJW2tdOiBlcnJvcnNba10KCQkJCQl9KTsKCQkJCQlkZWxldGUgZXJyb3JzW2tdOwoJCQkJfSk7CgkJCQlpZiAoT2JqZWN0LnZhbHVlcyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJCXJldHVybiB7CgkJCQkJCV9fZXhjZXB0aW9uOiBlcnJvcnMsCgkJCQkJfTsKCQkJCX0KCQkJCXJldHVybjsKCQkJfQoKCQkJbGV0IGluYyA9IGF3YWl0IG5ldyBvU2NvcGUuSW5jaWRlbnQoKS5udW1iZXIoIklOQzEyMzQiKS50aXRsZSgiVGVzdGluZyIpLmdyb3VwKG5ldyBvU2NvcGUuR3JvdXAoKS5uYW1lKCJHcm91cDEiKSkuc3RhdGUobmV3IG9TY29wZS5TdGF0ZSgpLm5hbWUoIkFzc2lnbmVkIikpLnByaW9yaXR5KG5ldyBvU2NvcGUuUHJpb3JpdHkoKS5uYW1lKCJIaWdoIikuY29kZSgiUDEiKSkuY2FsbGVyKG5ldyBvU2NvcGUuVXNlcigpLnVzZXJuYW1lKCJmYWRpIikubmFtZSgiRmFkaSIpKS5zdG9yZSgpOwoJCQlpbmMuVG9vbCA9ICJNb25nb0RCIjsKCQkJcmV0dXJuIGF3YWl0IGluYy5zdG9yZSgpOwoKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdLAoJCX0pOwoKCQkvLyB0YWtlIG91dCB0aGUgaW52YWxpZCBub2RlIHJlc3VsdHMKCQlyZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByICYmIHIucmV0KTsKCgkJLy8gaGFzIGFueSBub2RlIGdlbmVyYXRlZCBhIHZhbGlkYXRpb24gZXhjZXB0aW9uPwoJCWxldCBfX2V4ID0gcmVzdWx0cy5maW5kKHIgPT4gci5yZXQuX19leGNlcHRpb24pOwoJCWlmIChfX2V4KSByZXR1cm4gX19leC5yZXQ7CgoJCXJldHVybiByZXN1bHRzLmxlbmd0aCA/IHJlc3VsdHNbMF0ucmV0IDogbnVsbDsKCgl9CgoJLyoqCgkgKiBTdW1tYXJ5LiBpblByb2dyZXNzLgoJICoKCSAqIERlc2NyaXB0aW9uLiAuCgkgKgoJICogQHNpbmNlICAgICAgeC54LngKCSAqIEBkZXByZWNhdGVkIHgueC54IFVzZSBuZXdfZnVuY3Rpb25fbmFtZSgpIGluc3RlYWQuCgkgKiBAYWNjZXNzICAgICBwdWJsaWMKCSAqCgkgKiBAY2xhc3MKCSAqIEBhdWdtZW50cyBwYXJlbnQKCSAqIEBtaXhlcyAgICBtaXhpbgoJICoKCSAqIEBhbGlhcyAgICByZWFsTmFtZQoJICogQG1lbWJlcm9mIG5hbWVzcGFjZQoJICoKCSAqIEBzZWUgIEZ1bmN0aW9uL2NsYXNzIHJlbGllZCBvbgoJICogQGxpbmsgVVJMCgkgKiBAZ2xvYmFsCgkgKgoJICogQGZpcmVzICAgZXZlbnROYW1lCgkgKiBAZmlyZXMgICBjbGFzc05hbWUjZXZlbnROYW1lCgkgKiBAbGlzdGVucyBldmVudDpldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGNsYXNzTmFtZX5ldmVudDpldmVudE5hbWUKCSAqIEBwYXJhbSB7dHlwZX0gICB2YXIgICAgICAgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXJdICAgICAgICAgRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUuCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcj1kZWZhdWx0XSBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZSB3aXRoIGRlZmF1bHQgdmFyaWFibGUuCgkgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0VmFyICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBvYmplY3RWYXIua2V5IERlc2NyaXB0aW9uIG9mIGEga2V5IGluIHRoZSBvYmplY3RWYXIgcGFyYW1ldGVyLgoJICoKCSAqIEB5aWVsZCB7dHlwZX0gWWllbGRlZCB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqCgkgKiBAcmV0dXJuIHt0eXBlfSBSZXR1cm4gdmFsdWUgZGVzY3JpcHRpb24uCgkgKi8KCWFzeW5jIGluUHJvZ3Jlc3MocmVhc29uKSB7CgoJCWxldCBhbnN3ZXIgPSBmYWxzZTsKCgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5Qcm9ncmVzcyIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpblByb2dyZXNzIiwgX25vZGUsIHJlYXNvbikgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5Qcm9ncmVzcyIsIHJlYXNvbikgPT4gewoKCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkluY2lkZW50LmluUHJvZ3Jlc3MnKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luUHJvZ3Jlc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgewoJCQkJCQlba106IGVycm9yc1trXQoJCQkJCX0pOwoJCQkJCWRlbGV0ZSBlcnJvcnNba107CgkJCQl9KTsKCQkJCWlmIChPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIHsKCQkJCQkJX19leGNlcHRpb246IGVycm9ycywKCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10sCgkJCXJlYXNvbjogcmVhc29uCgkJfSk7CgoJCS8vIHRha2Ugb3V0IHRoZSBpbnZhbGlkIG5vZGUgcmVzdWx0cwoJCXJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIgJiYgci5yZXQpOwoKCQkvLyBoYXMgYW55IG5vZGUgZ2VuZXJhdGVkIGEgdmFsaWRhdGlvbiBleGNlcHRpb24/CgkJbGV0IF9fZXggPSByZXN1bHRzLmZpbmQociA9PiByLnJldC5fX2V4Y2VwdGlvbik7CgkJaWYgKF9fZXgpIHJldHVybiBfX2V4LnJldDsKCgkJcmV0dXJuIHJlc3VsdHMubGVuZ3RoID8gcmVzdWx0c1swXS5yZXQgOiBudWxsOwoKCX0KCglhc3luYyBfcmVzdCh0TmFtZSA9IHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKHVuZGVmaW5lZCwgdGhpcy5Ub29sKS5fcmVzdCh0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyk7CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3N0YXRlJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3ByaW9yaXR5JywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICBgCgkJfTsKCQlyZXQuc3FsICs9ICcvKkluY2lkZW50Ki8pO1xuJzsKCgkJcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogdHJ1ZSwKCQkJTnVsbDogdHJ1ZSwKCQkJLy9JZDogKG9iaiwgdikgPT4gb2JqLnNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVlgLAoKCQkJImxvY2F0aW9uIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJncm91cCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkic3RhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJInN5bXB0b20iOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJjbG9zZV9yZWFzb24iOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkicHJpb3JpdHkiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJImNhbGxlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJjb250YWN0IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypJbmNpZGVudCovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJsb2NhdGlvbiIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubG9jYXRpb24odGFibGVbImxvY2F0aW9uIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImdyb3VwIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5ncm91cCh0YWJsZVsiZ3JvdXAiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigic3RhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnN0YXRlKHRhYmxlWyJzdGF0ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJzeW1wdG9tIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5zeW1wdG9tKHRhYmxlWyJzeW1wdG9tIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNsb3NlX3JlYXNvbiIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY2xvc2VfcmVhc29uKHRhYmxlWyJjbG9zZV9yZWFzb24iXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicHJpb3JpdHkiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnByaW9yaXR5KHRhYmxlWyJwcmlvcml0eSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjYWxsZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNhbGxlcih0YWJsZVsiY2FsbGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvbnRhY3QiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvbnRhY3QodGFibGVbImNvbnRhY3QiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5hY3RpdmUodGFibGVbImFjdGl2ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5lbmFibGVkKHRhYmxlWyJlbmFibGVkIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvZGUodGFibGVbImNvZGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9yZGVyKHRhYmxlWyJvcmRlciJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5kYXRlKHRhYmxlWyJkYXRlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm5hbWUodGFibGVbIm5hbWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5yZW1hcmsodGFibGVbInJlbWFyayJdKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIF9zcWwoc3FsLCBzb3VyY2UgPSB0aGlzKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWwoc3FsLCB0aGlzKTsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCBiU3RyaW5nKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoewoJCQlbdGhpcy5fbkNvZGUoKV06IHsKCQkJCXBhcmFtczogewoJCQkJCXdoZXJlOiB7CgkJCQkJCWFuZDogW10sCgkJCQkJCW9yOiBbXQoJCQkJCX0KCQkJCX0sCgkJCQllZGdlczogewoJCQkJCW5vZGU6IHt9CgkJCQl9CgkJCX0KCQl9LCB7CgkJCS8vT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaCh7CgkJCQlJZDogewoJCQkJCWVxOiB2CgkJCQl9CgkJCX0pLAoKCQkJbG9jYXRpb246IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdsb2NhdGlvbicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJewoJCQkJCQkJaW5xOiB7CgkJCQkJCQkJQXBpTmFtZTogJ0lkJywKCQkJCQkJCQlbdGhpcy5fbkNvZGUoJ0xvY2F0aW9uJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnTG9jYXRpb24nLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZ3JvdXA6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJewoJCQkJCQkJaW5xOiB7CgkJCQkJCQkJQXBpTmFtZTogJ0lkJywKCQkJCQkJCQlbdGhpcy5fbkNvZGUoJ0dyb3VwJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnR3JvdXAnLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJc3RhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJewoJCQkJCQkJaW5xOiB7CgkJCQkJCQkJQXBpTmFtZTogJ0lkJywKCQkJCQkJCQlbdGhpcy5fbkNvZGUoJ1N0YXRlJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnU3RhdGUnLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJc3ltcHRvbTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N5bXB0b20nLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdTeW1wdG9tJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnU3ltcHRvbScsIHVuZGVmaW5lZCldLnBhcmFtcy53aGVyZS5hbmQgOiBbXSwKCQkJCQkJCX0sCgkJCQkJCX0KCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQljbG9zZV9yZWFzb246IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdSZWFzb24nLCB1bmRlZmluZWQpXTogdiA/IHYuX3RvU0ZRdWVyeSgpW3RoaXMuX25Db2RlKCdSZWFzb24nLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJcHJpb3JpdHk6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJewoJCQkJCQkJaW5xOiB7CgkJCQkJCQkJQXBpTmFtZTogJ0lkJywKCQkJCQkJCQlbdGhpcy5fbkNvZGUoJ1ByaW9yaXR5JywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnUHJpb3JpdHknLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY2FsbGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQl7CgkJCQkJCQlpbnE6IHsKCQkJCQkJCQlBcGlOYW1lOiAnSWQnLAoJCQkJCQkJCVt0aGlzLl9uQ29kZSgnVXNlcicsIHVuZGVmaW5lZCldOiB2ID8gdi5fdG9TRlF1ZXJ5KClbdGhpcy5fbkNvZGUoJ1VzZXInLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY29udGFjdDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdVc2VyJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnVXNlcicsIHVuZGVmaW5lZCldLnBhcmFtcy53aGVyZS5hbmQgOiBbXSwKCQkJCQkJCX0sCgkJCQkJCX0KCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCSh2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbCkKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQl9LCAiX3RvU0ZRdWVyeSIpOwoKCQkvL09iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlpZiAoYlN0cmluZykgewoJCQlyZXQgPSB7CgkJCQlxdWVyeTogewoJCQkJCVt0aGlzLl9uQ29kZSgpICsgJ1F1ZXJ5J106IHsKCQkJCQkJdWlhcGk6IHJldAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJcmV0ID0gSlNPTi5zdHJpbmdpZnkocmV0LCBudWxsLCA0KTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NGUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqLnN5c19pZCA9IHYsCgoJCQlsb2NhdGlvbjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCQlncm91cDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCQlzdGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N0YXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCQlzeW1wdG9tOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b1NOUXVlcnkoKSA6IG51bGw7CgoJCQl9LAoKCQkJY2xvc2VfcmVhc29uOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCQlwcmlvcml0eTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3ByaW9yaXR5JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCQljYWxsZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9TTlF1ZXJ5KCkgOiBudWxsOwoKCQkJfSwKCgkJCWNvbnRhY3Q6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250YWN0JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJbGV0IGQgPSBgJHt2LmdldEZ1bGxZZWFyKCl9LSR7KCcwJysodi5nZXRNb250aCgpKzEpKS5zbGljZSgtMil9LSR7di5nZXREYXRlKCl9YDsKCQkJCWxldCB0ID0gYCR7di5nZXRIb3VycygpfToke3YuZ2V0TWludXRlcygpfToke3YuZ2V0U2Vjb25kcygpfWA7CgkJCQlpZiAoKHYuZ2V0SG91cnMoKSA9PSAwICYmIHYuZ2V0TWludXRlcygpID09IDAgJiYgdi5nZXRTZWNvbmRzKCkgPT0gMCkgfHwgdGhpcy5fZGF0ZV9jb29wID09ICc9JyB8fCAhdGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgT04ke2R9QGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9Jywnc3RhcnQnKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ2VuZCcpYDsKCQkJCX0gZWxzZSBpZiAodGhpcy5fZGF0ZV9jb29wICE9PSAnQkVUV0VFTicpIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0KCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCX0sICJfdG9TTlF1ZXJ5Iik7CgoJCU9iamVjdC5rZXlzKHJldC5PUEVSQVRPUlMgfHwge30pLmZpbHRlcihrID0+IHR5cGVvZihyZXRba10pICE9PSAndW5kZWZpbmVkJykuZm9yRWFjaChrID0+IHJldFtrXSA9IHJldC5PUEVSQVRPUlNba10gKyByZXRba10pOwoKCQlkZWxldGUgcmV0Lk9QRVJBVE9SUzsKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJcmV0ID0gRG90T2JqZWN0LmRvdChyZXQpOwoKCQkvLyBhdm9pZCBzZW5kaW5nIHdpdGggbm8gY29tcGFyaXNvbiBvcGVyYXRvcnMKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFbJz4nLCAnPCcsICdCRVRXRUVOJywgJ09OJywgJyEnLCAnPScsICdTVEFSVFNXSVRIJywgJ0xJS0UnXS5zb21lKHMgPT4gU3RyaW5nKHJldFtrXSkuc3RhcnRzV2l0aChzKSkpLmZvckVhY2goayA9PiByZXRba10gPSAodGhpc1tgXyR7a31fY29vcGBdIHx8ICdTVEFSVFNXSVRIJykgKyByZXRba10pOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIE9iamVjdC5lbnRyaWVzKHJldCB8fCB7fSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCWxldCBfcmV0ID0gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCBmYWxzZSwgZnVuLCBlYU9iaiwgb2JqKTsKCQkJCXJldHVybiBfcmV0OwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiZDc1ZDUwMGQtMmY3NS00ZTYxLWIzYTUtZDQ1OWZlMjYyNGM0IiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudCB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCWlmICghdGhpcy5sb2NhdGlvbigpIHx8ICh0aGlzLmxvY2F0aW9uKCkKCgkJCQkmJgoJCQkJIXRoaXMubG9jYXRpb24oKS5sb2NhdGlvbl9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoImxvY2F0aW9uIiwgb2JqLCB0aGlzLmxvY2F0aW9uKCkpOwoJCX0KCgkJaWYgKCF0aGlzLmdyb3VwKCkgfHwgKHRoaXMuZ3JvdXAoKQoKCQkJCSYmCgkJCQkhdGhpcy5ncm91cCgpLmdyb3VwX0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5ncm91cCgpLmdyb3VwX0dyb3VwX01lbWJlcnMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoImdyb3VwIiwgb2JqLCB0aGlzLmdyb3VwKCkpOwoJCX0KCgkJaWYgKCF0aGlzLnN0YXRlKCkgfHwgKHRoaXMuc3RhdGUoKQoKCQkJCSYmCgkJCQkhdGhpcy5zdGF0ZSgpLnN0YXRlX0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygic3RhdGUiLCBvYmosIHRoaXMuc3RhdGUoKSk7CgkJfQoKCQlpZiAoIXRoaXMuc3ltcHRvbSgpIHx8ICh0aGlzLnN5bXB0b20oKQoKCQkJCSYmCgkJCQkhdGhpcy5zeW1wdG9tKCkuc3ltcHRvbV9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoInN5bXB0b20iLCBvYmosIHRoaXMuc3ltcHRvbSgpKTsKCQl9CgoJCWlmICghdGhpcy5jbG9zZV9yZWFzb24oKSB8fCAodGhpcy5jbG9zZV9yZWFzb24oKQoKCQkJCSYmCgkJCQkhdGhpcy5jbG9zZV9yZWFzb24oKS5jbG9zZV9yZWFzb25fSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJjbG9zZV9yZWFzb24iLCBvYmosIHRoaXMuY2xvc2VfcmVhc29uKCkpOwoJCX0KCgkJaWYgKCF0aGlzLnByaW9yaXR5KCkgfHwgKHRoaXMucHJpb3JpdHkoKQoKCQkJCSYmCgkJCQkhdGhpcy5wcmlvcml0eSgpLnByaW9yaXR5X0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygicHJpb3JpdHkiLCBvYmosIHRoaXMucHJpb3JpdHkoKSk7CgkJfQoKCQlpZiAoIXRoaXMuY2FsbGVyKCkgfHwgKHRoaXMuY2FsbGVyKCkKCgkJCQkmJgoJCQkJIXRoaXMuY2FsbGVyKCkubWFuYWdlcl9EZXBhcnRtZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jYWxsZXIoKS5jYWxsZXJfSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmNhbGxlcigpLmNvbnRhY3RfSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmNhbGxlcigpLnVzZXJfR3JvdXBfTWVtYmVycygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygiY2FsbGVyIiwgb2JqLCB0aGlzLmNhbGxlcigpKTsKCQl9CgoJCWlmICghdGhpcy5jb250YWN0KCkgfHwgKHRoaXMuY29udGFjdCgpCgoJCQkJJiYKCQkJCSF0aGlzLmNvbnRhY3QoKS5tYW5hZ2VyX0RlcGFydG1lbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmNvbnRhY3QoKS5jYWxsZXJfSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmNvbnRhY3QoKS5jb250YWN0X0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jb250YWN0KCkudXNlcl9Hcm91cF9NZW1iZXJzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJjb250YWN0Iiwgb2JqLCB0aGlzLmNvbnRhY3QoKSk7CgkJfQoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydsb2NhdGlvbicsICdncm91cCcsICdzdGF0ZScsICdzeW1wdG9tJywgJ2Nsb3NlX3JlYXNvbicsICdwcmlvcml0eScsICdjYWxsZXInLCAnY29udGFjdCcsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCB0cnVlLCBmdW4sIG9iaiwgb2JqKTsKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmopOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiZDc1ZDUwMGQtMmY3NS00ZTYxLWIzYTUtZDQ1OWZlMjYyNGM0IiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudCB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5JbmNpZGVudFtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuSW5jaWRlbnRbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkluY2lkZW50W2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoImxvY2F0aW9uIiwgb2JqKTsKCgkJX29wdGlvbnMoImdyb3VwIiwgb2JqKTsKCgkJX29wdGlvbnMoInN0YXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoInN5bXB0b20iLCBvYmopOwoKCQlfb3B0aW9ucygiY2xvc2VfcmVhc29uIiwgb2JqKTsKCgkJX29wdGlvbnMoInByaW9yaXR5Iiwgb2JqKTsKCgkJX29wdGlvbnMoImNhbGxlciIsIG9iaik7CgoJCV9vcHRpb25zKCJjb250YWN0Iiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnbG9jYXRpb24nLCAnZ3JvdXAnLCAnc3RhdGUnLCAnc3ltcHRvbScsICdjbG9zZV9yZWFzb24nLCAncHJpb3JpdHknLCAnY2FsbGVyJywgJ2NvbnRhY3QnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaikpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9EQk9iamVjdChmaWVsZHMsIGJOb1JlZikgewoJCWlmICghdGhpcy5JZCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCAiSW52YWxpZCBJRCIsIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSwgdGhpcy5Ub29sKTsKCQl9CgkJbGV0IHJldCA9IHsKCQkJW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXTogIiciICsgdGhpcy5JZCArICInIgoJCX07CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibG9jYXRpb24iKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbG9jYXRpb25fc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmxvY2F0aW9uKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdsb2NhdGlvbicsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZ3JvdXAiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZ3JvdXBfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmdyb3VwKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigic3RhdGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fc3RhdGVfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnN0YXRlKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigic3ltcHRvbSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9zeW1wdG9tX3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5zeW1wdG9tKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSArICJpZCJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjbG9zZV9yZWFzb24iKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY2xvc2VfcmVhc29uX3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jbG9zZV9yZWFzb24oKTsKCgkJCWlmICh2ICYmICh2Ll9fc3luY19vbigpIHx8IHYuSWQgPT0gdi5JZCkpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYuSWQgKyAiJyI7CgkJCX0gZWxzZSB7CgkJCQlmVmFsdWUgPSAwOwoJCQl9CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicHJpb3JpdHkiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcHJpb3JpdHlfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnByaW9yaXR5KCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY2FsbGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NhbGxlcl9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY2FsbGVyKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvbnRhY3QiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY29udGFjdF9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29udGFjdCgpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2FjdGl2ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hY3RpdmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9lbmFibGVkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY29kZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jb2RlKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fb3JkZXJfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMub3JkZXIoKTsKCgkJCWZWYWx1ZSA9IHYgfHwgJzAnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZGF0ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5kYXRlKCk7CgoJCQl0cnkgewoJCQkJZlZhbHVlID0gIiciICsgKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiAiMTk3MC0xLTEiKSArICInIjsKCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJykgewoJCQkJCWZWYWx1ZSA9IGBTVFJfVE9fREFURSgke2ZWYWx1ZX0sICclWS0lbS0lZFQlVC4lZlonKWA7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9ICdkYXRldGltZSgnICsgZlZhbHVlICsgJyknOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9uYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm5hbWUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcmVtYXJrX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnJlbWFyaygpOwoKCQkJZlZhbHVlID0gIiciICsgKCh2ICYmIHYucmVwbGFjZSkgPyB2LnJlcGxhY2UoL1wnL2csICJcJ1wnIikgOiB2KSArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmIChbJ1NhbGVzRm9yY2UnXS5pbmRleE9mKHRoaXMuVG9vbC50eXBlLm5hbWUpID09IDApIHsKCQkJX28gPSBfcSA9ICIiOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXRoaXMuX19RID0gdGhpcy5fX1EgPT0gX28gPyBfcSA6IF9vOwoJCXJldHVybiB0aGlzLl9fUTsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpLCB0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkgKyAiLmlkIiwgdGhpcy5fbkNvZGUoJ3N0YXRlJywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCkgKyAiLmlkIiwgdGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCkgKyAiLmlkIiwgdGhpcy5fbkNvZGUoJ3ByaW9yaXR5JywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkgKyAiLmlkIiwgdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCldOwoJCWZpZWxkcyA9IEFycmF5LmlzQXJyYXkoZmllbGRzKSA/IGZpZWxkcyA6IFtmaWVsZHNdOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCS8vIHtmaWVsZDogb3JkZXJ9CgkJCWZpZWxkcyA9IFtdOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5sb2NhdGlvbikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5ncm91cCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5zdGF0ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ3N0YXRlJywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5zeW1wdG9tKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY2xvc2VfcmVhc29uKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uJywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5wcmlvcml0eSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ3ByaW9yaXR5JywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jYWxsZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvbnRhY3QpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb250YWN0JywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0sCgoJCQkJbG9jYXRpb246IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdsb2NhdGlvbicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmxvY2F0aW9uKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZ3JvdXA6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmdyb3VwKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJc3RhdGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnN0YXRlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJc3ltcHRvbTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N5bXB0b20nLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5zeW1wdG9tKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY2xvc2VfcmVhc29uOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuY2xvc2VfcmVhc29uKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcHJpb3JpdHk6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnByaW9yaXR5KG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY2FsbGVyOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuY2FsbGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29udGFjdDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb250YWN0KG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb2RlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5kYXRlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5uYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucmVtYXJrKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlOdWxsOiB0cnVlLAoKCQkJbG9jYXRpb246IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdsb2NhdGlvbicsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LkxvY2F0aW9uKG51bGwsIHRoaXMuVG9vbCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQlncm91cDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gb2JqW2VhQ29kZV0gPSBuZXcgc2FsZXNub3cuR3JvdXAobnVsbCwgdGhpcy5Ub29sKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJCXN0YXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5TdGF0ZShudWxsLCB0aGlzLlRvb2wpLl90b1NlbGVjdEhlYWRlcigpLAoKCQkJc3ltcHRvbTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3N5bXB0b20nLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5TeW1wdG9tKG51bGwsIHRoaXMuVG9vbCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQljbG9zZV9yZWFzb246IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5SZWFzb24obnVsbCwgdGhpcy5Ub29sKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJCXByaW9yaXR5OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Qcmlvcml0eShudWxsLCB0aGlzLlRvb2wpLl90b1NlbGVjdEhlYWRlcigpLAoKCQkJY2FsbGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2FsbGVyJywgdW5kZWZpbmVkKSkgPT4gb2JqW2VhQ29kZV0gPSBuZXcgc2FsZXNub3cuVXNlcihudWxsLCB0aGlzLlRvb2wpLl90b1NlbGVjdEhlYWRlcigpLAoKCQkJY29udGFjdDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Vc2VyKG51bGwsIHRoaXMuVG9vbCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCX0sICJfdG9TZWxlY3RIZWFkZXIiKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0SGVhZGVyJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU2VsZWN0U1FMKGZpZWxkcykgewoJCWxldCBzcWwgPSAic2VsZWN0ICI7CgoJCWxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9YDsKCgkJbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7CgoJCXNxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsKCgkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpIHsKCQkJLy8ge2ZpZWxkOiBmdW5jdGlvbn0KCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmxvY2F0aW9uKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5sb2NhdGlvbn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZ3JvdXApIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmdyb3VwfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5zdGF0ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuc3RhdGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3N0YXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnN5bXB0b20pIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnN5bXB0b219KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3N5bXB0b20nLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY2xvc2VfcmVhc29uKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jbG9zZV9yZWFzb259KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2Nsb3NlX3JlYXNvbicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5wcmlvcml0eSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMucHJpb3JpdHl9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3ByaW9yaXR5JywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNhbGxlcikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY2FsbGVyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29udGFjdCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29udGFjdH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCX0KCgkJc3FsICs9IGAgZnJvbSAke3RQcmVmfSBgOwoKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gYGxlZnQgam9pbiAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX0ke3RoaXMuX1EoKX0gYXMgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0gb24gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtrfWlkJHt0aGlzLl9RKCl9PSR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGApOwoKCQlzcWwgKz0gYCB3aGVyZSAxPTFgOwoKCQlzcWwgPSB0aGlzLl9fZXhwb3J0KHsKCQkJc3FsOiBzcWwKCQl9LCB7CgkJCV9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgPyBbJ0lkJ10gOiB1bmRlZmluZWQsCgkJCU51bGw6IHRydWUsCgkJCV9USElTOiBvYmogPT4gewoJCQkJaWYgKCF0aGlzLl9USElTIHx8ICF0aGlzLl9USElTLmxlbmd0aCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCh0Ll9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnKSkuam9pbignIFVOSU9OIEFMTCAnKSArICIpIjsKCQkJfSwKCQkJSWQ6IG9iaiA9PiBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2AsCgoJCQlsb2NhdGlvbjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9sb2NhdGlvbl9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX2xvY2F0aW9uX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZ3JvdXA6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZ3JvdXBfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9ncm91cF9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXN0YXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3N0YXRlX3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fc3RhdGVfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlzeW1wdG9tOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fc3ltcHRvbV9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX3N5bXB0b21fY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljbG9zZV9yZWFzb246IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX2Nsb3NlX3JlYXNvbl9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXByaW9yaXR5OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3ByaW9yaXR5X3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fcHJpb3JpdHlfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljYWxsZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NhbGxlcl9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX2NhbGxlcl9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNvbnRhY3Q6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250YWN0JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jb250YWN0X3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fY29udGFjdF9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jb2RlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fY29kZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX29yZGVyX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fb3JkZXJfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fZGF0ZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi50b0lTT1N0cmluZykgewoJCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbGl0ZScpIHsKCQkJCQkJb2JqLnNxbCArPSAic3RyZnRpbWUoJyVzJywgJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJykiOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9iai5zcWwgKz0gIiciICsgdi50b0lTT1N0cmluZygpICsgIiciOwoJCQkJCX0KCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9uYW1lX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9yZW1hcmtfc2V0KSByZXR1cm47CgoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b1NlbGVjdFNRTCIsIGZpZWxkcykuc3FsOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCWlmIChPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubG9jYXRpb24pIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmxvY2F0aW9ufWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmdyb3VwKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5ncm91cH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5zdGF0ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuc3RhdGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuc3ltcHRvbSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5zeW1wdG9tfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNsb3NlX3JlYXNvbikgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNsb3NlX3JlYXNvbn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5wcmlvcml0eSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMucHJpb3JpdHl9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY2FsbGVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuY2FsbGVyfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvbnRhY3QpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuY29udGFjdH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWR9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuY29kZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMubmFtZX1gOwoKCQl9CgoJCWlmIChzcWwuZW5kc1dpdGgoIndoZXJlIDE9MSIpKSB7CgkJCS8vIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEiLCAid2hlcmUgMT0wIik7CgkJfSBlbHNlIHsKCQkJc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSBhbmQgIiwgIndoZXJlICIpOwoJCX0KCgkJc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpIDogc3FsOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoKCQlyZXR1cm4gc3FsOwoJfQoKCV90b1BhdGhzKCkgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCV9USElTOiBvYmogPT4ge30sCgoJCQlsb2NhdGlvbjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2xvY2F0aW9uJywgdW5kZWZpbmVkKSkgPT4gb2JqLmxvY2F0aW9uID0gdi5fdG9QYXRocygpLAoKCQkJZ3JvdXA6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IG9iai5ncm91cCA9IHYuX3RvUGF0aHMoKSwKCgkJCXN0YXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpKSA9PiBvYmouc3RhdGUgPSB2Ll90b1BhdGhzKCksCgoJCQlzeW1wdG9tOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3ltcHRvbScsIHVuZGVmaW5lZCkpID0+IG9iai5zeW1wdG9tID0gdi5fdG9QYXRocygpLAoKCQkJY2xvc2VfcmVhc29uOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uJywgdW5kZWZpbmVkKSkgPT4gb2JqLmNsb3NlX3JlYXNvbiA9IHYuX3RvUGF0aHMoKSwKCgkJCXByaW9yaXR5OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpKSA9PiBvYmoucHJpb3JpdHkgPSB2Ll90b1BhdGhzKCksCgoJCQljYWxsZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYWxsZXInLCB1bmRlZmluZWQpKSA9PiBvYmouY2FsbGVyID0gdi5fdG9QYXRocygpLAoKCQkJY29udGFjdDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpKSA9PiBvYmouY29udGFjdCA9IHYuX3RvUGF0aHMoKSwKCgkJfSwgIl90b1BhdGhzIik7CgkJLy8gcmV0dXJuIHJldDsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5tYXAoayA9PiAoewoJCQlba106IHJldFtrXQoJCX0pKTsKCX0KCglfdG9VcGRhdGVTUUwoZmllbGRzKSB7CgkJbGV0IHJldEZpZWxkcyA9IHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLmpvaW4oJywgJyk7CgkJbGV0IHNxbCA9IGB1cGRhdGUgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSBzZXQgYCArIE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvREJPYmplY3QoZmllbGRzKSkubWFwKHYgPT4gdGhpcy5fUSgpICsgdlswXSArIHRoaXMuX1EoKSArICI9IiArIHZbMV0pICsgYCB3aGVyZSAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgOyAvL2AgcmV0dXJuaW5nICR7cmV0RmllbGRzfWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvVXBkYXRlU1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfdG9JbnNlcnRTUUwoZmllbGRzKSB7CgkJbGV0IG9iaiA9IHRoaXMuX3RvREJPYmplY3QoZmllbGRzKTsKCQlsZXQgc3FsID0gYGluc2VydCBpbnRvICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKGAgKyBPYmplY3Qua2V5cyhvYmopLm1hcChrID0+IHRoaXMuX1EoKSArIGsgKyB0aGlzLl9RKCkpICsgIikgdmFsdWVzICgiICsgT2JqZWN0LnZhbHVlcyhvYmopICsgYClgOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0luc2VydFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5JbmNpZGVudCkgcmV0dXJuOwoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5JbmNpZGVudCA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCBzcWwgPSBuZXcgc2FsZXNub3cuSW5jaWRlbnQoKQoKCQkJCQkubG9jYXRpb24obmV3IHNhbGVzbm93LkxvY2F0aW9uKCkpCgoJCQkJCS5ncm91cChuZXcgc2FsZXNub3cuR3JvdXAoKSkKCgkJCQkJLnN0YXRlKG5ldyBzYWxlc25vdy5TdGF0ZSgpKQoKCQkJCQkuc3ltcHRvbShuZXcgc2FsZXNub3cuU3ltcHRvbSgpKQoKCQkJCQkuY2xvc2VfcmVhc29uKG5ldyBzYWxlc25vdy5SZWFzb24oKSkKCgkJCQkJLnByaW9yaXR5KG5ldyBzYWxlc25vdy5Qcmlvcml0eSgpKQoKCQkJCQkuY2FsbGVyKG5ldyBzYWxlc25vdy5Vc2VyKCkpCgoJCQkJCS5jb250YWN0KG5ldyBzYWxlc25vdy5Vc2VyKCkpCgoJCQkJCS5fdG9TUUxUYWJsZShkZXB0aCk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiSW5jaWRlbnQiKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJbG9jYXRpb246IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmxvY2F0aW9uID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5sb2NhdGlvbigpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9sb2NhdGlvbl9zZXQgJiYgIXF1ZXJ5Ll9sb2NhdGlvbl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubG9jYXRpb24gPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbG9jYXRpb25fc2V0ICYmIHF1ZXJ5Ll9sb2NhdGlvbl9zZXQpIHx8CgoJCQkJCQkodGhpcy5sb2NhdGlvbigpICYmICF0aGlzLmxvY2F0aW9uKCkuX21hdGNoZXMocXVlcnkubG9jYXRpb24oKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmxvY2F0aW9uID0gZmFsc2U7CgkJCQl9LAoKCQkJCWdyb3VwOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5ncm91cCA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkuZ3JvdXAoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZ3JvdXBfc2V0ICYmICFxdWVyeS5fZ3JvdXBfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmdyb3VwID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2dyb3VwX3NldCAmJiBxdWVyeS5fZ3JvdXBfc2V0KSB8fAoKCQkJCQkJKHRoaXMuZ3JvdXAoKSAmJiAhdGhpcy5ncm91cCgpLl9tYXRjaGVzKHF1ZXJ5Lmdyb3VwKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5ncm91cCA9IGZhbHNlOwoJCQkJfSwKCgkJCQlzdGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouc3RhdGUgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LnN0YXRlKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3N0YXRlX3NldCAmJiAhcXVlcnkuX3N0YXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5zdGF0ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9zdGF0ZV9zZXQgJiYgcXVlcnkuX3N0YXRlX3NldCkgfHwKCgkJCQkJCSh0aGlzLnN0YXRlKCkgJiYgIXRoaXMuc3RhdGUoKS5fbWF0Y2hlcyhxdWVyeS5zdGF0ZSgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouc3RhdGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJc3ltcHRvbTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouc3ltcHRvbSA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkuc3ltcHRvbSgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9zeW1wdG9tX3NldCAmJiAhcXVlcnkuX3N5bXB0b21fc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnN5bXB0b20gPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fc3ltcHRvbV9zZXQgJiYgcXVlcnkuX3N5bXB0b21fc2V0KSB8fAoKCQkJCQkJKHRoaXMuc3ltcHRvbSgpICYmICF0aGlzLnN5bXB0b20oKS5fbWF0Y2hlcyhxdWVyeS5zeW1wdG9tKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5zeW1wdG9tID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNsb3NlX3JlYXNvbjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY2xvc2VfcmVhc29uID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5jbG9zZV9yZWFzb24oKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY2xvc2VfcmVhc29uX3NldCAmJiAhcXVlcnkuX2Nsb3NlX3JlYXNvbl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY2xvc2VfcmVhc29uID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2Nsb3NlX3JlYXNvbl9zZXQgJiYgcXVlcnkuX2Nsb3NlX3JlYXNvbl9zZXQpIHx8CgoJCQkJCQkodGhpcy5jbG9zZV9yZWFzb24oKSAmJiAhdGhpcy5jbG9zZV9yZWFzb24oKS5fbWF0Y2hlcyhxdWVyeS5jbG9zZV9yZWFzb24oKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNsb3NlX3JlYXNvbiA9IGZhbHNlOwoJCQkJfSwKCgkJCQlwcmlvcml0eTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucHJpb3JpdHkgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LnByaW9yaXR5KCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3ByaW9yaXR5X3NldCAmJiAhcXVlcnkuX3ByaW9yaXR5X3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5wcmlvcml0eSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9wcmlvcml0eV9zZXQgJiYgcXVlcnkuX3ByaW9yaXR5X3NldCkgfHwKCgkJCQkJCSh0aGlzLnByaW9yaXR5KCkgJiYgIXRoaXMucHJpb3JpdHkoKS5fbWF0Y2hlcyhxdWVyeS5wcmlvcml0eSgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucHJpb3JpdHkgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY2FsbGVyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jYWxsZXIgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LmNhbGxlcigpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jYWxsZXJfc2V0ICYmICFxdWVyeS5fY2FsbGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jYWxsZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY2FsbGVyX3NldCAmJiBxdWVyeS5fY2FsbGVyX3NldCkgfHwKCgkJCQkJCSh0aGlzLmNhbGxlcigpICYmICF0aGlzLmNhbGxlcigpLl9tYXRjaGVzKHF1ZXJ5LmNhbGxlcigpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY2FsbGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvbnRhY3Q6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvbnRhY3QgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LmNvbnRhY3QoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29udGFjdF9zZXQgJiYgIXF1ZXJ5Ll9jb250YWN0X3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb250YWN0ID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvbnRhY3Rfc2V0ICYmIHF1ZXJ5Ll9jb250YWN0X3NldCkgfHwKCgkJCQkJCSh0aGlzLmNvbnRhY3QoKSAmJiAhdGhpcy5jb250YWN0KCkuX21hdGNoZXMocXVlcnkuY29udGFjdCgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29udGFjdCA9IGZhbHNlOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoZXMiKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDAsIG9NYXRjaCk7CgoJCQlyZXR1cm4gT2JqZWN0LmtleXMob01hdGNoKS5ldmVyeShrID0+IG9NYXRjaFtrXSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfbWF0Y2hpbmcocXVlcnkpIHsKCQl0cnkgewoJCQlsZXQgcmV0ID0gW107CgoJCQlsZXQgbWF0Y2hlcyA9IHRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlsb2NhdGlvbjogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIGxvY2F0aW9uIik7CgkJCQkJb2JqLmxvY2F0aW9uID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJZ3JvdXA6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBncm91cCIpOwoJCQkJCW9iai5ncm91cCA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCXN0YXRlOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3Igc3RhdGUiKTsKCQkJCQlvYmouc3RhdGUgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQlzeW1wdG9tOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3Igc3ltcHRvbSIpOwoJCQkJCW9iai5zeW1wdG9tID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJY2xvc2VfcmVhc29uOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgY2xvc2VfcmVhc29uIik7CgkJCQkJb2JqLmNsb3NlX3JlYXNvbiA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCXByaW9yaXR5OiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgcHJpb3JpdHkiKTsKCQkJCQlvYmoucHJpb3JpdHkgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQljYWxsZXI6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBjYWxsZXIiKTsKCQkJCQlvYmouY2FsbGVyID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJY29udGFjdDogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIGNvbnRhY3QiKTsKCQkJCQlvYmouY29udGFjdCA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX2xvY2F0aW9uX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2dyb3VwX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3N0YXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3N5bXB0b21fc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY2xvc2VfcmVhc29uX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3ByaW9yaXR5X3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NhbGxlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb250YWN0X3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJbG9jYXRpb246IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5sb2NhdGlvbihyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJZ3JvdXA6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5ncm91cChyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJc3RhdGU6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5zdGF0ZShyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJc3ltcHRvbTogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLnN5bXB0b20ocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCWNsb3NlX3JlYXNvbjogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLmNsb3NlX3JlYXNvbihyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJcHJpb3JpdHk6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5wcmlvcml0eShyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJY2FsbGVyOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMuY2FsbGVyKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQljb250YWN0OiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMuY29udGFjdChyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCWxvY2F0aW9uOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpIDogImxvY2F0aW9uIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2xvY2F0aW9uX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLmxvY2F0aW9uKCkgfHwgbmV3IHNhbGVzbm93LkxvY2F0aW9uKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5sb2NhdGlvbihvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIGxvY2F0aW9uIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQlncm91cDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSA6ICJncm91cCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9ncm91cF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5ncm91cCgpIHx8IG5ldyBzYWxlc25vdy5Hcm91cCgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuZ3JvdXAob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSBncm91cCIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJc3RhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzdGF0ZScsIHVuZGVmaW5lZCkgOiAic3RhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fc3RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMuc3RhdGUoKSB8fCBuZXcgc2FsZXNub3cuU3RhdGUoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLnN0YXRlKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2Ugc3RhdGUiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCXN5bXB0b206IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSA6ICJzeW1wdG9tIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3N5bXB0b21fY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMuc3ltcHRvbSgpIHx8IG5ldyBzYWxlc25vdy5TeW1wdG9tKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5zeW1wdG9tKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2Ugc3ltcHRvbSIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJY2xvc2VfcmVhc29uOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY2xvc2VfcmVhc29uJywgdW5kZWZpbmVkKSA6ICJjbG9zZV9yZWFzb24iKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY2xvc2VfcmVhc29uX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLmNsb3NlX3JlYXNvbigpIHx8IG5ldyBzYWxlc25vdy5SZWFzb24oKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLmNsb3NlX3JlYXNvbihvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIGNsb3NlX3JlYXNvbiIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJcHJpb3JpdHk6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdwcmlvcml0eScsIHVuZGVmaW5lZCkgOiAicHJpb3JpdHkiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcHJpb3JpdHlfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMucHJpb3JpdHkoKSB8fCBuZXcgc2FsZXNub3cuUHJpb3JpdHkoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLnByaW9yaXR5KG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgcHJpb3JpdHkiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCWNhbGxlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCkgOiAiY2FsbGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NhbGxlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5jYWxsZXIoKSB8fCBuZXcgc2FsZXNub3cuVXNlcigpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuY2FsbGVyKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgY2FsbGVyIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQljb250YWN0OiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29udGFjdCcsIHVuZGVmaW5lZCkgOiAiY29udGFjdCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb250YWN0X2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLmNvbnRhY3QoKSB8fCBuZXcgc2FsZXNub3cuVXNlcigpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuY29udGFjdChvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIGNvbnRhY3QiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvZGUocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kYXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoJCQkJCWlmICh0eXBlb2YobW9tZW50KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZWYgPSBuZXcgRGF0ZShyZWYpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmVmID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpKTsKCQkJCX0KCQkJCXRoaXMuZGF0ZShyZWYpOwoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm5hbWUocmVmKTsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZW1hcmtfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnJlbWFyayhyZWYpOwoKCQkJfSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSA9IHYsCgoJCQkibG9jYXRpb24iOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbG9jYXRpb24nLCB1bmRlZmluZWQpIDogImxvY2F0aW9uIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fbG9jYXRpb25fY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2xvY2F0aW9uX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZ3JvdXAiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpIDogImdyb3VwIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fZ3JvdXBfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2dyb3VwX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkic3RhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnc3RhdGUnLCB1bmRlZmluZWQpIDogInN0YXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fc3RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3N0YXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkic3ltcHRvbSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzeW1wdG9tJywgdW5kZWZpbmVkKSA6ICJzeW1wdG9tIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fc3ltcHRvbV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fc3ltcHRvbV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNsb3NlX3JlYXNvbiI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjbG9zZV9yZWFzb24nLCB1bmRlZmluZWQpIDogImNsb3NlX3JlYXNvbiIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX2Nsb3NlX3JlYXNvbl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY2xvc2VfcmVhc29uX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicHJpb3JpdHkiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncHJpb3JpdHknLCB1bmRlZmluZWQpIDogInByaW9yaXR5IikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fcHJpb3JpdHlfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3ByaW9yaXR5X2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY2FsbGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NhbGxlcicsIHVuZGVmaW5lZCkgOiAiY2FsbGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fY2FsbGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jYWxsZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb250YWN0IjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvbnRhY3QnLCB1bmRlZmluZWQpIDogImNvbnRhY3QiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl9jb250YWN0X2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb250YWN0X2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3JkZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGw7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIG9ialtlYUNvZGVdID0gb2JqW2VhQ29kZV0ucmVwbGFjZSgvXC5bMC05XSpaL2csICcnKTsKCgkJCQlpZiAodGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGF0ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9uYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9uYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3JlbWFya19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2ZsaXAoKSAqLwoJX2ZsaXAoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9mbGlwKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fZmxpcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCglieUxvY2F0aW9uKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9sb2NhdGlvbiJdICYmIChhWyJfbG9jYXRpb24iXS5FcXVhbHMgPyBhWyJfbG9jYXRpb24iXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX2xvY2F0aW9uIl0sIHIpKSkgewoJCQkJCXIuX2xvY2F0aW9uX0luY2lkZW50cy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5R3JvdXAoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX2dyb3VwIl0gJiYgKGFbIl9ncm91cCJdLkVxdWFscyA/IGFbIl9ncm91cCJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfZ3JvdXAiXSwgcikpKSB7CgkJCQkJci5fZ3JvdXBfSW5jaWRlbnRzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlTdGF0ZShhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfc3RhdGUiXSAmJiAoYVsiX3N0YXRlIl0uRXF1YWxzID8gYVsiX3N0YXRlIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9zdGF0ZSJdLCByKSkpIHsKCQkJCQlyLl9zdGF0ZV9JbmNpZGVudHMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglieVN5bXB0b20oYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX3N5bXB0b20iXSAmJiAoYVsiX3N5bXB0b20iXS5FcXVhbHMgPyBhWyJfc3ltcHRvbSJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfc3ltcHRvbSJdLCByKSkpIHsKCQkJCQlyLl9zeW1wdG9tX0luY2lkZW50cy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5UmVhc29uKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9jbG9zZV9yZWFzb24iXSAmJiAoYVsiX2Nsb3NlX3JlYXNvbiJdLkVxdWFscyA/IGFbIl9jbG9zZV9yZWFzb24iXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX2Nsb3NlX3JlYXNvbiJdLCByKSkpIHsKCQkJCQlyLl9jbG9zZV9yZWFzb25fSW5jaWRlbnRzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlQcmlvcml0eShhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfcHJpb3JpdHkiXSAmJiAoYVsiX3ByaW9yaXR5Il0uRXF1YWxzID8gYVsiX3ByaW9yaXR5Il0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9wcmlvcml0eSJdLCByKSkpIHsKCQkJCQlyLl9wcmlvcml0eV9JbmNpZGVudHMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglieVVzZXIoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX2NhbGxlciJdICYmIChhWyJfY2FsbGVyIl0uRXF1YWxzID8gYVsiX2NhbGxlciJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfY2FsbGVyIl0sIHIpKSkgewoJCQkJCXIuX2NhbGxlcl9JbmNpZGVudHMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglieVVzZXIoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX2NvbnRhY3QiXSAmJiAoYVsiX2NvbnRhY3QiXS5FcXVhbHMgPyBhWyJfY29udGFjdCJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfY29udGFjdCJdLCByKSkpIHsKCQkJCQlyLl9jb250YWN0X0luY2lkZW50cy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gZmFsc2U7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5JbmNpZGVudC5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuSW5jaWRlbnQobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLmNvZGUodGhpcy5jb2RlKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCWlmICh0eXBlb2Yoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgPT09ICJ1bmRlZmluZWQiIHx8IHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQkJCWF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsKCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiA9IHsKCQkJCQkJCU93bmVyOiB0aGlzLAoJCQkJCQkJc3FsczogW10sCgkJCQkJCQlzdGFydDogbmV3IERhdGUoKSwKCQkJCQkJCWVuZDogbnVsbAoJCQkJCQl9OwoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX2xvY2F0aW9uX3NldCAmJiB0aGlzLmxvY2F0aW9uKCkgJiYgIShhd2FpdCB0aGlzLmxvY2F0aW9uKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfbG9jYXRpb24oKTsKCgkJCQkJaWYgKHRoaXMuX2dyb3VwX3NldCAmJiB0aGlzLmdyb3VwKCkgJiYgIShhd2FpdCB0aGlzLmdyb3VwKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfZ3JvdXAoKTsKCgkJCQkJaWYgKHRoaXMuX3N0YXRlX3NldCAmJiB0aGlzLnN0YXRlKCkgJiYgIShhd2FpdCB0aGlzLnN0YXRlKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfc3RhdGUoKTsKCgkJCQkJaWYgKHRoaXMuX3N5bXB0b21fc2V0ICYmIHRoaXMuc3ltcHRvbSgpICYmICEoYXdhaXQgdGhpcy5zeW1wdG9tKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfc3ltcHRvbSgpOwoKCQkJCQlpZiAodGhpcy5fY2xvc2VfcmVhc29uX3NldCAmJiB0aGlzLmNsb3NlX3JlYXNvbigpICYmICEoYXdhaXQgdGhpcy5jbG9zZV9yZWFzb24oKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9jbG9zZV9yZWFzb24oKTsKCgkJCQkJaWYgKHRoaXMuX3ByaW9yaXR5X3NldCAmJiB0aGlzLnByaW9yaXR5KCkgJiYgIShhd2FpdCB0aGlzLnByaW9yaXR5KCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfcHJpb3JpdHkoKTsKCgkJCQkJaWYgKHRoaXMuX2NhbGxlcl9zZXQgJiYgdGhpcy5jYWxsZXIoKSAmJiAhKGF3YWl0IHRoaXMuY2FsbGVyKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfY2FsbGVyKCk7CgoJCQkJCWlmICh0aGlzLl9jb250YWN0X3NldCAmJiB0aGlzLmNvbnRhY3QoKSAmJiAhKGF3YWl0IHRoaXMuY29udGFjdCgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX2NvbnRhY3QoKTsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBGaW5pc2hlZCBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0gSWQ9WyR7dGhpcy5JZH1dYCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBpbnNlcnQoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5JbmNpZGVudC5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvSW5zZXJ0U1FMKCkpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnaW5zZXJ0JywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJdGhpcy5fZnJvbURvY3VtZW50KGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJbGV0IG9iaiA9IHt9OwoKCQkJCWlmICh0aGlzLl9sb2NhdGlvbl9zZXQpIHsKCgkJCQkJb2JqLmxvY2F0aW9uID0gdGhpcy5fbG9jYXRpb24uSWQ7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9ncm91cF9zZXQpIHsKCgkJCQkJb2JqLmdyb3VwID0gdGhpcy5fZ3JvdXAuSWQ7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9zdGF0ZV9zZXQpIHsKCgkJCQkJb2JqLnN0YXRlID0gdGhpcy5fc3RhdGUuSWQ7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9zeW1wdG9tX3NldCkgewoKCQkJCQlvYmouc3ltcHRvbSA9IHRoaXMuX3N5bXB0b20uSWQ7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9jbG9zZV9yZWFzb25fc2V0KSB7CgoJCQkJCW9iai5jbG9zZV9yZWFzb24gPSB0aGlzLl9jbG9zZV9yZWFzb24uSWQ7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9wcmlvcml0eV9zZXQpIHsKCgkJCQkJb2JqLnByaW9yaXR5ID0gdGhpcy5fcHJpb3JpdHkuSWQ7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9jYWxsZXJfc2V0KSB7CgoJCQkJCW9iai5jYWxsZXIgPSB0aGlzLl9jYWxsZXIuSWQ7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9jb250YWN0X3NldCkgewoKCQkJCQlvYmouY29udGFjdCA9IHRoaXMuX2NvbnRhY3QuSWQ7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9hY3RpdmVfc2V0KSB7CgoJCQkJCW9iai5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9zZXQpIHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2NvZGVfc2V0KSB7CgoJCQkJCW9iai5jb2RlID0gdGhpcy5jb2RlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9vcmRlcl9zZXQpIHsKCgkJCQkJb2JqLm9yZGVyID0gdGhpcy5vcmRlcigpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZGF0ZV9zZXQpIHsKCgkJCQkJb2JqLmRhdGUgPSB0aGlzLmRhdGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX25hbWVfc2V0KSB7CgoJCQkJCW9iai5uYW1lID0gdGhpcy5uYW1lKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9yZW1hcmtfc2V0KSB7CgoJCQkJCW9iai5yZW1hcmsgPSB0aGlzLnJlbWFyaygpOwoKCQkJCX0KCgkJCQlsb2coIlNlbmRpbmcgdG8gU0YiLCBvYmopOwoKCQkJCWxldCByZXMgPSBhd2FpdCB0aGlzLlRvb2wuZGIuc29iamVjdCgiSW5jaWRlbnQiKS5jcmVhdGUob2JqKTsKCQkJCXRoaXMuSWQgPSByZXMuaWQ7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5JbmNpZGVudC51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1VwZGF0ZVNRTCgpKTsKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTCgpKTsKCQkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IHJldFswXTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkluY2lkZW50LmZpbmRBbGwnKTsKCgkJCS8vIGF2b2lkcyBjeWNsaWMgcXVlcmllcwoJCQlvYmpzID0gKG9ianMgfHwgW10pLm1hcChvID0+IG8uX2Nsb25lKCkpOwoKCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLz8/CgoJCQlsZXQgcmV0ID0gW107IC8vIGEganNvbiBhcnJheQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTChmaWVsZHMsIG9ianMpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgewoJCQkJCXN5c3Bhcm1fcXVlcnk6IE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvU05RdWVyeShmaWVsZHMsIG9ianMpKS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCB0cnVlKSwgbnVsbCwgewoJCQkJCXVybDogJ3Jlc3QudXJsLmdxbCcKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2ApOwoJCQkJcmV0ID0gcmV0LmNvbnRlbnQgPyBbSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSldIDogW107CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5tYXAociA9PiBuZXcgc2FsZXNub3cuSW5jaWRlbnQobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoKCX0KCn07CgpzYWxlc25vdy5TdGF0ZSA9IGNsYXNzIFN0YXRlIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUXNLaTVmY21WemRDd3FMbDlzYjJGa1ZHOXZiSE1pZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzZXlKdVlXMWxJam9pVTA1UFYwOVBRaUlzSW5SNWNHVWlPbnNpYm1GdFpTSTZJbE5sY25acFkyVk9iM2NpZlgwc0lsTmhiR1Z6Um05eVkyVWlMQ0pIYVhSSWRXSWlYUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2FjdGl2ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2VuYWJsZWQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb2RlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb2RlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3JkZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29yZGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZGF0ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZGF0ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm5hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX25hbWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3JlbWFyaygpOwoKCQl0aGlzLmNsZWFyX3N0YXRlX0luY2lkZW50cygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIlN0YXRlIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQkvLyAodGhpcy5zdGF0ZV9JbmNpZGVudHMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc3RhdGVfSW5jaWRlbnRzICoqLwoJc3RhdGVfSW5jaWRlbnRzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9zdGF0ZV9JbmNpZGVudHM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2Q3NWQ1MDBkLTJmNzUtNGU2MS1iM2E1LWQ0NTlmZTI2MjRjNCcgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnSW5jaWRlbnQnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX3N0YXRlX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0YXRlX0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAic3RhdGUgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkluY2lkZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RhdGVfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJzdGF0ZSBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkluY2lkZW50Iik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LnN0YXRlKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX3N0YXRlX0luY2lkZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX3N0YXRlX0luY2lkZW50c19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fc3RhdGVfSW5jaWRlbnRzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9zdGF0ZV9JbmNpZGVudHMoKSB7CgkJdGhpcy5fc3RhdGVfSW5jaWRlbnRzX3NldCA9IG51bGw7CgkJdGhpcy5fc3RhdGVfSW5jaWRlbnRzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fc3RhdGVfSW5jaWRlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc3RhdGVfSW5jaWRlbnRzICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJCXRoaXMuX3N0YXRlX0luY2lkZW50c19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0LnN0YXRlX0luY2lkZW50cyA9IHRoaXMuc3RhdGVfSW5jaWRlbnRzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQlzdGF0ZV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzdGF0ZV9TdGF0ZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkgIT0gJ1N0YXRlJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL1N0YXRlLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7CgoJCQl9CgoJCQkvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8KCgkJCWxldCB2ID0gdW5kZWZpbmVkOwoJCQl0cnkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke21ldGhvZH1gKTsKCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQlsZXQgX2lkID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgZGF0YSwgbWV0aG9kLCB7fSk7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIHsKCQkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKGRhdGEpOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSBkYXRhLl9fdGhpcy5jb2RlIHx8IGRhdGEuaWQgfHwgZGF0YS5JRDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCQlpZiAoZGF0YS5JZCAmJiBkYXRhLklkID09IGRhdGEuSWQpIHsKCQkJCQkJX2lkID0gZGF0YS5JZDsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5FbnRpdHlDbGFzcykgewoJCQkJCQlfaWQgPSBkYXRhLkVudGl0eUNsYXNzLklkIHx8IGRhdGEuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI1YTJhNDM5OS0zOGE2LTQ1ZmYtOTQ3OS0zODk3MTM2MGU4MWEiIHx8ICJOVUxMIjsKCQkJCQl9CgkJCQl9CgoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbbWV0aG9kXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVttZXRob2RdW19pZF0gfHwge307CgoJCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKHt9LCB7CgkJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJCX0pOwoKCQkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnU3RhdGUnKS5zZW5kZXIoc2FsZXNub3cuX25vZGUpLmNhcnJpZXIoc2FsZXNub3cuX25vZGUpLnBheWxvYWQoZGF0YSk7CgkJCWlmIChldmVudCkgewoJCQkJaWYgKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOwoJCQkJaWYgKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOwoJCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJaWYgKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOwoJCQl9CgkJCXJldCA9IGF3YWl0IGV2LnRyaWdnZXIoKTsKCgkJCWlmICh0eXBlb2YocmV0KSA9PT0gInN0cmluZyIpIHsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCX0KCQkJcmV0dXJuIHJldDsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5TdGF0ZShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuU3RhdGUobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuU3RhdGUoKS5faW52b2tlTm9kZSh0biwgbWV0aG9kLCBfcGFyYW1zKTsKCQl9CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYFN0YXRlLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgU3RhdGUuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGUuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuU3RhdGUuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglfcGFyc2VDb2RlU3RhdGUodCkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyc2VDb2RlU3RhdGUodCk7CgoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiU3RhdGUiKTsKCgl9CgoJX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXggPSAne3snLCBwb3N0Zml4ID0gJ319JykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCwgcG9zdGZpeCk7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCS8vIHRoaXMuc3RhdGVfU3RhdGVzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuU3RhdGUodGhpcy5JZCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkuc3RhdGVfSW5jaWRlbnRzKHRoaXMuc3RhdGVfSW5jaWRlbnRzKCksIHRoaXMuX3N0YXRlX0luY2lkZW50c19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSkgewoJCWNvbnRleHQgPSBjb250ZXh0IHx8ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCS8vb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCS8vb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ1N0YXRlJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgkJY29kZVR5cGUgPSBjb2RlVHlwZSB8fCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBlMzA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSlbY29kZV07CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIlN0YXRlIjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucyA9IHt9KSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fY29uZmlnKG4sIG51bGxWYWx1ZSwgT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucyB8fCB7fSwgewoJCQlfY2xhc3M6ICdTdGF0ZScKCQl9KSk7CgoJfQoKCWFzeW5jIF9yZXN0KHROYW1lID0gdGhpcy5fbkNvZGUoKSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMgPSB7fSkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIodW5kZWZpbmVkLCB0aGlzLlRvb2wpLl9yZXN0KHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zKTsKCgl9CgoJX3RvU1FMVGFibGUoKSB7CgkJbGV0IHJldCA9IHsKCQkJc3FsOiBgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoCiAgICAgICAgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVkKICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgYAoJCX07CgkJcmV0LnNxbCArPSAnLypTdGF0ZSovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQlzdGF0ZV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzdGF0ZV9TdGF0ZXMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypTdGF0ZSovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbChzcWwsIHRoaXMpOwoKCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIGJTdHJpbmcpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7CgkJCVt0aGlzLl9uQ29kZSgpXTogewoJCQkJcGFyYW1zOiB7CgkJCQkJd2hlcmU6IHsKCQkJCQkJYW5kOiBbXSwKCQkJCQkJb3I6IFtdCgkJCQkJfQoJCQkJfSwKCQkJCWVkZ2VzOiB7CgkJCQkJbm9kZToge30KCQkJCX0KCQkJfQoJCX0sIHsKCQkJLy9PUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKHsKCQkJCUlkOiB7CgkJCQkJZXE6IHYKCQkJCX0KCQkJfSksCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCSh2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbCkKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQl9LCAiX3RvU0ZRdWVyeSIpOwoKCQkvL09iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlpZiAoYlN0cmluZykgewoJCQlyZXQgPSB7CgkJCQlxdWVyeTogewoJCQkJCVt0aGlzLl9uQ29kZSgpICsgJ1F1ZXJ5J106IHsKCQkJCQkJdWlhcGk6IHJldAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJcmV0ID0gSlNPTi5zdHJpbmdpZnkocmV0LCBudWxsLCA0KTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NGUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqLnN5c19pZCA9IHYsCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJbGV0IGQgPSBgJHt2LmdldEZ1bGxZZWFyKCl9LSR7KCcwJysodi5nZXRNb250aCgpKzEpKS5zbGljZSgtMil9LSR7di5nZXREYXRlKCl9YDsKCQkJCWxldCB0ID0gYCR7di5nZXRIb3VycygpfToke3YuZ2V0TWludXRlcygpfToke3YuZ2V0U2Vjb25kcygpfWA7CgkJCQlpZiAoKHYuZ2V0SG91cnMoKSA9PSAwICYmIHYuZ2V0TWludXRlcygpID09IDAgJiYgdi5nZXRTZWNvbmRzKCkgPT0gMCkgfHwgdGhpcy5fZGF0ZV9jb29wID09ICc9JyB8fCAhdGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgT04ke2R9QGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9Jywnc3RhcnQnKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ2VuZCcpYDsKCQkJCX0gZWxzZSBpZiAodGhpcy5fZGF0ZV9jb29wICE9PSAnQkVUV0VFTicpIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0KCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCX0sICJfdG9TTlF1ZXJ5Iik7CgoJCU9iamVjdC5rZXlzKHJldC5PUEVSQVRPUlMgfHwge30pLmZpbHRlcihrID0+IHR5cGVvZihyZXRba10pICE9PSAndW5kZWZpbmVkJykuZm9yRWFjaChrID0+IHJldFtrXSA9IHJldC5PUEVSQVRPUlNba10gKyByZXRba10pOwoKCQlkZWxldGUgcmV0Lk9QRVJBVE9SUzsKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJcmV0ID0gRG90T2JqZWN0LmRvdChyZXQpOwoKCQkvLyBhdm9pZCBzZW5kaW5nIHdpdGggbm8gY29tcGFyaXNvbiBvcGVyYXRvcnMKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFbJz4nLCAnPCcsICdCRVRXRUVOJywgJ09OJywgJyEnLCAnPScsICdTVEFSVFNXSVRIJywgJ0xJS0UnXS5zb21lKHMgPT4gU3RyaW5nKHJldFtrXSkuc3RhcnRzV2l0aChzKSkpLmZvckVhY2goayA9PiByZXRba10gPSAodGhpc1tgXyR7a31fY29vcGBdIHx8ICdTVEFSVFNXSVRIJykgKyByZXRba10pOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIE9iamVjdC5lbnRyaWVzKHJldCB8fCB7fSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCWxldCBfcmV0ID0gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCBmYWxzZSwgZnVuLCBlYU9iaiwgb2JqKTsKCQkJCXJldHVybiBfcmV0OwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiNWEyYTQzOTktMzhhNi00NWZmLTk0NzktMzg5NzEzNjBlODFhIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCV9vcHRpb25zKCJzdGF0ZV9JbmNpZGVudHMiLCBvYmosIHRoaXMuc3RhdGVfSW5jaWRlbnRzKCkpOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnc3RhdGVfSW5jaWRlbnRzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCB0cnVlLCBmdW4sIG9iaiwgb2JqKTsKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmopOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiNWEyYTQzOTktMzhhNi00NWZmLTk0NzktMzg5NzEzNjBlODFhIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5TdGF0ZVtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuU3RhdGVbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlN0YXRlW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoInN0YXRlX0luY2lkZW50cyIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydzdGF0ZV9JbmNpZGVudHMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV06ICInIiArIHRoaXMuSWQgKyAiJyIKCQl9OwoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9hY3RpdmVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYWN0aXZlKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZW5hYmxlZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5lbmFibGVkKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvZGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29kZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2RhdGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZGF0ZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5uYW1lKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3JlbWFya19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5yZW1hcmsoKTsKCgkJCWZWYWx1ZSA9ICInIiArICgodiAmJiB2LnJlcGxhY2UpID8gdi5yZXBsYWNlKC9cJy9nLCAiXCdcJyIpIDogdikgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX1EoKSB7CgkJbGV0IF9vID0gJyInOwoJCWxldCBfcSA9IF9vOwoKCQlpZiAoWydTYWxlc0ZvcmNlJ10uaW5kZXhPZih0aGlzLlRvb2wudHlwZS5uYW1lKSA9PSAwKSB7CgkJCV9vID0gX3EgPSAiIjsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgewoJCQlfbyA9IF9xID0gJ2AnOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxzZXJ2ZXInKSB7CgkJCV9vID0gJ1snOwoJCQlfcSA9ICddJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ2FwaUtleScpID09ICdhaXJ0YWJsZScpIHsKCQkJX28gPSAneyc7CgkJCV9xID0gJ30nOwoJCX0KCQl0aGlzLl9fUSA9IHRoaXMuX19RID09IF9vID8gX3EgOiBfbzsKCQlyZXR1cm4gdGhpcy5fX1E7Cgl9CgoJX2ZpZWxkR3JvdXBzKGZncyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOwoJCXJldHVybiB0aGlzOwoJfQoKCV9maWVsZEFnZ3JlZ2F0ZXMoZmFzID0ge30pIHsKCQl0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOwoJCXJldHVybiB0aGlzOwoJfQoKCV90b0ZpZWxkc1NRTChmaWVsZHMpIHsKCgkJZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKSwgdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCldOwoJCWZpZWxkcyA9IEFycmF5LmlzQXJyYXkoZmllbGRzKSA/IGZpZWxkcyA6IFtmaWVsZHNdOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCS8vIHtmaWVsZDogb3JkZXJ9CgkJCWZpZWxkcyA9IFtdOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb2RlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5kYXRlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5uYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucmVtYXJrKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlOdWxsOiB0cnVlLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCX0KCgkJc3FsICs9IGAgZnJvbSAke3RQcmVmfSBgOwoKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gYGxlZnQgam9pbiAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX0ke3RoaXMuX1EoKX0gYXMgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0gb24gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtrfWlkJHt0aGlzLl9RKCl9PSR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGApOwoKCQlzcWwgKz0gYCB3aGVyZSAxPTFgOwoKCQlzcWwgPSB0aGlzLl9fZXhwb3J0KHsKCQkJc3FsOiBzcWwKCQl9LCB7CgkJCV9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgPyBbJ0lkJ10gOiB1bmRlZmluZWQsCgkJCU51bGw6IHRydWUsCgkJCV9USElTOiBvYmogPT4gewoJCQkJaWYgKCF0aGlzLl9USElTIHx8ICF0aGlzLl9USElTLmxlbmd0aCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCh0Ll9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnKSkuam9pbignIFVOSU9OIEFMTCAnKSArICIpIjsKCQkJfSwKCQkJSWQ6IG9iaiA9PiBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2AsCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvZGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2RhdGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVtYXJrX3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlzdGF0ZV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzdGF0ZV9TdGF0ZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3N0YXRlX0luY2lkZW50c19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoInN0YXRlLmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9zdGF0ZV9JbmNpZGVudHNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX3N0YXRlX0luY2lkZW50c19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9zdGF0ZV9JbmNpZGVudHNfY29vcCA9PSAnPScgfHwgdGhpcy5fc3RhdGVfSW5jaWRlbnRzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fc3RhdGVfSW5jaWRlbnRzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKnN0YXRlX0luY2lkZW50cyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJfSwgIl90b1NlbGVjdFNRTCIsIGZpZWxkcykuc3FsOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCWlmIChPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJc3RhdGVfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc3RhdGVfU3RhdGVzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnN0YXRlX0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQl9LCAiX3RvUGF0aHMiKTsKCQkvLyByZXR1cm4gcmV0OwoJCXJldHVybiBPYmplY3Qua2V5cyhyZXQpLm1hcChrID0+ICh7CgkJCVtrXTogcmV0W2tdCgkJfSkpOwoJfQoKCV90b1VwZGF0ZVNRTChmaWVsZHMpIHsKCQlsZXQgcmV0RmllbGRzID0gdGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkuam9pbignLCAnKTsKCQlsZXQgc3FsID0gYHVwZGF0ZSAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IHNldCBgICsgT2JqZWN0LmVudHJpZXModGhpcy5fdG9EQk9iamVjdChmaWVsZHMpKS5tYXAodiA9PiB0aGlzLl9RKCkgKyB2WzBdICsgdGhpcy5fUSgpICsgIj0iICsgdlsxXSkgKyBgIHdoZXJlICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2A7IC8vYCByZXR1cm5pbmcgJHtyZXRGaWVsZHN9YDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9VcGRhdGVTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV90b0luc2VydFNRTChmaWVsZHMpIHsKCQlsZXQgb2JqID0gdGhpcy5fdG9EQk9iamVjdChmaWVsZHMpOwoJCWxldCBzcWwgPSBgaW5zZXJ0IGludG8gJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoYCArIE9iamVjdC5rZXlzKG9iaikubWFwKGsgPT4gdGhpcy5fUSgpICsgayArIHRoaXMuX1EoKSkgKyAiKSB2YWx1ZXMgKCIgKyBPYmplY3QudmFsdWVzKG9iaikgKyBgKWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvSW5zZXJ0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlN0YXRlKSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlN0YXRlID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5TdGF0ZSgpCgoJCQkJCS5zdGF0ZV9JbmNpZGVudHMobmV3IHNhbGVzbm93LkluY2lkZW50KCkpCgoJCQkJCS5fdG9TUUxUYWJsZShkZXB0aCk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiU3RhdGUiKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCXN0YXRlX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5zdGF0ZV9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBxdWVyeS5zdGF0ZV9JbmNpZGVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXN0YXRlX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5zdGF0ZV9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJc3RhdGVfSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuc3RhdGVfSW5jaWRlbnRzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb2RlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jb2RlKHJlZik7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3JkZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9yZGVyKHJlZik7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLmRhdGUocmVmKTsKCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9uYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5uYW1lKHJlZik7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVtYXJrX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5yZW1hcmsocmVmKTsKCgkJCX0sCgoJCQlzdGF0ZV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzdGF0ZV9TdGF0ZXMnLCB1bmRlZmluZWQpIDogInN0YXRlX0luY2lkZW50cyIpKSA9PiB0aGlzLnN0YXRlX0luY2lkZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuSW5jaWRlbnQoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSA9IHYsCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3JkZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGw7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIG9ialtlYUNvZGVdID0gb2JqW2VhQ29kZV0ucmVwbGFjZSgvXC5bMC05XSpaL2csICcnKTsKCgkJCQlpZiAodGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGF0ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9uYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9uYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3JlbWFya19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQlzdGF0ZV9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzdGF0ZV9TdGF0ZXMnLCB1bmRlZmluZWQpIDogInN0YXRlX0luY2lkZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9zdGF0ZV9JbmNpZGVudHNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3N0YXRlX0luY2lkZW50c19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9mbGlwKCkgKi8KCV9mbGlwKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fZmxpcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9mbGlwKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2ZsaXAoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSBmYWxzZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLm5hbWUgPSB7fTsKCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgZXJyb3IubmFtZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IubmFtZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IubmFtZTsKCQl9CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlN0YXRlLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5TdGF0ZShudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuY29kZSh0aGlzLmNvZGUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9zdGF0ZV9JbmNpZGVudHNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5zdGF0ZV9JbmNpZGVudHMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCQlpZiAoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5Pd25lciA9PSB0aGlzKSB7CgkJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYENPTU1JVCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nIFRSQU5TQUNUSU9OJzonJ31gKTsKCQkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kID0gbmV3IERhdGUoKTsKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuU3RhdGUuaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b0luc2VydFNRTCgpKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luc2VydCcsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXRoaXMuX2Zyb21Eb2N1bWVudChhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCWxldCBvYmogPSB7fTsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX3NldCkgewoKCQkJCQlvYmouYWN0aXZlID0gdGhpcy5hY3RpdmUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfc2V0KSB7CgoJCQkJCW9iai5lbmFibGVkID0gdGhpcy5lbmFibGVkKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9jb2RlX3NldCkgewoKCQkJCQlvYmouY29kZSA9IHRoaXMuY29kZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fb3JkZXJfc2V0KSB7CgoJCQkJCW9iai5vcmRlciA9IHRoaXMub3JkZXIoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2RhdGVfc2V0KSB7CgoJCQkJCW9iai5kYXRlID0gdGhpcy5kYXRlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9uYW1lX3NldCkgewoKCQkJCQlvYmoubmFtZSA9IHRoaXMubmFtZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fcmVtYXJrX3NldCkgewoKCQkJCQlvYmoucmVtYXJrID0gdGhpcy5yZW1hcmsoKTsKCgkJCQl9CgoJCQkJbG9nKCJTZW5kaW5nIHRvIFNGIiwgb2JqKTsKCgkJCQlsZXQgcmVzID0gYXdhaXQgdGhpcy5Ub29sLmRiLnNvYmplY3QoIlN0YXRlIikuY3JlYXRlKG9iaik7CgkJCQl0aGlzLklkID0gcmVzLmlkOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuU3RhdGUudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5TdGF0ZS5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoZmllbGRzLCBvYmpzKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIHsKCQkJCQlzeXNwYXJtX3F1ZXJ5OiBPYmplY3QuZW50cmllcyh0aGlzLl90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgdHJ1ZSksIG51bGwsIHsKCQkJCQl1cmw6ICdyZXN0LnVybC5ncWwnCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgKTsKCQkJCXJldCA9IHJldC5jb250ZW50ID8gW0pTT04ucGFyc2UodGhpcy5fYXRvYihyZXQuY29udGVudCkpXSA6IFtdOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiQmVmb3JlIF9mcm9tRG9jdW1lbnQoKSIsIHJldCk7CgoJCQlyZXQgPSByZXQubWFwKHIgPT4gbmV3IHNhbGVzbm93LlN0YXRlKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuR3JvdXAgPSBjbGFzcyBHcm91cCBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFzS2k1ZmNtVnpkQ3dxTGw5c2IyRmtWRzl2YkhNaWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc2V5SnVZVzFsSWpvaVUwNVBWMDlQUWlJc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaWZYMHNJbE5oYkdWelJtOXlZMlVpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3BlbkluY2lkZW50VGhyZWFzaG9sZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3BlbkluY2lkZW50VGhyZWFzaG9sZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfZ3JvdXBfSW5jaWRlbnRzKCk7CgoJCXRoaXMuY2xlYXJfZ3JvdXBfR3JvdXBfTWVtYmVycygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIkdyb3VwIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQkvLyAodGhpcy5ncm91cF9JbmNpZGVudHMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQkvLyAodGhpcy5ncm91cF9Hcm91cF9NZW1iZXJzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJVEhJUyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsKCQlpZiAoIXYpIHJldHVybiB0aGlzOwoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCQl0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KSA9PT0gJ29iamVjdCcgJiYgX3YuRW50aXR5Q2xhc3MgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSA9PSB0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGUgPT0gdGhpcy5TY29wZSk7CgkJaWYgKGNvKSB0aGlzLl9USElTX2Nvb3AgPSBjbzsKCQlyZXR1cm4gdGhpczsKCX0KCgljbGVhcl9USElTKCkgewoJCXRoaXMuX1RISVMgPSBbXTsKCQl0aGlzLl9USElTX2Nvb3AgPSAnJzsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9wZW5JbmNpZGVudFRocmVhc2hvbGQgKiovCglvcGVuSW5jaWRlbnRUaHJlYXNob2xkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9wZW5JbmNpZGVudFRocmVhc2hvbGQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkICE9IHYpIHsKCQkJCXRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZCk7CgkJfQoJfQoKCWNsZWFyX29wZW5JbmNpZGVudFRocmVhc2hvbGQoKSB7CgkJdGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9zZXQgPSBudWxsOwoJCXRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGQgPSBudWxsOwoJCXRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9wZW5JbmNpZGVudFRocmVhc2hvbGQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoJY29kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb2RlICE9IHYpIHsKCQkJCXRoaXMuX2NvZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29kZSk7CgkJfQoJfQoKCWNsZWFyX2NvZGUoKSB7CgkJdGhpcy5fY29kZV9zZXQgPSBudWxsOwoJCXRoaXMuX2NvZGUgPSBudWxsOwoJCXRoaXMuX2NvZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCglkYXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImRhdGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJyA/IF92IDogKG5ldyBEYXRlKF92KSk7CgkJCQlpZiAoaXNOYU4oX3YuZ2V0VGltZSgpKSkgX3YgPSBudWxsOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuRGF0ZVZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RhdGUgIT0gdikgewoJCQkJdGhpcy5fZGF0ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkRhdGVWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGF0ZSk7CgkJfQoJfQoKCWNsZWFyX2RhdGUoKSB7CgkJdGhpcy5fZGF0ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2RhdGUgPSBudWxsOwoJCXRoaXMuX2RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoJbmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9uYW1lICE9IHYpIHsKCQkJCXRoaXMuX25hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX25hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbmFtZSk7CgkJfQoJfQoKCWNsZWFyX25hbWUoKSB7CgkJdGhpcy5fbmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX25hbWUgPSBudWxsOwoJCXRoaXMuX25hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCglyZW1hcmsodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9yZW1hcmtfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZW1hcmsiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3JlbWFyayAhPSB2KSB7CgkJCQl0aGlzLl9yZW1hcmtfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3JlbWFyayA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcmVtYXJrKTsKCQl9Cgl9CgoJY2xlYXJfcmVtYXJrKCkgewoJCXRoaXMuX3JlbWFya19zZXQgPSBudWxsOwoJCXRoaXMuX3JlbWFyayA9IG51bGw7CgkJdGhpcy5fcmVtYXJrX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBncm91cF9JbmNpZGVudHMgKiovCglncm91cF9JbmNpZGVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX2dyb3VwX0luY2lkZW50czsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnZDc1ZDUwMGQtMmY3NS00ZTYxLWIzYTUtZDQ1OWZlMjYyNGM0JyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdJbmNpZGVudCcpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fZ3JvdXBfc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ3JvdXBfSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJncm91cCBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiSW5jaWRlbnQiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdncm91cF9JbmNpZGVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgImdyb3VwIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiSW5jaWRlbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YuZ3JvdXAodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fZ3JvdXBfSW5jaWRlbnRzLnB1c2goLi4udik7CgkJdGhpcy5fZ3JvdXBfSW5jaWRlbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9ncm91cF9JbmNpZGVudHNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX2dyb3VwX0luY2lkZW50cygpIHsKCQl0aGlzLl9ncm91cF9JbmNpZGVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9ncm91cF9JbmNpZGVudHMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9ncm91cF9JbmNpZGVudHNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBncm91cF9JbmNpZGVudHMgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBncm91cF9Hcm91cF9NZW1iZXJzICoqLwoJZ3JvdXBfR3JvdXBfTWVtYmVycyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVyczsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnMmZmNGQ5NTItM2UwNy00MTQwLThjMDItYjliMTViMjhiMTQ2JyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdHcm91cCBNZW1iZXInKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX2dyb3VwX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dyb3VwX0dyb3VwX01lbWJlcnMnLCAnRW50aXR5T2JqZWN0JywgMSwgImdyb3VwIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJHcm91cF9NZW1iZXIiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdncm91cF9Hcm91cF9NZW1iZXJzJywgJ0VudGl0eU9iamVjdCcsIDEsICJncm91cCBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkdyb3VwX01lbWJlciIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5ncm91cCh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzLnB1c2goLi4udik7CgkJdGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVyc19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVyc19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfZ3JvdXBfR3JvdXBfTWVtYmVycygpIHsKCQl0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX3NldCA9IG51bGw7CgkJdGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVycyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBncm91cF9Hcm91cF9NZW1iZXJzICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9zZXQsCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fZ3JvdXBfSW5jaWRlbnRzX3NldCwKCgkJCXRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9zZXQgPSB0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX3NldDsKCQlyZXQuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfY29vcCA9IHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfY29vcDsKCQlyZXQub3BlbkluY2lkZW50VGhyZWFzaG9sZCA9IHRoaXMub3BlbkluY2lkZW50VGhyZWFzaG9sZCgpID8gdGhpcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKCkgOiB0aGlzLm9wZW5JbmNpZGVudFRocmVhc2hvbGQoKTsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0Lmdyb3VwX0luY2lkZW50cyA9IHRoaXMuZ3JvdXBfSW5jaWRlbnRzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXQuZ3JvdXBfR3JvdXBfTWVtYmVycyA9IHRoaXMuZ3JvdXBfR3JvdXBfTWVtYmVycygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkib3BlbkluY2lkZW50VGhyZWFzaG9sZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcGVuSW5jaWRlbnRUaHJlYXNob2xkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJZ3JvdXBfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXBfR3JvdXBzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJZ3JvdXBfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwX0dyb3VwcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCAmJiBldmVudC5jbGFzc05hbWUoKSAmJiBldmVudC5jbGFzc05hbWUoKSAhPSAnR3JvdXAnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiRGVsZWdhdGluZyBpbnZva2F0aW9uIHRvICIgKyBldmVudC5jbGFzc05hbWUoKSk7CgkJCQlyZXR1cm4gbmV3IHNhbGVzbm93W2V2ZW50LmNsYXNzTmFtZSgpXSgpLl9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpOwoJCQl9CgoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQlkYXRhLl9fdGhpcyA9IGRhdGEuX190aGlzIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkJc3dpdGNoIChtZXRob2QpIHsKCgkJCX0KCQl9CgoJCWlmICghbiB8fCBzYWxlc25vdy5fbm9kZS5fc2FtZU5vZGUobikpIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkNhbGxiYWNrIik7CgkJCXJldCA9IGF3YWl0IHRoaXMuX2ludm9rZShtZXRob2QsIGRhdGEpOwoJCX0gZWxzZSBpZiAobi5hZGRyZXNzKCkgJiYgbi5fc2FtZU5vZGUobikgLyphY3R1YWwgbm9kZSovICkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBuLl9hZGRyZXNzLCBuLl9wb3J0LCBtZXRob2QpOwoJCQl0cnkgewoJCQkJbGV0IGNvbmZpZyA9IHsKCQkJCQloZWFkZXJzOiB7fSwKCQkJCX07CgkJCQlpZiAoc2FsZXNub3cuX190b2tlbikgY29uZmlnLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGAke3NhbGVzbm93Ll9fdG9rZW4udG9rZW5fdHlwZX0gJHtzYWxlc25vdy5fX3Rva2VuLmFjY2Vzc190b2tlbn1gOwoJCQkJcmV0ID0gYXdhaXQgYXhpb3MucG9zdChgaHR0cCR7bi5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHtuLmFkZHJlc3MoKX06JHtuLnBvcnQoKSB8fCAzMDAwfS9tZXRob2QvR3JvdXAvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQkJZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOwoJCQkJZGVsZXRlIGRhdGEuX190aGlzLm9ubGluZTsKCgkJCX0KCgkJCS8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/PwoKCQkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJCXRyeSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0pIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7bWV0aG9kfWApOwoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCWxldCBfaWQgPSBudWxsOwoJCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBkYXRhLCBtZXRob2QsIHt9KTsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRhdGEpID09PSAnc3RyaW5nJykgewoJCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUoZGF0YSk7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IGRhdGEuX190aGlzLmNvZGUgfHwgZGF0YS5pZCB8fCBkYXRhLklEOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJCWlmIChkYXRhLklkICYmIGRhdGEuSWQgPT0gZGF0YS5JZCkgewoJCQkJCQlfaWQgPSBkYXRhLklkOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQkJfSBlbHNlIGlmIChkYXRhLkVudGl0eUNsYXNzKSB7CgkJCQkJCV9pZCA9IGRhdGEuRW50aXR5Q2xhc3MuSWQgfHwgZGF0YS5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgImRhMTcwYTQwLTY0NmItNGFkMi04MGFiLThkYWRiZTQ0NWI4ZSIgfHwgIk5VTEwiOwoJCQkJCX0KCQkJCX0KCgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXAgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFttZXRob2RdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFttZXRob2RdIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFttZXRob2RdW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW21ldGhvZF1bX2lkXSB8fCB7fTsKCgkJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goe30sIHsKCQkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQkJfSk7CgoJCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbbWV0aG9kXVtfaWRdW19oYXNoXTsKCQkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogNSkpIHsKCQkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIG1ldGhvZCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCQl2LnJldXNlZCsrOwoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0KCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSk7CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW21ldGhvZF1bX2lkXVtfaGFzaF0gPSB7CgkJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoe30pLAoJCQkJCW9iajogZGF0YSwKCQkJCQlyZXVzZWQ6IDAsCgkJCQl9OwoJCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0gPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGRhdGEsIG1ldGhvZCwge30sIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBgVHJpZ2dlcnJpbmcgJHttZXRob2R9IHRvICR7bi5jb2RlKCl9ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSxudWxsLDQpfWApOwoKCQkJbGV0IGV2ID0gbmV3IHNhbGVzbm93LkV2ZW50KCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuY29kZSh0aGlzLl91dWlkKCkpLm5hbWUodGhpcy5fX2NvbmZpZygnZXZlbnQnKSB8fCAnc2FsZXNub3cuRXZlbnQnKS5kYXRlKHRoaXMuc2VydmVyRGF0ZSgpKS5yZWNpcGllbnQobikubWV0aG9kKG1ldGhvZCkuY2xhc3NOYW1lKCdHcm91cCcpLnNlbmRlcihzYWxlc25vdy5fbm9kZSkuY2FycmllcihzYWxlc25vdy5fbm9kZSkucGF5bG9hZChkYXRhKTsKCQkJaWYgKGV2ZW50KSB7CgkJCQlpZiAoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7CgkJCQlpZiAoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7CgkJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7CgkJCQlpZiAoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7CgkJCX0KCQkJcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOwoKCQkJaWYgKHR5cGVvZihyZXQpID09PSAic3RyaW5nIikgewoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChleCkge30KCQkJfQoJCQlyZXR1cm4gcmV0OwoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93Lkdyb3VwKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5Hcm91cChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocCkpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHt9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2UobWV0aG9kLCBib2R5LCBxdWVyeSwgYXV0aE9iaikgewoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgbWV0aG9kLCBxdWVyeSwgYm9keSk7CgoJCWlmICh0eXBlb2YoYm9keSkgPT09ICdzdHJpbmcnIHx8ICh0eXBlb2YoQnVmZmVyKSAhPT0gJ3VuZGVmaW5lZCcgJiYgQnVmZmVyLmlzQnVmZmVyKGJvZHkpKSkgewoJCQl0cnkgewoJCQkJYm9keSA9IEpTT04ucGFyc2UoYm9keS50b1N0cmluZygpKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJvZHkgaXMgbm90IGEgdmFsaWQgSlNPTiIsIGJvZHkpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoKCQlsZXQgX3BhcmFtcyA9IHF1ZXJ5ID8gT2JqZWN0LmFzc2lnbihxdWVyeSwgYm9keSkgOiBib2R5OwoJCWlmICh0eXBlb2YoX3BhcmFtcykgPT09ICdzdHJpbmcnKSBfcGFyYW1zID0gSlNPTi5wYXJzZShfcGFyYW1zKTsKCgkJaWYgKF9wYXJhbXMpIHsKCQkJX3BhcmFtcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcyk7CgkJfSBlbHNlIHsKCQkJX3BhcmFtcyA9IHt9OwoJCX0KCgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgX3BhcmFtcy5fX2ZsYXR0ZWQpIF9wYXJhbXMgPSBGbGF0dGVkLnBhcnNlKF9wYXJhbXMuX19mbGF0dGVkKTsKCgkJaWYgKF9wYXJhbXMuX19ub2RlKSB7CgkJCS8vIHByb2JhYmx5IHNob3VsZCBub3QgYmUgcHJvY2Vzc2VkIGhlcmUsIGJ1dCByYXRoZXIgY29uc3VtZWQgYXMgcGFydCBvZiB0aGUgZXhlY3V0ZSgpIGxvZ2ljLCBwdXNoaW5nIF9fbm9kZSB0byB0aGUgbGlzdCBvZiBteSBub2RlcyB0byBkZWxlZ2F0ZSB0byE/CgkJCWxldCB0biA9IG5ldyBzYWxlc25vdy5Ob2RlKCkuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fbm9kZSkuX2RlUmVmZXJlbmNlKCk7CgkJCWRlbGV0ZSBfcGFyYW1zLl9fbm9kZTsKCQkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Hcm91cCgpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOwoJCX0KCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgR3JvdXAuX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBHcm91cC5faW52b2tlOiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLAoJCQkJCSdvYmonOiBvYmoKCQkJCX0KCQkJfTsKCQl9IGVsc2UgewoJCQlyZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOwoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJaWYgKGZhbHNlICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQlyZXQgPSB7CgkJCQkJX19leGNlcHRpb246IHsKCQkJCQkJJy00JzogIlVuY29tbWl0dGVkIHRyYW5zYWN0aW9uczogIiArIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uc3Fscy5sZW5ndGgsCgkJCQkJCSdvYmonOiBvYmoKCQkJCQl9CgkJCQl9CgkJCX0KCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQl9CgoJCWlmIChyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbikgewoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0ge307CgkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCXJldCA9IHJldC5tYXAociA9PiB7CgkJCQkJaWYgKHIgJiYgci5fdG9Eb2N1bWVudCkgewoJCQkJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cC5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5Hcm91cC4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9wYXJzZUNvZGVTdGF0ZSh0KSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9wYXJzZUNvZGVTdGF0ZSh0KTsKCgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlIHx8ICJHcm91cCIpOwoKCX0KCglfcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCA9ICd7eycsIHBvc3RmaXggPSAnfX0nKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4LCBwb3N0Zml4KTsKCgl9CgoJX19zeW5jX29uKGQpIHsKCQl0aGlzLl9fX3N5bmNfb24gPSB0aGlzLl9fX3N5bmNfb24gfHwge307CgoJCWlmIChkKSB7CgkJCXRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV0gPSBkOwoKCQkJLy8gdGhpcy5ncm91cF9Hcm91cHMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJLy8gdGhpcy5ncm91cF9Hcm91cHMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Hcm91cCh0aGlzLklkKQoKCQkJLm9wZW5JbmNpZGVudFRocmVhc2hvbGQodGhpcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKCksIHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfY29vcCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkuZ3JvdXBfSW5jaWRlbnRzKHRoaXMuZ3JvdXBfSW5jaWRlbnRzKCksIHRoaXMuX2dyb3VwX0luY2lkZW50c19jb29wKQoKCQkJLmdyb3VwX0dyb3VwX01lbWJlcnModGhpcy5ncm91cF9Hcm91cF9NZW1iZXJzKCksIHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQkvL29iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkvL29ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdHcm91cCc7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoJCWNvZGVUeXBlID0gY29kZVR5cGUgfHwgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZTMwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pW2NvZGVdOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJHcm91cCI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMgPSB7fSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX2NvbmZpZyhuLCBudWxsVmFsdWUsIE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMgfHwge30sIHsKCQkJX2NsYXNzOiAnR3JvdXAnCgkJfSkpOwoKCX0KCglhc3luYyBfcmVzdCh0TmFtZSA9IHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKHVuZGVmaW5lZCwgdGhpcy5Ub29sKS5fcmVzdCh0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyk7CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgYAoJCX07CgkJcmV0LnNxbCArPSAnLypHcm91cCovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJvcGVuSW5jaWRlbnRUaHJlYXNob2xkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQlncm91cF9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cF9Hcm91cHMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQkJZ3JvdXBfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwX0dyb3VwcycsIHVuZGVmaW5lZCkpID0+IG9iai5zcWwgPSB2Lm1hcChfdiA9PiBfdi5fdG9TUUxUYWJsZSgpKSArIG9iai5zcWwsCgoJCX0sICJfdG9TUUxUYWJsZSIpOwoKCQkvLyByZXQuc3FsICs9ICcvKkdyb3VwKi8pO1xuJzsKCgkJcmV0LnNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQocmV0LnNxbCkgOiByZXQuc3FsOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TUUxUYWJsZScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQuc3FsKTsKCQlyZXR1cm4gcmV0LnNxbDsKCX0KCglfZnJvbVNRTFRhYmxlKHRhYmxlLCBmaWVsZHMpIHsKCQkvLyB0YWJsZSBpcyBhIGpzb24gYXJyYXkKCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9wZW5JbmNpZGVudFRocmVhc2hvbGQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9wZW5JbmNpZGVudFRocmVhc2hvbGQodGFibGVbIm9wZW5JbmNpZGVudFRocmVhc2hvbGQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5hY3RpdmUodGFibGVbImFjdGl2ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5lbmFibGVkKHRhYmxlWyJlbmFibGVkIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvZGUodGFibGVbImNvZGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9yZGVyKHRhYmxlWyJvcmRlciJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5kYXRlKHRhYmxlWyJkYXRlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm5hbWUodGFibGVbIm5hbWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5yZW1hcmsodGFibGVbInJlbWFyayJdKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIF9zcWwoc3FsLCBzb3VyY2UgPSB0aGlzKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWwoc3FsLCB0aGlzKTsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCBiU3RyaW5nKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoewoJCQlbdGhpcy5fbkNvZGUoKV06IHsKCQkJCXBhcmFtczogewoJCQkJCXdoZXJlOiB7CgkJCQkJCWFuZDogW10sCgkJCQkJCW9yOiBbXQoJCQkJCX0KCQkJCX0sCgkJCQllZGdlczogewoJCQkJCW5vZGU6IHt9CgkJCQl9CgkJCX0KCQl9LCB7CgkJCS8vT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaCh7CgkJCQlJZDogewoJCQkJCWVxOiB2CgkJCQl9CgkJCX0pLAoKCQkJb3BlbkluY2lkZW50VGhyZWFzaG9sZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQkodiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGwpCgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJfSwgIl90b1NGUXVlcnkiKTsKCgkJLy9PYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJaWYgKGJTdHJpbmcpIHsKCQkJcmV0ID0gewoJCQkJcXVlcnk6IHsKCQkJCQlbdGhpcy5fbkNvZGUoKSArICdRdWVyeSddOiB7CgkJCQkJCXVpYXBpOiByZXQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXJldCA9IEpTT04uc3RyaW5naWZ5KHJldCwgbnVsbCwgNCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TRlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9iai5zeXNfaWQgPSB2LAoKCQkJb3BlbkluY2lkZW50VGhyZWFzaG9sZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlsZXQgZCA9IGAke3YuZ2V0RnVsbFllYXIoKX0tJHsoJzAnKyh2LmdldE1vbnRoKCkrMSkpLnNsaWNlKC0yKX0tJHt2LmdldERhdGUoKX1gOwoJCQkJbGV0IHQgPSBgJHt2LmdldEhvdXJzKCl9OiR7di5nZXRNaW51dGVzKCl9OiR7di5nZXRTZWNvbmRzKCl9YDsKCQkJCWlmICgodi5nZXRIb3VycygpID09IDAgJiYgdi5nZXRNaW51dGVzKCkgPT0gMCAmJiB2LmdldFNlY29uZHMoKSA9PSAwKSB8fCB0aGlzLl9kYXRlX2Nvb3AgPT0gJz0nIHx8ICF0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBPTiR7ZH1AamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdzdGFydCcpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywnZW5kJylgOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9kYXRlX2Nvb3AgIT09ICdCRVRXRUVOJykgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9IGVsc2UgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfQoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJfSwgIl90b1NOUXVlcnkiKTsKCgkJT2JqZWN0LmtleXMocmV0Lk9QRVJBVE9SUyB8fCB7fSkuZmlsdGVyKGsgPT4gdHlwZW9mKHJldFtrXSkgIT09ICd1bmRlZmluZWQnKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gcmV0Lk9QRVJBVE9SU1trXSArIHJldFtrXSk7CgoJCWRlbGV0ZSByZXQuT1BFUkFUT1JTOwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlyZXQgPSBEb3RPYmplY3QuZG90KHJldCk7CgoJCS8vIGF2b2lkIHNlbmRpbmcgd2l0aCBubyBjb21wYXJpc29uIG9wZXJhdG9ycwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVsnPicsICc8JywgJ0JFVFdFRU4nLCAnT04nLCAnIScsICc9JywgJ1NUQVJUU1dJVEgnLCAnTElLRSddLnNvbWUocyA9PiBTdHJpbmcocmV0W2tdKS5zdGFydHNXaXRoKHMpKSkuZm9yRWFjaChrID0+IHJldFtrXSA9ICh0aGlzW2BfJHtrfV9jb29wYF0gfHwgJ1NUQVJUU1dJVEgnKSArIHJldFtrXSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgT2JqZWN0LmVudHJpZXMocmV0IHx8IHt9KS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJbGV0IF9yZXQgPSBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIGZhbHNlLCBmdW4sIGVhT2JqLCBvYmopOwoJCQkJcmV0dXJuIF9yZXQ7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoIm9wZW5JbmNpZGVudFRocmVhc2hvbGQiLCBvYmosIHRoaXMub3BlbkluY2lkZW50VGhyZWFzaG9sZCgpKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqLCB0aGlzLmNvZGUoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmosIHRoaXMuZGF0ZSgpKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmosIHRoaXMubmFtZSgpKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaiwgdGhpcy5yZW1hcmsoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJkYTE3MGE0MC02NDZiLTRhZDItODBhYi04ZGFkYmU0NDViOGUiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXAgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiBvYmosCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIG9iaiwgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIl9USElTIiwgb2JqLCB0aGlzLl9USElTKTsKCgkJX29wdGlvbnMoImdyb3VwX0luY2lkZW50cyIsIG9iaiwgdGhpcy5ncm91cF9JbmNpZGVudHMoKSk7CgoJCV9vcHRpb25zKCJncm91cF9Hcm91cF9NZW1iZXJzIiwgb2JqLCB0aGlzLmdyb3VwX0dyb3VwX01lbWJlcnMoKSk7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ2dyb3VwX0luY2lkZW50cycsICdncm91cF9Hcm91cF9NZW1iZXJzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCB0cnVlLCBmdW4sIG9iaiwgb2JqKTsKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9wZW5JbmNpZGVudFRocmVhc2hvbGQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJkYTE3MGE0MC02NDZiLTRhZDItODBhYi04ZGFkYmU0NDViOGUiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXAgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cFtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcyk7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiZ3JvdXBfSW5jaWRlbnRzIiwgb2JqKTsKCgkJX29wdGlvbnMoImdyb3VwX0dyb3VwX01lbWJlcnMiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydvcGVuSW5jaWRlbnRUaHJlYXNob2xkJywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydncm91cF9JbmNpZGVudHMnLCAnZ3JvdXBfR3JvdXBfTWVtYmVycyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaikpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9EQk9iamVjdChmaWVsZHMsIGJOb1JlZikgewoJCWlmICghdGhpcy5JZCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCAiSW52YWxpZCBJRCIsIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSwgdGhpcy5Ub29sKTsKCQl9CgkJbGV0IHJldCA9IHsKCQkJW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXTogIiciICsgdGhpcy5JZCArICInIgoJCX07CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3BlbkluY2lkZW50VGhyZWFzaG9sZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9wZW5JbmNpZGVudFRocmVhc2hvbGQoKTsKCgkJCWZWYWx1ZSA9IHYgfHwgJzAnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcGVuSW5jaWRlbnRUaHJlYXNob2xkJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2FjdGl2ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hY3RpdmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9lbmFibGVkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY29kZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jb2RlKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fb3JkZXJfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMub3JkZXIoKTsKCgkJCWZWYWx1ZSA9IHYgfHwgJzAnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZGF0ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5kYXRlKCk7CgoJCQl0cnkgewoJCQkJZlZhbHVlID0gIiciICsgKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiAiMTk3MC0xLTEiKSArICInIjsKCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJykgewoJCQkJCWZWYWx1ZSA9IGBTVFJfVE9fREFURSgke2ZWYWx1ZX0sICclWS0lbS0lZFQlVC4lZlonKWA7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9ICdkYXRldGltZSgnICsgZlZhbHVlICsgJyknOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9uYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm5hbWUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcmVtYXJrX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnJlbWFyaygpOwoKCQkJZlZhbHVlID0gIiciICsgKCh2ICYmIHYucmVwbGFjZSkgPyB2LnJlcGxhY2UoL1wnL2csICJcJ1wnIikgOiB2KSArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmIChbJ1NhbGVzRm9yY2UnXS5pbmRleE9mKHRoaXMuVG9vbC50eXBlLm5hbWUpID09IDApIHsKCQkJX28gPSBfcSA9ICIiOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXRoaXMuX19RID0gdGhpcy5fX1EgPT0gX28gPyBfcSA6IF9vOwoJCXJldHVybiB0aGlzLl9fUTsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpLCB0aGlzLl9uQ29kZSgnb3BlbkluY2lkZW50VGhyZWFzaG9sZCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpXTsKCQlmaWVsZHMgPSBBcnJheS5pc0FycmF5KGZpZWxkcykgPyBmaWVsZHMgOiBbZmllbGRzXTsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQkvLyB7ZmllbGQ6IG9yZGVyfQoJCQlmaWVsZHMgPSBbXTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3BlbkluY2lkZW50VGhyZWFzaG9sZCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0sCgoJCQkJb3BlbkluY2lkZW50VGhyZWFzaG9sZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb2RlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5kYXRlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5uYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucmVtYXJrKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlOdWxsOiB0cnVlLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcGVuSW5jaWRlbnRUaHJlYXNob2xkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJfQoKCQlzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7CgoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCk7CgoJCXNxbCArPSBgIHdoZXJlIDE9MWA7CgoJCXNxbCA9IHRoaXMuX19leHBvcnQoewoJCQlzcWw6IHNxbAoJCX0sIHsKCQkJX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSA/IFsnSWQnXSA6IHVuZGVmaW5lZCwKCQkJTnVsbDogdHJ1ZSwKCQkJX1RISVM6IG9iaiA9PiB7CgkJCQlpZiAoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKHQuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOwoJCQl9LAoJCQlJZDogb2JqID0+IG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwKCgkJCW9wZW5JbmNpZGVudFRocmVhc2hvbGQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcGVuSW5jaWRlbnRUaHJlYXNob2xkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jb2RlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fb3JkZXJfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vcmRlcl9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9kYXRlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LnRvSVNPU3RyaW5nKSB7CgkJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3FsaXRlJykgewoJCQkJCQlvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbmFtZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX25hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3JlbWFya19zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZ3JvdXBfSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXBfR3JvdXBzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9ncm91cF9JbmNpZGVudHNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJncm91cC5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fZ3JvdXBfSW5jaWRlbnRzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl9ncm91cF9JbmNpZGVudHNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fZ3JvdXBfSW5jaWRlbnRzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX2dyb3VwX0luY2lkZW50c19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX2dyb3VwX0luY2lkZW50c19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLypncm91cF9JbmNpZGVudHMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCQlncm91cF9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXBfR3JvdXBzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX3NldCkgcmV0dXJuOwoKCQkJCWxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCgiZ3JvdXAuaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVyc19jb29wID09ICc9JyB8fCB0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fZ3JvdXBfR3JvdXBfTWVtYmVyc19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLypncm91cF9Hcm91cF9NZW1iZXJzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQl9LCAiX3RvU2VsZWN0U1FMIiwgZmllbGRzKS5zcWw7CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJaWYgKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29wZW5JbmNpZGVudFRocmVhc2hvbGQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcGVuSW5jaWRlbnRUaHJlYXNob2xkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jb2RlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMub3JkZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZGF0ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5uYW1lfWA7CgoJCX0KCgkJaWYgKHNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpIHsKCQkJLy8gc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSIsICJ3aGVyZSAxPTAiKTsKCQl9IGVsc2UgewoJCQlzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7CgkJfQoKCQlzcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCkgOiBzcWw7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgoJCXJldHVybiBzcWw7Cgl9CgoJX3RvUGF0aHMoKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJX1RISVM6IG9iaiA9PiB7fSwKCgkJCWdyb3VwX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwX0dyb3VwcycsIHVuZGVmaW5lZCkpID0+IG9iai5ncm91cF9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJCWdyb3VwX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cF9Hcm91cHMnLCB1bmRlZmluZWQpKSA9PiBvYmouZ3JvdXBfR3JvdXBfTWVtYmVycyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQl9LCAiX3RvUGF0aHMiKTsKCQkvLyByZXR1cm4gcmV0OwoJCXJldHVybiBPYmplY3Qua2V5cyhyZXQpLm1hcChrID0+ICh7CgkJCVtrXTogcmV0W2tdCgkJfSkpOwoJfQoKCV90b1VwZGF0ZVNRTChmaWVsZHMpIHsKCQlsZXQgcmV0RmllbGRzID0gdGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkuam9pbignLCAnKTsKCQlsZXQgc3FsID0gYHVwZGF0ZSAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IHNldCBgICsgT2JqZWN0LmVudHJpZXModGhpcy5fdG9EQk9iamVjdChmaWVsZHMpKS5tYXAodiA9PiB0aGlzLl9RKCkgKyB2WzBdICsgdGhpcy5fUSgpICsgIj0iICsgdlsxXSkgKyBgIHdoZXJlICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2A7IC8vYCByZXR1cm5pbmcgJHtyZXRGaWVsZHN9YDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9VcGRhdGVTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV90b0luc2VydFNRTChmaWVsZHMpIHsKCQlsZXQgb2JqID0gdGhpcy5fdG9EQk9iamVjdChmaWVsZHMpOwoJCWxldCBzcWwgPSBgaW5zZXJ0IGludG8gJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoYCArIE9iamVjdC5rZXlzKG9iaikubWFwKGsgPT4gdGhpcy5fUSgpICsgayArIHRoaXMuX1EoKSkgKyAiKSB2YWx1ZXMgKCIgKyBPYmplY3QudmFsdWVzKG9iaikgKyBgKWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvSW5zZXJ0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLkdyb3VwKSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLkdyb3VwID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5Hcm91cCgpCgoJCQkJCS5ncm91cF9JbmNpZGVudHMobmV3IHNhbGVzbm93LkluY2lkZW50KCkpCgoJCQkJCS5ncm91cF9Hcm91cF9NZW1iZXJzKG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIoKSkKCgkJCQkJLl90b1NRTFRhYmxlKGRlcHRoKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJHcm91cCIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlvcGVuSW5jaWRlbnRUaHJlYXNob2xkOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5vcGVuSW5jaWRlbnRUaHJlYXNob2xkID0gdiA9PSBxdWVyeS5vcGVuSW5jaWRlbnRUaHJlYXNob2xkKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0ICYmICFxdWVyeS5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3BlbkluY2lkZW50VGhyZWFzaG9sZCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX3NldCAmJiBxdWVyeS5fb3BlbkluY2lkZW50VGhyZWFzaG9sZF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9wZW5JbmNpZGVudFRocmVhc2hvbGQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCWdyb3VwX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5ncm91cF9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBxdWVyeS5ncm91cF9JbmNpZGVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCQlncm91cF9Hcm91cF9NZW1iZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmdyb3VwX0dyb3VwX01lbWJlcnMgPSB2Lm1hcChfdiA9PiBxdWVyeS5ncm91cF9Hcm91cF9NZW1iZXJzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoZXMiKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDAsIG9NYXRjaCk7CgoJCQlyZXR1cm4gT2JqZWN0LmtleXMob01hdGNoKS5ldmVyeShrID0+IG9NYXRjaFtrXSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfbWF0Y2hpbmcocXVlcnkpIHsKCQl0cnkgewoJCQlsZXQgcmV0ID0gW107CgoJCQlsZXQgbWF0Y2hlcyA9IHRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlncm91cF9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouZ3JvdXBfSW5jaWRlbnRzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCQlncm91cF9Hcm91cF9NZW1iZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmdyb3VwX0dyb3VwX01lbWJlcnMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fYWN0aXZlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcmRlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9kYXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX25hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcmVtYXJrX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlncm91cF9JbmNpZGVudHM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5ncm91cF9JbmNpZGVudHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJZ3JvdXBfR3JvdXBfTWVtYmVyczogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLmdyb3VwX0dyb3VwX01lbWJlcnMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCW9wZW5JbmNpZGVudFRocmVhc2hvbGQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcGVuSW5jaWRlbnRUaHJlYXNob2xkJywgdW5kZWZpbmVkKSA6ICJvcGVuSW5jaWRlbnRUaHJlYXNob2xkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9wZW5JbmNpZGVudFRocmVhc2hvbGQocmVmKTsKCgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb2RlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jb2RlKHJlZik7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3JkZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9yZGVyKHJlZik7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLmRhdGUocmVmKTsKCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9uYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5uYW1lKHJlZik7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVtYXJrX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5yZW1hcmsocmVmKTsKCgkJCX0sCgoJCQlncm91cF9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdncm91cF9Hcm91cHMnLCB1bmRlZmluZWQpIDogImdyb3VwX0luY2lkZW50cyIpKSA9PiB0aGlzLmdyb3VwX0luY2lkZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuSW5jaWRlbnQoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJCWdyb3VwX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdncm91cF9Hcm91cHMnLCB1bmRlZmluZWQpIDogImdyb3VwX0dyb3VwX01lbWJlcnMiKSkgPT4gdGhpcy5ncm91cF9Hcm91cF9NZW1iZXJzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSA9IHYsCgoJCQkib3BlbkluY2lkZW50VGhyZWFzaG9sZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcGVuSW5jaWRlbnRUaHJlYXNob2xkJywgdW5kZWZpbmVkKSA6ICJvcGVuSW5jaWRlbnRUaHJlYXNob2xkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29wZW5JbmNpZGVudFRocmVhc2hvbGRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCWdyb3VwX0luY2lkZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2dyb3VwX0dyb3VwcycsIHVuZGVmaW5lZCkgOiAiZ3JvdXBfSW5jaWRlbnRzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX2dyb3VwX0luY2lkZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZ3JvdXBfSW5jaWRlbnRzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQlncm91cF9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXBfR3JvdXBzJywgdW5kZWZpbmVkKSA6ICJncm91cF9Hcm91cF9NZW1iZXJzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2dyb3VwX0dyb3VwX01lbWJlcnNfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fZmxpcCgpICovCglfZmxpcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmxpcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9mbGlwKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCXRvU3RyaW5nKCkgewoKCQlyZXR1cm4gdGhpcy5fbmFtZTsKCgl9CgoJRW50aXR5VmFsdWUoYU5hbWUpIHsKCQlsZXQgcmV0ID0gW10uY29uY2F0KHRoaXMuRW50aXR5VmFsdWVzLCB0aGlzLlZhbHVlRW50aXRpZXMpLmZpbmQoZXYgPT4gZXYuRW50aXR5QXR0cmlidXRlICYmIGV2LkVudGl0eUF0dHJpYnV0ZS5OYW1lID09IGFOYW1lKTsKCgkJaWYgKCFyZXQpIHsKCQkJLy8gYW4gYXR0cmlidXRlIHRoYXQgaGFzIHlldCBubyBrbm93biBlbnRpdHkgdmFsdWUKCQkJcmV0ID0gewoJCQkJQWN0aXZlOiB0cnVlLAoJCQkJT1BFUkFUT1JTOiB7fSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGFOYW1lLAoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlFbnRpdHlDbGFzczogewoJCQkJCQlJZDogdGhpcy5FbnRpdHlDbGFzcy5JZAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaChyZXQpOwoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBmaW5kKGRlcHRoID0gMSkgewoJCXJldHVybiAoYXdhaXQgdGhpcy5maW5kQWxsKGRlcHRoKSlbMF07Cgl9CgoJX19hc3NlcnRWYWxpZChiU3luYykgewoJCWxldCBlcnJvciA9IHt9OwoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gZmFsc2U7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Hcm91cC5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuR3JvdXAobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLmNvZGUodGhpcy5jb2RlKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCWlmICh0eXBlb2Yoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgPT09ICJ1bmRlZmluZWQiIHx8IHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQkJCWF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsKCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiA9IHsKCQkJCQkJCU93bmVyOiB0aGlzLAoJCQkJCQkJc3FsczogW10sCgkJCQkJCQlzdGFydDogbmV3IERhdGUoKSwKCQkJCQkJCWVuZDogbnVsbAoJCQkJCQl9OwoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBGaW5pc2hlZCBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0gSWQ9WyR7dGhpcy5JZH1dYCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fZ3JvdXBfSW5jaWRlbnRzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuZ3JvdXBfSW5jaWRlbnRzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICh0aGlzLl9ncm91cF9Hcm91cF9NZW1iZXJzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuZ3JvdXBfR3JvdXBfTWVtYmVycygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBpbnNlcnQoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Hcm91cC5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvSW5zZXJ0U1FMKCkpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnaW5zZXJ0JywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJdGhpcy5fZnJvbURvY3VtZW50KGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJbGV0IG9iaiA9IHt9OwoKCQkJCWlmICh0aGlzLl9vcGVuSW5jaWRlbnRUaHJlYXNob2xkX3NldCkgewoKCQkJCQlvYmoub3BlbkluY2lkZW50VGhyZWFzaG9sZCA9IHRoaXMub3BlbkluY2lkZW50VGhyZWFzaG9sZCgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fYWN0aXZlX3NldCkgewoKCQkJCQlvYmouYWN0aXZlID0gdGhpcy5hY3RpdmUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfc2V0KSB7CgoJCQkJCW9iai5lbmFibGVkID0gdGhpcy5lbmFibGVkKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9jb2RlX3NldCkgewoKCQkJCQlvYmouY29kZSA9IHRoaXMuY29kZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fb3JkZXJfc2V0KSB7CgoJCQkJCW9iai5vcmRlciA9IHRoaXMub3JkZXIoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2RhdGVfc2V0KSB7CgoJCQkJCW9iai5kYXRlID0gdGhpcy5kYXRlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9uYW1lX3NldCkgewoKCQkJCQlvYmoubmFtZSA9IHRoaXMubmFtZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fcmVtYXJrX3NldCkgewoKCQkJCQlvYmoucmVtYXJrID0gdGhpcy5yZW1hcmsoKTsKCgkJCQl9CgoJCQkJbG9nKCJTZW5kaW5nIHRvIFNGIiwgb2JqKTsKCgkJCQlsZXQgcmVzID0gYXdhaXQgdGhpcy5Ub29sLmRiLnNvYmplY3QoIkdyb3VwIikuY3JlYXRlKG9iaik7CgkJCQl0aGlzLklkID0gcmVzLmlkOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuR3JvdXAudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Hcm91cC5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoZmllbGRzLCBvYmpzKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIHsKCQkJCQlzeXNwYXJtX3F1ZXJ5OiBPYmplY3QuZW50cmllcyh0aGlzLl90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgdHJ1ZSksIG51bGwsIHsKCQkJCQl1cmw6ICdyZXN0LnVybC5ncWwnCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgKTsKCQkJCXJldCA9IHJldC5jb250ZW50ID8gW0pTT04ucGFyc2UodGhpcy5fYXRvYihyZXQuY29udGVudCkpXSA6IFtdOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiQmVmb3JlIF9mcm9tRG9jdW1lbnQoKSIsIHJldCk7CgoJCQlyZXQgPSByZXQubWFwKHIgPT4gbmV3IHNhbGVzbm93Lkdyb3VwKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuR3JvdXBfTWVtYmVyID0gY2xhc3MgR3JvdXBfTWVtYmVyIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUXNLaTVmY21WemRDd3FMbDlzYjJGa1ZHOXZiSE1pZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzZXlKdVlXMWxJam9pVTA1UFYwOVBRaUlzSW5SNWNHVWlPbnNpYm1GdFpTSTZJbE5sY25acFkyVk9iM2NpZlgwc0lsTmhiR1Z6Um05eVkyVWlMQ0pIYVhSSWRXSWlYUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJncm91cCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZ3JvdXAoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJ1c2VyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl91c2VyKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiR3JvdXAgTWVtYmVyIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQkvLyBpZih0aGlzLl9ncm91cF9zZXQgJiYgdGhpcy5fZ3JvdXApIHRoaXMuX2dyb3VwLlRvb2wgPSB0b29sOwoKCQkvLyBpZih0aGlzLl91c2VyX3NldCAmJiB0aGlzLl91c2VyKSB0aGlzLl91c2VyLlRvb2wgPSB0b29sOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXAgKiovCglncm91cCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2dyb3VwX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZ3JvdXAiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICdkYTE3MGE0MC02NDZiLTRhZDItODBhYi04ZGFkYmU0NDViOGUnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdHcm91cCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdncm91cCcsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgImRhMTcwYTQwLTY0NmItNGFkMi04MGFiLThkYWRiZTQ0NWI4ZSIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJHcm91cCIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9ncm91cCAhPSB2KSB7CgkJCQl0aGlzLl9ncm91cF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dyb3VwJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9ncm91cCA/IHRoaXMuX2dyb3VwLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9ncm91cF9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fZ3JvdXAgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZ3JvdXApOwoJCX0KCX0KCgljbGVhcl9ncm91cCgpIHsKCQl0aGlzLl9ncm91cF9zZXQgPSBudWxsOwoJCXRoaXMuX2dyb3VwID0gbnVsbDsKCQl0aGlzLl9ncm91cF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZ3JvdXAgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB1c2VyICoqLwoJdXNlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3VzZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJ1c2VyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnMDI2NDVjNWMtYmUwNC00ZGFiLTkxYjQtZjhjODViZTk0YTZlJyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnVXNlcicpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1c2VyJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiMDI2NDVjNWMtYmUwNC00ZGFiLTkxYjQtZjhjODViZTk0YTZlIiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIlVzZXIiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fdXNlciAhPSB2KSB7CgkJCQl0aGlzLl91c2VyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXNlcicsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fdXNlciA/IHRoaXMuX3VzZXIuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX3VzZXJfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX3VzZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fdXNlcik7CgkJfQoJfQoKCWNsZWFyX3VzZXIoKSB7CgkJdGhpcy5fdXNlcl9zZXQgPSBudWxsOwoJCXRoaXMuX3VzZXIgPSBudWxsOwoJCXRoaXMuX3VzZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHVzZXIgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9ncm91cF9zZXQsCgoJCQl0aGlzLl91c2VyX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX2dyb3VwX3NldCA9IHRoaXMuX2dyb3VwX3NldDsKCQlyZXQuX2dyb3VwX2Nvb3AgPSB0aGlzLl9ncm91cF9jb29wOwoJCXJldC5ncm91cCA9IHRoaXMuZ3JvdXAoKSA/IHRoaXMuZ3JvdXAoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5ncm91cCgpOwoKCQlyZXQuX3VzZXJfc2V0ID0gdGhpcy5fdXNlcl9zZXQ7CgkJcmV0Ll91c2VyX2Nvb3AgPSB0aGlzLl91c2VyX2Nvb3A7CgkJcmV0LnVzZXIgPSB0aGlzLnVzZXIoKSA/IHRoaXMudXNlcigpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLnVzZXIoKTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkiZ3JvdXAiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJ1c2VyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJncm91cCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgZ3JvdXAnLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93Lkdyb3VwKCkuZ3JvdXBfR3JvdXBfTWVtYmVycyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInVzZXIiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIHVzZXInLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93LlVzZXIoKS51c2VyX0dyb3VwX01lbWJlcnModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCX0pOwoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpIHsKCQkvLyBpZighbikgcmV0dXJuIG51bGw7CgoJCWlmICh0eXBlb2Yoc2FsZXNub3cuX25vZGUpID09PSAndW5kZWZpbmVkJykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAic2FsZXNub3cuX25vZGUgbm90IGRlZmluZWQiKTsKCQkJcmV0dXJuIG51bGw7CgkJfQoKCQlpZiAoZXZlbnQpIHsKCgkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCAmJiBldmVudC5jbGFzc05hbWUoKSAmJiBldmVudC5jbGFzc05hbWUoKSAhPSAnR3JvdXBfTWVtYmVyJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL0dyb3VwX01lbWJlci8ke21ldGhvZH1gLCBkYXRhLCBjb25maWcpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQl9CgkJfSBlbHNlIHsKCgkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMuX19nZW5lcmF0ZWQ7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMub25saW5lOwoKCQkJfQoKCQkJLy93aHkgZG8gd2UgbmVlZCB0aGlzPz8/CgoJCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQkJdHJ5IHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHttZXRob2R9YCk7CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJbGV0IF9pZCA9IG51bGw7CgkJCQlpZiAodHlwZW9mKGRhdGEpID09PSAndW5kZWZpbmVkJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIGRhdGEsIG1ldGhvZCwge30pOwoJCQkJCXJldHVybiBkYXRhOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoZGF0YSkgPT09ICdzdHJpbmcnKSB7CgkJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShkYXRhKTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gZGF0YS5fX3RoaXMuY29kZSB8fCBkYXRhLmlkIHx8IGRhdGEuSUQ7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQkJaWYgKGRhdGEuSWQgJiYgZGF0YS5JZCA9PSBkYXRhLklkKSB7CgkJCQkJCV9pZCA9IGRhdGEuSWQ7CgkJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCQl9IGVsc2UgaWYgKGRhdGEuRW50aXR5Q2xhc3MpIHsKCQkJCQkJX2lkID0gZGF0YS5FbnRpdHlDbGFzcy5JZCB8fCBkYXRhLkVudGl0eUNsYXNzLk5hbWU7CgkJCQkJfSBlbHNlIHsKCQkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiMmZmNGQ5NTItM2UwNy00MTQwLThjMDItYjliMTViMjhiMTQ2IiB8fCAiTlVMTCI7CgkJCQkJfQoJCQkJfQoKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXIgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlciB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyW21ldGhvZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlclttZXRob2RdIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbbWV0aG9kXVtfaWRdIHx8IHt9OwoKCQkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaCh7fSwgewoJCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCQl9KTsKCgkJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbbWV0aG9kXVtfaWRdW19oYXNoXTsKCQkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogNSkpIHsKCQkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIG1ldGhvZCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCQl2LnJldXNlZCsrOwoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0KCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSk7CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlclttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnR3JvdXBfTWVtYmVyJykuc2VuZGVyKHNhbGVzbm93Ll9ub2RlKS5jYXJyaWVyKHNhbGVzbm93Ll9ub2RlKS5wYXlsb2FkKGRhdGEpOwoJCQlpZiAoZXZlbnQpIHsKCQkJCWlmIChldmVudC5fcmVzcG9uc2VUb19zZXQpIGV2LnJlc3BvbnNlVG8oZXZlbnQucmVzcG9uc2VUbygpKTsKCQkJCWlmIChldmVudC5fc2VuZGVyX3NldCkgZXYuc2VuZGVyKGV2ZW50LnNlbmRlcigpKTsKCQkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCkgZXYuY2xhc3NOYW1lKGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCWlmIChldmVudC5fY2Fycmllcl9zZXQgfHwgZXZlbnQuX3NlbmRlcl9zZXQpIGV2LmNhcnJpZXIoZXZlbnQuY2FycmllcigpIHx8IGV2ZW50LnNlbmRlcigpKTsKCQkJfQoJCQlyZXQgPSBhd2FpdCBldi50cmlnZ2VyKCk7CgoJCQlpZiAodHlwZW9mKHJldCkgPT09ICJzdHJpbmciKSB7CgkJCQl0cnkgewoJCQkJCXJldCA9IEpTT04ucGFyc2UocmV0KTsKCQkJCX0gY2F0Y2ggKGV4KSB7fQoJCQl9CgkJCXJldHVybiByZXQ7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5zZXJ0IjoKCQkJY2FzZSAidXBkYXRlIjoKCQkJY2FzZSAic3RvcmUiOgoJCQljYXNlICJkZWxldGUiOgoJCQljYXNlICJmaW5kIjogewoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuR3JvdXBfTWVtYmVyKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuR3JvdXBfTWVtYmVyKCkuX2ludm9rZU5vZGUodG4sIG1ldGhvZCwgX3BhcmFtcyk7CgkJfQoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBHcm91cF9NZW1iZXIuX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBHcm91cF9NZW1iZXIuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyLl90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93Lkdyb3VwX01lbWJlci4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9wYXJzZUNvZGVTdGF0ZSh0KSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9wYXJzZUNvZGVTdGF0ZSh0KTsKCgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlIHx8ICJHcm91cCBNZW1iZXIiKTsKCgl9CgoJX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXggPSAne3snLCBwb3N0Zml4ID0gJ319JykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCwgcG9zdGZpeCk7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCWlmICh0aGlzLl9ncm91cF9zZXQgJiYgdGhpcy5ncm91cCgpKSB0aGlzLmdyb3VwKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX3VzZXJfc2V0ICYmIHRoaXMudXNlcigpKSB0aGlzLnVzZXIoKS5fX3N5bmNfb24oZCk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93Lkdyb3VwX01lbWJlcih0aGlzLklkKQoKCQkJLmdyb3VwKHRoaXMuZ3JvdXAoKSwgdGhpcy5fZ3JvdXBfY29vcCkKCgkJCS51c2VyKHRoaXMudXNlcigpLCB0aGlzLl91c2VyX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJLy9vYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJLy9vYmpUbyA9IG9ialRvIHx8IHt9OwoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAnR3JvdXBfTWVtYmVyJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgkJY29kZVR5cGUgPSBjb2RlVHlwZSB8fCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpuY205MWNDSTZJa2R5YjNWd0lpd2lkWE5sY2lJNklsVnpaWElpZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pW2NvZGVdOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJHcm91cF9NZW1iZXIiOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19jb25maWcobiwgbnVsbFZhbHVlLCBPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zIHx8IHt9LCB7CgkJCV9jbGFzczogJ0dyb3VwX01lbWJlcicKCQl9KSk7CgoJfQoKCWFzeW5jIF9yZXN0KHROYW1lID0gdGhpcy5fbkNvZGUoKSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMgPSB7fSkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIodW5kZWZpbmVkLCB0aGlzLlRvb2wpLl9yZXN0KHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zKTsKCgl9CgoJX3RvU1FMVGFibGUoKSB7CgkJbGV0IHJldCA9IHsKCQkJc3FsOiBgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoCiAgICAgICAgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVkKICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qR3JvdXBfTWVtYmVyKi8pO1xuJzsKCgkJcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogdHJ1ZSwKCQkJTnVsbDogdHJ1ZSwKCQkJLy9JZDogKG9iaiwgdikgPT4gb2JqLnNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVlgLAoKCQkJImdyb3VwIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJ1c2VyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndXNlcicsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCX0sICJfdG9TUUxUYWJsZSIpOwoKCQkvLyByZXQuc3FsICs9ICcvKkdyb3VwX01lbWJlciovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJncm91cCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZ3JvdXAodGFibGVbImdyb3VwIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInVzZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnVzZXIodGFibGVbInVzZXIiXSk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBfc3FsKHNxbCwgc291cmNlID0gdGhpcykgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsKHNxbCwgdGhpcyk7CgoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgYlN0cmluZykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHsKCQkJW3RoaXMuX25Db2RlKCldOiB7CgkJCQlwYXJhbXM6IHsKCQkJCQl3aGVyZTogewoJCQkJCQlhbmQ6IFtdLAoJCQkJCQlvcjogW10KCQkJCQl9CgkJCQl9LAoJCQkJZWRnZXM6IHsKCQkJCQlub2RlOiB7fQoJCQkJfQoJCQl9CgkJfSwgewoJCQkvL09QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goewoJCQkJSWQ6IHsKCQkJCQllcTogdgoJCQkJfQoJCQl9KSwKCgkJCWdyb3VwOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdHcm91cCcsIHVuZGVmaW5lZCldOiB2ID8gdi5fdG9TRlF1ZXJ5KClbdGhpcy5fbkNvZGUoJ0dyb3VwJywgdW5kZWZpbmVkKV0ucGFyYW1zLndoZXJlLmFuZCA6IFtdLAoJCQkJCQkJfSwKCQkJCQkJfQoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCXVzZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQl7CgkJCQkJCQlpbnE6IHsKCQkJCQkJCQlBcGlOYW1lOiAnSWQnLAoJCQkJCQkJCVt0aGlzLl9uQ29kZSgnVXNlcicsIHVuZGVmaW5lZCldOiB2ID8gdi5fdG9TRlF1ZXJ5KClbdGhpcy5fbkNvZGUoJ1VzZXInLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQl9LCAiX3RvU0ZRdWVyeSIpOwoKCQkvL09iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlpZiAoYlN0cmluZykgewoJCQlyZXQgPSB7CgkJCQlxdWVyeTogewoJCQkJCVt0aGlzLl9uQ29kZSgpICsgJ1F1ZXJ5J106IHsKCQkJCQkJdWlhcGk6IHJldAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJcmV0ID0gSlNPTi5zdHJpbmdpZnkocmV0LCBudWxsLCA0KTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NGUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqLnN5c19pZCA9IHYsCgoJCQlncm91cDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCQl1c2VyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b1NOUXVlcnkoKSA6IG51bGw7CgoJCQl9LAoKCQl9LCAiX3RvU05RdWVyeSIpOwoKCQlPYmplY3Qua2V5cyhyZXQuT1BFUkFUT1JTIHx8IHt9KS5maWx0ZXIoayA9PiB0eXBlb2YocmV0W2tdKSAhPT0gJ3VuZGVmaW5lZCcpLmZvckVhY2goayA9PiByZXRba10gPSByZXQuT1BFUkFUT1JTW2tdICsgcmV0W2tdKTsKCgkJZGVsZXRlIHJldC5PUEVSQVRPUlM7CgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCXJldCA9IERvdE9iamVjdC5kb3QocmV0KTsKCgkJLy8gYXZvaWQgc2VuZGluZyB3aXRoIG5vIGNvbXBhcmlzb24gb3BlcmF0b3JzCgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhWyc+JywgJzwnLCAnQkVUV0VFTicsICdPTicsICchJywgJz0nLCAnU1RBUlRTV0lUSCcsICdMSUtFJ10uc29tZShzID0+IFN0cmluZyhyZXRba10pLnN0YXJ0c1dpdGgocykpKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gKHRoaXNbYF8ke2t9X2Nvb3BgXSB8fCAnU1RBUlRTV0lUSCcpICsgcmV0W2tdKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCBPYmplY3QuZW50cmllcyhyZXQgfHwge30pLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlsZXQgX3JldCA9IG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgZmFsc2UsIGZ1biwgZWFPYmosIG9iaik7CgkJCQlyZXR1cm4gX3JldDsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiMmZmNGQ5NTItM2UwNy00MTQwLThjMDItYjliMTViMjhiMTQ2IiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlciA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiBvYmosCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIG9iaiwgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIl9USElTIiwgb2JqLCB0aGlzLl9USElTKTsKCgkJaWYgKCF0aGlzLmdyb3VwKCkgfHwgKHRoaXMuZ3JvdXAoKQoKCQkJCSYmCgkJCQkhdGhpcy5ncm91cCgpLmdyb3VwX0luY2lkZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5ncm91cCgpLmdyb3VwX0dyb3VwX01lbWJlcnMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoImdyb3VwIiwgb2JqLCB0aGlzLmdyb3VwKCkpOwoJCX0KCgkJaWYgKCF0aGlzLnVzZXIoKSB8fCAodGhpcy51c2VyKCkKCgkJCQkmJgoJCQkJIXRoaXMudXNlcigpLm1hbmFnZXJfRGVwYXJ0bWVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMudXNlcigpLmNhbGxlcl9JbmNpZGVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMudXNlcigpLmNvbnRhY3RfSW5jaWRlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnVzZXIoKS51c2VyX0dyb3VwX01lbWJlcnMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoInVzZXIiLCBvYmosIHRoaXMudXNlcigpKTsKCQl9CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2dyb3VwJywgJ3VzZXInXSkuY29uY2F0KFsnJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCB0cnVlLCBmdW4sIG9iaiwgb2JqKTsKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICIyZmY0ZDk1Mi0zZTA3LTQxNDAtOGMwMi1iOWIxNWIyOGIxNDYiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXIgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuR3JvdXBfTWVtYmVyW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Hcm91cF9NZW1iZXJbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkdyb3VwX01lbWJlcltmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJncm91cCIsIG9iaik7CgoJCV9vcHRpb25zKCJ1c2VyIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnZ3JvdXAnLCAndXNlciddKS5jb25jYXQoWycnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV06ICInIiArIHRoaXMuSWQgKyAiJyIKCQl9OwoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImdyb3VwIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2dyb3VwX3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5ncm91cCgpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInVzZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fdXNlcl9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMudXNlcigpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgndXNlcicsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmIChbJ1NhbGVzRm9yY2UnXS5pbmRleE9mKHRoaXMuVG9vbC50eXBlLm5hbWUpID09IDApIHsKCQkJX28gPSBfcSA9ICIiOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXRoaXMuX19RID0gdGhpcy5fX1EgPT0gX28gPyBfcSA6IF9vOwoJCXJldHVybiB0aGlzLl9fUTsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpLCB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCd1c2VyJywgdW5kZWZpbmVkKSArICIuaWQiXTsKCQlmaWVsZHMgPSBBcnJheS5pc0FycmF5KGZpZWxkcykgPyBmaWVsZHMgOiBbZmllbGRzXTsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQkvLyB7ZmllbGQ6IG9yZGVyfQoJCQlmaWVsZHMgPSBbXTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZ3JvdXApIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMudXNlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCX0KCQlyZXR1cm4gZmllbGRzOwoJfQoKCV9mcm9tREJPYmplY3QociA9IHt9KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMuX19pbXBvcnQociwgewoJCQkJSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSwKCgkJCQlncm91cDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZ3JvdXAob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQl1c2VyOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndXNlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnVzZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU51bGw6IHRydWUsCgoJCQlncm91cDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gb2JqW2VhQ29kZV0gPSBuZXcgc2FsZXNub3cuR3JvdXAobnVsbCwgdGhpcy5Ub29sKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJCXVzZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VyJywgdW5kZWZpbmVkKSkgPT4gb2JqW2VhQ29kZV0gPSBuZXcgc2FsZXNub3cuVXNlcihudWxsLCB0aGlzLlRvb2wpLl90b1NlbGVjdEhlYWRlcigpLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5ncm91cCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZ3JvdXB9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnVzZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnVzZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJZ3JvdXA6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZ3JvdXBfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9ncm91cF9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXVzZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd1c2VyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl91c2VyX3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fdXNlcl9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b1NlbGVjdFNRTCIsIGZpZWxkcykuc3FsOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCWlmIChPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZ3JvdXApIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmdyb3VwfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnVzZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndXNlcicsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMudXNlcn1gOwoKCQl9CgoJCWlmIChzcWwuZW5kc1dpdGgoIndoZXJlIDE9MSIpKSB7CgkJCS8vIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEiLCAid2hlcmUgMT0wIik7CgkJfSBlbHNlIHsKCQkJc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSBhbmQgIiwgIndoZXJlICIpOwoJCX0KCgkJc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpIDogc3FsOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoKCQlyZXR1cm4gc3FsOwoJfQoKCV90b1BhdGhzKCkgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCV9USElTOiBvYmogPT4ge30sCgoJCQlncm91cDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gb2JqLmdyb3VwID0gdi5fdG9QYXRocygpLAoKCQkJdXNlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpKSA9PiBvYmoudXNlciA9IHYuX3RvUGF0aHMoKSwKCgkJfSwgIl90b1BhdGhzIik7CgkJLy8gcmV0dXJuIHJldDsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5tYXAoayA9PiAoewoJCQlba106IHJldFtrXQoJCX0pKTsKCX0KCglfdG9VcGRhdGVTUUwoZmllbGRzKSB7CgkJbGV0IHJldEZpZWxkcyA9IHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLmpvaW4oJywgJyk7CgkJbGV0IHNxbCA9IGB1cGRhdGUgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSBzZXQgYCArIE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvREJPYmplY3QoZmllbGRzKSkubWFwKHYgPT4gdGhpcy5fUSgpICsgdlswXSArIHRoaXMuX1EoKSArICI9IiArIHZbMV0pICsgYCB3aGVyZSAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgOyAvL2AgcmV0dXJuaW5nICR7cmV0RmllbGRzfWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvVXBkYXRlU1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfdG9JbnNlcnRTUUwoZmllbGRzKSB7CgkJbGV0IG9iaiA9IHRoaXMuX3RvREJPYmplY3QoZmllbGRzKTsKCQlsZXQgc3FsID0gYGluc2VydCBpbnRvICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKGAgKyBPYmplY3Qua2V5cyhvYmopLm1hcChrID0+IHRoaXMuX1EoKSArIGsgKyB0aGlzLl9RKCkpICsgIikgdmFsdWVzICgiICsgT2JqZWN0LnZhbHVlcyhvYmopICsgYClgOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0luc2VydFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5Hcm91cF9NZW1iZXIpIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuR3JvdXBfTWVtYmVyID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIoKQoKCQkJCQkuZ3JvdXAobmV3IHNhbGVzbm93Lkdyb3VwKCkpCgoJCQkJCS51c2VyKG5ldyBzYWxlc25vdy5Vc2VyKCkpCgoJCQkJCS5fdG9TUUxUYWJsZShkZXB0aCk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiR3JvdXAgTWVtYmVyIikgcmV0dXJuIGZhbHNlOwoKCQkJbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJCUZ1bGw6IHRydWUsCgkJCQlOdWxsOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5faWQgPSB0aGlzLklkID09IHF1ZXJ5LklkLAoKCQkJCWdyb3VwOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5ncm91cCA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkuZ3JvdXAoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZ3JvdXBfc2V0ICYmICFxdWVyeS5fZ3JvdXBfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmdyb3VwID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2dyb3VwX3NldCAmJiBxdWVyeS5fZ3JvdXBfc2V0KSB8fAoKCQkJCQkJKHRoaXMuZ3JvdXAoKSAmJiAhdGhpcy5ncm91cCgpLl9tYXRjaGVzKHF1ZXJ5Lmdyb3VwKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5ncm91cCA9IGZhbHNlOwoJCQkJfSwKCgkJCQl1c2VyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai51c2VyID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS51c2VyKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3VzZXJfc2V0ICYmICFxdWVyeS5fdXNlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudXNlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl91c2VyX3NldCAmJiBxdWVyeS5fdXNlcl9zZXQpIHx8CgoJCQkJCQkodGhpcy51c2VyKCkgJiYgIXRoaXMudXNlcigpLl9tYXRjaGVzKHF1ZXJ5LnVzZXIoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnVzZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoZXMiKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDAsIG9NYXRjaCk7CgoJCQlyZXR1cm4gT2JqZWN0LmtleXMob01hdGNoKS5ldmVyeShrID0+IG9NYXRjaFtrXSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfbWF0Y2hpbmcocXVlcnkpIHsKCQl0cnkgewoJCQlsZXQgcmV0ID0gW107CgoJCQlsZXQgbWF0Y2hlcyA9IHRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlncm91cDogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIGdyb3VwIik7CgkJCQkJb2JqLmdyb3VwID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJdXNlcjogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIHVzZXIiKTsKCQkJCQlvYmoudXNlciA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX2dyb3VwX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3VzZXJfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWdyb3VwOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMuZ3JvdXAocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCXVzZXI6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy51c2VyKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV07CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJZ3JvdXA6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkgOiAiZ3JvdXAiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZ3JvdXBfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMuZ3JvdXAoKSB8fCBuZXcgc2FsZXNub3cuR3JvdXAoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLmdyb3VwKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgZ3JvdXAiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCXVzZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd1c2VyJywgdW5kZWZpbmVkKSA6ICJ1c2VyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3VzZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMudXNlcigpIHx8IG5ldyBzYWxlc25vdy5Vc2VyKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy51c2VyKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgdXNlciIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQl9LCAiX2Zyb21Eb2N1bWVudCIpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSB7CgkJbGV0IHJldCA9IHt9OwoKCQlpZiAoIWJUb29sKSB7CgkJCXJldC5fX2dlbmVyYXRlZCA9IG5ldyBEYXRlKCk7CgkJCWlmICh0aGlzLlRvb2wubmFtZSkgewoJCQkJcmV0Ll9fdG9vbCA9IHsKCQkJCQluYW1lOiB0aGlzLlRvb2wubmFtZSwKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlpZiAoc2FsZXNub3cuX25vZGUpIHsKCQkJCXJldC5fX25vZGUgPSB7CgkJCQkJY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogYkZ1bGwsCgkJCU51bGw6IGJOdWxsLAoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IChvYmosIHYpID0+IHsKCQkJCWlmIChiVG9vbCkgcmV0dXJuOwoJCQkJb2JqLlRISVMgPSB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQlvYmouT1BFUkFUT1JTLlRISVMgPSB0aGlzLl9USElTX2Nvb3A7CgkJCX0sCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldID0gdiwKCgkJCSJncm91cCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkgOiAiZ3JvdXAiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl9ncm91cF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZ3JvdXBfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJ1c2VyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3VzZXInLCB1bmRlZmluZWQpIDogInVzZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl91c2VyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl91c2VyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2ZsaXAoKSAqLwoJX2ZsaXAoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9mbGlwKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fZmxpcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCglieUdyb3VwKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9ncm91cCJdICYmIChhWyJfZ3JvdXAiXS5FcXVhbHMgPyBhWyJfZ3JvdXAiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX2dyb3VwIl0sIHIpKSkgewoJCQkJCXIuX2dyb3VwX0dyb3VwX01lbWJlcnMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglieVVzZXIoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX3VzZXIiXSAmJiAoYVsiX3VzZXIiXS5FcXVhbHMgPyBhWyJfdXNlciJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfdXNlciJdLCByKSkpIHsKCQkJCQlyLl91c2VyX0dyb3VwX01lbWJlcnMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuSWQ7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuR3JvdXBfTWVtYmVyLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLmdyb3VwKHRoaXMuZ3JvdXAoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy51c2VyKHRoaXMudXNlcigpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24pID09PSAidW5kZWZpbmVkIiB8fCBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nQkVHSU4nOidTVEFSVCd9IFRSQU5TQUNUSU9OYCk7CgkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gPSB7CgkJCQkJCQlPd25lcjogdGhpcywKCQkJCQkJCXNxbHM6IFtdLAoJCQkJCQkJc3RhcnQ6IG5ldyBEYXRlKCksCgkJCQkJCQllbmQ6IG51bGwKCQkJCQkJfTsKCQkJCQl9CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX2dyb3VwX3NldCAmJiB0aGlzLmdyb3VwKCkgJiYgIShhd2FpdCB0aGlzLmdyb3VwKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfZ3JvdXAoKTsKCgkJCQkJaWYgKHRoaXMuX3VzZXJfc2V0ICYmIHRoaXMudXNlcigpICYmICEoYXdhaXQgdGhpcy51c2VyKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfdXNlcigpOwoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQkJaWYgKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uT3duZXIgPT0gdGhpcykgewoJCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGBDT01NSVQke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/JyBUUkFOU0FDVElPTic6Jyd9YCk7CgkJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCA9IG5ldyBEYXRlKCk7CgkJCQkJCX0KCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lkdyb3VwX01lbWJlci5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvSW5zZXJ0U1FMKCkpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnaW5zZXJ0JywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJdGhpcy5fZnJvbURvY3VtZW50KGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJbGV0IG9iaiA9IHt9OwoKCQkJCWlmICh0aGlzLl9ncm91cF9zZXQpIHsKCgkJCQkJb2JqLmdyb3VwID0gdGhpcy5fZ3JvdXAuSWQ7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl91c2VyX3NldCkgewoKCQkJCQlvYmoudXNlciA9IHRoaXMuX3VzZXIuSWQ7CgoJCQkJfQoKCQkJCWxvZygiU2VuZGluZyB0byBTRiIsIG9iaik7CgoJCQkJbGV0IHJlcyA9IGF3YWl0IHRoaXMuVG9vbC5kYi5zb2JqZWN0KCJHcm91cF9NZW1iZXIiKS5jcmVhdGUob2JqKTsKCQkJCXRoaXMuSWQgPSByZXMuaWQ7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Hcm91cF9NZW1iZXIudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Hcm91cF9NZW1iZXIuZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCB7CgkJCQkJc3lzcGFybV9xdWVyeTogT2JqZWN0LmVudHJpZXModGhpcy5fdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykpLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKQoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIHRydWUpLCBudWxsLCB7CgkJCQkJdXJsOiAncmVzdC51cmwuZ3FsJwoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCk7CgkJCQlyZXQgPSByZXQuY29udGVudCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5Hcm91cF9NZW1iZXIobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoKCX0KCn07CgpzYWxlc25vdy5Mb2NhdGlvbiA9IGNsYXNzIExvY2F0aW9uIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUXNLaTVmY21WemRDd3FMbDlzYjJGa1ZHOXZiSE1pZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzZXlKdVlXMWxJam9pVTA1UFYwOVBRaUlzSW5SNWNHVWlPbnNpYm1GdFpTSTZJbE5sY25acFkyVk9iM2NpZlgwc0lsTmhiR1Z6Um05eVkyVWlMQ0pIYVhSSWRXSWlYUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2FjdGl2ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2VuYWJsZWQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb2RlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb2RlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3JkZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29yZGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZGF0ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZGF0ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm5hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX25hbWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3JlbWFyaygpOwoKCQl0aGlzLmNsZWFyX2xvY2F0aW9uX0luY2lkZW50cygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIkxvY2F0aW9uIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQkvLyAodGhpcy5sb2NhdGlvbl9JbmNpZGVudHMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbG9jYXRpb25fSW5jaWRlbnRzICoqLwoJbG9jYXRpb25fSW5jaWRlbnRzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2Q3NWQ1MDBkLTJmNzUtNGU2MS1iM2E1LWQ0NTlmZTI2MjRjNCcgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnSW5jaWRlbnQnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX2xvY2F0aW9uX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2xvY2F0aW9uX0luY2lkZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAibG9jYXRpb24gaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkluY2lkZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnbG9jYXRpb25fSW5jaWRlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJsb2NhdGlvbiBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkluY2lkZW50Iik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LmxvY2F0aW9uKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX2xvY2F0aW9uX0luY2lkZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9sb2NhdGlvbl9JbmNpZGVudHMoKSB7CgkJdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX3NldCA9IG51bGw7CgkJdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbG9jYXRpb25fSW5jaWRlbnRzICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJCXRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0LmxvY2F0aW9uX0luY2lkZW50cyA9IHRoaXMubG9jYXRpb25fSW5jaWRlbnRzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b0hhc2goYXJncywgb3B0aW9ucykgewoJCW9wdGlvbnMgPSBvcHRpb25zIHx8IHt9OwoJCW9wdGlvbnMuY2FjaGVMaW1pdCA9IG9wdGlvbnMuY2FjaGVMaW1pdCB8fCA1OwoKCQlsZXQgb0hhc2ggPSB7CgkJCWFyZ3M6IGFyZ3MsCgkJCV90aGlzOiB7fSAvLyB0aGlzLl9wcnVuZSh0aGlzKSBkb2VzIG5vdCB3b3JrIGJlY2F1c2UgSWQgaXMgbm90IGV4Y2x1ZGVkIGZvciBxdWVyaWVzOyB0aGlzLl9wcnVuZSh0aGlzLl90b0RvY3VtZW50KCkpIGNyZWF0ZXMgY2lyY3VsYXJzCgkJfTsKCgkJaWYgKHRydWUgfHwgb3B0aW9ucy5kZXB0aCkgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX2ZsYXR0ZW4ob3B0aW9ucy5kZXB0aCB8fCAzKTsKCQl9IGVsc2UgewoJCQlvSGFzaC5fdGhpcyA9IHRoaXMuX19leHBvcnQob0hhc2guX3RoaXMsIHsKCQkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouSWQgPSB2LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQlsb2NhdGlvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdsb2NhdGlvbl9Mb2NhdGlvbnMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkgIT0gJ0xvY2F0aW9uJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL0xvY2F0aW9uLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7CgoJCQl9CgoJCQkvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8KCgkJCWxldCB2ID0gdW5kZWZpbmVkOwoJCQl0cnkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke21ldGhvZH1gKTsKCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQlsZXQgX2lkID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgZGF0YSwgbWV0aG9kLCB7fSk7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIHsKCQkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKGRhdGEpOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSBkYXRhLl9fdGhpcy5jb2RlIHx8IGRhdGEuaWQgfHwgZGF0YS5JRDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCQlpZiAoZGF0YS5JZCAmJiBkYXRhLklkID09IGRhdGEuSWQpIHsKCQkJCQkJX2lkID0gZGF0YS5JZDsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5FbnRpdHlDbGFzcykgewoJCQkJCQlfaWQgPSBkYXRhLkVudGl0eUNsYXNzLklkIHx8IGRhdGEuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICIyYmMxYTZmNS05YzlkLTQ3ZDYtODIwNS1mZWNlOGI5NDVlMjMiIHx8ICJOVUxMIjsKCQkJCQl9CgkJCQl9CgoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbiB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bbWV0aG9kXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvblttZXRob2RdW19pZF0gfHwge307CgoJCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKHt9LCB7CgkJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJCX0pOwoKCQkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvblttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnTG9jYXRpb24nKS5zZW5kZXIoc2FsZXNub3cuX25vZGUpLmNhcnJpZXIoc2FsZXNub3cuX25vZGUpLnBheWxvYWQoZGF0YSk7CgkJCWlmIChldmVudCkgewoJCQkJaWYgKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOwoJCQkJaWYgKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOwoJCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJaWYgKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOwoJCQl9CgkJCXJldCA9IGF3YWl0IGV2LnRyaWdnZXIoKTsKCgkJCWlmICh0eXBlb2YocmV0KSA9PT0gInN0cmluZyIpIHsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCX0KCQkJcmV0dXJuIHJldDsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5Mb2NhdGlvbihudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuTG9jYXRpb24obnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuTG9jYXRpb24oKS5faW52b2tlTm9kZSh0biwgbWV0aG9kLCBfcGFyYW1zKTsKCQl9CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYExvY2F0aW9uLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgTG9jYXRpb24uX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb24uX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuTG9jYXRpb24uJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglfcGFyc2VDb2RlU3RhdGUodCkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyc2VDb2RlU3RhdGUodCk7CgoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiTG9jYXRpb24iKTsKCgl9CgoJX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXggPSAne3snLCBwb3N0Zml4ID0gJ319JykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCwgcG9zdGZpeCk7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCS8vIHRoaXMubG9jYXRpb25fTG9jYXRpb25zKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuTG9jYXRpb24odGhpcy5JZCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkubG9jYXRpb25fSW5jaWRlbnRzKHRoaXMubG9jYXRpb25fSW5jaWRlbnRzKCksIHRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSkgewoJCWNvbnRleHQgPSBjb250ZXh0IHx8ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCS8vb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCS8vb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ0xvY2F0aW9uJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgkJY29kZVR5cGUgPSBjb2RlVHlwZSB8fCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBlMzA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSlbY29kZV07CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIkxvY2F0aW9uIjsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IiAmJiB0aGlzLl9fY29uZmlnKCdzY29wZScpKSB7CgkJCQkJY29kZSA9IHRoaXMuX19jb25maWcoJ3Njb3BlJykgKyAiX3N0XyIgKyBjb2RlOwoJCQkJfQoJCQkJb0NvZGUgPSB1bmRlZmluZWQ7CgkJCX0KCQkJbGV0IHJldCA9IGNvZGU7CgkJCWlmIChvQ29kZSAmJiB0eXBlb2Yob0NvZGUpID09PSAnb2JqZWN0JykgewoJCQkJcmV0ID0gb0NvZGVbdGhpcy5Ub29sLm5hbWVdIHx8IHJldDsKCQkJfQoKCQkJcmV0ID0gdGhpcy5fbWFwKGNvZGUsIGZhbHNlLCBjb250ZXh0KSB8fCByZXQ7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX25Db2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGV4KTsKCQkJcmV0dXJuIGNvZGU7CgkJfQoJfQoKCV9fY29uZmlnKG4sIG51bGxWYWx1ZSwgb3B0aW9ucyA9IHt9KSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fY29uZmlnKG4sIG51bGxWYWx1ZSwgT2JqZWN0LmFzc2lnbih7fSwgb3B0aW9ucyB8fCB7fSwgewoJCQlfY2xhc3M6ICdMb2NhdGlvbicKCQl9KSk7CgoJfQoKCWFzeW5jIF9yZXN0KHROYW1lID0gdGhpcy5fbkNvZGUoKSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMgPSB7fSkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIodW5kZWZpbmVkLCB0aGlzLlRvb2wpLl9yZXN0KHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zKTsKCgl9CgoJX3RvU1FMVGFibGUoKSB7CgkJbGV0IHJldCA9IHsKCQkJc3FsOiBgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoCiAgICAgICAgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVkKICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgYAoJCX07CgkJcmV0LnNxbCArPSAnLypMb2NhdGlvbiovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQlsb2NhdGlvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdsb2NhdGlvbl9Mb2NhdGlvbnMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypMb2NhdGlvbiovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbChzcWwsIHRoaXMpOwoKCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIGJTdHJpbmcpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7CgkJCVt0aGlzLl9uQ29kZSgpXTogewoJCQkJcGFyYW1zOiB7CgkJCQkJd2hlcmU6IHsKCQkJCQkJYW5kOiBbXSwKCQkJCQkJb3I6IFtdCgkJCQkJfQoJCQkJfSwKCQkJCWVkZ2VzOiB7CgkJCQkJbm9kZToge30KCQkJCX0KCQkJfQoJCX0sIHsKCQkJLy9PUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKHsKCQkJCUlkOiB7CgkJCQkJZXE6IHYKCQkJCX0KCQkJfSksCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCSh2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbCkKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQl9LCAiX3RvU0ZRdWVyeSIpOwoKCQkvL09iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlpZiAoYlN0cmluZykgewoJCQlyZXQgPSB7CgkJCQlxdWVyeTogewoJCQkJCVt0aGlzLl9uQ29kZSgpICsgJ1F1ZXJ5J106IHsKCQkJCQkJdWlhcGk6IHJldAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJcmV0ID0gSlNPTi5zdHJpbmdpZnkocmV0LCBudWxsLCA0KTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NGUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqLnN5c19pZCA9IHYsCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJbGV0IGQgPSBgJHt2LmdldEZ1bGxZZWFyKCl9LSR7KCcwJysodi5nZXRNb250aCgpKzEpKS5zbGljZSgtMil9LSR7di5nZXREYXRlKCl9YDsKCQkJCWxldCB0ID0gYCR7di5nZXRIb3VycygpfToke3YuZ2V0TWludXRlcygpfToke3YuZ2V0U2Vjb25kcygpfWA7CgkJCQlpZiAoKHYuZ2V0SG91cnMoKSA9PSAwICYmIHYuZ2V0TWludXRlcygpID09IDAgJiYgdi5nZXRTZWNvbmRzKCkgPT0gMCkgfHwgdGhpcy5fZGF0ZV9jb29wID09ICc9JyB8fCAhdGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgT04ke2R9QGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9Jywnc3RhcnQnKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ2VuZCcpYDsKCQkJCX0gZWxzZSBpZiAodGhpcy5fZGF0ZV9jb29wICE9PSAnQkVUV0VFTicpIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0KCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCX0sICJfdG9TTlF1ZXJ5Iik7CgoJCU9iamVjdC5rZXlzKHJldC5PUEVSQVRPUlMgfHwge30pLmZpbHRlcihrID0+IHR5cGVvZihyZXRba10pICE9PSAndW5kZWZpbmVkJykuZm9yRWFjaChrID0+IHJldFtrXSA9IHJldC5PUEVSQVRPUlNba10gKyByZXRba10pOwoKCQlkZWxldGUgcmV0Lk9QRVJBVE9SUzsKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJcmV0ID0gRG90T2JqZWN0LmRvdChyZXQpOwoKCQkvLyBhdm9pZCBzZW5kaW5nIHdpdGggbm8gY29tcGFyaXNvbiBvcGVyYXRvcnMKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFbJz4nLCAnPCcsICdCRVRXRUVOJywgJ09OJywgJyEnLCAnPScsICdTVEFSVFNXSVRIJywgJ0xJS0UnXS5zb21lKHMgPT4gU3RyaW5nKHJldFtrXSkuc3RhcnRzV2l0aChzKSkpLmZvckVhY2goayA9PiByZXRba10gPSAodGhpc1tgXyR7a31fY29vcGBdIHx8ICdTVEFSVFNXSVRIJykgKyByZXRba10pOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIE9iamVjdC5lbnRyaWVzKHJldCB8fCB7fSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCWxldCBfcmV0ID0gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCBmYWxzZSwgZnVuLCBlYU9iaiwgb2JqKTsKCQkJCXJldHVybiBfcmV0OwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiMmJjMWE2ZjUtOWM5ZC00N2Q2LTgyMDUtZmVjZThiOTQ1ZTIzIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbiB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbltmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbltmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCV9vcHRpb25zKCJsb2NhdGlvbl9JbmNpZGVudHMiLCBvYmosIHRoaXMubG9jYXRpb25fSW5jaWRlbnRzKCkpOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnbG9jYXRpb25fSW5jaWRlbnRzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCB0cnVlLCBmdW4sIG9iaiwgb2JqKTsKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmopOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiMmJjMWE2ZjUtOWM5ZC00N2Q2LTgyMDUtZmVjZThiOTQ1ZTIzIiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbiB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbltmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Mb2NhdGlvbltmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTG9jYXRpb25bZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkxvY2F0aW9uW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoImxvY2F0aW9uX0luY2lkZW50cyIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydsb2NhdGlvbl9JbmNpZGVudHMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV06ICInIiArIHRoaXMuSWQgKyAiJyIKCQl9OwoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9hY3RpdmVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYWN0aXZlKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZW5hYmxlZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5lbmFibGVkKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvZGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29kZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2RhdGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZGF0ZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5uYW1lKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3JlbWFya19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5yZW1hcmsoKTsKCgkJCWZWYWx1ZSA9ICInIiArICgodiAmJiB2LnJlcGxhY2UpID8gdi5yZXBsYWNlKC9cJy9nLCAiXCdcJyIpIDogdikgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX1EoKSB7CgkJbGV0IF9vID0gJyInOwoJCWxldCBfcSA9IF9vOwoKCQlpZiAoWydTYWxlc0ZvcmNlJ10uaW5kZXhPZih0aGlzLlRvb2wudHlwZS5uYW1lKSA9PSAwKSB7CgkJCV9vID0gX3EgPSAiIjsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgewoJCQlfbyA9IF9xID0gJ2AnOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxzZXJ2ZXInKSB7CgkJCV9vID0gJ1snOwoJCQlfcSA9ICddJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ2FwaUtleScpID09ICdhaXJ0YWJsZScpIHsKCQkJX28gPSAneyc7CgkJCV9xID0gJ30nOwoJCX0KCQl0aGlzLl9fUSA9IHRoaXMuX19RID09IF9vID8gX3EgOiBfbzsKCQlyZXR1cm4gdGhpcy5fX1E7Cgl9CgoJX2ZpZWxkR3JvdXBzKGZncyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOwoJCXJldHVybiB0aGlzOwoJfQoKCV9maWVsZEFnZ3JlZ2F0ZXMoZmFzID0ge30pIHsKCQl0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOwoJCXJldHVybiB0aGlzOwoJfQoKCV90b0ZpZWxkc1NRTChmaWVsZHMpIHsKCgkJZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKSwgdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCldOwoJCWZpZWxkcyA9IEFycmF5LmlzQXJyYXkoZmllbGRzKSA/IGZpZWxkcyA6IFtmaWVsZHNdOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCS8vIHtmaWVsZDogb3JkZXJ9CgkJCWZpZWxkcyA9IFtdOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb2RlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5kYXRlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5uYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucmVtYXJrKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlOdWxsOiB0cnVlLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCX0KCgkJc3FsICs9IGAgZnJvbSAke3RQcmVmfSBgOwoKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gYGxlZnQgam9pbiAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX0ke3RoaXMuX1EoKX0gYXMgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0gb24gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtrfWlkJHt0aGlzLl9RKCl9PSR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGApOwoKCQlzcWwgKz0gYCB3aGVyZSAxPTFgOwoKCQlzcWwgPSB0aGlzLl9fZXhwb3J0KHsKCQkJc3FsOiBzcWwKCQl9LCB7CgkJCV9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgPyBbJ0lkJ10gOiB1bmRlZmluZWQsCgkJCU51bGw6IHRydWUsCgkJCV9USElTOiBvYmogPT4gewoJCQkJaWYgKCF0aGlzLl9USElTIHx8ICF0aGlzLl9USElTLmxlbmd0aCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCh0Ll9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnKSkuam9pbignIFVOSU9OIEFMTCAnKSArICIpIjsKCQkJfSwKCQkJSWQ6IG9iaiA9PiBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2AsCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvZGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2RhdGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVtYXJrX3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlsb2NhdGlvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdsb2NhdGlvbl9Mb2NhdGlvbnMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoImxvY2F0aW9uLmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfY29vcCA9PSAnPScgfHwgdGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fbG9jYXRpb25fSW5jaWRlbnRzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKmxvY2F0aW9uX0luY2lkZW50cyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJfSwgIl90b1NlbGVjdFNRTCIsIGZpZWxkcykuc3FsOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCWlmIChPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJbG9jYXRpb25fSW5jaWRlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbG9jYXRpb25fTG9jYXRpb25zJywgdW5kZWZpbmVkKSkgPT4gb2JqLmxvY2F0aW9uX0luY2lkZW50cyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQl9LCAiX3RvUGF0aHMiKTsKCQkvLyByZXR1cm4gcmV0OwoJCXJldHVybiBPYmplY3Qua2V5cyhyZXQpLm1hcChrID0+ICh7CgkJCVtrXTogcmV0W2tdCgkJfSkpOwoJfQoKCV90b1VwZGF0ZVNRTChmaWVsZHMpIHsKCQlsZXQgcmV0RmllbGRzID0gdGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkuam9pbignLCAnKTsKCQlsZXQgc3FsID0gYHVwZGF0ZSAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IHNldCBgICsgT2JqZWN0LmVudHJpZXModGhpcy5fdG9EQk9iamVjdChmaWVsZHMpKS5tYXAodiA9PiB0aGlzLl9RKCkgKyB2WzBdICsgdGhpcy5fUSgpICsgIj0iICsgdlsxXSkgKyBgIHdoZXJlICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2A7IC8vYCByZXR1cm5pbmcgJHtyZXRGaWVsZHN9YDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9VcGRhdGVTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV90b0luc2VydFNRTChmaWVsZHMpIHsKCQlsZXQgb2JqID0gdGhpcy5fdG9EQk9iamVjdChmaWVsZHMpOwoJCWxldCBzcWwgPSBgaW5zZXJ0IGludG8gJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoYCArIE9iamVjdC5rZXlzKG9iaikubWFwKGsgPT4gdGhpcy5fUSgpICsgayArIHRoaXMuX1EoKSkgKyAiKSB2YWx1ZXMgKCIgKyBPYmplY3QudmFsdWVzKG9iaikgKyBgKWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvSW5zZXJ0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLkxvY2F0aW9uKSByZXR1cm47CgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLkxvY2F0aW9uID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5Mb2NhdGlvbigpCgoJCQkJCS5sb2NhdGlvbl9JbmNpZGVudHMobmV3IHNhbGVzbm93LkluY2lkZW50KCkpCgoJCQkJCS5fdG9TUUxUYWJsZShkZXB0aCk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiTG9jYXRpb24iKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCWxvY2F0aW9uX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5sb2NhdGlvbl9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBxdWVyeS5sb2NhdGlvbl9JbmNpZGVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWxvY2F0aW9uX0luY2lkZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5sb2NhdGlvbl9JbmNpZGVudHMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJbG9jYXRpb25fSW5jaWRlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMubG9jYXRpb25fSW5jaWRlbnRzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb2RlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jb2RlKHJlZik7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3JkZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9yZGVyKHJlZik7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLmRhdGUocmVmKTsKCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9uYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5uYW1lKHJlZik7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVtYXJrX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5yZW1hcmsocmVmKTsKCgkJCX0sCgoJCQlsb2NhdGlvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdsb2NhdGlvbl9Mb2NhdGlvbnMnLCB1bmRlZmluZWQpIDogImxvY2F0aW9uX0luY2lkZW50cyIpKSA9PiB0aGlzLmxvY2F0aW9uX0luY2lkZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuSW5jaWRlbnQoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSA9IHYsCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3JkZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGw7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIG9ialtlYUNvZGVdID0gb2JqW2VhQ29kZV0ucmVwbGFjZSgvXC5bMC05XSpaL2csICcnKTsKCgkJCQlpZiAodGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGF0ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9uYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9uYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3JlbWFya19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQlsb2NhdGlvbl9JbmNpZGVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdsb2NhdGlvbl9Mb2NhdGlvbnMnLCB1bmRlZmluZWQpIDogImxvY2F0aW9uX0luY2lkZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9sb2NhdGlvbl9JbmNpZGVudHNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9mbGlwKCkgKi8KCV9mbGlwKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fZmxpcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9mbGlwKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2ZsaXAoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSB0cnVlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTG9jYXRpb24uc3RvcmUnKTsgLy8gb3IgaW5zaWRlIGV4ZWN1dGU/CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJbGV0IGJVcGRhdGUgPSBmYWxzZTsKCQkJbGV0IGJJbnNlcnQgPSBmYWxzZTsKCgkJCWlmICghdGhpcy5fX3N5bmNfb24oKSkgewoJCQkJbGV0IF90aGlzID0gbmV3IHNhbGVzbm93LkxvY2F0aW9uKG51bGwsIHRoaXMuVG9vbCk7CgoJCQkJbGV0IGJGaW5kID0gZmFsc2U7CgkJCQlpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLklkID0gdGhpcy5JZDsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5uYW1lKHRoaXMubmFtZSgpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24pID09PSAidW5kZWZpbmVkIiB8fCBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nQkVHSU4nOidTVEFSVCd9IFRSQU5TQUNUSU9OYCk7CgkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gPSB7CgkJCQkJCQlPd25lcjogdGhpcywKCQkJCQkJCXNxbHM6IFtdLAoJCQkJCQkJc3RhcnQ6IG5ldyBEYXRlKCksCgkJCQkJCQllbmQ6IG51bGwKCQkJCQkJfTsKCQkJCQl9CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSB7CgkJCQkJdGhpcy5hY3RpdmUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSB7CgkJCQkJdGhpcy5lbmFibGVkKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgewoJCQkJCXRoaXMuZGF0ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSBuZXcgRGF0ZSgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fX2Fzc2VydFZhbGlkKHRydWUpKSByZXR1cm4gbnVsbDsKCgkJCQkvL2F3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8gaW4gY2FzZSBUb29sIGNoYW5nZXMKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgQWJvdXQgdG8gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9YCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgRmluaXNoZWQgSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9IElkPVske3RoaXMuSWR9XWApOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQkJaWYgKHRoaXMuX2xvY2F0aW9uX0luY2lkZW50c19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLmxvY2F0aW9uX0luY2lkZW50cygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBpbnNlcnQoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Mb2NhdGlvbi5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvSW5zZXJ0U1FMKCkpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnaW5zZXJ0JywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJdGhpcy5fZnJvbURvY3VtZW50KGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJbGV0IG9iaiA9IHt9OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfc2V0KSB7CgoJCQkJCW9iai5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9zZXQpIHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2NvZGVfc2V0KSB7CgoJCQkJCW9iai5jb2RlID0gdGhpcy5jb2RlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9vcmRlcl9zZXQpIHsKCgkJCQkJb2JqLm9yZGVyID0gdGhpcy5vcmRlcigpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZGF0ZV9zZXQpIHsKCgkJCQkJb2JqLmRhdGUgPSB0aGlzLmRhdGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX25hbWVfc2V0KSB7CgoJCQkJCW9iai5uYW1lID0gdGhpcy5uYW1lKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9yZW1hcmtfc2V0KSB7CgoJCQkJCW9iai5yZW1hcmsgPSB0aGlzLnJlbWFyaygpOwoKCQkJCX0KCgkJCQlsb2coIlNlbmRpbmcgdG8gU0YiLCBvYmopOwoKCQkJCWxldCByZXMgPSBhd2FpdCB0aGlzLlRvb2wuZGIuc29iamVjdCgiTG9jYXRpb24iKS5jcmVhdGUob2JqKTsKCQkJCXRoaXMuSWQgPSByZXMuaWQ7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Mb2NhdGlvbi51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1VwZGF0ZVNRTCgpKTsKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTCgpKTsKCQkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IHJldFswXTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkxvY2F0aW9uLmZpbmRBbGwnKTsKCgkJCS8vIGF2b2lkcyBjeWNsaWMgcXVlcmllcwoJCQlvYmpzID0gKG9ianMgfHwgW10pLm1hcChvID0+IG8uX2Nsb25lKCkpOwoKCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLz8/CgoJCQlsZXQgcmV0ID0gW107IC8vIGEganNvbiBhcnJheQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTChmaWVsZHMsIG9ianMpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgewoJCQkJCXN5c3Bhcm1fcXVlcnk6IE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvU05RdWVyeShmaWVsZHMsIG9ianMpKS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCB0cnVlKSwgbnVsbCwgewoJCQkJCXVybDogJ3Jlc3QudXJsLmdxbCcKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2ApOwoJCQkJcmV0ID0gcmV0LmNvbnRlbnQgPyBbSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSldIDogW107CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5tYXAociA9PiBuZXcgc2FsZXNub3cuTG9jYXRpb24obnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoKCX0KCn07CgpzYWxlc25vdy5Db25maWcgPSBjbGFzcyBDb25maWcgZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRc0tpNWZjbVZ6ZEN3cUxsOXNiMkZrVkc5dmJITWlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpPYjJSbElqcDdJbTV2UkdWMFpXTjBJanAwY25WbExDSnBibWwwTG1WdVpITWlPaklzSW1sdWFYUXViRzl2Y0NJNk1DNDFMQ0owYjI5c2N5NXpkRzl5WlNJNlptRnNjMlVzSW1SbGRHVmpkRkJoY21WdWRDNUpVQ0k2SWpFNE1pNHhOamd1TnpBdU9ESWlMQ0prWlhSbFkzUlFZWEpsYm5RdVkyOWtaU0k2SW1VNFpHVXdObVV6WldSak5EUXpZV1U1WkdabE1XUmxOV1ZqTlRKaE5HSm1JaXdpYzJWamNtVjBJam9pYjFOTGQyZGFNbk5MUms5VVNVcGpZa0ZtVlVsUk5FTnFPWEZ6U0RRNGJtd2lMQ0p3YkdGNVozSnZkVzVrSWpwMGNuVmxMQ0puVWxCRElqcDBjblZsTENKemRHOXlaUzV6Wlc1emFYUnBkbWwwZVNJNk1Td2lZMjl0Y0dGdWVTSTZJbkpsYzNWdFpTSjlMQ0pGZG1WdWRDSTZleUowY21sbloyVnlMblJwYldWdmRYUWlPakV3TURBd0xDSnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wc0lsUnZiMndpT25zaVoybDBhSFZpTG5SdmIyeHpJam9pYUhSMGNITTZMeTl5WVhjdVoybDBhSFZpZFhObGNtTnZiblJsYm5RdVkyOXRMMlpoWkdsdUwyWmhaR2x1TG1kcGRHaDFZaTVwYnk5dFlYTjBaWEl2SWl3aWMyVmpjbVYwSWpvaWIxTkxkMmRhTW5OTFJrOVVTVXBqWWtGbVZVbFJORU5xT1hGelNEUTRibXdpTENKd2JHRjVaM0p2ZFc1a0lqcDBjblZsTENKblVsQkRJanAwY25WbExDSnpkRzl5WlM1elpXNXphWFJwZG1sMGVTSTZNU3dpWTI5dGNHRnVlU0k2SW5KbGMzVnRaU0o5TENKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzZXlKdVlXMWxJam9pVTA1UFYwOVBRaUlzSW5SNWNHVWlPbnNpYm1GdFpTSTZJbE5sY25acFkyVk9iM2NpZlgwc0lsTmhiR1Z6Um05eVkyVWlMQ0pIYVhSSWRXSWlYUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJ2YWx1ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfdmFsdWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJzY3JpcHQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3NjcmlwdCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInRvb2wiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3Rvb2woKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJ0eXBlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl90eXBlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibm9kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbm9kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiQ29uZmlnIiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQkvLyBpZih0aGlzLl90b29sX3NldCAmJiB0aGlzLl90b29sKSB0aGlzLl90b29sLlRvb2wgPSB0b29sOwoKCQkvLyBpZih0aGlzLl90eXBlX3NldCAmJiB0aGlzLl90eXBlKSB0aGlzLl90eXBlLlRvb2wgPSB0b29sOwoKCQkvLyBpZih0aGlzLl9ub2RlX3NldCAmJiB0aGlzLl9ub2RlKSB0aGlzLl9ub2RlLlRvb2wgPSB0b29sOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdmFsdWUgKiovCgl2YWx1ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3ZhbHVlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgidmFsdWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3ZhbHVlICE9IHYpIHsKCQkJCXRoaXMuX3ZhbHVlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl92YWx1ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLk9iamVjdFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl92YWx1ZSk7CgkJfQoJfQoKCWNsZWFyX3ZhbHVlKCkgewoJCXRoaXMuX3ZhbHVlX3NldCA9IG51bGw7CgkJdGhpcy5fdmFsdWUgPSBudWxsOwoJCXRoaXMuX3ZhbHVlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB2YWx1ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHNjcmlwdCAqKi8KCXNjcmlwdCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3NjcmlwdF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInNjcmlwdCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fc2NyaXB0ICE9IHYpIHsKCQkJCXRoaXMuX3NjcmlwdF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fc2NyaXB0ID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9zY3JpcHQpOwoJCX0KCX0KCgljbGVhcl9zY3JpcHQoKSB7CgkJdGhpcy5fc2NyaXB0X3NldCA9IG51bGw7CgkJdGhpcy5fc2NyaXB0ID0gbnVsbDsKCQl0aGlzLl9zY3JpcHRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHNjcmlwdCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHRvb2wgKiovCgl0b29sKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fdG9vbF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInRvb2wiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc3MzliYzg1YS04ZDBkLTQyZDItOTVkNy0yZjg0NzU4NTZhODknICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdUb29sJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3Rvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICI3MzliYzg1YS04ZDBkLTQyZDItOTVkNy0yZjg0NzU4NTZhODkiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiVG9vbCIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl90b29sICE9IHYpIHsKCQkJCXRoaXMuX3Rvb2xfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0b29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl90b29sID8gdGhpcy5fdG9vbC5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fdG9vbF9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fdG9vbCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl90b29sKTsKCQl9Cgl9CgoJY2xlYXJfdG9vbCgpIHsKCQl0aGlzLl90b29sX3NldCA9IG51bGw7CgkJdGhpcy5fdG9vbCA9IG51bGw7CgkJdGhpcy5fdG9vbF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdG9vbCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHR5cGUgKiovCgl0eXBlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fdHlwZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInR5cGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc0NjhlNjE2MS0zZGY4LTRmZGYtYWU1MC0wZGIyOTM2ZTY1MDQnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdUb29sIFR5cGUnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndHlwZScsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjQ2OGU2MTYxLTNkZjgtNGZkZi1hZTUwLTBkYjI5MzZlNjUwNCIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJUb29sIFR5cGUiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fdHlwZSAhPSB2KSB7CgkJCQl0aGlzLl90eXBlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndHlwZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fdHlwZSA/IHRoaXMuX3R5cGUuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX3R5cGVfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX3R5cGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fdHlwZSk7CgkJfQoJfQoKCWNsZWFyX3R5cGUoKSB7CgkJdGhpcy5fdHlwZV9zZXQgPSBudWxsOwoJCXRoaXMuX3R5cGUgPSBudWxsOwoJCXRoaXMuX3R5cGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHR5cGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBub2RlICoqLwoJbm9kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25vZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJub2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnOWUyYTBkNzAtOWExYi00NzYyLWE5ZGItMDYwZTY1Nzk1Yzg5JyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnTm9kZScpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdub2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiOWUyYTBkNzAtOWExYi00NzYyLWE5ZGItMDYwZTY1Nzk1Yzg5IiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIk5vZGUiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbm9kZSAhPSB2KSB7CgkJCQl0aGlzLl9ub2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnbm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fbm9kZSA/IHRoaXMuX25vZGUuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX25vZGVfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX25vZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbm9kZSk7CgkJfQoJfQoKCWNsZWFyX25vZGUoKSB7CgkJdGhpcy5fbm9kZV9zZXQgPSBudWxsOwoJCXRoaXMuX25vZGUgPSBudWxsOwoJCXRoaXMuX25vZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5vZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoJY29kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb2RlICE9IHYpIHsKCQkJCXRoaXMuX2NvZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29kZSk7CgkJfQoJfQoKCWNsZWFyX2NvZGUoKSB7CgkJdGhpcy5fY29kZV9zZXQgPSBudWxsOwoJCXRoaXMuX2NvZGUgPSBudWxsOwoJCXRoaXMuX2NvZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCglkYXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImRhdGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJyA/IF92IDogKG5ldyBEYXRlKF92KSk7CgkJCQlpZiAoaXNOYU4oX3YuZ2V0VGltZSgpKSkgX3YgPSBudWxsOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuRGF0ZVZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RhdGUgIT0gdikgewoJCQkJdGhpcy5fZGF0ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkRhdGVWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGF0ZSk7CgkJfQoJfQoKCWNsZWFyX2RhdGUoKSB7CgkJdGhpcy5fZGF0ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2RhdGUgPSBudWxsOwoJCXRoaXMuX2RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoJbmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9uYW1lICE9IHYpIHsKCQkJCXRoaXMuX25hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX25hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbmFtZSk7CgkJfQoJfQoKCWNsZWFyX25hbWUoKSB7CgkJdGhpcy5fbmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX25hbWUgPSBudWxsOwoJCXRoaXMuX25hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCglyZW1hcmsodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9yZW1hcmtfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZW1hcmsiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3JlbWFyayAhPSB2KSB7CgkJCQl0aGlzLl9yZW1hcmtfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3JlbWFyayA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcmVtYXJrKTsKCQl9Cgl9CgoJY2xlYXJfcmVtYXJrKCkgewoJCXRoaXMuX3JlbWFya19zZXQgPSBudWxsOwoJCXRoaXMuX3JlbWFyayA9IG51bGw7CgkJdGhpcy5fcmVtYXJrX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl92YWx1ZV9zZXQsCgoJCQl0aGlzLl9zY3JpcHRfc2V0LAoKCQkJdGhpcy5fdG9vbF9zZXQsCgoJCQl0aGlzLl90eXBlX3NldCwKCgkJCXRoaXMuX25vZGVfc2V0LAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX3ZhbHVlX3NldCA9IHRoaXMuX3ZhbHVlX3NldDsKCQlyZXQuX3ZhbHVlX2Nvb3AgPSB0aGlzLl92YWx1ZV9jb29wOwoJCXJldC52YWx1ZSA9IHRoaXMudmFsdWUoKSA/IHRoaXMudmFsdWUoKSA6IHRoaXMudmFsdWUoKTsKCgkJcmV0Ll9zY3JpcHRfc2V0ID0gdGhpcy5fc2NyaXB0X3NldDsKCQlyZXQuX3NjcmlwdF9jb29wID0gdGhpcy5fc2NyaXB0X2Nvb3A7CgkJcmV0LnNjcmlwdCA9IHRoaXMuc2NyaXB0KCkgPyB0aGlzLnNjcmlwdCgpIDogdGhpcy5zY3JpcHQoKTsKCgkJcmV0Ll90b29sX3NldCA9IHRoaXMuX3Rvb2xfc2V0OwoJCXJldC5fdG9vbF9jb29wID0gdGhpcy5fdG9vbF9jb29wOwoJCXJldC50b29sID0gdGhpcy50b29sKCkgPyB0aGlzLnRvb2woKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy50b29sKCk7CgoJCXJldC5fdHlwZV9zZXQgPSB0aGlzLl90eXBlX3NldDsKCQlyZXQuX3R5cGVfY29vcCA9IHRoaXMuX3R5cGVfY29vcDsKCQlyZXQudHlwZSA9IHRoaXMudHlwZSgpID8gdGhpcy50eXBlKCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMudHlwZSgpOwoKCQlyZXQuX25vZGVfc2V0ID0gdGhpcy5fbm9kZV9zZXQ7CgkJcmV0Ll9ub2RlX2Nvb3AgPSB0aGlzLl9ub2RlX2Nvb3A7CgkJcmV0Lm5vZGUgPSB0aGlzLm5vZGUoKSA/IHRoaXMubm9kZSgpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLm5vZGUoKTsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkidmFsdWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndmFsdWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJzY3JpcHQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc2NyaXB0JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkidG9vbCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkidHlwZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkibm9kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQl9LCAiX3RvSGFzaCIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMuTm9Db2RlID8gb0hhc2ggOiB0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7Cgl9CgoJYXN5bmMgX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOwoKCX0KCglfcWxTZWxlY3Rpb25zKHNTZXQpIHsKCQlsZXQgcmV0ID0gW107CgkJaWYgKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7CgoJCXNTZXQuc2VsZWN0aW9ucy5maWx0ZXIocyA9PiBzLnNlbGVjdGlvblNldCkuZm9yRWFjaChzID0+IHsKCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInRvb2wiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIHRvb2wnLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93LlRvb2woKS50b29sX0NvbmZpZ3ModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJ0eXBlIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciB0eXBlJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Ub29sX1R5cGUoKS50eXBlX0NvbmZpZ3ModGhpcyk7CgkJCQlyZXQucHVzaChzT2JqKTsKCQkJCXJldC5wdXNoKC4uLnNPYmouX3FsU2VsZWN0aW9ucyhzLnNlbGVjdGlvblNldCkpOwoJCQl9CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJub2RlIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBub2RlJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Ob2RlKCkubm9kZV9Db25maWdzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkgIT0gJ0NvbmZpZycpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCXJldHVybiBuZXcgc2FsZXNub3dbZXZlbnQuY2xhc3NOYW1lKCldKCkuX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdyk7CgkJCX0KCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9Db25maWcvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQkJZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOwoJCQkJZGVsZXRlIGRhdGEuX190aGlzLm9ubGluZTsKCgkJCX0KCgkJCS8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/PwoKCQkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJCXRyeSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0pIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7bWV0aG9kfWApOwoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCWxldCBfaWQgPSBudWxsOwoJCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBkYXRhLCBtZXRob2QsIHt9KTsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRhdGEpID09PSAnc3RyaW5nJykgewoJCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUoZGF0YSk7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IGRhdGEuX190aGlzLmNvZGUgfHwgZGF0YS5pZCB8fCBkYXRhLklEOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJCWlmIChkYXRhLklkICYmIGRhdGEuSWQgPT0gZGF0YS5JZCkgewoJCQkJCQlfaWQgPSBkYXRhLklkOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQkJfSBlbHNlIGlmIChkYXRhLkVudGl0eUNsYXNzKSB7CgkJCQkJCV9pZCA9IGRhdGEuRW50aXR5Q2xhc3MuSWQgfHwgZGF0YS5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjg0NmJmMzc1LTdhZDEtNGRlYy04YTRlLWRmYzViZTViMzBhYiIgfHwgIk5VTEwiOwoJCQkJCX0KCQkJCX0KCgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWcgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZ1ttZXRob2RdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWdbbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnW21ldGhvZF1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnW21ldGhvZF1bX2lkXSB8fCB7fTsKCgkJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goe30sIHsKCQkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQkJfSk7CgoJCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnW21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWdbbWV0aG9kXVtfaWRdW19oYXNoXSA9IHsKCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeSh7fSksCgkJCQkJb2JqOiBkYXRhLAoJCQkJCXJldXNlZDogMCwKCQkJCX07CgkJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZGF0YSwgbWV0aG9kLCB7fSwgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBUcmlnZ2VycmluZyAke21ldGhvZH0gdG8gJHtuLmNvZGUoKX0gJHtKU09OLnN0cmluZ2lmeShkYXRhLG51bGwsNCl9YCk7CgoJCQlsZXQgZXYgPSBuZXcgc2FsZXNub3cuRXZlbnQoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSh0aGlzLl9fY29uZmlnKCdldmVudCcpIHx8ICdzYWxlc25vdy5FdmVudCcpLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnJlY2lwaWVudChuKS5tZXRob2QobWV0aG9kKS5jbGFzc05hbWUoJ0NvbmZpZycpLnNlbmRlcihzYWxlc25vdy5fbm9kZSkuY2FycmllcihzYWxlc25vdy5fbm9kZSkucGF5bG9hZChkYXRhKTsKCQkJaWYgKGV2ZW50KSB7CgkJCQlpZiAoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7CgkJCQlpZiAoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7CgkJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7CgkJCQlpZiAoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7CgkJCX0KCQkJcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOwoKCQkJaWYgKHR5cGVvZihyZXQpID09PSAic3RyaW5nIikgewoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChleCkge30KCQkJfQoJCQlyZXR1cm4gcmV0OwoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LkNvbmZpZyhudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuQ29uZmlnKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX25vZGUpIHsKCQkJLy8gcHJvYmFibHkgc2hvdWxkIG5vdCBiZSBwcm9jZXNzZWQgaGVyZSwgYnV0IHJhdGhlciBjb25zdW1lZCBhcyBwYXJ0IG9mIHRoZSBleGVjdXRlKCkgbG9naWMsIHB1c2hpbmcgX19ub2RlIHRvIHRoZSBsaXN0IG9mIG15IG5vZGVzIHRvIGRlbGVnYXRlIHRvIT8KCQkJbGV0IHRuID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX19ub2RlKS5fZGVSZWZlcmVuY2UoKTsKCQkJZGVsZXRlIF9wYXJhbXMuX19ub2RlOwoJCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LkNvbmZpZygpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOwoJCX0KCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgQ29uZmlnLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgQ29uZmlnLl9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQlpZiAoZmFsc2UgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCXJldCA9IHsKCQkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCQknLTQnOiAiVW5jb21taXR0ZWQgdHJhbnNhY3Rpb25zOiAiICsgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5zcWxzLmxlbmd0aCwKCQkJCQkJJ29iaic6IG9iagoJCQkJCX0KCQkJCX0KCQkJfQoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZy5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5Db25maWcuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglfcGFyc2VDb2RlU3RhdGUodCkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyc2VDb2RlU3RhdGUodCk7CgoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiQ29uZmlnIik7CgoJfQoKCV9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4ID0gJ3t7JywgcG9zdGZpeCA9ICd9fScpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXgsIHBvc3RmaXgpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQlpZiAodGhpcy5fdG9vbF9zZXQgJiYgdGhpcy50b29sKCkpIHRoaXMudG9vbCgpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl90eXBlX3NldCAmJiB0aGlzLnR5cGUoKSkgdGhpcy50eXBlKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX25vZGVfc2V0ICYmIHRoaXMubm9kZSgpKSB0aGlzLm5vZGUoKS5fX3N5bmNfb24oZCk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93LkNvbmZpZyh0aGlzLklkKQoKCQkJLnZhbHVlKHRoaXMudmFsdWUoKSwgdGhpcy5fdmFsdWVfY29vcCkKCgkJCS5zY3JpcHQodGhpcy5zY3JpcHQoKSwgdGhpcy5fc2NyaXB0X2Nvb3ApCgoJCQkudG9vbCh0aGlzLnRvb2woKSwgdGhpcy5fdG9vbF9jb29wKQoKCQkJLnR5cGUodGhpcy50eXBlKCksIHRoaXMuX3R5cGVfY29vcCkKCgkJCS5ub2RlKHRoaXMubm9kZSgpLCB0aGlzLl9ub2RlX2Nvb3ApCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5jb2RlKHRoaXMuY29kZSgpLCB0aGlzLl9jb2RlX2Nvb3ApCgoJCQkub3JkZXIodGhpcy5vcmRlcigpLCB0aGlzLl9vcmRlcl9jb29wKQoKCQkJLmRhdGUodGhpcy5kYXRlKCksIHRoaXMuX2RhdGVfY29vcCkKCgkJCS5uYW1lKHRoaXMubmFtZSgpLCB0aGlzLl9uYW1lX2Nvb3ApCgoJCQkucmVtYXJrKHRoaXMucmVtYXJrKCksIHRoaXMuX3JlbWFya19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSkgewoJCWNvbnRleHQgPSBjb250ZXh0IHx8ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCS8vb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCS8vb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ0NvbmZpZyc7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoJCWNvZGVUeXBlID0gY29kZVR5cGUgfHwgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKMGIyOXNJam9pVkc5dmJDSXNJblI1Y0dVaU9pSlViMjlzWDFSNWNHVWlMQ0p1YjJSbElqb2lUbTlrWlNKOWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pW2NvZGVdOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJDb25maWciOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19jb25maWcobiwgbnVsbFZhbHVlLCBPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zIHx8IHt9LCB7CgkJCV9jbGFzczogJ0NvbmZpZycKCQl9KSk7CgoJfQoKCWFzeW5jIF9yZXN0KHROYW1lID0gdGhpcy5fbkNvZGUoKSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMgPSB7fSkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIodW5kZWZpbmVkLCB0aGlzLlRvb2wpLl9yZXN0KHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zKTsKCgl9CgoJX3RvU1FMVGFibGUoKSB7CgkJbGV0IHJldCA9IHsKCQkJc3FsOiBgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoCiAgICAgICAgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVkKICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd2YWx1ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiT2JqZWN0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdzY3JpcHQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbm9kZScsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICBgCgkJfTsKCQlyZXQuc3FsICs9ICcvKkNvbmZpZyovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJ2YWx1ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd2YWx1ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd2YWx1ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiT2JqZWN0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJzY3JpcHQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc2NyaXB0JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3NjcmlwdCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkidG9vbCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJInR5cGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJub2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbm9kZScsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypDb25maWcqLyk7XG4nOwoKCQlyZXQuc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChyZXQuc3FsKSA6IHJldC5zcWw7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NRTFRhYmxlJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldC5zcWwpOwoJCXJldHVybiByZXQuc3FsOwoJfQoKCV9mcm9tU1FMVGFibGUodGFibGUsIGZpZWxkcykgewoJCS8vIHRhYmxlIGlzIGEganNvbiBhcnJheQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigidmFsdWUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnZhbHVlKHRhYmxlWyJ2YWx1ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJzY3JpcHQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnNjcmlwdCh0YWJsZVsic2NyaXB0Il0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInRvb2wiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnRvb2wodGFibGVbInRvb2wiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigidHlwZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMudHlwZSh0YWJsZVsidHlwZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJub2RlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5ub2RlKHRhYmxlWyJub2RlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuYWN0aXZlKHRhYmxlWyJhY3RpdmUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZW5hYmxlZCh0YWJsZVsiZW5hYmxlZCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5jb2RlKHRhYmxlWyJjb2RlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5vcmRlcih0YWJsZVsib3JkZXIiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZGF0ZSh0YWJsZVsiZGF0ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5uYW1lKHRhYmxlWyJuYW1lIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucmVtYXJrKHRhYmxlWyJyZW1hcmsiXSk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBfc3FsKHNxbCwgc291cmNlID0gdGhpcykgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsKHNxbCwgdGhpcyk7CgoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgYlN0cmluZykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHsKCQkJW3RoaXMuX25Db2RlKCldOiB7CgkJCQlwYXJhbXM6IHsKCQkJCQl3aGVyZTogewoJCQkJCQlhbmQ6IFtdLAoJCQkJCQlvcjogW10KCQkJCQl9CgkJCQl9LAoJCQkJZWRnZXM6IHsKCQkJCQlub2RlOiB7fQoJCQkJfQoJCQl9CgkJfSwgewoJCQkvL09QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goewoJCQkJSWQ6IHsKCQkJCQllcTogdgoJCQkJfQoJCQl9KSwKCgkJCXZhbHVlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndmFsdWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJc2NyaXB0OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc2NyaXB0JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCXRvb2w6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQl7CgkJCQkJCQlpbnE6IHsKCQkJCQkJCQlBcGlOYW1lOiAnSWQnLAoJCQkJCQkJCVt0aGlzLl9uQ29kZSgnVG9vbCcsIHVuZGVmaW5lZCldOiB2ID8gdi5fdG9TRlF1ZXJ5KClbdGhpcy5fbkNvZGUoJ1Rvb2wnLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJdHlwZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdUb29sX1R5cGUnLCB1bmRlZmluZWQpXTogdiA/IHYuX3RvU0ZRdWVyeSgpW3RoaXMuX25Db2RlKCdUb29sX1R5cGUnLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJbm9kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdOb2RlJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnTm9kZScsIHVuZGVmaW5lZCldLnBhcmFtcy53aGVyZS5hbmQgOiBbXSwKCQkJCQkJCX0sCgkJCQkJCX0KCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCSh2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbCkKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQl9LCAiX3RvU0ZRdWVyeSIpOwoKCQkvL09iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlpZiAoYlN0cmluZykgewoJCQlyZXQgPSB7CgkJCQlxdWVyeTogewoJCQkJCVt0aGlzLl9uQ29kZSgpICsgJ1F1ZXJ5J106IHsKCQkJCQkJdWlhcGk6IHJldAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJcmV0ID0gSlNPTi5zdHJpbmdpZnkocmV0LCBudWxsLCA0KTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NGUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqLnN5c19pZCA9IHYsCgoJCQl2YWx1ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3ZhbHVlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlzY3JpcHQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzY3JpcHQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCXRvb2w6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCQl0eXBlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b1NOUXVlcnkoKSA6IG51bGw7CgoJCQl9LAoKCQkJbm9kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9TTlF1ZXJ5KCkgOiBudWxsOwoKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlsZXQgZCA9IGAke3YuZ2V0RnVsbFllYXIoKX0tJHsoJzAnKyh2LmdldE1vbnRoKCkrMSkpLnNsaWNlKC0yKX0tJHt2LmdldERhdGUoKX1gOwoJCQkJbGV0IHQgPSBgJHt2LmdldEhvdXJzKCl9OiR7di5nZXRNaW51dGVzKCl9OiR7di5nZXRTZWNvbmRzKCl9YDsKCQkJCWlmICgodi5nZXRIb3VycygpID09IDAgJiYgdi5nZXRNaW51dGVzKCkgPT0gMCAmJiB2LmdldFNlY29uZHMoKSA9PSAwKSB8fCB0aGlzLl9kYXRlX2Nvb3AgPT0gJz0nIHx8ICF0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBPTiR7ZH1AamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdzdGFydCcpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywnZW5kJylgOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9kYXRlX2Nvb3AgIT09ICdCRVRXRUVOJykgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9IGVsc2UgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfQoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJfSwgIl90b1NOUXVlcnkiKTsKCgkJT2JqZWN0LmtleXMocmV0Lk9QRVJBVE9SUyB8fCB7fSkuZmlsdGVyKGsgPT4gdHlwZW9mKHJldFtrXSkgIT09ICd1bmRlZmluZWQnKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gcmV0Lk9QRVJBVE9SU1trXSArIHJldFtrXSk7CgoJCWRlbGV0ZSByZXQuT1BFUkFUT1JTOwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlyZXQgPSBEb3RPYmplY3QuZG90KHJldCk7CgoJCS8vIGF2b2lkIHNlbmRpbmcgd2l0aCBubyBjb21wYXJpc29uIG9wZXJhdG9ycwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVsnPicsICc8JywgJ0JFVFdFRU4nLCAnT04nLCAnIScsICc9JywgJ1NUQVJUU1dJVEgnLCAnTElLRSddLnNvbWUocyA9PiBTdHJpbmcocmV0W2tdKS5zdGFydHNXaXRoKHMpKSkuZm9yRWFjaChrID0+IHJldFtrXSA9ICh0aGlzW2BfJHtrfV9jb29wYF0gfHwgJ1NUQVJUU1dJVEgnKSArIHJldFtrXSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgT2JqZWN0LmVudHJpZXMocmV0IHx8IHt9KS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJbGV0IF9yZXQgPSBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIGZhbHNlLCBmdW4sIGVhT2JqLCBvYmopOwoJCQkJcmV0dXJuIF9yZXQ7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoInZhbHVlIiwgb2JqLCB0aGlzLnZhbHVlKCkpOwoKCQlfb3B0aW9ucygic2NyaXB0Iiwgb2JqLCB0aGlzLnNjcmlwdCgpKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqLCB0aGlzLmNvZGUoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmosIHRoaXMuZGF0ZSgpKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmosIHRoaXMubmFtZSgpKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaiwgdGhpcy5yZW1hcmsoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI4NDZiZjM3NS03YWQxLTRkZWMtOGE0ZS1kZmM1YmU1YjMwYWIiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWcgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZ1tmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZ1tmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZ1tmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWdbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZ1tmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlpZiAoIXRoaXMudG9vbCgpIHx8ICh0aGlzLnRvb2woKQoKCQkJCSYmCgkJCQkhdGhpcy50b29sKCkudG9vbF9Db25maWdzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnRvb2woKS50b29sX01hcHBpbmdzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJ0b29sIiwgb2JqLCB0aGlzLnRvb2woKSk7CgkJfQoKCQlpZiAoIXRoaXMudHlwZSgpIHx8ICh0aGlzLnR5cGUoKQoKCQkJCSYmCgkJCQkhdGhpcy50eXBlKCkudHlwZV9Db25maWdzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnR5cGUoKS50eXBlX1Rvb2xzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnR5cGUoKS50eXBlX01hcHBpbmdzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJ0eXBlIiwgb2JqLCB0aGlzLnR5cGUoKSk7CgkJfQoKCQlpZiAoIXRoaXMubm9kZSgpIHx8ICh0aGlzLm5vZGUoKQoKCQkJCSYmCgkJCQkhdGhpcy5ub2RlKCkubm9kZV9Db25maWdzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLm5vZGUoKS5jYXJyaWVyX0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5ub2RlKCkuc2VuZGVyX0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5ub2RlKCkucmVjaXBpZW50X0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5ub2RlKCkuYmFja3VwX05vZGVzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLm5vZGUoKS5wYXJlbnRfTm9kZXMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMubm9kZSgpLm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJub2RlIiwgb2JqLCB0aGlzLm5vZGUoKSk7CgkJfQoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWyd2YWx1ZScsICdzY3JpcHQnLCAndG9vbCcsICd0eXBlJywgJ25vZGUnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgdHJ1ZSwgZnVuLCBvYmosIG9iaik7CgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJ2YWx1ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJzY3JpcHQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI4NDZiZjM3NS03YWQxLTRkZWMtOGE0ZS1kZmM1YmU1YjMwYWIiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWcgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuQ29uZmlnW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZ1tmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZ1tmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZ1tmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Db25maWdbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkNvbmZpZ1tmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJ0b29sIiwgb2JqKTsKCgkJX29wdGlvbnMoInR5cGUiLCBvYmopOwoKCQlfb3B0aW9ucygibm9kZSIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ3ZhbHVlJywgJ3NjcmlwdCcsICd0b29sJywgJ3R5cGUnLCAnbm9kZScsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RCT2JqZWN0KGZpZWxkcywgYk5vUmVmKSB7CgkJaWYgKCF0aGlzLklkKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJJbnZhbGlkIElEIiwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lLCB0aGlzLlRvb2wpOwoJCX0KCQlsZXQgcmV0ID0gewoJCQlbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldOiAiJyIgKyB0aGlzLklkICsgIiciCgkJfTsKCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJ2YWx1ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl92YWx1ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy52YWx1ZSgpOwoKCQkJZlZhbHVlID0gIiciICsgSlNPTi5zdHJpbmdpZnkodiwgbnVsbCwgJ1x0JykgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3ZhbHVlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigic2NyaXB0IikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3NjcmlwdF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5zY3JpcHQoKTsKCgkJCWZWYWx1ZSA9ICInIiArICgodiAmJiB2LnJlcGxhY2UpID8gdi5yZXBsYWNlKC9cJy9nLCAiXCdcJyIpIDogdikgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3NjcmlwdCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInRvb2wiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fdG9vbF9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMudG9vbCgpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgndG9vbCcsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigidHlwZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl90eXBlX3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy50eXBlKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSArICJpZCJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJub2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX25vZGVfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm5vZGUoKTsKCgkJCWlmICh2ICYmICh2Ll9fc3luY19vbigpIHx8IHYuSWQgPT0gdi5JZCkpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYuSWQgKyAiJyI7CgkJCX0gZWxzZSB7CgkJCQlmVmFsdWUgPSAwOwoJCQl9CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9hY3RpdmVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYWN0aXZlKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZW5hYmxlZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5lbmFibGVkKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvZGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29kZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2RhdGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZGF0ZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5uYW1lKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3JlbWFya19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5yZW1hcmsoKTsKCgkJCWZWYWx1ZSA9ICInIiArICgodiAmJiB2LnJlcGxhY2UpID8gdi5yZXBsYWNlKC9cJy9nLCAiXCdcJyIpIDogdikgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX1EoKSB7CgkJbGV0IF9vID0gJyInOwoJCWxldCBfcSA9IF9vOwoKCQlpZiAoWydTYWxlc0ZvcmNlJ10uaW5kZXhPZih0aGlzLlRvb2wudHlwZS5uYW1lKSA9PSAwKSB7CgkJCV9vID0gX3EgPSAiIjsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgewoJCQlfbyA9IF9xID0gJ2AnOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxzZXJ2ZXInKSB7CgkJCV9vID0gJ1snOwoJCQlfcSA9ICddJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ2FwaUtleScpID09ICdhaXJ0YWJsZScpIHsKCQkJX28gPSAneyc7CgkJCV9xID0gJ30nOwoJCX0KCQl0aGlzLl9fUSA9IHRoaXMuX19RID09IF9vID8gX3EgOiBfbzsKCQlyZXR1cm4gdGhpcy5fX1E7Cgl9CgoJX2ZpZWxkR3JvdXBzKGZncyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOwoJCXJldHVybiB0aGlzOwoJfQoKCV9maWVsZEFnZ3JlZ2F0ZXMoZmFzID0ge30pIHsKCQl0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOwoJCXJldHVybiB0aGlzOwoJfQoKCV90b0ZpZWxkc1NRTChmaWVsZHMpIHsKCgkJZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKSwgdGhpcy5fbkNvZGUoJ3ZhbHVlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3NjcmlwdCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkgKyAiLmlkIiwgdGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpXTsKCQlmaWVsZHMgPSBBcnJheS5pc0FycmF5KGZpZWxkcykgPyBmaWVsZHMgOiBbZmllbGRzXTsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQkvLyB7ZmllbGQ6IG9yZGVyfQoJCQlmaWVsZHMgPSBbXTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMudmFsdWUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCd2YWx1ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnRvb2wpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy50eXBlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubm9kZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9YCk7CgoJCX0KCQlyZXR1cm4gZmllbGRzOwoJfQoKCV9mcm9tREJPYmplY3QociA9IHt9KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMuX19pbXBvcnQociwgewoJCQkJSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSwKCgkJCQl2YWx1ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3ZhbHVlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMudmFsdWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlzY3JpcHQ6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzY3JpcHQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5zY3JpcHQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQl0b29sOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndG9vbCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnRvb2wob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQl0eXBlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnR5cGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlub2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbm9kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5vZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU51bGw6IHRydWUsCgoJCQl0b29sOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndG9vbCcsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LlRvb2wobnVsbCwgdGhpcy5Ub29sKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJCXR5cGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSkgPT4gb2JqW2VhQ29kZV0gPSBuZXcgc2FsZXNub3cuVG9vbF9UeXBlKG51bGwsIHRoaXMuVG9vbCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQlub2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbm9kZScsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93Lk5vZGUobnVsbCwgdGhpcy5Ub29sKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJfSwgIl90b1NlbGVjdEhlYWRlciIpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RIZWFkZXInLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9TZWxlY3RTUUwoZmllbGRzKSB7CgkJbGV0IHNxbCA9ICJzZWxlY3QgIjsKCgkJbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX1gOwoKCQlsZXQgaGVhZGVyID0gdGhpcy5fdG9TZWxlY3RIZWFkZXIoZmllbGRzKTsKCgkJc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOwoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOwoKCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcykgewoJCQkvLyB7ZmllbGQ6IGZ1bmN0aW9ufQoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMudmFsdWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnZhbHVlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd2YWx1ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy50b29sKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy50b29sfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnR5cGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnR5cGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubm9kZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubm9kZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbm9kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCX0KCgkJc3FsICs9IGAgZnJvbSAke3RQcmVmfSBgOwoKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gYGxlZnQgam9pbiAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX0ke3RoaXMuX1EoKX0gYXMgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0gb24gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtrfWlkJHt0aGlzLl9RKCl9PSR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGApOwoKCQlzcWwgKz0gYCB3aGVyZSAxPTFgOwoKCQlzcWwgPSB0aGlzLl9fZXhwb3J0KHsKCQkJc3FsOiBzcWwKCQl9LCB7CgkJCV9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgPyBbJ0lkJ10gOiB1bmRlZmluZWQsCgkJCU51bGw6IHRydWUsCgkJCV9USElTOiBvYmogPT4gewoJCQkJaWYgKCF0aGlzLl9USElTIHx8ICF0aGlzLl9USElTLmxlbmd0aCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCh0Ll9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnKSkuam9pbignIFVOSU9OIEFMTCAnKSArICIpIjsKCQkJfSwKCQkJSWQ6IG9iaiA9PiBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2AsCgoJCQl2YWx1ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3ZhbHVlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl92YWx1ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX3ZhbHVlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlzY3JpcHQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzY3JpcHQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3NjcmlwdF9zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJdG9vbDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3Rvb2xfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl90b29sX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJdHlwZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3R5cGVfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl90eXBlX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJbm9kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX25vZGVfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9ub2RlX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jb2RlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fb3JkZXJfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vcmRlcl9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9kYXRlX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LnRvSVNPU3RyaW5nKSB7CgkJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3FsaXRlJykgewoJCQkJCQlvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbmFtZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX25hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3JlbWFya19zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvU2VsZWN0U1FMIiwgZmllbGRzKS5zcWw7CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJaWYgKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy52YWx1ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd2YWx1ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnZhbHVlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnRvb2wpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndG9vbCcsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMudG9vbH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy50eXBlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnR5cGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubm9kZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5ub2RlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jb2RlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMub3JkZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZGF0ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5uYW1lfWA7CgoJCX0KCgkJaWYgKHNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpIHsKCQkJLy8gc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSIsICJ3aGVyZSAxPTAiKTsKCQl9IGVsc2UgewoJCQlzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7CgkJfQoKCQlzcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCkgOiBzcWw7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgoJCXJldHVybiBzcWw7Cgl9CgoJX3RvUGF0aHMoKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJX1RISVM6IG9iaiA9PiB7fSwKCgkJCXRvb2w6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKSkgPT4gb2JqLnRvb2wgPSB2Ll90b1BhdGhzKCksCgoJCQl0eXBlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IG9iai50eXBlID0gdi5fdG9QYXRocygpLAoKCQkJbm9kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpKSA9PiBvYmoubm9kZSA9IHYuX3RvUGF0aHMoKSwKCgkJfSwgIl90b1BhdGhzIik7CgkJLy8gcmV0dXJuIHJldDsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5tYXAoayA9PiAoewoJCQlba106IHJldFtrXQoJCX0pKTsKCX0KCglfdG9VcGRhdGVTUUwoZmllbGRzKSB7CgkJbGV0IHJldEZpZWxkcyA9IHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLmpvaW4oJywgJyk7CgkJbGV0IHNxbCA9IGB1cGRhdGUgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSBzZXQgYCArIE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvREJPYmplY3QoZmllbGRzKSkubWFwKHYgPT4gdGhpcy5fUSgpICsgdlswXSArIHRoaXMuX1EoKSArICI9IiArIHZbMV0pICsgYCB3aGVyZSAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgOyAvL2AgcmV0dXJuaW5nICR7cmV0RmllbGRzfWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvVXBkYXRlU1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfdG9JbnNlcnRTUUwoZmllbGRzKSB7CgkJbGV0IG9iaiA9IHRoaXMuX3RvREJPYmplY3QoZmllbGRzKTsKCQlsZXQgc3FsID0gYGluc2VydCBpbnRvICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKGAgKyBPYmplY3Qua2V5cyhvYmopLm1hcChrID0+IHRoaXMuX1EoKSArIGsgKyB0aGlzLl9RKCkpICsgIikgdmFsdWVzICgiICsgT2JqZWN0LnZhbHVlcyhvYmopICsgYClgOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0luc2VydFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5Db25maWcpIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuQ29uZmlnID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5Db25maWcoKQoKCQkJCQkudG9vbChuZXcgc2FsZXNub3cuVG9vbCgpKQoKCQkJCQkudHlwZShuZXcgc2FsZXNub3cuVG9vbF9UeXBlKCkpCgoJCQkJCS5ub2RlKG5ldyBzYWxlc25vdy5Ob2RlKCkpCgoJCQkJCS5fdG9TUUxUYWJsZShkZXB0aCk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiQ29uZmlnIikgcmV0dXJuIGZhbHNlOwoKCQkJbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJCUZ1bGw6IHRydWUsCgkJCQlOdWxsOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5faWQgPSB0aGlzLklkID09IHF1ZXJ5LklkLAoKCQkJCXZhbHVlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai52YWx1ZSA9IHYgPT0gcXVlcnkudmFsdWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fdmFsdWVfc2V0ICYmICFxdWVyeS5fdmFsdWVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnZhbHVlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3ZhbHVlX3NldCAmJiBxdWVyeS5fdmFsdWVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai52YWx1ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlzY3JpcHQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnNjcmlwdCA9IHYgPT0gcXVlcnkuc2NyaXB0KCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3NjcmlwdF9zZXQgJiYgIXF1ZXJ5Ll9zY3JpcHRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnNjcmlwdCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9zY3JpcHRfc2V0ICYmIHF1ZXJ5Ll9zY3JpcHRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5zY3JpcHQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJdG9vbDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoudG9vbCA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkudG9vbCgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl90b29sX3NldCAmJiAhcXVlcnkuX3Rvb2xfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnRvb2wgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fdG9vbF9zZXQgJiYgcXVlcnkuX3Rvb2xfc2V0KSB8fAoKCQkJCQkJKHRoaXMudG9vbCgpICYmICF0aGlzLnRvb2woKS5fbWF0Y2hlcyhxdWVyeS50b29sKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai50b29sID0gZmFsc2U7CgkJCQl9LAoKCQkJCXR5cGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnR5cGUgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LnR5cGUoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fdHlwZV9zZXQgJiYgIXF1ZXJ5Ll90eXBlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai50eXBlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3R5cGVfc2V0ICYmIHF1ZXJ5Ll90eXBlX3NldCkgfHwKCgkJCQkJCSh0aGlzLnR5cGUoKSAmJiAhdGhpcy50eXBlKCkuX21hdGNoZXMocXVlcnkudHlwZSgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudHlwZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlub2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5ub2RlID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5ub2RlKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25vZGVfc2V0ICYmICFxdWVyeS5fbm9kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubm9kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9ub2RlX3NldCAmJiBxdWVyeS5fbm9kZV9zZXQpIHx8CgoJCQkJCQkodGhpcy5ub2RlKCkgJiYgIXRoaXMubm9kZSgpLl9tYXRjaGVzKHF1ZXJ5Lm5vZGUoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5vZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJdG9vbDogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIHRvb2wiKTsKCQkJCQlvYmoudG9vbCA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCXR5cGU6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciB0eXBlIik7CgkJCQkJb2JqLnR5cGUgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQlub2RlOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3Igbm9kZSIpOwoJCQkJCW9iai5ub2RlID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fdmFsdWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fc2NyaXB0X3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3Rvb2xfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fdHlwZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9ub2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJdG9vbDogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLnRvb2wocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCXR5cGU6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy50eXBlKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlub2RlOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMubm9kZShyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCXZhbHVlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndmFsdWUnLCB1bmRlZmluZWQpIDogInZhbHVlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3ZhbHVlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy52YWx1ZShyZWYpOwoKCQkJfSwKCgkJCXNjcmlwdDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3NjcmlwdCcsIHVuZGVmaW5lZCkgOiAic2NyaXB0IikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3NjcmlwdF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuc2NyaXB0KHJlZik7CgoJCQl9LAoKCQkJdG9vbDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpIDogInRvb2wiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fdG9vbF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy50b29sKCkgfHwgbmV3IHNhbGVzbm93LlRvb2woKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLnRvb2wob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSB0b29sIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQl0eXBlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkgOiAidHlwZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl90eXBlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLnR5cGUoKSB8fCBuZXcgc2FsZXNub3cuVG9vbF9UeXBlKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy50eXBlKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgdHlwZSIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJbm9kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpIDogIm5vZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbm9kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5ub2RlKCkgfHwgbmV3IHNhbGVzbm93Lk5vZGUoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLm5vZGUob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSBub2RlIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb2RlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jb2RlKHJlZik7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3JkZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9yZGVyKHJlZik7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLmRhdGUocmVmKTsKCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9uYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5uYW1lKHJlZik7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVtYXJrX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5yZW1hcmsocmVmKTsKCgkJCX0sCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0gPSB2LAoKCQkJInZhbHVlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3ZhbHVlJywgdW5kZWZpbmVkKSA6ICJ2YWx1ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl92YWx1ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fdmFsdWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJzY3JpcHQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnc2NyaXB0JywgdW5kZWZpbmVkKSA6ICJzY3JpcHQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fc2NyaXB0X2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9zY3JpcHRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJ0b29sIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpIDogInRvb2wiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl90b29sX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl90b29sX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkidHlwZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSA6ICJ0eXBlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fdHlwZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fdHlwZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5vZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbm9kZScsIHVuZGVmaW5lZCkgOiAibm9kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX25vZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25vZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fZmxpcCgpICovCglfZmxpcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmxpcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9mbGlwKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCWJ5VG9vbChhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfdG9vbCJdICYmIChhWyJfdG9vbCJdLkVxdWFscyA/IGFbIl90b29sIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl90b29sIl0sIHIpKSkgewoJCQkJCXIuX3Rvb2xfQ29uZmlncy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5VG9vbF9UeXBlKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl90eXBlIl0gJiYgKGFbIl90eXBlIl0uRXF1YWxzID8gYVsiX3R5cGUiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX3R5cGUiXSwgcikpKSB7CgkJCQkJci5fdHlwZV9Db25maWdzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlOb2RlKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9ub2RlIl0gJiYgKGFbIl9ub2RlIl0uRXF1YWxzID8gYVsiX25vZGUiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX25vZGUiXSwgcikpKSB7CgkJCQkJci5fbm9kZV9Db25maWdzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSB0cnVlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuQ29uZmlnLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5Db25maWcobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLnRvb2wodGhpcy50b29sKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMudHlwZSh0aGlzLnR5cGUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5uYW1lKHRoaXMubmFtZSgpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24pID09PSAidW5kZWZpbmVkIiB8fCBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nQkVHSU4nOidTVEFSVCd9IFRSQU5TQUNUSU9OYCk7CgkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gPSB7CgkJCQkJCQlPd25lcjogdGhpcywKCQkJCQkJCXNxbHM6IFtdLAoJCQkJCQkJc3RhcnQ6IG5ldyBEYXRlKCksCgkJCQkJCQllbmQ6IG51bGwKCQkJCQkJfTsKCQkJCQl9CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSB7CgkJCQkJdGhpcy5hY3RpdmUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSB7CgkJCQkJdGhpcy5lbmFibGVkKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgewoJCQkJCXRoaXMuZGF0ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSBuZXcgRGF0ZSgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl90b29sX3NldCAmJiB0aGlzLnRvb2woKSAmJiAhKGF3YWl0IHRoaXMudG9vbCgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX3Rvb2woKTsKCgkJCQkJaWYgKHRoaXMuX3R5cGVfc2V0ICYmIHRoaXMudHlwZSgpICYmICEoYXdhaXQgdGhpcy50eXBlKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfdHlwZSgpOwoKCQkJCQlpZiAodGhpcy5fbm9kZV9zZXQgJiYgdGhpcy5ub2RlKCkgJiYgIShhd2FpdCB0aGlzLm5vZGUoKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9ub2RlKCk7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fX2Fzc2VydFZhbGlkKHRydWUpKSByZXR1cm4gbnVsbDsKCgkJCQkvL2F3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8gaW4gY2FzZSBUb29sIGNoYW5nZXMKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgQWJvdXQgdG8gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9YCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgRmluaXNoZWQgSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9IElkPVske3RoaXMuSWR9XWApOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCQlpZiAoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5Pd25lciA9PSB0aGlzKSB7CgkJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYENPTU1JVCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nIFRSQU5TQUNUSU9OJzonJ31gKTsKCQkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kID0gbmV3IERhdGUoKTsKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuQ29uZmlnLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl0aGlzLl9mcm9tRG9jdW1lbnQoYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlsZXQgb2JqID0ge307CgoJCQkJaWYgKHRoaXMuX3ZhbHVlX3NldCkgewoKCQkJCQlvYmoudmFsdWUgPSB0aGlzLnZhbHVlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9zY3JpcHRfc2V0KSB7CgoJCQkJCW9iai5zY3JpcHQgPSB0aGlzLnNjcmlwdCgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fdG9vbF9zZXQpIHsKCgkJCQkJb2JqLnRvb2wgPSB0aGlzLl90b29sLklkOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fdHlwZV9zZXQpIHsKCgkJCQkJb2JqLnR5cGUgPSB0aGlzLl90eXBlLklkOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fbm9kZV9zZXQpIHsKCgkJCQkJb2JqLm5vZGUgPSB0aGlzLl9ub2RlLklkOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fYWN0aXZlX3NldCkgewoKCQkJCQlvYmouYWN0aXZlID0gdGhpcy5hY3RpdmUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfc2V0KSB7CgoJCQkJCW9iai5lbmFibGVkID0gdGhpcy5lbmFibGVkKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9jb2RlX3NldCkgewoKCQkJCQlvYmouY29kZSA9IHRoaXMuY29kZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fb3JkZXJfc2V0KSB7CgoJCQkJCW9iai5vcmRlciA9IHRoaXMub3JkZXIoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2RhdGVfc2V0KSB7CgoJCQkJCW9iai5kYXRlID0gdGhpcy5kYXRlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9uYW1lX3NldCkgewoKCQkJCQlvYmoubmFtZSA9IHRoaXMubmFtZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fcmVtYXJrX3NldCkgewoKCQkJCQlvYmoucmVtYXJrID0gdGhpcy5yZW1hcmsoKTsKCgkJCQl9CgoJCQkJbG9nKCJTZW5kaW5nIHRvIFNGIiwgb2JqKTsKCgkJCQlsZXQgcmVzID0gYXdhaXQgdGhpcy5Ub29sLmRiLnNvYmplY3QoIkNvbmZpZyIpLmNyZWF0ZShvYmopOwoJCQkJdGhpcy5JZCA9IHJlcy5pZDsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkNvbmZpZy51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1VwZGF0ZVNRTCgpKTsKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTCgpKTsKCQkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IHJldFswXTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkNvbmZpZy5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoZmllbGRzLCBvYmpzKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIHsKCQkJCQlzeXNwYXJtX3F1ZXJ5OiBPYmplY3QuZW50cmllcyh0aGlzLl90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgdHJ1ZSksIG51bGwsIHsKCQkJCQl1cmw6ICdyZXN0LnVybC5ncWwnCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgKTsKCQkJCXJldCA9IHJldC5jb250ZW50ID8gW0pTT04ucGFyc2UodGhpcy5fYXRvYihyZXQuY29udGVudCkpXSA6IFtdOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiQmVmb3JlIF9mcm9tRG9jdW1lbnQoKSIsIHJldCk7CgoJCQlyZXQgPSByZXQubWFwKHIgPT4gbmV3IHNhbGVzbm93LkNvbmZpZyhudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93LlRvb2wgPSBjbGFzcyBUb29sIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUXNLaTVmY21WemRDd3FMbDlzYjJGa1ZHOXZiSE1pZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKbmFYUm9kV0l1ZEc5dmJITWlPaUpvZEhSd2N6b3ZMM0poZHk1bmFYUm9kV0oxYzJWeVkyOXVkR1Z1ZEM1amIyMHZabUZrYVc0dlptRmthVzR1WjJsMGFIVmlMbWx2TDIxaGMzUmxjaThpTENKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzZXlKdVlXMWxJam9pVTA1UFYwOVBRaUlzSW5SNWNHVWlPbnNpYm1GdFpTSTZJbE5sY25acFkyVk9iM2NpZlgwc0lsTmhiR1Z6Um05eVkyVWlMQ0pIYVhSSWRXSWlYUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJ0eXBlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl90eXBlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgkJdGhpcy5jbGVhcl90b29sX0NvbmZpZ3MoKTsKCgkJdGhpcy5jbGVhcl90b29sX01hcHBpbmdzKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiVG9vbCIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJLy8gaWYodGhpcy5fdHlwZV9zZXQgJiYgdGhpcy5fdHlwZSkgdGhpcy5fdHlwZS5Ub29sID0gdG9vbDsKCgkJLy8gKHRoaXMudG9vbF9Db25maWdzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJLy8gKHRoaXMudG9vbF9NYXBwaW5ncygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0eXBlICoqLwoJdHlwZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3R5cGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJ0eXBlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnNDY4ZTYxNjEtM2RmOC00ZmRmLWFlNTAtMGRiMjkzNmU2NTA0JyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnVG9vbCBUeXBlJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3R5cGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICI0NjhlNjE2MS0zZGY4LTRmZGYtYWU1MC0wZGIyOTM2ZTY1MDQiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiVG9vbCBUeXBlIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3R5cGUgIT0gdikgewoJCQkJdGhpcy5fdHlwZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3R5cGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX3R5cGUgPyB0aGlzLl90eXBlLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl90eXBlX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl90eXBlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3R5cGUpOwoJCX0KCX0KCgljbGVhcl90eXBlKCkgewoJCXRoaXMuX3R5cGVfc2V0ID0gbnVsbDsKCQl0aGlzLl90eXBlID0gbnVsbDsKCQl0aGlzLl90eXBlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0eXBlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdG9vbF9Db25maWdzICoqLwoJdG9vbF9Db25maWdzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl90b29sX0NvbmZpZ3M7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzg0NmJmMzc1LTdhZDEtNGRlYy04YTRlLWRmYzViZTViMzBhYicgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnQ29uZmlnJykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll90b29sX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3Rvb2xfQ29uZmlncycsICdFbnRpdHlPYmplY3QnLCAxLCAidG9vbCBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiQ29uZmlnIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndG9vbF9Db25maWdzJywgJ0VudGl0eU9iamVjdCcsIDEsICJ0b29sIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiQ29uZmlnIik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LnRvb2wodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fdG9vbF9Db25maWdzLnB1c2goLi4udik7CgkJdGhpcy5fdG9vbF9Db25maWdzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl90b29sX0NvbmZpZ3NfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX3Rvb2xfQ29uZmlncygpIHsKCQl0aGlzLl90b29sX0NvbmZpZ3Nfc2V0ID0gbnVsbDsKCQl0aGlzLl90b29sX0NvbmZpZ3MgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl90b29sX0NvbmZpZ3NfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0b29sX0NvbmZpZ3MgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0b29sX01hcHBpbmdzICoqLwoJdG9vbF9NYXBwaW5ncyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fdG9vbF9NYXBwaW5nczsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnOWFiYTU4ODMtYjY2Yi00Nzk0LTg5N2QtM2ZkODU5NGZhMDEyJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdNYXBwaW5nJykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll90b29sX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3Rvb2xfTWFwcGluZ3MnLCAnRW50aXR5T2JqZWN0JywgMSwgInRvb2wgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIk1hcHBpbmciKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0b29sX01hcHBpbmdzJywgJ0VudGl0eU9iamVjdCcsIDEsICJ0b29sIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiTWFwcGluZyIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi50b29sKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX3Rvb2xfTWFwcGluZ3MucHVzaCguLi52KTsKCQl0aGlzLl90b29sX01hcHBpbmdzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl90b29sX01hcHBpbmdzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl90b29sX01hcHBpbmdzKCkgewoJCXRoaXMuX3Rvb2xfTWFwcGluZ3Nfc2V0ID0gbnVsbDsKCQl0aGlzLl90b29sX01hcHBpbmdzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fdG9vbF9NYXBwaW5nc19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHRvb2xfTWFwcGluZ3MgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl90eXBlX3NldCwKCgkJCXRoaXMuX2FjdGl2ZV9zZXQsCgoJCQl0aGlzLl9lbmFibGVkX3NldCwKCgkJCXRoaXMuX2NvZGVfc2V0LAoKCQkJdGhpcy5fb3JkZXJfc2V0LAoKCQkJdGhpcy5fZGF0ZV9zZXQsCgoJCQl0aGlzLl9uYW1lX3NldCwKCgkJCXRoaXMuX3JlbWFya19zZXQsCgoJCQl0aGlzLl90b29sX0NvbmZpZ3Nfc2V0LAoKCQkJdGhpcy5fdG9vbF9NYXBwaW5nc19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll90eXBlX3NldCA9IHRoaXMuX3R5cGVfc2V0OwoJCXJldC5fdHlwZV9jb29wID0gdGhpcy5fdHlwZV9jb29wOwoJCXJldC50eXBlID0gdGhpcy50eXBlKCkgPyB0aGlzLnR5cGUoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy50eXBlKCk7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC50b29sX0NvbmZpZ3MgPSB0aGlzLnRvb2xfQ29uZmlncygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0LnRvb2xfTWFwcGluZ3MgPSB0aGlzLnRvb2xfTWFwcGluZ3MoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJInR5cGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCXRvb2xfQ29uZmlnczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Rvb2xfVG9vbHMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQl0b29sX01hcHBpbmdzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndG9vbF9Ub29scycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJ0eXBlIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciB0eXBlJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Ub29sX1R5cGUoKS50eXBlX1Rvb2xzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkgIT0gJ1Rvb2wnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiRGVsZWdhdGluZyBpbnZva2F0aW9uIHRvICIgKyBldmVudC5jbGFzc05hbWUoKSk7CgkJCQlyZXR1cm4gbmV3IHNhbGVzbm93W2V2ZW50LmNsYXNzTmFtZSgpXSgpLl9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpOwoJCQl9CgoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQlkYXRhLl9fdGhpcyA9IGRhdGEuX190aGlzIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkJc3dpdGNoIChtZXRob2QpIHsKCgkJCX0KCQl9CgoJCWlmICghbiB8fCBzYWxlc25vdy5fbm9kZS5fc2FtZU5vZGUobikpIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkNhbGxiYWNrIik7CgkJCXJldCA9IGF3YWl0IHRoaXMuX2ludm9rZShtZXRob2QsIGRhdGEpOwoJCX0gZWxzZSBpZiAobi5hZGRyZXNzKCkgJiYgbi5fc2FtZU5vZGUobikgLyphY3R1YWwgbm9kZSovICkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBuLl9hZGRyZXNzLCBuLl9wb3J0LCBtZXRob2QpOwoJCQl0cnkgewoJCQkJbGV0IGNvbmZpZyA9IHsKCQkJCQloZWFkZXJzOiB7fSwKCQkJCX07CgkJCQlpZiAoc2FsZXNub3cuX190b2tlbikgY29uZmlnLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGAke3NhbGVzbm93Ll9fdG9rZW4udG9rZW5fdHlwZX0gJHtzYWxlc25vdy5fX3Rva2VuLmFjY2Vzc190b2tlbn1gOwoJCQkJcmV0ID0gYXdhaXQgYXhpb3MucG9zdChgaHR0cCR7bi5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHtuLmFkZHJlc3MoKX06JHtuLnBvcnQoKSB8fCAzMDAwfS9tZXRob2QvVG9vbC8ke21ldGhvZH1gLCBkYXRhLCBjb25maWcpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQl9CgkJfSBlbHNlIHsKCgkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMuX19nZW5lcmF0ZWQ7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMub25saW5lOwoKCQkJfQoKCQkJLy93aHkgZG8gd2UgbmVlZCB0aGlzPz8/CgoJCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQkJdHJ5IHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHttZXRob2R9YCk7CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJbGV0IF9pZCA9IG51bGw7CgkJCQlpZiAodHlwZW9mKGRhdGEpID09PSAndW5kZWZpbmVkJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIGRhdGEsIG1ldGhvZCwge30pOwoJCQkJCXJldHVybiBkYXRhOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoZGF0YSkgPT09ICdzdHJpbmcnKSB7CgkJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShkYXRhKTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gZGF0YS5fX3RoaXMuY29kZSB8fCBkYXRhLmlkIHx8IGRhdGEuSUQ7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQkJaWYgKGRhdGEuSWQgJiYgZGF0YS5JZCA9PSBkYXRhLklkKSB7CgkJCQkJCV9pZCA9IGRhdGEuSWQ7CgkJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCQl9IGVsc2UgaWYgKGRhdGEuRW50aXR5Q2xhc3MpIHsKCQkJCQkJX2lkID0gZGF0YS5FbnRpdHlDbGFzcy5JZCB8fCBkYXRhLkVudGl0eUNsYXNzLk5hbWU7CgkJCQkJfSBlbHNlIHsKCQkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiNzM5YmM4NWEtOGQwZC00MmQyLTk1ZDctMmY4NDc1ODU2YTg5IiB8fCAiTlVMTCI7CgkJCQkJfQoJCQkJfQoKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sW21ldGhvZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xbbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbFttZXRob2RdW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xbbWV0aG9kXVtfaWRdIHx8IHt9OwoKCQkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaCh7fSwgewoJCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCQl9KTsKCgkJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sW21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sW21ldGhvZF1bX2lkXVtfaGFzaF0gPSB7CgkJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoe30pLAoJCQkJCW9iajogZGF0YSwKCQkJCQlyZXVzZWQ6IDAsCgkJCQl9OwoJCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0gPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGRhdGEsIG1ldGhvZCwge30sIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBgVHJpZ2dlcnJpbmcgJHttZXRob2R9IHRvICR7bi5jb2RlKCl9ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSxudWxsLDQpfWApOwoKCQkJbGV0IGV2ID0gbmV3IHNhbGVzbm93LkV2ZW50KCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuY29kZSh0aGlzLl91dWlkKCkpLm5hbWUodGhpcy5fX2NvbmZpZygnZXZlbnQnKSB8fCAnc2FsZXNub3cuRXZlbnQnKS5kYXRlKHRoaXMuc2VydmVyRGF0ZSgpKS5yZWNpcGllbnQobikubWV0aG9kKG1ldGhvZCkuY2xhc3NOYW1lKCdUb29sJykuc2VuZGVyKHNhbGVzbm93Ll9ub2RlKS5jYXJyaWVyKHNhbGVzbm93Ll9ub2RlKS5wYXlsb2FkKGRhdGEpOwoJCQlpZiAoZXZlbnQpIHsKCQkJCWlmIChldmVudC5fcmVzcG9uc2VUb19zZXQpIGV2LnJlc3BvbnNlVG8oZXZlbnQucmVzcG9uc2VUbygpKTsKCQkJCWlmIChldmVudC5fc2VuZGVyX3NldCkgZXYuc2VuZGVyKGV2ZW50LnNlbmRlcigpKTsKCQkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCkgZXYuY2xhc3NOYW1lKGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCWlmIChldmVudC5fY2Fycmllcl9zZXQgfHwgZXZlbnQuX3NlbmRlcl9zZXQpIGV2LmNhcnJpZXIoZXZlbnQuY2FycmllcigpIHx8IGV2ZW50LnNlbmRlcigpKTsKCQkJfQoJCQlyZXQgPSBhd2FpdCBldi50cmlnZ2VyKCk7CgoJCQlpZiAodHlwZW9mKHJldCkgPT09ICJzdHJpbmciKSB7CgkJCQl0cnkgewoJCQkJCXJldCA9IEpTT04ucGFyc2UocmV0KTsKCQkJCX0gY2F0Y2ggKGV4KSB7fQoJCQl9CgkJCXJldHVybiByZXQ7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5zZXJ0IjoKCQkJY2FzZSAidXBkYXRlIjoKCQkJY2FzZSAic3RvcmUiOgoJCQljYXNlICJkZWxldGUiOgoJCQljYXNlICJmaW5kIjogewoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuVG9vbChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuVG9vbChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocCkpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHt9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2UobWV0aG9kLCBib2R5LCBxdWVyeSwgYXV0aE9iaikgewoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgbWV0aG9kLCBxdWVyeSwgYm9keSk7CgoJCWlmICh0eXBlb2YoYm9keSkgPT09ICdzdHJpbmcnIHx8ICh0eXBlb2YoQnVmZmVyKSAhPT0gJ3VuZGVmaW5lZCcgJiYgQnVmZmVyLmlzQnVmZmVyKGJvZHkpKSkgewoJCQl0cnkgewoJCQkJYm9keSA9IEpTT04ucGFyc2UoYm9keS50b1N0cmluZygpKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJvZHkgaXMgbm90IGEgdmFsaWQgSlNPTiIsIGJvZHkpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoKCQlsZXQgX3BhcmFtcyA9IHF1ZXJ5ID8gT2JqZWN0LmFzc2lnbihxdWVyeSwgYm9keSkgOiBib2R5OwoJCWlmICh0eXBlb2YoX3BhcmFtcykgPT09ICdzdHJpbmcnKSBfcGFyYW1zID0gSlNPTi5wYXJzZShfcGFyYW1zKTsKCgkJaWYgKF9wYXJhbXMpIHsKCQkJX3BhcmFtcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcyk7CgkJfSBlbHNlIHsKCQkJX3BhcmFtcyA9IHt9OwoJCX0KCgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgX3BhcmFtcy5fX2ZsYXR0ZWQpIF9wYXJhbXMgPSBGbGF0dGVkLnBhcnNlKF9wYXJhbXMuX19mbGF0dGVkKTsKCgkJaWYgKF9wYXJhbXMuX19ub2RlKSB7CgkJCS8vIHByb2JhYmx5IHNob3VsZCBub3QgYmUgcHJvY2Vzc2VkIGhlcmUsIGJ1dCByYXRoZXIgY29uc3VtZWQgYXMgcGFydCBvZiB0aGUgZXhlY3V0ZSgpIGxvZ2ljLCBwdXNoaW5nIF9fbm9kZSB0byB0aGUgbGlzdCBvZiBteSBub2RlcyB0byBkZWxlZ2F0ZSB0byE/CgkJCWxldCB0biA9IG5ldyBzYWxlc25vdy5Ob2RlKCkuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fbm9kZSkuX2RlUmVmZXJlbmNlKCk7CgkJCWRlbGV0ZSBfcGFyYW1zLl9fbm9kZTsKCQkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Ub29sKCkuX2ludm9rZU5vZGUodG4sIG1ldGhvZCwgX3BhcmFtcyk7CgkJfQoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBUb29sLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgVG9vbC5faW52b2tlOiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLAoJCQkJCSdvYmonOiBvYmoKCQkJCX0KCQkJfTsKCQl9IGVsc2UgewoJCQlyZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOwoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJaWYgKGZhbHNlICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQlyZXQgPSB7CgkJCQkJX19leGNlcHRpb246IHsKCQkJCQkJJy00JzogIlVuY29tbWl0dGVkIHRyYW5zYWN0aW9uczogIiArIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uc3Fscy5sZW5ndGgsCgkJCQkJCSdvYmonOiBvYmoKCQkJCQl9CgkJCQl9CgkJCX0KCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQl9CgoJCWlmIChyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbikgewoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0ge307CgkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCXJldCA9IHJldC5tYXAociA9PiB7CgkJCQkJaWYgKHIgJiYgci5fdG9Eb2N1bWVudCkgewoJCQkJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sLl90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93LlRvb2wuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglfcGFyc2VDb2RlU3RhdGUodCkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyc2VDb2RlU3RhdGUodCk7CgoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiVG9vbCIpOwoKCX0KCglfcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCA9ICd7eycsIHBvc3RmaXggPSAnfX0nKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4LCBwb3N0Zml4KTsKCgl9CgoJX19zeW5jX29uKGQpIHsKCQl0aGlzLl9fX3N5bmNfb24gPSB0aGlzLl9fX3N5bmNfb24gfHwge307CgoJCWlmIChkKSB7CgkJCXRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV0gPSBkOwoKCQkJaWYgKHRoaXMuX3R5cGVfc2V0ICYmIHRoaXMudHlwZSgpKSB0aGlzLnR5cGUoKS5fX3N5bmNfb24oZCk7CgoJCQkvLyB0aGlzLnRvb2xfVG9vbHMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJLy8gdGhpcy50b29sX1Rvb2xzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0KCgkJcmV0dXJuIHRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV07Cgl9CgoJX2Nsb25lKCkgewoJCXJldHVybiBuZXcgc2FsZXNub3cuVG9vbCh0aGlzLklkKQoKCQkJLnR5cGUodGhpcy50eXBlKCksIHRoaXMuX3R5cGVfY29vcCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkudG9vbF9Db25maWdzKHRoaXMudG9vbF9Db25maWdzKCksIHRoaXMuX3Rvb2xfQ29uZmlnc19jb29wKQoKCQkJLnRvb2xfTWFwcGluZ3ModGhpcy50b29sX01hcHBpbmdzKCksIHRoaXMuX3Rvb2xfTWFwcGluZ3NfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQkvL29iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkvL29ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdUb29sJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgkJY29kZVR5cGUgPSBjb2RlVHlwZSB8fCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUowZVhCbElqb2lWRzl2YkY5VWVYQmxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSlbY29kZV07CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIlRvb2wiOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19jb25maWcobiwgbnVsbFZhbHVlLCBPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zIHx8IHt9LCB7CgkJCV9jbGFzczogJ1Rvb2wnCgkJfSkpOwoKCX0KCglhc3luYyBfcmVzdCh0TmFtZSA9IHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKHVuZGVmaW5lZCwgdGhpcy5Ub29sKS5fcmVzdCh0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyk7CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICBgCgkJfTsKCQlyZXQuc3FsICs9ICcvKlRvb2wqLyk7XG4nOwoKCQlyZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiB0cnVlLAoJCQlOdWxsOiB0cnVlLAoJCQkvL0lkOiAob2JqLCB2KSA9PiBvYmouc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWWAsCgoJCQkidHlwZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCXRvb2xfQ29uZmlnczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Rvb2xfVG9vbHMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQkJdG9vbF9NYXBwaW5nczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Rvb2xfVG9vbHMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypUb29sKi8pO1xuJzsKCgkJcmV0LnNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQocmV0LnNxbCkgOiByZXQuc3FsOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TUUxUYWJsZScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQuc3FsKTsKCQlyZXR1cm4gcmV0LnNxbDsKCX0KCglfZnJvbVNRTFRhYmxlKHRhYmxlLCBmaWVsZHMpIHsKCQkvLyB0YWJsZSBpcyBhIGpzb24gYXJyYXkKCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInR5cGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnR5cGUodGFibGVbInR5cGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5hY3RpdmUodGFibGVbImFjdGl2ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5lbmFibGVkKHRhYmxlWyJlbmFibGVkIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvZGUodGFibGVbImNvZGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9yZGVyKHRhYmxlWyJvcmRlciJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5kYXRlKHRhYmxlWyJkYXRlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm5hbWUodGFibGVbIm5hbWUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5yZW1hcmsodGFibGVbInJlbWFyayJdKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIF9zcWwoc3FsLCBzb3VyY2UgPSB0aGlzKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWwoc3FsLCB0aGlzKTsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCBiU3RyaW5nKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoewoJCQlbdGhpcy5fbkNvZGUoKV06IHsKCQkJCXBhcmFtczogewoJCQkJCXdoZXJlOiB7CgkJCQkJCWFuZDogW10sCgkJCQkJCW9yOiBbXQoJCQkJCX0KCQkJCX0sCgkJCQllZGdlczogewoJCQkJCW5vZGU6IHt9CgkJCQl9CgkJCX0KCQl9LCB7CgkJCS8vT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaCh7CgkJCQlJZDogewoJCQkJCWVxOiB2CgkJCQl9CgkJCX0pLAoKCQkJdHlwZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdUb29sX1R5cGUnLCB1bmRlZmluZWQpXTogdiA/IHYuX3RvU0ZRdWVyeSgpW3RoaXMuX25Db2RlKCdUb29sX1R5cGUnLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQkodiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGwpCgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJfSwgIl90b1NGUXVlcnkiKTsKCgkJLy9PYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJaWYgKGJTdHJpbmcpIHsKCQkJcmV0ID0gewoJCQkJcXVlcnk6IHsKCQkJCQlbdGhpcy5fbkNvZGUoKSArICdRdWVyeSddOiB7CgkJCQkJCXVpYXBpOiByZXQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXJldCA9IEpTT04uc3RyaW5naWZ5KHJldCwgbnVsbCwgNCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TRlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9iai5zeXNfaWQgPSB2LAoKCQkJdHlwZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9TTlF1ZXJ5KCkgOiBudWxsOwoKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlsZXQgZCA9IGAke3YuZ2V0RnVsbFllYXIoKX0tJHsoJzAnKyh2LmdldE1vbnRoKCkrMSkpLnNsaWNlKC0yKX0tJHt2LmdldERhdGUoKX1gOwoJCQkJbGV0IHQgPSBgJHt2LmdldEhvdXJzKCl9OiR7di5nZXRNaW51dGVzKCl9OiR7di5nZXRTZWNvbmRzKCl9YDsKCQkJCWlmICgodi5nZXRIb3VycygpID09IDAgJiYgdi5nZXRNaW51dGVzKCkgPT0gMCAmJiB2LmdldFNlY29uZHMoKSA9PSAwKSB8fCB0aGlzLl9kYXRlX2Nvb3AgPT0gJz0nIHx8ICF0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBPTiR7ZH1AamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdzdGFydCcpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywnZW5kJylgOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9kYXRlX2Nvb3AgIT09ICdCRVRXRUVOJykgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9IGVsc2UgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfQoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJfSwgIl90b1NOUXVlcnkiKTsKCgkJT2JqZWN0LmtleXMocmV0Lk9QRVJBVE9SUyB8fCB7fSkuZmlsdGVyKGsgPT4gdHlwZW9mKHJldFtrXSkgIT09ICd1bmRlZmluZWQnKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gcmV0Lk9QRVJBVE9SU1trXSArIHJldFtrXSk7CgoJCWRlbGV0ZSByZXQuT1BFUkFUT1JTOwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlyZXQgPSBEb3RPYmplY3QuZG90KHJldCk7CgoJCS8vIGF2b2lkIHNlbmRpbmcgd2l0aCBubyBjb21wYXJpc29uIG9wZXJhdG9ycwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVsnPicsICc8JywgJ0JFVFdFRU4nLCAnT04nLCAnIScsICc9JywgJ1NUQVJUU1dJVEgnLCAnTElLRSddLnNvbWUocyA9PiBTdHJpbmcocmV0W2tdKS5zdGFydHNXaXRoKHMpKSkuZm9yRWFjaChrID0+IHJldFtrXSA9ICh0aGlzW2BfJHtrfV9jb29wYF0gfHwgJ1NUQVJUU1dJVEgnKSArIHJldFtrXSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgT2JqZWN0LmVudHJpZXMocmV0IHx8IHt9KS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJbGV0IF9yZXQgPSBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIGZhbHNlLCBmdW4sIGVhT2JqLCBvYmopOwoJCQkJcmV0dXJuIF9yZXQ7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqLCB0aGlzLmNvZGUoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmosIHRoaXMuZGF0ZSgpKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmosIHRoaXMubmFtZSgpKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaiwgdGhpcy5yZW1hcmsoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI3MzliYzg1YS04ZDBkLTQyZDItOTVkNy0yZjg0NzU4NTZhODkiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbCA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbCB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbFtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCWlmICghdGhpcy50eXBlKCkgfHwgKHRoaXMudHlwZSgpCgoJCQkJJiYKCQkJCSF0aGlzLnR5cGUoKS50eXBlX0NvbmZpZ3MoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMudHlwZSgpLnR5cGVfVG9vbHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMudHlwZSgpLnR5cGVfTWFwcGluZ3MoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoInR5cGUiLCBvYmosIHRoaXMudHlwZSgpKTsKCQl9CgoJCV9vcHRpb25zKCJ0b29sX0NvbmZpZ3MiLCBvYmosIHRoaXMudG9vbF9Db25maWdzKCkpOwoKCQlfb3B0aW9ucygidG9vbF9NYXBwaW5ncyIsIG9iaiwgdGhpcy50b29sX01hcHBpbmdzKCkpOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWyd0eXBlJywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWyd0b29sX0NvbmZpZ3MnLCAndG9vbF9NYXBwaW5ncyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgdHJ1ZSwgZnVuLCBvYmosIG9iaik7CgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjczOWJjODVhLThkMGQtNDJkMi05NWQ3LTJmODQ3NTg1NmE4OSIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbFtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygidHlwZSIsIG9iaik7CgoJCV9vcHRpb25zKCJ0b29sX0NvbmZpZ3MiLCBvYmopOwoKCQlfb3B0aW9ucygidG9vbF9NYXBwaW5ncyIsIG9iaik7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ3R5cGUnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3Rvb2xfQ29uZmlncycsICd0b29sX01hcHBpbmdzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RCT2JqZWN0KGZpZWxkcywgYk5vUmVmKSB7CgkJaWYgKCF0aGlzLklkKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJJbnZhbGlkIElEIiwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lLCB0aGlzLlRvb2wpOwoJCX0KCQlsZXQgcmV0ID0gewoJCQlbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldOiAiJyIgKyB0aGlzLklkICsgIiciCgkJfTsKCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJ0eXBlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3R5cGVfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnR5cGUoKTsKCgkJCWlmICh2ICYmICh2Ll9fc3luY19vbigpIHx8IHYuSWQgPT0gdi5JZCkpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYuSWQgKyAiJyI7CgkJCX0gZWxzZSB7CgkJCQlmVmFsdWUgPSAwOwoJCQl9CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9hY3RpdmVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYWN0aXZlKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZW5hYmxlZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5lbmFibGVkKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvZGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29kZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2RhdGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZGF0ZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5uYW1lKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3JlbWFya19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5yZW1hcmsoKTsKCgkJCWZWYWx1ZSA9ICInIiArICgodiAmJiB2LnJlcGxhY2UpID8gdi5yZXBsYWNlKC9cJy9nLCAiXCdcJyIpIDogdikgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX1EoKSB7CgkJbGV0IF9vID0gJyInOwoJCWxldCBfcSA9IF9vOwoKCQlpZiAoWydTYWxlc0ZvcmNlJ10uaW5kZXhPZih0aGlzLlRvb2wudHlwZS5uYW1lKSA9PSAwKSB7CgkJCV9vID0gX3EgPSAiIjsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgewoJCQlfbyA9IF9xID0gJ2AnOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxzZXJ2ZXInKSB7CgkJCV9vID0gJ1snOwoJCQlfcSA9ICddJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ2FwaUtleScpID09ICdhaXJ0YWJsZScpIHsKCQkJX28gPSAneyc7CgkJCV9xID0gJ30nOwoJCX0KCQl0aGlzLl9fUSA9IHRoaXMuX19RID09IF9vID8gX3EgOiBfbzsKCQlyZXR1cm4gdGhpcy5fX1E7Cgl9CgoJX2ZpZWxkR3JvdXBzKGZncyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOwoJCXJldHVybiB0aGlzOwoJfQoKCV9maWVsZEFnZ3JlZ2F0ZXMoZmFzID0ge30pIHsKCQl0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOwoJCXJldHVybiB0aGlzOwoJfQoKCV90b0ZpZWxkc1NRTChmaWVsZHMpIHsKCgkJZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKSwgdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpXTsKCQlmaWVsZHMgPSBBcnJheS5pc0FycmF5KGZpZWxkcykgPyBmaWVsZHMgOiBbZmllbGRzXTsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQkvLyB7ZmllbGQ6IG9yZGVyfQoJCQlmaWVsZHMgPSBbXTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMudHlwZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9YCk7CgoJCX0KCQlyZXR1cm4gZmllbGRzOwoJfQoKCV9mcm9tREJPYmplY3QociA9IHt9KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMuX19pbXBvcnQociwgewoJCQkJSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSwKCgkJCQl0eXBlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnR5cGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU51bGw6IHRydWUsCgoJCQl0eXBlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LlRvb2xfVHlwZShudWxsLCB0aGlzLlRvb2wpLl90b1NlbGVjdEhlYWRlcigpLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy50eXBlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy50eXBlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJfQoKCQlzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7CgoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCk7CgoJCXNxbCArPSBgIHdoZXJlIDE9MWA7CgoJCXNxbCA9IHRoaXMuX19leHBvcnQoewoJCQlzcWw6IHNxbAoJCX0sIHsKCQkJX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSA/IFsnSWQnXSA6IHVuZGVmaW5lZCwKCQkJTnVsbDogdHJ1ZSwKCQkJX1RISVM6IG9iaiA9PiB7CgkJCQlpZiAoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKHQuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOwoJCQl9LAoJCQlJZDogb2JqID0+IG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwKCgkJCXR5cGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl90eXBlX3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fdHlwZV9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jb2RlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fY29kZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX29yZGVyX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fb3JkZXJfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fZGF0ZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi50b0lTT1N0cmluZykgewoJCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbGl0ZScpIHsKCQkJCQkJb2JqLnNxbCArPSAic3RyZnRpbWUoJyVzJywgJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJykiOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9iai5zcWwgKz0gIiciICsgdi50b0lTT1N0cmluZygpICsgIiciOwoJCQkJCX0KCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9uYW1lX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9yZW1hcmtfc2V0KSByZXR1cm47CgoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXRvb2xfQ29uZmlnczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Rvb2xfVG9vbHMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3Rvb2xfQ29uZmlnc19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoInRvb2wuaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX3Rvb2xfQ29uZmlnc19jb29wID09ICchPScgfHwgdGhpcy5fdG9vbF9Db25maWdzX2Nvb3AgPT0gJ05PVCBJTicpIHsKCQkJCQlpbk9QID0gJ05PVCBJTic7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX3Rvb2xfQ29uZmlnc19jb29wID09ICc9JyB8fCB0aGlzLl90b29sX0NvbmZpZ3NfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl90b29sX0NvbmZpZ3NfY29vcCA9PSAnPT0nKSB7CgkJCQkJak9QID0gJ0lOVEVSU0VDVCc7CgkJCQl9CgoJCQkJb2JqLnNxbCArPSBgYW5kIC8qdG9vbF9Db25maWdzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQkJdG9vbF9NYXBwaW5nczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Rvb2xfVG9vbHMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3Rvb2xfTWFwcGluZ3Nfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJ0b29sLmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl90b29sX01hcHBpbmdzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl90b29sX01hcHBpbmdzX2Nvb3AgPT0gJ05PVCBJTicpIHsKCQkJCQlpbk9QID0gJ05PVCBJTic7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX3Rvb2xfTWFwcGluZ3NfY29vcCA9PSAnPScgfHwgdGhpcy5fdG9vbF9NYXBwaW5nc19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX3Rvb2xfTWFwcGluZ3NfY29vcCA9PSAnPT0nKSB7CgkJCQkJak9QID0gJ0lOVEVSU0VDVCc7CgkJCQl9CgoJCQkJb2JqLnNxbCArPSBgYW5kIC8qdG9vbF9NYXBwaW5ncyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJfSwgIl90b1NlbGVjdFNRTCIsIGZpZWxkcykuc3FsOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCWlmIChPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMudHlwZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy50eXBlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jb2RlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMub3JkZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZGF0ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5uYW1lfWA7CgoJCX0KCgkJaWYgKHNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpIHsKCQkJLy8gc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSIsICJ3aGVyZSAxPTAiKTsKCQl9IGVsc2UgewoJCQlzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7CgkJfQoKCQlzcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCkgOiBzcWw7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgoJCXJldHVybiBzcWw7Cgl9CgoJX3RvUGF0aHMoKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJX1RISVM6IG9iaiA9PiB7fSwKCgkJCXR5cGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSkgPT4gb2JqLnR5cGUgPSB2Ll90b1BhdGhzKCksCgoJCQl0b29sX0NvbmZpZ3M6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0b29sX1Rvb2xzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnRvb2xfQ29uZmlncyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQkJdG9vbF9NYXBwaW5nczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Rvb2xfVG9vbHMnLCB1bmRlZmluZWQpKSA9PiBvYmoudG9vbF9NYXBwaW5ncyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQl9LCAiX3RvUGF0aHMiKTsKCQkvLyByZXR1cm4gcmV0OwoJCXJldHVybiBPYmplY3Qua2V5cyhyZXQpLm1hcChrID0+ICh7CgkJCVtrXTogcmV0W2tdCgkJfSkpOwoJfQoKCV90b1VwZGF0ZVNRTChmaWVsZHMpIHsKCQlsZXQgcmV0RmllbGRzID0gdGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkuam9pbignLCAnKTsKCQlsZXQgc3FsID0gYHVwZGF0ZSAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IHNldCBgICsgT2JqZWN0LmVudHJpZXModGhpcy5fdG9EQk9iamVjdChmaWVsZHMpKS5tYXAodiA9PiB0aGlzLl9RKCkgKyB2WzBdICsgdGhpcy5fUSgpICsgIj0iICsgdlsxXSkgKyBgIHdoZXJlICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2A7IC8vYCByZXR1cm5pbmcgJHtyZXRGaWVsZHN9YDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9VcGRhdGVTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV90b0luc2VydFNRTChmaWVsZHMpIHsKCQlsZXQgb2JqID0gdGhpcy5fdG9EQk9iamVjdChmaWVsZHMpOwoJCWxldCBzcWwgPSBgaW5zZXJ0IGludG8gJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoYCArIE9iamVjdC5rZXlzKG9iaikubWFwKGsgPT4gdGhpcy5fUSgpICsgayArIHRoaXMuX1EoKSkgKyAiKSB2YWx1ZXMgKCIgKyBPYmplY3QudmFsdWVzKG9iaikgKyBgKWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvSW5zZXJ0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlRvb2wpIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuVG9vbCA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCBzcWwgPSBuZXcgc2FsZXNub3cuVG9vbCgpCgoJCQkJCS50eXBlKG5ldyBzYWxlc25vdy5Ub29sX1R5cGUoKSkKCgkJCQkJLnRvb2xfQ29uZmlncyhuZXcgc2FsZXNub3cuQ29uZmlnKCkpCgoJCQkJCS50b29sX01hcHBpbmdzKG5ldyBzYWxlc25vdy5NYXBwaW5nKCkpCgoJCQkJCS5fdG9TUUxUYWJsZShkZXB0aCk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiVG9vbCIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQl0eXBlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai50eXBlID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS50eXBlKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3R5cGVfc2V0ICYmICFxdWVyeS5fdHlwZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudHlwZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl90eXBlX3NldCAmJiBxdWVyeS5fdHlwZV9zZXQpIHx8CgoJCQkJCQkodGhpcy50eXBlKCkgJiYgIXRoaXMudHlwZSgpLl9tYXRjaGVzKHF1ZXJ5LnR5cGUoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnR5cGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCXRvb2xfQ29uZmlnczogKG9iaiwgdikgPT4gewoJCQkJCW9iai50b29sX0NvbmZpZ3MgPSB2Lm1hcChfdiA9PiBxdWVyeS50b29sX0NvbmZpZ3MoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCQl0b29sX01hcHBpbmdzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnRvb2xfTWFwcGluZ3MgPSB2Lm1hcChfdiA9PiBxdWVyeS50b29sX01hcHBpbmdzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoZXMiKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDAsIG9NYXRjaCk7CgoJCQlyZXR1cm4gT2JqZWN0LmtleXMob01hdGNoKS5ldmVyeShrID0+IG9NYXRjaFtrXSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfbWF0Y2hpbmcocXVlcnkpIHsKCQl0cnkgewoJCQlsZXQgcmV0ID0gW107CgoJCQlsZXQgbWF0Y2hlcyA9IHRoaXMuX19leHBvcnQoe30sIHsKCgkJCQl0eXBlOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgdHlwZSIpOwoJCQkJCW9iai50eXBlID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJdG9vbF9Db25maWdzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnRvb2xfQ29uZmlncyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQkJdG9vbF9NYXBwaW5nczogKG9iaiwgdikgPT4gewoJCQkJCW9iai50b29sX01hcHBpbmdzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hpbmciKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAibWF0Y2hlcyIsIG1hdGNoZXMpOwoKCQkJcmV0ID0gWy4uLm5ldyBTZXQoT2JqZWN0LmtleXMobWF0Y2hlcykubWFwKGsgPT4gbWF0Y2hlc1trXSkuZmxhdCgpKV0uZmlsdGVyKG0gPT4gbSAhPSBxdWVyeSk7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgInJldCIsIHJldCk7CgkJCXJldHVybiByZXQ7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2RlUmVmZXJlbmNlKHJvb3QpIHsKCQl0cnkgewoJCQlpZiAoIXJvb3QpIHJvb3QgPSB0aGlzOwoKCQkJbGV0IGlzUXVlcnkgPSB0cnVlCgoJCQkJJiYKCQkJCSh0aGlzLl90eXBlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJdHlwZTogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLnR5cGUocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCXRvb2xfQ29uZmlnczogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLnRvb2xfQ29uZmlncygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQl0b29sX01hcHBpbmdzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMudG9vbF9NYXBwaW5ncygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV07CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJdHlwZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpIDogInR5cGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fdHlwZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy50eXBlKCkgfHwgbmV3IHNhbGVzbm93LlRvb2xfVHlwZSgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMudHlwZShvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIHR5cGUiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvZGUocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kYXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoJCQkJCWlmICh0eXBlb2YobW9tZW50KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZWYgPSBuZXcgRGF0ZShyZWYpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmVmID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpKTsKCQkJCX0KCQkJCXRoaXMuZGF0ZShyZWYpOwoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm5hbWUocmVmKTsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZW1hcmtfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnJlbWFyayhyZWYpOwoKCQkJfSwKCgkJCXRvb2xfQ29uZmlnczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3Rvb2xfVG9vbHMnLCB1bmRlZmluZWQpIDogInRvb2xfQ29uZmlncyIpKSA9PiB0aGlzLnRvb2xfQ29uZmlncyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuQ29uZmlnKCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCQl0b29sX01hcHBpbmdzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndG9vbF9Ub29scycsIHVuZGVmaW5lZCkgOiAidG9vbF9NYXBwaW5ncyIpKSA9PiB0aGlzLnRvb2xfTWFwcGluZ3Mob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93Lk1hcHBpbmcoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSA9IHYsCgoJCQkidHlwZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSA6ICJ0eXBlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fdHlwZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fdHlwZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQkJdG9vbF9Db25maWdzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndG9vbF9Ub29scycsIHVuZGVmaW5lZCkgOiAidG9vbF9Db25maWdzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX3Rvb2xfQ29uZmlnc19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fdG9vbF9Db25maWdzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQl0b29sX01hcHBpbmdzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndG9vbF9Ub29scycsIHVuZGVmaW5lZCkgOiAidG9vbF9NYXBwaW5ncyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl90b29sX01hcHBpbmdzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl90b29sX01hcHBpbmdzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2ZsaXAoKSAqLwoJX2ZsaXAoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9mbGlwKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fZmxpcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCglieVRvb2xfVHlwZShhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfdHlwZSJdICYmIChhWyJfdHlwZSJdLkVxdWFscyA/IGFbIl90eXBlIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl90eXBlIl0sIHIpKSkgewoJCQkJCXIuX3R5cGVfVG9vbHMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuX25hbWU7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IHRydWU7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ub29sLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5Ub29sKG51bGwsIHRoaXMuVG9vbCk7CgoJCQkJbGV0IGJGaW5kID0gZmFsc2U7CgkJCQlpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLklkID0gdGhpcy5JZDsKCQkJCX0KCgkJCQlpZiAoCgkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCX0KCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KShzYWxlc25vdykKCQkJCSkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5uYW1lKHRoaXMubmFtZSgpLCAnPScpOwoJCQkJfQoKCQkJCWlmIChiRmluZCkgewoJCQkJCV90aGlzID0gYXdhaXQgX3RoaXMuZmluZCgpOwoJCQkJfSBlbHNlIF90aGlzID0gbnVsbDsKCQkJCWlmIChfdGhpcykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfdGhpcy5JZCIsIF90aGlzLklkLCBfdGhpcy5Ub29sLm5hbWUsIHRoaXMuVG9vbC5uYW1lKTsKCQkJCQl0aGlzLklkID0gX3RoaXMuSWQ7CgkJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCQl9IGVsc2UgewoJCQkJCXRoaXMuSWQgPSB0aGlzLklkOyAvLyB0byBlbmZvcmNlIHRoZSBJZCBhbmQgbm90IGdldCBhIG5ldyBvbmUgZXZlcnkgdGltZQoJCQkJCWJJbnNlcnQgPSB0cnVlOwoJCQkJfQoJCQl9IGVsc2UgaWYgKE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSA8IHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJBbHJlYWR5IHN0b3JlZCIsIE1hdGguYWJzKCh0aGlzLlNldF9Pbi5nZXRUaW1lKCkgLSB0aGlzLl9fc3luY19vbigpLmdldFRpbWUoKSkgLyAxMDAwKSArICI8IiArIHRoaXMuX19jb25maWcoJ3N0b3JlLnNlbnNpdGl2aXR5JywgNSkpOwoJCQl9IGVsc2UgewoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiR29pbmcgdG8gdXBkYXRlIFsiICsgdGhpcy5JZCArICJdIik7CgkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJfQoKCQkJaWYgKCFiVXBkYXRlICYmICFiSW5zZXJ0KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiTm8gZGF0YSBjaGFuZ2VzIik7CgkJCX0gZWxzZSB7CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24pID09PSAidW5kZWZpbmVkIiB8fCBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nQkVHSU4nOidTVEFSVCd9IFRSQU5TQUNUSU9OYCk7CgkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gPSB7CgkJCQkJCQlPd25lcjogdGhpcywKCQkJCQkJCXNxbHM6IFtdLAoJCQkJCQkJc3RhcnQ6IG5ldyBEYXRlKCksCgkJCQkJCQllbmQ6IG51bGwKCQkJCQkJfTsKCQkJCQl9CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSB7CgkJCQkJdGhpcy5hY3RpdmUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSB7CgkJCQkJdGhpcy5lbmFibGVkKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgewoJCQkJCXRoaXMuZGF0ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSBuZXcgRGF0ZSgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl90eXBlX3NldCAmJiB0aGlzLnR5cGUoKSAmJiAhKGF3YWl0IHRoaXMudHlwZSgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX3R5cGUoKTsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBGaW5pc2hlZCBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0gSWQ9WyR7dGhpcy5JZH1dYCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fdG9vbF9Db25maWdzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMudG9vbF9Db25maWdzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICh0aGlzLl90b29sX01hcHBpbmdzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMudG9vbF9NYXBwaW5ncygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBpbnNlcnQoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ub29sLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl0aGlzLl9mcm9tRG9jdW1lbnQoYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlsZXQgb2JqID0ge307CgoJCQkJaWYgKHRoaXMuX3R5cGVfc2V0KSB7CgoJCQkJCW9iai50eXBlID0gdGhpcy5fdHlwZS5JZDsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9zZXQpIHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9lbmFibGVkX3NldCkgewoKCQkJCQlvYmouZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fY29kZV9zZXQpIHsKCgkJCQkJb2JqLmNvZGUgPSB0aGlzLmNvZGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX29yZGVyX3NldCkgewoKCQkJCQlvYmoub3JkZXIgPSB0aGlzLm9yZGVyKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9kYXRlX3NldCkgewoKCQkJCQlvYmouZGF0ZSA9IHRoaXMuZGF0ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fbmFtZV9zZXQpIHsKCgkJCQkJb2JqLm5hbWUgPSB0aGlzLm5hbWUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX3JlbWFya19zZXQpIHsKCgkJCQkJb2JqLnJlbWFyayA9IHRoaXMucmVtYXJrKCk7CgoJCQkJfQoKCQkJCWxvZygiU2VuZGluZyB0byBTRiIsIG9iaik7CgoJCQkJbGV0IHJlcyA9IGF3YWl0IHRoaXMuVG9vbC5kYi5zb2JqZWN0KCJUb29sIikuY3JlYXRlKG9iaik7CgkJCQl0aGlzLklkID0gcmVzLmlkOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuVG9vbC51cGRhdGUnKTsKCgkJCWxldCByZXQgPSBudWxsOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1VwZGF0ZVNRTCgpKTsKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTCgpKTsKCQkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHJldCA9IHJldFswXTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZScsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChyZXQsIHRydWUpOwoKCQkJcmV0dXJuIHJldDsKCgkJCS8qKiogRU5EIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBmaW5kQWxsKGRlcHRoID0gMSwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZmluZEFsbCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgX25vZGUsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LlRvb2wuZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCB7CgkJCQkJc3lzcGFybV9xdWVyeTogT2JqZWN0LmVudHJpZXModGhpcy5fdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykpLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKQoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIHRydWUpLCBudWxsLCB7CgkJCQkJdXJsOiAncmVzdC51cmwuZ3FsJwoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCk7CgkJCQlyZXQgPSByZXQuY29udGVudCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5Ub29sKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuVG9vbF9UeXBlID0gY2xhc3MgVG9vbF9UeXBlIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUXNLaTVmY21WemRDd3FMbDlzYjJGa1ZHOXZiSE1pZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKT2IyUmxJanA3SW01dlJHVjBaV04wSWpwMGNuVmxMQ0pwYm1sMExtVnVaSE1pT2pJc0ltbHVhWFF1Ykc5dmNDSTZNQzQxTENKMGIyOXNjeTV6ZEc5eVpTSTZabUZzYzJVc0ltUmxkR1ZqZEZCaGNtVnVkQzVKVUNJNklqRTRNaTR4TmpndU56QXVPRElpTENKa1pYUmxZM1JRWVhKbGJuUXVZMjlrWlNJNkltVTRaR1V3Tm1VelpXUmpORFF6WVdVNVpHWmxNV1JsTldWak5USmhOR0ptSWl3aWMyVmpjbVYwSWpvaWIxTkxkMmRhTW5OTFJrOVVTVXBqWWtGbVZVbFJORU5xT1hGelNEUTRibXdpTENKd2JHRjVaM0p2ZFc1a0lqcDBjblZsTENKblVsQkRJanAwY25WbExDSnpkRzl5WlM1elpXNXphWFJwZG1sMGVTSTZNU3dpWTI5dGNHRnVlU0k2SW5KbGMzVnRaU0o5TENKRmRtVnVkQ0k2ZXlKMGNtbG5aMlZ5TG5ScGJXVnZkWFFpT2pFd01EQXdMQ0p6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMHNJbFJ2YjJ3aU9uc2laMmwwYUhWaUxuUnZiMnh6SWpvaWFIUjBjSE02THk5eVlYY3VaMmwwYUhWaWRYTmxjbU52Ym5SbGJuUXVZMjl0TDJaaFpHbHVMMlpoWkdsdUxtZHBkR2gxWWk1cGJ5OXRZWE4wWlhJdklpd2ljMlZqY21WMElqb2liMU5MZDJkYU1uTkxSazlVU1VwallrRm1WVWxSTkVOcU9YRnpTRFE0Ym13aUxDSndiR0Y1WjNKdmRXNWtJanAwY25WbExDSm5VbEJESWpwMGNuVmxMQ0p6ZEc5eVpTNXpaVzV6YVhScGRtbDBlU0k2TVN3aVkyOXRjR0Z1ZVNJNkluSmxjM1Z0WlNKOUxDSnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc2V5SnVZVzFsSWpvaVUwNVBWMDlQUWlJc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaWZYMHNJbE5oYkdWelJtOXlZMlVpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgkJdGhpcy5jbGVhcl90eXBlX0NvbmZpZ3MoKTsKCgkJdGhpcy5jbGVhcl90eXBlX1Rvb2xzKCk7CgoJCXRoaXMuY2xlYXJfdHlwZV9NYXBwaW5ncygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIlRvb2wgVHlwZSIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJLy8gKHRoaXMudHlwZV9Db25maWdzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJLy8gKHRoaXMudHlwZV9Ub29scygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCS8vICh0aGlzLnR5cGVfTWFwcGluZ3MoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglUSElTKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9USElTOwoJCWlmICghdikgcmV0dXJuIHRoaXM7CgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoJCXRoaXMuX1RISVMgPSB2LmZpbHRlcihfdiA9PiB0eXBlb2YoX3YpID09PSAnb2JqZWN0JyAmJiBfdi5FbnRpdHlDbGFzcyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lID09IHRoaXMuRW50aXR5Q2xhc3MuTmFtZSAmJiBfdi5TY29wZSA9PSB0aGlzLlNjb3BlKTsKCQlpZiAoY28pIHRoaXMuX1RISVNfY29vcCA9IGNvOwoJCXJldHVybiB0aGlzOwoJfQoKCWNsZWFyX1RISVMoKSB7CgkJdGhpcy5fVEhJUyA9IFtdOwoJCXRoaXMuX1RISVNfY29vcCA9ICcnOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdHlwZV9Db25maWdzICoqLwoJdHlwZV9Db25maWdzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl90eXBlX0NvbmZpZ3M7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzg0NmJmMzc1LTdhZDEtNGRlYy04YTRlLWRmYzViZTViMzBhYicgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnQ29uZmlnJykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll90eXBlX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3R5cGVfQ29uZmlncycsICdFbnRpdHlPYmplY3QnLCAxLCAidHlwZSBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiQ29uZmlnIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndHlwZV9Db25maWdzJywgJ0VudGl0eU9iamVjdCcsIDEsICJ0eXBlIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiQ29uZmlnIik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LnR5cGUodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fdHlwZV9Db25maWdzLnB1c2goLi4udik7CgkJdGhpcy5fdHlwZV9Db25maWdzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl90eXBlX0NvbmZpZ3NfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX3R5cGVfQ29uZmlncygpIHsKCQl0aGlzLl90eXBlX0NvbmZpZ3Nfc2V0ID0gbnVsbDsKCQl0aGlzLl90eXBlX0NvbmZpZ3MgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl90eXBlX0NvbmZpZ3NfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0eXBlX0NvbmZpZ3MgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0eXBlX1Rvb2xzICoqLwoJdHlwZV9Ub29scyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fdHlwZV9Ub29sczsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnNzM5YmM4NWEtOGQwZC00MmQyLTk1ZDctMmY4NDc1ODU2YTg5JyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdUb29sJykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll90eXBlX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3R5cGVfVG9vbHMnLCAnRW50aXR5T2JqZWN0JywgMSwgInR5cGUgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIlRvb2wiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0eXBlX1Rvb2xzJywgJ0VudGl0eU9iamVjdCcsIDEsICJ0eXBlIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiVG9vbCIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi50eXBlKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX3R5cGVfVG9vbHMucHVzaCguLi52KTsKCQl0aGlzLl90eXBlX1Rvb2xzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl90eXBlX1Rvb2xzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl90eXBlX1Rvb2xzKCkgewoJCXRoaXMuX3R5cGVfVG9vbHNfc2V0ID0gbnVsbDsKCQl0aGlzLl90eXBlX1Rvb2xzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fdHlwZV9Ub29sc19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHR5cGVfVG9vbHMgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0eXBlX01hcHBpbmdzICoqLwoJdHlwZV9NYXBwaW5ncyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fdHlwZV9NYXBwaW5nczsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnOWFiYTU4ODMtYjY2Yi00Nzk0LTg5N2QtM2ZkODU5NGZhMDEyJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdNYXBwaW5nJykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll90eXBlX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3R5cGVfTWFwcGluZ3MnLCAnRW50aXR5T2JqZWN0JywgMSwgInR5cGUgaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIk1hcHBpbmciKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0eXBlX01hcHBpbmdzJywgJ0VudGl0eU9iamVjdCcsIDEsICJ0eXBlIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiTWFwcGluZyIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi50eXBlKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX3R5cGVfTWFwcGluZ3MucHVzaCguLi52KTsKCQl0aGlzLl90eXBlX01hcHBpbmdzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl90eXBlX01hcHBpbmdzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl90eXBlX01hcHBpbmdzKCkgewoJCXRoaXMuX3R5cGVfTWFwcGluZ3Nfc2V0ID0gbnVsbDsKCQl0aGlzLl90eXBlX01hcHBpbmdzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fdHlwZV9NYXBwaW5nc19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHR5cGVfTWFwcGluZ3MgKiovCgoJZ2V0IFNldF9PbigpIHsKCQlsZXQgcmV0ID0gbmV3IERhdGUoTWF0aC5tYXgoCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fdHlwZV9Db25maWdzX3NldCwKCgkJCXRoaXMuX3R5cGVfVG9vbHNfc2V0LAoKCQkJdGhpcy5fdHlwZV9NYXBwaW5nc19zZXQsCgoJCSkpOwoKCQlpZiAoIXJldCB8fCAhKHJldCBpbnN0YW5jZW9mIERhdGUgJiYgIWlzTmFOKHJldCkpKSByZXR1cm4gdW5kZWZpbmVkOwoJCXJldHVybiByZXQ7Cgl9CgoJX2ZsYXR0ZW4oZGVwdGgpIHsKCQlsZXQgcmV0ID0ge307CgkJaWYgKCFkZXB0aCkgcmV0dXJuIHJldDsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0LnR5cGVfQ29uZmlncyA9IHRoaXMudHlwZV9Db25maWdzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXQudHlwZV9Ub29scyA9IHRoaXMudHlwZV9Ub29scygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0LnR5cGVfTWFwcGluZ3MgPSB0aGlzLnR5cGVfTWFwcGluZ3MoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCXR5cGVfQ29uZmlnczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGVfVG9vbF9UeXBlcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCXR5cGVfVG9vbHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlX1Rvb2xfVHlwZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQl0eXBlX01hcHBpbmdzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZV9Ub29sX1R5cGVzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX3RvSGFzaCIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMuTm9Db2RlID8gb0hhc2ggOiB0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7Cgl9CgoJYXN5bmMgX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOwoKCX0KCglfcWxTZWxlY3Rpb25zKHNTZXQpIHsKCQlsZXQgcmV0ID0gW107CgkJaWYgKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7CgoJCXNTZXQuc2VsZWN0aW9ucy5maWx0ZXIocyA9PiBzLnNlbGVjdGlvblNldCkuZm9yRWFjaChzID0+IHsKCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpICE9ICdUb29sX1R5cGUnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiRGVsZWdhdGluZyBpbnZva2F0aW9uIHRvICIgKyBldmVudC5jbGFzc05hbWUoKSk7CgkJCQlyZXR1cm4gbmV3IHNhbGVzbm93W2V2ZW50LmNsYXNzTmFtZSgpXSgpLl9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpOwoJCQl9CgoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQlkYXRhLl9fdGhpcyA9IGRhdGEuX190aGlzIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkJc3dpdGNoIChtZXRob2QpIHsKCgkJCX0KCQl9CgoJCWlmICghbiB8fCBzYWxlc25vdy5fbm9kZS5fc2FtZU5vZGUobikpIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkNhbGxiYWNrIik7CgkJCXJldCA9IGF3YWl0IHRoaXMuX2ludm9rZShtZXRob2QsIGRhdGEpOwoJCX0gZWxzZSBpZiAobi5hZGRyZXNzKCkgJiYgbi5fc2FtZU5vZGUobikgLyphY3R1YWwgbm9kZSovICkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBuLl9hZGRyZXNzLCBuLl9wb3J0LCBtZXRob2QpOwoJCQl0cnkgewoJCQkJbGV0IGNvbmZpZyA9IHsKCQkJCQloZWFkZXJzOiB7fSwKCQkJCX07CgkJCQlpZiAoc2FsZXNub3cuX190b2tlbikgY29uZmlnLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGAke3NhbGVzbm93Ll9fdG9rZW4udG9rZW5fdHlwZX0gJHtzYWxlc25vdy5fX3Rva2VuLmFjY2Vzc190b2tlbn1gOwoJCQkJcmV0ID0gYXdhaXQgYXhpb3MucG9zdChgaHR0cCR7bi5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHtuLmFkZHJlc3MoKX06JHtuLnBvcnQoKSB8fCAzMDAwfS9tZXRob2QvVG9vbF9UeXBlLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7CgoJCQl9CgoJCQkvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8KCgkJCWxldCB2ID0gdW5kZWZpbmVkOwoJCQl0cnkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke21ldGhvZH1gKTsKCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQlsZXQgX2lkID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgZGF0YSwgbWV0aG9kLCB7fSk7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIHsKCQkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKGRhdGEpOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSBkYXRhLl9fdGhpcy5jb2RlIHx8IGRhdGEuaWQgfHwgZGF0YS5JRDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCQlpZiAoZGF0YS5JZCAmJiBkYXRhLklkID09IGRhdGEuSWQpIHsKCQkJCQkJX2lkID0gZGF0YS5JZDsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5FbnRpdHlDbGFzcykgewoJCQkJCQlfaWQgPSBkYXRhLkVudGl0eUNsYXNzLklkIHx8IGRhdGEuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI0NjhlNjE2MS0zZGY4LTRmZGYtYWU1MC0wZGIyOTM2ZTY1MDQiIHx8ICJOVUxMIjsKCQkJCQl9CgkJCQl9CgoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sX1R5cGVbbWV0aG9kXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlW21ldGhvZF0gfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVttZXRob2RdW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVttZXRob2RdW19pZF0gfHwge307CgoJCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKHt9LCB7CgkJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJCX0pOwoKCQkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVttZXRob2RdW19pZF1bX2hhc2hdOwoJCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiA1KSkgewoJCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gbWV0aG9kIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJCXYucmV1c2VkKys7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhKTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlW21ldGhvZF1bX2lkXVtfaGFzaF0gPSB7CgkJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoe30pLAoJCQkJCW9iajogZGF0YSwKCQkJCQlyZXVzZWQ6IDAsCgkJCQl9OwoJCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0gPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGRhdGEsIG1ldGhvZCwge30sIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBgVHJpZ2dlcnJpbmcgJHttZXRob2R9IHRvICR7bi5jb2RlKCl9ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSxudWxsLDQpfWApOwoKCQkJbGV0IGV2ID0gbmV3IHNhbGVzbm93LkV2ZW50KCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuY29kZSh0aGlzLl91dWlkKCkpLm5hbWUodGhpcy5fX2NvbmZpZygnZXZlbnQnKSB8fCAnc2FsZXNub3cuRXZlbnQnKS5kYXRlKHRoaXMuc2VydmVyRGF0ZSgpKS5yZWNpcGllbnQobikubWV0aG9kKG1ldGhvZCkuY2xhc3NOYW1lKCdUb29sX1R5cGUnKS5zZW5kZXIoc2FsZXNub3cuX25vZGUpLmNhcnJpZXIoc2FsZXNub3cuX25vZGUpLnBheWxvYWQoZGF0YSk7CgkJCWlmIChldmVudCkgewoJCQkJaWYgKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOwoJCQkJaWYgKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOwoJCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJaWYgKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOwoJCQl9CgkJCXJldCA9IGF3YWl0IGV2LnRyaWdnZXIoKTsKCgkJCWlmICh0eXBlb2YocmV0KSA9PT0gInN0cmluZyIpIHsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCX0KCQkJcmV0dXJuIHJldDsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5Ub29sX1R5cGUobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93LlRvb2xfVHlwZShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocCkpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHt9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2UobWV0aG9kLCBib2R5LCBxdWVyeSwgYXV0aE9iaikgewoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgbWV0aG9kLCBxdWVyeSwgYm9keSk7CgoJCWlmICh0eXBlb2YoYm9keSkgPT09ICdzdHJpbmcnIHx8ICh0eXBlb2YoQnVmZmVyKSAhPT0gJ3VuZGVmaW5lZCcgJiYgQnVmZmVyLmlzQnVmZmVyKGJvZHkpKSkgewoJCQl0cnkgewoJCQkJYm9keSA9IEpTT04ucGFyc2UoYm9keS50b1N0cmluZygpKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJvZHkgaXMgbm90IGEgdmFsaWQgSlNPTiIsIGJvZHkpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoKCQlsZXQgX3BhcmFtcyA9IHF1ZXJ5ID8gT2JqZWN0LmFzc2lnbihxdWVyeSwgYm9keSkgOiBib2R5OwoJCWlmICh0eXBlb2YoX3BhcmFtcykgPT09ICdzdHJpbmcnKSBfcGFyYW1zID0gSlNPTi5wYXJzZShfcGFyYW1zKTsKCgkJaWYgKF9wYXJhbXMpIHsKCQkJX3BhcmFtcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcyk7CgkJfSBlbHNlIHsKCQkJX3BhcmFtcyA9IHt9OwoJCX0KCgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgX3BhcmFtcy5fX2ZsYXR0ZWQpIF9wYXJhbXMgPSBGbGF0dGVkLnBhcnNlKF9wYXJhbXMuX19mbGF0dGVkKTsKCgkJaWYgKF9wYXJhbXMuX19ub2RlKSB7CgkJCS8vIHByb2JhYmx5IHNob3VsZCBub3QgYmUgcHJvY2Vzc2VkIGhlcmUsIGJ1dCByYXRoZXIgY29uc3VtZWQgYXMgcGFydCBvZiB0aGUgZXhlY3V0ZSgpIGxvZ2ljLCBwdXNoaW5nIF9fbm9kZSB0byB0aGUgbGlzdCBvZiBteSBub2RlcyB0byBkZWxlZ2F0ZSB0byE/CgkJCWxldCB0biA9IG5ldyBzYWxlc25vdy5Ob2RlKCkuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fbm9kZSkuX2RlUmVmZXJlbmNlKCk7CgkJCWRlbGV0ZSBfcGFyYW1zLl9fbm9kZTsKCQkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Ub29sX1R5cGUoKS5faW52b2tlTm9kZSh0biwgbWV0aG9kLCBfcGFyYW1zKTsKCQl9CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYFRvb2xfVHlwZS5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYFRvb2xfVHlwZS5faW52b2tlOiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLAoJCQkJCSdvYmonOiBvYmoKCQkJCX0KCQkJfTsKCQl9IGVsc2UgewoJCQlyZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOwoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJaWYgKGZhbHNlICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQlyZXQgPSB7CgkJCQkJX19leGNlcHRpb246IHsKCQkJCQkJJy00JzogIlVuY29tbWl0dGVkIHRyYW5zYWN0aW9uczogIiArIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uc3Fscy5sZW5ndGgsCgkJCQkJCSdvYmonOiBvYmoKCQkJCQl9CgkJCQl9CgkJCX0KCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQl9CgoJCWlmIChyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbikgewoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0ge307CgkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCXJldCA9IHJldC5tYXAociA9PiB7CgkJCQkJaWYgKHIgJiYgci5fdG9Eb2N1bWVudCkgewoJCQkJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sX1R5cGUuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuVG9vbF9UeXBlLicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJX3BhcnNlQ29kZVN0YXRlKHQpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3BhcnNlQ29kZVN0YXRlKHQpOwoKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIlRvb2wgVHlwZSIpOwoKCX0KCglfcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCA9ICd7eycsIHBvc3RmaXggPSAnfX0nKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4LCBwb3N0Zml4KTsKCgl9CgoJX19zeW5jX29uKGQpIHsKCQl0aGlzLl9fX3N5bmNfb24gPSB0aGlzLl9fX3N5bmNfb24gfHwge307CgoJCWlmIChkKSB7CgkJCXRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV0gPSBkOwoKCQkJLy8gdGhpcy50eXBlX1Rvb2xfVHlwZXMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJLy8gdGhpcy50eXBlX1Rvb2xfVHlwZXMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJLy8gdGhpcy50eXBlX1Rvb2xfVHlwZXMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlyZXR1cm4gdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXTsKCX0KCglfY2xvbmUoKSB7CgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Ub29sX1R5cGUodGhpcy5JZCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkudHlwZV9Db25maWdzKHRoaXMudHlwZV9Db25maWdzKCksIHRoaXMuX3R5cGVfQ29uZmlnc19jb29wKQoKCQkJLnR5cGVfVG9vbHModGhpcy50eXBlX1Rvb2xzKCksIHRoaXMuX3R5cGVfVG9vbHNfY29vcCkKCgkJCS50eXBlX01hcHBpbmdzKHRoaXMudHlwZV9NYXBwaW5ncygpLCB0aGlzLl90eXBlX01hcHBpbmdzX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJLy9vYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJLy9vYmpUbyA9IG9ialRvIHx8IHt9OwoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAnVG9vbF9UeXBlJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgkJY29kZVR5cGUgPSBjb2RlVHlwZSB8fCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBlMzA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSlbY29kZV07CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIlRvb2xfVHlwZSI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMgPSB7fSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX2NvbmZpZyhuLCBudWxsVmFsdWUsIE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMgfHwge30sIHsKCQkJX2NsYXNzOiAnVG9vbF9UeXBlJwoJCX0pKTsKCgl9CgoJYXN5bmMgX3Jlc3QodE5hbWUgPSB0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyA9IHt9KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcih1bmRlZmluZWQsIHRoaXMuVG9vbCkuX3Jlc3QodGhpcy5fbkNvZGUoKSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMpOwoKCX0KCglfdG9TUUxUYWJsZSgpIHsKCQlsZXQgcmV0ID0gewoJCQlzcWw6IGBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9ICgKICAgICAgICAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICBgCgkJfTsKCQlyZXQuc3FsICs9ICcvKlRvb2xfVHlwZSovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQl0eXBlX0NvbmZpZ3M6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlX1Rvb2xfVHlwZXMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQkJdHlwZV9Ub29sczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGVfVG9vbF9UeXBlcycsIHVuZGVmaW5lZCkpID0+IG9iai5zcWwgPSB2Lm1hcChfdiA9PiBfdi5fdG9TUUxUYWJsZSgpKSArIG9iai5zcWwsCgoJCQl0eXBlX01hcHBpbmdzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZV9Ub29sX1R5cGVzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJfSwgIl90b1NRTFRhYmxlIik7CgoJCS8vIHJldC5zcWwgKz0gJy8qVG9vbF9UeXBlKi8pO1xuJzsKCgkJcmV0LnNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQocmV0LnNxbCkgOiByZXQuc3FsOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TUUxUYWJsZScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQuc3FsKTsKCQlyZXR1cm4gcmV0LnNxbDsKCX0KCglfZnJvbVNRTFRhYmxlKHRhYmxlLCBmaWVsZHMpIHsKCQkvLyB0YWJsZSBpcyBhIGpzb24gYXJyYXkKCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuYWN0aXZlKHRhYmxlWyJhY3RpdmUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZW5hYmxlZCh0YWJsZVsiZW5hYmxlZCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5jb2RlKHRhYmxlWyJjb2RlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5vcmRlcih0YWJsZVsib3JkZXIiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZGF0ZSh0YWJsZVsiZGF0ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5uYW1lKHRhYmxlWyJuYW1lIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucmVtYXJrKHRhYmxlWyJyZW1hcmsiXSk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBfc3FsKHNxbCwgc291cmNlID0gdGhpcykgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsKHNxbCwgdGhpcyk7CgoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgYlN0cmluZykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHsKCQkJW3RoaXMuX25Db2RlKCldOiB7CgkJCQlwYXJhbXM6IHsKCQkJCQl3aGVyZTogewoJCQkJCQlhbmQ6IFtdLAoJCQkJCQlvcjogW10KCQkJCQl9CgkJCQl9LAoJCQkJZWRnZXM6IHsKCQkJCQlub2RlOiB7fQoJCQkJfQoJCQl9CgkJfSwgewoJCQkvL09QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goewoJCQkJSWQ6IHsKCQkJCQllcTogdgoJCQkJfQoJCQl9KSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsKQoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCX0sICJfdG9TRlF1ZXJ5Iik7CgoJCS8vT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCWlmIChiU3RyaW5nKSB7CgkJCXJldCA9IHsKCQkJCXF1ZXJ5OiB7CgkJCQkJW3RoaXMuX25Db2RlKCkgKyAnUXVlcnknXTogewoJCQkJCQl1aWFwaTogcmV0CgkJCQkJfQoJCQkJfQoJCQl9OwoJCQlyZXQgPSBKU09OLnN0cmluZ2lmeShyZXQsIG51bGwsIDQpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU0ZRdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU05RdWVyeShmaWVsZHMsIG9ianMpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlPUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmouc3lzX2lkID0gdiwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlsZXQgZCA9IGAke3YuZ2V0RnVsbFllYXIoKX0tJHsoJzAnKyh2LmdldE1vbnRoKCkrMSkpLnNsaWNlKC0yKX0tJHt2LmdldERhdGUoKX1gOwoJCQkJbGV0IHQgPSBgJHt2LmdldEhvdXJzKCl9OiR7di5nZXRNaW51dGVzKCl9OiR7di5nZXRTZWNvbmRzKCl9YDsKCQkJCWlmICgodi5nZXRIb3VycygpID09IDAgJiYgdi5nZXRNaW51dGVzKCkgPT0gMCAmJiB2LmdldFNlY29uZHMoKSA9PSAwKSB8fCB0aGlzLl9kYXRlX2Nvb3AgPT0gJz0nIHx8ICF0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBPTiR7ZH1AamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdzdGFydCcpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywnZW5kJylgOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9kYXRlX2Nvb3AgIT09ICdCRVRXRUVOJykgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9IGVsc2UgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfQoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJfSwgIl90b1NOUXVlcnkiKTsKCgkJT2JqZWN0LmtleXMocmV0Lk9QRVJBVE9SUyB8fCB7fSkuZmlsdGVyKGsgPT4gdHlwZW9mKHJldFtrXSkgIT09ICd1bmRlZmluZWQnKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gcmV0Lk9QRVJBVE9SU1trXSArIHJldFtrXSk7CgoJCWRlbGV0ZSByZXQuT1BFUkFUT1JTOwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlyZXQgPSBEb3RPYmplY3QuZG90KHJldCk7CgoJCS8vIGF2b2lkIHNlbmRpbmcgd2l0aCBubyBjb21wYXJpc29uIG9wZXJhdG9ycwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVsnPicsICc8JywgJ0JFVFdFRU4nLCAnT04nLCAnIScsICc9JywgJ1NUQVJUU1dJVEgnLCAnTElLRSddLnNvbWUocyA9PiBTdHJpbmcocmV0W2tdKS5zdGFydHNXaXRoKHMpKSkuZm9yRWFjaChrID0+IHJldFtrXSA9ICh0aGlzW2BfJHtrfV9jb29wYF0gfHwgJ1NUQVJUU1dJVEgnKSArIHJldFtrXSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgT2JqZWN0LmVudHJpZXMocmV0IHx8IHt9KS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJbGV0IF9yZXQgPSBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIGZhbHNlLCBmdW4sIGVhT2JqLCBvYmopOwoJCQkJcmV0dXJuIF9yZXQ7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqLCB0aGlzLmNvZGUoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmosIHRoaXMuZGF0ZSgpKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmosIHRoaXMubmFtZSgpKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaiwgdGhpcy5yZW1hcmsoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI0NjhlNjE2MS0zZGY4LTRmZGYtYWU1MC0wZGIyOTM2ZTY1MDQiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sX1R5cGUgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sX1R5cGVbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlfb3B0aW9ucygidHlwZV9Db25maWdzIiwgb2JqLCB0aGlzLnR5cGVfQ29uZmlncygpKTsKCgkJX29wdGlvbnMoInR5cGVfVG9vbHMiLCBvYmosIHRoaXMudHlwZV9Ub29scygpKTsKCgkJX29wdGlvbnMoInR5cGVfTWFwcGluZ3MiLCBvYmosIHRoaXMudHlwZV9NYXBwaW5ncygpKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3R5cGVfQ29uZmlncycsICd0eXBlX1Rvb2xzJywgJ3R5cGVfTWFwcGluZ3MnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIHRydWUsIGZ1biwgb2JqLCBvYmopOwoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI0NjhlNjE2MS0zZGY4LTRmZGYtYWU1MC0wZGIyOTM2ZTY1MDQiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sX1R5cGUgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuVG9vbF9UeXBlW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ub29sX1R5cGVbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLlRvb2xfVHlwZVtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJ0eXBlX0NvbmZpZ3MiLCBvYmopOwoKCQlfb3B0aW9ucygidHlwZV9Ub29scyIsIG9iaik7CgoJCV9vcHRpb25zKCJ0eXBlX01hcHBpbmdzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3R5cGVfQ29uZmlncycsICd0eXBlX1Rvb2xzJywgJ3R5cGVfTWFwcGluZ3MnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV06ICInIiArIHRoaXMuSWQgKyAiJyIKCQl9OwoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9hY3RpdmVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYWN0aXZlKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZW5hYmxlZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5lbmFibGVkKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvZGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29kZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2RhdGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZGF0ZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5uYW1lKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3JlbWFya19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5yZW1hcmsoKTsKCgkJCWZWYWx1ZSA9ICInIiArICgodiAmJiB2LnJlcGxhY2UpID8gdi5yZXBsYWNlKC9cJy9nLCAiXCdcJyIpIDogdikgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX1EoKSB7CgkJbGV0IF9vID0gJyInOwoJCWxldCBfcSA9IF9vOwoKCQlpZiAoWydTYWxlc0ZvcmNlJ10uaW5kZXhPZih0aGlzLlRvb2wudHlwZS5uYW1lKSA9PSAwKSB7CgkJCV9vID0gX3EgPSAiIjsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgewoJCQlfbyA9IF9xID0gJ2AnOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxzZXJ2ZXInKSB7CgkJCV9vID0gJ1snOwoJCQlfcSA9ICddJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ2FwaUtleScpID09ICdhaXJ0YWJsZScpIHsKCQkJX28gPSAneyc7CgkJCV9xID0gJ30nOwoJCX0KCQl0aGlzLl9fUSA9IHRoaXMuX19RID09IF9vID8gX3EgOiBfbzsKCQlyZXR1cm4gdGhpcy5fX1E7Cgl9CgoJX2ZpZWxkR3JvdXBzKGZncyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOwoJCXJldHVybiB0aGlzOwoJfQoKCV9maWVsZEFnZ3JlZ2F0ZXMoZmFzID0ge30pIHsKCQl0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOwoJCXJldHVybiB0aGlzOwoJfQoKCV90b0ZpZWxkc1NRTChmaWVsZHMpIHsKCgkJZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKSwgdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCldOwoJCWZpZWxkcyA9IEFycmF5LmlzQXJyYXkoZmllbGRzKSA/IGZpZWxkcyA6IFtmaWVsZHNdOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCS8vIHtmaWVsZDogb3JkZXJ9CgkJCWZpZWxkcyA9IFtdOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb2RlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5kYXRlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5uYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucmVtYXJrKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlOdWxsOiB0cnVlLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29kZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcikgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmRhdGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMubmFtZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCX0KCgkJc3FsICs9IGAgZnJvbSAke3RQcmVmfSBgOwoKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gYGxlZnQgam9pbiAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX0ke3RoaXMuX1EoKX0gYXMgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0gb24gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtrfWlkJHt0aGlzLl9RKCl9PSR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGApOwoKCQlzcWwgKz0gYCB3aGVyZSAxPTFgOwoKCQlzcWwgPSB0aGlzLl9fZXhwb3J0KHsKCQkJc3FsOiBzcWwKCQl9LCB7CgkJCV9maWVsZHM6ICh0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgPyBbJ0lkJ10gOiB1bmRlZmluZWQsCgkJCU51bGw6IHRydWUsCgkJCV9USElTOiBvYmogPT4gewoJCQkJaWYgKCF0aGlzLl9USElTIHx8ICF0aGlzLl9USElTLmxlbmd0aCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9USElTX2Nvb3AgfHwgIklOIikgKyAiICgiICsgdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCh0Ll9fY29uZmlnKCdpZEZpZWxkJykgfHwgJ19faWQnKSkuam9pbignIFVOSU9OIEFMTCAnKSArICIpIjsKCQkJfSwKCQkJSWQ6IG9iaiA9PiBvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2AsCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvZGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2RhdGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVtYXJrX3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQl0eXBlX0NvbmZpZ3M6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlX1Rvb2xfVHlwZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3R5cGVfQ29uZmlnc19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoInR5cGUuaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX3R5cGVfQ29uZmlnc19jb29wID09ICchPScgfHwgdGhpcy5fdHlwZV9Db25maWdzX2Nvb3AgPT0gJ05PVCBJTicpIHsKCQkJCQlpbk9QID0gJ05PVCBJTic7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX3R5cGVfQ29uZmlnc19jb29wID09ICc9JyB8fCB0aGlzLl90eXBlX0NvbmZpZ3NfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl90eXBlX0NvbmZpZ3NfY29vcCA9PSAnPT0nKSB7CgkJCQkJak9QID0gJ0lOVEVSU0VDVCc7CgkJCQl9CgoJCQkJb2JqLnNxbCArPSBgYW5kIC8qdHlwZV9Db25maWdzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQkJdHlwZV9Ub29sczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGVfVG9vbF9UeXBlcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fdHlwZV9Ub29sc19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoInR5cGUuaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX3R5cGVfVG9vbHNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX3R5cGVfVG9vbHNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fdHlwZV9Ub29sc19jb29wID09ICc9JyB8fCB0aGlzLl90eXBlX1Rvb2xzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fdHlwZV9Ub29sc19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLyp0eXBlX1Rvb2xzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQkJdHlwZV9NYXBwaW5nczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGVfVG9vbF9UeXBlcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fdHlwZV9NYXBwaW5nc19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoInR5cGUuaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX3R5cGVfTWFwcGluZ3NfY29vcCA9PSAnIT0nIHx8IHRoaXMuX3R5cGVfTWFwcGluZ3NfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fdHlwZV9NYXBwaW5nc19jb29wID09ICc9JyB8fCB0aGlzLl90eXBlX01hcHBpbmdzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fdHlwZV9NYXBwaW5nc19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLyp0eXBlX01hcHBpbmdzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQl9LCAiX3RvU2VsZWN0U1FMIiwgZmllbGRzKS5zcWw7CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJaWYgKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWR9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuY29kZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMubmFtZX1gOwoKCQl9CgoJCWlmIChzcWwuZW5kc1dpdGgoIndoZXJlIDE9MSIpKSB7CgkJCS8vIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEiLCAid2hlcmUgMT0wIik7CgkJfSBlbHNlIHsKCQkJc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSBhbmQgIiwgIndoZXJlICIpOwoJCX0KCgkJc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpIDogc3FsOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoKCQlyZXR1cm4gc3FsOwoJfQoKCV90b1BhdGhzKCkgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCV9USElTOiBvYmogPT4ge30sCgoJCQl0eXBlX0NvbmZpZ3M6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlX1Rvb2xfVHlwZXMnLCB1bmRlZmluZWQpKSA9PiBvYmoudHlwZV9Db25maWdzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCQl0eXBlX1Rvb2xzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZV9Ub29sX1R5cGVzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnR5cGVfVG9vbHMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJCXR5cGVfTWFwcGluZ3M6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlX1Rvb2xfVHlwZXMnLCB1bmRlZmluZWQpKSA9PiBvYmoudHlwZV9NYXBwaW5ncyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQl9LCAiX3RvUGF0aHMiKTsKCQkvLyByZXR1cm4gcmV0OwoJCXJldHVybiBPYmplY3Qua2V5cyhyZXQpLm1hcChrID0+ICh7CgkJCVtrXTogcmV0W2tdCgkJfSkpOwoJfQoKCV90b1VwZGF0ZVNRTChmaWVsZHMpIHsKCQlsZXQgcmV0RmllbGRzID0gdGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkuam9pbignLCAnKTsKCQlsZXQgc3FsID0gYHVwZGF0ZSAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IHNldCBgICsgT2JqZWN0LmVudHJpZXModGhpcy5fdG9EQk9iamVjdChmaWVsZHMpKS5tYXAodiA9PiB0aGlzLl9RKCkgKyB2WzBdICsgdGhpcy5fUSgpICsgIj0iICsgdlsxXSkgKyBgIHdoZXJlICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2A7IC8vYCByZXR1cm5pbmcgJHtyZXRGaWVsZHN9YDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9VcGRhdGVTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV90b0luc2VydFNRTChmaWVsZHMpIHsKCQlsZXQgb2JqID0gdGhpcy5fdG9EQk9iamVjdChmaWVsZHMpOwoJCWxldCBzcWwgPSBgaW5zZXJ0IGludG8gJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoYCArIE9iamVjdC5rZXlzKG9iaikubWFwKGsgPT4gdGhpcy5fUSgpICsgayArIHRoaXMuX1EoKSkgKyAiKSB2YWx1ZXMgKCIgKyBPYmplY3QudmFsdWVzKG9iaikgKyBgKWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvSW5zZXJ0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLlRvb2xfVHlwZSkgcmV0dXJuOwoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5Ub29sX1R5cGUgPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgc3FsID0gbmV3IHNhbGVzbm93LlRvb2xfVHlwZSgpCgoJCQkJCS50eXBlX0NvbmZpZ3MobmV3IHNhbGVzbm93LkNvbmZpZygpKQoKCQkJCQkudHlwZV9Ub29scyhuZXcgc2FsZXNub3cuVG9vbCgpKQoKCQkJCQkudHlwZV9NYXBwaW5ncyhuZXcgc2FsZXNub3cuTWFwcGluZygpKQoKCQkJCQkuX3RvU1FMVGFibGUoZGVwdGgpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQkJCWF3YWl0IHRoaXMuX3NxbChzcWwpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIlRvb2wgVHlwZSIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQkJdHlwZV9Db25maWdzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnR5cGVfQ29uZmlncyA9IHYubWFwKF92ID0+IHF1ZXJ5LnR5cGVfQ29uZmlncygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJCXR5cGVfVG9vbHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoudHlwZV9Ub29scyA9IHYubWFwKF92ID0+IHF1ZXJ5LnR5cGVfVG9vbHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCQl0eXBlX01hcHBpbmdzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnR5cGVfTWFwcGluZ3MgPSB2Lm1hcChfdiA9PiBxdWVyeS50eXBlX01hcHBpbmdzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoZXMiKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDAsIG9NYXRjaCk7CgoJCQlyZXR1cm4gT2JqZWN0LmtleXMob01hdGNoKS5ldmVyeShrID0+IG9NYXRjaFtrXSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfbWF0Y2hpbmcocXVlcnkpIHsKCQl0cnkgewoJCQlsZXQgcmV0ID0gW107CgoJCQlsZXQgbWF0Y2hlcyA9IHRoaXMuX19leHBvcnQoe30sIHsKCgkJCQl0eXBlX0NvbmZpZ3M6IChvYmosIHYpID0+IHsKCQkJCQlvYmoudHlwZV9Db25maWdzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCQl0eXBlX1Rvb2xzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnR5cGVfVG9vbHMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJCXR5cGVfTWFwcGluZ3M6IChvYmosIHYpID0+IHsKCQkJCQlvYmoudHlwZV9NYXBwaW5ncyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fYWN0aXZlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcmRlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9kYXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX25hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcmVtYXJrX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQl0eXBlX0NvbmZpZ3M6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy50eXBlX0NvbmZpZ3MoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJdHlwZV9Ub29sczogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLnR5cGVfVG9vbHMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJdHlwZV9NYXBwaW5nczogKG9iaiwgdikgPT4gewoJCQkJCXYuZmlsdGVyKHRhID0+IHRhKS5mb3JFYWNoKCh0YSwgaSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdGEuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHRhKSB0aGlzLnR5cGVfTWFwcGluZ3MoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvZGUocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kYXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoJCQkJCWlmICh0eXBlb2YobW9tZW50KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZWYgPSBuZXcgRGF0ZShyZWYpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmVmID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpKTsKCQkJCX0KCQkJCXRoaXMuZGF0ZShyZWYpOwoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm5hbWUocmVmKTsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZW1hcmtfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnJlbWFyayhyZWYpOwoKCQkJfSwKCgkJCXR5cGVfQ29uZmlnczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3R5cGVfVG9vbF9UeXBlcycsIHVuZGVmaW5lZCkgOiAidHlwZV9Db25maWdzIikpID0+IHRoaXMudHlwZV9Db25maWdzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5Db25maWcoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJCXR5cGVfVG9vbHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0eXBlX1Rvb2xfVHlwZXMnLCB1bmRlZmluZWQpIDogInR5cGVfVG9vbHMiKSkgPT4gdGhpcy50eXBlX1Rvb2xzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5Ub29sKCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCQl0eXBlX01hcHBpbmdzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndHlwZV9Ub29sX1R5cGVzJywgdW5kZWZpbmVkKSA6ICJ0eXBlX01hcHBpbmdzIikpID0+IHRoaXMudHlwZV9NYXBwaW5ncyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuTWFwcGluZygpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQl9LCAiX2Zyb21Eb2N1bWVudCIpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSB7CgkJbGV0IHJldCA9IHt9OwoKCQlpZiAoIWJUb29sKSB7CgkJCXJldC5fX2dlbmVyYXRlZCA9IG5ldyBEYXRlKCk7CgkJCWlmICh0aGlzLlRvb2wubmFtZSkgewoJCQkJcmV0Ll9fdG9vbCA9IHsKCQkJCQluYW1lOiB0aGlzLlRvb2wubmFtZSwKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlpZiAoc2FsZXNub3cuX25vZGUpIHsKCQkJCXJldC5fX25vZGUgPSB7CgkJCQkJY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogYkZ1bGwsCgkJCU51bGw6IGJOdWxsLAoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IChvYmosIHYpID0+IHsKCQkJCWlmIChiVG9vbCkgcmV0dXJuOwoJCQkJb2JqLlRISVMgPSB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQlvYmouT1BFUkFUT1JTLlRISVMgPSB0aGlzLl9USElTX2Nvb3A7CgkJCX0sCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldID0gdiwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCXR5cGVfQ29uZmlnczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3R5cGVfVG9vbF9UeXBlcycsIHVuZGVmaW5lZCkgOiAidHlwZV9Db25maWdzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX3R5cGVfQ29uZmlnc19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fdHlwZV9Db25maWdzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQl0eXBlX1Rvb2xzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndHlwZV9Ub29sX1R5cGVzJywgdW5kZWZpbmVkKSA6ICJ0eXBlX1Rvb2xzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX3R5cGVfVG9vbHNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3R5cGVfVG9vbHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJCXR5cGVfTWFwcGluZ3M6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0eXBlX1Rvb2xfVHlwZXMnLCB1bmRlZmluZWQpIDogInR5cGVfTWFwcGluZ3MiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fdHlwZV9NYXBwaW5nc19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fdHlwZV9NYXBwaW5nc19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9mbGlwKCkgKi8KCV9mbGlwKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fZmxpcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9mbGlwKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2ZsaXAoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSB0cnVlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuVG9vbF9UeXBlLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5Ub29sX1R5cGUobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLm5hbWUodGhpcy5uYW1lKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCWlmICh0eXBlb2Yoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgPT09ICJ1bmRlZmluZWQiIHx8IHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQkJCWF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsKCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiA9IHsKCQkJCQkJCU93bmVyOiB0aGlzLAoJCQkJCQkJc3FsczogW10sCgkJCQkJCQlzdGFydDogbmV3IERhdGUoKSwKCQkJCQkJCWVuZDogbnVsbAoJCQkJCQl9OwoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBGaW5pc2hlZCBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0gSWQ9WyR7dGhpcy5JZH1dYCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fdHlwZV9Db25maWdzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMudHlwZV9Db25maWdzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICh0aGlzLl90eXBlX1Rvb2xzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMudHlwZV9Ub29scygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAodGhpcy5fdHlwZV9NYXBwaW5nc19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLnR5cGVfTWFwcGluZ3MoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCQlpZiAoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5Pd25lciA9PSB0aGlzKSB7CgkJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYENPTU1JVCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nIFRSQU5TQUNUSU9OJzonJ31gKTsKCQkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kID0gbmV3IERhdGUoKTsKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuVG9vbF9UeXBlLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl0aGlzLl9mcm9tRG9jdW1lbnQoYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlsZXQgb2JqID0ge307CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9zZXQpIHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9lbmFibGVkX3NldCkgewoKCQkJCQlvYmouZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fY29kZV9zZXQpIHsKCgkJCQkJb2JqLmNvZGUgPSB0aGlzLmNvZGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX29yZGVyX3NldCkgewoKCQkJCQlvYmoub3JkZXIgPSB0aGlzLm9yZGVyKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9kYXRlX3NldCkgewoKCQkJCQlvYmouZGF0ZSA9IHRoaXMuZGF0ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fbmFtZV9zZXQpIHsKCgkJCQkJb2JqLm5hbWUgPSB0aGlzLm5hbWUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX3JlbWFya19zZXQpIHsKCgkJCQkJb2JqLnJlbWFyayA9IHRoaXMucmVtYXJrKCk7CgoJCQkJfQoKCQkJCWxvZygiU2VuZGluZyB0byBTRiIsIG9iaik7CgoJCQkJbGV0IHJlcyA9IGF3YWl0IHRoaXMuVG9vbC5kYi5zb2JqZWN0KCJUb29sX1R5cGUiKS5jcmVhdGUob2JqKTsKCQkJCXRoaXMuSWQgPSByZXMuaWQ7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ub29sX1R5cGUudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ub29sX1R5cGUuZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCB7CgkJCQkJc3lzcGFybV9xdWVyeTogT2JqZWN0LmVudHJpZXModGhpcy5fdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykpLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKQoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIHRydWUpLCBudWxsLCB7CgkJCQkJdXJsOiAncmVzdC51cmwuZ3FsJwoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCk7CgkJCQlyZXQgPSByZXQuY29udGVudCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5Ub29sX1R5cGUobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoKCX0KCn07CgpzYWxlc25vdy5FdmVudCA9IGNsYXNzIEV2ZW50IGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUXNLaTVmY21WemRDd3FMbDlzYjJGa1ZHOXZiSE1pZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKMGNtbG5aMlZ5TG5ScGJXVnZkWFFpT2pFd01EQXdMQ0p6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpWYzJWeUlqcDdJbDloZFhSb2IzSnBlbVV1ZFhObGNtNWhiV1VpT2lKbVlXUnBJaXdpWDJGMWRHaHZjbWw2WlM1d1lYTnpkMjl5WkNJNklqRXlNeUlzSWw5aGRYUm9iM0pwZW1VdWRHVnpkRlZ6WlhJaU9uc2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0puWlc1a1pYSWlPbnNpWTI5a1pTSTZJazBpTENKdVlXMWxJam9pVFdGc1pTSjlMQ0pqYjJSbElqb2labUZrYVNJc0ltNWhiV1VpT2lKR1lXUnBJbjE5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpUY1d4RVFpSXNleUp1WVcxbElqb2lVMDVQVjA5UFFpSXNJblI1Y0dVaU9uc2libUZ0WlNJNklsTmxjblpwWTJWT2IzY2lmWDBzSWxOaGJHVnpSbTl5WTJVaUxDSkhhWFJJZFdJaVhRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLk1hcHBpbmdzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgVzEwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoKCQkvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUKCQl0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307CgkJdGhpcy5Ub29sID0gdG9vbDsKCQl0aGlzLklkID0gaWQ7CgoJCXRoaXMuVmFsdWVFbnRpdGllcyA9IFtdOwoKCQl0aGlzLkRhdGUgPSBudWxsOwoKCQl0aGlzLmNsZWFyX1RISVMoKTsKCQl0aGlzLkVudGl0eVZhbHVlcyA9IFtdOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNsYXNzTmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY2xhc3NOYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibWV0aG9kIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9tZXRob2QoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJwYXlsb2FkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9wYXlsb2FkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY2FycmllciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY2FycmllcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInNlbmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfc2VuZGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVjaXBpZW50IiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZWNpcGllbnQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJyZXNwb25zZVRvIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZXNwb25zZVRvKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgkJdGhpcy5jbGVhcl9yZXNwb25zZVRvX0V2ZW50cygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIkV2ZW50IiwKCQkJT1BFUkFUT1JTOiB7CgkJCQlOYW1lOiAiPSIKCQkJfSwKCQl9OwoKCQkvLyB0aGF0J3Mgd2h5IHdlIG5lZWQgaXQgYXMgYSBnZXR0ZXIKCQlpZiAoIU51bWJlcihlYy5JZCkgJiYgc2FsZXNub3cuRW50aXR5Q2xhc3NlcykgewoJCQlsZXQgY2lkID0gc2FsZXNub3cuRW50aXR5Q2xhc3Nlcy5maW5kKGMgPT4gTnVtYmVyKGMuSWQpICYmIGMuTmFtZSA9PSBlYy5OYW1lKTsKCQkJaWYgKGNpZCkgZWMuSWQgPSBjaWQuSWQ7CgkJfQoJCXJldHVybiBlYzsKCX0KCglnZXQgSWQoKSB7CgkJcmV0dXJuIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgdGhpcy5fdXVpZCgpOwoJfQoKCXNldCBJZChpZCkgewoJCWlmICghdGhpcy5Ub29sKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBJZCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgVG9vbCIsIHRoaXMuVG9vbHMubGVuZ3RoLCBzYWxlc25vdy5Ub29scy5sZW5ndGgpOwoJCQlyZXR1cm47CgkJfQoJCXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0gPSBpZDsKCX0KCglnZXQgVG9vbCgpIHsKCQlpZiAodHlwZW9mKHRoaXMuX19Ub29sKSAhPT0gJ3VuZGVmaW5lZCcpIHJldHVybiB0aGlzLl9fVG9vbDsKCQlsZXQgbm9Ub29sID0gewoJCQluYW1lOiAnJywKCQkJdHlwZTogewoJCQkJbmFtZTogJycKCQkJfSwKCQl9OwoJCWlmICh0eXBlb2Yoc2FsZXNub3cuVG9vbHMpICE9PSAidW5kZWZpbmVkIiAmJiAhQXJyYXkuaXNBcnJheShzYWxlc25vdy5Ub29scykpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMiwgInNhbGVzbm93LlRvb2xzIGlzIG5vdCBhbiBhcnJheTogIiwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm4gbm9Ub29sOwoJCX0KCQlsZXQgcmV0ID0gdGhpcy5Ub29scy5maW5kKHQgPT4gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKF90ID0+IHQgPT0gX3QubmFtZSB8fCB0Lm5hbWUgPT0gX3QubmFtZSkpOwoJCWlmICh0eXBlb2YocmV0KSAhPT0gJ3VuZGVmaW5lZCcpIHJldCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZCh0ID0+IHQubmFtZSA9PSByZXQgfHwgdC5uYW1lID09IHJldC5uYW1lKTsKCQlpZiAodHlwZW9mKHJldCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gbm9Ub29sOwoJCXJldHVybiByZXQ7Cgl9CgoJc2V0IFRvb2wodG9vbCkgewoJCWlmICh0eXBlb2YodG9vbCkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gInN0cmluZyIpIHsKCQkJdG9vbCA9IHsKCQkJCW5hbWU6IHRvb2wKCQkJfTsKCQl9CgkJaWYgKHRvb2wuRW50aXR5Q2xhc3MpIHsKCQkJdG9vbCA9IHRvb2wuX3RvRG9jdW1lbnQoKTsKCQl9CgkJaWYgKHR5cGVvZih0b29sLm5hbWUpID09PSAndW5kZWZpbmVkJyAmJiB0eXBlb2YodG9vbC50eXBlLm5hbWUpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCXRvb2wudHlwZSA9IHRvb2wudHlwZSB8fCB7CgkJCW5hbWU6IHRvb2wubmFtZQoJCX07CgoJCWlmICghdG9vbC50eXBlICYmICF0b29sLm5hbWUpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMSwgIkVtcHR5IFRvb2wgb2JqZWN0Iik7CgkJCXJldHVybjsKCQl9CgoJCWxldCB0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maWx0ZXIodCA9PiB0Lm5hbWUgJiYgdC50eXBlKS5maW5kKHQgPT4gKHQubmFtZSA9PSB0b29sLm5hbWUpIHx8ICh0LnR5cGUubmFtZSA9PSB0b29sLnR5cGUubmFtZSkpOwoJCWlmICghdCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAibm8gbWF0Y2hpbmcgdG9vbCIsIHRvb2wsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuOwoJCX0KCgkJdGhpcy5fX1Rvb2wgPSB0OwoKCQkvLyBpZih0aGlzLl9jYXJyaWVyX3NldCAmJiB0aGlzLl9jYXJyaWVyKSB0aGlzLl9jYXJyaWVyLlRvb2wgPSB0b29sOwoKCQkvLyBpZih0aGlzLl9zZW5kZXJfc2V0ICYmIHRoaXMuX3NlbmRlcikgdGhpcy5fc2VuZGVyLlRvb2wgPSB0b29sOwoKCQkvLyBpZih0aGlzLl9yZWNpcGllbnRfc2V0ICYmIHRoaXMuX3JlY2lwaWVudCkgdGhpcy5fcmVjaXBpZW50LlRvb2wgPSB0b29sOwoKCQkvLyBpZih0aGlzLl9yZXNwb25zZVRvX3NldCAmJiB0aGlzLl9yZXNwb25zZVRvKSB0aGlzLl9yZXNwb25zZVRvLlRvb2wgPSB0b29sOwoKCQkvLyAodGhpcy5yZXNwb25zZVRvX0V2ZW50cygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjbGFzc05hbWUgKiovCgljbGFzc05hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jbGFzc05hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjbGFzc05hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NsYXNzTmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9jbGFzc05hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NsYXNzTmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jbGFzc05hbWUpOwoJCX0KCX0KCgljbGVhcl9jbGFzc05hbWUoKSB7CgkJdGhpcy5fY2xhc3NOYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fY2xhc3NOYW1lID0gbnVsbDsKCQl0aGlzLl9jbGFzc05hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNsYXNzTmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG1ldGhvZCAqKi8KCW1ldGhvZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX21ldGhvZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm1ldGhvZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbWV0aG9kICE9IHYpIHsKCQkJCXRoaXMuX21ldGhvZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbWV0aG9kID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX21ldGhvZCk7CgkJfQoJfQoKCWNsZWFyX21ldGhvZCgpIHsKCQl0aGlzLl9tZXRob2Rfc2V0ID0gbnVsbDsKCQl0aGlzLl9tZXRob2QgPSBudWxsOwoJCXRoaXMuX21ldGhvZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbWV0aG9kICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcGF5bG9hZCAqKi8KCXBheWxvYWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9wYXlsb2FkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicGF5bG9hZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcGF5bG9hZCAhPSB2KSB7CgkJCQl0aGlzLl9wYXlsb2FkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9wYXlsb2FkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9wYXlsb2FkKTsKCQl9Cgl9CgoJY2xlYXJfcGF5bG9hZCgpIHsKCQl0aGlzLl9wYXlsb2FkX3NldCA9IG51bGw7CgkJdGhpcy5fcGF5bG9hZCA9IG51bGw7CgkJdGhpcy5fcGF5bG9hZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcGF5bG9hZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNhcnJpZXIgKiovCgljYXJyaWVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY2Fycmllcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNhcnJpZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc5ZTJhMGQ3MC05YTFiLTQ3NjItYTlkYi0wNjBlNjU3OTVjODknICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdOb2RlJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NhcnJpZXInLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICI5ZTJhMGQ3MC05YTFiLTQ3NjItYTlkYi0wNjBlNjU3OTVjODkiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiTm9kZSIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jYXJyaWVyICE9IHYpIHsKCQkJCXRoaXMuX2NhcnJpZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdjYXJyaWVyJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9jYXJyaWVyID8gdGhpcy5fY2Fycmllci5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fY2Fycmllcl9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fY2FycmllciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jYXJyaWVyKTsKCQl9Cgl9CgoJY2xlYXJfY2FycmllcigpIHsKCQl0aGlzLl9jYXJyaWVyX3NldCA9IG51bGw7CgkJdGhpcy5fY2FycmllciA9IG51bGw7CgkJdGhpcy5fY2Fycmllcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY2FycmllciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHNlbmRlciAqKi8KCXNlbmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3NlbmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInNlbmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzllMmEwZDcwLTlhMWItNDc2Mi1hOWRiLTA2MGU2NTc5NWM4OScgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ05vZGUnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2VuZGVyJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiOWUyYTBkNzAtOWExYi00NzYyLWE5ZGItMDYwZTY1Nzk1Yzg5IiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIk5vZGUiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fc2VuZGVyICE9IHYpIHsKCQkJCXRoaXMuX3NlbmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NlbmRlcicsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fc2VuZGVyID8gdGhpcy5fc2VuZGVyLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9zZW5kZXJfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX3NlbmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9zZW5kZXIpOwoJCX0KCX0KCgljbGVhcl9zZW5kZXIoKSB7CgkJdGhpcy5fc2VuZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fc2VuZGVyID0gbnVsbDsKCQl0aGlzLl9zZW5kZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHNlbmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlY2lwaWVudCAqKi8KCXJlY2lwaWVudCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlY2lwaWVudF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlY2lwaWVudCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChfdiAmJiBfdi50b0VudGl0eU9iamVjdCAmJiBfdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzllMmEwZDcwLTlhMWItNDc2Mi1hOWRiLTA2MGU2NTc5NWM4OScgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ05vZGUnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAncmVjaXBpZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiOWUyYTBkNzAtOWExYi00NzYyLWE5ZGItMDYwZTY1Nzk1Yzg5IiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIk5vZGUiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVjaXBpZW50ICE9IHYpIHsKCQkJCXRoaXMuX3JlY2lwaWVudF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3JlY2lwaWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fcmVjaXBpZW50ID8gdGhpcy5fcmVjaXBpZW50LlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9yZWNpcGllbnRfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX3JlY2lwaWVudCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZWNpcGllbnQpOwoJCX0KCX0KCgljbGVhcl9yZWNpcGllbnQoKSB7CgkJdGhpcy5fcmVjaXBpZW50X3NldCA9IG51bGw7CgkJdGhpcy5fcmVjaXBpZW50ID0gbnVsbDsKCQl0aGlzLl9yZWNpcGllbnRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlY2lwaWVudCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlc3BvbnNlVG8gKiovCglyZXNwb25zZVRvKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVzcG9uc2VUb19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlc3BvbnNlVG8iKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICdkNWMyOGQwZS1iOWU1LTRhOWEtOTc1Zi05ZjliMDA1NDViNGUnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdFdmVudCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdyZXNwb25zZVRvJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiZDVjMjhkMGUtYjllNS00YTlhLTk3NWYtOWY5YjAwNTQ1YjRlIiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIkV2ZW50Iik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3Jlc3BvbnNlVG8gIT0gdikgewoJCQkJdGhpcy5fcmVzcG9uc2VUb19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3Jlc3BvbnNlVG8nLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX3Jlc3BvbnNlVG8gPyB0aGlzLl9yZXNwb25zZVRvLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl9yZXNwb25zZVRvX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9yZXNwb25zZVRvID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3Jlc3BvbnNlVG8pOwoJCX0KCX0KCgljbGVhcl9yZXNwb25zZVRvKCkgewoJCXRoaXMuX3Jlc3BvbnNlVG9fc2V0ID0gbnVsbDsKCQl0aGlzLl9yZXNwb25zZVRvID0gbnVsbDsKCQl0aGlzLl9yZXNwb25zZVRvX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZXNwb25zZVRvICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoJYWN0aXZlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fYWN0aXZlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiYWN0aXZlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fYWN0aXZlICE9IHYpIHsKCQkJCXRoaXMuX2FjdGl2ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fYWN0aXZlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9hY3RpdmUpOwoJCX0KCX0KCgljbGVhcl9hY3RpdmUoKSB7CgkJdGhpcy5fYWN0aXZlX3NldCA9IG51bGw7CgkJdGhpcy5fYWN0aXZlID0gbnVsbDsKCQl0aGlzLl9hY3RpdmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgllbmFibGVkKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZW5hYmxlZF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImVuYWJsZWQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9lbmFibGVkICE9IHYpIHsKCQkJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2VuYWJsZWQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2VuYWJsZWQpOwoJCX0KCX0KCgljbGVhcl9lbmFibGVkKCkgewoJCXRoaXMuX2VuYWJsZWRfc2V0ID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkID0gbnVsbDsKCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCWNvZGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9jb2RlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiY29kZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY29kZSAhPSB2KSB7CgkJCQl0aGlzLl9jb2RlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9jb2RlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NvZGUpOwoJCX0KCX0KCgljbGVhcl9jb2RlKCkgewoJCXRoaXMuX2NvZGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jb2RlID0gbnVsbDsKCQl0aGlzLl9jb2RlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCglvcmRlcih2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX29yZGVyX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib3JkZXIiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoaXNOYU4oX3YpKSBfdiA9IDA7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5JbnRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vcmRlciAhPSB2KSB7CgkJCQl0aGlzLl9vcmRlcl9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fb3JkZXIgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5JbnRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3JkZXIpOwoJCX0KCX0KCgljbGVhcl9vcmRlcigpIHsKCQl0aGlzLl9vcmRlcl9zZXQgPSBudWxsOwoJCXRoaXMuX29yZGVyID0gbnVsbDsKCQl0aGlzLl9vcmRlcl9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb3JkZXIgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoJZGF0ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2RhdGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkYXRlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9kYXRlICE9IHYpIHsKCQkJCXRoaXMuX2RhdGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2RhdGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2RhdGUpOwoJCX0KCX0KCgljbGVhcl9kYXRlKCkgewoJCXRoaXMuX2RhdGVfc2V0ID0gbnVsbDsKCQl0aGlzLl9kYXRlID0gbnVsbDsKCQl0aGlzLl9kYXRlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkYXRlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCW5hbWUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9uYW1lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgibmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fbmFtZSAhPSB2KSB7CgkJCQl0aGlzLl9uYW1lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9uYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX25hbWUpOwoJCX0KCX0KCgljbGVhcl9uYW1lKCkgewoJCXRoaXMuX25hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9uYW1lID0gbnVsbDsKCQl0aGlzLl9uYW1lX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoJcmVtYXJrKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fcmVtYXJrX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgicmVtYXJrIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKHR5cGVvZihfdikgPT09ICdvYmplY3QnKSBfdiA9IEpTT04uc3RyaW5naWZ5KF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlRleHRWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9yZW1hcmsgIT0gdikgewoJCQkJdGhpcy5fcmVtYXJrX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9yZW1hcmsgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5UZXh0VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3JlbWFyayk7CgkJfQoJfQoKCWNsZWFyX3JlbWFyaygpIHsKCQl0aGlzLl9yZW1hcmtfc2V0ID0gbnVsbDsKCQl0aGlzLl9yZW1hcmsgPSBudWxsOwoJCXRoaXMuX3JlbWFya19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVtYXJrICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgcmVzcG9uc2VUb19FdmVudHMgKiovCglyZXNwb25zZVRvX0V2ZW50cyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fcmVzcG9uc2VUb19FdmVudHM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJ2Q1YzI4ZDBlLWI5ZTUtNGE5YS05NzVmLTlmOWIwMDU0NWI0ZScgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnRXZlbnQnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX3Jlc3BvbnNlVG9fc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAncmVzcG9uc2VUb19FdmVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgInJlc3BvbnNlVG8gaGFzIG5vIGNvbnN0cnVjdG9yIiwgX3YpOwoJCQl9IGVsc2UgaWYgKF92LmNvbnN0cnVjdG9yLm5hbWUgIT0gIkV2ZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAncmVzcG9uc2VUb19FdmVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgInJlc3BvbnNlVG8gbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJFdmVudCIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5yZXNwb25zZVRvKHRoaXMpOwoJCQl9CgkJfSk7CgoJCXRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzLnB1c2goLi4udik7CgkJdGhpcy5fcmVzcG9uc2VUb19FdmVudHNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzX2Nvb3AgPSBjbzsKCgkJcmV0dXJuIHRoaXM7Cgl9CgljbGVhcl9yZXNwb25zZVRvX0V2ZW50cygpIHsKCQl0aGlzLl9yZXNwb25zZVRvX0V2ZW50c19zZXQgPSBudWxsOwoJCXRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzID0gbmV3IEFycmF5KCk7CgkJdGhpcy5fcmVzcG9uc2VUb19FdmVudHNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZXNwb25zZVRvX0V2ZW50cyAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX2NsYXNzTmFtZV9zZXQsCgoJCQl0aGlzLl9tZXRob2Rfc2V0LAoKCQkJdGhpcy5fcGF5bG9hZF9zZXQsCgoJCQl0aGlzLl9jYXJyaWVyX3NldCwKCgkJCXRoaXMuX3NlbmRlcl9zZXQsCgoJCQl0aGlzLl9yZWNpcGllbnRfc2V0LAoKCQkJdGhpcy5fcmVzcG9uc2VUb19zZXQsCgoJCQl0aGlzLl9hY3RpdmVfc2V0LAoKCQkJdGhpcy5fZW5hYmxlZF9zZXQsCgoJCQl0aGlzLl9jb2RlX3NldCwKCgkJCXRoaXMuX29yZGVyX3NldCwKCgkJCXRoaXMuX2RhdGVfc2V0LAoKCQkJdGhpcy5fbmFtZV9zZXQsCgoJCQl0aGlzLl9yZW1hcmtfc2V0LAoKCQkJdGhpcy5fcmVzcG9uc2VUb19FdmVudHNfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fY2xhc3NOYW1lX3NldCA9IHRoaXMuX2NsYXNzTmFtZV9zZXQ7CgkJcmV0Ll9jbGFzc05hbWVfY29vcCA9IHRoaXMuX2NsYXNzTmFtZV9jb29wOwoJCXJldC5jbGFzc05hbWUgPSB0aGlzLmNsYXNzTmFtZSgpID8gdGhpcy5jbGFzc05hbWUoKSA6IHRoaXMuY2xhc3NOYW1lKCk7CgoJCXJldC5fbWV0aG9kX3NldCA9IHRoaXMuX21ldGhvZF9zZXQ7CgkJcmV0Ll9tZXRob2RfY29vcCA9IHRoaXMuX21ldGhvZF9jb29wOwoJCXJldC5tZXRob2QgPSB0aGlzLm1ldGhvZCgpID8gdGhpcy5tZXRob2QoKSA6IHRoaXMubWV0aG9kKCk7CgoJCXJldC5fcGF5bG9hZF9zZXQgPSB0aGlzLl9wYXlsb2FkX3NldDsKCQlyZXQuX3BheWxvYWRfY29vcCA9IHRoaXMuX3BheWxvYWRfY29vcDsKCQlyZXQucGF5bG9hZCA9IHRoaXMucGF5bG9hZCgpID8gdGhpcy5wYXlsb2FkKCkgOiB0aGlzLnBheWxvYWQoKTsKCgkJcmV0Ll9jYXJyaWVyX3NldCA9IHRoaXMuX2NhcnJpZXJfc2V0OwoJCXJldC5fY2Fycmllcl9jb29wID0gdGhpcy5fY2Fycmllcl9jb29wOwoJCXJldC5jYXJyaWVyID0gdGhpcy5jYXJyaWVyKCkgPyB0aGlzLmNhcnJpZXIoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5jYXJyaWVyKCk7CgoJCXJldC5fc2VuZGVyX3NldCA9IHRoaXMuX3NlbmRlcl9zZXQ7CgkJcmV0Ll9zZW5kZXJfY29vcCA9IHRoaXMuX3NlbmRlcl9jb29wOwoJCXJldC5zZW5kZXIgPSB0aGlzLnNlbmRlcigpID8gdGhpcy5zZW5kZXIoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5zZW5kZXIoKTsKCgkJcmV0Ll9yZWNpcGllbnRfc2V0ID0gdGhpcy5fcmVjaXBpZW50X3NldDsKCQlyZXQuX3JlY2lwaWVudF9jb29wID0gdGhpcy5fcmVjaXBpZW50X2Nvb3A7CgkJcmV0LnJlY2lwaWVudCA9IHRoaXMucmVjaXBpZW50KCkgPyB0aGlzLnJlY2lwaWVudCgpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLnJlY2lwaWVudCgpOwoKCQlyZXQuX3Jlc3BvbnNlVG9fc2V0ID0gdGhpcy5fcmVzcG9uc2VUb19zZXQ7CgkJcmV0Ll9yZXNwb25zZVRvX2Nvb3AgPSB0aGlzLl9yZXNwb25zZVRvX2Nvb3A7CgkJcmV0LnJlc3BvbnNlVG8gPSB0aGlzLnJlc3BvbnNlVG8oKSA/IHRoaXMucmVzcG9uc2VUbygpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLnJlc3BvbnNlVG8oKTsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0LnJlc3BvbnNlVG9fRXZlbnRzID0gdGhpcy5yZXNwb25zZVRvX0V2ZW50cygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkiY2xhc3NOYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NsYXNzTmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm1ldGhvZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdtZXRob2QnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJwYXlsb2FkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3BheWxvYWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjYXJyaWVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhcnJpZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJzZW5kZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc2VuZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IHYpIDogbnVsbDsKCQkJCQkJb2JqW2VhQ29kZV0gPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IHYuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IG9ialtlYUNvZGVdCgkJCQkJCX0pOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9ialtlYUNvZGVdID0gdjsKCQkJCQl9CgoJCQkJfSwKCgkJCQkicmVjaXBpZW50IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlY2lwaWVudCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJInJlc3BvbnNlVG8iOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVzcG9uc2VUbycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCXJlc3BvbnNlVG9fRXZlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVzcG9uc2VUb19FdmVudHMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAiY2FycmllciIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgY2FycmllcicsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuTm9kZSgpLmNhcnJpZXJfRXZlbnRzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAic2VuZGVyIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciBzZW5kZXInLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5zZW5kZXJfRXZlbnRzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAicmVjaXBpZW50IikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3FsU2VsZWN0aW9ucycsICdFbnRpdHlPYmplY3QnLCAwLCAnUmVmZXJlbmNlIGZvciByZWNpcGllbnQnLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5yZWNpcGllbnRfRXZlbnRzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAicmVzcG9uc2VUbyIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgcmVzcG9uc2VUbycsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuRXZlbnQoKS5yZXNwb25zZVRvX0V2ZW50cyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpICE9ICdFdmVudCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCXJldHVybiBuZXcgc2FsZXNub3dbZXZlbnQuY2xhc3NOYW1lKCldKCkuX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdyk7CgkJCX0KCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJCWNhc2UgImxpc3RlbiI6IHsKCgkJCQkJZGF0YS5ub2RlID0gZGF0YS5ub2RlID8gZGF0YS5ub2RlCgoJCQkJCQkuX3RvRG9jdW1lbnQoKQoKCQkJCQkJOgoJCQkJCQl1bmRlZmluZWQ7CgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCWNhc2UgInRyaWdnZXIiOiB7CgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCWNhc2UgInByb2Nlc3MiOiB7CgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9FdmVudC8ke21ldGhvZH1gLCBkYXRhLCBjb25maWcpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQl9CgkJfSBlbHNlIHsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJsaXN0ZW4iOiB7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgInRyaWdnZXIiOiB7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgInByb2Nlc3MiOiB7CgoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuRXZlbnQobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93LkV2ZW50KG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5FdmVudChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocCkpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHt9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2UobWV0aG9kLCBib2R5LCBxdWVyeSwgYXV0aE9iaikgewoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgbWV0aG9kLCBxdWVyeSwgYm9keSk7CgoJCWlmICh0eXBlb2YoYm9keSkgPT09ICdzdHJpbmcnIHx8ICh0eXBlb2YoQnVmZmVyKSAhPT0gJ3VuZGVmaW5lZCcgJiYgQnVmZmVyLmlzQnVmZmVyKGJvZHkpKSkgewoJCQl0cnkgewoJCQkJYm9keSA9IEpTT04ucGFyc2UoYm9keS50b1N0cmluZygpKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJvZHkgaXMgbm90IGEgdmFsaWQgSlNPTiIsIGJvZHkpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoKCQlsZXQgX3BhcmFtcyA9IHF1ZXJ5ID8gT2JqZWN0LmFzc2lnbihxdWVyeSwgYm9keSkgOiBib2R5OwoJCWlmICh0eXBlb2YoX3BhcmFtcykgPT09ICdzdHJpbmcnKSBfcGFyYW1zID0gSlNPTi5wYXJzZShfcGFyYW1zKTsKCgkJaWYgKF9wYXJhbXMpIHsKCQkJX3BhcmFtcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcyk7CgkJfSBlbHNlIHsKCQkJX3BhcmFtcyA9IHt9OwoJCX0KCgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgX3BhcmFtcy5fX2ZsYXR0ZWQpIF9wYXJhbXMgPSBGbGF0dGVkLnBhcnNlKF9wYXJhbXMuX19mbGF0dGVkKTsKCgkJaWYgKF9wYXJhbXMuX19ub2RlKSB7CgkJCS8vIHByb2JhYmx5IHNob3VsZCBub3QgYmUgcHJvY2Vzc2VkIGhlcmUsIGJ1dCByYXRoZXIgY29uc3VtZWQgYXMgcGFydCBvZiB0aGUgZXhlY3V0ZSgpIGxvZ2ljLCBwdXNoaW5nIF9fbm9kZSB0byB0aGUgbGlzdCBvZiBteSBub2RlcyB0byBkZWxlZ2F0ZSB0byE/CgkJCWxldCB0biA9IG5ldyBzYWxlc25vdy5Ob2RlKCkuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fbm9kZSkuX2RlUmVmZXJlbmNlKCk7CgkJCWRlbGV0ZSBfcGFyYW1zLl9fbm9kZTsKCQkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5FdmVudCgpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOwoJCX0KCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAibGlzdGVuIjogewoKCQkJCV9wYXJhbXMubm9kZSA9IG5ldyBzYWxlc25vdy5Ob2RlKCkuX2Zyb21Eb2N1bWVudChfcGFyYW1zLm5vZGUpLl9kZVJlZmVyZW5jZSgpOwoKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMubm9kZSk7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgInRyaWdnZXIiOiB7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgInByb2Nlc3MiOiB7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYEV2ZW50Ll9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgRXZlbnQuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuRXZlbnQuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuRXZlbnQuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglfcGFyc2VDb2RlU3RhdGUodCkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyc2VDb2RlU3RhdGUodCk7CgoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiRXZlbnQiKTsKCgl9CgoJX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXggPSAne3snLCBwb3N0Zml4ID0gJ319JykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCwgcG9zdGZpeCk7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCWlmICh0aGlzLl9jYXJyaWVyX3NldCAmJiB0aGlzLmNhcnJpZXIoKSkgdGhpcy5jYXJyaWVyKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX3NlbmRlcl9zZXQgJiYgdGhpcy5zZW5kZXIoKSkgdGhpcy5zZW5kZXIoKS5fX3N5bmNfb24oZCk7CgoJCQlpZiAodGhpcy5fcmVjaXBpZW50X3NldCAmJiB0aGlzLnJlY2lwaWVudCgpKSB0aGlzLnJlY2lwaWVudCgpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl9yZXNwb25zZVRvX3NldCAmJiB0aGlzLnJlc3BvbnNlVG8oKSkgdGhpcy5yZXNwb25zZVRvKCkuX19zeW5jX29uKGQpOwoKCQkJLy8gdGhpcy5yZXNwb25zZVRvX0V2ZW50cygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93LkV2ZW50KHRoaXMuSWQpCgoJCQkuY2xhc3NOYW1lKHRoaXMuY2xhc3NOYW1lKCksIHRoaXMuX2NsYXNzTmFtZV9jb29wKQoKCQkJLm1ldGhvZCh0aGlzLm1ldGhvZCgpLCB0aGlzLl9tZXRob2RfY29vcCkKCgkJCS5wYXlsb2FkKHRoaXMucGF5bG9hZCgpLCB0aGlzLl9wYXlsb2FkX2Nvb3ApCgoJCQkuY2Fycmllcih0aGlzLmNhcnJpZXIoKSwgdGhpcy5fY2Fycmllcl9jb29wKQoKCQkJLnNlbmRlcih0aGlzLnNlbmRlcigpLCB0aGlzLl9zZW5kZXJfY29vcCkKCgkJCS5yZWNpcGllbnQodGhpcy5yZWNpcGllbnQoKSwgdGhpcy5fcmVjaXBpZW50X2Nvb3ApCgoJCQkucmVzcG9uc2VUbyh0aGlzLnJlc3BvbnNlVG8oKSwgdGhpcy5fcmVzcG9uc2VUb19jb29wKQoKCQkJLmFjdGl2ZSh0aGlzLmFjdGl2ZSgpLCB0aGlzLl9hY3RpdmVfY29vcCkKCgkJCS5lbmFibGVkKHRoaXMuZW5hYmxlZCgpLCB0aGlzLl9lbmFibGVkX2Nvb3ApCgoJCQkuY29kZSh0aGlzLmNvZGUoKSwgdGhpcy5fY29kZV9jb29wKQoKCQkJLm9yZGVyKHRoaXMub3JkZXIoKSwgdGhpcy5fb3JkZXJfY29vcCkKCgkJCS5kYXRlKHRoaXMuZGF0ZSgpLCB0aGlzLl9kYXRlX2Nvb3ApCgoJCQkubmFtZSh0aGlzLm5hbWUoKSwgdGhpcy5fbmFtZV9jb29wKQoKCQkJLnJlbWFyayh0aGlzLnJlbWFyaygpLCB0aGlzLl9yZW1hcmtfY29vcCkKCgkJCS5yZXNwb25zZVRvX0V2ZW50cyh0aGlzLnJlc3BvbnNlVG9fRXZlbnRzKCksIHRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJLy9vYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJLy9vYmpUbyA9IG9ialRvIHx8IHt9OwoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAnRXZlbnQnOwoJCXRvb2wgPSB0b29sIHx8IHRoaXMuVG9vbDsKCQljb2RlVHlwZSA9IGNvZGVUeXBlIHx8IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpZWEp5YVdWeUlqb2lUbTlrWlNJc0luTmxibVJsY2lJNklrNXZaR1VpTENKeVpXTnBjR2xsYm5RaU9pSk9iMlJsSWl3aWNtVnpjRzl1YzJWVWJ5STZJa1YyWlc1MElpd2libTlrWlNJNklrNXZaR1VpZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pW2NvZGVdOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJFdmVudCI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMgPSB7fSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX2NvbmZpZyhuLCBudWxsVmFsdWUsIE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMgfHwge30sIHsKCQkJX2NsYXNzOiAnRXZlbnQnCgkJfSkpOwoKCX0KCgkvKioKCSAqIFN1bW1hcnkuIGxpc3Rlbi4KCSAqCgkgKiBEZXNjcmlwdGlvbi4gLgoJICoKCSAqIEBzaW5jZSAgICAgIHgueC54CgkgKiBAZGVwcmVjYXRlZCB4LngueCBVc2UgbmV3X2Z1bmN0aW9uX25hbWUoKSBpbnN0ZWFkLgoJICogQGFjY2VzcyAgICAgcHVibGljCgkgKgoJICogQGNsYXNzCgkgKiBAYXVnbWVudHMgcGFyZW50CgkgKiBAbWl4ZXMgICAgbWl4aW4KCSAqCgkgKiBAYWxpYXMgICAgcmVhbE5hbWUKCSAqIEBtZW1iZXJvZiBuYW1lc3BhY2UKCSAqCgkgKiBAc2VlICBGdW5jdGlvbi9jbGFzcyByZWxpZWQgb24KCSAqIEBsaW5rIFVSTAoJICogQGdsb2JhbAoJICoKCSAqIEBmaXJlcyAgIGV2ZW50TmFtZQoJICogQGZpcmVzICAgY2xhc3NOYW1lI2V2ZW50TmFtZQoJICogQGxpc3RlbnMgZXZlbnQ6ZXZlbnROYW1lCgkgKiBAbGlzdGVucyBjbGFzc05hbWV+ZXZlbnQ6ZXZlbnROYW1lCgkgKiBAcGFyYW0ge3R5cGV9ICAgdmFyICAgICAgICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyXSAgICAgICAgIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXI9ZGVmYXVsdF0gRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUgd2l0aCBkZWZhdWx0IHZhcmlhYmxlLgoJICogQHBhcmFtIHtPYmplY3R9IG9iamVjdFZhciAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgb2JqZWN0VmFyLmtleSBEZXNjcmlwdGlvbiBvZiBhIGtleSBpbiB0aGUgb2JqZWN0VmFyIHBhcmFtZXRlci4KCSAqCgkgKiBAeWllbGQge3R5cGV9IFlpZWxkZWQgdmFsdWUgZGVzY3JpcHRpb24uCgkgKgoJICogQHJldHVybiB7dHlwZX0gUmV0dXJuIHZhbHVlIGRlc2NyaXB0aW9uLgoJICovCglhc3luYyBsaXN0ZW4obm9kZSkgewoKCQlsZXQgYW5zd2VyID0gbnVsbDsKCgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAibGlzdGVuIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImxpc3RlbiIsIF9ub2RlLCBub2RlKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJsaXN0ZW4iLCBub2RlKSA9PiB7CgoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuRXZlbnQubGlzdGVuJyk7CgoJCQl2YXIgZXJyb3JzID0gewoKCQkJCSJub2RlIjogKChub2RlKSA9PiB7CgoJCQkJCWxldCBhbnN3ZXIgPQoKCQkJCQkJKCFub2RlICYmIGZhbHNlKSB8fCAobm9kZSAmJiAobm9kZS5jb25zdHJ1Y3Rvci5uYW1lICE9ICdOb2RlJyB8fCBub2RlLkVudGl0eUNsYXNzLk5hbWUgIT0gJ05vZGUnKSkKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdsaXN0ZW4nLCAnRW50aXR5T2JqZWN0JywgMCwgImFuc3dlciIsICJub2RlIiwgYW5zd2VyKTsKCQkJCQlyZXR1cm4gYW5zd2VyOwoJCQkJfSkobm9kZSkgPyAoJ25vZGUgaXMgbm90IG9mIHR5cGUgTm9kZScgfHwgJ1ZhbGlkYXRpb24gRXJyb3InKSA6ICcnLAoKCQkJCSIwMSI6ICgobm9kZSkgPT4gewoKCQkJCQlsZXQgYW5zd2VyID0KCgkJCQkJCXR5cGVvZihub2RlKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKG9TY29wZS5fbm9kZSkgPT09ICd1bmRlZmluZWQnCgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnbGlzdGVuJywgJ0VudGl0eU9iamVjdCcsIDAsICJhbnN3ZXIiLCAiMDEiLCBhbnN3ZXIpOwoJCQkJCXJldHVybiBhbnN3ZXI7CgkJCQl9KShub2RlKSA/ICgnb1Njb3BlLl9ub2RlIG5vdCBkZWZpbmVkJyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQkJIi0wMiI6ICgobm9kZSkgPT4gewoKCQkJCQlsZXQgYW5zd2VyID0KCgkJCQkJCXR5cGVvZihvU2NvcGUuX19icm9rZXIpICE9PSAndW5kZWZpbmVkJwoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ2xpc3RlbicsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgIi0wMiIsIGFuc3dlcik7CgkJCQkJcmV0dXJuIGFuc3dlcjsKCQkJCX0pKG5vZGUpID8gKCdvU2NvcGUuX19icm9rZXIgYWxyZWFkeSBkZWZpbmVkJyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2xpc3RlbicsICdFbnRpdHlPYmplY3QnLCAwLCB7CgkJCQkJCVtrXTogZXJyb3JzW2tdCgkJCQkJfSk7CgkJCQkJZGVsZXRlIGVycm9yc1trXTsKCQkJCX0pOwoJCQkJaWYgKE9iamVjdC52YWx1ZXMoZXJyb3JzKS5sZW5ndGgpIHsKCQkJCQlyZXR1cm4gewoJCQkJCQlfX2V4Y2VwdGlvbjogZXJyb3JzLAoJCQkJCX07CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJCW5vZGUgPSBub2RlIHx8IG9TY29wZS5fbm9kZTsKCgkJCWlmICh0eXBlb2YobXF0dCkgIT09ICd1bmRlZmluZWQnICYmIG5vZGUuX19jb25maWcoJ21xdHQuc2VydmVyJykpIHsKCQkJCWxvZyhgRXN0YWJsaXNoaW5nIGNvbm5lY3Rpb24gd2l0aCBNUVRUIHNlcnZlciBAJHtub2RlLmNvZGUoKX0gJHtub2RlLl9fY29uZmlnKCdtcXR0LnNlcnZlcicpfToke25vZGUuX19jb25maWcoJ21xdHQucG9ydCcpfHw4MDgwfWApOwoJCQkJb1Njb3BlLl9fYnJva2VyID0gbXF0dC5jb25uZWN0KGB3czovLyR7bm9kZS5fX2NvbmZpZygnbXF0dC5zZXJ2ZXInKX06JHtub2RlLl9fY29uZmlnKCdtcXR0LnBvcnQnKXx8ODA4MH0vbXF0dGAsIHsKCQkJCQkvLyBDbGVhbiBzZXNzaW9uCgkJCQkJY2xlYW46IHR5cGVvZihub2RlLl9fY29uZmlnKCdtcXR0LmNsZWFuJykpICE9PSAndW5kZWZpbmVkJyA/IG5vZGUuX19jb25maWcoJ21xdHQuY2xlYW4nKSA6IHRydWUsCgkJCQkJY29ubmVjdFRpbWVvdXQ6IG5vZGUuX19jb25maWcoJ21xdHQuY29ubmVjdFRpbWVvdXQnKSB8fCA0MDAwLAoJCQkJCS8vIEF1dGhlbnRpY2F0aW9uCgkJCQkJY2xpZW50SWQ6IG5vZGUuX19jb25maWcoJ21xdHQuY2xpZW50SWQnKSB8fCBub2RlLmNvZGUoKSwKCQkJCQkvL3JlY29ubmVjdFBlcmlvZDogbm9kZS5fX2NvbmZpZygnbXF0dC51c2VybmFtZScpLAoJCQkJCXVzZXJuYW1lOiBub2RlLl9fY29uZmlnKCdtcXR0LnVzZXJuYW1lJyksCgkJCQkJcGFzc3dvcmQ6IG5vZGUuX19jb25maWcoJ21xdHQucGFzc3dvcmQnKSwKCQkJCX0pOwoJCQkJb1Njb3BlLl9fYnJva2VyLm9uKCdjb25uZWN0JywgKCkgPT4gb1Njb3BlLl9fYnJva2VyLnN1YnNjcmliZSh0aGlzLlNjb3BlKSk7CgkJCQlvU2NvcGUuX19icm9rZXIuc3RyZWFtLm9uKCdlcnJvcicsIGVyID0+IG9TY29wZS5fX2Jyb2tlci5lbmQoKSk7CgkJCQlvU2NvcGUuX19icm9rZXIub24oJ21lc3NhZ2UnLCAodG9waWMsIG1lc3NhZ2UpID0+IHsKCQkJCQlsZXQgbXNnID0gSlNPTi5wYXJzZShtZXNzYWdlLnRvU3RyaW5nKCkpOwoJCQkJCS8vbG9nKCJNUVRUIE1lc3NhZ2UiLCBtc2cpOwoJCQkJCW5ldyBvU2NvcGUuRXZlbnQoKS5fZnJvbURvY3VtZW50KG1zZykuX2RlUmVmZXJlbmNlKCkucHJvY2VzcygpOwoJCQkJfSk7CgkJCX0gZWxzZSBpZiAodHlwZW9mKGdsb2JhbCkgPT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZihpbykgIT09ICJ1bmRlZmluZWQiICYmIG5vZGUucGFyZW50KCkuYWRkcmVzcygpKSB7CgkJCQlsb2coYEVzdGFibGlzaGluZyBTb2NrZXQuSU8gd2l0aCBuZXcgUGFyZW50ICR7bm9kZS5fcGFyZW50Ll9hZGRyZXNzfToke25vZGUuX3BhcmVudC5fcG9ydHx8MzAwMH1gKTsKCQkJCW9TY29wZS5fX2Jyb2tlciA9IGlvKGAke25vZGUuX3BhcmVudC5fYWRkcmVzc306JHtub2RlLl9wYXJlbnQuX3BvcnR8fDMwMDB9YCwgewoJCQkJCXRyYW5zcG9ydHM6IFsnd2Vic29ja2V0J10sCgkJCQkJcmVjb25uZWN0aW9uOiBmYWxzZSwKCQkJCQlxdWVyeTogYF9ub2RlPSR7bm9kZS5fY29kZX0mX2RhdGU9JHtzci5zZXJ2ZXJEYXRlKCkudG9VVENTdHJpbmcoKX1gCgkJCQl9KTsKCQkJCW9TY29wZS5fX2Jyb2tlci5vbih0aGlzLm5hbWUoKSwgZSA9PiBuZXcgb1Njb3BlLkV2ZW50KCkuX2Zyb21Eb2N1bWVudChlKS5fZGVSZWZlcmVuY2UoKS5wcm9jZXNzKCkpOwoJCQkJb1Njb3BlLl9fYnJva2VyLm9uKCJkaXNjb25uZWN0IiwgcmVhc29uID0+IHsKCQkJCQlsb2coIkRpc2Nvbm5lY3RlZCB3aXRoIHJlYXNvbjogIiArIHJlYXNvbik7CgkJCQl9KTsKCQkJfSBlbHNlIGlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHNvY2tldGlvKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCW9TY29wZS5fX2Jyb2tlciA9IG5ldyBzb2NrZXRpby5TZXJ2ZXIoZ2xvYmFsLmV4U2VydmVyKTsKCgkJCQlvU2NvcGUuZXZlbnRFbWl0dGVyID0gbmV3IGV2ZW50cy5FdmVudEVtaXR0ZXIoKTsKCgkJCQlsb2coIlN0YXJ0aW5nIFNvY2tldElPIHNlcnZlciIpOwoJCQkJb1Njb3BlLl9fYnJva2VyLm9uKCdjb25uZWN0aW9uJywgc29ja2V0ID0+IHsKCQkJCQlsZXQgcGFyYW0gPSBzb2NrZXQuaGFuZHNoYWtlLnF1ZXJ5OwoJCQkJCWlmICghcGFyYW0uX25vZGUgfHwgIXBhcmFtLl9kYXRlKSByZXR1cm47CgoJCQkJCW9TY29wZS5fX3NvY2tldHMgPSBvU2NvcGUuX19zb2NrZXRzIHx8IHt9OwoJCQkJCW9TY29wZS5fX3NvY2tldHNbc29ja2V0LmhhbmRzaGFrZS5xdWVyeS5fbm9kZV0gPSBzb2NrZXQ7CgkJCQkJT2JqZWN0LmtleXMob1Njb3BlLl9fc29ja2V0cykuZm9yRWFjaChuID0+IHsKCQkJCQkJaWYgKCFvU2NvcGUuX19zb2NrZXRzW25dLmNvbm5lY3RlZCkgZGVsZXRlIG9TY29wZS5fX3NvY2tldHNbbl07CgkJCQkJfSk7CgkJCQkJbG9nKCdTb2NrZXRzIGNvbm5lY3RlZCBbJyArIE9iamVjdC5rZXlzKG9TY29wZS5fX3NvY2tldHMpLmxlbmd0aCArICddLCBMYXN0ZXN0OiAnICsgc29ja2V0LmhhbmRzaGFrZS5xdWVyeS5fbm9kZSArICcoJyArIHNvY2tldC5pZCArICcpJyk7CgkJCQkJb1Njb3BlLl9fc29ja2V0c1tzb2NrZXQuaGFuZHNoYWtlLnF1ZXJ5Ll9ub2RlXS5vbih0aGlzLm5hbWUoKSwgZSA9PiBuZXcgb1Njb3BlLkV2ZW50KCkuX2Zyb21Eb2N1bWVudChlKS5fZGVSZWZlcmVuY2UoKS5wcm9jZXNzKCkpOwoJCQkJfSwgewoJCQkJCWNvcnM6IHsKCQkJCQkJb3JpZ2luOiAiKiIsCgkJCQkJCW1ldGhvZHM6IFsiR0VUIiwgIlBPU1QiXSwKCQkJCQl9CgkJCQl9KTsKCQkJfSBlbHNlIGlmICh0eXBlb2YoQnJvYWRjYXN0Q2hhbm5lbCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQlsb2coIlN0YXJ0aW5nIEJyb2FkY2FzdENoYW5uZWwgLSAiICsgdGhpcy5TY29wZSk7CgkJCQlvU2NvcGUuX19icm9rZXIgPSBuZXcgQnJvYWRjYXN0Q2hhbm5lbCh0aGlzLlNjb3BlKTsKCQkJCW9TY29wZS5fX2Jyb2tlci5vbm1lc3NhZ2UgPSBlID0+IG5ldyBvU2NvcGUuRXZlbnQoKS5fZnJvbURvY3VtZW50KGUuZGF0YSkuX2RlUmVmZXJlbmNlKCkucHJvY2VzcygpOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihuYXZpZ2F0b3Iuc2VydmljZVdvcmtlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQlsb2coIldvcmtlciBFdmVudCBQcm9jZXNzaW5nIik7CgkJCQlvU2NvcGUuX19icm9rZXIgPSBuYXZpZ2F0b3Iuc2VydmljZVdvcmtlci5jb250cm9sbGVyOwoJCQkJYWRkRXZlbnRMaXN0ZW5lcih0aGlzLm5hbWUoKSwgZSA9PiBuZXcgb1Njb3BlLkV2ZW50KCkuX2Zyb21Eb2N1bWVudChlKS5fZGVSZWZlcmVuY2UoKS5wcm9jZXNzKCkpOwoJCQl9IGVsc2UgewoJCQkJbG9nKCJObyBFdmVudCBCcmlkZ2UgYXZhaWxhYmxlIiwgdGhpcy5Ub29sLm5hbWUpOwoJCQl9CgoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10sCgkJCW5vZGU6IG5vZGUKCQl9KTsKCgkJLy8gdGFrZSBvdXQgdGhlIGludmFsaWQgbm9kZSByZXN1bHRzCgkJcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gciAmJiByLnJldCk7CgoJCS8vIGhhcyBhbnkgbm9kZSBnZW5lcmF0ZWQgYSB2YWxpZGF0aW9uIGV4Y2VwdGlvbj8KCQlsZXQgX19leCA9IHJlc3VsdHMuZmluZChyID0+IHIucmV0Ll9fZXhjZXB0aW9uKTsKCQlpZiAoX19leCkgcmV0dXJuIF9fZXgucmV0OwoKCQlyZXR1cm4gcmVzdWx0cy5sZW5ndGggPyByZXN1bHRzWzBdLnJldCA6IG51bGw7CgoJfQoKCS8qKgoJICogU3VtbWFyeS4gdHJpZ2dlci4KCSAqCgkgKiBEZXNjcmlwdGlvbi4gLgoJICoKCSAqIEBzaW5jZSAgICAgIHgueC54CgkgKiBAZGVwcmVjYXRlZCB4LngueCBVc2UgbmV3X2Z1bmN0aW9uX25hbWUoKSBpbnN0ZWFkLgoJICogQGFjY2VzcyAgICAgcHVibGljCgkgKgoJICogQGNsYXNzCgkgKiBAYXVnbWVudHMgcGFyZW50CgkgKiBAbWl4ZXMgICAgbWl4aW4KCSAqCgkgKiBAYWxpYXMgICAgcmVhbE5hbWUKCSAqIEBtZW1iZXJvZiBuYW1lc3BhY2UKCSAqCgkgKiBAc2VlICBGdW5jdGlvbi9jbGFzcyByZWxpZWQgb24KCSAqIEBsaW5rIFVSTAoJICogQGdsb2JhbAoJICoKCSAqIEBmaXJlcyAgIGV2ZW50TmFtZQoJICogQGZpcmVzICAgY2xhc3NOYW1lI2V2ZW50TmFtZQoJICogQGxpc3RlbnMgZXZlbnQ6ZXZlbnROYW1lCgkgKiBAbGlzdGVucyBjbGFzc05hbWV+ZXZlbnQ6ZXZlbnROYW1lCgkgKiBAcGFyYW0ge3R5cGV9ICAgdmFyICAgICAgICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyXSAgICAgICAgIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXI9ZGVmYXVsdF0gRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUgd2l0aCBkZWZhdWx0IHZhcmlhYmxlLgoJICogQHBhcmFtIHtPYmplY3R9IG9iamVjdFZhciAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgb2JqZWN0VmFyLmtleSBEZXNjcmlwdGlvbiBvZiBhIGtleSBpbiB0aGUgb2JqZWN0VmFyIHBhcmFtZXRlci4KCSAqCgkgKiBAeWllbGQge3R5cGV9IFlpZWxkZWQgdmFsdWUgZGVzY3JpcHRpb24uCgkgKgoJICogQHJldHVybiB7dHlwZX0gUmV0dXJuIHZhbHVlIGRlc2NyaXB0aW9uLgoJICovCglhc3luYyB0cmlnZ2VyKCkgewoKCQlsZXQgYW5zd2VyID0gbnVsbDsKCgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidHJpZ2dlciIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ0cmlnZ2VyIiwgX25vZGUsICkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidHJpZ2dlciIsICkgPT4gewoKCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkV2ZW50LnRyaWdnZXInKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQkJIjAxIjogKCgpID0+IHsKCgkJCQkJbGV0IGFuc3dlciA9CgoJCQkJCQkhdGhpcy5fc2VuZGVyX3NldCB8fCAhdGhpcy5zZW5kZXIoKQoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ3RyaWdnZXInLCAnRW50aXR5T2JqZWN0JywgMCwgImFuc3dlciIsICIwMSIsIGFuc3dlcik7CgkJCQkJcmV0dXJuIGFuc3dlcjsKCQkJCX0pKCkgPyAoJ05vIFNlbmRlcicgfHwgJ1ZhbGlkYXRpb24gRXJyb3InKSA6ICcnLAoKCQkJCSIwMiI6ICgoKSA9PiB7CgoJCQkJCWxldCBhbnN3ZXIgPQoKCQkJCQkJIXRoaXMuX3JlY2lwaWVudF9zZXQgfHwgIXRoaXMucmVjaXBpZW50KCkKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICd0cmlnZ2VyJywgJ0VudGl0eU9iamVjdCcsIDAsICJhbnN3ZXIiLCAiMDIiLCBhbnN3ZXIpOwoJCQkJCXJldHVybiBhbnN3ZXI7CgkJCQl9KSgpID8gKCdObyBwcm9jZXNzaW5nIG9mIEV2ZW50cyB3aXRob3V0IHJlY2lwaWVudCcgfHwgJ1ZhbGlkYXRpb24gRXJyb3InKSA6ICcnLAoKCQkJfTsKCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiAhZXJyb3JzW2tdKS5mb3JFYWNoKGsgPT4gZGVsZXRlIGVycm9yc1trXSk7CgkJCWlmIChPYmplY3Qua2V5cyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJy0nKSkuZm9yRWFjaChrID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0cmlnZ2VyJywgJ0VudGl0eU9iamVjdCcsIDAsIHsKCQkJCQkJW2tdOiBlcnJvcnNba10KCQkJCQl9KTsKCQkJCQlkZWxldGUgZXJyb3JzW2tdOwoJCQkJfSk7CgkJCQlpZiAoT2JqZWN0LnZhbHVlcyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJCXJldHVybiB7CgkJCQkJCV9fZXhjZXB0aW9uOiBlcnJvcnMsCgkJCQkJfTsKCQkJCX0KCQkJCXJldHVybjsKCQkJfQoKCQkJbGV0IHBheWxvYWQgPSBudWxsOwoKCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAidW5kZWZpbmVkIiAmJiBvU2NvcGUuX19zb2NrZXRzKSB7CgkJCQlpZiAob1Njb3BlLl9fc29ja2V0c1t0aGlzLnJlY2lwaWVudCgpLmNvZGUoKV0pIHsKCQkJCQlvU2NvcGUuX19zb2NrZXRzW3RoaXMucmVjaXBpZW50KCkuY29kZSgpXS5lbWl0KHRoaXMubmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQkJfSBlbHNlIHsKCQkJCQl3YXJuKCJVbmtub3duIG5vZGUgaW4gc29ja2V0cyBsaXN0ICIgKyB0aGlzLnJlY2lwaWVudCgpLl9jb2RlKTsKCQkJCX0KCQkJfSBlbHNlIGlmIChvU2NvcGUuX19icm9rZXIpIHsKCQkJCS8vbG9nKEpTT04uc3RyaW5naWZ5KGRvYywgbnVsbCwgNCkpCgkJCQlpZiAob1Njb3BlLl9fYnJva2VyLmVtaXQpIG9TY29wZS5fX2Jyb2tlci5lbWl0KHRoaXMubmFtZSgpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQkJaWYgKG9TY29wZS5fX2Jyb2tlci5wb3N0TWVzc2FnZSkgb1Njb3BlLl9fYnJva2VyLnBvc3RNZXNzYWdlKEpTT04uc3RyaW5naWZ5KHRoaXMuX3RvRG9jdW1lbnQoKSkpOwoJCQkJaWYgKG9TY29wZS5fX2Jyb2tlci5wdWJsaXNoKSBvU2NvcGUuX19icm9rZXIucHVibGlzaCh0aGlzLlNjb3BlLCBKU09OLnN0cmluZ2lmeSh0aGlzLl90b0RvY3VtZW50KCkpLCB7CgkJCQkJcW9zOiAwLAoJCQkJCXJldGFpbjogZmFsc2UKCQkJCX0sIGVyciA9PiBlcnIgPyBlcnJvcihlcnIpIDogbnVsbCk7CgkJCX0gZWxzZSB7CgkJCQlhd2FpdCB0aGlzLmNhcnJpZXIob1Njb3BlLl9ub2RlKS5zdG9yZSgpOwoJCQkJbG9nKCJDYW5ub3QgdHJpZ2dlciBkaXJlY3RseSwgaW5zZXJ0ZWQgdG8gVG9vbDogIiArIHRoaXMuVG9vbC50eXBlLm5hbWUgKyAiLyIgKyB0aGlzLmNvZGUoKSk7CgoJCQkJLy8gd2FpdCB1bnRpbCB0aGUgZXZlbnQgaXMgcHJvY2Vzc2VkIHdpdGggYW5vdGhlciBldmVudAoJCQkJaWYgKCF0aGlzLnJlc3BvbnNlVG8oKSkgYXdhaXQgdGhpcy5zZXRJbnRlcnZhbChhc3luYyAoIC8qcmVzcG9uc2UgcG9sbGluZyovICkgPT4gewoJCQkJCWlmICghb1Njb3BlLl9ub2RlKSByZXR1cm47CgoJCQkJCWxvZygiUG9sbGluZyAiICsgdGhpcy5Ub29sLnR5cGUubmFtZSArICIgZm9yIHJlc3BvbnNlIGV2ZW50IHRvICIgKyB0aGlzLmNvZGUoKSk7CgkJCQkJdHJ5IHsKCQkJCQkJcGF5bG9hZCA9IChhd2FpdCBuZXcgb1Njb3BlLkV2ZW50KCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkucmVzcG9uc2VUbyh0aGlzKQoJCQkJCQkJLyouc2VuZGVyKG9TY29wZS5fbm9kZSwgJyE9JykucmVjaXBpZW50KG9TY29wZS5fbm9kZSkqLwoJCQkJCQkJLmZpbmQoKSkucGF5bG9hZCgpOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCS8vIHdhcm4oZXgpOwoJCQkJCQlyZXR1cm4gdHJ1ZTsgLy8ga2VlcCBsb29waW5nCgkJCQkJfQoJCQkJfSwgMC4zKTsKCQkJfQoKCQkJaWYgKHRoaXMucmVzcG9uc2VUbygpKSB7CgkJCQlsb2coInJlc3BvbnNlVG8gaXMgc2V0IGZvciAiICsgdGhpcy5jb2RlKCkgKyAiOiAiICsgdGhpcy5yZXNwb25zZVRvKCkuY29kZSgpICsgIiwgcmV0dXJuaW5nIik7CgkJCQlyZXR1cm47CgkJCX0KCgkJCWlmICghcGF5bG9hZCkgcGF5bG9hZCA9IGF3YWl0IG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHsKCQkJCWlmICghb1Njb3BlLl9ub2RlKSByZXNvbHZlKG51bGwpOwoJCQkJbG9nKCJXYWl0aW5nIGZvciBwcm9jZXNzaW5nIG9mICIgKyB0aGlzLmNsYXNzTmFtZSgpICsgIi4iICsgdGhpcy5tZXRob2QoKSArICIoIiArIHRoaXMuY29kZSgpICsgIikiKTsKCgkJCQlsZXQgYk9uY2UgPSBmYWxzZTsgLy90aGlzLnJlY2lwaWVudCgpLl9jb2RlX3NldD90cnVlOmZhbHNlOwoJCQkJaWYgKCFiT25jZSkgewoJCQkJCXRoaXMuYXJSZXNwb25zZXMgPSB0aGlzLmFyUmVzcG9uc2VzIHx8IFtdOwoJCQkJCXRoaXMuX3dhaXQodGhpcy5fX2NvbmZpZygndHJpZ2dlci50aW1lb3V0JywgNTAwMCkpLnRoZW4oKCkgPT4gewoJCQkJCQlsb2coIlRpbWVvdXQgLSBjYW5ub3Qgd2FpdCBubyBtb3JlIG9uICIgKyB0aGlzLmNsYXNzTmFtZSgpICsgIi4iICsgdGhpcy5tZXRob2QoKSArICIoIiArIHRoaXMuY29kZSgpICsgIikiKTsKCQkJCQkJcmVzb2x2ZSh0aGlzLmFyUmVzcG9uc2VzKTsKCQkJCQl9KTsKCQkJCX0KCgkJCQlsZXQgaGFuZGxlciA9IChldiwgcmVzb2x2ZSwgcmVqZWN0KSA9PiB7CgkJCQkJbG9nKCJHb3QgcmVzcG9uc2UgZnJvbSBwcm9jZXNzKCIgKyB0aGlzLmNvZGUoKSArICIpIiwgZXYucGF5bG9hZCk7CgkJCQkJaWYgKHRoaXMucmVjaXBpZW50KCkuX2NvZGVfc2V0IC8qYk9uY2UqLyB8fCAhb1Njb3BlLl9ub2RlKSByZXR1cm4gcmVzb2x2ZShldi5wYXlsb2FkKTsKCgkJCQkJdGhpcy5hclJlc3BvbnNlcy5wdXNoKG5ldyBvU2NvcGUuRXZlbnQoKS5fZnJvbURvY3VtZW50KGV2KSk7CgkJCQl9OwoKCQkJCWlmICh0eXBlb2Yob1Njb3BlLmV2ZW50RW1pdHRlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJb1Njb3BlLmV2ZW50RW1pdHRlclsib24iICsgKGJPbmNlID8gImNlIiA6ICIiKV0odGhpcy5uYW1lKCkgKyAiLiIgKyB0aGlzLmNvZGUoKSwgZSA9PiBoYW5kbGVyKGUsIHJlc29sdmUsIHJlamVjdCkpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoYWRkRXZlbnRMaXN0ZW5lcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJYWRkRXZlbnRMaXN0ZW5lcih0aGlzLm5hbWUoKSArICIuIiArIHRoaXMuY29kZSgpLCBlID0+IGhhbmRsZXIoZS5kZXRhaWwsIHJlc29sdmUsIHJlamVjdCksIHsKCQkJCQkJb25jZTogYk9uY2UKCQkJCQl9KTsKCQkJCX0KCQkJfSk7CgoJCQlyZXR1cm4gcGF5bG9hZDsKCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXSwKCQl9KTsKCgkJLy8gdGFrZSBvdXQgdGhlIGludmFsaWQgbm9kZSByZXN1bHRzCgkJcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gciAmJiByLnJldCk7CgoJCS8vIGhhcyBhbnkgbm9kZSBnZW5lcmF0ZWQgYSB2YWxpZGF0aW9uIGV4Y2VwdGlvbj8KCQlsZXQgX19leCA9IHJlc3VsdHMuZmluZChyID0+IHIucmV0Ll9fZXhjZXB0aW9uKTsKCQlpZiAoX19leCkgcmV0dXJuIF9fZXgucmV0OwoKCQlyZXR1cm4gcmVzdWx0cy5sZW5ndGggPyByZXN1bHRzWzBdLnJldCA6IG51bGw7CgoJfQoKCS8qKgoJICogU3VtbWFyeS4gcHJvY2Vzcy4KCSAqCgkgKiBEZXNjcmlwdGlvbi4gLgoJICoKCSAqIEBzaW5jZSAgICAgIHgueC54CgkgKiBAZGVwcmVjYXRlZCB4LngueCBVc2UgbmV3X2Z1bmN0aW9uX25hbWUoKSBpbnN0ZWFkLgoJICogQGFjY2VzcyAgICAgcHVibGljCgkgKgoJICogQGNsYXNzCgkgKiBAYXVnbWVudHMgcGFyZW50CgkgKiBAbWl4ZXMgICAgbWl4aW4KCSAqCgkgKiBAYWxpYXMgICAgcmVhbE5hbWUKCSAqIEBtZW1iZXJvZiBuYW1lc3BhY2UKCSAqCgkgKiBAc2VlICBGdW5jdGlvbi9jbGFzcyByZWxpZWQgb24KCSAqIEBsaW5rIFVSTAoJICogQGdsb2JhbAoJICoKCSAqIEBmaXJlcyAgIGV2ZW50TmFtZQoJICogQGZpcmVzICAgY2xhc3NOYW1lI2V2ZW50TmFtZQoJICogQGxpc3RlbnMgZXZlbnQ6ZXZlbnROYW1lCgkgKiBAbGlzdGVucyBjbGFzc05hbWV+ZXZlbnQ6ZXZlbnROYW1lCgkgKiBAcGFyYW0ge3R5cGV9ICAgdmFyICAgICAgICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyXSAgICAgICAgIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXI9ZGVmYXVsdF0gRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUgd2l0aCBkZWZhdWx0IHZhcmlhYmxlLgoJICogQHBhcmFtIHtPYmplY3R9IG9iamVjdFZhciAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgb2JqZWN0VmFyLmtleSBEZXNjcmlwdGlvbiBvZiBhIGtleSBpbiB0aGUgb2JqZWN0VmFyIHBhcmFtZXRlci4KCSAqCgkgKiBAeWllbGQge3R5cGV9IFlpZWxkZWQgdmFsdWUgZGVzY3JpcHRpb24uCgkgKgoJICogQHJldHVybiB7dHlwZX0gUmV0dXJuIHZhbHVlIGRlc2NyaXB0aW9uLgoJICovCglhc3luYyBwcm9jZXNzKCkgewoKCQlsZXQgYW5zd2VyID0gbmV3IHNhbGVzbm93LkV2ZW50KCk7CgoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInByb2Nlc3MiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAicHJvY2VzcyIsIF9ub2RlLCApID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInByb2Nlc3MiLCApID0+IHsKCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5FdmVudC5wcm9jZXNzJyk7CgoJCQl2YXIgZXJyb3JzID0gewoKCQkJCSIwMSI6ICgoKSA9PiB7CgoJCQkJCWxldCBhbnN3ZXIgPQoKCQkJCQkJIXRoaXMuX3NlbmRlcl9zZXQgfHwgIXRoaXMuc2VuZGVyKCkKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdwcm9jZXNzJywgJ0VudGl0eU9iamVjdCcsIDAsICJhbnN3ZXIiLCAiMDEiLCBhbnN3ZXIpOwoJCQkJCXJldHVybiBhbnN3ZXI7CgkJCQl9KSgpID8gKCdObyBTZW5kZXInIHx8ICdWYWxpZGF0aW9uIEVycm9yJykgOiAnJywKCgkJCQkiMDIiOiAoKCkgPT4gewoKCQkJCQlsZXQgYW5zd2VyID0KCgkJCQkJCSF0aGlzLl9yZWNpcGllbnRfc2V0IHx8ICF0aGlzLnJlY2lwaWVudCgpCgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAncHJvY2VzcycsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgIjAyIiwgYW5zd2VyKTsKCQkJCQlyZXR1cm4gYW5zd2VyOwoJCQkJfSkoKSA/ICgnTm8gUmVjaXBpZW50JyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQkJIjA0IjogKCgpID0+IHsKCgkJCQkJbGV0IGFuc3dlciA9CgoJCQkJCQlvU2NvcGUuX25vZGUuX3NhbWVOb2RlKHRoaXMuc2VuZGVyKCkpCgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAncHJvY2VzcycsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgIjA0IiwgYW5zd2VyKTsKCQkJCQlyZXR1cm4gYW5zd2VyOwoJCQkJfSkoKSA/ICgnU2VudCBieSBteXNlbGYnIHx8ICdWYWxpZGF0aW9uIEVycm9yJykgOiAnJywKCgkJCQkiMDUiOiAoKCkgPT4gewoKCQkJCQlsZXQgYW5zd2VyID0KCgkJCQkJCSFvU2NvcGUuX25vZGUuX3NhbWVOb2RlKHRoaXMucmVjaXBpZW50KCkpICYmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgfHwgKG9TY29wZS5fX3NvY2tldHMgJiYgIW9TY29wZS5fX3NvY2tldHNbdGhpcy5yZWNpcGllbnQoKS5jb2RlKCldKSkKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdwcm9jZXNzJywgJ0VudGl0eU9iamVjdCcsIDAsICJhbnN3ZXIiLCAiMDUiLCBhbnN3ZXIpOwoJCQkJCXJldHVybiBhbnN3ZXI7CgkJCQl9KSgpID8gKCdJZ25vcm5pbmcgcmVjaXBpZW50JyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3Byb2Nlc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgewoJCQkJCQlba106IGVycm9yc1trXQoJCQkJCX0pOwoJCQkJCWRlbGV0ZSBlcnJvcnNba107CgkJCQl9KTsKCQkJCWlmIChPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIHsKCQkJCQkJX19leGNlcHRpb246IGVycm9ycywKCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlpZiAoIW9TY29wZS5fbm9kZS5wYXJlbnQoKS5hZGRyZXNzKCkpIHRoaXMuc2VuZGVyKCkuc3RvcmUoKTsKCgkJCWlmICh0aGlzLnJlc3BvbnNlVG8oKSkgewoJCQkJLy8gcmVzcG9uZGluZyB0byBhIHByZXZpb3VzIGV2ZW50CgkJCQlsb2coIkRpc3BhdGNoaW5nIGZvciAiICsgdGhpcy5yZXNwb25zZVRvKCkuY29kZSgpKTsKCQkJCWlmICh0eXBlb2YoZGlzcGF0Y2hFdmVudCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJZGlzcGF0Y2hFdmVudChuZXcgQ3VzdG9tRXZlbnQodGhpcy5uYW1lKCkgKyAiLiIgKyB0aGlzLnJlc3BvbnNlVG8oKS5jb2RlKCksIHsKCQkJCQkJZGV0YWlsOiB0aGlzLl90b0RvY3VtZW50KHRydWUsIHRydWUpCgkJCQkJfSkpOwoJCQkJfSBlbHNlIGlmICh0eXBlb2Yob1Njb3BlLmV2ZW50RW1pdHRlcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJbG9nKCJEaXNwYXRjaGVkIHRocm91Z2ggZXZlbnRFbWl0dGVyIikKCQkJCQlvU2NvcGUuZXZlbnRFbWl0dGVyLmVtaXQodGhpcy5uYW1lKCkgKyAiLiIgKyB0aGlzLnJlc3BvbnNlVG8oKS5jb2RlKCksIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSwgdHJ1ZSkpOwoJCQkJfQoJCQl9IGVsc2UgaWYgKCFvU2NvcGUuX25vZGUuX3NhbWVOb2RlKHRoaXMucmVjaXBpZW50KCkpKSB7CgkJCQlsb2coIkV2ZW50IG5vdCBhZGRyZXNzZWQgdG8gbWUsIGNoZWNraW5nLi4uIiwgdGhpcy5yZWNpcGllbnQoKS5jb2RlKCkpOwoJCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAidW5kZWZpbmVkIiAmJiBvU2NvcGUuX19zb2NrZXRzICYmIG9TY29wZS5fX3NvY2tldHNbdGhpcy5yZWNpcGllbnQoKS5jb2RlKCldKSB7CgkJCQkJbG9nKCJGb3J3YXJkaW5nIHRvIHRoZSByZWdpc3RlcmVkIG5vZGUiLCB0aGlzLnJlY2lwaWVudCgpLmNvZGUoKSk7CgkJCQkJcmV0dXJuIGF3YWl0IHRoaXMuZm9yd2FyZCgpOwoJCQkJfSBlbHNlIGlmICghdGhpcy5yZWNpcGllbnQoKS5fY29kZV9zZXQpIHsKCQkJCQkvLyByZWNpcGllbnQgaXMgYSBxdWVyeSB0byBtYXRjaCBub2RlcwoJCQkJCWxvZygiUXVlcnk6IFdobyBzaG91bGQgcGljayB0aGlzIHVwPyIpOwoJCQkJCWxldCBxTm9kZXMgPSBhd2FpdCB0aGlzLnJlY2lwaWVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmZpbmRBbGwoKTsKCQkJCQlsZXQgbXlOb2RlcyA9IFtvU2NvcGUuX25vZGVdOwoJCQkJCWlmICh0eXBlb2YoZ2xvYmFsKSAhPT0gInVuZGVmaW5lZCIgJiYgb1Njb3BlLl9fc29ja2V0cykgbXlOb2RlcyA9IG15Tm9kZXMuY29uY2F0KE9iamVjdC5rZXlzKG9TY29wZS5fX3NvY2tldHMpLm1hcChzID0+IG5ldyBvU2NvcGUuTm9kZSgpLmNvZGUocykpKTsKCQkJCQlxTm9kZXMgPSBxTm9kZXMuZmlsdGVyKHIgPT4gbXlOb2Rlcy5maW5kKG4gPT4gbi5fc2FtZU5vZGUocikpKS5maWx0ZXIobiA9PiAhbi5fc2FtZU5vZGUodGhpcy5zZW5kZXIoKSkpOwoJCQkJCWlmICghcU5vZGVzLmxlbmd0aCkgewoJCQkJCQlsb2coIlF1ZXJ5OiBObyBtYXRjaGVzIGZvdW5kLCBpZ25vcmluZy4uLiIpOwoJCQkJCQlpZiAodHlwZW9mKHJlamVjdCkgIT09ICJ1bmRlZmluZWQiKSByZWplY3QoKTsKCQkJCQkJcmV0dXJuOwoJCQkJCX0KCgkJCQkJZm9yIGF3YWl0IChjb25zdCByIG9mIHFOb2RlcykgewoJCQkJCQlsZXQgZXZGcm9tID0gbmV3IG9TY29wZS5FdmVudCgpLmNhcnJpZXIob1Njb3BlLl9ub2RlKS5zZW5kZXIocikucmVzcG9uc2VUbyh0aGlzKTsKCQkJCQkJaWYgKHRoaXMuX2NsYXNzTmFtZV9zZXQpIGV2RnJvbS5jbGFzc05hbWUodGhpcy5jbGFzc05hbWUoKSk7CgoJCQkJCQlsb2coImludm9raW5nICIgKyByLmNvZGUoKSArICIgYW5kIHJlcGx5aW5nIHRvICIgKyB0aGlzLnNlbmRlcigpLmNvZGUoKSk7CgkJCQkJCWxldCBwYXlsb2FkID0gYXdhaXQgb1Njb3BlLl9ub2RlLl9pbnZva2VOb2RlKHIsIHRoaXMubWV0aG9kKCksIHRoaXMucGF5bG9hZCgpLCB0aGlzLl9jbGFzc05hbWVfc2V0ID8gbmV3IG9TY29wZS5FdmVudCgpLmNsYXNzTmFtZSh0aGlzLmNsYXNzTmFtZSgpKSA6IHVuZGVmaW5lZCwgdHJ1ZSk7CgkJCQkJCS8vIGxvZygiUGF5bG9hZCBbIiArIHIuY29kZSgpICsgIl0iLCBwYXlsb2FkKTsKCQkJCQkJYXdhaXQgdGhpcy5faW52b2tlTm9kZSh0aGlzLnNlbmRlcigpLCB0aGlzLm1ldGhvZCgpLCBwYXlsb2FkLCBldkZyb20pOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJd2FybigiTm8ga25vd24gbm9kZSB0byBmb3J3YXJkIHRvIiwgb1Njb3BlLl9ub2RlLmNvZGUoKSwgdGhpcy5yZWNpcGllbnQoKS5jb2RlKCkpOwoJCQkJCXJldHVybiBudWxsOwoJCQkJfQoJCQl9IGVsc2UgewoJCQkJbG9nKCJFeGVjdXRpbmcgRXZlbnQgbG9jYWxseTogIiArIHRoaXMuY2xhc3NOYW1lKCkgKyAiLiIgKyB0aGlzLm1ldGhvZCgpICsgIigpIC0gIiArIHRoaXMuY29kZSgpKTsKCgkJCQlsZXQgZXZUbyA9IHRoaXMuX2NsYXNzTmFtZV9zZXQgPyBuZXcgb1Njb3BlLkV2ZW50KCkuY2xhc3NOYW1lKHRoaXMuY2xhc3NOYW1lKCkpIDogdW5kZWZpbmVkOwoJCQkJcmV0dXJuIGF3YWl0IHRoaXMuX2ludm9rZU5vZGUodGhpcy5zZW5kZXIoKSwgdGhpcy5tZXRob2QoKSwgYXdhaXQgdGhpcy5faW52b2tlTm9kZShvU2NvcGUuX25vZGUsIHRoaXMubWV0aG9kKCksIHRoaXMucGF5bG9hZCgpLCBldlRvLCB0cnVlKSwgZXZUby5yZXNwb25zZVRvKHRoaXMpKTsKCQkJfQoKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdLAoJCX0pOwoKCQkvLyB0YWtlIG91dCB0aGUgaW52YWxpZCBub2RlIHJlc3VsdHMKCQlyZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByICYmIHIucmV0KTsKCgkJLy8gaGFzIGFueSBub2RlIGdlbmVyYXRlZCBhIHZhbGlkYXRpb24gZXhjZXB0aW9uPwoJCWxldCBfX2V4ID0gcmVzdWx0cy5maW5kKHIgPT4gci5yZXQuX19leGNlcHRpb24pOwoJCWlmIChfX2V4KSByZXR1cm4gX19leC5yZXQ7CgoJCXJldHVybiByZXN1bHRzLmxlbmd0aCA/IHJlc3VsdHNbMF0ucmV0IDogbnVsbDsKCgl9CgoJYXN5bmMgX3Jlc3QodE5hbWUgPSB0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyA9IHt9KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcih1bmRlZmluZWQsIHRoaXMuVG9vbCkuX3Jlc3QodGhpcy5fbkNvZGUoKSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMpOwoKCX0KCglfdG9TUUxUYWJsZSgpIHsKCQlsZXQgcmV0ID0gewoJCQlzcWw6IGBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9ICgKICAgICAgICAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NsYXNzTmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdtZXRob2QnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncGF5bG9hZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY2FycmllcicsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3NlbmRlcicsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlY2lwaWVudCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3Jlc3BvbnNlVG8nLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgYAoJCX07CgkJcmV0LnNxbCArPSAnLypFdmVudCovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJjbGFzc05hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NsYXNzTmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJtZXRob2QiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbWV0aG9kJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ21ldGhvZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJwYXlsb2FkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3BheWxvYWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncGF5bG9hZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiY2FycmllciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYXJyaWVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NhcnJpZXInLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJInNlbmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzZW5kZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc2VuZGVyJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJyZWNpcGllbnQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVjaXBpZW50JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlY2lwaWVudCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkicmVzcG9uc2VUbyI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZXNwb25zZVRvJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3Jlc3BvbnNlVG8nLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCXJlc3BvbnNlVG9fRXZlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVzcG9uc2VUb19FdmVudHMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypFdmVudCovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjbGFzc05hbWUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNsYXNzTmFtZSh0YWJsZVsiY2xhc3NOYW1lIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm1ldGhvZCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubWV0aG9kKHRhYmxlWyJtZXRob2QiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicGF5bG9hZCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucGF5bG9hZCh0YWJsZVsicGF5bG9hZCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjYXJyaWVyIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5jYXJyaWVyKHRhYmxlWyJjYXJyaWVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInNlbmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuc2VuZGVyKHRhYmxlWyJzZW5kZXIiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVjaXBpZW50IikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5yZWNpcGllbnQodGFibGVbInJlY2lwaWVudCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZXNwb25zZVRvIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5yZXNwb25zZVRvKHRhYmxlWyJyZXNwb25zZVRvIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuYWN0aXZlKHRhYmxlWyJhY3RpdmUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZW5hYmxlZCh0YWJsZVsiZW5hYmxlZCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5jb2RlKHRhYmxlWyJjb2RlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5vcmRlcih0YWJsZVsib3JkZXIiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZGF0ZSh0YWJsZVsiZGF0ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5uYW1lKHRhYmxlWyJuYW1lIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucmVtYXJrKHRhYmxlWyJyZW1hcmsiXSk7CgkJfQoKCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBfc3FsKHNxbCwgc291cmNlID0gdGhpcykgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsKHNxbCwgdGhpcyk7CgoJfQoKCWFzeW5jIF9naXRodWIoZmlsZSwgY29udGVudCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZ2l0aHViKGZpbGUsIGNvbnRlbnQpOwoKCX0KCglfdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgYlN0cmluZykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHsKCQkJW3RoaXMuX25Db2RlKCldOiB7CgkJCQlwYXJhbXM6IHsKCQkJCQl3aGVyZTogewoJCQkJCQlhbmQ6IFtdLAoJCQkJCQlvcjogW10KCQkJCQl9CgkJCQl9LAoJCQkJZWRnZXM6IHsKCQkJCQlub2RlOiB7fQoJCQkJfQoJCQl9CgkJfSwgewoJCQkvL09QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goewoJCQkJSWQ6IHsKCQkJCQllcTogdgoJCQkJfQoJCQl9KSwKCgkJCWNsYXNzTmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NsYXNzTmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQltZXRob2Q6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdtZXRob2QnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJcGF5bG9hZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3BheWxvYWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY2FycmllcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhcnJpZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdOb2RlJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnTm9kZScsIHVuZGVmaW5lZCldLnBhcmFtcy53aGVyZS5hbmQgOiBbXSwKCQkJCQkJCX0sCgkJCQkJCX0KCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlzZW5kZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzZW5kZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdOb2RlJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnTm9kZScsIHVuZGVmaW5lZCldLnBhcmFtcy53aGVyZS5hbmQgOiBbXSwKCQkJCQkJCX0sCgkJCQkJCX0KCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlyZWNpcGllbnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZWNpcGllbnQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdOb2RlJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnTm9kZScsIHVuZGVmaW5lZCldLnBhcmFtcy53aGVyZS5hbmQgOiBbXSwKCQkJCQkJCX0sCgkJCQkJCX0KCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlyZXNwb25zZVRvOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVzcG9uc2VUbycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJewoJCQkJCQkJaW5xOiB7CgkJCQkJCQkJQXBpTmFtZTogJ0lkJywKCQkJCQkJCQlbdGhpcy5fbkNvZGUoJ0V2ZW50JywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnRXZlbnQnLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQkodiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGwpCgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJfSwgIl90b1NGUXVlcnkiKTsKCgkJLy9PYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJaWYgKGJTdHJpbmcpIHsKCQkJcmV0ID0gewoJCQkJcXVlcnk6IHsKCQkJCQlbdGhpcy5fbkNvZGUoKSArICdRdWVyeSddOiB7CgkJCQkJCXVpYXBpOiByZXQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXJldCA9IEpTT04uc3RyaW5naWZ5KHJldCwgbnVsbCwgNCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TRlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU9QRVJBVE9SUzogdHJ1ZSwKCQkJSWQ6IChvYmosIHYpID0+IG9iai5zeXNfaWQgPSB2LAoKCQkJY2xhc3NOYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQltZXRob2Q6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdtZXRob2QnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCXBheWxvYWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwYXlsb2FkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQljYXJyaWVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2FycmllcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b1NOUXVlcnkoKSA6IG51bGw7CgoJCQl9LAoKCQkJc2VuZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc2VuZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCQlyZWNpcGllbnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZWNpcGllbnQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9TTlF1ZXJ5KCkgOiBudWxsOwoKCQkJfSwKCgkJCXJlc3BvbnNlVG86IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZXNwb25zZVRvJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJbGV0IGQgPSBgJHt2LmdldEZ1bGxZZWFyKCl9LSR7KCcwJysodi5nZXRNb250aCgpKzEpKS5zbGljZSgtMil9LSR7di5nZXREYXRlKCl9YDsKCQkJCWxldCB0ID0gYCR7di5nZXRIb3VycygpfToke3YuZ2V0TWludXRlcygpfToke3YuZ2V0U2Vjb25kcygpfWA7CgkJCQlpZiAoKHYuZ2V0SG91cnMoKSA9PSAwICYmIHYuZ2V0TWludXRlcygpID09IDAgJiYgdi5nZXRTZWNvbmRzKCkgPT0gMCkgfHwgdGhpcy5fZGF0ZV9jb29wID09ICc9JyB8fCAhdGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgT04ke2R9QGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9Jywnc3RhcnQnKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ2VuZCcpYDsKCQkJCX0gZWxzZSBpZiAodGhpcy5fZGF0ZV9jb29wICE9PSAnQkVUV0VFTicpIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0KCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCX0sICJfdG9TTlF1ZXJ5Iik7CgoJCU9iamVjdC5rZXlzKHJldC5PUEVSQVRPUlMgfHwge30pLmZpbHRlcihrID0+IHR5cGVvZihyZXRba10pICE9PSAndW5kZWZpbmVkJykuZm9yRWFjaChrID0+IHJldFtrXSA9IHJldC5PUEVSQVRPUlNba10gKyByZXRba10pOwoKCQlkZWxldGUgcmV0Lk9QRVJBVE9SUzsKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJcmV0ID0gRG90T2JqZWN0LmRvdChyZXQpOwoKCQkvLyBhdm9pZCBzZW5kaW5nIHdpdGggbm8gY29tcGFyaXNvbiBvcGVyYXRvcnMKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFbJz4nLCAnPCcsICdCRVRXRUVOJywgJ09OJywgJyEnLCAnPScsICdTVEFSVFNXSVRIJywgJ0xJS0UnXS5zb21lKHMgPT4gU3RyaW5nKHJldFtrXSkuc3RhcnRzV2l0aChzKSkpLmZvckVhY2goayA9PiByZXRba10gPSAodGhpc1tgXyR7a31fY29vcGBdIHx8ICdTVEFSVFNXSVRIJykgKyByZXRba10pOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIE9iamVjdC5lbnRyaWVzKHJldCB8fCB7fSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCWxldCBfcmV0ID0gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCBmYWxzZSwgZnVuLCBlYU9iaiwgb2JqKTsKCQkJCXJldHVybiBfcmV0OwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJjbGFzc05hbWUiLCBvYmosIHRoaXMuY2xhc3NOYW1lKCkpOwoKCQlfb3B0aW9ucygibWV0aG9kIiwgb2JqLCB0aGlzLm1ldGhvZCgpKTsKCgkJX29wdGlvbnMoInBheWxvYWQiLCBvYmosIHRoaXMucGF5bG9hZCgpKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqLCB0aGlzLmNvZGUoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmosIHRoaXMuZGF0ZSgpKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmosIHRoaXMubmFtZSgpKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaiwgdGhpcy5yZW1hcmsoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJkNWMyOGQwZS1iOWU1LTRhOWEtOTc1Zi05ZjliMDA1NDViNGUiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRXZlbnQgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkV2ZW50IHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkV2ZW50W2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkV2ZW50W2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRXZlbnRbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5FdmVudFtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5FdmVudFtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRXZlbnRbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiBvYmosCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIG9iaiwgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIl9USElTIiwgb2JqLCB0aGlzLl9USElTKTsKCgkJaWYgKCF0aGlzLmNhcnJpZXIoKSB8fCAodGhpcy5jYXJyaWVyKCkKCgkJCQkmJgoJCQkJIXRoaXMuY2FycmllcigpLm5vZGVfQ29uZmlncygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jYXJyaWVyKCkuY2Fycmllcl9FdmVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuY2FycmllcigpLnNlbmRlcl9FdmVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuY2FycmllcigpLnJlY2lwaWVudF9FdmVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuY2FycmllcigpLmJhY2t1cF9Ob2RlcygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5jYXJyaWVyKCkucGFyZW50X05vZGVzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmNhcnJpZXIoKS5ub2RlX05vZGVfR3JvdXBfTWVtYmVycygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygiY2FycmllciIsIG9iaiwgdGhpcy5jYXJyaWVyKCkpOwoJCX0KCgkJaWYgKCF0aGlzLnNlbmRlcigpIHx8ICh0aGlzLnNlbmRlcigpCgoJCQkJJiYKCQkJCSF0aGlzLnNlbmRlcigpLm5vZGVfQ29uZmlncygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5zZW5kZXIoKS5jYXJyaWVyX0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5zZW5kZXIoKS5zZW5kZXJfRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnNlbmRlcigpLnJlY2lwaWVudF9FdmVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuc2VuZGVyKCkuYmFja3VwX05vZGVzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnNlbmRlcigpLnBhcmVudF9Ob2RlcygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5zZW5kZXIoKS5ub2RlX05vZGVfR3JvdXBfTWVtYmVycygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygic2VuZGVyIiwgb2JqLCB0aGlzLnNlbmRlcigpKTsKCQl9CgoJCWlmICghdGhpcy5yZWNpcGllbnQoKSB8fCAodGhpcy5yZWNpcGllbnQoKQoKCQkJCSYmCgkJCQkhdGhpcy5yZWNpcGllbnQoKS5ub2RlX0NvbmZpZ3MoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMucmVjaXBpZW50KCkuY2Fycmllcl9FdmVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMucmVjaXBpZW50KCkuc2VuZGVyX0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5yZWNpcGllbnQoKS5yZWNpcGllbnRfRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnJlY2lwaWVudCgpLmJhY2t1cF9Ob2RlcygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5yZWNpcGllbnQoKS5wYXJlbnRfTm9kZXMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMucmVjaXBpZW50KCkubm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoInJlY2lwaWVudCIsIG9iaiwgdGhpcy5yZWNpcGllbnQoKSk7CgkJfQoKCQlpZiAoIXRoaXMucmVzcG9uc2VUbygpIHx8ICh0aGlzLnJlc3BvbnNlVG8oKQoKCQkJCSYmCgkJCQkhdGhpcy5yZXNwb25zZVRvKCkucmVzcG9uc2VUb19FdmVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoInJlc3BvbnNlVG8iLCBvYmosIHRoaXMucmVzcG9uc2VUbygpKTsKCQl9CgoJCV9vcHRpb25zKCJyZXNwb25zZVRvX0V2ZW50cyIsIG9iaiwgdGhpcy5yZXNwb25zZVRvX0V2ZW50cygpKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnY2xhc3NOYW1lJywgJ21ldGhvZCcsICdwYXlsb2FkJywgJ2NhcnJpZXInLCAnc2VuZGVyJywgJ3JlY2lwaWVudCcsICdyZXNwb25zZVRvJywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydyZXNwb25zZVRvX0V2ZW50cyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgdHJ1ZSwgZnVuLCBvYmosIG9iaik7CgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjbGFzc05hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygibWV0aG9kIiwgb2JqKTsKCgkJX29wdGlvbnMoInBheWxvYWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaik7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaik7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5hbWUiLCBvYmopOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqKTsKCgkJLy8gY2FuIHdlIGRvIGRlUmVmZXJlbmNlIGhlcmU/CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2YodGhpcykgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCB0aGlzLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiB0aGlzOwoJCQl9IGVsc2UgaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUodGhpcyk7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSB0aGlzLl9pZCB8fCB0aGlzLmlkIHx8IHRoaXMuSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKHRoaXMuSWQgJiYgdGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICJkNWMyOGQwZS1iOWU1LTRhOWEtOTc1Zi05ZjliMDA1NDViNGUiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRXZlbnQgPSBzYWxlc25vdy5fdW5SZWN1cnNlLkV2ZW50IHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLkV2ZW50W2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLkV2ZW50W2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRXZlbnRbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5FdmVudFtmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5FdmVudFtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcyk7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuRXZlbnRbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiY2FycmllciIsIG9iaik7CgoJCV9vcHRpb25zKCJzZW5kZXIiLCBvYmopOwoKCQlfb3B0aW9ucygicmVjaXBpZW50Iiwgb2JqKTsKCgkJX29wdGlvbnMoInJlc3BvbnNlVG8iLCBvYmopOwoKCQlfb3B0aW9ucygicmVzcG9uc2VUb19FdmVudHMiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydjbGFzc05hbWUnLCAnbWV0aG9kJywgJ3BheWxvYWQnLCAnY2FycmllcicsICdzZW5kZXInLCAncmVjaXBpZW50JywgJ3Jlc3BvbnNlVG8nLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3Jlc3BvbnNlVG9fRXZlbnRzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RCT2JqZWN0KGZpZWxkcywgYk5vUmVmKSB7CgkJaWYgKCF0aGlzLklkKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJJbnZhbGlkIElEIiwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lLCB0aGlzLlRvb2wpOwoJCX0KCQlsZXQgcmV0ID0gewoJCQlbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldOiAiJyIgKyB0aGlzLklkICsgIiciCgkJfTsKCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjbGFzc05hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY2xhc3NOYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNsYXNzTmFtZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibWV0aG9kIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX21ldGhvZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5tZXRob2QoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ21ldGhvZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInBheWxvYWQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcGF5bG9hZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5wYXlsb2FkKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdwYXlsb2FkJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY2FycmllciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9jYXJyaWVyX3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jYXJyaWVyKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdjYXJyaWVyJywgdW5kZWZpbmVkKSArICJpZCJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJzZW5kZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fc2VuZGVyX3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5zZW5kZXIoKTsKCgkJCWlmICh2ICYmICh2Ll9fc3luY19vbigpIHx8IHYuSWQgPT0gdi5JZCkpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYuSWQgKyAiJyI7CgkJCX0gZWxzZSB7CgkJCQlmVmFsdWUgPSAwOwoJCQl9CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3NlbmRlcicsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVjaXBpZW50IikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3JlY2lwaWVudF9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucmVjaXBpZW50KCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdyZWNpcGllbnQnLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlc3BvbnNlVG8iKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcmVzcG9uc2VUb19zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucmVzcG9uc2VUbygpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgncmVzcG9uc2VUbycsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2FjdGl2ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hY3RpdmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9lbmFibGVkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY29kZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jb2RlKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fb3JkZXJfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMub3JkZXIoKTsKCgkJCWZWYWx1ZSA9IHYgfHwgJzAnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZGF0ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5kYXRlKCk7CgoJCQl0cnkgewoJCQkJZlZhbHVlID0gIiciICsgKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiAiMTk3MC0xLTEiKSArICInIjsKCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJykgewoJCQkJCWZWYWx1ZSA9IGBTVFJfVE9fREFURSgke2ZWYWx1ZX0sICclWS0lbS0lZFQlVC4lZlonKWA7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9ICdkYXRldGltZSgnICsgZlZhbHVlICsgJyknOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9uYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm5hbWUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcmVtYXJrX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnJlbWFyaygpOwoKCQkJZlZhbHVlID0gIiciICsgKCh2ICYmIHYucmVwbGFjZSkgPyB2LnJlcGxhY2UoL1wnL2csICJcJ1wnIikgOiB2KSArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmIChbJ1NhbGVzRm9yY2UnXS5pbmRleE9mKHRoaXMuVG9vbC50eXBlLm5hbWUpID09IDApIHsKCQkJX28gPSBfcSA9ICIiOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXRoaXMuX19RID0gdGhpcy5fX1EgPT0gX28gPyBfcSA6IF9vOwoJCXJldHVybiB0aGlzLl9fUTsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpLCB0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ21ldGhvZCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdwYXlsb2FkJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2NhcnJpZXInLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdzZW5kZXInLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdyZWNpcGllbnQnLCB1bmRlZmluZWQpICsgIi5pZCIsIHRoaXMuX25Db2RlKCdyZXNwb25zZVRvJywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKV07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNsYXNzTmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NsYXNzTmFtZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm1ldGhvZCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ21ldGhvZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNhcnJpZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjYXJyaWVyJywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5zZW5kZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdzZW5kZXInLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnJlY2lwaWVudCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ3JlY2lwaWVudCcsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMucmVzcG9uc2VUbykgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ3Jlc3BvbnNlVG8nLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9YCk7CgoJCX0KCQlyZXR1cm4gZmllbGRzOwoJfQoKCV9mcm9tREJPYmplY3QociA9IHt9KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMuX19pbXBvcnQociwgewoJCQkJSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSwKCgkJCQljbGFzc05hbWU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbGFzc05hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jbGFzc05hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQltZXRob2Q6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdtZXRob2QnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5tZXRob2Qob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlwYXlsb2FkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncGF5bG9hZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnBheWxvYWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljYXJyaWVyOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2FycmllcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNhcnJpZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlzZW5kZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzZW5kZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5zZW5kZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZWNpcGllbnQ6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZWNpcGllbnQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZWNpcGllbnQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZXNwb25zZVRvOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVzcG9uc2VUbycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnJlc3BvbnNlVG8ob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU51bGw6IHRydWUsCgoJCQljYXJyaWVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2FycmllcicsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93Lk5vZGUobnVsbCwgdGhpcy5Ub29sKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJCXNlbmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3NlbmRlcicsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93Lk5vZGUobnVsbCwgdGhpcy5Ub29sKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJCXJlY2lwaWVudDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlY2lwaWVudCcsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93Lk5vZGUobnVsbCwgdGhpcy5Ub29sKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJCXJlc3BvbnNlVG86IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZXNwb25zZVRvJywgdW5kZWZpbmVkKSkgPT4gb2JqW2VhQ29kZV0gPSBuZXcgc2FsZXNub3cuRXZlbnQobnVsbCwgdGhpcy5Ub29sKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJfSwgIl90b1NlbGVjdEhlYWRlciIpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RIZWFkZXInLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9TZWxlY3RTUUwoZmllbGRzKSB7CgkJbGV0IHNxbCA9ICJzZWxlY3QgIjsKCgkJbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX1gOwoKCQlsZXQgaGVhZGVyID0gdGhpcy5fdG9TZWxlY3RIZWFkZXIoZmllbGRzKTsKCgkJc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOwoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOwoKCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcykgewoJCQkvLyB7ZmllbGQ6IGZ1bmN0aW9ufQoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY2xhc3NOYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jbGFzc05hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NsYXNzTmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5tZXRob2QpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm1ldGhvZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbWV0aG9kJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNhcnJpZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNhcnJpZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NhcnJpZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuc2VuZGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5zZW5kZXJ9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3NlbmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5yZWNpcGllbnQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnJlY2lwaWVudH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVjaXBpZW50JywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnJlc3BvbnNlVG8pIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnJlc3BvbnNlVG99KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3Jlc3BvbnNlVG8nLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5lbmFibGVkfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNvZGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5kYXRlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm5hbWV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJY2xhc3NOYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jbGFzc05hbWVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jbGFzc05hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NsYXNzTmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY2xhc3NOYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY2xhc3NOYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jbGFzc05hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW1ldGhvZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ21ldGhvZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbWV0aG9kX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbWV0aG9kX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9tZXRob2RfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX21ldGhvZF9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX21ldGhvZF9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbWV0aG9kX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlwYXlsb2FkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncGF5bG9hZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcGF5bG9hZF9zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY2FycmllcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhcnJpZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NhcnJpZXJfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9jYXJyaWVyX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJc2VuZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc2VuZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9zZW5kZXJfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9zZW5kZXJfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlyZWNpcGllbnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZWNpcGllbnQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3JlY2lwaWVudF9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX3JlY2lwaWVudF9jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlc3BvbnNlVG86IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZXNwb25zZVRvJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9yZXNwb25zZVRvX3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fcmVzcG9uc2VUb19jb29wOwoJCQkJc3dpdGNoIChjb29wKSB7CgkJCQkJY2FzZSAiIT0iOgoJCQkJCQljb29wID0gIk5PVCBJTiI7CgkJCQkJY2FzZSAiPSI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJCWNhc2UgIiI6CgkJCQkJCWNvb3AgPSAiSU4iOwoJCQkJfQoKCQkJCWlmICh2KSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgke3YuX3RvU2VsZWN0U1FMKHYuX19jb25maWcoJ2lkRmllbGQnKXx8J19faWQnKX0pYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSBgIGFuZCAoJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoMCkgT1IgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gSVMgTlVMTClgOwoJCQkJfQoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jb2RlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fY29kZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX29yZGVyX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fb3JkZXJfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fZGF0ZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi50b0lTT1N0cmluZykgewoJCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbGl0ZScpIHsKCQkJCQkJb2JqLnNxbCArPSAic3RyZnRpbWUoJyVzJywgJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJykiOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9iai5zcWwgKz0gIiciICsgdi50b0lTT1N0cmluZygpICsgIiciOwoJCQkJCX0KCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9uYW1lX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9yZW1hcmtfc2V0KSByZXR1cm47CgoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlc3BvbnNlVG9fRXZlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVzcG9uc2VUb19FdmVudHMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzX3NldCkgcmV0dXJuOwoKCQkJCWxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCgicmVzcG9uc2VUby5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fcmVzcG9uc2VUb19FdmVudHNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzX2Nvb3AgPT0gJ05PVCBJTicpIHsKCQkJCQlpbk9QID0gJ05PVCBJTic7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fcmVzcG9uc2VUb19FdmVudHNfY29vcCA9PSAnPT0nKSB7CgkJCQkJak9QID0gJ0lOVEVSU0VDVCc7CgkJCQl9CgoJCQkJb2JqLnNxbCArPSBgYW5kIC8qcmVzcG9uc2VUb19FdmVudHMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCX0sICJfdG9TZWxlY3RTUUwiLCBmaWVsZHMpLnNxbDsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQlpZiAoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNsYXNzTmFtZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjbGFzc05hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jbGFzc05hbWV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubWV0aG9kKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ21ldGhvZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm1ldGhvZH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jYXJyaWVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NhcnJpZXInLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNhcnJpZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuc2VuZGVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3NlbmRlcicsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuc2VuZGVyfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnJlY2lwaWVudCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZWNpcGllbnQnLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnJlY2lwaWVudH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5yZXNwb25zZVRvKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3Jlc3BvbnNlVG8nLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnJlc3BvbnNlVG99YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJY2FycmllcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhcnJpZXInLCB1bmRlZmluZWQpKSA9PiBvYmouY2FycmllciA9IHYuX3RvUGF0aHMoKSwKCgkJCXNlbmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3NlbmRlcicsIHVuZGVmaW5lZCkpID0+IG9iai5zZW5kZXIgPSB2Ll90b1BhdGhzKCksCgoJCQlyZWNpcGllbnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZWNpcGllbnQnLCB1bmRlZmluZWQpKSA9PiBvYmoucmVjaXBpZW50ID0gdi5fdG9QYXRocygpLAoKCQkJcmVzcG9uc2VUbzogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Jlc3BvbnNlVG8nLCB1bmRlZmluZWQpKSA9PiBvYmoucmVzcG9uc2VUbyA9IHYuX3RvUGF0aHMoKSwKCgkJCXJlc3BvbnNlVG9fRXZlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVzcG9uc2VUb19FdmVudHMnLCB1bmRlZmluZWQpKSA9PiBvYmoucmVzcG9uc2VUb19FdmVudHMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJfSwgIl90b1BhdGhzIik7CgkJLy8gcmV0dXJuIHJldDsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5tYXAoayA9PiAoewoJCQlba106IHJldFtrXQoJCX0pKTsKCX0KCglfdG9VcGRhdGVTUUwoZmllbGRzKSB7CgkJbGV0IHJldEZpZWxkcyA9IHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLmpvaW4oJywgJyk7CgkJbGV0IHNxbCA9IGB1cGRhdGUgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSBzZXQgYCArIE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvREJPYmplY3QoZmllbGRzKSkubWFwKHYgPT4gdGhpcy5fUSgpICsgdlswXSArIHRoaXMuX1EoKSArICI9IiArIHZbMV0pICsgYCB3aGVyZSAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgOyAvL2AgcmV0dXJuaW5nICR7cmV0RmllbGRzfWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvVXBkYXRlU1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfdG9JbnNlcnRTUUwoZmllbGRzKSB7CgkJbGV0IG9iaiA9IHRoaXMuX3RvREJPYmplY3QoZmllbGRzKTsKCQlsZXQgc3FsID0gYGluc2VydCBpbnRvICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKGAgKyBPYmplY3Qua2V5cyhvYmopLm1hcChrID0+IHRoaXMuX1EoKSArIGsgKyB0aGlzLl9RKCkpICsgIikgdmFsdWVzICgiICsgT2JqZWN0LnZhbHVlcyhvYmopICsgYClgOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0luc2VydFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5FdmVudCkgcmV0dXJuOwoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5FdmVudCA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCBzcWwgPSBuZXcgc2FsZXNub3cuRXZlbnQoKQoKCQkJCQkuY2FycmllcihuZXcgc2FsZXNub3cuTm9kZSgpKQoKCQkJCQkuc2VuZGVyKG5ldyBzYWxlc25vdy5Ob2RlKCkpCgoJCQkJCS5yZWNpcGllbnQobmV3IHNhbGVzbm93Lk5vZGUoKSkKCgkJCQkJLnJlc3BvbnNlVG8obmV3IHNhbGVzbm93LkV2ZW50KCkpCgoJCQkJCS5yZXNwb25zZVRvX0V2ZW50cyhuZXcgc2FsZXNub3cuRXZlbnQoKSkKCgkJCQkJLl90b1NRTFRhYmxlKGRlcHRoKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJFdmVudCIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQljbGFzc05hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNsYXNzTmFtZSA9IHYgPT0gcXVlcnkuY2xhc3NOYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NsYXNzTmFtZV9zZXQgJiYgIXF1ZXJ5Ll9jbGFzc05hbWVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNsYXNzTmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jbGFzc05hbWVfc2V0ICYmIHF1ZXJ5Ll9jbGFzc05hbWVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jbGFzc05hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbWV0aG9kOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5tZXRob2QgPSB2ID09IHF1ZXJ5Lm1ldGhvZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9tZXRob2Rfc2V0ICYmICFxdWVyeS5fbWV0aG9kX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5tZXRob2QgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fbWV0aG9kX3NldCAmJiBxdWVyeS5fbWV0aG9kX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubWV0aG9kID0gZmFsc2U7CgkJCQl9LAoKCQkJCXBheWxvYWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnBheWxvYWQgPSB2ID09IHF1ZXJ5LnBheWxvYWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcGF5bG9hZF9zZXQgJiYgIXF1ZXJ5Ll9wYXlsb2FkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5wYXlsb2FkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3BheWxvYWRfc2V0ICYmIHF1ZXJ5Ll9wYXlsb2FkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucGF5bG9hZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljYXJyaWVyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jYXJyaWVyID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5jYXJyaWVyKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NhcnJpZXJfc2V0ICYmICFxdWVyeS5fY2Fycmllcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY2FycmllciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jYXJyaWVyX3NldCAmJiBxdWVyeS5fY2Fycmllcl9zZXQpIHx8CgoJCQkJCQkodGhpcy5jYXJyaWVyKCkgJiYgIXRoaXMuY2FycmllcigpLl9tYXRjaGVzKHF1ZXJ5LmNhcnJpZXIoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNhcnJpZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJc2VuZGVyOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5zZW5kZXIgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LnNlbmRlcigpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9zZW5kZXJfc2V0ICYmICFxdWVyeS5fc2VuZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5zZW5kZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fc2VuZGVyX3NldCAmJiBxdWVyeS5fc2VuZGVyX3NldCkgfHwKCgkJCQkJCSh0aGlzLnNlbmRlcigpICYmICF0aGlzLnNlbmRlcigpLl9tYXRjaGVzKHF1ZXJ5LnNlbmRlcigpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouc2VuZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCXJlY2lwaWVudDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoucmVjaXBpZW50ID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5yZWNpcGllbnQoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcmVjaXBpZW50X3NldCAmJiAhcXVlcnkuX3JlY2lwaWVudF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVjaXBpZW50ID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3JlY2lwaWVudF9zZXQgJiYgcXVlcnkuX3JlY2lwaWVudF9zZXQpIHx8CgoJCQkJCQkodGhpcy5yZWNpcGllbnQoKSAmJiAhdGhpcy5yZWNpcGllbnQoKS5fbWF0Y2hlcyhxdWVyeS5yZWNpcGllbnQoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlY2lwaWVudCA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZXNwb25zZVRvOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZXNwb25zZVRvID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5yZXNwb25zZVRvKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3Jlc3BvbnNlVG9fc2V0ICYmICFxdWVyeS5fcmVzcG9uc2VUb19zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVzcG9uc2VUbyA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZXNwb25zZVRvX3NldCAmJiBxdWVyeS5fcmVzcG9uc2VUb19zZXQpIHx8CgoJCQkJCQkodGhpcy5yZXNwb25zZVRvKCkgJiYgIXRoaXMucmVzcG9uc2VUbygpLl9tYXRjaGVzKHF1ZXJ5LnJlc3BvbnNlVG8oKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlc3BvbnNlVG8gPSBmYWxzZTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCXJlc3BvbnNlVG9fRXZlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnJlc3BvbnNlVG9fRXZlbnRzID0gdi5tYXAoX3YgPT4gcXVlcnkucmVzcG9uc2VUb19FdmVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCWNhcnJpZXI6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBjYXJyaWVyIik7CgkJCQkJb2JqLmNhcnJpZXIgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQlzZW5kZXI6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciBzZW5kZXIiKTsKCQkJCQlvYmouc2VuZGVyID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJcmVjaXBpZW50OiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgcmVjaXBpZW50Iik7CgkJCQkJb2JqLnJlY2lwaWVudCA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCXJlc3BvbnNlVG86IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciByZXNwb25zZVRvIik7CgkJCQkJb2JqLnJlc3BvbnNlVG8gPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQlyZXNwb25zZVRvX0V2ZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5yZXNwb25zZVRvX0V2ZW50cyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fY2xhc3NOYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX21ldGhvZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9wYXlsb2FkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NhcnJpZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fc2VuZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlY2lwaWVudF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZXNwb25zZVRvX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJY2FycmllcjogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLmNhcnJpZXIocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCXNlbmRlcjogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLnNlbmRlcihyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJcmVjaXBpZW50OiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMucmVjaXBpZW50KHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlyZXNwb25zZVRvOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMucmVzcG9uc2VUbyhyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJcmVzcG9uc2VUb19FdmVudHM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5yZXNwb25zZVRvX0V2ZW50cygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfZGVSZWZlcmVuY2UiKTsKCgkJCXJldHVybiB0aGlzOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9mcm9tRG9jdW1lbnQob2JqLCBiVG9vbCwgYk5vTnVsbCkgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCQlpZiAob2JqLl9mcm9tRG9jdW1lbnQpIHJldHVybiBvYmo7CgoJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJdHJ5IHsKCQkJCW9iaiA9IEpTT04ucGFyc2Uob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMSwgIkludmFsaWQgSlNPTiIsIG9iaik7CgkJCX0KCQl9CgoJCXRoaXMuX19pbXBvcnQob2JqLCB7CgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogb2JqID0+IHRoaXMuVEhJUyhvYmouVEhJUywgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlMuVEhJUyA6IHVuZGVmaW5lZCksCgkJCUlkOiBvYmogPT4gewoJCQkJdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV07CgkJCQlpZiAob2JqLl9fdG9vbCkgewoJCQkJCXRyeSB7CgkJCQkJCXRoaXMuVG9vbCA9IG9iai5fX3Rvb2w7CgkJCQkJfSBjYXRjaCAoZXgpIHsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCQkJfQoJCQkJfQoJCQl9LAoKCQkJY2xhc3NOYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKSA6ICJjbGFzc05hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY2xhc3NOYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jbGFzc05hbWUocmVmKTsKCgkJCX0sCgoJCQltZXRob2Q6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdtZXRob2QnLCB1bmRlZmluZWQpIDogIm1ldGhvZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9tZXRob2RfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm1ldGhvZChyZWYpOwoKCQkJfSwKCgkJCXBheWxvYWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdwYXlsb2FkJywgdW5kZWZpbmVkKSA6ICJwYXlsb2FkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3BheWxvYWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnBheWxvYWQocmVmKTsKCgkJCX0sCgoJCQljYXJyaWVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY2FycmllcicsIHVuZGVmaW5lZCkgOiAiY2FycmllciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jYXJyaWVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLmNhcnJpZXIoKSB8fCBuZXcgc2FsZXNub3cuTm9kZSgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuY2FycmllcihvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIGNhcnJpZXIiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCXNlbmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3NlbmRlcicsIHVuZGVmaW5lZCkgOiAic2VuZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3NlbmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5zZW5kZXIoKSB8fCBuZXcgc2FsZXNub3cuTm9kZSgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMuc2VuZGVyKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2Ugc2VuZGVyIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQlyZWNpcGllbnQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZWNpcGllbnQnLCB1bmRlZmluZWQpIDogInJlY2lwaWVudCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZWNpcGllbnRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMucmVjaXBpZW50KCkgfHwgbmV3IHNhbGVzbm93Lk5vZGUoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLnJlY2lwaWVudChvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIHJlY2lwaWVudCIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJcmVzcG9uc2VUbzogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3Jlc3BvbnNlVG8nLCB1bmRlZmluZWQpIDogInJlc3BvbnNlVG8iKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVzcG9uc2VUb19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJSZXN0REJJTyIpIHJlZiA9IHJlZlswXTsKCQkJCWlmICghcmVmKSByZXR1cm47CgoJCQkJbGV0IG9SZWYgPSAodGhpcy5yZXNwb25zZVRvKCkgfHwgbmV3IHNhbGVzbm93LkV2ZW50KCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5yZXNwb25zZVRvKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgcmVzcG9uc2VUbyIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJcmVzcG9uc2VUb19FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZXNwb25zZVRvX0V2ZW50cycsIHVuZGVmaW5lZCkgOiAicmVzcG9uc2VUb19FdmVudHMiKSkgPT4gdGhpcy5yZXNwb25zZVRvX0V2ZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuRXZlbnQoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSA9IHYsCgoJCQkiY2xhc3NOYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NsYXNzTmFtZScsIHVuZGVmaW5lZCkgOiAiY2xhc3NOYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NsYXNzTmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY2xhc3NOYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibWV0aG9kIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ21ldGhvZCcsIHVuZGVmaW5lZCkgOiAibWV0aG9kIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX21ldGhvZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbWV0aG9kX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicGF5bG9hZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdwYXlsb2FkJywgdW5kZWZpbmVkKSA6ICJwYXlsb2FkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3BheWxvYWRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3BheWxvYWRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjYXJyaWVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NhcnJpZXInLCB1bmRlZmluZWQpIDogImNhcnJpZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl9jYXJyaWVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jYXJyaWVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkic2VuZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3NlbmRlcicsIHVuZGVmaW5lZCkgOiAic2VuZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fc2VuZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9zZW5kZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZWNpcGllbnQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVjaXBpZW50JywgdW5kZWZpbmVkKSA6ICJyZWNpcGllbnQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl9yZWNpcGllbnRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlY2lwaWVudF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlc3BvbnNlVG8iOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVzcG9uc2VUbycsIHVuZGVmaW5lZCkgOiAicmVzcG9uc2VUbyIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX3Jlc3BvbnNlVG9fY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3Jlc3BvbnNlVG9fY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCXJlc3BvbnNlVG9fRXZlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVzcG9uc2VUb19FdmVudHMnLCB1bmRlZmluZWQpIDogInJlc3BvbnNlVG9fRXZlbnRzIikpID0+IHsKCQkJCW9ialtlYUNvZGVdID0gdi5tYXAoX3YgPT4gX3YuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJaWYgKHRoaXMuX3Jlc3BvbnNlVG9fRXZlbnRzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZXNwb25zZVRvX0V2ZW50c19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9mbGlwKCkgKi8KCV9mbGlwKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fZmxpcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9mbGlwKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2ZsaXAoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJYnlOb2RlKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9jYXJyaWVyIl0gJiYgKGFbIl9jYXJyaWVyIl0uRXF1YWxzID8gYVsiX2NhcnJpZXIiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX2NhcnJpZXIiXSwgcikpKSB7CgkJCQkJci5fY2Fycmllcl9FdmVudHMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglieU5vZGUoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX3NlbmRlciJdICYmIChhWyJfc2VuZGVyIl0uRXF1YWxzID8gYVsiX3NlbmRlciJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfc2VuZGVyIl0sIHIpKSkgewoJCQkJCXIuX3NlbmRlcl9FdmVudHMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglieU5vZGUoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX3JlY2lwaWVudCJdICYmIChhWyJfcmVjaXBpZW50Il0uRXF1YWxzID8gYVsiX3JlY2lwaWVudCJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfcmVjaXBpZW50Il0sIHIpKSkgewoJCQkJCXIuX3JlY2lwaWVudF9FdmVudHMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglieUV2ZW50KGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9yZXNwb25zZVRvIl0gJiYgKGFbIl9yZXNwb25zZVRvIl0uRXF1YWxzID8gYVsiX3Jlc3BvbnNlVG8iXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX3Jlc3BvbnNlVG8iXSwgcikpKSB7CgkJCQkJci5fcmVzcG9uc2VUb19FdmVudHMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuX25hbWU7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IGZhbHNlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IucGF5bG9hZCA9IHt9OwoJCQlpZiAoIXRoaXMuX3BheWxvYWRfc2V0KSBlcnJvci5wYXlsb2FkWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5wYXlsb2FkKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5wYXlsb2FkOwoJCX0KCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IGZhbHNlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3Iuc2VuZGVyID0ge307CgkJCWlmICghdGhpcy5fc2VuZGVyX3NldCkgZXJyb3Iuc2VuZGVyWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCF0aGlzLnNlbmRlcigpKSBlcnJvci5zZW5kZXJbIjAyIl0gPSAiRW1wdHkgVmFsdWUiOwoJCQlpZiAodGhpcy5zZW5kZXIoKSAmJiBiU3luYyAmJiAhdGhpcy5zZW5kZXIoKS5fX3N5bmNfb24oKSkgZXJyb3Iuc2VuZGVyWyIwMyJdID0gIk5vdCBpbiBTeW5jIjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3Iuc2VuZGVyKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5zZW5kZXI7CgkJfQoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gZmFsc2U7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5uYW1lID0ge307CgkJCWlmICghdGhpcy5fbmFtZV9zZXQpIGVycm9yLm5hbWVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5hbWUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5hbWU7CgkJfQoKCQlpZiAoT2JqZWN0LmtleXMoZXJyb3IpLmxlbmd0aCkgewoJCQl0aGlzLl9fYXNzZXJ0RXJyb3IgPSBlcnJvcjsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19hc3NlcnRWYWxpZCcsICdFbnRpdHlPYmplY3QnLCAyLCBKU09OLnN0cmluZ2lmeShlcnJvciwgbnVsbCwgNCksIHRoaXMuX3RvRG9jdW1lbnQoKSk7CgkJCXJldHVybiBmYWxzZTsKCQl9IGVsc2UgewoJCQlkZWxldGUgdGhpcy5fX2Fzc2VydEVycm9yOwoJCQlyZXR1cm4gdHJ1ZTsKCQl9Cgl9CgoJYXN5bmMgc3RvcmUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAic3RvcmUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RvcmUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgc3RvcmUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5FdmVudC5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuRXZlbnQobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLmNvZGUodGhpcy5jb2RlKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCWlmICh0eXBlb2Yoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgPT09ICJ1bmRlZmluZWQiIHx8IHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQkJCWF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsKCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiA9IHsKCQkJCQkJCU93bmVyOiB0aGlzLAoJCQkJCQkJc3FsczogW10sCgkJCQkJCQlzdGFydDogbmV3IERhdGUoKSwKCQkJCQkJCWVuZDogbnVsbAoJCQkJCQl9OwoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSB7CgkJCQkJdGhpcy5jb2RlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9ICgpID0+IHRoaXMuX3V1aWQoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fY2Fycmllcl9zZXQgJiYgdGhpcy5jYXJyaWVyKCkgJiYgIShhd2FpdCB0aGlzLmNhcnJpZXIoKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9jYXJyaWVyKCk7CgoJCQkJCWlmICh0aGlzLl9zZW5kZXJfc2V0ICYmIHRoaXMuc2VuZGVyKCkgJiYgIShhd2FpdCB0aGlzLnNlbmRlcigpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX3NlbmRlcigpOwoKCQkJCQlpZiAodGhpcy5fcmVjaXBpZW50X3NldCAmJiB0aGlzLnJlY2lwaWVudCgpICYmICEoYXdhaXQgdGhpcy5yZWNpcGllbnQoKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9yZWNpcGllbnQoKTsKCgkJCQkJaWYgKHRoaXMuX3Jlc3BvbnNlVG9fc2V0ICYmIHRoaXMucmVzcG9uc2VUbygpICYmICEoYXdhaXQgdGhpcy5yZXNwb25zZVRvKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfcmVzcG9uc2VUbygpOwoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9yZXNwb25zZVRvX0V2ZW50c19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLnJlc3BvbnNlVG9fRXZlbnRzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJfQoKCQkJCWlmIChiVXBkYXRlIHx8IGJJbnNlcnQpIHsKCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCQkJaWYgKHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uT3duZXIgPT0gdGhpcykgewoJCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGBDT01NSVQke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/JyBUUkFOU0FDVElPTic6Jyd9YCk7CgkJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCA9IG5ldyBEYXRlKCk7CgkJCQkJCX0KCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQkJfQoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCQl9CgoJCQkJfQoJCQl9CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgaW5zZXJ0KCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImluc2VydCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGluc2VydCgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkV2ZW50Lmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl0aGlzLl9mcm9tRG9jdW1lbnQoYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlsZXQgb2JqID0ge307CgoJCQkJaWYgKHRoaXMuX2NsYXNzTmFtZV9zZXQpIHsKCgkJCQkJb2JqLmNsYXNzTmFtZSA9IHRoaXMuY2xhc3NOYW1lKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9tZXRob2Rfc2V0KSB7CgoJCQkJCW9iai5tZXRob2QgPSB0aGlzLm1ldGhvZCgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fcGF5bG9hZF9zZXQpIHsKCgkJCQkJb2JqLnBheWxvYWQgPSB0aGlzLnBheWxvYWQoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2NhcnJpZXJfc2V0KSB7CgoJCQkJCW9iai5jYXJyaWVyID0gdGhpcy5fY2Fycmllci5JZDsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX3NlbmRlcl9zZXQpIHsKCgkJCQkJb2JqLnNlbmRlciA9IHRoaXMuX3NlbmRlci5JZDsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX3JlY2lwaWVudF9zZXQpIHsKCgkJCQkJb2JqLnJlY2lwaWVudCA9IHRoaXMuX3JlY2lwaWVudC5JZDsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX3Jlc3BvbnNlVG9fc2V0KSB7CgoJCQkJCW9iai5yZXNwb25zZVRvID0gdGhpcy5fcmVzcG9uc2VUby5JZDsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9zZXQpIHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9lbmFibGVkX3NldCkgewoKCQkJCQlvYmouZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fY29kZV9zZXQpIHsKCgkJCQkJb2JqLmNvZGUgPSB0aGlzLmNvZGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX29yZGVyX3NldCkgewoKCQkJCQlvYmoub3JkZXIgPSB0aGlzLm9yZGVyKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9kYXRlX3NldCkgewoKCQkJCQlvYmouZGF0ZSA9IHRoaXMuZGF0ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fbmFtZV9zZXQpIHsKCgkJCQkJb2JqLm5hbWUgPSB0aGlzLm5hbWUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX3JlbWFya19zZXQpIHsKCgkJCQkJb2JqLnJlbWFyayA9IHRoaXMucmVtYXJrKCk7CgoJCQkJfQoKCQkJCWxvZygiU2VuZGluZyB0byBTRiIsIG9iaik7CgoJCQkJbGV0IHJlcyA9IGF3YWl0IHRoaXMuVG9vbC5kYi5zb2JqZWN0KCJFdmVudCIpLmNyZWF0ZShvYmopOwoJCQkJdGhpcy5JZCA9IHJlcy5pZDsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93LkV2ZW50LnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvVXBkYXRlU1FMKCkpOwoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKCkpOwoJCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0WzBdOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuRXZlbnQuZmluZEFsbCcpOwoKCQkJLy8gYXZvaWRzIGN5Y2xpYyBxdWVyaWVzCgkJCW9ianMgPSAob2JqcyB8fCBbXSkubWFwKG8gPT4gby5fY2xvbmUoKSk7CgoJCQlhd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vPz8KCgkJCWxldCByZXQgPSBbXTsgLy8gYSBqc29uIGFycmF5CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKGZpZWxkcywgb2JqcykpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCB7CgkJCQkJc3lzcGFybV9xdWVyeTogT2JqZWN0LmVudHJpZXModGhpcy5fdG9TTlF1ZXJ5KGZpZWxkcywgb2JqcykpLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKQoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIHRydWUpLCBudWxsLCB7CgkJCQkJdXJsOiAncmVzdC51cmwuZ3FsJwoJCQkJfSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCk7CgkJCQlyZXQgPSByZXQuY29udGVudCA/IFtKU09OLnBhcnNlKHRoaXMuX2F0b2IocmV0LmNvbnRlbnQpKV0gOiBbXTsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJlZm9yZSBfZnJvbURvY3VtZW50KCkiLCByZXQpOwoKCQkJcmV0ID0gcmV0Lm1hcChyID0+IG5ldyBzYWxlc25vdy5FdmVudChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93Lk5vZGUgPSBjbGFzcyBOb2RlIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUXNLaTVmY21WemRDd3FMbDlzYjJGa1ZHOXZiSE1pZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKdWIwUmxkR1ZqZENJNmRISjFaU3dpYVc1cGRDNWxibVJ6SWpveUxDSnBibWwwTG14dmIzQWlPakF1TlN3aWRHOXZiSE11YzNSdmNtVWlPbVpoYkhObExDSmtaWFJsWTNSUVlYSmxiblF1U1ZBaU9pSXhPREl1TVRZNExqY3dMamd5SWl3aVpHVjBaV04wVUdGeVpXNTBMbU52WkdVaU9pSmxPR1JsTURabE0yVmtZelEwTTJGbE9XUm1aVEZrWlRWbFl6VXlZVFJpWmlJc0luTmxZM0psZENJNkltOVRTM2RuV2pKelMwWlBWRWxLWTJKQlpsVkpVVFJEYWpseGMwZzBPRzVzSWl3aWNHeGhlV2R5YjNWdVpDSTZkSEoxWlN3aVoxSlFReUk2ZEhKMVpTd2ljM1J2Y21VdWMyVnVjMmwwYVhacGRIa2lPakVzSW1OdmJYQmhibmtpT2lKeVpYTjFiV1VpZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc2V5SnVZVzFsSWpvaVUwNVBWMDlQUWlJc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaWZYMHNJbE5oYkdWelJtOXlZMlVpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWRkcmVzcyIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWRkcmVzcygpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImJhY2t1cCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYmFja3VwKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicGFyZW50IiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9wYXJlbnQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJwb3J0IiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9wb3J0KCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib25saW5lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vbmxpbmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJzZWN1cmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3NlY3VyZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInR5cGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3R5cGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2FjdGl2ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2VuYWJsZWQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjb2RlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9jb2RlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3JkZXIiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29yZGVyKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZGF0ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZGF0ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm5hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX25hbWUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJyZW1hcmsiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3JlbWFyaygpOwoKCQl0aGlzLmNsZWFyX25vZGVfQ29uZmlncygpOwoKCQl0aGlzLmNsZWFyX2NhcnJpZXJfRXZlbnRzKCk7CgoJCXRoaXMuY2xlYXJfc2VuZGVyX0V2ZW50cygpOwoKCQl0aGlzLmNsZWFyX3JlY2lwaWVudF9FdmVudHMoKTsKCgkJdGhpcy5jbGVhcl9iYWNrdXBfTm9kZXMoKTsKCgkJdGhpcy5jbGVhcl9wYXJlbnRfTm9kZXMoKTsKCgkJdGhpcy5jbGVhcl9ub2RlX05vZGVfR3JvdXBfTWVtYmVycygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIk5vZGUiLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCS8vIGlmKHRoaXMuX2JhY2t1cF9zZXQgJiYgdGhpcy5fYmFja3VwKSB0aGlzLl9iYWNrdXAuVG9vbCA9IHRvb2w7CgoJCS8vIGlmKHRoaXMuX3BhcmVudF9zZXQgJiYgdGhpcy5fcGFyZW50KSB0aGlzLl9wYXJlbnQuVG9vbCA9IHRvb2w7CgoJCS8vIGlmKHRoaXMuX3R5cGVfc2V0ICYmIHRoaXMuX3R5cGUpIHRoaXMuX3R5cGUuVG9vbCA9IHRvb2w7CgoJCS8vICh0aGlzLm5vZGVfQ29uZmlncygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCS8vICh0aGlzLmNhcnJpZXJfRXZlbnRzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJLy8gKHRoaXMuc2VuZGVyX0V2ZW50cygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCS8vICh0aGlzLnJlY2lwaWVudF9FdmVudHMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQkvLyAodGhpcy5iYWNrdXBfTm9kZXMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQkvLyAodGhpcy5wYXJlbnRfTm9kZXMoKSB8fCBbXSkuZm9yRWFjaCh0ID0+IHQuVG9vbCA9IHRvb2wpOwoKCQkvLyAodGhpcy5ub2RlX05vZGVfR3JvdXBfTWVtYmVycygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhZGRyZXNzICoqLwoJYWRkcmVzcyh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FkZHJlc3NfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhZGRyZXNzIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hZGRyZXNzICE9IHYpIHsKCQkJCXRoaXMuX2FkZHJlc3Nfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FkZHJlc3MgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWRkcmVzcyk7CgkJfQoJfQoKCWNsZWFyX2FkZHJlc3MoKSB7CgkJdGhpcy5fYWRkcmVzc19zZXQgPSBudWxsOwoJCXRoaXMuX2FkZHJlc3MgPSBudWxsOwoJCXRoaXMuX2FkZHJlc3NfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFkZHJlc3MgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBiYWNrdXAgKiovCgliYWNrdXAodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9iYWNrdXBfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJiYWNrdXAiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc5ZTJhMGQ3MC05YTFiLTQ3NjItYTlkYi0wNjBlNjU3OTVjODknICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdOb2RlJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2JhY2t1cCcsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjllMmEwZDcwLTlhMWItNDc2Mi1hOWRiLTA2MGU2NTc5NWM4OSIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJOb2RlIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2JhY2t1cCAhPSB2KSB7CgkJCQl0aGlzLl9iYWNrdXBfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdiYWNrdXAnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX2JhY2t1cCA/IHRoaXMuX2JhY2t1cC5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fYmFja3VwX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9iYWNrdXAgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYmFja3VwKTsKCQl9Cgl9CgoJY2xlYXJfYmFja3VwKCkgewoJCXRoaXMuX2JhY2t1cF9zZXQgPSBudWxsOwoJCXRoaXMuX2JhY2t1cCA9IG51bGw7CgkJdGhpcy5fYmFja3VwX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBiYWNrdXAgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBwYXJlbnQgKiovCglwYXJlbnQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9wYXJlbnRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJwYXJlbnQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc5ZTJhMGQ3MC05YTFiLTQ3NjItYTlkYi0wNjBlNjU3OTVjODknICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdOb2RlJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3BhcmVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjllMmEwZDcwLTlhMWItNDc2Mi1hOWRiLTA2MGU2NTc5NWM4OSIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJOb2RlIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3BhcmVudCAhPSB2KSB7CgkJCQl0aGlzLl9wYXJlbnRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdwYXJlbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX3BhcmVudCA/IHRoaXMuX3BhcmVudC5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fcGFyZW50X3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9wYXJlbnQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcGFyZW50KTsKCQl9Cgl9CgoJY2xlYXJfcGFyZW50KCkgewoJCXRoaXMuX3BhcmVudF9zZXQgPSBudWxsOwoJCXRoaXMuX3BhcmVudCA9IG51bGw7CgkJdGhpcy5fcGFyZW50X2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBwYXJlbnQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBwb3J0ICoqLwoJcG9ydCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3BvcnRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJwb3J0Iik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcG9ydCAhPSB2KSB7CgkJCQl0aGlzLl9wb3J0X3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9wb3J0ID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3BvcnQpOwoJCX0KCX0KCgljbGVhcl9wb3J0KCkgewoJCXRoaXMuX3BvcnRfc2V0ID0gbnVsbDsKCQl0aGlzLl9wb3J0ID0gbnVsbDsKCQl0aGlzLl9wb3J0X2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBwb3J0ICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb25saW5lICoqLwoJb25saW5lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb25saW5lX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgib25saW5lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBPYmplY3QucHJvdG90eXBlLnRvU3RyaW5nLmNhbGwoX3YpID09PSAnW29iamVjdCBEYXRlXScgPyBfdiA6IChuZXcgRGF0ZShfdikpOwoJCQkJaWYgKGlzTmFOKF92LmdldFRpbWUoKSkpIF92ID0gbnVsbDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkRhdGVWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9vbmxpbmUgIT0gdikgewoJCQkJdGhpcy5fb25saW5lX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vbmxpbmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5EYXRlVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29ubGluZSk7CgkJfQoJfQoKCWNsZWFyX29ubGluZSgpIHsKCQl0aGlzLl9vbmxpbmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9vbmxpbmUgPSBudWxsOwoJCXRoaXMuX29ubGluZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igb25saW5lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc2VjdXJlICoqLwoJc2VjdXJlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fc2VjdXJlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgic2VjdXJlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fc2VjdXJlICE9IHYpIHsKCQkJCXRoaXMuX3NlY3VyZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fc2VjdXJlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9zZWN1cmUpOwoJCX0KCX0KCgljbGVhcl9zZWN1cmUoKSB7CgkJdGhpcy5fc2VjdXJlX3NldCA9IG51bGw7CgkJdGhpcy5fc2VjdXJlID0gbnVsbDsKCQl0aGlzLl9zZWN1cmVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHNlY3VyZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHR5cGUgKiovCgl0eXBlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fdHlwZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInR5cGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICcxYmFmYWE3Yy03ZDIxLTQ1MGEtOWNjNC04Yzk2YzIyMGQxZTQnICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdOb2RlIFR5cGUnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndHlwZScsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjFiYWZhYTdjLTdkMjEtNDUwYS05Y2M0LThjOTZjMjIwZDFlNCIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJOb2RlIFR5cGUiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fdHlwZSAhPSB2KSB7CgkJCQl0aGlzLl90eXBlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndHlwZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fdHlwZSA/IHRoaXMuX3R5cGUuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX3R5cGVfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX3R5cGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fdHlwZSk7CgkJfQoJfQoKCWNsZWFyX3R5cGUoKSB7CgkJdGhpcy5fdHlwZV9zZXQgPSBudWxsOwoJCXRoaXMuX3R5cGUgPSBudWxsOwoJCXRoaXMuX3R5cGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHR5cGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBjb2RlICoqLwoJY29kZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NvZGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJjb2RlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9jb2RlICE9IHYpIHsKCQkJCXRoaXMuX2NvZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2NvZGUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fY29kZSk7CgkJfQoJfQoKCWNsZWFyX2NvZGUoKSB7CgkJdGhpcy5fY29kZV9zZXQgPSBudWxsOwoJCXRoaXMuX2NvZGUgPSBudWxsOwoJCXRoaXMuX2NvZGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCglkYXRlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fZGF0ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImRhdGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IE9iamVjdC5wcm90b3R5cGUudG9TdHJpbmcuY2FsbChfdikgPT09ICdbb2JqZWN0IERhdGVdJyA/IF92IDogKG5ldyBEYXRlKF92KSk7CgkJCQlpZiAoaXNOYU4oX3YuZ2V0VGltZSgpKSkgX3YgPSBudWxsOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuRGF0ZVZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2RhdGUgIT0gdikgewoJCQkJdGhpcy5fZGF0ZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZGF0ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkRhdGVWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZGF0ZSk7CgkJfQoJfQoKCWNsZWFyX2RhdGUoKSB7CgkJdGhpcy5fZGF0ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2RhdGUgPSBudWxsOwoJCXRoaXMuX2RhdGVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGRhdGUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBuYW1lICoqLwoJbmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX25hbWVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJuYW1lIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9uYW1lICE9IHYpIHsKCQkJCXRoaXMuX25hbWVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX25hbWUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fbmFtZSk7CgkJfQoJfQoKCWNsZWFyX25hbWUoKSB7CgkJdGhpcy5fbmFtZV9zZXQgPSBudWxsOwoJCXRoaXMuX25hbWUgPSBudWxsOwoJCXRoaXMuX25hbWVfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCglyZW1hcmsodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9yZW1hcmtfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJyZW1hcmsiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3JlbWFyayAhPSB2KSB7CgkJCQl0aGlzLl9yZW1hcmtfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX3JlbWFyayA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fcmVtYXJrKTsKCQl9Cgl9CgoJY2xlYXJfcmVtYXJrKCkgewoJCXRoaXMuX3JlbWFya19zZXQgPSBudWxsOwoJCXRoaXMuX3JlbWFyayA9IG51bGw7CgkJdGhpcy5fcmVtYXJrX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZW1hcmsgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBub2RlX0NvbmZpZ3MgKiovCglub2RlX0NvbmZpZ3ModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX25vZGVfQ29uZmlnczsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnODQ2YmYzNzUtN2FkMS00ZGVjLThhNGUtZGZjNWJlNWIzMGFiJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdDb25maWcnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX25vZGVfc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnbm9kZV9Db25maWdzJywgJ0VudGl0eU9iamVjdCcsIDEsICJub2RlIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJDb25maWciKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdub2RlX0NvbmZpZ3MnLCAnRW50aXR5T2JqZWN0JywgMSwgIm5vZGUgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJDb25maWciKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3Yubm9kZSh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9ub2RlX0NvbmZpZ3MucHVzaCguLi52KTsKCQl0aGlzLl9ub2RlX0NvbmZpZ3Nfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX25vZGVfQ29uZmlnc19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfbm9kZV9Db25maWdzKCkgewoJCXRoaXMuX25vZGVfQ29uZmlnc19zZXQgPSBudWxsOwoJCXRoaXMuX25vZGVfQ29uZmlncyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX25vZGVfQ29uZmlnc19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5vZGVfQ29uZmlncyAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNhcnJpZXJfRXZlbnRzICoqLwoJY2Fycmllcl9FdmVudHModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHRoaXMuX2NhcnJpZXJfRXZlbnRzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICdkNWMyOGQwZS1iOWU1LTRhOWEtOTc1Zi05ZjliMDA1NDViNGUnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0V2ZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9jYXJyaWVyX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NhcnJpZXJfRXZlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJjYXJyaWVyIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJFdmVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2NhcnJpZXJfRXZlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJjYXJyaWVyIG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiRXZlbnQiKTsKCQkJfSBlbHNlIGlmICh0cnVlIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkIHx8IF92Ll9fc3luY19vbigpIHx8IF92LklkID09IF92LklkKSB7IC8vIGV4cGVyaW1lbnRhbCBjb25kaXRpb24sIHdhcyBhbHdheXMgdHJ1ZQoJCQkJX3YuY2Fycmllcih0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9jYXJyaWVyX0V2ZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX2NhcnJpZXJfRXZlbnRzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9jYXJyaWVyX0V2ZW50c19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfY2Fycmllcl9FdmVudHMoKSB7CgkJdGhpcy5fY2Fycmllcl9FdmVudHNfc2V0ID0gbnVsbDsKCQl0aGlzLl9jYXJyaWVyX0V2ZW50cyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX2NhcnJpZXJfRXZlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY2Fycmllcl9FdmVudHMgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBzZW5kZXJfRXZlbnRzICoqLwoJc2VuZGVyX0V2ZW50cyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fc2VuZGVyX0V2ZW50czsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnZDVjMjhkMGUtYjllNS00YTlhLTk3NWYtOWY5YjAwNTQ1YjRlJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdFdmVudCcpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fc2VuZGVyX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NlbmRlcl9FdmVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgInNlbmRlciBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiRXZlbnQiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZW5kZXJfRXZlbnRzJywgJ0VudGl0eU9iamVjdCcsIDEsICJzZW5kZXIgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJFdmVudCIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5zZW5kZXIodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fc2VuZGVyX0V2ZW50cy5wdXNoKC4uLnYpOwoJCXRoaXMuX3NlbmRlcl9FdmVudHNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX3NlbmRlcl9FdmVudHNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX3NlbmRlcl9FdmVudHMoKSB7CgkJdGhpcy5fc2VuZGVyX0V2ZW50c19zZXQgPSBudWxsOwoJCXRoaXMuX3NlbmRlcl9FdmVudHMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9zZW5kZXJfRXZlbnRzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc2VuZGVyX0V2ZW50cyAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlY2lwaWVudF9FdmVudHMgKiovCglyZWNpcGllbnRfRXZlbnRzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9yZWNpcGllbnRfRXZlbnRzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICdkNWMyOGQwZS1iOWU1LTRhOWEtOTc1Zi05ZjliMDA1NDViNGUnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ0V2ZW50JykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9yZWNpcGllbnRfc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAncmVjaXBpZW50X0V2ZW50cycsICdFbnRpdHlPYmplY3QnLCAxLCAicmVjaXBpZW50IGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJFdmVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3JlY2lwaWVudF9FdmVudHMnLCAnRW50aXR5T2JqZWN0JywgMSwgInJlY2lwaWVudCBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIkV2ZW50Iik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LnJlY2lwaWVudCh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9yZWNpcGllbnRfRXZlbnRzLnB1c2goLi4udik7CgkJdGhpcy5fcmVjaXBpZW50X0V2ZW50c19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fcmVjaXBpZW50X0V2ZW50c19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfcmVjaXBpZW50X0V2ZW50cygpIHsKCQl0aGlzLl9yZWNpcGllbnRfRXZlbnRzX3NldCA9IG51bGw7CgkJdGhpcy5fcmVjaXBpZW50X0V2ZW50cyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX3JlY2lwaWVudF9FdmVudHNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciByZWNpcGllbnRfRXZlbnRzICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYmFja3VwX05vZGVzICoqLwoJYmFja3VwX05vZGVzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9iYWNrdXBfTm9kZXM7CgoJCWlmICh2ICYmIHYudG9FbnRpdHlPYmplY3QgJiYgdi5FbnRpdHlDbGFzcy5JZCAhPT0gJzllMmEwZDcwLTlhMWItNDc2Mi1hOWRiLTA2MGU2NTc5NWM4OScgJiYgdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnTm9kZScpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fYmFja3VwX3NldCkuZm9yRWFjaChfdiA9PiB7CgkJCWlmICghX3YuY29uc3RydWN0b3IpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2JhY2t1cF9Ob2RlcycsICdFbnRpdHlPYmplY3QnLCAxLCAiYmFja3VwIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJOb2RlIikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnYmFja3VwX05vZGVzJywgJ0VudGl0eU9iamVjdCcsIDEsICJiYWNrdXAgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJOb2RlIik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LmJhY2t1cCh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9iYWNrdXBfTm9kZXMucHVzaCguLi52KTsKCQl0aGlzLl9iYWNrdXBfTm9kZXNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX2JhY2t1cF9Ob2Rlc19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfYmFja3VwX05vZGVzKCkgewoJCXRoaXMuX2JhY2t1cF9Ob2Rlc19zZXQgPSBudWxsOwoJCXRoaXMuX2JhY2t1cF9Ob2RlcyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX2JhY2t1cF9Ob2Rlc19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGJhY2t1cF9Ob2RlcyAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHBhcmVudF9Ob2RlcyAqKi8KCXBhcmVudF9Ob2Rlcyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fcGFyZW50X05vZGVzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICc5ZTJhMGQ3MC05YTFiLTQ3NjItYTlkYi0wNjBlNjU3OTVjODknICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ05vZGUnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX3BhcmVudF9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdwYXJlbnRfTm9kZXMnLCAnRW50aXR5T2JqZWN0JywgMSwgInBhcmVudCBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiTm9kZSIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3BhcmVudF9Ob2RlcycsICdFbnRpdHlPYmplY3QnLCAxLCAicGFyZW50IG5vdCB2YWxpZCIsIF92LCBfdi5jb25zdHJ1Y3Rvci5uYW1lLCAiTm9kZSIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5wYXJlbnQodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fcGFyZW50X05vZGVzLnB1c2goLi4udik7CgkJdGhpcy5fcGFyZW50X05vZGVzX3NldCA9IG5ldyBEYXRlKCk7CgkJaWYgKGNvKSB0aGlzLl9wYXJlbnRfTm9kZXNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX3BhcmVudF9Ob2RlcygpIHsKCQl0aGlzLl9wYXJlbnRfTm9kZXNfc2V0ID0gbnVsbDsKCQl0aGlzLl9wYXJlbnRfTm9kZXMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9wYXJlbnRfTm9kZXNfY29vcCA9IG51bGw7CgkJcmV0dXJuIHRoaXM7Cgl9CgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBwYXJlbnRfTm9kZXMgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBub2RlX05vZGVfR3JvdXBfTWVtYmVycyAqKi8KCW5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl9ub2RlX05vZGVfR3JvdXBfTWVtYmVyczsKCgkJaWYgKHYgJiYgdi50b0VudGl0eU9iamVjdCAmJiB2LkVudGl0eUNsYXNzLklkICE9PSAnNTljYmRkMTEtZWNiMC00N2ZiLWIwMTUtZTI5YmUzNGU3NGZhJyAmJiB2LkVudGl0eUNsYXNzLk5hbWUgIT09ICdOb2RlIEdyb3VwIE1lbWJlcicpIHJldHVybiB0aGlzOwoKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgoJCXYuZmlsdGVyKF92ID0+IF92ICYmICFfdi5fbm9kZV9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdub2RlX05vZGVfR3JvdXBfTWVtYmVycycsICdFbnRpdHlPYmplY3QnLCAxLCAibm9kZSBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiTm9kZV9Hcm91cF9NZW1iZXIiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdub2RlX05vZGVfR3JvdXBfTWVtYmVycycsICdFbnRpdHlPYmplY3QnLCAxLCAibm9kZSBub3QgdmFsaWQiLCBfdiwgX3YuY29uc3RydWN0b3IubmFtZSwgIk5vZGVfR3JvdXBfTWVtYmVyIik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92Lm5vZGUodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMucHVzaCguLi52KTsKCQl0aGlzLl9ub2RlX05vZGVfR3JvdXBfTWVtYmVyc19zZXQgPSBuZXcgRGF0ZSgpOwoJCWlmIChjbykgdGhpcy5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKCkgewoJCXRoaXMuX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzX3NldCA9IG51bGw7CgkJdGhpcy5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl9ub2RlX05vZGVfR3JvdXBfTWVtYmVyc19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fYWRkcmVzc19zZXQsCgoJCQl0aGlzLl9iYWNrdXBfc2V0LAoKCQkJdGhpcy5fcGFyZW50X3NldCwKCgkJCXRoaXMuX3BvcnRfc2V0LAoKCQkJdGhpcy5fb25saW5lX3NldCwKCgkJCXRoaXMuX3NlY3VyZV9zZXQsCgoJCQl0aGlzLl90eXBlX3NldCwKCgkJCXRoaXMuX2FjdGl2ZV9zZXQsCgoJCQl0aGlzLl9lbmFibGVkX3NldCwKCgkJCXRoaXMuX2NvZGVfc2V0LAoKCQkJdGhpcy5fb3JkZXJfc2V0LAoKCQkJdGhpcy5fZGF0ZV9zZXQsCgoJCQl0aGlzLl9uYW1lX3NldCwKCgkJCXRoaXMuX3JlbWFya19zZXQsCgoJCQl0aGlzLl9ub2RlX0NvbmZpZ3Nfc2V0LAoKCQkJdGhpcy5fY2Fycmllcl9FdmVudHNfc2V0LAoKCQkJdGhpcy5fc2VuZGVyX0V2ZW50c19zZXQsCgoJCQl0aGlzLl9yZWNpcGllbnRfRXZlbnRzX3NldCwKCgkJCXRoaXMuX2JhY2t1cF9Ob2Rlc19zZXQsCgoJCQl0aGlzLl9wYXJlbnRfTm9kZXNfc2V0LAoKCQkJdGhpcy5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnNfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fYWRkcmVzc19zZXQgPSB0aGlzLl9hZGRyZXNzX3NldDsKCQlyZXQuX2FkZHJlc3NfY29vcCA9IHRoaXMuX2FkZHJlc3NfY29vcDsKCQlyZXQuYWRkcmVzcyA9IHRoaXMuYWRkcmVzcygpID8gdGhpcy5hZGRyZXNzKCkgOiB0aGlzLmFkZHJlc3MoKTsKCgkJcmV0Ll9iYWNrdXBfc2V0ID0gdGhpcy5fYmFja3VwX3NldDsKCQlyZXQuX2JhY2t1cF9jb29wID0gdGhpcy5fYmFja3VwX2Nvb3A7CgkJcmV0LmJhY2t1cCA9IHRoaXMuYmFja3VwKCkgPyB0aGlzLmJhY2t1cCgpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLmJhY2t1cCgpOwoKCQlyZXQuX3BhcmVudF9zZXQgPSB0aGlzLl9wYXJlbnRfc2V0OwoJCXJldC5fcGFyZW50X2Nvb3AgPSB0aGlzLl9wYXJlbnRfY29vcDsKCQlyZXQucGFyZW50ID0gdGhpcy5wYXJlbnQoKSA/IHRoaXMucGFyZW50KCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMucGFyZW50KCk7CgoJCXJldC5fcG9ydF9zZXQgPSB0aGlzLl9wb3J0X3NldDsKCQlyZXQuX3BvcnRfY29vcCA9IHRoaXMuX3BvcnRfY29vcDsKCQlyZXQucG9ydCA9IHRoaXMucG9ydCgpID8gdGhpcy5wb3J0KCkgOiB0aGlzLnBvcnQoKTsKCgkJcmV0Ll9vbmxpbmVfc2V0ID0gdGhpcy5fb25saW5lX3NldDsKCQlyZXQuX29ubGluZV9jb29wID0gdGhpcy5fb25saW5lX2Nvb3A7CgkJcmV0Lm9ubGluZSA9IHRoaXMub25saW5lKCkgPyB0aGlzLm9ubGluZSgpIDogdGhpcy5vbmxpbmUoKTsKCgkJcmV0Ll9zZWN1cmVfc2V0ID0gdGhpcy5fc2VjdXJlX3NldDsKCQlyZXQuX3NlY3VyZV9jb29wID0gdGhpcy5fc2VjdXJlX2Nvb3A7CgkJcmV0LnNlY3VyZSA9IHRoaXMuc2VjdXJlKCkgPyB0aGlzLnNlY3VyZSgpIDogdGhpcy5zZWN1cmUoKTsKCgkJcmV0Ll90eXBlX3NldCA9IHRoaXMuX3R5cGVfc2V0OwoJCXJldC5fdHlwZV9jb29wID0gdGhpcy5fdHlwZV9jb29wOwoJCXJldC50eXBlID0gdGhpcy50eXBlKCkgPyB0aGlzLnR5cGUoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy50eXBlKCk7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5ub2RlX0NvbmZpZ3MgPSB0aGlzLm5vZGVfQ29uZmlncygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0LmNhcnJpZXJfRXZlbnRzID0gdGhpcy5jYXJyaWVyX0V2ZW50cygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0LnNlbmRlcl9FdmVudHMgPSB0aGlzLnNlbmRlcl9FdmVudHMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldC5yZWNpcGllbnRfRXZlbnRzID0gdGhpcy5yZWNpcGllbnRfRXZlbnRzKCkubWFwKHQgPT4gdCA/IHQuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHQpOwoKCQlyZXQuYmFja3VwX05vZGVzID0gdGhpcy5iYWNrdXBfTm9kZXMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldC5wYXJlbnRfTm9kZXMgPSB0aGlzLnBhcmVudF9Ob2RlcygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0Lm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzID0gdGhpcy5ub2RlX05vZGVfR3JvdXBfTWVtYmVycygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkiYWRkcmVzcyI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhZGRyZXNzJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiYmFja3VwIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2JhY2t1cCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJInBhcmVudCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwYXJlbnQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJwb3J0IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3BvcnQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvbmxpbmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb25saW5lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkic2VjdXJlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3NlY3VyZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInR5cGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCW5vZGVfQ29uZmlnczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25vZGVfTm9kZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQljYXJyaWVyX0V2ZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NhcnJpZXJfTm9kZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQlzZW5kZXJfRXZlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc2VuZGVyX05vZGVzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCW9ialtlYUNvZGVdID0gKHYgfHwgW10pLm1hcChfdiA9PiB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gX3YpIDogbnVsbDsKCQkJCQkJbGV0IHJldCA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gX3YuX3RvSGFzaChudWxsLCBvcHRpb25zKSA6IG51bGwpOwoJCQkJCQlpZiAob3B0aW9ucy5jYWNoZSAmJiAhaCkgb3B0aW9ucy5jYWNoZS5wdXNoKHsKCQkJCQkJCW9iajogdiwKCQkJCQkJCWhhc2g6IHJldAoJCQkJCQl9KTsKCQkJCQkJcmV0dXJuIHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJcmVjaXBpZW50X0V2ZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlY2lwaWVudF9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCWJhY2t1cF9Ob2RlczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2JhY2t1cF9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCXBhcmVudF9Ob2RlczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3BhcmVudF9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCW5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbm9kZV9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQlvYmpbZWFDb2RlXSA9ICh2IHx8IFtdKS5tYXAoX3YgPT4gewoJCQkJCQlsZXQgaCA9IG9wdGlvbnMuY2FjaGUgPyBvcHRpb25zLmNhY2hlLmZpbmQoX2ggPT4gX2gub2JqID09IF92KSA6IG51bGw7CgkJCQkJCWxldCByZXQgPSBoID8gaC5oYXNoIDogKChvcHRpb25zLmNhY2hlICYmIG9wdGlvbnMuY2FjaGUubGVuZ3RoIDwgb3B0aW9ucy5jYWNoZUxpbWl0KSA/IF92Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiByZXQKCQkJCQkJfSk7CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl90b0hhc2giKTsKCQl9CgoJCXJldHVybiBvcHRpb25zLk5vQ29kZSA/IG9IYXNoIDogdGhpcy5oYXNoQ29kZShKU09OLnN0cmluZ2lmeShvSGFzaCkpOwoJfQoKCWFzeW5jIF9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9hdXRob3JpemUodXNlcm5hbWUsIHBhc3N3b3JkLCBiU2VydmVyKTsKCgl9CgoJX3FsU2VsZWN0aW9ucyhzU2V0KSB7CgkJbGV0IHJldCA9IFtdOwoJCWlmICghc1NldCB8fCAhc1NldC5zZWxlY3Rpb25zKSByZXR1cm4gcmV0OwoKCQlzU2V0LnNlbGVjdGlvbnMuZmlsdGVyKHMgPT4gcy5zZWxlY3Rpb25TZXQpLmZvckVhY2gocyA9PiB7CgoJCQlpZiAocy5uYW1lLnZhbHVlID09ICJiYWNrdXAiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIGJhY2t1cCcsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuTm9kZSgpLmJhY2t1cF9Ob2Rlcyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInBhcmVudCIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgcGFyZW50Jywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Ob2RlKCkucGFyZW50X05vZGVzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAidHlwZSIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgdHlwZScsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuTm9kZV9UeXBlKCkudHlwZV9Ob2Rlcyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpICE9ICdOb2RlJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQkJY2FzZSAiYXV0aENvZGUiOiB7CgoJCQkJCWRhdGEuY29kZSA9IGRhdGEuY29kZSA/IGRhdGEuY29kZQoKCQkJCQkJOgoJCQkJCQl1bmRlZmluZWQ7CgoJCQkJCWRhdGEudG9vbCA9IGRhdGEudG9vbCA/IGRhdGEudG9vbAoKCQkJCQkJLl90b0RvY3VtZW50KCkKCgkJCQkJCToKCQkJCQkJdW5kZWZpbmVkOwoKCQkJCQlicmVhazsKCQkJCX0KCgkJCQljYXNlICJ1cGRhdGVBUEkiOiB7CgoJCQkJCWRhdGEuc2NyaXB0ID0gZGF0YS5zY3JpcHQgPyBkYXRhLnNjcmlwdAoKCQkJCQkJOgoJCQkJCQl1bmRlZmluZWQ7CgoJCQkJCWRhdGEuZmlsZW5hbWUgPSBkYXRhLmZpbGVuYW1lID8gZGF0YS5maWxlbmFtZQoKCQkJCQkJOgoJCQkJCQl1bmRlZmluZWQ7CgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCWNhc2UgImluaXQiOiB7CgoJCQkJCWRhdGEub25saW5lID0gZGF0YS5vbmxpbmUgPyBkYXRhLm9ubGluZQoKCQkJCQkJOgoJCQkJCQl1bmRlZmluZWQ7CgoJCQkJCWRhdGEuY29kZSA9IGRhdGEuY29kZSA/IGRhdGEuY29kZQoKCQkJCQkJOgoJCQkJCQl1bmRlZmluZWQ7CgoJCQkJCWRhdGEudWlkID0gZGF0YS51aWQgPyBkYXRhLnVpZAoKCQkJCQkJOgoJCQkJCQl1bmRlZmluZWQ7CgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCWNhc2UgImRhcnRBUEkiOiB7CgoJCQkJCWRhdGEuc2NvcGUgPSBkYXRhLnNjb3BlID8gZGF0YS5zY29wZQoKCQkJCQkJOgoJCQkJCQl1bmRlZmluZWQ7CgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCWNhc2UgInJlc3RhcnQiOiB7CgoJCQkJCWJyZWFrOwoJCQkJfQoKCQkJCWNhc2UgInN0YXR1cyI6IHsKCgkJCQkJYnJlYWs7CgkJCQl9CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL05vZGUvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQkJZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOwoJCQkJZGVsZXRlIGRhdGEuX190aGlzLm9ubGluZTsKCgkJCX0KCgkJCS8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/PwoKCQkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJCXRyeSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0pIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7bWV0aG9kfWApOwoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCWxldCBfaWQgPSBudWxsOwoJCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBkYXRhLCBtZXRob2QsIHt9KTsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRhdGEpID09PSAnc3RyaW5nJykgewoJCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUoZGF0YSk7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IGRhdGEuX190aGlzLmNvZGUgfHwgZGF0YS5pZCB8fCBkYXRhLklEOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJCWlmIChkYXRhLklkICYmIGRhdGEuSWQgPT0gZGF0YS5JZCkgewoJCQkJCQlfaWQgPSBkYXRhLklkOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQkJfSBlbHNlIGlmIChkYXRhLkVudGl0eUNsYXNzKSB7CgkJCQkJCV9pZCA9IGRhdGEuRW50aXR5Q2xhc3MuSWQgfHwgZGF0YS5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjllMmEwZDcwLTlhMWItNDc2Mi1hOWRiLTA2MGU2NTc5NWM4OSIgfHwgIk5VTEwiOwoJCQkJCX0KCQkJCX0KCgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVttZXRob2RdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlW21ldGhvZF0gfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlW21ldGhvZF1bX2lkXSB8fCB7fTsKCgkJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goe30sIHsKCQkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQkJfSk7CgoJCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVttZXRob2RdW19pZF1bX2hhc2hdOwoJCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiA1KSkgewoJCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gbWV0aG9kIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJCXYucmV1c2VkKys7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhKTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnTm9kZScpLnNlbmRlcihzYWxlc25vdy5fbm9kZSkuY2FycmllcihzYWxlc25vdy5fbm9kZSkucGF5bG9hZChkYXRhKTsKCQkJaWYgKGV2ZW50KSB7CgkJCQlpZiAoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7CgkJCQlpZiAoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7CgkJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7CgkJCQlpZiAoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7CgkJCX0KCQkJcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOwoKCQkJaWYgKHR5cGVvZihyZXQpID09PSAic3RyaW5nIikgewoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChleCkge30KCQkJfQoJCQlyZXR1cm4gcmV0OwoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImF1dGhDb2RlIjogewoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJ1cGRhdGVBUEkiOiB7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImluaXQiOiB7CgoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuTm9kZShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAiZGFydEFQSSI6IHsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAicmVzdGFydCI6IHsKCgkJCQlicmVhazsKCQkJfQoKCQkJY2FzZSAic3RhdHVzIjogewoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5Ob2RlKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyZXQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWlmIChyZXQgJiYgIUFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOb3QgYW4gQXJyYXkgaW4gRmluZEFsbCIsIHJldCk7CgkJCQkJcmV0ID0gW3JldF07CgkJCQl9CgkJCQlpZiAoIWJSYXcgJiYgcmV0Lm1hcCkgcmV0ID0gcmV0Lm1hcChwID0+IG5ldyBzYWxlc25vdy5Ob2RlKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJhdXRoQ29kZSI6IHsKCgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmNvZGUpOwoKCQkJCV9wYXJhbXMudG9vbCA9IG5ldyBzYWxlc25vdy5Ub29sKCkuX2Zyb21Eb2N1bWVudChfcGFyYW1zLnRvb2wpLl9kZVJlZmVyZW5jZSgpOwoKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMudG9vbCk7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgInVwZGF0ZUFQSSI6IHsKCgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnNjcmlwdCk7CgoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5maWxlbmFtZSk7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImluaXQiOiB7CgoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vbmxpbmUpOwoKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuY29kZSk7CgoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy51aWQpOwoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJkYXJ0QVBJIjogewoKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc2NvcGUpOwoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJyZXN0YXJ0IjogewoKCQkJCWJyZWFrOwoJCQl9CgoJCQljYXNlICJzdGF0dXMiOiB7CgoJCQkJYnJlYWs7CgkJCX0KCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYE5vZGUuX2ludm9rZTogb2JqIGlzIHVuZGVmaW5lZGAKCQkJCX0KCQkJfTsKCQl9IGVsc2UgaWYgKCFvYmpbbWV0aG9kXSkgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMic6IGBOb2RlLl9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQlpZiAoZmFsc2UgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCXJldCA9IHsKCQkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCQknLTQnOiAiVW5jb21taXR0ZWQgdHJhbnNhY3Rpb25zOiAiICsgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5zcWxzLmxlbmd0aCwKCQkJCQkJJ29iaic6IG9iagoJCQkJCX0KCQkJCX0KCQkJfQoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGUuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZS4nICsgbWV0aG9kKX1gKTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9wYXJzZUNvZGVTdGF0ZSh0KSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9wYXJzZUNvZGVTdGF0ZSh0KTsKCgl9CgoJYXN5bmMgX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlIHx8ICJOb2RlIik7CgoJfQoKCV9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4ID0gJ3t7JywgcG9zdGZpeCA9ICd9fScpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXgsIHBvc3RmaXgpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQlpZiAodGhpcy5fYmFja3VwX3NldCAmJiB0aGlzLmJhY2t1cCgpKSB0aGlzLmJhY2t1cCgpLl9fc3luY19vbihkKTsKCgkJCWlmICh0aGlzLl9wYXJlbnRfc2V0ICYmIHRoaXMucGFyZW50KCkpIHRoaXMucGFyZW50KCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX3R5cGVfc2V0ICYmIHRoaXMudHlwZSgpKSB0aGlzLnR5cGUoKS5fX3N5bmNfb24oZCk7CgoJCQkvLyB0aGlzLm5vZGVfTm9kZXMoKS5mb3JFYWNoKHQgPT4gdC5fX3N5bmNfb24oZCkpOwoKCQkJLy8gdGhpcy5jYXJyaWVyX05vZGVzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCS8vIHRoaXMuc2VuZGVyX05vZGVzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCS8vIHRoaXMucmVjaXBpZW50X05vZGVzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCS8vIHRoaXMuYmFja3VwX05vZGVzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCS8vIHRoaXMucGFyZW50X05vZGVzKCkuZm9yRWFjaCh0ID0+IHQuX19zeW5jX29uKGQpKTsKCgkJCS8vIHRoaXMubm9kZV9Ob2RlcygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93Lk5vZGUodGhpcy5JZCkKCgkJCS5hZGRyZXNzKHRoaXMuYWRkcmVzcygpLCB0aGlzLl9hZGRyZXNzX2Nvb3ApCgoJCQkuYmFja3VwKHRoaXMuYmFja3VwKCksIHRoaXMuX2JhY2t1cF9jb29wKQoKCQkJLnBhcmVudCh0aGlzLnBhcmVudCgpLCB0aGlzLl9wYXJlbnRfY29vcCkKCgkJCS5wb3J0KHRoaXMucG9ydCgpLCB0aGlzLl9wb3J0X2Nvb3ApCgoJCQkub25saW5lKHRoaXMub25saW5lKCksIHRoaXMuX29ubGluZV9jb29wKQoKCQkJLnNlY3VyZSh0aGlzLnNlY3VyZSgpLCB0aGlzLl9zZWN1cmVfY29vcCkKCgkJCS50eXBlKHRoaXMudHlwZSgpLCB0aGlzLl90eXBlX2Nvb3ApCgoJCQkuYWN0aXZlKHRoaXMuYWN0aXZlKCksIHRoaXMuX2FjdGl2ZV9jb29wKQoKCQkJLmVuYWJsZWQodGhpcy5lbmFibGVkKCksIHRoaXMuX2VuYWJsZWRfY29vcCkKCgkJCS5jb2RlKHRoaXMuY29kZSgpLCB0aGlzLl9jb2RlX2Nvb3ApCgoJCQkub3JkZXIodGhpcy5vcmRlcigpLCB0aGlzLl9vcmRlcl9jb29wKQoKCQkJLmRhdGUodGhpcy5kYXRlKCksIHRoaXMuX2RhdGVfY29vcCkKCgkJCS5uYW1lKHRoaXMubmFtZSgpLCB0aGlzLl9uYW1lX2Nvb3ApCgoJCQkucmVtYXJrKHRoaXMucmVtYXJrKCksIHRoaXMuX3JlbWFya19jb29wKQoKCQkJLm5vZGVfQ29uZmlncyh0aGlzLm5vZGVfQ29uZmlncygpLCB0aGlzLl9ub2RlX0NvbmZpZ3NfY29vcCkKCgkJCS5jYXJyaWVyX0V2ZW50cyh0aGlzLmNhcnJpZXJfRXZlbnRzKCksIHRoaXMuX2NhcnJpZXJfRXZlbnRzX2Nvb3ApCgoJCQkuc2VuZGVyX0V2ZW50cyh0aGlzLnNlbmRlcl9FdmVudHMoKSwgdGhpcy5fc2VuZGVyX0V2ZW50c19jb29wKQoKCQkJLnJlY2lwaWVudF9FdmVudHModGhpcy5yZWNpcGllbnRfRXZlbnRzKCksIHRoaXMuX3JlY2lwaWVudF9FdmVudHNfY29vcCkKCgkJCS5iYWNrdXBfTm9kZXModGhpcy5iYWNrdXBfTm9kZXMoKSwgdGhpcy5fYmFja3VwX05vZGVzX2Nvb3ApCgoJCQkucGFyZW50X05vZGVzKHRoaXMucGFyZW50X05vZGVzKCksIHRoaXMuX3BhcmVudF9Ob2Rlc19jb29wKQoKCQkJLm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKHRoaXMubm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMoKSwgdGhpcy5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnNfY29vcCkKCgl9CgoJX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpIHsKCQljb250ZXh0ID0gY29udGV4dCB8fCAnRW50aXR5QXR0cmlidXRlJzsKCQkvL29iakZyb20gPSBvYmpGcm9tIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkvL29ialRvID0gb2JqVG8gfHwge307CgkJY2xhc3NOYW1lID0gY2xhc3NOYW1lIHx8ICdOb2RlJzsKCQl0b29sID0gdG9vbCB8fCB0aGlzLlRvb2w7CgkJY29kZVR5cGUgPSBjb2RlVHlwZSB8fCBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUppWVdOcmRYQWlPaUpPYjJSbElpd2ljR0Z5Wlc1MElqb2lUbTlrWlNJc0luUjVjR1VpT2lKT2IyUmxYMVI1Y0dVaUxDSjBiMjlzSWpvaVZHOXZiQ0o5YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSlbY29kZV07CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIk5vZGUiOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19jb25maWcobiwgbnVsbFZhbHVlLCBPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zIHx8IHt9LCB7CgkJCV9jbGFzczogJ05vZGUnCgkJfSkpOwoKCX0KCgkvKioKCSAqIFN1bW1hcnkuIGF1dGhDb2RlLgoJICoKCSAqIERlc2NyaXB0aW9uLiAuCgkgKgoJICogQHNpbmNlICAgICAgeC54LngKCSAqIEBkZXByZWNhdGVkIHgueC54IFVzZSBuZXdfZnVuY3Rpb25fbmFtZSgpIGluc3RlYWQuCgkgKiBAYWNjZXNzICAgICBwdWJsaWMKCSAqCgkgKiBAY2xhc3MKCSAqIEBhdWdtZW50cyBwYXJlbnQKCSAqIEBtaXhlcyAgICBtaXhpbgoJICoKCSAqIEBhbGlhcyAgICByZWFsTmFtZQoJICogQG1lbWJlcm9mIG5hbWVzcGFjZQoJICoKCSAqIEBzZWUgIEZ1bmN0aW9uL2NsYXNzIHJlbGllZCBvbgoJICogQGxpbmsgVVJMCgkgKiBAZ2xvYmFsCgkgKgoJICogQGZpcmVzICAgZXZlbnROYW1lCgkgKiBAZmlyZXMgICBjbGFzc05hbWUjZXZlbnROYW1lCgkgKiBAbGlzdGVucyBldmVudDpldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGNsYXNzTmFtZX5ldmVudDpldmVudE5hbWUKCSAqIEBwYXJhbSB7dHlwZX0gICB2YXIgICAgICAgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXJdICAgICAgICAgRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUuCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcj1kZWZhdWx0XSBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZSB3aXRoIGRlZmF1bHQgdmFyaWFibGUuCgkgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0VmFyICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBvYmplY3RWYXIua2V5IERlc2NyaXB0aW9uIG9mIGEga2V5IGluIHRoZSBvYmplY3RWYXIgcGFyYW1ldGVyLgoJICoKCSAqIEB5aWVsZCB7dHlwZX0gWWllbGRlZCB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqCgkgKiBAcmV0dXJuIHt0eXBlfSBSZXR1cm4gdmFsdWUgZGVzY3JpcHRpb24uCgkgKi8KCWFzeW5jIGF1dGhDb2RlKGNvZGUsIHRvb2wpIHsKCgkJbGV0IGFuc3dlciA9IG51bGw7CgoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImF1dGhDb2RlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImF1dGhDb2RlIiwgX25vZGUsIGNvZGUsIHRvb2wpID0+IHsKCQkJcmV0dXJuIF9ub2RlLl9zYW1lTm9kZShvU2NvcGUuX25vZGUuX3BhcmVudCkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiYXV0aENvZGUiLCBjb2RlLCB0b29sKSA9PiB7CgoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZS5hdXRoQ29kZScpOwoKCQkJdmFyIGVycm9ycyA9IHsKCgkJCQkiY29kZS1yZXF1aXJlZCI6ICgoY29kZSwgdG9vbCkgPT4gewoKCQkJCQlsZXQgYW5zd2VyID0KCgkJCQkJCXR5cGVvZihjb2RlKSA9PT0gJ3VuZGVmaW5lZCcKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdhdXRoQ29kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgImNvZGUtcmVxdWlyZWQiLCBhbnN3ZXIpOwoJCQkJCXJldHVybiBhbnN3ZXI7CgkJCQl9KShjb2RlLCB0b29sKSA/ICgnY29kZSBpcyBhIHJlcXVpcmVkIFBhcmFtZXRlcicgfHwgJ1ZhbGlkYXRpb24gRXJyb3InKSA6ICcnLAoKCQkJCSJ0b29sLXJlcXVpcmVkIjogKChjb2RlLCB0b29sKSA9PiB7CgoJCQkJCWxldCBhbnN3ZXIgPQoKCQkJCQkJdHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJwoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ2F1dGhDb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJhbnN3ZXIiLCAidG9vbC1yZXF1aXJlZCIsIGFuc3dlcik7CgkJCQkJcmV0dXJuIGFuc3dlcjsKCQkJCX0pKGNvZGUsIHRvb2wpID8gKCd0b29sIGlzIGEgcmVxdWlyZWQgUGFyYW1ldGVyJyB8fCAnVmFsaWRhdGlvbiBFcnJvcicpIDogJycsCgoJCQkJInRvb2wiOiAoKGNvZGUsIHRvb2wpID0+IHsKCgkJCQkJbGV0IGFuc3dlciA9CgoJCQkJCQkoIXRvb2wgJiYgdHJ1ZSkgfHwgKHRvb2wgJiYgKHRvb2wuY29uc3RydWN0b3IubmFtZSAhPSAnVG9vbCcgfHwgdG9vbC5FbnRpdHlDbGFzcy5OYW1lICE9ICdUb29sJykpCgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnYXV0aENvZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgImFuc3dlciIsICJ0b29sIiwgYW5zd2VyKTsKCQkJCQlyZXR1cm4gYW5zd2VyOwoJCQkJfSkoY29kZSwgdG9vbCkgPyAoJ3Rvb2wgaXMgbm90IG9mIHR5cGUgVG9vbCcgfHwgJ1ZhbGlkYXRpb24gRXJyb3InKSA6ICcnLAoKCQkJfTsKCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiAhZXJyb3JzW2tdKS5mb3JFYWNoKGsgPT4gZGVsZXRlIGVycm9yc1trXSk7CgkJCWlmIChPYmplY3Qua2V5cyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJT2JqZWN0LmtleXMoZXJyb3JzKS5maWx0ZXIoayA9PiBrLnN0YXJ0c1dpdGgoJy0nKSkuZm9yRWFjaChrID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdhdXRoQ29kZScsICdFbnRpdHlPYmplY3QnLCAwLCB7CgkJCQkJCVtrXTogZXJyb3JzW2tdCgkJCQkJfSk7CgkJCQkJZGVsZXRlIGVycm9yc1trXTsKCQkJCX0pOwoJCQkJaWYgKE9iamVjdC52YWx1ZXMoZXJyb3JzKS5sZW5ndGgpIHsKCQkJCQlyZXR1cm4gewoJCQkJCQlfX2V4Y2VwdGlvbjogZXJyb3JzLAoJCQkJCX07CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJCXRoaXMuX19jb25maWcoJ29hdXRoLmF1dGhvcml6ZS5jb2RlJywgbnVsbCwgewoJCQkJbmV3VmFsdWU6IGNvZGUsCgkJCQl0b29sOiB0b29sCgkJCX0pCgoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10sCgkJCWNvZGU6IGNvZGUsCgkJCXRvb2w6IHRvb2wKCQl9KTsKCgkJLy8gdGFrZSBvdXQgdGhlIGludmFsaWQgbm9kZSByZXN1bHRzCgkJcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gciAmJiByLnJldCk7CgoJCS8vIGhhcyBhbnkgbm9kZSBnZW5lcmF0ZWQgYSB2YWxpZGF0aW9uIGV4Y2VwdGlvbj8KCQlsZXQgX19leCA9IHJlc3VsdHMuZmluZChyID0+IHIucmV0Ll9fZXhjZXB0aW9uKTsKCQlpZiAoX19leCkgcmV0dXJuIF9fZXgucmV0OwoKCQlyZXR1cm4gcmVzdWx0cy5sZW5ndGggPyByZXN1bHRzWzBdLnJldCA6IG51bGw7CgoJfQoKCS8qKgoJICogU3VtbWFyeS4gdXBkYXRlQVBJLgoJICoKCSAqIERlc2NyaXB0aW9uLiAuCgkgKgoJICogQHNpbmNlICAgICAgeC54LngKCSAqIEBkZXByZWNhdGVkIHgueC54IFVzZSBuZXdfZnVuY3Rpb25fbmFtZSgpIGluc3RlYWQuCgkgKiBAYWNjZXNzICAgICBwdWJsaWMKCSAqCgkgKiBAY2xhc3MKCSAqIEBhdWdtZW50cyBwYXJlbnQKCSAqIEBtaXhlcyAgICBtaXhpbgoJICoKCSAqIEBhbGlhcyAgICByZWFsTmFtZQoJICogQG1lbWJlcm9mIG5hbWVzcGFjZQoJICoKCSAqIEBzZWUgIEZ1bmN0aW9uL2NsYXNzIHJlbGllZCBvbgoJICogQGxpbmsgVVJMCgkgKiBAZ2xvYmFsCgkgKgoJICogQGZpcmVzICAgZXZlbnROYW1lCgkgKiBAZmlyZXMgICBjbGFzc05hbWUjZXZlbnROYW1lCgkgKiBAbGlzdGVucyBldmVudDpldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGNsYXNzTmFtZX5ldmVudDpldmVudE5hbWUKCSAqIEBwYXJhbSB7dHlwZX0gICB2YXIgICAgICAgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXJdICAgICAgICAgRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUuCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcj1kZWZhdWx0XSBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZSB3aXRoIGRlZmF1bHQgdmFyaWFibGUuCgkgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0VmFyICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBvYmplY3RWYXIua2V5IERlc2NyaXB0aW9uIG9mIGEga2V5IGluIHRoZSBvYmplY3RWYXIgcGFyYW1ldGVyLgoJICoKCSAqIEB5aWVsZCB7dHlwZX0gWWllbGRlZCB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqCgkgKiBAcmV0dXJuIHt0eXBlfSBSZXR1cm4gdmFsdWUgZGVzY3JpcHRpb24uCgkgKi8KCWFzeW5jIHVwZGF0ZUFQSShzY3JpcHQsIGZpbGVuYW1lKSB7CgoJCWxldCBhbnN3ZXIgPSBmYWxzZTsKCgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlQVBJIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZUFQSSIsIF9ub2RlLCBzY3JpcHQsIGZpbGVuYW1lKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGVBUEkiLCBzY3JpcHQsIGZpbGVuYW1lKSA9PiB7CgoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZS51cGRhdGVBUEknKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQkJInNjcmlwdC1yZXF1aXJlZCI6ICgoc2NyaXB0LCBmaWxlbmFtZSkgPT4gewoKCQkJCQlsZXQgYW5zd2VyID0KCgkJCQkJCXR5cGVvZihzY3JpcHQpID09PSAndW5kZWZpbmVkJwoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ3VwZGF0ZUFQSScsICdFbnRpdHlPYmplY3QnLCAwLCAiYW5zd2VyIiwgInNjcmlwdC1yZXF1aXJlZCIsIGFuc3dlcik7CgkJCQkJcmV0dXJuIGFuc3dlcjsKCQkJCX0pKHNjcmlwdCwgZmlsZW5hbWUpID8gKCdzY3JpcHQgaXMgYSByZXF1aXJlZCBQYXJhbWV0ZXInIHx8ICdWYWxpZGF0aW9uIEVycm9yJykgOiAnJywKCgkJCX07CgkJCU9iamVjdC5rZXlzKGVycm9ycykuZmlsdGVyKGsgPT4gIWVycm9yc1trXSkuZm9yRWFjaChrID0+IGRlbGV0ZSBlcnJvcnNba10pOwoJCQlpZiAoT2JqZWN0LmtleXMoZXJyb3JzKS5sZW5ndGgpIHsKCQkJCU9iamVjdC5rZXlzKGVycm9ycykuZmlsdGVyKGsgPT4gay5zdGFydHNXaXRoKCctJykpLmZvckVhY2goayA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlQVBJJywgJ0VudGl0eU9iamVjdCcsIDAsIHsKCQkJCQkJW2tdOiBlcnJvcnNba10KCQkJCQl9KTsKCQkJCQlkZWxldGUgZXJyb3JzW2tdOwoJCQkJfSk7CgkJCQlpZiAoT2JqZWN0LnZhbHVlcyhlcnJvcnMpLmxlbmd0aCkgewoJCQkJCXJldHVybiB7CgkJCQkJCV9fZXhjZXB0aW9uOiBlcnJvcnMsCgkJCQkJfTsKCQkJCX0KCQkJCXJldHVybjsKCQkJfQoKCQkJaWYgKHR5cGVvZihnbG9iYWwpICE9PSAidW5kZWZpbmVkIikgewoJCQkJLy8gbm9kZWpzCgkJCQlyZXR1cm4gYXdhaXQgZ2xvYmFsLnV0aWwucHJvbWlzaWZ5KGdsb2JhbC5mcy53cml0ZUZpbGUpKGZpbGVuYW1lLCB0aGlzLl9hdG9iKHNjcmlwdCkpOwoJCQl9IGVsc2UgewoJCQkJbG9nKCJCcm93c2VycyBkbyBub3Qgd3JpdGUgdG8gZmlsZXMgZm9yIG5vdyIpOwoJCQl9CgkJCXJldHVybiB0cnVlOwoKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdLAoJCQlzY3JpcHQ6IHNjcmlwdCwKCQkJZmlsZW5hbWU6IGZpbGVuYW1lCgkJfSk7CgoJCS8vIHRha2Ugb3V0IHRoZSBpbnZhbGlkIG5vZGUgcmVzdWx0cwoJCXJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIgJiYgci5yZXQpOwoKCQkvLyBoYXMgYW55IG5vZGUgZ2VuZXJhdGVkIGEgdmFsaWRhdGlvbiBleGNlcHRpb24/CgkJbGV0IF9fZXggPSByZXN1bHRzLmZpbmQociA9PiByLnJldC5fX2V4Y2VwdGlvbik7CgkJaWYgKF9fZXgpIHJldHVybiBfX2V4LnJldDsKCgkJcmV0dXJuIHJlc3VsdHMubGVuZ3RoID8gcmVzdWx0c1swXS5yZXQgOiBudWxsOwoKCX0KCgkvKioKCSAqIFN1bW1hcnkuIGluaXQuCgkgKgoJICogRGVzY3JpcHRpb24uIC4KCSAqCgkgKiBAc2luY2UgICAgICB4LngueAoJICogQGRlcHJlY2F0ZWQgeC54LnggVXNlIG5ld19mdW5jdGlvbl9uYW1lKCkgaW5zdGVhZC4KCSAqIEBhY2Nlc3MgICAgIHB1YmxpYwoJICoKCSAqIEBjbGFzcwoJICogQGF1Z21lbnRzIHBhcmVudAoJICogQG1peGVzICAgIG1peGluCgkgKgoJICogQGFsaWFzICAgIHJlYWxOYW1lCgkgKiBAbWVtYmVyb2YgbmFtZXNwYWNlCgkgKgoJICogQHNlZSAgRnVuY3Rpb24vY2xhc3MgcmVsaWVkIG9uCgkgKiBAbGluayBVUkwKCSAqIEBnbG9iYWwKCSAqCgkgKiBAZmlyZXMgICBldmVudE5hbWUKCSAqIEBmaXJlcyAgIGNsYXNzTmFtZSNldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGV2ZW50OmV2ZW50TmFtZQoJICogQGxpc3RlbnMgY2xhc3NOYW1lfmV2ZW50OmV2ZW50TmFtZQoJICogQHBhcmFtIHt0eXBlfSAgIHZhciAgICAgICAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcl0gICAgICAgICBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyPWRlZmF1bHRdIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlIHdpdGggZGVmYXVsdCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3RWYXIgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIG9iamVjdFZhci5rZXkgRGVzY3JpcHRpb24gb2YgYSBrZXkgaW4gdGhlIG9iamVjdFZhciBwYXJhbWV0ZXIuCgkgKgoJICogQHlpZWxkIHt0eXBlfSBZaWVsZGVkIHZhbHVlIGRlc2NyaXB0aW9uLgoJICoKCSAqIEByZXR1cm4ge3R5cGV9IFJldHVybiB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqLwoJYXN5bmMgaW5pdChvbmxpbmUsIGNvZGUsIHVpZCkgewoKCQlsZXQgYW5zd2VyID0gbmV3IHNhbGVzbm93Lk5vZGUoKTsKCgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5pdCIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbml0IiwgX25vZGUsIG9ubGluZSwgY29kZSwgdWlkKSA9PiB7CgkJCXJldHVybiBfbm9kZS5fc2FtZU5vZGUob1Njb3BlLl9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbml0Iiwgb25saW5lLCBjb2RlLCB1aWQpID0+IHsKCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlLmluaXQnKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luaXQnLCAnRW50aXR5T2JqZWN0JywgMCwgewoJCQkJCQlba106IGVycm9yc1trXQoJCQkJCX0pOwoJCQkJCWRlbGV0ZSBlcnJvcnNba107CgkJCQl9KTsKCQkJCWlmIChPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIHsKCQkJCQkJX19leGNlcHRpb246IGVycm9ycywKCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCQkvLyBkZWZhdWx0cwoJCQlvbmxpbmUgPSBvbmxpbmUgfHwgdGhpcy5fX2NvbmZpZygnaW5pdC5sb29wJyk7CgkJCW9TY29wZS5fbm9kZXMgPSBvU2NvcGUuX25vZGVzIHx8IHt9OwoKCQkJLy8gY29kZSBhbmQgdHlwZSBkZXRlY3Rpb24KCQkJbGV0IG4gPSBudWxsOwoJCQlpZiAoIXVpZCAmJiBvU2NvcGUuX25vZGUpIHsKCQkJCW4gPSBvU2NvcGUuX25vZGU7CgkJCX0gZWxzZSBpZiAodWlkICYmIHR5cGVvZih1aWQpID09PSAnc3RyaW5nJykgewoJCQkJbiA9IG9TY29wZS5fbm9kZXNbdWlkXTsKCQkJfQoKCQkJbGV0IGlwID0gdGhpcy5pcEFkZHJlc3MoKTsKCQkJaXAgPSBbIjE4Mi4xNjguNzAuODIiLCAiMTkyLjE2OC4xLjI1MyJdLmluZGV4T2YoaXApID49IDAgPyAiMTk1LjExMi4yMTUuMjE4IiA6IGlwOwoJCQluID0gbiB8fCBuZXcgb1Njb3BlLk5vZGUoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5zZWN1cmUodGhpcy5zZWN1cmUoKSkuY29kZSh0aGlzLl9fY29uZmlnKCdDb2RlJykgfHwgKHR5cGVvZihnbG9iYWwpICE9PSAndW5kZWZpbmVkJyA/IGdsb2JhbC5tYWNoaW5laWQubWFjaGluZUlkU3luYyh0cnVlKSA6IG51bGwpIHx8IHRoaXMuX19jb25maWcoJ3Rlc3QuY29kZScpIHx8ICgodHlwZW9mKHVpZCkgPT09ICdzdHJpbmcnKSA/IHVpZCA6IG51bGwpIHx8ICgodHlwZW9mKHV1aWQpICE9PSAidW5kZWZpbmVkIikgPyAoIC8qdWlkID0gKi8gdXVpZCgpKSA6IG51bGwpIHx8ICgxMCAqIE1hdGgucmFuZG9tKCkpKS50eXBlKG5ldyBvU2NvcGUuTm9kZV9UeXBlKCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkubmFtZSh0eXBlb2YoZ2xvYmFsKSAhPT0gInVuZGVmaW5lZCIgPyAiTm9kZUpTIiA6ICJCcm93c2VyIikuZHluYW1pYyh0eXBlb2YoZ2xvYmFsKSA9PT0gInVuZGVmaW5lZCIpKS5wb3J0KHRoaXMuX19jb25maWcoJ3BvcnQnKSB8fCAzMDAwKS5hZGRyZXNzKGlwKTsKCgkJCWlmIChuLnR5cGUoKS5keW5hbWljKCkpIHsKCQkJCS8vIHdpdGggZHluYW1pYyBub2RlcyB3ZSBuZWVkIHRvIGNoZWNrIGlmIHRoZXJlIGlzIGEgbm9kZSB0aGF0IGlzIG5vIGxvbmdlciBvbmxpbmUsIGFuZCBiaW5kIHRoaXMgaW5zdGFuY2UgdG8gaXQgKG5vZGUgcmVjeWNsaW5nKQoJCQkJLy8gYSBkeW5hbWljIG5vZGUgaXMgbm8gbG9uZ2VyIG9ubGluZSBpZiBpdCBmYWlscyB0byByZXBvcnQgaXRzIGxhc3Qgb25saW5lIHByZXNlbmNlIGFmdGVyIDUgbWludXRlcyA/Pz8KCQkJCS8vIGdldCBhIHBvb2wgb2YgYWxsIG5vZGVzIHRoYXQgYXJlIG5vIGxvbmdlciBvbmxpbmUsIGJpbmQgdG8gdGhlIG9sZGVzdCBvbmUKCgkJCQlsZXQgZGVhZE5vZGVzID0gYXdhaXQgbmV3IG9TY29wZS5Ob2RlKCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuY29kZShudWxsLCAiIT0iKS50eXBlKG4udHlwZSgpKS5zZWN1cmUobi5zZWN1cmUoKSkub25saW5lKG5ldyBEYXRlKHRoaXMuc3IoKS5zZXJ2ZXJEYXRlKCkgLSAxMCAqIChvbmxpbmUgfHwgNSkgKiA2MDAwMCksICI8PSIpLmZpbmRBbGwoKTsKCgkJCQlpZiAoZGVhZE5vZGVzLmxlbmd0aCkgewoJCQkJCWRlYWROb2Rlcy5zb3J0KChhLCBiKSA9PiBhLl9vbmxpbmUgLSBiLl9vbmxpbmUpOwoJCQkJCWRlYWROb2RlcyA9IGRlYWROb2Rlcy5maWx0ZXIoZG4gPT4gIW9TY29wZS5fbm9kZXNbZG4uY29kZSgpXSk7CgkJCQkJbiA9IGRlYWROb2Rlc1swXTsKCQkJCQlsb2coIlJldXNpbmcgRGVhZCBOb2RlICIgKyBuLmNvZGUoKSk7CgkJCQl9CgkJCX0KCgkJCWlmICh1aWQpIHsKCQkJCW9TY29wZS5fbm9kZXNbdWlkXSA9IG9TY29wZS5fbm9kZXNbdWlkXSB8fCBuOwoJCQkJbiA9IG9TY29wZS5fbm9kZXNbdWlkXTsKCQkJfQoKCQkJaWYgKE9iamVjdC5rZXlzKG9TY29wZS5fbm9kZXMpLmxlbmd0aCA8PSAxKSB7CgkJCQlvU2NvcGUuX25vZGUgPSBuOwoJCQl9IGVsc2UgewoJCQkJZGVsZXRlIG9TY29wZS5fbm9kZTsKCQkJfQoKCQkJb1Njb3BlLm5vZGVJbml0Q2FsbHMgPSBvU2NvcGUubm9kZUluaXRDYWxscyB8fCAwOwoKCQkJdGhpcy5zZXRJbnRlcnZhbChhc3luYyAoc2NvcGUsIHVpZCwgb25saW5lKSA9PiB7CgkJCQlzY29wZS5ub2RlSW5pdENhbGxzKysKCQkJCWxvZygiQ2FsbCAjIiArIHNjb3BlLm5vZGVJbml0Q2FsbHMgKyAiIG9mICIgKyB0aGlzLl9fY29uZmlnKCdpbml0LmVuZHMnKSk7CgoJCQkJbGV0IF9uID0gbnVsbDsKCQkJCWlmICh1aWQgJiYgc2NvcGUuX25vZGVzKSB7CgkJCQkJX24gPSBzY29wZS5fbm9kZXNbdWlkXTsKCQkJCX0KCgkJCQlfbiA9IF9uIHx8IHNjb3BlLl9ub2RlOwoKCQkJCWlmIChfbikgewoJCQkJCWxldCBwSVAgPSBfbi5fX2NvbmZpZygnbm9EZXRlY3QnKSA/IG51bGwgOiBfbi5fX2NvbmZpZygiZGV0ZWN0UGFyZW50LklQIik7CgoJCQkJCWlmIChwSVApIHsKCQkJCQkJLy8gbm9kZSBoYXMgYSBwcmUtY29uZmlndXJlZCBwYXJlbnQKCQkJCQkJX24ucGFyZW50KG5ldyBvU2NvcGUuTm9kZSgpLmFkZHJlc3MocElQKS5wb3J0KHRoaXMuX19jb25maWcoJ3BvcnQnKSB8fCAzMDAwKS5jb2RlKF9uLl9fY29uZmlnKCdkZXRlY3RQYXJlbnQuY29kZScpKS50eXBlKG5ldyBvU2NvcGUuTm9kZV9UeXBlKCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkubmFtZSgiTm9kZUpTIikpLnNlY3VyZShfbi5zZWN1cmUoKSkpOwoJCQkJCQlhd2FpdCBfbi5fYXV0aG9yaXplKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJLy8gbm9kZSBoYXMgbm8gcGFyZW50LCBidXQgYSBwYXJlbnQgcXVlcnkhCgkJCQkJCV9uLnBhcmVudChuZXcgb1Njb3BlLk5vZGUoKS50eXBlKG5ldyBvU2NvcGUuTm9kZV9UeXBlKCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkubmFtZSgnTm9kZUpTJykpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLm9ubGluZShuZXcgRGF0ZSh0aGlzLnNyKCkuc2VydmVyRGF0ZSgpIC0gKG9ubGluZSB8fCA1KSAqIDYwMDAwKSwgIj49IikuY29kZShfbi5fY29kZSwgJyE9JykuYWRkcmVzcygnJywgJyE9JykucG9ydCgnJywgJyE9JykucGFyZW50KG51bGwpKTsKCQkJCQl9CgoJCQkJCWlmICh0aGlzLl9sb2FkVG9vbHMpIGF3YWl0IHRoaXMuX2xvYWRUb29scyh0aGlzLl9fY29uZmlnKCd0b29scy5zdG9yZScsIHRydWUpKTsKCgkJCQkJaWYgKG9TY29wZS5FdmVudCkgewoJCQkJCQlpZiAodGhpcy5fX2NvbmZpZygnZXZlbnQucG9sbGluZy5kaXNhYmxlZCcsIHRydWUpKSB7CgkJCQkJCQlhd2FpdCBuZXcgb1Njb3BlLkV2ZW50KCkubmFtZSh0aGlzLl9fY29uZmlnKCdldmVudCcpIHx8IGAke3RoaXMuU2NvcGV9LkV2ZW50YCkubGlzdGVuKF9uKTsKCQkJCQkJfSBlbHNlIHsKCQkJCQkJCWxvZygiUG9sbGluZyBFdmVudHM6ICIgKyAodGhpcy5Ub29sLnR5cGUgPyB0aGlzLlRvb2wudHlwZS5uYW1lIDogJycpKTsKCgkJCQkJCQlsZXQgbWUgPSBuZXcgb1Njb3BlLk5vZGUoKS5jb2RlKG9TY29wZS5fbm9kZS5jb2RlKCkpOwoJCQkJCQkJbGV0IG5tZSA9IG5ldyBvU2NvcGUuTm9kZSgpLmNvZGUob1Njb3BlLl9ub2RlLmNvZGUoKSwgJyE9Jyk7CgkJCQkJCQlsZXQgZXYgPSBuZXcgb1Njb3BlLkV2ZW50KCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuc2VuZGVyKG1lLCAnTk9UIElOJykucmVjaXBpZW50KG1lKS5yZXNwb25zZVRvKG51bGwpOwoJCQkJCQkJbGV0IG5ldiA9IG5ldyBvU2NvcGUuRXZlbnQoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5zZW5kZXIobWUpLnJlY2lwaWVudChtZSwgJ05PVCBJTicpLnJlc3BvbnNlVG8obnVsbCwgJ05PVCBJTicpOwoJCQkJCQkJbGV0IHFldiA9IGV2LnJlc3BvbnNlVG9fRXZlbnRzKFtuZXZdLCAnTk9UIElOJyk7CgoJCQkJCQkJZm9yIGF3YWl0IChjb25zdCBlIG9mIChhd2FpdCBxZXYuZmluZEFsbCgpKSkgewoJCQkJCQkJCWF3YWl0IGUucHJvY2VzcygpOwoJCQkJCQkJfQoJCQkJCQl9CgkJCQkJfQoJCQkJCWlmIChvU2NvcGUuVHJhbnNhY3Rpb24gJiYgIXRoaXMuX19jb25maWcoJ2hpc3RvcnkucG9sbGluZy5kaXNhYmxlZCcsIHRydWUpKSB7CgkJCQkJCWxvZygiUG9sbGluZyBUcmFuc2FjdGlvbnM6ICIgKyAodGhpcy5Ub29sLnR5cGUgPyB0aGlzLlRvb2wudHlwZS5uYW1lIDogJycpKTsKCQkJCQkJKGF3YWl0IG5ldyBvU2NvcGUuVHJhbnNhY3Rpb24oKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5zdGF0ZShuZXcgb1Njb3BlLlRyYW5hY3Rpb25TdGF0ZSgpLm5hbWUoImxvYWRlZCIpKS5zY29wZSh0aGlzLlNjb3BlKS5jb2RlKG9TY29wZS5fbm9kZS5jb2RlKCkpKS5wcm9jZXNzKCk7CgkJCQkJfQoJCQkJfQoKCQkJCWlmICghX24gfHwgIV9uLl9jb2RlX3NldCkgewoJCQkJCWxvZygiRXhpdGluZyBPbmxpbmUgSW50ZXJ2YWwuLi4gaW5pdCgpIHNob3VsZCBiZSBjYWxsZWQgYWdhaW4uIik7CgkJCQkJX24gPSB1bmRlZmluZWQ7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZihvbmxpbmUpID09PSAndW5kZWZpbmVkJyB8fCAhb25saW5lIHx8IG9ubGluZSA8IDApIHsKCQkJCQlsb2coIk5vdCBpbiBvbmxpbmUgbW9kZS4uLiBleGl0aW5nLiIpOwoJCQkJCV9uID0gdW5kZWZpbmVkOwoJCQkJfQoKCQkJCWlmIChzY29wZS5ub2RlSW5pdENhbGxzID49IHRoaXMuX19jb25maWcoJ2luaXQuZW5kcycsIDIpKSB7CgkJCQkJbG9nKCJFeGNlZWRlZCBjYWxscyBsaW1pdC4uLiBleGl0aW5nLiIpOwoJCQkJCV9uID0gdW5kZWZpbmVkOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX24pID09PSAidW5kZWZpbmVkIikgewoJCQkJCS8vbG9nKCJFeGl0IGNsZWFudXAuLi4iKTsKCQkJCQlpZiAob1Njb3BlLl9fYnJva2VyKSB7CgkJCQkJCWlmIChvU2NvcGUuX19icm9rZXIuZGlzY29ubmVjdCkgb1Njb3BlLl9fYnJva2VyLmRpc2Nvbm5lY3QoKTsKCQkJCQkJaWYgKG9TY29wZS5fX2Jyb2tlci5jbG9zZSkgb1Njb3BlLl9fYnJva2VyLmNsb3NlKCk7CgkJCQkJCWlmIChvU2NvcGUuX19icm9rZXIuZW5kKSBvU2NvcGUuX19icm9rZXIuZW5kKCk7CgkJCQkJfQoJCQkJCXJldHVybiBmYWxzZTsKCQkJCX0KCgkJCQlvU2NvcGUuVG9vbHMuZm9yRWFjaCh0ID0+IHRoaXMuX3BhcnNlQ29kZVN0YXRlKHQpKTsKCgkJCQlhd2FpdCBfbi5vbmxpbmUodGhpcy5zcigpLnNlcnZlckRhdGUoKSkuc3RvcmUoKTsKCQkJCWxvZyhgKCR7X24uX2FkZHJlc3N9OiR7X24uX3BvcnR9KVske19uLl9jb2RlfS8ke19uLklkfV0gaXMgb25saW5lWyR7b25saW5lfV1gKTsKCgkJCQkvL2xvZygibm9kZXMiLCBKU09OLnN0cmluZ2lmeSgoYXdhaXQgbmV3IG9TY29wZS5Ob2RlKCkuZmluZEFsbCgpKS5tYXAobiA9PiBuLl90b0RvY3VtZW50KCkpLCBudWxsLCA0KSk7CgoJCQkJcmV0dXJuIHRydWU7CgkJCX0sIG9ubGluZSwgb1Njb3BlLCB1aWQsIG9ubGluZSk7CgoJCQlyZXR1cm4gbjsKCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXSwKCQkJb25saW5lOiBvbmxpbmUsCgkJCWNvZGU6IGNvZGUsCgkJCXVpZDogdWlkCgkJfSk7CgoJCS8vIHRha2Ugb3V0IHRoZSBpbnZhbGlkIG5vZGUgcmVzdWx0cwoJCXJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIgJiYgci5yZXQpOwoKCQkvLyBoYXMgYW55IG5vZGUgZ2VuZXJhdGVkIGEgdmFsaWRhdGlvbiBleGNlcHRpb24/CgkJbGV0IF9fZXggPSByZXN1bHRzLmZpbmQociA9PiByLnJldC5fX2V4Y2VwdGlvbik7CgkJaWYgKF9fZXgpIHJldHVybiBfX2V4LnJldDsKCgkJcmV0dXJuIHJlc3VsdHMubGVuZ3RoID8gcmVzdWx0c1swXS5yZXQgOiBudWxsOwoKCX0KCgkvKioKCSAqIFN1bW1hcnkuIGRhcnRBUEkuCgkgKgoJICogRGVzY3JpcHRpb24uIC4KCSAqCgkgKiBAc2luY2UgICAgICB4LngueAoJICogQGRlcHJlY2F0ZWQgeC54LnggVXNlIG5ld19mdW5jdGlvbl9uYW1lKCkgaW5zdGVhZC4KCSAqIEBhY2Nlc3MgICAgIHB1YmxpYwoJICoKCSAqIEBjbGFzcwoJICogQGF1Z21lbnRzIHBhcmVudAoJICogQG1peGVzICAgIG1peGluCgkgKgoJICogQGFsaWFzICAgIHJlYWxOYW1lCgkgKiBAbWVtYmVyb2YgbmFtZXNwYWNlCgkgKgoJICogQHNlZSAgRnVuY3Rpb24vY2xhc3MgcmVsaWVkIG9uCgkgKiBAbGluayBVUkwKCSAqIEBnbG9iYWwKCSAqCgkgKiBAZmlyZXMgICBldmVudE5hbWUKCSAqIEBmaXJlcyAgIGNsYXNzTmFtZSNldmVudE5hbWUKCSAqIEBsaXN0ZW5zIGV2ZW50OmV2ZW50TmFtZQoJICogQGxpc3RlbnMgY2xhc3NOYW1lfmV2ZW50OmV2ZW50TmFtZQoJICogQHBhcmFtIHt0eXBlfSAgIHZhciAgICAgICAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgW3Zhcl0gICAgICAgICBEZXNjcmlwdGlvbiBvZiBvcHRpb25hbCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyPWRlZmF1bHRdIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlIHdpdGggZGVmYXVsdCB2YXJpYWJsZS4KCSAqIEBwYXJhbSB7T2JqZWN0fSBvYmplY3RWYXIgICAgIERlc2NyaXB0aW9uLgoJICogQHBhcmFtIHt0eXBlfSAgIG9iamVjdFZhci5rZXkgRGVzY3JpcHRpb24gb2YgYSBrZXkgaW4gdGhlIG9iamVjdFZhciBwYXJhbWV0ZXIuCgkgKgoJICogQHlpZWxkIHt0eXBlfSBZaWVsZGVkIHZhbHVlIGRlc2NyaXB0aW9uLgoJICoKCSAqIEByZXR1cm4ge3R5cGV9IFJldHVybiB2YWx1ZSBkZXNjcmlwdGlvbi4KCSAqLwoJYXN5bmMgZGFydEFQSShzY29wZSkgewoKCQlsZXQgYW5zd2VyID0gbnVsbDsKCgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiZGFydEFQSSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJkYXJ0QVBJIiwgX25vZGUsIHNjb3BlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJkYXJ0QVBJIiwgc2NvcGUpID0+IHsKCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlLmRhcnRBUEknKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2RhcnRBUEknLCAnRW50aXR5T2JqZWN0JywgMCwgewoJCQkJCQlba106IGVycm9yc1trXQoJCQkJCX0pOwoJCQkJCWRlbGV0ZSBlcnJvcnNba107CgkJCQl9KTsKCQkJCWlmIChPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIHsKCQkJCQkJX19leGNlcHRpb246IGVycm9ycywKCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlyZXR1cm4gKGF3YWl0IHRoaXMuc3IoKS5fKCJDb250ZW50TWFuYWdlci5jbXNTdG9yZWRTY3JpcHRGaW5kIiwgbnVsbCwgewoJCQkJTmFtZTogIkRBUlRBUEk6OiIgKyAoc2NvcGUgfHwgb1Njb3BlLl9ub2RlLlNjb3BlKQoJCQl9KSkuU2NyaXB0OwoKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdLAoJCQlzY29wZTogc2NvcGUKCQl9KTsKCgkJLy8gdGFrZSBvdXQgdGhlIGludmFsaWQgbm9kZSByZXN1bHRzCgkJcmVzdWx0cyA9IHJlc3VsdHMuZmlsdGVyKHIgPT4gciAmJiByLnJldCk7CgoJCS8vIGhhcyBhbnkgbm9kZSBnZW5lcmF0ZWQgYSB2YWxpZGF0aW9uIGV4Y2VwdGlvbj8KCQlsZXQgX19leCA9IHJlc3VsdHMuZmluZChyID0+IHIucmV0Ll9fZXhjZXB0aW9uKTsKCQlpZiAoX19leCkgcmV0dXJuIF9fZXgucmV0OwoKCQlyZXR1cm4gcmVzdWx0cy5sZW5ndGggPyByZXN1bHRzWzBdLnJldCA6IG51bGw7CgoJfQoKCS8qKgoJICogU3VtbWFyeS4gcmVzdGFydC4KCSAqCgkgKiBEZXNjcmlwdGlvbi4gLgoJICoKCSAqIEBzaW5jZSAgICAgIHgueC54CgkgKiBAZGVwcmVjYXRlZCB4LngueCBVc2UgbmV3X2Z1bmN0aW9uX25hbWUoKSBpbnN0ZWFkLgoJICogQGFjY2VzcyAgICAgcHVibGljCgkgKgoJICogQGNsYXNzCgkgKiBAYXVnbWVudHMgcGFyZW50CgkgKiBAbWl4ZXMgICAgbWl4aW4KCSAqCgkgKiBAYWxpYXMgICAgcmVhbE5hbWUKCSAqIEBtZW1iZXJvZiBuYW1lc3BhY2UKCSAqCgkgKiBAc2VlICBGdW5jdGlvbi9jbGFzcyByZWxpZWQgb24KCSAqIEBsaW5rIFVSTAoJICogQGdsb2JhbAoJICoKCSAqIEBmaXJlcyAgIGV2ZW50TmFtZQoJICogQGZpcmVzICAgY2xhc3NOYW1lI2V2ZW50TmFtZQoJICogQGxpc3RlbnMgZXZlbnQ6ZXZlbnROYW1lCgkgKiBAbGlzdGVucyBjbGFzc05hbWV+ZXZlbnQ6ZXZlbnROYW1lCgkgKiBAcGFyYW0ge3R5cGV9ICAgdmFyICAgICAgICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyXSAgICAgICAgIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXI9ZGVmYXVsdF0gRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUgd2l0aCBkZWZhdWx0IHZhcmlhYmxlLgoJICogQHBhcmFtIHtPYmplY3R9IG9iamVjdFZhciAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgb2JqZWN0VmFyLmtleSBEZXNjcmlwdGlvbiBvZiBhIGtleSBpbiB0aGUgb2JqZWN0VmFyIHBhcmFtZXRlci4KCSAqCgkgKiBAeWllbGQge3R5cGV9IFlpZWxkZWQgdmFsdWUgZGVzY3JpcHRpb24uCgkgKgoJICogQHJldHVybiB7dHlwZX0gUmV0dXJuIHZhbHVlIGRlc2NyaXB0aW9uLgoJICovCglhc3luYyByZXN0YXJ0KCkgewoKCQlsZXQgYW5zd2VyID0gZmFsc2U7CgoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInJlc3RhcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAicmVzdGFydCIsIF9ub2RlLCApID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInJlc3RhcnQiLCApID0+IHsKCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlLnJlc3RhcnQnKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3Jlc3RhcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgewoJCQkJCQlba106IGVycm9yc1trXQoJCQkJCX0pOwoJCQkJCWRlbGV0ZSBlcnJvcnNba107CgkJCQl9KTsKCQkJCWlmIChPYmplY3QudmFsdWVzKGVycm9ycykubGVuZ3RoKSB7CgkJCQkJcmV0dXJuIHsKCQkJCQkJX19leGNlcHRpb246IGVycm9ycywKCQkJCQl9OwoJCQkJfQoJCQkJcmV0dXJuOwoJCQl9CgoJCQlzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgewoJCQkJLy8gV2hlbiBOb2RlSlMgZXhpdHMKCQkJCXByb2Nlc3Mub24oImV4aXQiLCBmdW5jdGlvbigpIHsKCgkJCQkJcmVxdWlyZSgiY2hpbGRfcHJvY2VzcyIpLnNwYXduKHByb2Nlc3MuYXJndi5zaGlmdCgpLCBwcm9jZXNzLmFyZ3YsIHsKCQkJCQkJY3dkOiBwcm9jZXNzLmN3ZCgpLAoJCQkJCQlkZXRhY2hlZDogdHJ1ZSwKCQkJCQkJc3RkaW86ICJpbmhlcml0IgoJCQkJCX0pOwoJCQkJfSk7CgkJCQlwcm9jZXNzLmV4aXQoKTsKCQkJfSwgMTAwMCk7CgoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10sCgkJfSk7CgoJCS8vIHRha2Ugb3V0IHRoZSBpbnZhbGlkIG5vZGUgcmVzdWx0cwoJCXJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIgJiYgci5yZXQpOwoKCQkvLyBoYXMgYW55IG5vZGUgZ2VuZXJhdGVkIGEgdmFsaWRhdGlvbiBleGNlcHRpb24/CgkJbGV0IF9fZXggPSByZXN1bHRzLmZpbmQociA9PiByLnJldC5fX2V4Y2VwdGlvbik7CgkJaWYgKF9fZXgpIHJldHVybiBfX2V4LnJldDsKCgkJcmV0dXJuIHJlc3VsdHMubGVuZ3RoID8gcmVzdWx0c1swXS5yZXQgOiBudWxsOwoKCX0KCgkvKioKCSAqIFN1bW1hcnkuIHN0YXR1cy4KCSAqCgkgKiBEZXNjcmlwdGlvbi4gLgoJICoKCSAqIEBzaW5jZSAgICAgIHgueC54CgkgKiBAZGVwcmVjYXRlZCB4LngueCBVc2UgbmV3X2Z1bmN0aW9uX25hbWUoKSBpbnN0ZWFkLgoJICogQGFjY2VzcyAgICAgcHVibGljCgkgKgoJICogQGNsYXNzCgkgKiBAYXVnbWVudHMgcGFyZW50CgkgKiBAbWl4ZXMgICAgbWl4aW4KCSAqCgkgKiBAYWxpYXMgICAgcmVhbE5hbWUKCSAqIEBtZW1iZXJvZiBuYW1lc3BhY2UKCSAqCgkgKiBAc2VlICBGdW5jdGlvbi9jbGFzcyByZWxpZWQgb24KCSAqIEBsaW5rIFVSTAoJICogQGdsb2JhbAoJICoKCSAqIEBmaXJlcyAgIGV2ZW50TmFtZQoJICogQGZpcmVzICAgY2xhc3NOYW1lI2V2ZW50TmFtZQoJICogQGxpc3RlbnMgZXZlbnQ6ZXZlbnROYW1lCgkgKiBAbGlzdGVucyBjbGFzc05hbWV+ZXZlbnQ6ZXZlbnROYW1lCgkgKiBAcGFyYW0ge3R5cGV9ICAgdmFyICAgICAgICAgICBEZXNjcmlwdGlvbi4KCSAqIEBwYXJhbSB7dHlwZX0gICBbdmFyXSAgICAgICAgIERlc2NyaXB0aW9uIG9mIG9wdGlvbmFsIHZhcmlhYmxlLgoJICogQHBhcmFtIHt0eXBlfSAgIFt2YXI9ZGVmYXVsdF0gRGVzY3JpcHRpb24gb2Ygb3B0aW9uYWwgdmFyaWFibGUgd2l0aCBkZWZhdWx0IHZhcmlhYmxlLgoJICogQHBhcmFtIHtPYmplY3R9IG9iamVjdFZhciAgICAgRGVzY3JpcHRpb24uCgkgKiBAcGFyYW0ge3R5cGV9ICAgb2JqZWN0VmFyLmtleSBEZXNjcmlwdGlvbiBvZiBhIGtleSBpbiB0aGUgb2JqZWN0VmFyIHBhcmFtZXRlci4KCSAqCgkgKiBAeWllbGQge3R5cGV9IFlpZWxkZWQgdmFsdWUgZGVzY3JpcHRpb24uCgkgKgoJICogQHJldHVybiB7dHlwZX0gUmV0dXJuIHZhbHVlIGRlc2NyaXB0aW9uLgoJICovCglhc3luYyBzdGF0dXMoKSB7CgoJCWxldCBhbnN3ZXIgPSBudWxsOwoKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdGF0dXMiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RhdHVzIiwgX25vZGUsICkgPT4gewoJCQlyZXR1cm4gX25vZGUuX3NhbWVOb2RlKG9TY29wZS5fbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAic3RhdHVzIiwgKSA9PiB7CgoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZS5zdGF0dXMnKTsKCgkJCXZhciBlcnJvcnMgPSB7CgoJCQl9OwoJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+ICFlcnJvcnNba10pLmZvckVhY2goayA9PiBkZWxldGUgZXJyb3JzW2tdKTsKCQkJaWYgKE9iamVjdC5rZXlzKGVycm9ycykubGVuZ3RoKSB7CgkJCQlPYmplY3Qua2V5cyhlcnJvcnMpLmZpbHRlcihrID0+IGsuc3RhcnRzV2l0aCgnLScpKS5mb3JFYWNoKGsgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0YXR1cycsICdFbnRpdHlPYmplY3QnLCAwLCB7CgkJCQkJCVtrXTogZXJyb3JzW2tdCgkJCQkJfSk7CgkJCQkJZGVsZXRlIGVycm9yc1trXTsKCQkJCX0pOwoJCQkJaWYgKE9iamVjdC52YWx1ZXMoZXJyb3JzKS5sZW5ndGgpIHsKCQkJCQlyZXR1cm4gewoJCQkJCQlfX2V4Y2VwdGlvbjogZXJyb3JzLAoJCQkJCX07CgkJCQl9CgkJCQlyZXR1cm47CgkJCX0KCgkJCXJldHVybiB7CgkJCQlfbm9kZTogb1Njb3BlLl9ub2RlID8gb1Njb3BlLl9ub2RlLl9jb2RlIDogbnVsbCwKCQkJCXZlcnNpb246IG9TY29wZS5fX3NjcmlwdC5EYXRlLnRvSVNPU3RyaW5nKCksCgkJCQl0aW1lOiB0aGlzLnNyKCkuc2VydmVyRGF0ZSgpLnRvSVNPU3RyaW5nKCksCgkJCX07CgoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10sCgkJfSk7CgoJCS8vIHRha2Ugb3V0IHRoZSBpbnZhbGlkIG5vZGUgcmVzdWx0cwoJCXJlc3VsdHMgPSByZXN1bHRzLmZpbHRlcihyID0+IHIgJiYgci5yZXQpOwoKCQkvLyBoYXMgYW55IG5vZGUgZ2VuZXJhdGVkIGEgdmFsaWRhdGlvbiBleGNlcHRpb24/CgkJbGV0IF9fZXggPSByZXN1bHRzLmZpbmQociA9PiByLnJldC5fX2V4Y2VwdGlvbik7CgkJaWYgKF9fZXgpIHJldHVybiBfX2V4LnJldDsKCgkJcmV0dXJuIHJlc3VsdHMubGVuZ3RoID8gcmVzdWx0c1swXS5yZXQgOiBudWxsOwoKCX0KCglhc3luYyBfcmVzdCh0TmFtZSA9IHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKHVuZGVmaW5lZCwgdGhpcy5Ub29sKS5fcmVzdCh0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyk7CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWRkcmVzcycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdiYWNrdXAnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdwYXJlbnQnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdwb3J0JywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29ubGluZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc2VjdXJlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qTm9kZSovKTtcbic7CgoJCXJldCA9IHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IHRydWUsCgkJCU51bGw6IHRydWUsCgkJCS8vSWQ6IChvYmosIHYpID0+IG9iai5zcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZYCwKCgkJCSJhZGRyZXNzIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FkZHJlc3MnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWRkcmVzcycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJiYWNrdXAiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYmFja3VwJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2JhY2t1cCcsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCQkicGFyZW50IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3BhcmVudCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdwYXJlbnQnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJInBvcnQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncG9ydCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdwb3J0JywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9ubGluZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvbmxpbmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb25saW5lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJzZWN1cmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc2VjdXJlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3NlY3VyZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkidHlwZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCW5vZGVfQ29uZmlnczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25vZGVfTm9kZXMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQkJY2Fycmllcl9FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjYXJyaWVyX05vZGVzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJCXNlbmRlcl9FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzZW5kZXJfTm9kZXMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQkJcmVjaXBpZW50X0V2ZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlY2lwaWVudF9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IG9iai5zcWwgPSB2Lm1hcChfdiA9PiBfdi5fdG9TUUxUYWJsZSgpKSArIG9iai5zcWwsCgoJCQliYWNrdXBfTm9kZXM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdiYWNrdXBfTm9kZXMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQkJcGFyZW50X05vZGVzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncGFyZW50X05vZGVzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJCW5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbm9kZV9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IG9iai5zcWwgPSB2Lm1hcChfdiA9PiBfdi5fdG9TUUxUYWJsZSgpKSArIG9iai5zcWwsCgoJCX0sICJfdG9TUUxUYWJsZSIpOwoKCQkvLyByZXQuc3FsICs9ICcvKk5vZGUqLyk7XG4nOwoKCQlyZXQuc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChyZXQuc3FsKSA6IHJldC5zcWw7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NRTFRhYmxlJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldC5zcWwpOwoJCXJldHVybiByZXQuc3FsOwoJfQoKCV9mcm9tU1FMVGFibGUodGFibGUsIGZpZWxkcykgewoJCS8vIHRhYmxlIGlzIGEganNvbiBhcnJheQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWRkcmVzcyIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuYWRkcmVzcyh0YWJsZVsiYWRkcmVzcyJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJiYWNrdXAiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmJhY2t1cCh0YWJsZVsiYmFja3VwIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInBhcmVudCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucGFyZW50KHRhYmxlWyJwYXJlbnQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicG9ydCIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMucG9ydCh0YWJsZVsicG9ydCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvbmxpbmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm9ubGluZSh0YWJsZVsib25saW5lIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInNlY3VyZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuc2VjdXJlKHRhYmxlWyJzZWN1cmUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigidHlwZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMudHlwZSh0YWJsZVsidHlwZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbChzcWwsIHRoaXMpOwoKCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIGJTdHJpbmcpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7CgkJCVt0aGlzLl9uQ29kZSgpXTogewoJCQkJcGFyYW1zOiB7CgkJCQkJd2hlcmU6IHsKCQkJCQkJYW5kOiBbXSwKCQkJCQkJb3I6IFtdCgkJCQkJfQoJCQkJfSwKCQkJCWVkZ2VzOiB7CgkJCQkJbm9kZToge30KCQkJCX0KCQkJfQoJCX0sIHsKCQkJLy9PUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKHsKCQkJCUlkOiB7CgkJCQkJZXE6IHYKCQkJCX0KCQkJfSksCgoJCQlhZGRyZXNzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWRkcmVzcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQliYWNrdXA6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdiYWNrdXAnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdOb2RlJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnTm9kZScsIHVuZGVmaW5lZCldLnBhcmFtcy53aGVyZS5hbmQgOiBbXSwKCQkJCQkJCX0sCgkJCQkJCX0KCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlwYXJlbnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwYXJlbnQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdOb2RlJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnTm9kZScsIHVuZGVmaW5lZCldLnBhcmFtcy53aGVyZS5hbmQgOiBbXSwKCQkJCQkJCX0sCgkJCQkJCX0KCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlwb3J0OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncG9ydCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlvbmxpbmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvbmxpbmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQkodiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGwpCgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJc2VjdXJlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc2VjdXJlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCXR5cGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQl7CgkJCQkJCQlpbnE6IHsKCQkJCQkJCQlBcGlOYW1lOiAnSWQnLAoJCQkJCQkJCVt0aGlzLl9uQ29kZSgnTm9kZV9UeXBlJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnTm9kZV9UeXBlJywgdW5kZWZpbmVkKV0ucGFyYW1zLndoZXJlLmFuZCA6IFtdLAoJCQkJCQkJfSwKCQkJCQkJfQoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsKQoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCX0sICJfdG9TRlF1ZXJ5Iik7CgoJCS8vT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCWlmIChiU3RyaW5nKSB7CgkJCXJldCA9IHsKCQkJCXF1ZXJ5OiB7CgkJCQkJW3RoaXMuX25Db2RlKCkgKyAnUXVlcnknXTogewoJCQkJCQl1aWFwaTogcmV0CgkJCQkJfQoJCQkJfQoJCQl9OwoJCQlyZXQgPSBKU09OLnN0cmluZ2lmeShyZXQsIG51bGwsIDQpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU0ZRdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU05RdWVyeShmaWVsZHMsIG9ianMpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlPUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmouc3lzX2lkID0gdiwKCgkJCWFkZHJlc3M6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhZGRyZXNzJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQliYWNrdXA6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdiYWNrdXAnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9TTlF1ZXJ5KCkgOiBudWxsOwoKCQkJfSwKCgkJCXBhcmVudDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3BhcmVudCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b1NOUXVlcnkoKSA6IG51bGw7CgoJCQl9LAoKCQkJcG9ydDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3BvcnQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCW9ubGluZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29ubGluZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlsZXQgZCA9IGAke3YuZ2V0RnVsbFllYXIoKX0tJHsoJzAnKyh2LmdldE1vbnRoKCkrMSkpLnNsaWNlKC0yKX0tJHt2LmdldERhdGUoKX1gOwoJCQkJbGV0IHQgPSBgJHt2LmdldEhvdXJzKCl9OiR7di5nZXRNaW51dGVzKCl9OiR7di5nZXRTZWNvbmRzKCl9YDsKCQkJCWlmICgodi5nZXRIb3VycygpID09IDAgJiYgdi5nZXRNaW51dGVzKCkgPT0gMCAmJiB2LmdldFNlY29uZHMoKSA9PSAwKSB8fCB0aGlzLl9vbmxpbmVfY29vcCA9PSAnPScgfHwgIXRoaXMuX29ubGluZV9jb29wKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgT04ke2R9QGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9Jywnc3RhcnQnKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ2VuZCcpYDsKCQkJCX0gZWxzZSBpZiAodGhpcy5fb25saW5lX2Nvb3AgIT09ICdCRVRXRUVOJykgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9IGVsc2UgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfQoKCQkJfSwKCgkJCXNlY3VyZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3NlY3VyZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJdHlwZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9TTlF1ZXJ5KCkgOiBudWxsOwoKCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlsZXQgZCA9IGAke3YuZ2V0RnVsbFllYXIoKX0tJHsoJzAnKyh2LmdldE1vbnRoKCkrMSkpLnNsaWNlKC0yKX0tJHt2LmdldERhdGUoKX1gOwoJCQkJbGV0IHQgPSBgJHt2LmdldEhvdXJzKCl9OiR7di5nZXRNaW51dGVzKCl9OiR7di5nZXRTZWNvbmRzKCl9YDsKCQkJCWlmICgodi5nZXRIb3VycygpID09IDAgJiYgdi5nZXRNaW51dGVzKCkgPT0gMCAmJiB2LmdldFNlY29uZHMoKSA9PSAwKSB8fCB0aGlzLl9kYXRlX2Nvb3AgPT0gJz0nIHx8ICF0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBPTiR7ZH1AamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdzdGFydCcpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywnZW5kJylgOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9kYXRlX2Nvb3AgIT09ICdCRVRXRUVOJykgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9IGVsc2UgewoJCQkJCW9ialtlYUNvZGVdID0gYGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfQoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJfSwgIl90b1NOUXVlcnkiKTsKCgkJT2JqZWN0LmtleXMocmV0Lk9QRVJBVE9SUyB8fCB7fSkuZmlsdGVyKGsgPT4gdHlwZW9mKHJldFtrXSkgIT09ICd1bmRlZmluZWQnKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gcmV0Lk9QRVJBVE9SU1trXSArIHJldFtrXSk7CgoJCWRlbGV0ZSByZXQuT1BFUkFUT1JTOwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlyZXQgPSBEb3RPYmplY3QuZG90KHJldCk7CgoJCS8vIGF2b2lkIHNlbmRpbmcgd2l0aCBubyBjb21wYXJpc29uIG9wZXJhdG9ycwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVsnPicsICc8JywgJ0JFVFdFRU4nLCAnT04nLCAnIScsICc9JywgJ1NUQVJUU1dJVEgnLCAnTElLRSddLnNvbWUocyA9PiBTdHJpbmcocmV0W2tdKS5zdGFydHNXaXRoKHMpKSkuZm9yRWFjaChrID0+IHJldFtrXSA9ICh0aGlzW2BfJHtrfV9jb29wYF0gfHwgJ1NUQVJUU1dJVEgnKSArIHJldFtrXSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgT2JqZWN0LmVudHJpZXMocmV0IHx8IHt9KS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJbGV0IF9yZXQgPSBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIGZhbHNlLCBmdW4sIGVhT2JqLCBvYmopOwoJCQkJcmV0dXJuIF9yZXQ7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoImFkZHJlc3MiLCBvYmosIHRoaXMuYWRkcmVzcygpKTsKCgkJX29wdGlvbnMoInBvcnQiLCBvYmosIHRoaXMucG9ydCgpKTsKCgkJX29wdGlvbnMoIm9ubGluZSIsIG9iaiwgdGhpcy5vbmxpbmUoKSk7CgoJCV9vcHRpb25zKCJzZWN1cmUiLCBvYmosIHRoaXMuc2VjdXJlKCkpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjllMmEwZDcwLTlhMWItNDc2Mi1hOWRiLTA2MGU2NTc5NWM4OSIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmopOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiBvYmosCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIG9iaiwgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoIl9USElTIiwgb2JqLCB0aGlzLl9USElTKTsKCgkJaWYgKCF0aGlzLmJhY2t1cCgpIHx8ICh0aGlzLmJhY2t1cCgpCgoJCQkJJiYKCQkJCSF0aGlzLmJhY2t1cCgpLm5vZGVfQ29uZmlncygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5iYWNrdXAoKS5jYXJyaWVyX0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5iYWNrdXAoKS5zZW5kZXJfRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmJhY2t1cCgpLnJlY2lwaWVudF9FdmVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMuYmFja3VwKCkuYmFja3VwX05vZGVzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLmJhY2t1cCgpLnBhcmVudF9Ob2RlcygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5iYWNrdXAoKS5ub2RlX05vZGVfR3JvdXBfTWVtYmVycygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygiYmFja3VwIiwgb2JqLCB0aGlzLmJhY2t1cCgpKTsKCQl9CgoJCWlmICghdGhpcy5wYXJlbnQoKSB8fCAodGhpcy5wYXJlbnQoKQoKCQkJCSYmCgkJCQkhdGhpcy5wYXJlbnQoKS5ub2RlX0NvbmZpZ3MoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMucGFyZW50KCkuY2Fycmllcl9FdmVudHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMucGFyZW50KCkuc2VuZGVyX0V2ZW50cygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5wYXJlbnQoKS5yZWNpcGllbnRfRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLnBhcmVudCgpLmJhY2t1cF9Ob2RlcygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5wYXJlbnQoKS5wYXJlbnRfTm9kZXMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMucGFyZW50KCkubm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoInBhcmVudCIsIG9iaiwgdGhpcy5wYXJlbnQoKSk7CgkJfQoKCQlpZiAoIXRoaXMudHlwZSgpIHx8ICh0aGlzLnR5cGUoKQoKCQkJCSYmCgkJCQkhdGhpcy50eXBlKCkudHlwZV9Ob2RlcygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJKSkgewoJCQlfb3B0aW9ucygidHlwZSIsIG9iaiwgdGhpcy50eXBlKCkpOwoJCX0KCgkJX29wdGlvbnMoIm5vZGVfQ29uZmlncyIsIG9iaiwgdGhpcy5ub2RlX0NvbmZpZ3MoKSk7CgoJCV9vcHRpb25zKCJjYXJyaWVyX0V2ZW50cyIsIG9iaiwgdGhpcy5jYXJyaWVyX0V2ZW50cygpKTsKCgkJX29wdGlvbnMoInNlbmRlcl9FdmVudHMiLCBvYmosIHRoaXMuc2VuZGVyX0V2ZW50cygpKTsKCgkJX29wdGlvbnMoInJlY2lwaWVudF9FdmVudHMiLCBvYmosIHRoaXMucmVjaXBpZW50X0V2ZW50cygpKTsKCgkJX29wdGlvbnMoImJhY2t1cF9Ob2RlcyIsIG9iaiwgdGhpcy5iYWNrdXBfTm9kZXMoKSk7CgoJCV9vcHRpb25zKCJwYXJlbnRfTm9kZXMiLCBvYmosIHRoaXMucGFyZW50X05vZGVzKCkpOwoKCQlfb3B0aW9ucygibm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMiLCBvYmosIHRoaXMubm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMoKSk7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FkZHJlc3MnLCAnYmFja3VwJywgJ3BhcmVudCcsICdwb3J0JywgJ29ubGluZScsICdzZWN1cmUnLCAndHlwZScsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnbm9kZV9Db25maWdzJywgJ2NhcnJpZXJfRXZlbnRzJywgJ3NlbmRlcl9FdmVudHMnLCAncmVjaXBpZW50X0V2ZW50cycsICdiYWNrdXBfTm9kZXMnLCAncGFyZW50X05vZGVzJywgJ25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqLCB0cnVlKSk7CgoJCXJldHVybiBvYmo7Cgl9CgoJX19pbXBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJLy8gaWYoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKHR5cGVvZihvYmopICE9PSAnb2JqZWN0JykgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgJHtmdW59OiBOb3QgYW4gb2JqZWN0OiAke3R5cGVvZihvYmopfWAsIG9iaik7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmopID0+IHsKCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQlpZiAoIW9iaikgcmV0dXJuOwoJCQlpZiAoQXJyYXkuaXNBcnJheShvYmopICYmICFvYmoubGVuZ3RoKSByZXR1cm47CgoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCB0cnVlLCBmdW4sIG9iaiwgb2JqKTsKCQkJCWlmIChvcHRpb25zW2ZpZWxkXSAmJiB0eXBlb2Yob3B0aW9uc1tmaWVsZF0pID09PSAiZnVuY3Rpb24iKSByZXR1cm4gb3B0aW9uc1tmaWVsZF0ob2JqKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciAke2V4fSBpbiAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfWAsIGV4KTsKCQkJfQoJCX07CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaik7CgkJX29wdGlvbnMoIklkIiwgb2JqKTsKCgkJX29wdGlvbnMoImFkZHJlc3MiLCBvYmopOwoKCQlfb3B0aW9ucygicG9ydCIsIG9iaik7CgoJCV9vcHRpb25zKCJvbmxpbmUiLCBvYmopOwoKCQlfb3B0aW9ucygic2VjdXJlIiwgb2JqKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmopOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaik7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInJlbWFyayIsIG9iaik7CgoJCS8vIGNhbiB3ZSBkbyBkZVJlZmVyZW5jZSBoZXJlPwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKHRoaXMpID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgdGhpcywgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gdGhpczsKCQkJfSBlbHNlIGlmICh0eXBlb2YodGhpcykgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKHRoaXMpOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gdGhpcy5faWQgfHwgdGhpcy5pZCB8fCB0aGlzLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmICh0aGlzLklkICYmIHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8IHRoaXMuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiOWUyYTBkNzAtOWExYi00NzYyLWE5ZGItMDYwZTY1Nzk1Yzg5IiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGUgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGUgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcyk7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZVtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJiYWNrdXAiLCBvYmopOwoKCQlfb3B0aW9ucygicGFyZW50Iiwgb2JqKTsKCgkJX29wdGlvbnMoInR5cGUiLCBvYmopOwoKCQlfb3B0aW9ucygibm9kZV9Db25maWdzIiwgb2JqKTsKCgkJX29wdGlvbnMoImNhcnJpZXJfRXZlbnRzIiwgb2JqKTsKCgkJX29wdGlvbnMoInNlbmRlcl9FdmVudHMiLCBvYmopOwoKCQlfb3B0aW9ucygicmVjaXBpZW50X0V2ZW50cyIsIG9iaik7CgoJCV9vcHRpb25zKCJiYWNrdXBfTm9kZXMiLCBvYmopOwoKCQlfb3B0aW9ucygicGFyZW50X05vZGVzIiwgb2JqKTsKCgkJX29wdGlvbnMoIm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWRkcmVzcycsICdiYWNrdXAnLCAncGFyZW50JywgJ3BvcnQnLCAnb25saW5lJywgJ3NlY3VyZScsICd0eXBlJywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWydub2RlX0NvbmZpZ3MnLCAnY2Fycmllcl9FdmVudHMnLCAnc2VuZGVyX0V2ZW50cycsICdyZWNpcGllbnRfRXZlbnRzJywgJ2JhY2t1cF9Ob2RlcycsICdwYXJlbnRfTm9kZXMnLCAnbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmopKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvREJPYmplY3QoZmllbGRzLCBiTm9SZWYpIHsKCQlpZiAoIXRoaXMuSWQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgIkludmFsaWQgSUQiLCB0aGlzLkVudGl0eUNsYXNzLk5hbWUsIHRoaXMuVG9vbCk7CgkJfQoJCWxldCByZXQgPSB7CgkJCVt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV06ICInIiArIHRoaXMuSWQgKyAiJyIKCQl9OwoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFkZHJlc3MiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fYWRkcmVzc19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hZGRyZXNzKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdhZGRyZXNzJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYmFja3VwIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2JhY2t1cF9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYmFja3VwKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCdiYWNrdXAnLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInBhcmVudCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9wYXJlbnRfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnBhcmVudCgpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgncGFyZW50JywgdW5kZWZpbmVkKSArICJpZCJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJwb3J0IikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3BvcnRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucG9ydCgpOwoKCQkJZlZhbHVlID0gdiB8fCAnMCc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3BvcnQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvbmxpbmUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fb25saW5lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9ubGluZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb25saW5lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigic2VjdXJlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3NlY3VyZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5zZWN1cmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnc2VjdXJlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigidHlwZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl90eXBlX3NldCAmJiAoIWJOb1JlZiB8fCBmYWxzZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy50eXBlKCk7CgoJCQlpZiAodiAmJiAodi5fX3N5bmNfb24oKSB8fCB2LklkID09IHYuSWQpKSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2LklkICsgIiciOwoJCQl9IGVsc2UgewoJCQkJZlZhbHVlID0gMDsKCQkJfQoKCQkJcmV0W3RoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSArICJpZCJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fYWN0aXZlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2VuYWJsZWRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9jb2RlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNvZGUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9vcmRlcl9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5vcmRlcigpOwoKCQkJZlZhbHVlID0gdiB8fCAnMCc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZGF0ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9kYXRlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmRhdGUoKTsKCgkJCXRyeSB7CgkJCQlmVmFsdWUgPSAiJyIgKyAodiA/IHYudG9JU09TdHJpbmcoKSA6ICIxOTcwLTEtMSIpICsgIiciOwoJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnKSB7CgkJCQkJZlZhbHVlID0gYFNUUl9UT19EQVRFKCR7ZlZhbHVlfSwgJyVZLSVtLSVkVCVULiVmWicpYDsKCQkJCX0KCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgkJCX0KCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gJ2RhdGV0aW1lKCcgKyBmVmFsdWUgKyAnKSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJuYW1lIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX25hbWVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMubmFtZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInJlbWFyayIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9yZW1hcmtfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMucmVtYXJrKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9RKCkgewoJCWxldCBfbyA9ICciJzsKCQlsZXQgX3EgPSBfbzsKCgkJaWYgKFsnU2FsZXNGb3JjZSddLmluZGV4T2YodGhpcy5Ub29sLnR5cGUubmFtZSkgPT0gMCkgewoJCQlfbyA9IF9xID0gIiI7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJyB8fCB0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIHsKCQkJX28gPSBfcSA9ICdgJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3Fsc2VydmVyJykgewoJCQlfbyA9ICdbJzsKCQkJX3EgPSAnXSc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCdhcGlLZXknKSA9PSAnYWlydGFibGUnKSB7CgkJCV9vID0gJ3snOwoJCQlfcSA9ICd9JzsKCQl9CgkJdGhpcy5fX1EgPSB0aGlzLl9fUSA9PSBfbyA/IF9xIDogX287CgkJcmV0dXJuIHRoaXMuX19ROwoJfQoKCV9maWVsZEdyb3VwcyhmZ3MgPSB7fSkgewoJCXRoaXMuX19maWVsZEdyb3VwcyA9IGZnczsKCQlyZXR1cm4gdGhpczsKCX0KCglfZmllbGRBZ2dyZWdhdGVzKGZhcyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkQWdncmVnYXRlcyA9IGZhczsKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9GaWVsZHNTUUwoZmllbGRzKSB7CgoJCWZpZWxkcyA9IGZpZWxkcyB8fCBbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyksIHRoaXMuX25Db2RlKCdhZGRyZXNzJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2JhY2t1cCcsIHVuZGVmaW5lZCkgKyAiLmlkIiwgdGhpcy5fbkNvZGUoJ3BhcmVudCcsIHVuZGVmaW5lZCkgKyAiLmlkIiwgdGhpcy5fbkNvZGUoJ3BvcnQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnb25saW5lJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3NlY3VyZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKV07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFkZHJlc3MpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhZGRyZXNzJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYmFja3VwKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnYmFja3VwJywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5wYXJlbnQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdwYXJlbnQnLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnBvcnQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdwb3J0JywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub25saW5lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnb25saW5lJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuc2VjdXJlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnc2VjdXJlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMudHlwZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9YCk7CgoJCX0KCQlyZXR1cm4gZmllbGRzOwoJfQoKCV9mcm9tREJPYmplY3QociA9IHt9KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMuX19pbXBvcnQociwgewoJCQkJSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSwKCgkJCQlhZGRyZXNzOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWRkcmVzcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmFkZHJlc3Mob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQliYWNrdXA6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdiYWNrdXAnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5iYWNrdXAob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlwYXJlbnQ6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwYXJlbnQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5wYXJlbnQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlwb3J0OiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncG9ydCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnBvcnQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvbmxpbmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvbmxpbmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5vbmxpbmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlzZWN1cmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzZWN1cmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5zZWN1cmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQl0eXBlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnR5cGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU51bGw6IHRydWUsCgoJCQliYWNrdXA6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdiYWNrdXAnLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Ob2RlKG51bGwsIHRoaXMuVG9vbCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQlwYXJlbnQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwYXJlbnQnLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Ob2RlKG51bGwsIHRoaXMuVG9vbCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQl0eXBlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93Lk5vZGVfVHlwZShudWxsLCB0aGlzLlRvb2wpLl90b1NlbGVjdEhlYWRlcigpLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hZGRyZXNzKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hZGRyZXNzfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhZGRyZXNzJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmJhY2t1cCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYmFja3VwfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdiYWNrdXAnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMucGFyZW50KSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5wYXJlbnR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3BhcmVudCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5wb3J0KSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5wb3J0fSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdwb3J0JywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9ubGluZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub25saW5lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvbmxpbmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuc2VjdXJlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5zZWN1cmV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3NlY3VyZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy50eXBlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy50eXBlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJfQoKCQlzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7CgoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCk7CgoJCXNxbCArPSBgIHdoZXJlIDE9MWA7CgoJCXNxbCA9IHRoaXMuX19leHBvcnQoewoJCQlzcWw6IHNxbAoJCX0sIHsKCQkJX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSA/IFsnSWQnXSA6IHVuZGVmaW5lZCwKCQkJTnVsbDogdHJ1ZSwKCQkJX1RISVM6IG9iaiA9PiB7CgkJCQlpZiAoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKHQuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOwoJCQl9LAoJCQlJZDogb2JqID0+IG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwKCgkJCWFkZHJlc3M6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhZGRyZXNzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9hZGRyZXNzX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fYWRkcmVzc19jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fYWRkcmVzc19jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fYWRkcmVzc19jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX2FkZHJlc3NfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2FkZHJlc3NfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWJhY2t1cDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2JhY2t1cCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fYmFja3VwX3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fYmFja3VwX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJcGFyZW50OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncGFyZW50JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9wYXJlbnRfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl9wYXJlbnRfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlwb3J0OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncG9ydCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcG9ydF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX3BvcnRfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW9ubGluZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29ubGluZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fb25saW5lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fb25saW5lX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LnRvSVNPU3RyaW5nKSB7CgkJCQkJaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnc3FsaXRlJykgewoJCQkJCQlvYmouc3FsICs9ICJzdHJmdGltZSgnJXMnLCAnIiArIHYudG9JU09TdHJpbmcoKSArICInKSI7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqLnNxbCArPSAiJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJyI7CgkJCQkJfQoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlzZWN1cmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzZWN1cmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3NlY3VyZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQl0eXBlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fdHlwZV9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX3R5cGVfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvZGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2RhdGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVtYXJrX3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlub2RlX0NvbmZpZ3M6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdub2RlX05vZGVzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9ub2RlX0NvbmZpZ3Nfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJub2RlLmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9ub2RlX0NvbmZpZ3NfY29vcCA9PSAnIT0nIHx8IHRoaXMuX25vZGVfQ29uZmlnc19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9ub2RlX0NvbmZpZ3NfY29vcCA9PSAnPScgfHwgdGhpcy5fbm9kZV9Db25maWdzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fbm9kZV9Db25maWdzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKm5vZGVfQ29uZmlncyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJCWNhcnJpZXJfRXZlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2Fycmllcl9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY2Fycmllcl9FdmVudHNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJjYXJyaWVyLmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl9jYXJyaWVyX0V2ZW50c19jb29wID09ICchPScgfHwgdGhpcy5fY2Fycmllcl9FdmVudHNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fY2Fycmllcl9FdmVudHNfY29vcCA9PSAnPScgfHwgdGhpcy5fY2Fycmllcl9FdmVudHNfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl9jYXJyaWVyX0V2ZW50c19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLypjYXJyaWVyX0V2ZW50cyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJCXNlbmRlcl9FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzZW5kZXJfTm9kZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3NlbmRlcl9FdmVudHNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJzZW5kZXIuaWQiKSk7CgoJCQkJbGV0IGpPUCA9ICdVTklPTiBBTEwnOwoJCQkJbGV0IGluT1AgPSAnSU4nOwoKCQkJCW9iai5zcWwgKz0gYGA7CgoJCQkJaWYgKHRoaXMuX3NlbmRlcl9FdmVudHNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX3NlbmRlcl9FdmVudHNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fc2VuZGVyX0V2ZW50c19jb29wID09ICc9JyB8fCB0aGlzLl9zZW5kZXJfRXZlbnRzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fc2VuZGVyX0V2ZW50c19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLypzZW5kZXJfRXZlbnRzKi8gJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gJHtpbk9QfSAoYCArIHNxdWVyaWVzLmpvaW4oYCAke2pPUH0vKk0yTSovIGApICsgJyknOwoJCQl9LAoKCQkJcmVjaXBpZW50X0V2ZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlY2lwaWVudF9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVjaXBpZW50X0V2ZW50c19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoInJlY2lwaWVudC5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fcmVjaXBpZW50X0V2ZW50c19jb29wID09ICchPScgfHwgdGhpcy5fcmVjaXBpZW50X0V2ZW50c19jb29wID09ICdOT1QgSU4nKSB7CgkJCQkJaW5PUCA9ICdOT1QgSU4nOwoJCQkJfSBlbHNlIGlmICh0aGlzLl9yZWNpcGllbnRfRXZlbnRzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX3JlY2lwaWVudF9FdmVudHNfY29vcCA9PSAnSU4nKSB7fSBlbHNlIGlmICh0aGlzLl9yZWNpcGllbnRfRXZlbnRzX2Nvb3AgPT0gJz09JykgewoJCQkJCWpPUCA9ICdJTlRFUlNFQ1QnOwoJCQkJfQoKCQkJCW9iai5zcWwgKz0gYGFuZCAvKnJlY2lwaWVudF9FdmVudHMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCQliYWNrdXBfTm9kZXM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdiYWNrdXBfTm9kZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2JhY2t1cF9Ob2Rlc19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoImJhY2t1cC5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fYmFja3VwX05vZGVzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl9iYWNrdXBfTm9kZXNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fYmFja3VwX05vZGVzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX2JhY2t1cF9Ob2Rlc19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX2JhY2t1cF9Ob2Rlc19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLypiYWNrdXBfTm9kZXMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCQlwYXJlbnRfTm9kZXM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdwYXJlbnRfTm9kZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3BhcmVudF9Ob2Rlc19zZXQpIHJldHVybjsKCgkJCQlsZXQgc3F1ZXJpZXMgPSAodiB8fCBbXSkuZmlsdGVyKHQgPT4gdCkubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwoInBhcmVudC5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fcGFyZW50X05vZGVzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl9wYXJlbnRfTm9kZXNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fcGFyZW50X05vZGVzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX3BhcmVudF9Ob2Rlc19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX3BhcmVudF9Ob2Rlc19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLypwYXJlbnRfTm9kZXMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCQlub2RlX05vZGVfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25vZGVfTm9kZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzX3NldCkgcmV0dXJuOwoKCQkJCWxldCBzcXVlcmllcyA9ICh2IHx8IFtdKS5maWx0ZXIodCA9PiB0KS5tYXAodCA9PiB0Ll90b1NlbGVjdFNRTCgibm9kZS5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnNfY29vcCA9PSAnIT0nIHx8IHRoaXMuX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzX2Nvb3AgPT0gJ05PVCBJTicpIHsKCQkJCQlpbk9QID0gJ05PVCBJTic7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzX2Nvb3AgPT0gJ0lOJykge30gZWxzZSBpZiAodGhpcy5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnNfY29vcCA9PSAnPT0nKSB7CgkJCQkJak9QID0gJ0lOVEVSU0VDVCc7CgkJCQl9CgoJCQkJb2JqLnNxbCArPSBgYW5kIC8qbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCX0sICJfdG9TZWxlY3RTUUwiLCBmaWVsZHMpLnNxbDsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQlpZiAoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFkZHJlc3MpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWRkcmVzcycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFkZHJlc3N9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYmFja3VwKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2JhY2t1cCcsIHVuZGVmaW5lZCkrImlkIn0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuYmFja3VwfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnBhcmVudCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdwYXJlbnQnLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnBhcmVudH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5wb3J0KSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3BvcnQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5wb3J0fWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9ubGluZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvbmxpbmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vbmxpbmV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuc2VjdXJlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3NlY3VyZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnNlY3VyZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy50eXBlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnR5cGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJYmFja3VwOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYmFja3VwJywgdW5kZWZpbmVkKSkgPT4gb2JqLmJhY2t1cCA9IHYuX3RvUGF0aHMoKSwKCgkJCXBhcmVudDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3BhcmVudCcsIHVuZGVmaW5lZCkpID0+IG9iai5wYXJlbnQgPSB2Ll90b1BhdGhzKCksCgoJCQl0eXBlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IG9iai50eXBlID0gdi5fdG9QYXRocygpLAoKCQkJbm9kZV9Db25maWdzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbm9kZV9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IG9iai5ub2RlX0NvbmZpZ3MgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJCWNhcnJpZXJfRXZlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2Fycmllcl9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IG9iai5jYXJyaWVyX0V2ZW50cyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQkJc2VuZGVyX0V2ZW50czogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3NlbmRlcl9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IG9iai5zZW5kZXJfRXZlbnRzID0gdi5tYXAoX3YgPT4gX3YuX3RvUGF0aHMoKSksCgoJCQlyZWNpcGllbnRfRXZlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVjaXBpZW50X05vZGVzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnJlY2lwaWVudF9FdmVudHMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJCWJhY2t1cF9Ob2RlczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2JhY2t1cF9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IG9iai5iYWNrdXBfTm9kZXMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJCXBhcmVudF9Ob2RlczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3BhcmVudF9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IG9iai5wYXJlbnRfTm9kZXMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJCW5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbm9kZV9Ob2RlcycsIHVuZGVmaW5lZCkpID0+IG9iai5ub2RlX05vZGVfR3JvdXBfTWVtYmVycyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQl9LCAiX3RvUGF0aHMiKTsKCQkvLyByZXR1cm4gcmV0OwoJCXJldHVybiBPYmplY3Qua2V5cyhyZXQpLm1hcChrID0+ICh7CgkJCVtrXTogcmV0W2tdCgkJfSkpOwoJfQoKCV90b1VwZGF0ZVNRTChmaWVsZHMpIHsKCQlsZXQgcmV0RmllbGRzID0gdGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkuam9pbignLCAnKTsKCQlsZXQgc3FsID0gYHVwZGF0ZSAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IHNldCBgICsgT2JqZWN0LmVudHJpZXModGhpcy5fdG9EQk9iamVjdChmaWVsZHMpKS5tYXAodiA9PiB0aGlzLl9RKCkgKyB2WzBdICsgdGhpcy5fUSgpICsgIj0iICsgdlsxXSkgKyBgIHdoZXJlICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2A7IC8vYCByZXR1cm5pbmcgJHtyZXRGaWVsZHN9YDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9VcGRhdGVTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV90b0luc2VydFNRTChmaWVsZHMpIHsKCQlsZXQgb2JqID0gdGhpcy5fdG9EQk9iamVjdChmaWVsZHMpOwoJCWxldCBzcWwgPSBgaW5zZXJ0IGludG8gJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoYCArIE9iamVjdC5rZXlzKG9iaikubWFwKGsgPT4gdGhpcy5fUSgpICsgayArIHRoaXMuX1EoKSkgKyAiKSB2YWx1ZXMgKCIgKyBPYmplY3QudmFsdWVzKG9iaikgKyBgKWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvSW5zZXJ0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLk5vZGUpIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTm9kZSA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCBzcWwgPSBuZXcgc2FsZXNub3cuTm9kZSgpCgoJCQkJCS5iYWNrdXAobmV3IHNhbGVzbm93Lk5vZGUoKSkKCgkJCQkJLnBhcmVudChuZXcgc2FsZXNub3cuTm9kZSgpKQoKCQkJCQkudHlwZShuZXcgc2FsZXNub3cuTm9kZV9UeXBlKCkpCgoJCQkJCS5ub2RlX0NvbmZpZ3MobmV3IHNhbGVzbm93LkNvbmZpZygpKQoKCQkJCQkuY2Fycmllcl9FdmVudHMobmV3IHNhbGVzbm93LkV2ZW50KCkpCgoJCQkJCS5zZW5kZXJfRXZlbnRzKG5ldyBzYWxlc25vdy5FdmVudCgpKQoKCQkJCQkucmVjaXBpZW50X0V2ZW50cyhuZXcgc2FsZXNub3cuRXZlbnQoKSkKCgkJCQkJLmJhY2t1cF9Ob2RlcyhuZXcgc2FsZXNub3cuTm9kZSgpKQoKCQkJCQkucGFyZW50X05vZGVzKG5ldyBzYWxlc25vdy5Ob2RlKCkpCgoJCQkJCS5ub2RlX05vZGVfR3JvdXBfTWVtYmVycyhuZXcgc2FsZXNub3cuTm9kZV9Hcm91cF9NZW1iZXIoKSkKCgkJCQkJLl90b1NRTFRhYmxlKGRlcHRoKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJOb2RlIikgcmV0dXJuIGZhbHNlOwoKCQkJbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJCUZ1bGw6IHRydWUsCgkJCQlOdWxsOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5faWQgPSB0aGlzLklkID09IHF1ZXJ5LklkLAoKCQkJCWFkZHJlc3M6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFkZHJlc3MgPSB2ID09IHF1ZXJ5LmFkZHJlc3MoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fYWRkcmVzc19zZXQgJiYgIXF1ZXJ5Ll9hZGRyZXNzX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hZGRyZXNzID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2FkZHJlc3Nfc2V0ICYmIHF1ZXJ5Ll9hZGRyZXNzX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWRkcmVzcyA9IGZhbHNlOwoJCQkJfSwKCgkJCQliYWNrdXA6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmJhY2t1cCA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkuYmFja3VwKCkgOiBudWxsKSA6IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2JhY2t1cF9zZXQgJiYgIXF1ZXJ5Ll9iYWNrdXBfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmJhY2t1cCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9iYWNrdXBfc2V0ICYmIHF1ZXJ5Ll9iYWNrdXBfc2V0KSB8fAoKCQkJCQkJKHRoaXMuYmFja3VwKCkgJiYgIXRoaXMuYmFja3VwKCkuX21hdGNoZXMocXVlcnkuYmFja3VwKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5iYWNrdXAgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcGFyZW50OiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5wYXJlbnQgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LnBhcmVudCgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9wYXJlbnRfc2V0ICYmICFxdWVyeS5fcGFyZW50X3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5wYXJlbnQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcGFyZW50X3NldCAmJiBxdWVyeS5fcGFyZW50X3NldCkgfHwKCgkJCQkJCSh0aGlzLnBhcmVudCgpICYmICF0aGlzLnBhcmVudCgpLl9tYXRjaGVzKHF1ZXJ5LnBhcmVudCgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucGFyZW50ID0gZmFsc2U7CgkJCQl9LAoKCQkJCXBvcnQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnBvcnQgPSB2ID09IHF1ZXJ5LnBvcnQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fcG9ydF9zZXQgJiYgIXF1ZXJ5Ll9wb3J0X3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5wb3J0ID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3BvcnRfc2V0ICYmIHF1ZXJ5Ll9wb3J0X3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucG9ydCA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvbmxpbmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9ubGluZSA9IHYgPT0gcXVlcnkub25saW5lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29ubGluZV9zZXQgJiYgIXF1ZXJ5Ll9vbmxpbmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9ubGluZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vbmxpbmVfc2V0ICYmIHF1ZXJ5Ll9vbmxpbmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vbmxpbmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJc2VjdXJlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5zZWN1cmUgPSB2ID09IHF1ZXJ5LnNlY3VyZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9zZWN1cmVfc2V0ICYmICFxdWVyeS5fc2VjdXJlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5zZWN1cmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fc2VjdXJlX3NldCAmJiBxdWVyeS5fc2VjdXJlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouc2VjdXJlID0gZmFsc2U7CgkJCQl9LAoKCQkJCXR5cGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnR5cGUgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LnR5cGUoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fdHlwZV9zZXQgJiYgIXF1ZXJ5Ll90eXBlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai50eXBlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3R5cGVfc2V0ICYmIHF1ZXJ5Ll90eXBlX3NldCkgfHwKCgkJCQkJCSh0aGlzLnR5cGUoKSAmJiAhdGhpcy50eXBlKCkuX21hdGNoZXMocXVlcnkudHlwZSgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudHlwZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQkJbm9kZV9Db25maWdzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLm5vZGVfQ29uZmlncyA9IHYubWFwKF92ID0+IHF1ZXJ5Lm5vZGVfQ29uZmlncygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJCWNhcnJpZXJfRXZlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmNhcnJpZXJfRXZlbnRzID0gdi5tYXAoX3YgPT4gcXVlcnkuY2Fycmllcl9FdmVudHMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCQlzZW5kZXJfRXZlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLnNlbmRlcl9FdmVudHMgPSB2Lm1hcChfdiA9PiBxdWVyeS5zZW5kZXJfRXZlbnRzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQkJcmVjaXBpZW50X0V2ZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5yZWNpcGllbnRfRXZlbnRzID0gdi5tYXAoX3YgPT4gcXVlcnkucmVjaXBpZW50X0V2ZW50cygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJCWJhY2t1cF9Ob2RlczogKG9iaiwgdikgPT4gewoJCQkJCW9iai5iYWNrdXBfTm9kZXMgPSB2Lm1hcChfdiA9PiBxdWVyeS5iYWNrdXBfTm9kZXMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCQlwYXJlbnRfTm9kZXM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoucGFyZW50X05vZGVzID0gdi5tYXAoX3YgPT4gcXVlcnkucGFyZW50X05vZGVzKCkuYW55KHEgPT4gX3YuX21hdGNoZXMocSkpKTsKCQkJCX0sCgoJCQkJbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoubm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMgPSB2Lm1hcChfdiA9PiBxdWVyeS5ub2RlX05vZGVfR3JvdXBfTWVtYmVycygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJYmFja3VwOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgYmFja3VwIik7CgkJCQkJb2JqLmJhY2t1cCA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJCXBhcmVudDogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIHBhcmVudCIpOwoJCQkJCW9iai5wYXJlbnQgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQl0eXBlOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgdHlwZSIpOwoJCQkJCW9iai50eXBlID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJbm9kZV9Db25maWdzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLm5vZGVfQ29uZmlncyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQkJY2Fycmllcl9FdmVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouY2Fycmllcl9FdmVudHMgPSB2Lm1hcChfdiA9PiBfdi5fbWF0Y2hpbmcocXVlcnkpKS5mbGF0KCk7CgkJCQl9LAoKCQkJCXNlbmRlcl9FdmVudHM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouc2VuZGVyX0V2ZW50cyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQkJcmVjaXBpZW50X0V2ZW50czogKG9iaiwgdikgPT4gewoJCQkJCW9iai5yZWNpcGllbnRfRXZlbnRzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCQliYWNrdXBfTm9kZXM6IChvYmosIHYpID0+IHsKCQkJCQlvYmouYmFja3VwX05vZGVzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCQlwYXJlbnRfTm9kZXM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoucGFyZW50X05vZGVzID0gdi5tYXAoX3YgPT4gX3YuX21hdGNoaW5nKHF1ZXJ5KSkuZmxhdCgpOwoJCQkJfSwKCgkJCQlub2RlX05vZGVfR3JvdXBfTWVtYmVyczogKG9iaiwgdikgPT4gewoJCQkJCW9iai5ub2RlX05vZGVfR3JvdXBfTWVtYmVycyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fYWRkcmVzc19zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9iYWNrdXBfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcGFyZW50X3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3BvcnRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb25saW5lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3NlY3VyZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl90eXBlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9lbmFibGVkX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZGF0ZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9uYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3JlbWFya19zZXQgPyBmYWxzZSA6IHRydWUpOwoKCQkJaWYgKHJvb3QgIT0gdGhpcyAmJiBpc1F1ZXJ5KSB7CgkJCQlsZXQgbXlNYXRjaGVzID0gcm9vdC5fbWF0Y2hpbmcodGhpcyk7CgkJCQlpZiAoIW15TWF0Y2hlcy5sZW5ndGgpIHJldHVybiB0aGlzOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJRdWVyeSIsIG15TWF0Y2hlcy5sZWd0aCk7CgkJCQlyZXR1cm4gbXlNYXRjaGVzWzBdOwoJCQl9CgoJCQl0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJYmFja3VwOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMuYmFja3VwKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlwYXJlbnQ6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy5wYXJlbnQocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJCXR5cGU6IChvYmosIHYpID0+IHsKCQkJCQlpZiAodikgewoJCQkJCQlsZXQgcmV0ID0gdi5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdikgdGhpcy50eXBlKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlub2RlX0NvbmZpZ3M6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5ub2RlX0NvbmZpZ3MoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJY2Fycmllcl9FdmVudHM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5jYXJyaWVyX0V2ZW50cygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQlzZW5kZXJfRXZlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMuc2VuZGVyX0V2ZW50cygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQlyZWNpcGllbnRfRXZlbnRzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMucmVjaXBpZW50X0V2ZW50cygpW2ldID0gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCQliYWNrdXBfTm9kZXM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5iYWNrdXBfTm9kZXMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQkJcGFyZW50X05vZGVzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMucGFyZW50X05vZGVzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJCW5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJdi5maWx0ZXIodGEgPT4gdGEpLmZvckVhY2goKHRhLCBpKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0YS5fZGVSZWZlcmVuY2Uocm9vdCk7CgkJCQkJCWlmIChyZXQgIT0gdGEpIHRoaXMubm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCWFkZHJlc3M6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhZGRyZXNzJywgdW5kZWZpbmVkKSA6ICJhZGRyZXNzIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FkZHJlc3NfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFkZHJlc3MocmVmKTsKCgkJCX0sCgoJCQliYWNrdXA6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdiYWNrdXAnLCB1bmRlZmluZWQpIDogImJhY2t1cCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9iYWNrdXBfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMuYmFja3VwKCkgfHwgbmV3IHNhbGVzbm93Lk5vZGUoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLmJhY2t1cChvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIGJhY2t1cCIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJcGFyZW50OiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncGFyZW50JywgdW5kZWZpbmVkKSA6ICJwYXJlbnQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcGFyZW50X2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLnBhcmVudCgpIHx8IG5ldyBzYWxlc25vdy5Ob2RlKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5wYXJlbnQob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSBwYXJlbnQiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCXBvcnQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdwb3J0JywgdW5kZWZpbmVkKSA6ICJwb3J0IikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3BvcnRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnBvcnQocmVmKTsKCgkJCX0sCgoJCQlvbmxpbmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvbmxpbmUnLCB1bmRlZmluZWQpIDogIm9ubGluZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vbmxpbmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5vbmxpbmUocmVmKTsKCgkJCX0sCgoJCQlzZWN1cmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzZWN1cmUnLCB1bmRlZmluZWQpIDogInNlY3VyZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9zZWN1cmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnNlY3VyZShyZWYpOwoKCQkJfSwKCgkJCXR5cGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSA6ICJ0eXBlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3R5cGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMudHlwZSgpIHx8IG5ldyBzYWxlc25vdy5Ob2RlX1R5cGUoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLnR5cGUob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSB0eXBlIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jb2RlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5jb2RlKHJlZik7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3JkZXJfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9yZGVyKHJlZik7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZGF0ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCQkJCQlpZiAodHlwZW9mKG1vbWVudCkgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXMpICE9PSAidW5kZWZpbmVkIikgewoJCQkJCQlyZWYgPSBtb21lbnQucGFyc2Vab25lKHJlZiwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGF0ZV9mb3JtYXQiXSArICIgIiArIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLnRpbWVfZm9ybWF0Il0sIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRlZmF1bHQudHoiXSkudG9EYXRlKCk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJcmVmID0gbmV3IERhdGUocmVmKTsKCQkJCQl9CgkJCQl9IGVsc2UgewoJCQkJCXJlZiA9IG5ldyBEYXRlKERhdGUucGFyc2UocmVmICsgIiBHTVQiKSk7CgkJCQl9CgkJCQl0aGlzLmRhdGUocmVmKTsKCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9uYW1lX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5uYW1lKHJlZik7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fcmVtYXJrX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5yZW1hcmsocmVmKTsKCgkJCX0sCgoJCQlub2RlX0NvbmZpZ3M6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdub2RlX05vZGVzJywgdW5kZWZpbmVkKSA6ICJub2RlX0NvbmZpZ3MiKSkgPT4gdGhpcy5ub2RlX0NvbmZpZ3Mob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkNvbmZpZygpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQkJY2Fycmllcl9FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjYXJyaWVyX05vZGVzJywgdW5kZWZpbmVkKSA6ICJjYXJyaWVyX0V2ZW50cyIpKSA9PiB0aGlzLmNhcnJpZXJfRXZlbnRzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5FdmVudCgpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQkJc2VuZGVyX0V2ZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3NlbmRlcl9Ob2RlcycsIHVuZGVmaW5lZCkgOiAic2VuZGVyX0V2ZW50cyIpKSA9PiB0aGlzLnNlbmRlcl9FdmVudHMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93LkV2ZW50KCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCQlyZWNpcGllbnRfRXZlbnRzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVjaXBpZW50X05vZGVzJywgdW5kZWZpbmVkKSA6ICJyZWNpcGllbnRfRXZlbnRzIikpID0+IHRoaXMucmVjaXBpZW50X0V2ZW50cyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuRXZlbnQoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJCWJhY2t1cF9Ob2RlczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2JhY2t1cF9Ob2RlcycsIHVuZGVmaW5lZCkgOiAiYmFja3VwX05vZGVzIikpID0+IHRoaXMuYmFja3VwX05vZGVzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5Ob2RlKCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCQlwYXJlbnRfTm9kZXM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdwYXJlbnRfTm9kZXMnLCB1bmRlZmluZWQpIDogInBhcmVudF9Ob2RlcyIpKSA9PiB0aGlzLnBhcmVudF9Ob2RlcyhvYmpbZWFDb2RlXSA/IG9ialtlYUNvZGVdLm1hcChfdiA9PiBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQkJbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdub2RlX05vZGVzJywgdW5kZWZpbmVkKSA6ICJub2RlX05vZGVfR3JvdXBfTWVtYmVycyIpKSA9PiB0aGlzLm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKG9ialtlYUNvZGVdID8gb2JqW2VhQ29kZV0ubWFwKF92ID0+IG5ldyBzYWxlc25vdy5Ob2RlX0dyb3VwX01lbWJlcigpLl9mcm9tRG9jdW1lbnQoX3YsIGJUb29sKSkgOiB1bmRlZmluZWQsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTW2VhQ29kZV0gOiB1bmRlZmluZWQpLAoKCQl9LCAiX2Zyb21Eb2N1bWVudCIpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSB7CgkJbGV0IHJldCA9IHt9OwoKCQlpZiAoIWJUb29sKSB7CgkJCXJldC5fX2dlbmVyYXRlZCA9IG5ldyBEYXRlKCk7CgkJCWlmICh0aGlzLlRvb2wubmFtZSkgewoJCQkJcmV0Ll9fdG9vbCA9IHsKCQkJCQluYW1lOiB0aGlzLlRvb2wubmFtZSwKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlpZiAoc2FsZXNub3cuX25vZGUpIHsKCQkJCXJldC5fX25vZGUgPSB7CgkJCQkJY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogYkZ1bGwsCgkJCU51bGw6IGJOdWxsLAoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IChvYmosIHYpID0+IHsKCQkJCWlmIChiVG9vbCkgcmV0dXJuOwoJCQkJb2JqLlRISVMgPSB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQlvYmouT1BFUkFUT1JTLlRISVMgPSB0aGlzLl9USElTX2Nvb3A7CgkJCX0sCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldID0gdiwKCgkJCSJhZGRyZXNzIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FkZHJlc3MnLCB1bmRlZmluZWQpIDogImFkZHJlc3MiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWRkcmVzc19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWRkcmVzc19jb29wOwoJCQkJfQoJCQl9LAoKCQkJImJhY2t1cCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdiYWNrdXAnLCB1bmRlZmluZWQpIDogImJhY2t1cCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX2JhY2t1cF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYmFja3VwX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicGFyZW50IjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3BhcmVudCcsIHVuZGVmaW5lZCkgOiAicGFyZW50IikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fcGFyZW50X2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9wYXJlbnRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJwb3J0IjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3BvcnQnLCB1bmRlZmluZWQpIDogInBvcnQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcG9ydF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcG9ydF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9ubGluZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvbmxpbmUnLCB1bmRlZmluZWQpIDogIm9ubGluZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9vbmxpbmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29ubGluZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInNlY3VyZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzZWN1cmUnLCB1bmRlZmluZWQpIDogInNlY3VyZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9zZWN1cmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3NlY3VyZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInR5cGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkgOiAidHlwZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX3R5cGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3R5cGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCW5vZGVfQ29uZmlnczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25vZGVfTm9kZXMnLCB1bmRlZmluZWQpIDogIm5vZGVfQ29uZmlncyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9ub2RlX0NvbmZpZ3NfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25vZGVfQ29uZmlnc19jb29wOwoJCQkJfQoJCQl9LAoKCQkJY2Fycmllcl9FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjYXJyaWVyX05vZGVzJywgdW5kZWZpbmVkKSA6ICJjYXJyaWVyX0V2ZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9jYXJyaWVyX0V2ZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY2Fycmllcl9FdmVudHNfY29vcDsKCQkJCX0KCQkJfSwKCgkJCXNlbmRlcl9FdmVudHM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzZW5kZXJfTm9kZXMnLCB1bmRlZmluZWQpIDogInNlbmRlcl9FdmVudHMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fc2VuZGVyX0V2ZW50c19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fc2VuZGVyX0V2ZW50c19jb29wOwoJCQkJfQoJCQl9LAoKCQkJcmVjaXBpZW50X0V2ZW50czogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlY2lwaWVudF9Ob2RlcycsIHVuZGVmaW5lZCkgOiAicmVjaXBpZW50X0V2ZW50cyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9yZWNpcGllbnRfRXZlbnRzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZWNpcGllbnRfRXZlbnRzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQliYWNrdXBfTm9kZXM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdiYWNrdXBfTm9kZXMnLCB1bmRlZmluZWQpIDogImJhY2t1cF9Ob2RlcyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9iYWNrdXBfTm9kZXNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2JhY2t1cF9Ob2Rlc19jb29wOwoJCQkJfQoJCQl9LAoKCQkJcGFyZW50X05vZGVzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncGFyZW50X05vZGVzJywgdW5kZWZpbmVkKSA6ICJwYXJlbnRfTm9kZXMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fcGFyZW50X05vZGVzX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9wYXJlbnRfTm9kZXNfY29vcDsKCQkJCX0KCQkJfSwKCgkJCW5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbm9kZV9Ob2RlcycsIHVuZGVmaW5lZCkgOiAibm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2ZsaXAoKSAqLwoJX2ZsaXAoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9mbGlwKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fZmxpcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCglieU5vZGUoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX2JhY2t1cCJdICYmIChhWyJfYmFja3VwIl0uRXF1YWxzID8gYVsiX2JhY2t1cCJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfYmFja3VwIl0sIHIpKSkgewoJCQkJCXIuX2JhY2t1cF9Ob2Rlcy5wdXNoKGEpOwoJCQkJfQoJCQl9KTsKCQl9KTsKCQlyZXR1cm4gcmV0OwoJfQoKCWJ5Tm9kZShhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfcGFyZW50Il0gJiYgKGFbIl9wYXJlbnQiXS5FcXVhbHMgPyBhWyJfcGFyZW50Il0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl9wYXJlbnQiXSwgcikpKSB7CgkJCQkJci5fcGFyZW50X05vZGVzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlOb2RlX1R5cGUoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX3R5cGUiXSAmJiAoYVsiX3R5cGUiXS5FcXVhbHMgPyBhWyJfdHlwZSJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfdHlwZSJdLCByKSkpIHsKCQkJCQlyLl90eXBlX05vZGVzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSBmYWxzZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLnR5cGUgPSB7fTsKCQkJaWYgKCF0aGlzLl90eXBlX3NldCkgZXJyb3IudHlwZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghdGhpcy50eXBlKCkpIGVycm9yLnR5cGVbIjAyIl0gPSAiRW1wdHkgVmFsdWUiOwoJCQlpZiAodGhpcy50eXBlKCkgJiYgYlN5bmMgJiYgIXRoaXMudHlwZSgpLl9fc3luY19vbigpKSBlcnJvci50eXBlWyIwMyJdID0gIk5vdCBpbiBTeW5jIjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IudHlwZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IudHlwZTsKCQl9CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSB0cnVlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IuY29kZSA9IHt9OwoJCQlpZiAoIXRoaXMuX2NvZGVfc2V0KSBlcnJvci5jb2RlWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5jb2RlKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5jb2RlOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZS5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuTm9kZShudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuY29kZSh0aGlzLmNvZGUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fdHlwZV9zZXQpIHsKCQkJCQl0aGlzLnR5cGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gKCkgPT4gbmV3IG9TY29wZS5Ob2RlX1R5cGUoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5uYW1lKHR5cGVvZihnbG9iYWwpICE9PSAidW5kZWZpbmVkIiA/ICJOb2RlSlMiIDogIkJyb3dzZXIiKS5keW5hbWljKHR5cGVvZihnbG9iYWwpID09PSAidW5kZWZpbmVkIik7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSB7CgkJCQkJdGhpcy5hY3RpdmUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSB7CgkJCQkJdGhpcy5lbmFibGVkKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgewoJCQkJCXRoaXMuZGF0ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSBuZXcgRGF0ZSgpOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jRW50aXR5QXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9iYWNrdXBfc2V0ICYmIHRoaXMuYmFja3VwKCkgJiYgIShhd2FpdCB0aGlzLmJhY2t1cCgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX2JhY2t1cCgpOwoKCQkJCQlpZiAodGhpcy5fcGFyZW50X3NldCAmJiB0aGlzLnBhcmVudCgpICYmICEoYXdhaXQgdGhpcy5wYXJlbnQoKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9wYXJlbnQoKTsKCgkJCQkJaWYgKHRoaXMuX3R5cGVfc2V0ICYmIHRoaXMudHlwZSgpICYmICEoYXdhaXQgdGhpcy50eXBlKCkuc3RvcmUoKSkpIHRoaXMuY2xlYXJfdHlwZSgpOwoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9ub2RlX0NvbmZpZ3Nfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5ub2RlX0NvbmZpZ3MoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuX2NhcnJpZXJfRXZlbnRzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuY2Fycmllcl9FdmVudHMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuX3NlbmRlcl9FdmVudHNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5zZW5kZXJfRXZlbnRzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICh0aGlzLl9yZWNpcGllbnRfRXZlbnRzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMucmVjaXBpZW50X0V2ZW50cygpKSB7CgkJCQkJCQlhd2FpdCB0YS5zdG9yZSgpOwoJCQkJCQl9CgkJCQkJfQoKCQkJCQlpZiAodGhpcy5fYmFja3VwX05vZGVzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMuYmFja3VwX05vZGVzKCkpIHsKCQkJCQkJCWF3YWl0IHRhLnN0b3JlKCk7CgkJCQkJCX0KCQkJCQl9CgoJCQkJCWlmICh0aGlzLl9wYXJlbnRfTm9kZXNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5wYXJlbnRfTm9kZXMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuX25vZGVfTm9kZV9Hcm91cF9NZW1iZXJzX3NldCkgewoJCQkJCQlmb3IgYXdhaXQgKGNvbnN0IHRhIG9mIHRoaXMubm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCQlpZiAoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5Pd25lciA9PSB0aGlzKSB7CgkJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYENPTU1JVCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nIFRSQU5TQUNUSU9OJzonJ31gKTsKCQkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kID0gbmV3IERhdGUoKTsKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZS5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvSW5zZXJ0U1FMKCkpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnaW5zZXJ0JywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJdGhpcy5fZnJvbURvY3VtZW50KGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJbGV0IG9iaiA9IHt9OwoKCQkJCWlmICh0aGlzLl9hZGRyZXNzX3NldCkgewoKCQkJCQlvYmouYWRkcmVzcyA9IHRoaXMuYWRkcmVzcygpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fYmFja3VwX3NldCkgewoKCQkJCQlvYmouYmFja3VwID0gdGhpcy5fYmFja3VwLklkOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fcGFyZW50X3NldCkgewoKCQkJCQlvYmoucGFyZW50ID0gdGhpcy5fcGFyZW50LklkOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fcG9ydF9zZXQpIHsKCgkJCQkJb2JqLnBvcnQgPSB0aGlzLnBvcnQoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX29ubGluZV9zZXQpIHsKCgkJCQkJb2JqLm9ubGluZSA9IHRoaXMub25saW5lKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9zZWN1cmVfc2V0KSB7CgoJCQkJCW9iai5zZWN1cmUgPSB0aGlzLnNlY3VyZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fdHlwZV9zZXQpIHsKCgkJCQkJb2JqLnR5cGUgPSB0aGlzLl90eXBlLklkOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fYWN0aXZlX3NldCkgewoKCQkJCQlvYmouYWN0aXZlID0gdGhpcy5hY3RpdmUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfc2V0KSB7CgoJCQkJCW9iai5lbmFibGVkID0gdGhpcy5lbmFibGVkKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9jb2RlX3NldCkgewoKCQkJCQlvYmouY29kZSA9IHRoaXMuY29kZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fb3JkZXJfc2V0KSB7CgoJCQkJCW9iai5vcmRlciA9IHRoaXMub3JkZXIoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2RhdGVfc2V0KSB7CgoJCQkJCW9iai5kYXRlID0gdGhpcy5kYXRlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9uYW1lX3NldCkgewoKCQkJCQlvYmoubmFtZSA9IHRoaXMubmFtZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fcmVtYXJrX3NldCkgewoKCQkJCQlvYmoucmVtYXJrID0gdGhpcy5yZW1hcmsoKTsKCgkJCQl9CgoJCQkJbG9nKCJTZW5kaW5nIHRvIFNGIiwgb2JqKTsKCgkJCQlsZXQgcmVzID0gYXdhaXQgdGhpcy5Ub29sLmRiLnNvYmplY3QoIk5vZGUiKS5jcmVhdGUob2JqKTsKCQkJCXRoaXMuSWQgPSByZXMuaWQ7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIHVwZGF0ZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJ1cGRhdGUiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlLnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvVXBkYXRlU1FMKCkpOwoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKCkpOwoJCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0WzBdOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZS5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoZmllbGRzLCBvYmpzKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIHsKCQkJCQlzeXNwYXJtX3F1ZXJ5OiBPYmplY3QuZW50cmllcyh0aGlzLl90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgdHJ1ZSksIG51bGwsIHsKCQkJCQl1cmw6ICdyZXN0LnVybC5ncWwnCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgKTsKCQkJCXJldCA9IHJldC5jb250ZW50ID8gW0pTT04ucGFyc2UodGhpcy5fYXRvYihyZXQuY29udGVudCkpXSA6IFtdOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiQmVmb3JlIF9mcm9tRG9jdW1lbnQoKSIsIHJldCk7CgoJCQlyZXQgPSByZXQubWFwKHIgPT4gbmV3IHNhbGVzbm93Lk5vZGUobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHIsIHRydWUsIHRydWUpLl9fc3luY19vbihuZXcgRGF0ZSgpKSk7CgoJCQlhd2FpdCB0aGlzLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiT3V0cHV0IiwgcmV0KTsKCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoKCQkJcmV0dXJuIHJldDsKCQkJLyoqKiBFTkQgTE9DQUwgZmluZEFsbCgpICoqKi8KCQl9LCB7CgkJCWRlcHRoLAoJCQlvYmpzLAoJCQlzdGFydCwKCQkJZW5kLAoJCQlmaWVsZHMsCgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBbXQoJCX0pLnJldCB8fCBbXTsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoKCX0KCn07CgpzYWxlc25vdy5Ob2RlX0dyb3VwID0gY2xhc3MgTm9kZV9Hcm91cCBleHRlbmRzIHNhbGVzbm93LkdlbmVyaWNTZXJ2aWNlQVBJIHsKCWNvbnN0cnVjdG9yKGlkLCB0b29sKSB7CgkJc3VwZXIoaWQsIHRvb2wpOwoKCQl0aGlzLlNjb3BlID0gInNhbGVzbm93IjsKCQl0aGlzLkRlYnVnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKamNtbDBhV05oYkNJNklpb2lMQ0psY25KdmNpSTZJaW9pTENKM1lYSnVJam9pS2lJc0ltbHVabThpT2lJcUxtbHVhWFFzS2k1ZmNtVnpkQ3dxTGw5c2IyRmtWRzl2YkhNaWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLkNvbmZpZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5Sk9iMlJsSWpwN0ltNXZSR1YwWldOMElqcDBjblZsTENKcGJtbDBMbVZ1WkhNaU9qSXNJbWx1YVhRdWJHOXZjQ0k2TUM0MUxDSjBiMjlzY3k1emRHOXlaU0k2Wm1Gc2MyVXNJbVJsZEdWamRGQmhjbVZ1ZEM1SlVDSTZJakU0TWk0eE5qZ3VOekF1T0RJaUxDSmtaWFJsWTNSUVlYSmxiblF1WTI5a1pTSTZJbVU0WkdVd05tVXpaV1JqTkRRellXVTVaR1psTVdSbE5XVmpOVEpoTkdKbUlpd2ljMlZqY21WMElqb2liMU5MZDJkYU1uTkxSazlVU1VwallrRm1WVWxSTkVOcU9YRnpTRFE0Ym13aUxDSndiR0Y1WjNKdmRXNWtJanAwY25WbExDSm5VbEJESWpwMGNuVmxMQ0p6ZEc5eVpTNXpaVzV6YVhScGRtbDBlU0k2TVN3aVkyOXRjR0Z1ZVNJNkluSmxjM1Z0WlNKOUxDSkZkbVZ1ZENJNmV5SjBjbWxuWjJWeUxuUnBiV1Z2ZFhRaU9qRXdNREF3TENKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjBzSWxSdmIyd2lPbnNpWjJsMGFIVmlMblJ2YjJ4eklqb2lhSFIwY0hNNkx5OXlZWGN1WjJsMGFIVmlkWE5sY21OdmJuUmxiblF1WTI5dEwyWmhaR2x1TDJaaFpHbHVMbWRwZEdoMVlpNXBieTl0WVhOMFpYSXZJaXdpYzJWamNtVjBJam9pYjFOTGQyZGFNbk5MUms5VVNVcGpZa0ZtVlVsUk5FTnFPWEZ6U0RRNGJtd2lMQ0p3YkdGNVozSnZkVzVrSWpwMGNuVmxMQ0puVWxCRElqcDBjblZsTENKemRHOXlaUzV6Wlc1emFYUnBkbWwwZVNJNk1Td2lZMjl0Y0dGdWVTSTZJbkpsYzNWdFpTSjlMQ0p6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRlc3QgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpWYzJWeUlqcDdJbDloZFhSb2IzSnBlbVV1ZFhObGNtNWhiV1VpT2lKbVlXUnBJaXdpWDJGMWRHaHZjbWw2WlM1d1lYTnpkMjl5WkNJNklqRXlNeUlzSWw5aGRYUm9iM0pwZW1VdWRHVnpkRlZ6WlhJaU9uc2lZV04wYVhabElqcDBjblZsTENKbGJtRmliR1ZrSWpwMGNuVmxMQ0puWlc1a1pYSWlPbnNpWTI5a1pTSTZJazBpTENKdVlXMWxJam9pVFdGc1pTSjlMQ0pqYjJSbElqb2labUZrYVNJc0ltNWhiV1VpT2lKR1lXUnBJbjE5ZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVG9vbHMgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXeUpUY1d4RVFpSXNleUp1WVcxbElqb2lVMDVQVjA5UFFpSXNJblI1Y0dVaU9uc2libUZ0WlNJNklsTmxjblpwWTJWT2IzY2lmWDBzSWxOaGJHVnpSbTl5WTJVaUxDSkhhWFJJZFdJaVhRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLk1hcHBpbmdzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgVzEwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoKCQkvLyBhdm9pZCBzdXBlciwga2VlcCB0aGlzIGhlcmUKCQl0aGlzLl9fSUQgPSB0aGlzLl9fSUQgfHwge307CgkJdGhpcy5Ub29sID0gdG9vbDsKCQl0aGlzLklkID0gaWQ7CgoJCXRoaXMuVmFsdWVFbnRpdGllcyA9IFtdOwoKCQl0aGlzLkRhdGUgPSBudWxsOwoKCQl0aGlzLmNsZWFyX1RISVMoKTsKCQl0aGlzLkVudGl0eVZhbHVlcyA9IFtdOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzKCk7CgoJfQoKCWdldCBFbnRpdHlDbGFzcygpIHsKCQlsZXQgZWMgPSB7CgoJCQlOYW1lOiAiTm9kZSBHcm91cCIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJLy8gKHRoaXMuZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzKCkgfHwgW10pLmZvckVhY2godCA9PiB0LlRvb2wgPSB0b29sKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJVEhJUyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsKCQlpZiAoIXYpIHJldHVybiB0aGlzOwoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCQl0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KSA9PT0gJ29iamVjdCcgJiYgX3YuRW50aXR5Q2xhc3MgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSA9PSB0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGUgPT0gdGhpcy5TY29wZSk7CgkJaWYgKGNvKSB0aGlzLl9USElTX2Nvb3AgPSBjbzsKCQlyZXR1cm4gdGhpczsKCX0KCgljbGVhcl9USElTKCkgewoJCXRoaXMuX1RISVMgPSBbXTsKCQl0aGlzLl9USElTX2Nvb3AgPSAnJzsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGdyb3VwX05vZGVfR3JvdXBfTWVtYmVycyAqKi8KCWdyb3VwX05vZGVfR3JvdXBfTWVtYmVycyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdGhpcy5fZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICc1OWNiZGQxMS1lY2IwLTQ3ZmItYjAxNS1lMjliZTM0ZTc0ZmEnICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ05vZGUgR3JvdXAgTWVtYmVyJykgcmV0dXJuIHRoaXM7CgoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCgkJdi5maWx0ZXIoX3YgPT4gX3YgJiYgIV92Ll9ncm91cF9zZXQpLmZvckVhY2goX3YgPT4gewoJCQlpZiAoIV92LmNvbnN0cnVjdG9yKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMnLCAnRW50aXR5T2JqZWN0JywgMSwgImdyb3VwIGhhcyBubyBjb25zdHJ1Y3RvciIsIF92KTsKCQkJfSBlbHNlIGlmIChfdi5jb25zdHJ1Y3Rvci5uYW1lICE9ICJOb2RlX0dyb3VwX01lbWJlciIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dyb3VwX05vZGVfR3JvdXBfTWVtYmVycycsICdFbnRpdHlPYmplY3QnLCAxLCAiZ3JvdXAgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJOb2RlX0dyb3VwX01lbWJlciIpOwoJCQl9IGVsc2UgaWYgKHRydWUgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQgfHwgX3YuX19zeW5jX29uKCkgfHwgX3YuSWQgPT0gX3YuSWQpIHsgLy8gZXhwZXJpbWVudGFsIGNvbmRpdGlvbiwgd2FzIGFsd2F5cyB0cnVlCgkJCQlfdi5ncm91cCh0aGlzKTsKCQkJfQoJCX0pOwoKCQl0aGlzLl9ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMucHVzaCguLi52KTsKCQl0aGlzLl9ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX2dyb3VwX05vZGVfR3JvdXBfTWVtYmVyc19jb29wID0gY287CgoJCXJldHVybiB0aGlzOwoJfQoJY2xlYXJfZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzKCkgewoJCXRoaXMuX2dyb3VwX05vZGVfR3JvdXBfTWVtYmVyc19zZXQgPSBudWxsOwoJCXRoaXMuX2dyb3VwX05vZGVfR3JvdXBfTWVtYmVycyA9IG5ldyBBcnJheSgpOwoJCXRoaXMuX2dyb3VwX05vZGVfR3JvdXBfTWVtYmVyc19jb29wID0gbnVsbDsKCQlyZXR1cm4gdGhpczsKCX0KCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGdyb3VwX05vZGVfR3JvdXBfTWVtYmVycyAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX2FjdGl2ZV9zZXQsCgoJCQl0aGlzLl9lbmFibGVkX3NldCwKCgkJCXRoaXMuX2NvZGVfc2V0LAoKCQkJdGhpcy5fb3JkZXJfc2V0LAoKCQkJdGhpcy5fZGF0ZV9zZXQsCgoJCQl0aGlzLl9uYW1lX3NldCwKCgkJCXRoaXMuX3JlbWFya19zZXQsCgoJCQl0aGlzLl9ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnNfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fYWN0aXZlX3NldCA9IHRoaXMuX2FjdGl2ZV9zZXQ7CgkJcmV0Ll9hY3RpdmVfY29vcCA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCXJldC5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpID8gdGhpcy5hY3RpdmUoKSA6IHRoaXMuYWN0aXZlKCk7CgoJCXJldC5fZW5hYmxlZF9zZXQgPSB0aGlzLl9lbmFibGVkX3NldDsKCQlyZXQuX2VuYWJsZWRfY29vcCA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQlyZXQuZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpID8gdGhpcy5lbmFibGVkKCkgOiB0aGlzLmVuYWJsZWQoKTsKCgkJcmV0Ll9jb2RlX3NldCA9IHRoaXMuX2NvZGVfc2V0OwoJCXJldC5fY29kZV9jb29wID0gdGhpcy5fY29kZV9jb29wOwoJCXJldC5jb2RlID0gdGhpcy5jb2RlKCkgPyB0aGlzLmNvZGUoKSA6IHRoaXMuY29kZSgpOwoKCQlyZXQuX29yZGVyX3NldCA9IHRoaXMuX29yZGVyX3NldDsKCQlyZXQuX29yZGVyX2Nvb3AgPSB0aGlzLl9vcmRlcl9jb29wOwoJCXJldC5vcmRlciA9IHRoaXMub3JkZXIoKSA/IHRoaXMub3JkZXIoKSA6IHRoaXMub3JkZXIoKTsKCgkJcmV0Ll9kYXRlX3NldCA9IHRoaXMuX2RhdGVfc2V0OwoJCXJldC5fZGF0ZV9jb29wID0gdGhpcy5fZGF0ZV9jb29wOwoJCXJldC5kYXRlID0gdGhpcy5kYXRlKCkgPyB0aGlzLmRhdGUoKSA6IHRoaXMuZGF0ZSgpOwoKCQlyZXQuX25hbWVfc2V0ID0gdGhpcy5fbmFtZV9zZXQ7CgkJcmV0Ll9uYW1lX2Nvb3AgPSB0aGlzLl9uYW1lX2Nvb3A7CgkJcmV0Lm5hbWUgPSB0aGlzLm5hbWUoKSA/IHRoaXMubmFtZSgpIDogdGhpcy5uYW1lKCk7CgoJCXJldC5fcmVtYXJrX3NldCA9IHRoaXMuX3JlbWFya19zZXQ7CgkJcmV0Ll9yZW1hcmtfY29vcCA9IHRoaXMuX3JlbWFya19jb29wOwoJCXJldC5yZW1hcmsgPSB0aGlzLnJlbWFyaygpID8gdGhpcy5yZW1hcmsoKSA6IHRoaXMucmVtYXJrKCk7CgoJCXJldC5ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMgPSB0aGlzLmdyb3VwX05vZGVfR3JvdXBfTWVtYmVycygpLm1hcCh0ID0+IHQgPyB0Ll9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXBfTm9kZV9Hcm91cHMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkgIT0gJ05vZGVfR3JvdXAnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiRGVsZWdhdGluZyBpbnZva2F0aW9uIHRvICIgKyBldmVudC5jbGFzc05hbWUoKSk7CgkJCQlyZXR1cm4gbmV3IHNhbGVzbm93W2V2ZW50LmNsYXNzTmFtZSgpXSgpLl9pbnZva2VOb2RlKG4sIG1ldGhvZCwgZGF0YSwgZXZlbnQsIGJSYXcpOwoJCQl9CgoJCX0KCgkJbGV0IHJldCA9IG51bGw7CgoJCWRhdGEgPSBkYXRhIHx8IHt9OwoKCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQlkYXRhLl9fdGhpcyA9IGRhdGEuX190aGlzIHx8IHRoaXMuX3RvRG9jdW1lbnQoKTsKCQkJc3dpdGNoIChtZXRob2QpIHsKCgkJCX0KCQl9CgoJCWlmICghbiB8fCBzYWxlc25vdy5fbm9kZS5fc2FtZU5vZGUobikpIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkNhbGxiYWNrIik7CgkJCXJldCA9IGF3YWl0IHRoaXMuX2ludm9rZShtZXRob2QsIGRhdGEpOwoJCX0gZWxzZSBpZiAobi5hZGRyZXNzKCkgJiYgbi5fc2FtZU5vZGUobikgLyphY3R1YWwgbm9kZSovICkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBuLl9hZGRyZXNzLCBuLl9wb3J0LCBtZXRob2QpOwoJCQl0cnkgewoJCQkJbGV0IGNvbmZpZyA9IHsKCQkJCQloZWFkZXJzOiB7fSwKCQkJCX07CgkJCQlpZiAoc2FsZXNub3cuX190b2tlbikgY29uZmlnLmhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGAke3NhbGVzbm93Ll9fdG9rZW4udG9rZW5fdHlwZX0gJHtzYWxlc25vdy5fX3Rva2VuLmFjY2Vzc190b2tlbn1gOwoJCQkJcmV0ID0gYXdhaXQgYXhpb3MucG9zdChgaHR0cCR7bi5zZWN1cmUoKT8ncyc6Jyd9Oi8vJHtuLmFkZHJlc3MoKX06JHtuLnBvcnQoKSB8fCAzMDAwfS9tZXRob2QvTm9kZV9Hcm91cC8ke21ldGhvZH1gLCBkYXRhLCBjb25maWcpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQl9CgkJfSBlbHNlIHsKCgkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMuX19nZW5lcmF0ZWQ7CgkJCQlkZWxldGUgZGF0YS5fX3RoaXMub25saW5lOwoKCQkJfQoKCQkJLy93aHkgZG8gd2UgbmVlZCB0aGlzPz8/CgoJCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQkJdHJ5IHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSkgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHttZXRob2R9YCk7CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJbGV0IF9pZCA9IG51bGw7CgkJCQlpZiAodHlwZW9mKGRhdGEpID09PSAndW5kZWZpbmVkJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIGRhdGEsIG1ldGhvZCwge30pOwoJCQkJCXJldHVybiBkYXRhOwoJCQkJfSBlbHNlIGlmICh0eXBlb2YoZGF0YSkgPT09ICdzdHJpbmcnKSB7CgkJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShkYXRhKTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gZGF0YS5fX3RoaXMuY29kZSB8fCBkYXRhLmlkIHx8IGRhdGEuSUQ7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQkJaWYgKGRhdGEuSWQgJiYgZGF0YS5JZCA9PSBkYXRhLklkKSB7CgkJCQkJCV9pZCA9IGRhdGEuSWQ7CgkJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCQl9IGVsc2UgaWYgKGRhdGEuRW50aXR5Q2xhc3MpIHsKCQkJCQkJX2lkID0gZGF0YS5FbnRpdHlDbGFzcy5JZCB8fCBkYXRhLkVudGl0eUNsYXNzLk5hbWU7CgkJCQkJfSBlbHNlIHsKCQkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiMzUwODc0YjAtNzVmMi00ZTY2LWFlNGItYWZjMzEyMWYyZWI2IiB8fCAiTlVMTCI7CgkJCQkJfQoJCQkJfQoKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwIHx8IHt9OwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwW21ldGhvZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBbbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cFttZXRob2RdW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBbbWV0aG9kXVtfaWRdIHx8IHt9OwoKCQkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaCh7fSwgewoJCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCQl9KTsKCgkJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwW21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwW21ldGhvZF1bX2lkXVtfaGFzaF0gPSB7CgkJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoe30pLAoJCQkJCW9iajogZGF0YSwKCQkJCQlyZXVzZWQ6IDAsCgkJCQl9OwoJCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0gPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGRhdGEsIG1ldGhvZCwge30sIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCBgVHJpZ2dlcnJpbmcgJHttZXRob2R9IHRvICR7bi5jb2RlKCl9ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSxudWxsLDQpfWApOwoKCQkJbGV0IGV2ID0gbmV3IHNhbGVzbm93LkV2ZW50KCkuYWN0aXZlKHRydWUpLmVuYWJsZWQodHJ1ZSkuY29kZSh0aGlzLl91dWlkKCkpLm5hbWUodGhpcy5fX2NvbmZpZygnZXZlbnQnKSB8fCAnc2FsZXNub3cuRXZlbnQnKS5kYXRlKHRoaXMuc2VydmVyRGF0ZSgpKS5yZWNpcGllbnQobikubWV0aG9kKG1ldGhvZCkuY2xhc3NOYW1lKCdOb2RlX0dyb3VwJykuc2VuZGVyKHNhbGVzbm93Ll9ub2RlKS5jYXJyaWVyKHNhbGVzbm93Ll9ub2RlKS5wYXlsb2FkKGRhdGEpOwoJCQlpZiAoZXZlbnQpIHsKCQkJCWlmIChldmVudC5fcmVzcG9uc2VUb19zZXQpIGV2LnJlc3BvbnNlVG8oZXZlbnQucmVzcG9uc2VUbygpKTsKCQkJCWlmIChldmVudC5fc2VuZGVyX3NldCkgZXYuc2VuZGVyKGV2ZW50LnNlbmRlcigpKTsKCQkJCWlmIChldmVudC5fY2xhc3NOYW1lX3NldCkgZXYuY2xhc3NOYW1lKGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCWlmIChldmVudC5fY2Fycmllcl9zZXQgfHwgZXZlbnQuX3NlbmRlcl9zZXQpIGV2LmNhcnJpZXIoZXZlbnQuY2FycmllcigpIHx8IGV2ZW50LnNlbmRlcigpKTsKCQkJfQoJCQlyZXQgPSBhd2FpdCBldi50cmlnZ2VyKCk7CgoJCQlpZiAodHlwZW9mKHJldCkgPT09ICJzdHJpbmciKSB7CgkJCQl0cnkgewoJCQkJCXJldCA9IEpTT04ucGFyc2UocmV0KTsKCQkJCX0gY2F0Y2ggKGV4KSB7fQoJCQl9CgkJCXJldHVybiByZXQ7CgoJCX0KCgkJaWYgKCFyZXQpIHJldHVybiBudWxsOwoJCXJldCA9IHJldC5kYXRhIHx8IHJldDsKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiByZXQuX19mbGF0dGVkKSByZXQgPSBGbGF0dGVkLnBhcnNlKHJldC5fX2ZsYXR0ZWQpOwoKCQlpZiAocmV0Ll9fZXhjZXB0aW9uKSB7CgkJCS8vIGFuIGV4Y2VwdGlvbiBvY2N1cnJlZCBhdCB0aGUgc2VydmVyCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGBFeGNlcHRpb24gYXQgJHtuLl9hZGRyZXNzfWAsIHJldC5fX2V4Y2VwdGlvbik7CgkJCXJldHVybiByZXQ7CgkJfQoKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiaW5zZXJ0IjoKCQkJY2FzZSAidXBkYXRlIjoKCQkJY2FzZSAic3RvcmUiOgoJCQljYXNlICJkZWxldGUiOgoJCQljYXNlICJmaW5kIjogewoJCQkJaWYgKCFiUmF3KSByZXQgPSBuZXcgc2FsZXNub3cuTm9kZV9Hcm91cChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuTm9kZV9Hcm91cChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocCkpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHt9CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIF9pbnZva2UobWV0aG9kLCBib2R5LCBxdWVyeSwgYXV0aE9iaikgewoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgbWV0aG9kLCBxdWVyeSwgYm9keSk7CgoJCWlmICh0eXBlb2YoYm9keSkgPT09ICdzdHJpbmcnIHx8ICh0eXBlb2YoQnVmZmVyKSAhPT0gJ3VuZGVmaW5lZCcgJiYgQnVmZmVyLmlzQnVmZmVyKGJvZHkpKSkgewoJCQl0cnkgewoJCQkJYm9keSA9IEpTT04ucGFyc2UoYm9keS50b1N0cmluZygpKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIkJvZHkgaXMgbm90IGEgdmFsaWQgSlNPTiIsIGJvZHkpOwoJCQkJcmV0dXJuOwoJCQl9CgkJfQoKCQlsZXQgX3BhcmFtcyA9IHF1ZXJ5ID8gT2JqZWN0LmFzc2lnbihxdWVyeSwgYm9keSkgOiBib2R5OwoJCWlmICh0eXBlb2YoX3BhcmFtcykgPT09ICdzdHJpbmcnKSBfcGFyYW1zID0gSlNPTi5wYXJzZShfcGFyYW1zKTsKCgkJaWYgKF9wYXJhbXMpIHsKCQkJX3BhcmFtcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcyk7CgkJfSBlbHNlIHsKCQkJX3BhcmFtcyA9IHt9OwoJCX0KCgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgX3BhcmFtcy5fX2ZsYXR0ZWQpIF9wYXJhbXMgPSBGbGF0dGVkLnBhcnNlKF9wYXJhbXMuX19mbGF0dGVkKTsKCgkJaWYgKF9wYXJhbXMuX19ub2RlKSB7CgkJCS8vIHByb2JhYmx5IHNob3VsZCBub3QgYmUgcHJvY2Vzc2VkIGhlcmUsIGJ1dCByYXRoZXIgY29uc3VtZWQgYXMgcGFydCBvZiB0aGUgZXhlY3V0ZSgpIGxvZ2ljLCBwdXNoaW5nIF9fbm9kZSB0byB0aGUgbGlzdCBvZiBteSBub2RlcyB0byBkZWxlZ2F0ZSB0byE/CgkJCWxldCB0biA9IG5ldyBzYWxlc25vdy5Ob2RlKCkuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fbm9kZSkuX2RlUmVmZXJlbmNlKCk7CgkJCWRlbGV0ZSBfcGFyYW1zLl9fbm9kZTsKCQkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Ob2RlX0dyb3VwKCkuX2ludm9rZU5vZGUodG4sIG1ldGhvZCwgX3BhcmFtcyk7CgkJfQoKCQlpZiAoX3BhcmFtcy5fX3RoaXMpIHsKCQkJX3BhcmFtcy5fX3RoaXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMuX190aGlzKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KF9wYXJhbXMuX190aGlzKS5fZGVSZWZlcmVuY2UoKTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIl9wYXJhbXMiLCBfcGFyYW1zKTsKCgkJbGV0IGFyQXJncyA9IFtdOwoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLm9ianMpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5zdGFydCk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmVuZCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kIjogewoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5kZXB0aCk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDogewoJCQkJYnJlYWs7CgkJCX0KCQl9CgoJCWxldCBvYmogPSB0aGlzOwoKCQlsZXQgcmV0ID0gbnVsbDsKCQlpZiAoIW9iaikgewoJCQlyZXQgPSB7CgkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCSctMSc6IGBOb2RlX0dyb3VwLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgTm9kZV9Hcm91cC5faW52b2tlOiBtZXRob2QgJHtvYmouY29uc3RydWN0b3IubmFtZX0oJHttZXRob2R9KSBpcyBub3QgZm91bmRgLAoJCQkJCSdvYmonOiBvYmoKCQkJCX0KCQkJfTsKCQl9IGVsc2UgewoJCQlyZXQgPSBhd2FpdCBvYmpbbWV0aG9kXSguLi5hckFyZ3MpOwoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJaWYgKGZhbHNlICYmIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24gJiYgIXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQlyZXQgPSB7CgkJCQkJX19leGNlcHRpb246IHsKCQkJCQkJJy00JzogIlVuY29tbWl0dGVkIHRyYW5zYWN0aW9uczogIiArIHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uc3Fscy5sZW5ndGgsCgkJCQkJCSdvYmonOiBvYmoKCQkJCQl9CgkJCQl9CgkJCX0KCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQl9CgoJCWlmIChyZXQgJiYgIXJldC5fX2V4Y2VwdGlvbikgewoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0ge307CgkJCWlmIChBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCXJldCA9IHJldC5tYXAociA9PiB7CgkJCQkJaWYgKHIgJiYgci5fdG9Eb2N1bWVudCkgewoJCQkJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwLl90b0RvY3VtZW50OwoJCQkJCQlyZXR1cm4gci5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSk7CgkJCQkJfSBlbHNlIHJldHVybiByOwoJCQkJfSk7CgkJCX0gZWxzZSB7CgkJCQlyZXQgPSAocmV0ICYmIHJldC5fdG9Eb2N1bWVudCkgPyByZXQuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpIDogcmV0OwoJCQl9CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIGAke21ldGhvZH06ICR7dGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGVfR3JvdXAuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglfcGFyc2VDb2RlU3RhdGUodCkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyc2VDb2RlU3RhdGUodCk7CgoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiTm9kZSBHcm91cCIpOwoKCX0KCglfcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCA9ICd7eycsIHBvc3RmaXggPSAnfX0nKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4LCBwb3N0Zml4KTsKCgl9CgoJX19zeW5jX29uKGQpIHsKCQl0aGlzLl9fX3N5bmNfb24gPSB0aGlzLl9fX3N5bmNfb24gfHwge307CgoJCWlmIChkKSB7CgkJCXRoaXMuX19fc3luY19vblt0aGlzLlRvb2wubmFtZV0gPSBkOwoKCQkJLy8gdGhpcy5ncm91cF9Ob2RlX0dyb3VwcygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93Lk5vZGVfR3JvdXAodGhpcy5JZCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkuZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzKHRoaXMuZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzKCksIHRoaXMuX2dyb3VwX05vZGVfR3JvdXBfTWVtYmVyc19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSkgewoJCWNvbnRleHQgPSBjb250ZXh0IHx8ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCS8vb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCS8vb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ05vZGVfR3JvdXAnOwoJCXRvb2wgPSB0b29sIHx8IHRoaXMuVG9vbDsKCQljb2RlVHlwZSA9IGNvZGVUeXBlIHx8IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGUzMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KVtjb2RlXTsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX21hcChjb2RlLCBiUmV2ZXJzZSwgY29udGV4dCwgb2JqRnJvbSwgb2JqVG8sIGNsYXNzTmFtZSwgdG9vbCwgY29kZVR5cGUpOwoKCX0KCglfbkNvZGUoY29kZSwgb0NvZGUpIHsKCQl0cnkgewoJCQlsZXQgY29udGV4dCA9ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCQlpZiAoIWNvZGUgJiYgIW9Db2RlKSB7CgkJCQljb250ZXh0ID0gJ0VudGl0eUNsYXNzJzsKCQkJCWNvZGUgPSAiTm9kZV9Hcm91cCI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMgPSB7fSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX2NvbmZpZyhuLCBudWxsVmFsdWUsIE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMgfHwge30sIHsKCQkJX2NsYXNzOiAnTm9kZV9Hcm91cCcKCQl9KSk7CgoJfQoKCWFzeW5jIF9yZXN0KHROYW1lID0gdGhpcy5fbkNvZGUoKSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMgPSB7fSkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIodW5kZWZpbmVkLCB0aGlzLlRvb2wpLl9yZXN0KHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zKTsKCgl9CgoJX3RvU1FMVGFibGUoKSB7CgkJbGV0IHJldCA9IHsKCQkJc3FsOiBgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoCiAgICAgICAgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVkKICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgYAoJCX07CgkJcmV0LnNxbCArPSAnLypOb2RlX0dyb3VwKi8pO1xuJzsKCgkJcmV0ID0gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogdHJ1ZSwKCQkJTnVsbDogdHJ1ZSwKCQkJLy9JZDogKG9iaiwgdikgPT4gb2JqLnNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVlgLAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCWdyb3VwX05vZGVfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwX05vZGVfR3JvdXBzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnNxbCA9IHYubWFwKF92ID0+IF92Ll90b1NRTFRhYmxlKCkpICsgb2JqLnNxbCwKCgkJfSwgIl90b1NRTFRhYmxlIik7CgoJCS8vIHJldC5zcWwgKz0gJy8qTm9kZV9Hcm91cCovKTtcbic7CgoJCXJldC5zcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHJldC5zcWwpIDogcmV0LnNxbDsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU1FMVGFibGUnLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0LnNxbCk7CgkJcmV0dXJuIHJldC5zcWw7Cgl9CgoJX2Zyb21TUUxUYWJsZSh0YWJsZSwgZmllbGRzKSB7CgkJLy8gdGFibGUgaXMgYSBqc29uIGFycmF5CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbChzcWwsIHRoaXMpOwoKCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIGJTdHJpbmcpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7CgkJCVt0aGlzLl9uQ29kZSgpXTogewoJCQkJcGFyYW1zOiB7CgkJCQkJd2hlcmU6IHsKCQkJCQkJYW5kOiBbXSwKCQkJCQkJb3I6IFtdCgkJCQkJfQoJCQkJfSwKCQkJCWVkZ2VzOiB7CgkJCQkJbm9kZToge30KCQkJCX0KCQkJfQoJCX0sIHsKCQkJLy9PUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKHsKCQkJCUlkOiB7CgkJCQkJZXE6IHYKCQkJCX0KCQkJfSksCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCSh2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbCkKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQl9LCAiX3RvU0ZRdWVyeSIpOwoKCQkvL09iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlpZiAoYlN0cmluZykgewoJCQlyZXQgPSB7CgkJCQlxdWVyeTogewoJCQkJCVt0aGlzLl9uQ29kZSgpICsgJ1F1ZXJ5J106IHsKCQkJCQkJdWlhcGk6IHJldAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJcmV0ID0gSlNPTi5zdHJpbmdpZnkocmV0LCBudWxsLCA0KTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NGUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqLnN5c19pZCA9IHYsCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJZGF0ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJbGV0IGQgPSBgJHt2LmdldEZ1bGxZZWFyKCl9LSR7KCcwJysodi5nZXRNb250aCgpKzEpKS5zbGljZSgtMil9LSR7di5nZXREYXRlKCl9YDsKCQkJCWxldCB0ID0gYCR7di5nZXRIb3VycygpfToke3YuZ2V0TWludXRlcygpfToke3YuZ2V0U2Vjb25kcygpfWA7CgkJCQlpZiAoKHYuZ2V0SG91cnMoKSA9PSAwICYmIHYuZ2V0TWludXRlcygpID09IDAgJiYgdi5nZXRTZWNvbmRzKCkgPT0gMCkgfHwgdGhpcy5fZGF0ZV9jb29wID09ICc9JyB8fCAhdGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgT04ke2R9QGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9Jywnc3RhcnQnKUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ2VuZCcpYDsKCQkJCX0gZWxzZSBpZiAodGhpcy5fZGF0ZV9jb29wICE9PSAnQkVUV0VFTicpIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmpbZWFDb2RlXSA9IGBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsICcke3R9JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0KCgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCX0sICJfdG9TTlF1ZXJ5Iik7CgoJCU9iamVjdC5rZXlzKHJldC5PUEVSQVRPUlMgfHwge30pLmZpbHRlcihrID0+IHR5cGVvZihyZXRba10pICE9PSAndW5kZWZpbmVkJykuZm9yRWFjaChrID0+IHJldFtrXSA9IHJldC5PUEVSQVRPUlNba10gKyByZXRba10pOwoKCQlkZWxldGUgcmV0Lk9QRVJBVE9SUzsKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFTdHJpbmcocmV0W2tdKS5sZW5ndGgpLmZvckVhY2goayA9PiBkZWxldGUgcmV0W2tdKTsKCgkJcmV0ID0gRG90T2JqZWN0LmRvdChyZXQpOwoKCQkvLyBhdm9pZCBzZW5kaW5nIHdpdGggbm8gY29tcGFyaXNvbiBvcGVyYXRvcnMKCQlPYmplY3Qua2V5cyhyZXQpLmZpbHRlcihrID0+ICFbJz4nLCAnPCcsICdCRVRXRUVOJywgJ09OJywgJyEnLCAnPScsICdTVEFSVFNXSVRIJywgJ0xJS0UnXS5zb21lKHMgPT4gU3RyaW5nKHJldFtrXSkuc3RhcnRzV2l0aChzKSkpLmZvckVhY2goayA9PiByZXRba10gPSAodGhpc1tgXyR7a31fY29vcGBdIHx8ICdTVEFSVFNXSVRIJykgKyByZXRba10pOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIE9iamVjdC5lbnRyaWVzKHJldCB8fCB7fSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX19leHBvcnQob2JqLCBvcHRpb25zLCBmdW4sIC4uLmZBcmdzKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaiwgZWFPYmopID0+IHsKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJCWlmICh0eXBlb2Yob3B0aW9uc1tmaWVsZF0pICE9PSAiZnVuY3Rpb24iKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7ZnVufS5vcHRpb25zLiR7ZmllbGR9IGlzIG5vdCBhIGZ1bmN0aW9uYCk7CgkJCQkJcmV0dXJuOwoJCQkJfQoJCQkJaWYgKCFvcHRpb25zLk51bGwpIHsKCQkJCQlpZiAoZmllbGQgIT0gJ0lkJyAmJiAhdGhpc1snXycgKyBmaWVsZCArICdfc2V0J10pIHJldHVybjsKCQkJCQlpZiAoQXJyYXkuaXNBcnJheShlYU9iaikgJiYgdHlwZW9mKGVhT2JqLmxlbmd0aCkgIT09ICd1bmRlZmluZWQnICYmICFlYU9iai5sZW5ndGgpIHJldHVybjsKCQkJCX0KCQkJCWlmIChvcHRpb25zLk9QRVJBVE9SUyAmJiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10pIG9iai5PUEVSQVRPUlMgPSBPYmplY3QuYXNzaWduKG9iai5PUEVSQVRPUlMgfHwge30sIHsKCQkJCQlbZmllbGRdOiB0aGlzWydfJyArIGZpZWxkICsgJ19jb29wJ10KCQkJCX0pOwoKCQkJCWxldCBfcmV0ID0gb3B0aW9uc1tmaWVsZF0ob2JqLCBlYU9iaik7CgoJCQkJaWYgKG9wdGlvbnMuX21hcCkgdGhpcy5fbWFwKGZpZWxkLCBmYWxzZSwgZnVuLCBlYU9iaiwgb2JqKTsKCQkJCXJldHVybiBfcmV0OwoJCQl9IGNhdGNoIChleCkgewoJCQkJaWYgKCFleC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cuX19leHBvcnRBYm9ydCA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgaW4gJHtmdW59Ll9vcHRpb25zLiR7ZmllbGR9OiAke2V4fWAsIGV4KTsKCQkJfQoJCX07CgoJCWlmIChvcHRpb25zLkZ1bGwgfHwgdGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpIF9vcHRpb25zKCJJZCIsIG9iaiwgdGhpcy5JZCk7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmosIHRoaXMuYWN0aXZlKCkpOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaiwgdGhpcy5lbmFibGVkKCkpOwoKCQlfb3B0aW9ucygiY29kZSIsIG9iaiwgdGhpcy5jb2RlKCkpOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmosIHRoaXMub3JkZXIoKSk7CgoJCV9vcHRpb25zKCJkYXRlIiwgb2JqLCB0aGlzLmRhdGUoKSk7CgoJCV9vcHRpb25zKCJuYW1lIiwgb2JqLCB0aGlzLm5hbWUoKSk7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmosIHRoaXMucmVtYXJrKCkpOwoKCQlsZXQgdiA9IHVuZGVmaW5lZDsKCQl0cnkgewoJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQlpZiAoc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke2Z1bn1gKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCWxldCBfaWQgPSBudWxsOwoJCQlpZiAodHlwZW9mKG9iaikgPT09ICd1bmRlZmluZWQnKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBvYmosIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIG9iajsKCQkJfSBlbHNlIGlmICh0eXBlb2Yob2JqKSA9PT0gJ3N0cmluZycpIHsKCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUob2JqKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IG9iai5faWQgfHwgb2JqLmlkIHx8IG9iai5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAob2JqLklkICYmIG9iai5JZCA9PSBvYmouSWQpIHsKCQkJCQlfaWQgPSBvYmouSWQ7CgkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQl9IGVsc2UgaWYgKG9iai5FbnRpdHlDbGFzcykgewoJCQkJCV9pZCA9IG9iai5FbnRpdHlDbGFzcy5JZCB8fCBvYmouRW50aXR5Q2xhc3MuTmFtZTsKCQkJCX0gZWxzZSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCAiMzUwODc0YjAtNzVmMi00ZTY2LWFlNGItYWZjMzEyMWYyZWI2IiB8fCAiTlVMTCI7CgkJCQl9CgkJCX0KCgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSBzYWxlc25vdy5fdW5SZWN1cnNlIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXAgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXAgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cFtmdW5dID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cFtmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBbZnVuXVtfaWRdIHx8IHt9OwoKCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKGZBcmdzLCB7CgkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQljYWNoZTogKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IFtdIDogdW5kZWZpbmVkCgkJCX0pOwoKCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cFtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cFtmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlfb3B0aW9ucygiZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzIiwgb2JqLCB0aGlzLmdyb3VwX05vZGVfR3JvdXBfTWVtYmVycygpKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ2dyb3VwX05vZGVfR3JvdXBfTWVtYmVycyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgdHJ1ZSwgZnVuLCBvYmosIG9iaik7CgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjM1MDg3NGIwLTc1ZjItNGU2Ni1hZTRiLWFmYzMxMjFmMmViNiIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cFtmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ2dyb3VwX05vZGVfR3JvdXBfTWVtYmVycyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaikpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9EQk9iamVjdChmaWVsZHMsIGJOb1JlZikgewoJCWlmICghdGhpcy5JZCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCAiSW52YWxpZCBJRCIsIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSwgdGhpcy5Ub29sKTsKCQl9CgkJbGV0IHJldCA9IHsKCQkJW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXTogIiciICsgdGhpcy5JZCArICInIgoJCX07CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2FjdGl2ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hY3RpdmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9lbmFibGVkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY29kZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jb2RlKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fb3JkZXJfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMub3JkZXIoKTsKCgkJCWZWYWx1ZSA9IHYgfHwgJzAnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZGF0ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5kYXRlKCk7CgoJCQl0cnkgewoJCQkJZlZhbHVlID0gIiciICsgKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiAiMTk3MC0xLTEiKSArICInIjsKCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJykgewoJCQkJCWZWYWx1ZSA9IGBTVFJfVE9fREFURSgke2ZWYWx1ZX0sICclWS0lbS0lZFQlVC4lZlonKWA7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9ICdkYXRldGltZSgnICsgZlZhbHVlICsgJyknOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9uYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm5hbWUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcmVtYXJrX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnJlbWFyaygpOwoKCQkJZlZhbHVlID0gIiciICsgKCh2ICYmIHYucmVwbGFjZSkgPyB2LnJlcGxhY2UoL1wnL2csICJcJ1wnIikgOiB2KSArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmIChbJ1NhbGVzRm9yY2UnXS5pbmRleE9mKHRoaXMuVG9vbC50eXBlLm5hbWUpID09IDApIHsKCQkJX28gPSBfcSA9ICIiOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXRoaXMuX19RID0gdGhpcy5fX1EgPT0gX28gPyBfcSA6IF9vOwoJCXJldHVybiB0aGlzLl9fUTsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKV07CgkJZmllbGRzID0gQXJyYXkuaXNBcnJheShmaWVsZHMpID8gZmllbGRzIDogW2ZpZWxkc107CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJLy8ge2ZpZWxkOiBvcmRlcn0KCQkJZmllbGRzID0gW107CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9YCk7CgoJCX0KCQlyZXR1cm4gZmllbGRzOwoJfQoKCV9mcm9tREJPYmplY3QociA9IHt9KSB7CgkJdHJ5IHsKCQkJcmV0dXJuIHRoaXMuX19pbXBvcnQociwgewoJCQkJSWQ6IG9iaiA9PiB0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSwKCgkJCQlhY3RpdmU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5hY3RpdmUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmVuYWJsZWQob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmNvZGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3JkZXIob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlkYXRlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmRhdGUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm5hbWUob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5yZW1hcmsob2JqW2VhQ29kZV0pOwoJCQkJfSwKCgkJCX0sICJfZnJvbURCT2JqZWN0Iik7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV90b1NlbGVjdEhlYWRlcihmaWVsZHMpIHsKCQlsZXQgcmV0ID0gewoJCQl0YWJsZTogdGhpcy5fbkNvZGUoKSwKCQkJZmllbGRzOiBEb3RPYmplY3Qub2JqZWN0KE9iamVjdC5mcm9tRW50cmllcyh0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5tYXAoZiA9PiBbZiwgZl0pKSksCgkJCWpvaW5zOiB7fSwKCQl9OwoKCQlpZiAoZmllbGRzKSByZXR1cm4gcmV0OwoKCQlyZXQuam9pbnMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCU51bGw6IHRydWUsCgoJCX0sICJfdG9TZWxlY3RIZWFkZXIiKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0SGVhZGVyJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvU2VsZWN0U1FMKGZpZWxkcykgewoJCWxldCBzcWwgPSAic2VsZWN0ICI7CgoJCWxldCB0UHJlZiA9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9YDsKCgkJbGV0IGhlYWRlciA9IHRoaXMuX3RvU2VsZWN0SGVhZGVyKGZpZWxkcyk7CgoJCXNxbCArPSBPYmplY3QudmFsdWVzKGhlYWRlci5maWVsZHMpLm1hcChmID0+IGAke3RQcmVmfS4ke2Z9YCkuam9pbignLCAnKTsKCQlPYmplY3Qua2V5cyhoZWFkZXIuam9pbnMpLmZvckVhY2goayA9PiBzcWwgKz0gIiwgIiArIE9iamVjdC52YWx1ZXMoaGVhZGVyLmpvaW5zW2tdLmZpZWxkcykubWFwKGYgPT4gYCR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9LiR7Zn0gYXMgJHt0aGlzLl9RKCl9JHtrfS4ke2YucmVwbGFjZSh0aGlzLl9RKCksICcnKX1gKS5qb2luKCcsICcpKTsKCgkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMpIHsKCQkJLy8ge2ZpZWxkOiBmdW5jdGlvbn0KCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJfQoKCQlzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7CgoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCk7CgoJCXNxbCArPSBgIHdoZXJlIDE9MWA7CgoJCXNxbCA9IHRoaXMuX19leHBvcnQoewoJCQlzcWw6IHNxbAoJCX0sIHsKCQkJX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSA/IFsnSWQnXSA6IHVuZGVmaW5lZCwKCQkJTnVsbDogdHJ1ZSwKCQkJX1RISVM6IG9iaiA9PiB7CgkJCQlpZiAoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKHQuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOwoJCQl9LAoJCQlJZDogb2JqID0+IG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jb2RlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fY29kZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX29yZGVyX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fb3JkZXJfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fZGF0ZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi50b0lTT1N0cmluZykgewoJCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbGl0ZScpIHsKCQkJCQkJb2JqLnNxbCArPSAic3RyZnRpbWUoJyVzJywgJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJykiOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9iai5zcWwgKz0gIiciICsgdi50b0lTT1N0cmluZygpICsgIiciOwoJCQkJCX0KCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9uYW1lX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9yZW1hcmtfc2V0KSByZXR1cm47CgoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWdyb3VwX05vZGVfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwX05vZGVfR3JvdXBzJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJncm91cC5pZCIpKTsKCgkJCQlsZXQgak9QID0gJ1VOSU9OIEFMTCc7CgkJCQlsZXQgaW5PUCA9ICdJTic7CgoJCQkJb2JqLnNxbCArPSBgYDsKCgkJCQlpZiAodGhpcy5fZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl9ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnNfY29vcCA9PSAnTk9UIElOJykgewoJCQkJCWluT1AgPSAnTk9UIElOJzsKCQkJCX0gZWxzZSBpZiAodGhpcy5fZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzX2Nvb3AgPT0gJz0nIHx8IHRoaXMuX2dyb3VwX05vZGVfR3JvdXBfTWVtYmVyc19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX2dyb3VwX05vZGVfR3JvdXBfTWVtYmVyc19jb29wID09ICc9PScpIHsKCQkJCQlqT1AgPSAnSU5URVJTRUNUJzsKCQkJCX0KCgkJCQlvYmouc3FsICs9IGBhbmQgLypncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMqLyAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSAke2luT1B9IChgICsgc3F1ZXJpZXMuam9pbihgICR7ak9QfS8qTTJNKi8gYCkgKyAnKSc7CgkJCX0sCgoJCX0sICJfdG9TZWxlY3RTUUwiLCBmaWVsZHMpLnNxbDsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQlpZiAoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5jb2RlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMub3JkZXJ9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZGF0ZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZGF0ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5uYW1lKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5uYW1lfWA7CgoJCX0KCgkJaWYgKHNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpIHsKCQkJLy8gc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSIsICJ3aGVyZSAxPTAiKTsKCQl9IGVsc2UgewoJCQlzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7CgkJfQoKCQlzcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCkgOiBzcWw7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgoJCXJldHVybiBzcWw7Cgl9CgoJX3RvUGF0aHMoKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJX1RISVM6IG9iaiA9PiB7fSwKCgkJCWdyb3VwX05vZGVfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwX05vZGVfR3JvdXBzJywgdW5kZWZpbmVkKSkgPT4gb2JqLmdyb3VwX05vZGVfR3JvdXBfTWVtYmVycyA9IHYubWFwKF92ID0+IF92Ll90b1BhdGhzKCkpLAoKCQl9LCAiX3RvUGF0aHMiKTsKCQkvLyByZXR1cm4gcmV0OwoJCXJldHVybiBPYmplY3Qua2V5cyhyZXQpLm1hcChrID0+ICh7CgkJCVtrXTogcmV0W2tdCgkJfSkpOwoJfQoKCV90b1VwZGF0ZVNRTChmaWVsZHMpIHsKCQlsZXQgcmV0RmllbGRzID0gdGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkuam9pbignLCAnKTsKCQlsZXQgc3FsID0gYHVwZGF0ZSAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IHNldCBgICsgT2JqZWN0LmVudHJpZXModGhpcy5fdG9EQk9iamVjdChmaWVsZHMpKS5tYXAodiA9PiB0aGlzLl9RKCkgKyB2WzBdICsgdGhpcy5fUSgpICsgIj0iICsgdlsxXSkgKyBgIHdoZXJlICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2A7IC8vYCByZXR1cm5pbmcgJHtyZXRGaWVsZHN9YDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9VcGRhdGVTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV90b0luc2VydFNRTChmaWVsZHMpIHsKCQlsZXQgb2JqID0gdGhpcy5fdG9EQk9iamVjdChmaWVsZHMpOwoJCWxldCBzcWwgPSBgaW5zZXJ0IGludG8gJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoYCArIE9iamVjdC5rZXlzKG9iaikubWFwKGsgPT4gdGhpcy5fUSgpICsgayArIHRoaXMuX1EoKSkgKyAiKSB2YWx1ZXMgKCIgKyBPYmplY3QudmFsdWVzKG9iaikgKyBgKWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvSW5zZXJ0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLk5vZGVfR3JvdXApIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTm9kZV9Hcm91cCA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCBzcWwgPSBuZXcgc2FsZXNub3cuTm9kZV9Hcm91cCgpCgoJCQkJCS5ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMobmV3IHNhbGVzbm93Lk5vZGVfR3JvdXBfTWVtYmVyKCkpCgoJCQkJCS5fdG9TUUxUYWJsZShkZXB0aCk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiTm9kZSBHcm91cCIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmdyb3VwX05vZGVfR3JvdXBfTWVtYmVycyA9IHYubWFwKF92ID0+IHF1ZXJ5Lmdyb3VwX05vZGVfR3JvdXBfTWVtYmVycygpLmFueShxID0+IF92Ll9tYXRjaGVzKHEpKSk7CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGVzIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAwLCBvTWF0Y2gpOwoKCQkJcmV0dXJuIE9iamVjdC5rZXlzKG9NYXRjaCkuZXZlcnkoayA9PiBvTWF0Y2hba10pOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX21hdGNoaW5nKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJbGV0IHJldCA9IFtdOwoKCQkJbGV0IG1hdGNoZXMgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgoJCQkJZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2KSA9PiB7CgkJCQkJb2JqLmdyb3VwX05vZGVfR3JvdXBfTWVtYmVycyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fYWN0aXZlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcmRlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9kYXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX25hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcmVtYXJrX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlncm91cF9Ob2RlX0dyb3VwX01lbWJlcnM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy5ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMoKVtpXSA9IHJldDsKCQkJCQl9KTsKCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2FjdGl2ZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuYWN0aXZlKHJlZik7CgoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fZW5hYmxlZF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuZW5hYmxlZChyZWYpOwoKCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvZGUocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9kYXRlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoJCQkJCWlmICh0eXBlb2YobW9tZW50KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuVG9vbC5zeXNfcHJvcGVydGllcykgIT09ICJ1bmRlZmluZWQiKSB7CgkJCQkJCXJlZiA9IG1vbWVudC5wYXJzZVpvbmUocmVmLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kYXRlX2Zvcm1hdCJdICsgIiAiICsgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMudGltZV9mb3JtYXQiXSwgdGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzWyJnbGlkZS5zeXMuZGVmYXVsdC50eiJdKS50b0RhdGUoKTsKCQkJCQl9IGVsc2UgewoJCQkJCQlyZWYgPSBuZXcgRGF0ZShyZWYpOwoJCQkJCX0KCQkJCX0gZWxzZSB7CgkJCQkJcmVmID0gbmV3IERhdGUoRGF0ZS5wYXJzZShyZWYgKyAiIEdNVCIpKTsKCQkJCX0KCQkJCXRoaXMuZGF0ZShyZWYpOwoKCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm5hbWUocmVmKTsKCgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9yZW1hcmtfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnJlbWFyayhyZWYpOwoKCQkJfSwKCgkJCWdyb3VwX05vZGVfR3JvdXBfTWVtYmVyczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2dyb3VwX05vZGVfR3JvdXBzJywgdW5kZWZpbmVkKSA6ICJncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMiKSkgPT4gdGhpcy5ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93Lk5vZGVfR3JvdXBfTWVtYmVyKCkuX2Zyb21Eb2N1bWVudChfdiwgYlRvb2wpKSA6IHVuZGVmaW5lZCwgb2JqLk9QRVJBVE9SUyA/IG9iai5PUEVSQVRPUlNbZWFDb2RlXSA6IHVuZGVmaW5lZCksCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0gPSB2LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSA6ICJjb2RlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2NvZGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NvZGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgOiAib3JkZXIiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fb3JkZXJfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2LnRvSVNPU3RyaW5nKCkgOiBudWxsOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSBvYmpbZWFDb2RlXSA9IG9ialtlYUNvZGVdLnJlcGxhY2UoL1wuWzAtOV0qWi9nLCAnJyk7CgoJCQkJaWYgKHRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2RhdGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fbmFtZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fbmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpIDogInJlbWFyayIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9yZW1hcmtfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3JlbWFya19jb29wOwoJCQkJfQoJCQl9LAoKCQkJZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXBfTm9kZV9Hcm91cHMnLCB1bmRlZmluZWQpIDogImdyb3VwX05vZGVfR3JvdXBfTWVtYmVycyIpKSA9PiB7CgkJCQlvYmpbZWFDb2RlXSA9IHYubWFwKF92ID0+IF92Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCWlmICh0aGlzLl9ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2dyb3VwX05vZGVfR3JvdXBfTWVtYmVyc19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9mbGlwKCkgKi8KCV9mbGlwKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fZmxpcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9mbGlwKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2ZsaXAoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSB0cnVlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZV9Hcm91cC5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuTm9kZV9Hcm91cChudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMubmFtZSh0aGlzLm5hbWUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX19hc3NlcnRWYWxpZCh0cnVlKSkgcmV0dXJuIG51bGw7CgoJCQkJLy9hd2FpdCB0aGlzLl9zdG9yZUVudGl0eUNsYXNzKCk7IC8vIGluIGNhc2UgVG9vbCBjaGFuZ2VzCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEFib3V0IHRvIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfWApOwoJCQkJaWYgKGJVcGRhdGUpIGF3YWl0IHRoaXMudXBkYXRlKCk7CgkJCQlpZiAoYkluc2VydCkgYXdhaXQgdGhpcy5pbnNlcnQoKTsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgYEZpbmlzaGVkIEluc2VydDoke2JJbnNlcnR9LCBVcGRhdGU6JHtiVXBkYXRlfSBJZD1bJHt0aGlzLklkfV1gKTsKCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY1R5cGVkQXR0cmlidXRlcyIpKSB7CgoJCQkJCWlmICh0aGlzLl9ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnNfc2V0KSB7CgkJCQkJCWZvciBhd2FpdCAoY29uc3QgdGEgb2YgdGhpcy5ncm91cF9Ob2RlX0dyb3VwX01lbWJlcnMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCQlpZiAoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5Pd25lciA9PSB0aGlzKSB7CgkJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYENPTU1JVCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nIFRSQU5TQUNUSU9OJzonJ31gKTsKCQkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kID0gbmV3IERhdGUoKTsKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZV9Hcm91cC5pbnNlcnQnKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvSW5zZXJ0U1FMKCkpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnaW5zZXJ0JywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJdGhpcy5fZnJvbURvY3VtZW50KGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJbGV0IG9iaiA9IHt9OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfc2V0KSB7CgoJCQkJCW9iai5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9zZXQpIHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2NvZGVfc2V0KSB7CgoJCQkJCW9iai5jb2RlID0gdGhpcy5jb2RlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9vcmRlcl9zZXQpIHsKCgkJCQkJb2JqLm9yZGVyID0gdGhpcy5vcmRlcigpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZGF0ZV9zZXQpIHsKCgkJCQkJb2JqLmRhdGUgPSB0aGlzLmRhdGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX25hbWVfc2V0KSB7CgoJCQkJCW9iai5uYW1lID0gdGhpcy5uYW1lKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9yZW1hcmtfc2V0KSB7CgoJCQkJCW9iai5yZW1hcmsgPSB0aGlzLnJlbWFyaygpOwoKCQkJCX0KCgkJCQlsb2coIlNlbmRpbmcgdG8gU0YiLCBvYmopOwoKCQkJCWxldCByZXMgPSBhd2FpdCB0aGlzLlRvb2wuZGIuc29iamVjdCgiTm9kZV9Hcm91cCIpLmNyZWF0ZShvYmopOwoJCQkJdGhpcy5JZCA9IHJlcy5pZDsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGVfR3JvdXAudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlX0dyb3VwLmZpbmRBbGwnKTsKCgkJCS8vIGF2b2lkcyBjeWNsaWMgcXVlcmllcwoJCQlvYmpzID0gKG9ianMgfHwgW10pLm1hcChvID0+IG8uX2Nsb25lKCkpOwoKCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLz8/CgoJCQlsZXQgcmV0ID0gW107IC8vIGEganNvbiBhcnJheQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTChmaWVsZHMsIG9ianMpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgewoJCQkJCXN5c3Bhcm1fcXVlcnk6IE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvU05RdWVyeShmaWVsZHMsIG9ianMpKS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCB0cnVlKSwgbnVsbCwgewoJCQkJCXVybDogJ3Jlc3QudXJsLmdxbCcKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2ApOwoJCQkJcmV0ID0gcmV0LmNvbnRlbnQgPyBbSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSldIDogW107CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5tYXAociA9PiBuZXcgc2FsZXNub3cuTm9kZV9Hcm91cChudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCnNhbGVzbm93Lk5vZGVfR3JvdXBfTWVtYmVyID0gY2xhc3MgTm9kZV9Hcm91cF9NZW1iZXIgZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRc0tpNWZjbVZ6ZEN3cUxsOXNiMkZrVkc5dmJITWlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpPYjJSbElqcDdJbTV2UkdWMFpXTjBJanAwY25WbExDSnBibWwwTG1WdVpITWlPaklzSW1sdWFYUXViRzl2Y0NJNk1DNDFMQ0owYjI5c2N5NXpkRzl5WlNJNlptRnNjMlVzSW1SbGRHVmpkRkJoY21WdWRDNUpVQ0k2SWpFNE1pNHhOamd1TnpBdU9ESWlMQ0prWlhSbFkzUlFZWEpsYm5RdVkyOWtaU0k2SW1VNFpHVXdObVV6WldSak5EUXpZV1U1WkdabE1XUmxOV1ZqTlRKaE5HSm1JaXdpYzJWamNtVjBJam9pYjFOTGQyZGFNbk5MUms5VVNVcGpZa0ZtVlVsUk5FTnFPWEZ6U0RRNGJtd2lMQ0p3YkdGNVozSnZkVzVrSWpwMGNuVmxMQ0puVWxCRElqcDBjblZsTENKemRHOXlaUzV6Wlc1emFYUnBkbWwwZVNJNk1Td2lZMjl0Y0dGdWVTSTZJbkpsYzNWdFpTSjlMQ0pGZG1WdWRDSTZleUowY21sbloyVnlMblJwYldWdmRYUWlPakV3TURBd0xDSnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wc0lsUnZiMndpT25zaVoybDBhSFZpTG5SdmIyeHpJam9pYUhSMGNITTZMeTl5WVhjdVoybDBhSFZpZFhObGNtTnZiblJsYm5RdVkyOXRMMlpoWkdsdUwyWmhaR2x1TG1kcGRHaDFZaTVwYnk5dFlYTjBaWEl2SWl3aWMyVmpjbVYwSWpvaWIxTkxkMmRhTW5OTFJrOVVTVXBqWWtGbVZVbFJORU5xT1hGelNEUTRibXdpTENKd2JHRjVaM0p2ZFc1a0lqcDBjblZsTENKblVsQkRJanAwY25WbExDSnpkRzl5WlM1elpXNXphWFJwZG1sMGVTSTZNU3dpWTI5dGNHRnVlU0k2SW5KbGMzVnRaU0o5TENKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzZXlKdVlXMWxJam9pVTA1UFYwOVBRaUlzSW5SNWNHVWlPbnNpYm1GdFpTSTZJbE5sY25acFkyVk9iM2NpZlgwc0lsTmhiR1Z6Um05eVkyVWlMQ0pIYVhSSWRXSWlYUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJncm91cCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZ3JvdXAoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJub2RlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9ub2RlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiYWN0aXZlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9hY3RpdmUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJlbmFibGVkIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9lbmFibGVkKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiY29kZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfY29kZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogIm9yZGVyIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vcmRlcigpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImRhdGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2RhdGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJuYW1lIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9uYW1lKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAicmVtYXJrIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9yZW1hcmsoKTsKCgl9CgoJZ2V0IEVudGl0eUNsYXNzKCkgewoJCWxldCBlYyA9IHsKCgkJCU5hbWU6ICJOb2RlIEdyb3VwIE1lbWJlciIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJLy8gaWYodGhpcy5fZ3JvdXBfc2V0ICYmIHRoaXMuX2dyb3VwKSB0aGlzLl9ncm91cC5Ub29sID0gdG9vbDsKCgkJLy8gaWYodGhpcy5fbm9kZV9zZXQgJiYgdGhpcy5fbm9kZSkgdGhpcy5fbm9kZS5Ub29sID0gdG9vbDsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJVEhJUyh2LCBjbykgewoJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fVEhJUzsKCQlpZiAoIXYpIHJldHVybiB0aGlzOwoJCXYgPSBBcnJheS5pc0FycmF5KHYpID8gdiA6IFt2XTsKCQl0aGlzLl9USElTID0gdi5maWx0ZXIoX3YgPT4gdHlwZW9mKF92KSA9PT0gJ29iamVjdCcgJiYgX3YuRW50aXR5Q2xhc3MgJiYgX3YuRW50aXR5Q2xhc3MuTmFtZSA9PSB0aGlzLkVudGl0eUNsYXNzLk5hbWUgJiYgX3YuU2NvcGUgPT0gdGhpcy5TY29wZSk7CgkJaWYgKGNvKSB0aGlzLl9USElTX2Nvb3AgPSBjbzsKCQlyZXR1cm4gdGhpczsKCX0KCgljbGVhcl9USElTKCkgewoJCXRoaXMuX1RISVMgPSBbXTsKCQl0aGlzLl9USElTX2Nvb3AgPSAnJzsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGdyb3VwICoqLwoJZ3JvdXAodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9ncm91cF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImdyb3VwIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnMzUwODc0YjAtNzVmMi00ZTY2LWFlNGItYWZjMzEyMWYyZWI2JyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnTm9kZSBHcm91cCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdncm91cCcsICdFbnRpdHlPYmplY3QnLCAxLCAiR09UIEhFUkUiLCBfdiwgIjM1MDg3NGIwLTc1ZjItNGU2Ni1hZTRiLWFmYzMxMjFmMmViNiIsIF92LkVudGl0eUNsYXNzLk5hbWUsICJOb2RlIEdyb3VwIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2dyb3VwICE9IHYpIHsKCQkJCXRoaXMuX2dyb3VwX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ3JvdXAnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX2dyb3VwID8gdGhpcy5fZ3JvdXAuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX2dyb3VwX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl9ncm91cCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9ncm91cCk7CgkJfQoJfQoKCWNsZWFyX2dyb3VwKCkgewoJCXRoaXMuX2dyb3VwX3NldCA9IG51bGw7CgkJdGhpcy5fZ3JvdXAgPSBudWxsOwoJCXRoaXMuX2dyb3VwX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBncm91cCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5vZGUgKiovCglub2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbm9kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5vZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAoX3YgJiYgX3YudG9FbnRpdHlPYmplY3QgJiYgX3YuRW50aXR5Q2xhc3MuSWQgIT09ICc5ZTJhMGQ3MC05YTFiLTQ3NjItYTlkYi0wNjBlNjU3OTVjODknICYmIF92LkVudGl0eUNsYXNzLk5hbWUgIT09ICdOb2RlJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ25vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICI5ZTJhMGQ3MC05YTFiLTQ3NjItYTlkYi0wNjBlNjU3OTVjODkiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiTm9kZSIpOwoJCQkJfSBlbHNlIHsKCQkJCQlfdiA9ICgoX3YgJiYgIXRoaXMuSWQgJiYgX3YudG9FbnRpdHlPYmplY3QpID8gX3YudG9FbnRpdHlPYmplY3QoKSA6IF92KTsKCQkJCX0KCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWRlbGV0ZSBldi5PYmplY3RWYWx1ZWlkOwoJCQlldi5PYmplY3RWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9ub2RlICE9IHYpIHsKCQkJCXRoaXMuX25vZGVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdub2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZXQgYWZ0ZXIiLCB0aGlzLl9ub2RlID8gdGhpcy5fbm9kZS5TZXRfT24gOiBudWxsLCB2ID8gdi5TZXRfT24gOiBudWxsKTsKCQkJCS8qaWYodikgdGhpcy5fbm9kZV9zZXQgPSB2LlNldF9PbjsqLwoKCQkJfQoKCQkJdGhpcy5fbm9kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkVudGl0eVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9ub2RlKTsKCQl9Cgl9CgoJY2xlYXJfbm9kZSgpIHsKCQl0aGlzLl9ub2RlX3NldCA9IG51bGw7CgkJdGhpcy5fbm9kZSA9IG51bGw7CgkJdGhpcy5fbm9kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igbm9kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX2dyb3VwX3NldCwKCgkJCXRoaXMuX25vZGVfc2V0LAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX2dyb3VwX3NldCA9IHRoaXMuX2dyb3VwX3NldDsKCQlyZXQuX2dyb3VwX2Nvb3AgPSB0aGlzLl9ncm91cF9jb29wOwoJCXJldC5ncm91cCA9IHRoaXMuZ3JvdXAoKSA/IHRoaXMuZ3JvdXAoKS5fZmxhdHRlbihkZXB0aCAtIDEpIDogdGhpcy5ncm91cCgpOwoKCQlyZXQuX25vZGVfc2V0ID0gdGhpcy5fbm9kZV9zZXQ7CgkJcmV0Ll9ub2RlX2Nvb3AgPSB0aGlzLl9ub2RlX2Nvb3A7CgkJcmV0Lm5vZGUgPSB0aGlzLm5vZGUoKSA/IHRoaXMubm9kZSgpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLm5vZGUoKTsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkiZ3JvdXAiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJub2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCBoID0gb3B0aW9ucy5jYWNoZSA/IG9wdGlvbnMuY2FjaGUuZmluZChfaCA9PiBfaC5vYmogPT0gdikgOiBudWxsOwoJCQkJCQlvYmpbZWFDb2RlXSA9IGggPyBoLmhhc2ggOiAoKG9wdGlvbnMuY2FjaGUgJiYgb3B0aW9ucy5jYWNoZS5sZW5ndGggPCBvcHRpb25zLmNhY2hlTGltaXQpID8gdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogb2JqW2VhQ29kZV0KCQkJCQkJfSk7CgkJCQkJfSBlbHNlIHsKCQkJCQkJb2JqW2VhQ29kZV0gPSB2OwoJCQkJCX0KCgkJCQl9LAoKCQkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAiZ3JvdXAiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIGdyb3VwJywgcyk7CgkJCQlsZXQgc09iaiA9IG5ldyBzYWxlc25vdy5Ob2RlX0dyb3VwKCkuZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAibm9kZSIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3Igbm9kZScsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuTm9kZSgpLm5vZGVfTm9kZV9Hcm91cF9NZW1iZXJzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkgIT0gJ05vZGVfR3JvdXBfTWVtYmVyJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL05vZGVfR3JvdXBfTWVtYmVyLyR7bWV0aG9kfWAsIGRhdGEsIGNvbmZpZyk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJCX0KCQl9IGVsc2UgewoKCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5fX2dlbmVyYXRlZDsKCQkJCWRlbGV0ZSBkYXRhLl9fdGhpcy5vbmxpbmU7CgoJCQl9CgoJCQkvL3doeSBkbyB3ZSBuZWVkIHRoaXM/Pz8KCgkJCWxldCB2ID0gdW5kZWZpbmVkOwoJCQl0cnkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgYEFib3J0aW5nIGFzIHBlciBzYWxlc25vdy51blJlY3Vyc2VBYm9ydC4ke21ldGhvZH1gKTsKCgkJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCQl9IDogdi5vYmo7CgkJCQkJcmV0dXJuIHYub2JqOwoKCQkJCX0KCgkJCQlsZXQgX2lkID0gbnVsbDsKCQkJCWlmICh0eXBlb2YoZGF0YSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0IiwgZGF0YSwgbWV0aG9kLCB7fSk7CgkJCQkJcmV0dXJuIGRhdGE7CgkJCQl9IGVsc2UgaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3N0cmluZycpIHsKCQkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKGRhdGEpOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSBkYXRhLl9fdGhpcy5jb2RlIHx8IGRhdGEuaWQgfHwgZGF0YS5JRDsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCQlpZiAoZGF0YS5JZCAmJiBkYXRhLklkID09IGRhdGEuSWQpIHsKCQkJCQkJX2lkID0gZGF0YS5JZDsKCQkJCQl9IGVsc2UgaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJCX0gZWxzZSBpZiAoZGF0YS5FbnRpdHlDbGFzcykgewoJCQkJCQlfaWQgPSBkYXRhLkVudGl0eUNsYXNzLklkIHx8IGRhdGEuRW50aXR5Q2xhc3MuTmFtZTsKCQkJCQl9IGVsc2UgewoJCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI1OWNiZGQxMS1lY2IwLTQ3ZmItYjAxNS1lMjliZTM0ZTc0ZmEiIHx8ICJOVUxMIjsKCQkJCQl9CgkJCQl9CgoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlciB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXJbbWV0aG9kXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXJbbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXJbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlclttZXRob2RdW19pZF0gfHwge307CgoJCQkJbGV0IF9oYXNoID0gdGhpcy5fdG9IYXNoKHt9LCB7CgkJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJCX0pOwoKCQkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyW21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlclttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnTm9kZV9Hcm91cF9NZW1iZXInKS5zZW5kZXIoc2FsZXNub3cuX25vZGUpLmNhcnJpZXIoc2FsZXNub3cuX25vZGUpLnBheWxvYWQoZGF0YSk7CgkJCWlmIChldmVudCkgewoJCQkJaWYgKGV2ZW50Ll9yZXNwb25zZVRvX3NldCkgZXYucmVzcG9uc2VUbyhldmVudC5yZXNwb25zZVRvKCkpOwoJCQkJaWYgKGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5zZW5kZXIoZXZlbnQuc2VuZGVyKCkpOwoJCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0KSBldi5jbGFzc05hbWUoZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJaWYgKGV2ZW50Ll9jYXJyaWVyX3NldCB8fCBldmVudC5fc2VuZGVyX3NldCkgZXYuY2FycmllcihldmVudC5jYXJyaWVyKCkgfHwgZXZlbnQuc2VuZGVyKCkpOwoJCQl9CgkJCXJldCA9IGF3YWl0IGV2LnRyaWdnZXIoKTsKCgkJCWlmICh0eXBlb2YocmV0KSA9PT0gInN0cmluZyIpIHsKCQkJCXRyeSB7CgkJCQkJcmV0ID0gSlNPTi5wYXJzZShyZXQpOwoJCQkJfSBjYXRjaCAoZXgpIHt9CgkJCX0KCQkJcmV0dXJuIHJldDsKCgkJfQoKCQlpZiAoIXJldCkgcmV0dXJuIG51bGw7CgkJcmV0ID0gcmV0LmRhdGEgfHwgcmV0OwoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIHJldC5fX2ZsYXR0ZWQpIHJldCA9IEZsYXR0ZWQucGFyc2UocmV0Ll9fZmxhdHRlZCk7CgoJCWlmIChyZXQuX19leGNlcHRpb24pIHsKCQkJLy8gYW4gZXhjZXB0aW9uIG9jY3VycmVkIGF0IHRoZSBzZXJ2ZXIKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMiwgYEV4Y2VwdGlvbiBhdCAke24uX2FkZHJlc3N9YCwgcmV0Ll9fZXhjZXB0aW9uKTsKCQkJcmV0dXJuIHJldDsKCQl9CgoJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQljYXNlICJpbnNlcnQiOgoJCQljYXNlICJ1cGRhdGUiOgoJCQljYXNlICJzdG9yZSI6CgkJCWNhc2UgImRlbGV0ZSI6CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlpZiAoIWJSYXcpIHJldCA9IG5ldyBzYWxlc25vdy5Ob2RlX0dyb3VwX01lbWJlcihudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuTm9kZV9Hcm91cF9NZW1iZXIobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuTm9kZV9Hcm91cF9NZW1iZXIoKS5faW52b2tlTm9kZSh0biwgbWV0aG9kLCBfcGFyYW1zKTsKCQl9CgoJCWlmIChfcGFyYW1zLl9fdGhpcykgewoJCQlfcGFyYW1zLl9fdGhpcyA9IERvdE9iamVjdC5vYmplY3QoX3BhcmFtcy5fX3RoaXMpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX3RoaXMpLl9kZVJlZmVyZW5jZSgpOwoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3BhcmFtcyIsIF9wYXJhbXMpOwoKCQlsZXQgYXJBcmdzID0gW107CgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMub2Jqcyk7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLnN0YXJ0KTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZW5kKTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmQiOiB7CgkJCQlhckFyZ3MucHVzaChfcGFyYW1zLmRlcHRoKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7CgkJCQlicmVhazsKCQkJfQoJCX0KCgkJbGV0IG9iaiA9IHRoaXM7CgoJCWxldCByZXQgPSBudWxsOwoJCWlmICghb2JqKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0xJzogYE5vZGVfR3JvdXBfTWVtYmVyLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgTm9kZV9Hcm91cF9NZW1iZXIuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXIuX3RvRG9jdW1lbnQ7CgkJCQkJCXJldHVybiByLl90b0RvY3VtZW50KGZhbHNlLCB0cnVlKTsKCQkJCQl9IGVsc2UgcmV0dXJuIHI7CgkJCQl9KTsKCQkJfSBlbHNlIHsKCQkJCXJldCA9IChyZXQgJiYgcmV0Ll90b0RvY3VtZW50KSA/IHJldC5fdG9Eb2N1bWVudChmYWxzZSwgdHJ1ZSkgOiByZXQ7CgkJCX0KCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2UnLCAnRW50aXR5T2JqZWN0JywgMCwgYCR7bWV0aG9kfTogJHt0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZV9Hcm91cF9NZW1iZXIuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglfcGFyc2VDb2RlU3RhdGUodCkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyc2VDb2RlU3RhdGUodCk7CgoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiTm9kZSBHcm91cCBNZW1iZXIiKTsKCgl9CgoJX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXggPSAne3snLCBwb3N0Zml4ID0gJ319JykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCwgcG9zdGZpeCk7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCWlmICh0aGlzLl9ncm91cF9zZXQgJiYgdGhpcy5ncm91cCgpKSB0aGlzLmdyb3VwKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX25vZGVfc2V0ICYmIHRoaXMubm9kZSgpKSB0aGlzLm5vZGUoKS5fX3N5bmNfb24oZCk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93Lk5vZGVfR3JvdXBfTWVtYmVyKHRoaXMuSWQpCgoJCQkuZ3JvdXAodGhpcy5ncm91cCgpLCB0aGlzLl9ncm91cF9jb29wKQoKCQkJLm5vZGUodGhpcy5ub2RlKCksIHRoaXMuX25vZGVfY29vcCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJLy9vYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJLy9vYmpUbyA9IG9ialRvIHx8IHt9OwoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAnTm9kZV9Hcm91cF9NZW1iZXInOwoJCXRvb2wgPSB0b29sIHx8IHRoaXMuVG9vbDsKCQljb2RlVHlwZSA9IGNvZGVUeXBlIHx8IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5Sm5jbTkxY0NJNklrNXZaR1ZmUjNKdmRYQWlMQ0p1YjJSbElqb2lUbTlrWlNKOWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pW2NvZGVdOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJOb2RlX0dyb3VwX01lbWJlciI7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIgJiYgdGhpcy5fX2NvbmZpZygnc2NvcGUnKSkgewoJCQkJCWNvZGUgPSB0aGlzLl9fY29uZmlnKCdzY29wZScpICsgIl9zdF8iICsgY29kZTsKCQkJCX0KCQkJCW9Db2RlID0gdW5kZWZpbmVkOwoJCQl9CgkJCWxldCByZXQgPSBjb2RlOwoJCQlpZiAob0NvZGUgJiYgdHlwZW9mKG9Db2RlKSA9PT0gJ29iamVjdCcpIHsKCQkJCXJldCA9IG9Db2RlW3RoaXMuVG9vbC5uYW1lXSB8fCByZXQ7CgkJCX0KCgkJCXJldCA9IHRoaXMuX21hcChjb2RlLCBmYWxzZSwgY29udGV4dCkgfHwgcmV0OwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19uQ29kZScsICdFbnRpdHlPYmplY3QnLCAxLCBleCk7CgkJCXJldHVybiBjb2RlOwoJCX0KCX0KCglfX2NvbmZpZyhuLCBudWxsVmFsdWUsIG9wdGlvbnMgPSB7fSkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX2NvbmZpZyhuLCBudWxsVmFsdWUsIE9iamVjdC5hc3NpZ24oe30sIG9wdGlvbnMgfHwge30sIHsKCQkJX2NsYXNzOiAnTm9kZV9Hcm91cF9NZW1iZXInCgkJfSkpOwoKCX0KCglhc3luYyBfcmVzdCh0TmFtZSA9IHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKHVuZGVmaW5lZCwgdGhpcy5Ub29sKS5fcmVzdCh0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyk7CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgIGAKCQl9OwoJCXJldC5zcWwgKz0gJy8qTm9kZV9Hcm91cF9NZW1iZXIqLyk7XG4nOwoKCQlyZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiB0cnVlLAoJCQlOdWxsOiB0cnVlLAoJCQkvL0lkOiAob2JqLCB2KSA9PiBvYmouc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWWAsCgoJCQkiZ3JvdXAiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJCW9iai5zcWwgPSAodiA/IHYuX3RvU1FMVGFibGUoKSA6ICcnKSArIG9iai5zcWw7CgoJCQl9LAoKCQkJIm5vZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbm9kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJJbnQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJEYXRlIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJuYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCX0sICJfdG9TUUxUYWJsZSIpOwoKCQkvLyByZXQuc3FsICs9ICcvKk5vZGVfR3JvdXBfTWVtYmVyKi8pO1xuJzsKCgkJcmV0LnNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQocmV0LnNxbCkgOiByZXQuc3FsOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TUUxUYWJsZScsICdFbnRpdHlPYmplY3QnLCAwLCByZXQuc3FsKTsKCQlyZXR1cm4gcmV0LnNxbDsKCX0KCglfZnJvbVNRTFRhYmxlKHRhYmxlLCBmaWVsZHMpIHsKCQkvLyB0YWJsZSBpcyBhIGpzb24gYXJyYXkKCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImdyb3VwIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5ncm91cCh0YWJsZVsiZ3JvdXAiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibm9kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubm9kZSh0YWJsZVsibm9kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbChzcWwsIHRoaXMpOwoKCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIGJTdHJpbmcpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7CgkJCVt0aGlzLl9uQ29kZSgpXTogewoJCQkJcGFyYW1zOiB7CgkJCQkJd2hlcmU6IHsKCQkJCQkJYW5kOiBbXSwKCQkJCQkJb3I6IFtdCgkJCQkJfQoJCQkJfSwKCQkJCWVkZ2VzOiB7CgkJCQkJbm9kZToge30KCQkJCX0KCQkJfQoJCX0sIHsKCQkJLy9PUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKHsKCQkJCUlkOiB7CgkJCQkJZXE6IHYKCQkJCX0KCQkJfSksCgoJCQlncm91cDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQl7CgkJCQkJCQlpbnE6IHsKCQkJCQkJCQlBcGlOYW1lOiAnSWQnLAoJCQkJCQkJCVt0aGlzLl9uQ29kZSgnTm9kZV9Hcm91cCcsIHVuZGVmaW5lZCldOiB2ID8gdi5fdG9TRlF1ZXJ5KClbdGhpcy5fbkNvZGUoJ05vZGVfR3JvdXAnLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJbm9kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdOb2RlJywgdW5kZWZpbmVkKV06IHYgPyB2Ll90b1NGUXVlcnkoKVt0aGlzLl9uQ29kZSgnTm9kZScsIHVuZGVmaW5lZCldLnBhcmFtcy53aGVyZS5hbmQgOiBbXSwKCQkJCQkJCX0sCgkJCQkJCX0KCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCSh2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbCkKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQl9LCAiX3RvU0ZRdWVyeSIpOwoKCQkvL09iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlpZiAoYlN0cmluZykgewoJCQlyZXQgPSB7CgkJCQlxdWVyeTogewoJCQkJCVt0aGlzLl9uQ29kZSgpICsgJ1F1ZXJ5J106IHsKCQkJCQkJdWlhcGk6IHJldAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJcmV0ID0gSlNPTi5zdHJpbmdpZnkocmV0LCBudWxsLCA0KTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NGUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqLnN5c19pZCA9IHYsCgoJCQlncm91cDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvU05RdWVyeSgpIDogbnVsbDsKCgkJCX0sCgoJCQlub2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbm9kZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b1NOUXVlcnkoKSA6IG51bGw7CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCWxldCBkID0gYCR7di5nZXRGdWxsWWVhcigpfS0keygnMCcrKHYuZ2V0TW9udGgoKSsxKSkuc2xpY2UoLTIpfS0ke3YuZ2V0RGF0ZSgpfWA7CgkJCQlsZXQgdCA9IGAke3YuZ2V0SG91cnMoKX06JHt2LmdldE1pbnV0ZXMoKX06JHt2LmdldFNlY29uZHMoKX1gOwoJCQkJaWYgKCh2LmdldEhvdXJzKCkgPT0gMCAmJiB2LmdldE1pbnV0ZXMoKSA9PSAwICYmIHYuZ2V0U2Vjb25kcygpID09IDApIHx8IHRoaXMuX2RhdGVfY29vcCA9PSAnPScgfHwgIXRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9ialtlYUNvZGVdID0gYE9OJHtkfUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ3N0YXJ0JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdlbmQnKWA7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX2RhdGVfY29vcCAhPT0gJ0JFVFdFRU4nKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQl9LCAiX3RvU05RdWVyeSIpOwoKCQlPYmplY3Qua2V5cyhyZXQuT1BFUkFUT1JTIHx8IHt9KS5maWx0ZXIoayA9PiB0eXBlb2YocmV0W2tdKSAhPT0gJ3VuZGVmaW5lZCcpLmZvckVhY2goayA9PiByZXRba10gPSByZXQuT1BFUkFUT1JTW2tdICsgcmV0W2tdKTsKCgkJZGVsZXRlIHJldC5PUEVSQVRPUlM7CgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCXJldCA9IERvdE9iamVjdC5kb3QocmV0KTsKCgkJLy8gYXZvaWQgc2VuZGluZyB3aXRoIG5vIGNvbXBhcmlzb24gb3BlcmF0b3JzCgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhWyc+JywgJzwnLCAnQkVUV0VFTicsICdPTicsICchJywgJz0nLCAnU1RBUlRTV0lUSCcsICdMSUtFJ10uc29tZShzID0+IFN0cmluZyhyZXRba10pLnN0YXJ0c1dpdGgocykpKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gKHRoaXNbYF8ke2t9X2Nvb3BgXSB8fCAnU1RBUlRTV0lUSCcpICsgcmV0W2tdKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCBPYmplY3QuZW50cmllcyhyZXQgfHwge30pLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlsZXQgX3JldCA9IG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgZmFsc2UsIGZ1biwgZWFPYmosIG9iaik7CgkJCQlyZXR1cm4gX3JldDsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjU5Y2JkZDExLWVjYjAtNDdmYi1iMDE1LWUyOWJlMzRlNzRmYSIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlciA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXIgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXJbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXJbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlcltmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlcltmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IG9iaiwKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgb2JqLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmosIHRoaXMuX1RISVMpOwoKCQlpZiAoIXRoaXMuZ3JvdXAoKSB8fCAodGhpcy5ncm91cCgpCgoJCQkJJiYKCQkJCSF0aGlzLmdyb3VwKCkuZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkpKSB7CgkJCV9vcHRpb25zKCJncm91cCIsIG9iaiwgdGhpcy5ncm91cCgpKTsKCQl9CgoJCWlmICghdGhpcy5ub2RlKCkgfHwgKHRoaXMubm9kZSgpCgoJCQkJJiYKCQkJCSF0aGlzLm5vZGUoKS5ub2RlX0NvbmZpZ3MoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMubm9kZSgpLmNhcnJpZXJfRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLm5vZGUoKS5zZW5kZXJfRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLm5vZGUoKS5yZWNpcGllbnRfRXZlbnRzKCkuZmluZChfbyA9PiB0aGlzID09PSBfbyB8fCB0aGlzLkVxdWFscyhfbykpCgoJCQkJJiYKCQkJCSF0aGlzLm5vZGUoKS5iYWNrdXBfTm9kZXMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMubm9kZSgpLnBhcmVudF9Ob2RlcygpLmZpbmQoX28gPT4gdGhpcyA9PT0gX28gfHwgdGhpcy5FcXVhbHMoX28pKQoKCQkJCSYmCgkJCQkhdGhpcy5ub2RlKCkubm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoIm5vZGUiLCBvYmosIHRoaXMubm9kZSgpKTsKCQl9CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2dyb3VwJywgJ25vZGUnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaiwgdHJ1ZSkpOwoKCQlyZXR1cm4gb2JqOwoJfQoKCV9faW1wb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCS8vIGlmKCFvYmopIHJldHVybiB0aGlzOwoJCWlmICh0eXBlb2Yob2JqKSAhPT0gJ29iamVjdCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYCR7ZnVufTogTm90IGFuIG9iamVjdDogJHt0eXBlb2Yob2JqKX1gLCBvYmopOwoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqKSA9PiB7CgkJCWlmIChvcHRpb25zLl9maWVsZHMgJiYgIW9wdGlvbnMuX2ZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpIHJldHVybjsKCQkJaWYgKCFvYmopIHJldHVybjsKCQkJaWYgKEFycmF5LmlzQXJyYXkob2JqKSAmJiAhb2JqLmxlbmd0aCkgcmV0dXJuOwoKCQkJdHJ5IHsKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgdHJ1ZSwgZnVuLCBvYmosIG9iaik7CgkJCQlpZiAob3B0aW9uc1tmaWVsZF0gJiYgdHlwZW9mKG9wdGlvbnNbZmllbGRdKSA9PT0gImZ1bmN0aW9uIikgcmV0dXJuIG9wdGlvbnNbZmllbGRdKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgRXJyb3IgJHtleH0gaW4gJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH1gLCBleCk7CgkJCX0KCQl9OwoKCQlfb3B0aW9ucygiX1RISVMiLCBvYmopOwoJCV9vcHRpb25zKCJJZCIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjU5Y2JkZDExLWVjYjAtNDdmYi1iMDE1LWUyOWJlMzRlNzRmYSIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlciA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXIgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXJbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9Hcm91cF9NZW1iZXJbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlcltmdW5dW19pZF0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfR3JvdXBfTWVtYmVyW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0KCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX0dyb3VwX01lbWJlcltmdW5dW19pZF1bX2hhc2hdID0gewoJCQkJZGF0ZTogbmV3IERhdGUoKS5nZXRUaW1lKCksCgkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeShmQXJncyksCgkJCQlvYmo6IHRoaXMsCgkJCQlyZXVzZWQ6IDAsCgkJCX07CgkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQlpZiAoIXVuUmVjRXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbZnVuXSA9IHRydWU7CgkJCX0KCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDIsIHRoaXMsIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJncm91cCIsIG9iaik7CgoJCV9vcHRpb25zKCJub2RlIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnZ3JvdXAnLCAnbm9kZScsICdhY3RpdmUnLCAnZW5hYmxlZCcsICdjb2RlJywgJ29yZGVyJywgJ2RhdGUnLCAnbmFtZScsICdyZW1hcmsnXSkuY29uY2F0KFsnJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RCT2JqZWN0KGZpZWxkcywgYk5vUmVmKSB7CgkJaWYgKCF0aGlzLklkKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJJbnZhbGlkIElEIiwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lLCB0aGlzLlRvb2wpOwoJCX0KCQlsZXQgcmV0ID0gewoJCQlbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldOiAiJyIgKyB0aGlzLklkICsgIiciCgkJfTsKCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJncm91cCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9ncm91cF9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZ3JvdXAoKTsKCgkJCWlmICh2ICYmICh2Ll9fc3luY19vbigpIHx8IHYuSWQgPT0gdi5JZCkpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYuSWQgKyAiJyI7CgkJCX0gZWxzZSB7CgkJCQlmVmFsdWUgPSAwOwoJCQl9CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSArICJpZCJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJub2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX25vZGVfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm5vZGUoKTsKCgkJCWlmICh2ICYmICh2Ll9fc3luY19vbigpIHx8IHYuSWQgPT0gdi5JZCkpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYuSWQgKyAiJyI7CgkJCX0gZWxzZSB7CgkJCQlmVmFsdWUgPSAwOwoJCQl9CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImFjdGl2ZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9hY3RpdmVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuYWN0aXZlKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZW5hYmxlZF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5lbmFibGVkKCk7CgoJCQlmVmFsdWUgPSB2ID8gMSA6IDA7CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9IGZWYWx1ZSA/ICdUcnVlJyA6ICdGYWxzZSc7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjb2RlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2NvZGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuY29kZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkYXRlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2RhdGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZGF0ZSgpOwoKCQkJdHJ5IHsKCQkJCWZWYWx1ZSA9ICInIiArICh2ID8gdi50b0lTT1N0cmluZygpIDogIjE5NzAtMS0xIikgKyAiJyI7CgkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcpIHsKCQkJCQlmVmFsdWUgPSBgU1RSX1RPX0RBVEUoJHtmVmFsdWV9LCAnJVktJW0tJWRUJVQuJWZaJylgOwoJCQkJfQoJCQl9IGNhdGNoIChleCkgewoJCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCQkJfQoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSAnZGF0ZXRpbWUoJyArIGZWYWx1ZSArICcpJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm5hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fbmFtZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5uYW1lKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigicmVtYXJrIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3JlbWFya19zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5yZW1hcmsoKTsKCgkJCWZWYWx1ZSA9ICInIiArICgodiAmJiB2LnJlcGxhY2UpID8gdi5yZXBsYWNlKC9cJy9nLCAiXCdcJyIpIDogdikgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoJCXJldHVybiByZXQ7Cgl9CgoJX1EoKSB7CgkJbGV0IF9vID0gJyInOwoJCWxldCBfcSA9IF9vOwoKCQlpZiAoWydTYWxlc0ZvcmNlJ10uaW5kZXhPZih0aGlzLlRvb2wudHlwZS5uYW1lKSA9PSAwKSB7CgkJCV9vID0gX3EgPSAiIjsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ3R5cGUnKSA9PSAnbXlzcWwnIHx8IHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgewoJCQlfbyA9IF9xID0gJ2AnOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxzZXJ2ZXInKSB7CgkJCV9vID0gJ1snOwoJCQlfcSA9ICddJzsKCQl9IGVsc2UgaWYgKHRoaXMuX19jb25maWcoJ2FwaUtleScpID09ICdhaXJ0YWJsZScpIHsKCQkJX28gPSAneyc7CgkJCV9xID0gJ30nOwoJCX0KCQl0aGlzLl9fUSA9IHRoaXMuX19RID09IF9vID8gX3EgOiBfbzsKCQlyZXR1cm4gdGhpcy5fX1E7Cgl9CgoJX2ZpZWxkR3JvdXBzKGZncyA9IHt9KSB7CgkJdGhpcy5fX2ZpZWxkR3JvdXBzID0gZmdzOwoJCXJldHVybiB0aGlzOwoJfQoKCV9maWVsZEFnZ3JlZ2F0ZXMoZmFzID0ge30pIHsKCQl0aGlzLl9fZmllbGRBZ2dyZWdhdGVzID0gZmFzOwoJCXJldHVybiB0aGlzOwoJfQoKCV90b0ZpZWxkc1NRTChmaWVsZHMpIHsKCgkJZmllbGRzID0gZmllbGRzIHx8IFt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKSwgdGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSArICIuaWQiLCB0aGlzLl9uQ29kZSgnbm9kZScsIHVuZGVmaW5lZCkgKyAiLmlkIiwgdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCldOwoJCWZpZWxkcyA9IEFycmF5LmlzQXJyYXkoZmllbGRzKSA/IGZpZWxkcyA6IFtmaWVsZHNdOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCS8vIHtmaWVsZDogb3JkZXJ9CgkJCWZpZWxkcyA9IFtdOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5ncm91cCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5ub2RlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnbm9kZScsIHVuZGVmaW5lZCkrImlkIn1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZW5hYmxlZCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jb2RlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX1gKTsKCgkJfQoJCXJldHVybiBmaWVsZHM7Cgl9CgoJX2Zyb21EQk9iamVjdChyID0ge30pIHsKCQl0cnkgewoJCQlyZXR1cm4gdGhpcy5fX2ltcG9ydChyLCB7CgkJCQlJZDogb2JqID0+IHRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldLAoKCQkJCWdyb3VwOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5ncm91cChvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW5vZGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMubm9kZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWFjdGl2ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmFjdGl2ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZW5hYmxlZChvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuY29kZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW9yZGVyOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5vcmRlcihvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuZGF0ZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMubmFtZShvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJCXJlbWFyazogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnJlbWFyayhvYmpbZWFDb2RlXSk7CgkJCQl9LAoKCQkJfSwgIl9mcm9tREJPYmplY3QiKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX3RvU2VsZWN0SGVhZGVyKGZpZWxkcykgewoJCWxldCByZXQgPSB7CgkJCXRhYmxlOiB0aGlzLl9uQ29kZSgpLAoJCQlmaWVsZHM6IERvdE9iamVjdC5vYmplY3QoT2JqZWN0LmZyb21FbnRyaWVzKHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLm1hcChmID0+IFtmLCBmXSkpKSwKCQkJam9pbnM6IHt9LAoJCX07CgoJCWlmIChmaWVsZHMpIHJldHVybiByZXQ7CgoJCXJldC5qb2lucyA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJTnVsbDogdHJ1ZSwKCgkJCWdyb3VwOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Ob2RlX0dyb3VwKG51bGwsIHRoaXMuVG9vbCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQlub2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbm9kZScsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93Lk5vZGUobnVsbCwgdGhpcy5Ub29sKS5fdG9TZWxlY3RIZWFkZXIoKSwKCgkJfSwgIl90b1NlbGVjdEhlYWRlciIpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RIZWFkZXInLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9TZWxlY3RTUUwoZmllbGRzKSB7CgkJbGV0IHNxbCA9ICJzZWxlY3QgIjsKCgkJbGV0IHRQcmVmID0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX1gOwoKCQlsZXQgaGVhZGVyID0gdGhpcy5fdG9TZWxlY3RIZWFkZXIoZmllbGRzKTsKCgkJc3FsICs9IE9iamVjdC52YWx1ZXMoaGVhZGVyLmZpZWxkcykubWFwKGYgPT4gYCR7dFByZWZ9LiR7Zn1gKS5qb2luKCcsICcpOwoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSAiLCAiICsgT2JqZWN0LnZhbHVlcyhoZWFkZXIuam9pbnNba10uZmllbGRzKS5tYXAoZiA9PiBgJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHtmfSBhcyAke3RoaXMuX1EoKX0ke2t9LiR7Zi5yZXBsYWNlKHRoaXMuX1EoKSwgJycpfWApLmpvaW4oJywgJykpOwoKCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcykgewoJCQkvLyB7ZmllbGQ6IGZ1bmN0aW9ufQoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZ3JvdXApIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmdyb3VwfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5ub2RlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5ub2RlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJfQoKCQlzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7CgoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCk7CgoJCXNxbCArPSBgIHdoZXJlIDE9MWA7CgoJCXNxbCA9IHRoaXMuX19leHBvcnQoewoJCQlzcWw6IHNxbAoJCX0sIHsKCQkJX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSA/IFsnSWQnXSA6IHVuZGVmaW5lZCwKCQkJTnVsbDogdHJ1ZSwKCQkJX1RISVM6IG9iaiA9PiB7CgkJCQlpZiAoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKHQuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOwoJCQl9LAoJCQlJZDogb2JqID0+IG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwKCgkJCWdyb3VwOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2dyb3VwX3NldCkgcmV0dXJuOwoKCQkJCWxldCBjb29wID0gdGhpcy5fZ3JvdXBfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlub2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbm9kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fbm9kZV9zZXQpIHJldHVybjsKCgkJCQlsZXQgY29vcCA9IHRoaXMuX25vZGVfY29vcDsKCQkJCXN3aXRjaCAoY29vcCkgewoJCQkJCWNhc2UgIiE9IjoKCQkJCQkJY29vcCA9ICJOT1QgSU4iOwoJCQkJCWNhc2UgIj0iOgoJCQkJCQljb29wID0gIklOIjsKCQkJCQljYXNlICIiOgoJCQkJCQljb29wID0gIklOIjsKCQkJCX0KCgkJCQlpZiAodikgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9aWQke3RoaXMuX1EoKX0gJHtjb29wfSAoJHt2Ll90b1NlbGVjdFNRTCh2Ll9fY29uZmlnKCdpZEZpZWxkJyl8fCdfX2lkJyl9KWA7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gYCBhbmQgKCR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKDApIE9SICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9IElTIE5VTEwpYDsKCQkJCX0KCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgIj0iICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJib29sZWFuIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKHYgPyAiMSIgOiAiMCIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQljb2RlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fY29kZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2NvZGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9jb2RlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb2RlX2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcmRlcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29yZGVyX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX2RhdGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYudG9JU09TdHJpbmcpIHsKCQkJCQlpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdzcWxpdGUnKSB7CgkJCQkJCW9iai5zcWwgKz0gInN0cmZ0aW1lKCclcycsICciICsgdi50b0lTT1N0cmluZygpICsgIicpIjsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmouc3FsICs9ICInIiArIHYudG9JU09TdHJpbmcoKSArICInIjsKCQkJCQl9CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW5hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fbmFtZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX25hbWVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX25hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fcmVtYXJrX3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9TZWxlY3RTUUwiLCBmaWVsZHMpLnNxbDsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQlpZiAoT2JqZWN0LmtleXModGhpcy5fX2ZpZWxkR3JvdXBzKS5sZW5ndGgpIHNxbCArPSAiIGdyb3VwIGJ5ICI7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmdyb3VwKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2dyb3VwJywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5ncm91cH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5ub2RlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5vZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmFjdGl2ZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5kYXRlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5kYXRlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm5hbWV9YDsKCgkJfQoKCQlpZiAoc3FsLmVuZHNXaXRoKCJ3aGVyZSAxPTEiKSkgewoJCQkvLyBzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIiwgIndoZXJlIDE9MCIpOwoJCX0gZWxzZSB7CgkJCXNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEgYW5kICIsICJ3aGVyZSAiKTsKCQl9CgoJCXNxbCA9IHR5cGVvZihzcWxGb3JtYXR0ZXIpICE9PSAndW5kZWZpbmVkJyA/IHNxbEZvcm1hdHRlci5mb3JtYXQoc3FsKSA6IHNxbDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TZWxlY3RTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCgkJcmV0dXJuIHNxbDsKCX0KCglfdG9QYXRocygpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlfVEhJUzogb2JqID0+IHt9LAoKCQkJZ3JvdXA6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkpID0+IG9iai5ncm91cCA9IHYuX3RvUGF0aHMoKSwKCgkJCW5vZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKSkgPT4gb2JqLm5vZGUgPSB2Ll90b1BhdGhzKCksCgoJCX0sICJfdG9QYXRocyIpOwoJCS8vIHJldHVybiByZXQ7CgkJcmV0dXJuIE9iamVjdC5rZXlzKHJldCkubWFwKGsgPT4gKHsKCQkJW2tdOiByZXRba10KCQl9KSk7Cgl9CgoJX3RvVXBkYXRlU1FMKGZpZWxkcykgewoJCWxldCByZXRGaWVsZHMgPSB0aGlzLl90b0ZpZWxkc1NRTChmaWVsZHMpLm1hcChmID0+IHRoaXMuX1EoKSArIGYucmVwbGFjZSgvXC4vZywgJycpICsgdGhpcy5fUSgpKS5qb2luKCcsICcpOwoJCWxldCBzcWwgPSBgdXBkYXRlICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gc2V0IGAgKyBPYmplY3QuZW50cmllcyh0aGlzLl90b0RCT2JqZWN0KGZpZWxkcykpLm1hcCh2ID0+IHRoaXMuX1EoKSArIHZbMF0gKyB0aGlzLl9RKCkgKyAiPSIgKyB2WzFdKSArIGAgd2hlcmUgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYDsgLy9gIHJldHVybmluZyAke3JldEZpZWxkc31gOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1VwZGF0ZVNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX3RvSW5zZXJ0U1FMKGZpZWxkcykgewoJCWxldCBvYmogPSB0aGlzLl90b0RCT2JqZWN0KGZpZWxkcyk7CgkJbGV0IHNxbCA9IGBpbnNlcnQgaW50byAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IChgICsgT2JqZWN0LmtleXMob2JqKS5tYXAoayA9PiB0aGlzLl9RKCkgKyBrICsgdGhpcy5fUSgpKSArICIpIHZhbHVlcyAoIiArIE9iamVjdC52YWx1ZXMob2JqKSArIGApYDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9JbnNlcnRTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV9jb3B5RnJvbShvYmopIHsKCQlpZiAoIW9iaikgcmV0dXJuIG51bGw7CgkJcmV0dXJuIHRoaXMuX3JldmVydChvYmopOwoJfQoKCWFzeW5jIF9zdG9yZUVudGl0eUNsYXNzKGRlcHRoKSB7CgkJdHJ5IHsKCQkJaWYgKHR5cGVvZihkZXB0aCkgPT09ICJ1bmRlZmluZWQiKSBkZXB0aCA9IHRoaXMuX19jb25maWcoImNyZWF0ZSIpOwoJCQlpZiAoIWRlcHRoKSByZXR1cm47CgoJCQlzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyA9IHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzIHx8IHt9OwoJCQlpZiAoc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTm9kZV9Hcm91cF9NZW1iZXIpIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTm9kZV9Hcm91cF9NZW1iZXIgPSB0cnVlOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgYHN0b3JpbmcgJyR7dGhpcy5Ub29sLnR5cGUubmFtZX0nIG1vZGVsIHdpdGggZGVwdGggJHtkZXB0aH1gKTsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlsZXQgc3FsID0gbmV3IHNhbGVzbm93Lk5vZGVfR3JvdXBfTWVtYmVyKCkKCgkJCQkJLmdyb3VwKG5ldyBzYWxlc25vdy5Ob2RlX0dyb3VwKCkpCgoJCQkJCS5ub2RlKG5ldyBzYWxlc25vdy5Ob2RlKCkpCgoJCQkJCS5fdG9TUUxUYWJsZShkZXB0aCk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCQkJYXdhaXQgdGhpcy5fc3FsKHNxbCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCX0KCgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCQlyZXR1cm4gdGhpczsKCX0KCglhc3luYyBEU0Nvbm5lY3QodG9vbCA9IHRoaXMuVG9vbCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5EU0Nvbm5lY3QodG9vbCk7CgoJfQoJLyogRW5kOiBVdGlsIGZ1bmN0aW9ucyAqLwoKCV9tYXRjaGVzKHF1ZXJ5KSB7CgkJdHJ5IHsKCQkJaWYgKCFxdWVyeSB8fCAhcXVlcnkuRW50aXR5Q2xhc3MgfHwgcXVlcnkuRW50aXR5Q2xhc3MuTmFtZSAhPSAiTm9kZSBHcm91cCBNZW1iZXIiKSByZXR1cm4gZmFsc2U7CgoJCQlsZXQgb01hdGNoID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQkJRnVsbDogdHJ1ZSwKCQkJCU51bGw6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLl9pZCA9IHRoaXMuSWQgPT0gcXVlcnkuSWQsCgoJCQkJZ3JvdXA6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmdyb3VwID0gdiA/IHYuX21hdGNoZXMocXVlcnkgPyBxdWVyeS5ncm91cCgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9ncm91cF9zZXQgJiYgIXF1ZXJ5Ll9ncm91cF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZ3JvdXAgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZ3JvdXBfc2V0ICYmIHF1ZXJ5Ll9ncm91cF9zZXQpIHx8CgoJCQkJCQkodGhpcy5ncm91cCgpICYmICF0aGlzLmdyb3VwKCkuX21hdGNoZXMocXVlcnkuZ3JvdXAoKSkpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmdyb3VwID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5vZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5vZGUgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5Lm5vZGUoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbm9kZV9zZXQgJiYgIXF1ZXJ5Ll9ub2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5ub2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25vZGVfc2V0ICYmIHF1ZXJ5Ll9ub2RlX3NldCkgfHwKCgkJCQkJCSh0aGlzLm5vZGUoKSAmJiAhdGhpcy5ub2RlKCkuX21hdGNoZXMocXVlcnkubm9kZSgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubm9kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlhY3RpdmU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHYgPT0gcXVlcnkuYWN0aXZlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2FjdGl2ZV9zZXQgJiYgIXF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9hY3RpdmVfc2V0ICYmIHF1ZXJ5Ll9hY3RpdmVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZW5hYmxlZCA9IHYgPT0gcXVlcnkuZW5hYmxlZCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9lbmFibGVkX3NldCAmJiAhcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZW5hYmxlZF9zZXQgJiYgcXVlcnkuX2VuYWJsZWRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNvZGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmNvZGUgPSB2ID09IHF1ZXJ5LmNvZGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY29kZV9zZXQgJiYgIXF1ZXJ5Ll9jb2RlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb2RlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NvZGVfc2V0ICYmIHF1ZXJ5Ll9jb2RlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvcmRlcjogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoub3JkZXIgPSB2ID09IHF1ZXJ5Lm9yZGVyKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX29yZGVyX3NldCAmJiAhcXVlcnkuX29yZGVyX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vcmRlciA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vcmRlcl9zZXQgJiYgcXVlcnkuX29yZGVyX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSBmYWxzZTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouZGF0ZSA9IHYgPT0gcXVlcnkuZGF0ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9kYXRlX3NldCAmJiAhcXVlcnkuX2RhdGVfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmRhdGUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fZGF0ZV9zZXQgJiYgcXVlcnkuX2RhdGVfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gZmFsc2U7CgkJCQl9LAoKCQkJCW5hbWU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm5hbWUgPSB2ID09IHF1ZXJ5Lm5hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fbmFtZV9zZXQgJiYgIXF1ZXJ5Ll9uYW1lX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5uYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX25hbWVfc2V0ICYmIHF1ZXJ5Ll9uYW1lX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlyZW1hcms6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnJlbWFyayA9IHYgPT0gcXVlcnkucmVtYXJrKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3JlbWFya19zZXQgJiYgIXF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnJlbWFyayA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9yZW1hcmtfc2V0ICYmIHF1ZXJ5Ll9yZW1hcmtfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSBmYWxzZTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoZXMiKTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGVzJywgJ0VudGl0eU9iamVjdCcsIDAsIG9NYXRjaCk7CgoJCQlyZXR1cm4gT2JqZWN0LmtleXMob01hdGNoKS5ldmVyeShrID0+IG9NYXRjaFtrXSk7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfbWF0Y2hpbmcocXVlcnkpIHsKCQl0cnkgewoJCQlsZXQgcmV0ID0gW107CgoJCQlsZXQgbWF0Y2hlcyA9IHRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlncm91cDogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIGdyb3VwIik7CgkJCQkJb2JqLmdyb3VwID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQkJbm9kZTogKG9iaiwgdikgPT4gewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAiRm9yIG5vZGUiKTsKCQkJCQlvYmoubm9kZSA9IHYgPyBbdi5fbWF0Y2hpbmcocXVlcnkpID8gdiA6IG51bGxdLmNvbmNhdCh2Ll9tYXRjaGluZyhxdWVyeSkpLmZpbHRlcihtID0+IG0pIDogW107CgkJCQl9LAoKCQkJfSwgIl9tYXRjaGluZyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJtYXRjaGVzIiwgbWF0Y2hlcyk7CgoJCQlyZXQgPSBbLi4ubmV3IFNldChPYmplY3Qua2V5cyhtYXRjaGVzKS5tYXAoayA9PiBtYXRjaGVzW2tdKS5mbGF0KCkpXS5maWx0ZXIobSA9PiBtICE9IHF1ZXJ5KTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAwLCAicmV0IiwgcmV0KTsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZGVSZWZlcmVuY2Uocm9vdCkgewoJCXRyeSB7CgkJCWlmICghcm9vdCkgcm9vdCA9IHRoaXM7CgoJCQlsZXQgaXNRdWVyeSA9IHRydWUKCgkJCQkmJgoJCQkJKHRoaXMuX2dyb3VwX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX25vZGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fYWN0aXZlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY29kZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcmRlcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9kYXRlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX25hbWVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fcmVtYXJrX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQlncm91cDogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLmdyb3VwKHJldCk7CgkJCQkJfQoJCQkJfSwKCgkJCQlub2RlOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMubm9kZShyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQl9LCAiX2RlUmVmZXJlbmNlIik7CgoJCQlyZXR1cm4gdGhpczsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfZnJvbURvY3VtZW50KG9iaiwgYlRvb2wsIGJOb051bGwpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgkJaWYgKG9iai5fZnJvbURvY3VtZW50KSByZXR1cm4gb2JqOwoKCQlpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCXRyeSB7CgkJCQlvYmogPSBKU09OLnBhcnNlKG9iaik7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDEsICJJbnZhbGlkIEpTT04iLCBvYmopOwoJCQl9CgkJfQoKCQl0aGlzLl9faW1wb3J0KG9iaiwgewoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IG9iaiA9PiB0aGlzLlRISVMob2JqLlRISVMsIG9iai5PUEVSQVRPUlMgPyBvYmouT1BFUkFUT1JTLlRISVMgOiB1bmRlZmluZWQpLAoJCQlJZDogb2JqID0+IHsKCQkJCXRoaXMuSWQgPSBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldOwoJCQkJaWYgKG9iai5fX3Rvb2wpIHsKCQkJCQl0cnkgewoJCQkJCQl0aGlzLlRvb2wgPSBvYmouX190b29sOwoJCQkJCX0gY2F0Y2ggKGV4KSB7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCQkJCX0KCQkJCX0KCQkJfSwKCgkJCWdyb3VwOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZ3JvdXAnLCB1bmRlZmluZWQpIDogImdyb3VwIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2dyb3VwX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLmdyb3VwKCkgfHwgbmV3IHNhbGVzbm93Lk5vZGVfR3JvdXAoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLmdyb3VwKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2UgZ3JvdXAiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCW5vZGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdub2RlJywgdW5kZWZpbmVkKSA6ICJub2RlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX25vZGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMubm9kZSgpIHx8IG5ldyBzYWxlc25vdy5Ob2RlKCkpLl9mcm9tRG9jdW1lbnQocmVmLCBiVG9vbCk7CgoJCQkJaWYgKCFiVG9vbCB8fCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8ICF0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdKSB7CgkJCQkJdGhpcy5ub2RlKG9SZWYpOwoJCQkJfSBlbHNlIHsKCQkJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBSZWZlcmVuY2Ugbm9kZSIsIG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0sIHRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0sIHJlZik7CgkJCQl9CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQl9LCAiX2Zyb21Eb2N1bWVudCIpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSB7CgkJbGV0IHJldCA9IHt9OwoKCQlpZiAoIWJUb29sKSB7CgkJCXJldC5fX2dlbmVyYXRlZCA9IG5ldyBEYXRlKCk7CgkJCWlmICh0aGlzLlRvb2wubmFtZSkgewoJCQkJcmV0Ll9fdG9vbCA9IHsKCQkJCQluYW1lOiB0aGlzLlRvb2wubmFtZSwKCQkJCQl0eXBlOiB7CgkJCQkJCW5hbWU6IHRoaXMuVG9vbC50eXBlLm5hbWUsCgkJCQkJfQoJCQkJfTsKCQkJfQoJCQlpZiAoc2FsZXNub3cuX25vZGUpIHsKCQkJCXJldC5fX25vZGUgPSB7CgkJCQkJY29kZTogc2FsZXNub3cuX25vZGUuY29kZSgpCgkJCQl9OwoJCQl9CgkJfQoKCQlyZXR1cm4gdGhpcy5fX2V4cG9ydChyZXQsIHsKCQkJRnVsbDogYkZ1bGwsCgkJCU51bGw6IGJOdWxsLAoJCQlfbWFwOiBiVG9vbCwKCQkJX1RISVM6IChvYmosIHYpID0+IHsKCQkJCWlmIChiVG9vbCkgcmV0dXJuOwoJCQkJb2JqLlRISVMgPSB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkpOwoJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQlvYmouT1BFUkFUT1JTLlRISVMgPSB0aGlzLl9USElTX2Nvb3A7CgkJCX0sCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldID0gdiwKCgkJCSJncm91cCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdncm91cCcsIHVuZGVmaW5lZCkgOiAiZ3JvdXAiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl9ncm91cF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZ3JvdXBfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJub2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25vZGUnLCB1bmRlZmluZWQpIDogIm5vZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYuX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgOiBudWxsOwoKCQkJCWlmICh0aGlzLl9ub2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9ub2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkgOiAiYWN0aXZlIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkiZW5hYmxlZCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2VuYWJsZWRfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29kZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29kZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcmRlcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3JkZXJfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJkYXRlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpIDogImRhdGUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdiA/IHYudG9JU09TdHJpbmcoKSA6IG51bGw7CgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIG9ialtlYUNvZGVdID0gb2JqW2VhQ29kZV0ucmVwbGFjZSgvXC5bMC05XSpaL2csICcnKTsKCgkJCQlpZiAodGhpcy5fZGF0ZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZGF0ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkgOiAibmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9uYW1lX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9uYW1lX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkicmVtYXJrIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX3JlbWFya19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCX0sICJfdG9Eb2N1bWVudCIsIGJUb29sLCBiRnVsbCwgYk51bGwpOwoJfQoKCWFzeW5jIGdldChuYW1lKSB7CgkJaWYgKCF0aGlzLklkKSByZXR1cm4gbnVsbDsKCQl2YXIgdCA9IG51bGw7CgkJJC5lYWNoKG5hbWUuc3BsaXQoJy4nKSwgKF8sIGYpID0+IHsKCQkJdCA9IHsKCQkJCUVudGl0eU9iamVjdDogdCA/IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJVmFsdWVFbnRpdGllczogW3RdCgkJCQl9IDogewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlJZDogdGhpcy5JZAoJCQkJfSwKCQkJCUVudGl0eUF0dHJpYnV0ZTogewoJCQkJCU5hbWU6IGYsCgkJCQkJT1BFUkFUT1JTOiB7CgkJCQkJCU5hbWU6ICI9IgoJCQkJCX0KCQkJCX0KCQkJfTsKCQl9KTsKCQlyZXR1cm4gJC53aGVuKHRoaXMuc3IoKS5fKCJFbnRlcnByaXNlTWFuYWdlci5lbXNFbnRpdHlWYWx1ZUZpbmQiLCBudWxsLCB0KSkudGhlbihldiA9PiB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCcsICdFbnRpdHlPYmplY3QnLCAwLCBldik7CgkJCWlmIChldiA9PT0gbnVsbCkgcmV0dXJuIG51bGw7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHJldHVybiBldi5TdHJpbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Zsb2F0KSByZXR1cm4gZXYuRmxvYXRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0ludCkgcmV0dXJuIGV2LkludFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzTG9uZykgcmV0dXJuIGV2LkxvbmdWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQpIHJldHVybiBldi5UZXh0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNCb29sKSByZXR1cm4gZXYuQm9vbFZhbHVlOwoKCQkJaWYgKCFldi5PYmplY3RWYWx1ZSkgcmV0dXJuIG51bGw7CgoJCQlyZXR1cm4gbmV3IHNhbGVzbm93WyQuZ3JlcChzYWxlc25vdy5FbnRpdHlDbGFzc2VzLCBjID0+IGMuSWQgPT0gZXYuRW50aXR5QXR0cmlidXRlLkVudGl0eVR5cGVpZClbMF0uTmFtZS5yZXBsYWNlKC8gL2csICdfJyldKGV2Lk9iamVjdFZhbHVlLklkKTsKCQl9KTsKCX0KCgkvKiBTVEFSVDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fKCkgKi8KCV8oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuXyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuXygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5idWlsZFVSTCgpICovCglidWlsZFVSTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmJ1aWxkVVJMKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLiRfUkVRVUVTVCgpICovCgkkX1JFUVVFU1QoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS4kX1JFUVVFU1QoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLiRfUkVRVUVTVCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wYXJhbSgpICovCglwYXJhbSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnBhcmFtKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucGFyYW0oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnBhcmFtKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl90b1hNTCgpICovCglfdG9YTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdG9YTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl90b1hNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jb29wKCkgKi8KCWNvb3AoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jb29wKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY29vcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY29vcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5PUigpICovCglPUiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLk9SKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuT1IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLk9SKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLm15UmVwbGFjZSgpICovCglteVJlcGxhY2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5teVJlcGxhY2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLm15UmVwbGFjZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZW5kWE1MKCkgKi8KCXNlbmRYTUwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VuZFhNTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoJcHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3BvbnNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzcG9uc2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCglwcm9jZXNzUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VydmVyRGF0ZSgpICovCglzZXJ2ZXJEYXRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlcnZlckRhdGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYWRkTVNlY29uZHMoKSAqLwoJYWRkTVNlY29uZHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5hZGRNU2Vjb25kcygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TY3JpcHQoKSAqLwoJcnVuU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU1JTY3JpcHQoKSAqLwoJcnVuU1JTY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ydW5TUlNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5oYXNoQ29kZSgpICovCgloYXNoQ29kZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmhhc2hDb2RlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmdyb3VwQnkoKSAqLwoJZ3JvdXBCeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5ncm91cEJ5KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dEZWJ1ZygpICovCglTaG93RGVidWcoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RGVidWcoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dEZWJ1ZygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5jYWNoZVJlc3VsdCgpICovCgljYWNoZVJlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnRvSGV4KCkgKi8KCXRvSGV4KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IudG9IZXgoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS50b0hleCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IudG9IZXgoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0Vycm9yKCkgKi8KCVNob3dFcnJvciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dFcnJvciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0Vycm9yKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLkVxdWFscygpICovCglFcXVhbHMoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5FcXVhbHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLkVxdWFscygpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5pcEFkZHJlc3MoKSAqLwoJaXBBZGRyZXNzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuaXBBZGRyZXNzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5pcEFkZHJlc3MoKSAqLwoKCS8qIEVORDogc3IgZnVuY3Rpb24gY29waWVzICovCgoJLyogU1RBUlQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXR0cigpICovCglfYXR0ciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0dHIoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXR0ciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdHRyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdW5pcXVlKCkgKi8KCV91bmlxdWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3VuaXF1ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2ZsaXAoKSAqLwoJX2ZsaXAoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9mbGlwKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fZmxpcCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoJX3JlZnJlc2hBUEkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX19zY29wZSgpICovCglfX3Njb3BlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19zY29wZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnNyKCkgKi8KCXNyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5zciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuc3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdG9iKCkgKi8KCV9hdG9iKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXRvYiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdG9iKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0b2IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9idG9hKCkgKi8KCV9idG9hKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYnRvYSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9idG9hKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2J0b2EoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fdGltZSgpICovCglfX3RpbWUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fdGltZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fdGltZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9fdGltZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3dhaXQoKSAqLwoJX3dhaXQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl93YWl0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3dhaXQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fd2FpdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoJX3NxbFR5cGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fc3FsVHlwZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3V1aWQoKSAqLwoJX3V1aWQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl91dWlkKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3V1aWQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdXVpZCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQucmVxdWlyZSgpICovCglyZXF1aXJlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCV9pbmNsdWRlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCglfYmVhdXRpZnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9iZWF1dGlmeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9iZWF1dGlmeSgpICovCgoJLyogRU5EOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJaTE4bihldiwgdikgewoJCWlmICh0eXBlb2Yod2luZG93KSA9PT0gInVuZGVmaW5lZCIgfHwgdHlwZW9mKHdpbmRvdy5pMThuX3N0b3JlKSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB2OwoKCQlpZiAoIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1RleHQgJiYgIWV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgewoJCQlyZXR1cm4gdjsKCQl9IGVsc2UgewoJCQlyZXR1cm4gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gPSB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSB8fCB2OwoJCX0KCX0KCglieU5vZGVfR3JvdXAoYXIpIHsKCQl2YXIgcmV0ID0gW107CgkJYXIuZm9yRWFjaChhID0+IHsKCQkJcmV0LmZvckVhY2gociA9PiB7CgkJCQlpZiAoYVsiX2dyb3VwIl0gJiYgKGFbIl9ncm91cCJdLkVxdWFscyA/IGFbIl9ncm91cCJdLkVxdWFscyhyKSA6IHNyLkVxdWFscyhhWyJfZ3JvdXAiXSwgcikpKSB7CgkJCQkJci5fZ3JvdXBfTm9kZV9Hcm91cF9NZW1iZXJzLnB1c2goYSk7CgkJCQl9CgkJCX0pOwoJCX0pOwoJCXJldHVybiByZXQ7Cgl9CgoJYnlOb2RlKGFyKSB7CgkJdmFyIHJldCA9IFtdOwoJCWFyLmZvckVhY2goYSA9PiB7CgkJCXJldC5mb3JFYWNoKHIgPT4gewoJCQkJaWYgKGFbIl9ub2RlIl0gJiYgKGFbIl9ub2RlIl0uRXF1YWxzID8gYVsiX25vZGUiXS5FcXVhbHMocikgOiBzci5FcXVhbHMoYVsiX25vZGUiXSwgcikpKSB7CgkJCQkJci5fbm9kZV9Ob2RlX0dyb3VwX01lbWJlcnMucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuX25hbWU7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IHRydWU7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5ncm91cCA9IHt9OwoJCQlpZiAoIXRoaXMuX2dyb3VwX3NldCkgZXJyb3IuZ3JvdXBbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIXRoaXMuZ3JvdXAoKSkgZXJyb3IuZ3JvdXBbIjAyIl0gPSAiRW1wdHkgVmFsdWUiOwoJCQlpZiAodGhpcy5ncm91cCgpICYmIGJTeW5jICYmICF0aGlzLmdyb3VwKCkuX19zeW5jX29uKCkpIGVycm9yLmdyb3VwWyIwMyJdID0gIk5vdCBpbiBTeW5jIjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IuZ3JvdXApLmxlbmd0aCkgZGVsZXRlIGVycm9yLmdyb3VwOwoJCX0KCgkJaWYgKAoJCQkvKgoJCQkoKG9TY29wZSkgPT4gewoJCQkgICAgbGV0IHJldCA9IHRydWU7CgkJCSAgICBpZih0eXBlb2YocmV0KT09PSJmdW5jdGlvbiIpewoJCQkgICAgICAgIHJldCA9IHJldChvU2NvcGUpOwoJCQkgICAgfQoJCQkgICAgcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJCSB8fCAqLwoJCQkoKG9TY29wZSkgPT4gewoJCQkJbGV0IHJldCA9IHRydWU7CgkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCX0KCQkJCXJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCSkgewoJCQllcnJvci5ub2RlID0ge307CgkJCWlmICghdGhpcy5fbm9kZV9zZXQpIGVycm9yLm5vZGVbIjAxIl0gPSAiTm90IFNldCI7CgoJCQlpZiAoIXRoaXMubm9kZSgpKSBlcnJvci5ub2RlWyIwMiJdID0gIkVtcHR5IFZhbHVlIjsKCQkJaWYgKHRoaXMubm9kZSgpICYmIGJTeW5jICYmICF0aGlzLm5vZGUoKS5fX3N5bmNfb24oKSkgZXJyb3Iubm9kZVsiMDMiXSA9ICJOb3QgaW4gU3luYyI7CgoJCQlpZiAoIU9iamVjdC5rZXlzKGVycm9yLm5vZGUpLmxlbmd0aCkgZGVsZXRlIGVycm9yLm5vZGU7CgkJfQoKCQlpZiAoCgkJCS8qCgkJCSgob1Njb3BlKSA9PiB7CgkJCSAgICBsZXQgcmV0ID0gdHJ1ZTsKCQkJICAgIGlmKHR5cGVvZihyZXQpPT09ImZ1bmN0aW9uIil7CgkJCSAgICAgICAgcmV0ID0gcmV0KG9TY29wZSk7CgkJCSAgICB9CgkJCSAgICByZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkJIHx8ICovCgkJCSgob1Njb3BlKSA9PiB7CgkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJfQoJCQkJcmV0dXJuIHJldDsKCQkJfSkoc2FsZXNub3cpCgkJKSB7CgkJCWVycm9yLm5hbWUgPSB7fTsKCQkJaWYgKCF0aGlzLl9uYW1lX3NldCkgZXJyb3IubmFtZVsiMDEiXSA9ICJOb3QgU2V0IjsKCgkJCWlmICghT2JqZWN0LmtleXMoZXJyb3IubmFtZSkubGVuZ3RoKSBkZWxldGUgZXJyb3IubmFtZTsKCQl9CgoJCWlmIChPYmplY3Qua2V5cyhlcnJvcikubGVuZ3RoKSB7CgkJCXRoaXMuX19hc3NlcnRFcnJvciA9IGVycm9yOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2Fzc2VydFZhbGlkJywgJ0VudGl0eU9iamVjdCcsIDIsIEpTT04uc3RyaW5naWZ5KGVycm9yLCBudWxsLCA0KSwgdGhpcy5fdG9Eb2N1bWVudCgpKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0gZWxzZSB7CgkJCWRlbGV0ZSB0aGlzLl9fYXNzZXJ0RXJyb3I7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCglhc3luYyBzdG9yZSgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJzdG9yZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJzdG9yZSIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBzdG9yZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk5vZGVfR3JvdXBfTWVtYmVyLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5Ob2RlX0dyb3VwX01lbWJlcihudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuZ3JvdXAodGhpcy5ncm91cCgpLCAnPScpOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLm5vZGUodGhpcy5ub2RlKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKAoJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQl9CgkJCQkJCXJldHVybiByZXQ7CgkJCQkJfSkoc2FsZXNub3cpCgkJCQkpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMubmFtZSh0aGlzLm5hbWUoKSwgJz0nKTsKCQkJCX0KCgkJCQlpZiAoYkZpbmQpIHsKCQkJCQlfdGhpcyA9IGF3YWl0IF90aGlzLmZpbmQoKTsKCQkJCX0gZWxzZSBfdGhpcyA9IG51bGw7CgkJCQlpZiAoX3RoaXMpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiX3RoaXMuSWQiLCBfdGhpcy5JZCwgX3RoaXMuVG9vbC5uYW1lLCB0aGlzLlRvb2wubmFtZSk7CgkJCQkJdGhpcy5JZCA9IF90aGlzLklkOwoJCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQkJfSBlbHNlIHsKCQkJCQl0aGlzLklkID0gdGhpcy5JZDsgLy8gdG8gZW5mb3JjZSB0aGUgSWQgYW5kIG5vdCBnZXQgYSBuZXcgb25lIGV2ZXJ5IHRpbWUKCQkJCQliSW5zZXJ0ID0gdHJ1ZTsKCQkJCX0KCQkJfSBlbHNlIGlmIChNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgPCB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQWxyZWFkeSBzdG9yZWQiLCBNYXRoLmFicygodGhpcy5TZXRfT24uZ2V0VGltZSgpIC0gdGhpcy5fX3N5bmNfb24oKS5nZXRUaW1lKCkpIC8gMTAwMCkgKyAiPCIgKyB0aGlzLl9fY29uZmlnKCdzdG9yZS5zZW5zaXRpdml0eScsIDUpKTsKCQkJfSBlbHNlIHsKCQkJCS8vdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkdvaW5nIHRvIHVwZGF0ZSBbIiArIHRoaXMuSWQgKyAiXSIpOwoJCQkJYlVwZGF0ZSA9IHRydWU7CgkJCX0KCgkJCWlmICghYlVwZGF0ZSAmJiAhYkluc2VydCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIk5vIGRhdGEgY2hhbmdlcyIpOwoJCQl9IGVsc2UgewoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJaWYgKHR5cGVvZihzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uKSA9PT0gInVuZGVmaW5lZCIgfHwgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCQkJYXdhaXQgdGhpcy5fc3FsKGAke3RoaXMuX19jb25maWcoJ3R5cGUnKT09J3NxbGl0ZSc/J0JFR0lOJzonU1RBUlQnfSBUUkFOU0FDVElPTmApOwoJCQkJCQlzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uID0gewoJCQkJCQkJT3duZXI6IHRoaXMsCgkJCQkJCQlzcWxzOiBbXSwKCQkJCQkJCXN0YXJ0OiBuZXcgRGF0ZSgpLAoJCQkJCQkJZW5kOiBudWxsCgkJCQkJCX07CgkJCQkJfQoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgewoJCQkJCXRoaXMuYWN0aXZlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IHRydWU7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgewoJCQkJCXRoaXMuZW5hYmxlZCgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZGF0ZV9zZXQpIHsKCQkJCQl0aGlzLmRhdGUoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gbmV3IERhdGUoKTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fZ3JvdXBfc2V0ICYmIHRoaXMuZ3JvdXAoKSAmJiAhKGF3YWl0IHRoaXMuZ3JvdXAoKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9ncm91cCgpOwoKCQkJCQlpZiAodGhpcy5fbm9kZV9zZXQgJiYgdGhpcy5ub2RlKCkgJiYgIShhd2FpdCB0aGlzLm5vZGUoKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl9ub2RlKCk7CgoJCQkJfQoKCQkJCWlmICghdGhpcy5fX2Fzc2VydFZhbGlkKHRydWUpKSByZXR1cm4gbnVsbDsKCgkJCQkvL2F3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8gaW4gY2FzZSBUb29sIGNoYW5nZXMKCgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgQWJvdXQgdG8gSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9YCk7CgkJCQlpZiAoYlVwZGF0ZSkgYXdhaXQgdGhpcy51cGRhdGUoKTsKCQkJCWlmIChiSW5zZXJ0KSBhd2FpdCB0aGlzLmluc2VydCgpOwoJCQkJLy90aGlzLmxvZyh1bmRlZmluZWQsICdzdG9yZScsICdFbnRpdHlPYmplY3QnLCAwLCBgRmluaXNoZWQgSW5zZXJ0OiR7Ykluc2VydH0sIFVwZGF0ZToke2JVcGRhdGV9IElkPVske3RoaXMuSWR9XWApOwoKCQkJCWlmICh0aGlzLl9fY29uZmlnKCJTeW5jVHlwZWRBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCQlpZiAoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5Pd25lciA9PSB0aGlzKSB7CgkJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYENPTU1JVCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nIFRSQU5TQUNUSU9OJzonJ31gKTsKCQkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kID0gbmV3IERhdGUoKTsKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZV9Hcm91cF9NZW1iZXIuaW5zZXJ0Jyk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b0luc2VydFNRTCgpKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2luc2VydCcsICdFbnRpdHlPYmplY3QnLCAwLCAicmVzdWx0IiwgcmV0KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXRoaXMuX2Zyb21Eb2N1bWVudChhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCWxldCBvYmogPSB7fTsKCgkJCQlpZiAodGhpcy5fZ3JvdXBfc2V0KSB7CgoJCQkJCW9iai5ncm91cCA9IHRoaXMuX2dyb3VwLklkOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fbm9kZV9zZXQpIHsKCgkJCQkJb2JqLm5vZGUgPSB0aGlzLl9ub2RlLklkOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fYWN0aXZlX3NldCkgewoKCQkJCQlvYmouYWN0aXZlID0gdGhpcy5hY3RpdmUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2VuYWJsZWRfc2V0KSB7CgoJCQkJCW9iai5lbmFibGVkID0gdGhpcy5lbmFibGVkKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9jb2RlX3NldCkgewoKCQkJCQlvYmouY29kZSA9IHRoaXMuY29kZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fb3JkZXJfc2V0KSB7CgoJCQkJCW9iai5vcmRlciA9IHRoaXMub3JkZXIoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2RhdGVfc2V0KSB7CgoJCQkJCW9iai5kYXRlID0gdGhpcy5kYXRlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9uYW1lX3NldCkgewoKCQkJCQlvYmoubmFtZSA9IHRoaXMubmFtZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fcmVtYXJrX3NldCkgewoKCQkJCQlvYmoucmVtYXJrID0gdGhpcy5yZW1hcmsoKTsKCgkJCQl9CgoJCQkJbG9nKCJTZW5kaW5nIHRvIFNGIiwgb2JqKTsKCgkJCQlsZXQgcmVzID0gYXdhaXQgdGhpcy5Ub29sLmRiLnNvYmplY3QoIk5vZGVfR3JvdXBfTWVtYmVyIikuY3JlYXRlKG9iaik7CgkJCQl0aGlzLklkID0gcmVzLmlkOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZV9Hcm91cF9NZW1iZXIudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlX0dyb3VwX01lbWJlci5maW5kQWxsJyk7CgoJCQkvLyBhdm9pZHMgY3ljbGljIHF1ZXJpZXMKCQkJb2JqcyA9IChvYmpzIHx8IFtdKS5tYXAobyA9PiBvLl9jbG9uZSgpKTsKCgkJCWF3YWl0IHRoaXMuX3N0b3JlRW50aXR5Q2xhc3MoKTsgLy8/PwoKCQkJbGV0IHJldCA9IFtdOyAvLyBhIGpzb24gYXJyYXkKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoZmllbGRzLCBvYmpzKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIHsKCQkJCQlzeXNwYXJtX3F1ZXJ5OiBPYmplY3QuZW50cmllcyh0aGlzLl90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSkubWFwKHAgPT4gYCR7cFswXX0ke3BbMV19YCkuam9pbigiXiIpCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgbnVsbCwgdGhpcy5fdG9TRlF1ZXJ5KGZpZWxkcywgb2JqcywgdHJ1ZSksIG51bGwsIHsKCQkJCQl1cmw6ICdyZXN0LnVybC5ncWwnCgkJCQl9KTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgKTsKCQkJCXJldCA9IHJldC5jb250ZW50ID8gW0pTT04ucGFyc2UodGhpcy5fYXRvYihyZXQuY29udGVudCkpXSA6IFtdOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZmluZEFsbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiQmVmb3JlIF9mcm9tRG9jdW1lbnQoKSIsIHJldCk7CgoJCQlyZXQgPSByZXQubWFwKHIgPT4gbmV3IHNhbGVzbm93Lk5vZGVfR3JvdXBfTWVtYmVyKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuTm9kZV9UeXBlID0gY2xhc3MgTm9kZV9UeXBlIGV4dGVuZHMgc2FsZXNub3cuR2VuZXJpY1NlcnZpY2VBUEkgewoJY29uc3RydWN0b3IoaWQsIHRvb2wpIHsKCQlzdXBlcihpZCwgdG9vbCk7CgoJCXRoaXMuU2NvcGUgPSAic2FsZXNub3ciOwoJCXRoaXMuRGVidWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpqY21sMGFXTmhiQ0k2SWlvaUxDSmxjbkp2Y2lJNklpb2lMQ0ozWVhKdUlqb2lLaUlzSW1sdVptOGlPaUlxTG1sdWFYUXNLaTVmY21WemRDd3FMbDlzYjJGa1ZHOXZiSE1pZlE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuQ29uZmlnID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKT2IyUmxJanA3SW01dlJHVjBaV04wSWpwMGNuVmxMQ0pwYm1sMExtVnVaSE1pT2pJc0ltbHVhWFF1Ykc5dmNDSTZNQzQxTENKMGIyOXNjeTV6ZEc5eVpTSTZabUZzYzJVc0ltUmxkR1ZqZEZCaGNtVnVkQzVKVUNJNklqRTRNaTR4TmpndU56QXVPRElpTENKa1pYUmxZM1JRWVhKbGJuUXVZMjlrWlNJNkltVTRaR1V3Tm1VelpXUmpORFF6WVdVNVpHWmxNV1JsTldWak5USmhOR0ptSWl3aWMyVmpjbVYwSWpvaWIxTkxkMmRhTW5OTFJrOVVTVXBqWWtGbVZVbFJORU5xT1hGelNEUTRibXdpTENKd2JHRjVaM0p2ZFc1a0lqcDBjblZsTENKblVsQkRJanAwY25WbExDSnpkRzl5WlM1elpXNXphWFJwZG1sMGVTSTZNU3dpWTI5dGNHRnVlU0k2SW5KbGMzVnRaU0o5TENKRmRtVnVkQ0k2ZXlKMGNtbG5aMlZ5TG5ScGJXVnZkWFFpT2pFd01EQXdMQ0p6WldOeVpYUWlPaUp2VTB0M1oxb3ljMHRHVDFSSlNtTmlRV1pWU1ZFMFEybzVjWE5JTkRodWJDSXNJbkJzWVhsbmNtOTFibVFpT25SeWRXVXNJbWRTVUVNaU9uUnlkV1VzSW5OMGIzSmxMbk5sYm5OcGRHbDJhWFI1SWpveExDSmpiMjF3WVc1NUlqb2ljbVZ6ZFcxbEluMHNJbFJ2YjJ3aU9uc2laMmwwYUhWaUxuUnZiMnh6SWpvaWFIUjBjSE02THk5eVlYY3VaMmwwYUhWaWRYTmxjbU52Ym5SbGJuUXVZMjl0TDJaaFpHbHVMMlpoWkdsdUxtZHBkR2gxWWk1cGJ5OXRZWE4wWlhJdklpd2ljMlZqY21WMElqb2liMU5MZDJkYU1uTkxSazlVU1VwallrRm1WVWxSTkVOcU9YRnpTRFE0Ym13aUxDSndiR0Y1WjNKdmRXNWtJanAwY25WbExDSm5VbEJESWpwMGNuVmxMQ0p6ZEc5eVpTNXpaVzV6YVhScGRtbDBlU0k2TVN3aVkyOXRjR0Z1ZVNJNkluSmxjM1Z0WlNKOUxDSnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuVGVzdCA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SlZjMlZ5SWpwN0lsOWhkWFJvYjNKcGVtVXVkWE5sY201aGJXVWlPaUptWVdScElpd2lYMkYxZEdodmNtbDZaUzV3WVhOemQyOXlaQ0k2SWpFeU15SXNJbDloZFhSb2IzSnBlbVV1ZEdWemRGVnpaWElpT25zaVlXTjBhWFpsSWpwMGNuVmxMQ0psYm1GaWJHVmtJanAwY25WbExDSm5aVzVrWlhJaU9uc2lZMjlrWlNJNklrMGlMQ0p1WVcxbElqb2lUV0ZzWlNKOUxDSmpiMlJsSWpvaVptRmthU0lzSW01aGJXVWlPaUpHWVdScEluMTlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Ub29scyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFd5SlRjV3hFUWlJc2V5SnVZVzFsSWpvaVUwNVBWMDlQUWlJc0luUjVjR1VpT25zaWJtRnRaU0k2SWxObGNuWnBZMlZPYjNjaWZYMHNJbE5oYkdWelJtOXlZMlVpTENKSGFYUklkV0lpWFE9PWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pOwoJCXRoaXMuTWFwcGluZ3MgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBXMTA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgoJCS8vIGF2b2lkIHN1cGVyLCBrZWVwIHRoaXMgaGVyZQoJCXRoaXMuX19JRCA9IHRoaXMuX19JRCB8fCB7fTsKCQl0aGlzLlRvb2wgPSB0b29sOwoJCXRoaXMuSWQgPSBpZDsKCgkJdGhpcy5WYWx1ZUVudGl0aWVzID0gW107CgoJCXRoaXMuRGF0ZSA9IG51bGw7CgoJCXRoaXMuY2xlYXJfVEhJUygpOwoJCXRoaXMuRW50aXR5VmFsdWVzID0gW107CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZHluYW1pYyIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZHluYW1pYygpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImFjdGl2ZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfYWN0aXZlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiZW5hYmxlZCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfZW5hYmxlZCgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvZGUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvZGUoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJkYXRlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9kYXRlKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAibmFtZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfbmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInJlbWFyayIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfcmVtYXJrKCk7CgoJCXRoaXMuY2xlYXJfdHlwZV9Ob2RlcygpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIk5vZGUgVHlwZSIsCgkJCU9QRVJBVE9SUzogewoJCQkJTmFtZTogIj0iCgkJCX0sCgkJfTsKCgkJLy8gdGhhdCdzIHdoeSB3ZSBuZWVkIGl0IGFzIGEgZ2V0dGVyCgkJaWYgKCFOdW1iZXIoZWMuSWQpICYmIHNhbGVzbm93LkVudGl0eUNsYXNzZXMpIHsKCQkJbGV0IGNpZCA9IHNhbGVzbm93LkVudGl0eUNsYXNzZXMuZmluZChjID0+IE51bWJlcihjLklkKSAmJiBjLk5hbWUgPT0gZWMuTmFtZSk7CgkJCWlmIChjaWQpIGVjLklkID0gY2lkLklkOwoJCX0KCQlyZXR1cm4gZWM7Cgl9CgoJZ2V0IElkKCkgewoJCXJldHVybiB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdIHx8IHRoaXMuX3V1aWQoKTsKCX0KCglzZXQgSWQoaWQpIHsKCQlpZiAoIXRoaXMuVG9vbCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgSWQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFRvb2wiLCB0aGlzLlRvb2xzLmxlbmd0aCwgc2FsZXNub3cuVG9vbHMubGVuZ3RoKTsKCQkJcmV0dXJuOwoJCX0KCQl0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdID0gaWQ7Cgl9CgoJZ2V0IFRvb2woKSB7CgkJaWYgKHR5cGVvZih0aGlzLl9fVG9vbCkgIT09ICd1bmRlZmluZWQnKSByZXR1cm4gdGhpcy5fX1Rvb2w7CgkJbGV0IG5vVG9vbCA9IHsKCQkJbmFtZTogJycsCgkJCXR5cGU6IHsKCQkJCW5hbWU6ICcnCgkJCX0sCgkJfTsKCQlpZiAodHlwZW9mKHNhbGVzbm93LlRvb2xzKSAhPT0gInVuZGVmaW5lZCIgJiYgIUFycmF5LmlzQXJyYXkoc2FsZXNub3cuVG9vbHMpKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2dldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDIsICJzYWxlc25vdy5Ub29scyBpcyBub3QgYW4gYXJyYXk6ICIsIHNhbGVzbm93LlRvb2xzKTsKCQkJcmV0dXJuIG5vVG9vbDsKCQl9CgkJbGV0IHJldCA9IHRoaXMuVG9vbHMuZmluZCh0ID0+IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmluZChfdCA9PiB0ID09IF90Lm5hbWUgfHwgdC5uYW1lID09IF90Lm5hbWUpKTsKCQlpZiAodHlwZW9mKHJldCkgIT09ICd1bmRlZmluZWQnKSByZXQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQodCA9PiB0Lm5hbWUgPT0gcmV0IHx8IHQubmFtZSA9PSByZXQubmFtZSk7CgkJaWYgKHR5cGVvZihyZXQpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIG5vVG9vbDsKCQlyZXR1cm4gcmV0OwoJfQoKCXNldCBUb29sKHRvb2wpIHsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCWlmICh0eXBlb2YodG9vbCkgPT09ICJzdHJpbmciKSB7CgkJCXRvb2wgPSB7CgkJCQluYW1lOiB0b29sCgkJCX07CgkJfQoJCWlmICh0b29sLkVudGl0eUNsYXNzKSB7CgkJCXRvb2wgPSB0b29sLl90b0RvY3VtZW50KCk7CgkJfQoJCWlmICh0eXBlb2YodG9vbC5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcgJiYgdHlwZW9mKHRvb2wudHlwZS5uYW1lKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQl0b29sLnR5cGUgPSB0b29sLnR5cGUgfHwgewoJCQluYW1lOiB0b29sLm5hbWUKCQl9OwoKCQlpZiAoIXRvb2wudHlwZSAmJiAhdG9vbC5uYW1lKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJFbXB0eSBUb29sIG9iamVjdCIpOwoJCQlyZXR1cm47CgkJfQoKCQlsZXQgdCA9IChzYWxlc25vdy5Ub29scyB8fCBbXSkuZmlsdGVyKHQgPT4gdC5uYW1lICYmIHQudHlwZSkuZmluZCh0ID0+ICh0Lm5hbWUgPT0gdG9vbC5uYW1lKSB8fCAodC50eXBlLm5hbWUgPT0gdG9vbC50eXBlLm5hbWUpKTsKCQlpZiAoIXQpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IFRvb2wnLCAnRW50aXR5T2JqZWN0JywgMCwgIm5vIG1hdGNoaW5nIHRvb2wiLCB0b29sLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybjsKCQl9CgoJCXRoaXMuX19Ub29sID0gdDsKCgkJLy8gKHRoaXMudHlwZV9Ob2RlcygpIHx8IFtdKS5mb3JFYWNoKHQgPT4gdC5Ub29sID0gdG9vbCk7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBkeW5hbWljICoqLwoJZHluYW1pYyh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2R5bmFtaWNfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJkeW5hbWljIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZHluYW1pYyAhPSB2KSB7CgkJCQl0aGlzLl9keW5hbWljX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9keW5hbWljID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9keW5hbWljKTsKCQl9Cgl9CgoJY2xlYXJfZHluYW1pYygpIHsKCQl0aGlzLl9keW5hbWljX3NldCA9IG51bGw7CgkJdGhpcy5fZHluYW1pYyA9IG51bGw7CgkJdGhpcy5fZHluYW1pY19jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZHluYW1pYyAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGFjdGl2ZSAqKi8KCWFjdGl2ZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2FjdGl2ZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImFjdGl2ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2FjdGl2ZSAhPSB2KSB7CgkJCQl0aGlzLl9hY3RpdmVfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX2FjdGl2ZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fYWN0aXZlKTsKCQl9Cgl9CgoJY2xlYXJfYWN0aXZlKCkgewoJCXRoaXMuX2FjdGl2ZV9zZXQgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZSA9IG51bGw7CgkJdGhpcy5fYWN0aXZlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBlbmFibGVkICoqLwoJZW5hYmxlZCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2VuYWJsZWRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJlbmFibGVkIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJX3YgPSBbInRydWUiLCAiMSIsICJ5ZXMiLCB0cnVlLCAxXS5pbmNsdWRlcyhfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5Cb29sVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZW5hYmxlZCAhPSB2KSB7CgkJCQl0aGlzLl9lbmFibGVkX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9lbmFibGVkID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuQm9vbFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9lbmFibGVkKTsKCQl9Cgl9CgoJY2xlYXJfZW5hYmxlZCgpIHsKCQl0aGlzLl9lbmFibGVkX3NldCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZCA9IG51bGw7CgkJdGhpcy5fZW5hYmxlZF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvZGUgKiovCgljb2RlKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29kZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvZGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvZGUgIT0gdikgewoJCQkJdGhpcy5fY29kZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29kZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb2RlKTsKCQl9Cgl9CgoJY2xlYXJfY29kZSgpIHsKCQl0aGlzLl9jb2RlX3NldCA9IG51bGw7CgkJdGhpcy5fY29kZSA9IG51bGw7CgkJdGhpcy5fY29kZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29kZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoJb3JkZXIodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vcmRlcl9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm9yZGVyIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKGlzTmFOKF92KSkgX3YgPSAwOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuSW50VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3JkZXIgIT0gdikgewoJCQkJdGhpcy5fb3JkZXJfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29yZGVyID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuSW50VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29yZGVyKTsKCQl9Cgl9CgoJY2xlYXJfb3JkZXIoKSB7CgkJdGhpcy5fb3JkZXJfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcmRlciA9IG51bGw7CgkJdGhpcy5fb3JkZXJfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9yZGVyICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCWRhdGUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9kYXRlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZGF0ZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gT2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKF92KSA9PT0gJ1tvYmplY3QgRGF0ZV0nID8gX3YgOiAobmV3IERhdGUoX3YpKTsKCQkJCWlmIChpc05hTihfdi5nZXRUaW1lKCkpKSBfdiA9IG51bGw7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5EYXRlVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fZGF0ZSAhPSB2KSB7CgkJCQl0aGlzLl9kYXRlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9kYXRlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRGF0ZVZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9kYXRlKTsKCQl9Cgl9CgoJY2xlYXJfZGF0ZSgpIHsKCQl0aGlzLl9kYXRlX3NldCA9IG51bGw7CgkJdGhpcy5fZGF0ZSA9IG51bGw7CgkJdGhpcy5fZGF0ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZGF0ZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG5hbWUgKiovCgluYW1lKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fbmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoIm5hbWUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX25hbWUgIT0gdikgewoJCQkJdGhpcy5fbmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fbmFtZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9uYW1lKTsKCQl9Cgl9CgoJY2xlYXJfbmFtZSgpIHsKCQl0aGlzLl9uYW1lX3NldCA9IG51bGw7CgkJdGhpcy5fbmFtZSA9IG51bGw7CgkJdGhpcy5fbmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgbmFtZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCXJlbWFyayh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3JlbWFya19jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInJlbWFyayIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmICh0eXBlb2YoX3YpID09PSAnb2JqZWN0JykgX3YgPSBKU09OLnN0cmluZ2lmeShfdik7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5UZXh0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fcmVtYXJrICE9IHYpIHsKCQkJCXRoaXMuX3JlbWFya19zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fcmVtYXJrID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuVGV4dFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9yZW1hcmspOwoJCX0KCX0KCgljbGVhcl9yZW1hcmsoKSB7CgkJdGhpcy5fcmVtYXJrX3NldCA9IG51bGw7CgkJdGhpcy5fcmVtYXJrID0gbnVsbDsKCQl0aGlzLl9yZW1hcmtfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHJlbWFyayAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHR5cGVfTm9kZXMgKiovCgl0eXBlX05vZGVzKHYsIGNvKSB7CgkJaWYgKHR5cGVvZih2KSA9PT0gInVuZGVmaW5lZCIpIHJldHVybiB0aGlzLl90eXBlX05vZGVzOwoKCQlpZiAodiAmJiB2LnRvRW50aXR5T2JqZWN0ICYmIHYuRW50aXR5Q2xhc3MuSWQgIT09ICc5ZTJhMGQ3MC05YTFiLTQ3NjItYTlkYi0wNjBlNjU3OTVjODknICYmIHYuRW50aXR5Q2xhc3MuTmFtZSAhPT0gJ05vZGUnKSByZXR1cm4gdGhpczsKCgkJdiA9IEFycmF5LmlzQXJyYXkodikgPyB2IDogW3ZdOwoKCQl2LmZpbHRlcihfdiA9PiBfdiAmJiAhX3YuX3R5cGVfc2V0KS5mb3JFYWNoKF92ID0+IHsKCQkJaWYgKCFfdi5jb25zdHJ1Y3RvcikgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndHlwZV9Ob2RlcycsICdFbnRpdHlPYmplY3QnLCAxLCAidHlwZSBoYXMgbm8gY29uc3RydWN0b3IiLCBfdik7CgkJCX0gZWxzZSBpZiAoX3YuY29uc3RydWN0b3IubmFtZSAhPSAiTm9kZSIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3R5cGVfTm9kZXMnLCAnRW50aXR5T2JqZWN0JywgMSwgInR5cGUgbm90IHZhbGlkIiwgX3YsIF92LmNvbnN0cnVjdG9yLm5hbWUsICJOb2RlIik7CgkJCX0gZWxzZSBpZiAodHJ1ZSB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCB8fCBfdi5fX3N5bmNfb24oKSB8fCBfdi5JZCA9PSBfdi5JZCkgeyAvLyBleHBlcmltZW50YWwgY29uZGl0aW9uLCB3YXMgYWx3YXlzIHRydWUKCQkJCV92LnR5cGUodGhpcyk7CgkJCX0KCQl9KTsKCgkJdGhpcy5fdHlwZV9Ob2Rlcy5wdXNoKC4uLnYpOwoJCXRoaXMuX3R5cGVfTm9kZXNfc2V0ID0gbmV3IERhdGUoKTsKCQlpZiAoY28pIHRoaXMuX3R5cGVfTm9kZXNfY29vcCA9IGNvOwoKCQlyZXR1cm4gdGhpczsKCX0KCWNsZWFyX3R5cGVfTm9kZXMoKSB7CgkJdGhpcy5fdHlwZV9Ob2Rlc19zZXQgPSBudWxsOwoJCXRoaXMuX3R5cGVfTm9kZXMgPSBuZXcgQXJyYXkoKTsKCQl0aGlzLl90eXBlX05vZGVzX2Nvb3AgPSBudWxsOwoJCXJldHVybiB0aGlzOwoJfQoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdHlwZV9Ob2RlcyAqKi8KCglnZXQgU2V0X09uKCkgewoJCWxldCByZXQgPSBuZXcgRGF0ZShNYXRoLm1heCgKCgkJCXRoaXMuX2R5bmFtaWNfc2V0LAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fY29kZV9zZXQsCgoJCQl0aGlzLl9vcmRlcl9zZXQsCgoJCQl0aGlzLl9kYXRlX3NldCwKCgkJCXRoaXMuX25hbWVfc2V0LAoKCQkJdGhpcy5fcmVtYXJrX3NldCwKCgkJCXRoaXMuX3R5cGVfTm9kZXNfc2V0LAoKCQkpKTsKCgkJaWYgKCFyZXQgfHwgIShyZXQgaW5zdGFuY2VvZiBEYXRlICYmICFpc05hTihyZXQpKSkgcmV0dXJuIHVuZGVmaW5lZDsKCQlyZXR1cm4gcmV0OwoJfQoKCV9mbGF0dGVuKGRlcHRoKSB7CgkJbGV0IHJldCA9IHt9OwoJCWlmICghZGVwdGgpIHJldHVybiByZXQ7CgoJCXJldC5fZHluYW1pY19zZXQgPSB0aGlzLl9keW5hbWljX3NldDsKCQlyZXQuX2R5bmFtaWNfY29vcCA9IHRoaXMuX2R5bmFtaWNfY29vcDsKCQlyZXQuZHluYW1pYyA9IHRoaXMuZHluYW1pYygpID8gdGhpcy5keW5hbWljKCkgOiB0aGlzLmR5bmFtaWMoKTsKCgkJcmV0Ll9hY3RpdmVfc2V0ID0gdGhpcy5fYWN0aXZlX3NldDsKCQlyZXQuX2FjdGl2ZV9jb29wID0gdGhpcy5fYWN0aXZlX2Nvb3A7CgkJcmV0LmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCkgPyB0aGlzLmFjdGl2ZSgpIDogdGhpcy5hY3RpdmUoKTsKCgkJcmV0Ll9lbmFibGVkX3NldCA9IHRoaXMuX2VuYWJsZWRfc2V0OwoJCXJldC5fZW5hYmxlZF9jb29wID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCXJldC5lbmFibGVkID0gdGhpcy5lbmFibGVkKCkgPyB0aGlzLmVuYWJsZWQoKSA6IHRoaXMuZW5hYmxlZCgpOwoKCQlyZXQuX2NvZGVfc2V0ID0gdGhpcy5fY29kZV9zZXQ7CgkJcmV0Ll9jb2RlX2Nvb3AgPSB0aGlzLl9jb2RlX2Nvb3A7CgkJcmV0LmNvZGUgPSB0aGlzLmNvZGUoKSA/IHRoaXMuY29kZSgpIDogdGhpcy5jb2RlKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2RhdGVfc2V0ID0gdGhpcy5fZGF0ZV9zZXQ7CgkJcmV0Ll9kYXRlX2Nvb3AgPSB0aGlzLl9kYXRlX2Nvb3A7CgkJcmV0LmRhdGUgPSB0aGlzLmRhdGUoKSA/IHRoaXMuZGF0ZSgpIDogdGhpcy5kYXRlKCk7CgoJCXJldC5fbmFtZV9zZXQgPSB0aGlzLl9uYW1lX3NldDsKCQlyZXQuX25hbWVfY29vcCA9IHRoaXMuX25hbWVfY29vcDsKCQlyZXQubmFtZSA9IHRoaXMubmFtZSgpID8gdGhpcy5uYW1lKCkgOiB0aGlzLm5hbWUoKTsKCgkJcmV0Ll9yZW1hcmtfc2V0ID0gdGhpcy5fcmVtYXJrX3NldDsKCQlyZXQuX3JlbWFya19jb29wID0gdGhpcy5fcmVtYXJrX2Nvb3A7CgkJcmV0LnJlbWFyayA9IHRoaXMucmVtYXJrKCkgPyB0aGlzLnJlbWFyaygpIDogdGhpcy5yZW1hcmsoKTsKCgkJcmV0LnR5cGVfTm9kZXMgPSB0aGlzLnR5cGVfTm9kZXMoKS5tYXAodCA9PiB0ID8gdC5fZmxhdHRlbihkZXB0aCAtIDEpIDogdCk7CgoJCXJldHVybiByZXQ7Cgl9CgoJX3RvSGFzaChhcmdzLCBvcHRpb25zKSB7CgkJb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkJb3B0aW9ucy5jYWNoZUxpbWl0ID0gb3B0aW9ucy5jYWNoZUxpbWl0IHx8IDU7CgoJCWxldCBvSGFzaCA9IHsKCQkJYXJnczogYXJncywKCQkJX3RoaXM6IHt9IC8vIHRoaXMuX3BydW5lKHRoaXMpIGRvZXMgbm90IHdvcmsgYmVjYXVzZSBJZCBpcyBub3QgZXhjbHVkZWQgZm9yIHF1ZXJpZXM7IHRoaXMuX3BydW5lKHRoaXMuX3RvRG9jdW1lbnQoKSkgY3JlYXRlcyBjaXJjdWxhcnMKCQl9OwoKCQlpZiAodHJ1ZSB8fCBvcHRpb25zLmRlcHRoKSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fZmxhdHRlbihvcHRpb25zLmRlcHRoIHx8IDMpOwoJCX0gZWxzZSB7CgkJCW9IYXNoLl90aGlzID0gdGhpcy5fX2V4cG9ydChvSGFzaC5fdGhpcywgewoJCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5JZCA9IHYsCgoJCQkJImR5bmFtaWMiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZHluYW1pYycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJjb2RlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCXR5cGVfTm9kZXM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlX05vZGVfVHlwZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJb2JqW2VhQ29kZV0gPSAodiB8fCBbXSkubWFwKF92ID0+IHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSBfdikgOiBudWxsOwoJCQkJCQlsZXQgcmV0ID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyBfdi5fdG9IYXNoKG51bGwsIG9wdGlvbnMpIDogbnVsbCk7CgkJCQkJCWlmIChvcHRpb25zLmNhY2hlICYmICFoKSBvcHRpb25zLmNhY2hlLnB1c2goewoJCQkJCQkJb2JqOiB2LAoJCQkJCQkJaGFzaDogcmV0CgkJCQkJCX0pOwoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pOwoJCQkJfSwKCgkJCX0sICJfdG9IYXNoIik7CgkJfQoKCQlyZXR1cm4gb3B0aW9ucy5Ob0NvZGUgPyBvSGFzaCA6IHRoaXMuaGFzaENvZGUoSlNPTi5zdHJpbmdpZnkob0hhc2gpKTsKCX0KCglhc3luYyBfYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcikgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fYXV0aG9yaXplKHVzZXJuYW1lLCBwYXNzd29yZCwgYlNlcnZlcik7CgoJfQoKCV9xbFNlbGVjdGlvbnMoc1NldCkgewoJCWxldCByZXQgPSBbXTsKCQlpZiAoIXNTZXQgfHwgIXNTZXQuc2VsZWN0aW9ucykgcmV0dXJuIHJldDsKCgkJc1NldC5zZWxlY3Rpb25zLmZpbHRlcihzID0+IHMuc2VsZWN0aW9uU2V0KS5mb3JFYWNoKHMgPT4gewoKCQl9KTsKCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KSB7CgkJLy8gaWYoIW4pIHJldHVybiBudWxsOwoKCQlpZiAodHlwZW9mKHNhbGVzbm93Ll9ub2RlKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgInNhbGVzbm93Ll9ub2RlIG5vdCBkZWZpbmVkIik7CgkJCXJldHVybiBudWxsOwoJCX0KCgkJaWYgKGV2ZW50KSB7CgoJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQgJiYgZXZlbnQuY2xhc3NOYW1lKCkgJiYgZXZlbnQuY2xhc3NOYW1lKCkgIT0gJ05vZGVfVHlwZScpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJEZWxlZ2F0aW5nIGludm9rYXRpb24gdG8gIiArIGV2ZW50LmNsYXNzTmFtZSgpKTsKCQkJCXJldHVybiBuZXcgc2FsZXNub3dbZXZlbnQuY2xhc3NOYW1lKCldKCkuX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdyk7CgkJCX0KCgkJfQoKCQlsZXQgcmV0ID0gbnVsbDsKCgkJZGF0YSA9IGRhdGEgfHwge307CgoJCWlmICh0eXBlb2YoZGF0YSkgPT09ICJvYmplY3QiKSB7CgkJCWRhdGEuX190aGlzID0gZGF0YS5fX3RoaXMgfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJfQoJCX0KCgkJaWYgKCFuIHx8IHNhbGVzbm93Ll9ub2RlLl9zYW1lTm9kZShuKSkgewoJCQkvLyB0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQ2FsbGJhY2siKTsKCQkJcmV0ID0gYXdhaXQgdGhpcy5faW52b2tlKG1ldGhvZCwgZGF0YSk7CgkJfSBlbHNlIGlmIChuLmFkZHJlc3MoKSAmJiBuLl9zYW1lTm9kZShuKSAvKmFjdHVhbCBub2RlKi8gKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIG4uX2FkZHJlc3MsIG4uX3BvcnQsIG1ldGhvZCk7CgkJCXRyeSB7CgkJCQlsZXQgY29uZmlnID0gewoJCQkJCWhlYWRlcnM6IHt9LAoJCQkJfTsKCQkJCWlmIChzYWxlc25vdy5fX3Rva2VuKSBjb25maWcuaGVhZGVycy5BdXRob3JpemF0aW9uID0gYCR7c2FsZXNub3cuX190b2tlbi50b2tlbl90eXBlfSAke3NhbGVzbm93Ll9fdG9rZW4uYWNjZXNzX3Rva2VufWA7CgkJCQlyZXQgPSBhd2FpdCBheGlvcy5wb3N0KGBodHRwJHtuLnNlY3VyZSgpPydzJzonJ306Ly8ke24uYWRkcmVzcygpfToke24ucG9ydCgpIHx8IDMwMDB9L21ldGhvZC9Ob2RlX1R5cGUvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQkJZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOwoJCQkJZGVsZXRlIGRhdGEuX190aGlzLm9ubGluZTsKCgkJCX0KCgkJCS8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/PwoKCQkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJCXRyeSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0pIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7bWV0aG9kfWApOwoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCWxldCBfaWQgPSBudWxsOwoJCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBkYXRhLCBtZXRob2QsIHt9KTsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRhdGEpID09PSAnc3RyaW5nJykgewoJCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUoZGF0YSk7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IGRhdGEuX190aGlzLmNvZGUgfHwgZGF0YS5pZCB8fCBkYXRhLklEOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJCWlmIChkYXRhLklkICYmIGRhdGEuSWQgPT0gZGF0YS5JZCkgewoJCQkJCQlfaWQgPSBkYXRhLklkOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQkJfSBlbHNlIGlmIChkYXRhLkVudGl0eUNsYXNzKSB7CgkJCQkJCV9pZCA9IGRhdGEuRW50aXR5Q2xhc3MuSWQgfHwgZGF0YS5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjFiYWZhYTdjLTdkMjEtNDUwYS05Y2M0LThjOTZjMjIwZDFlNCIgfHwgIk5VTEwiOwoJCQkJCX0KCQkJCX0KCgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGUgfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfVHlwZVttZXRob2RdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGVbbWV0aG9kXSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW21ldGhvZF1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW21ldGhvZF1bX2lkXSB8fCB7fTsKCgkJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goe30sIHsKCQkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQkJfSk7CgoJCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW21ldGhvZF1bX2lkXVtfaGFzaF07CgkJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDUpKSB7CgkJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihtZXRob2QpID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBtZXRob2QiLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEsIHYpOwoJCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQkJdi5yZXVzZWQrKzsKCQkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9CgoJCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJCV9pZDogdi5vYmouX2lkCgkJCQkJfSA6IHYub2JqOwoJCQkJCXJldHVybiB2Lm9iajsKCgkJCQl9CgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBtZXRob2QsIGRhdGEpOwoJCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGVbbWV0aG9kXVtfaWRdW19oYXNoXSA9IHsKCQkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCQlhcmdzOiBKU09OLnN0cmluZ2lmeSh7fSksCgkJCQkJb2JqOiBkYXRhLAoJCQkJCXJldXNlZDogMCwKCQkJCX07CgkJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnRbbWV0aG9kXSA9IHRydWU7CgkJCQl9CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgZGF0YSwgbWV0aG9kLCB7fSwgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQkJX2lkOiB2Lm9iai5faWQKCQkJCX0gOiB2Lm9iajsKCQkJCXJldHVybiB2Lm9iajsKCgkJCX0KCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBUcmlnZ2VycmluZyAke21ldGhvZH0gdG8gJHtuLmNvZGUoKX0gJHtKU09OLnN0cmluZ2lmeShkYXRhLG51bGwsNCl9YCk7CgoJCQlsZXQgZXYgPSBuZXcgc2FsZXNub3cuRXZlbnQoKS5hY3RpdmUodHJ1ZSkuZW5hYmxlZCh0cnVlKS5jb2RlKHRoaXMuX3V1aWQoKSkubmFtZSh0aGlzLl9fY29uZmlnKCdldmVudCcpIHx8ICdzYWxlc25vdy5FdmVudCcpLmRhdGUodGhpcy5zZXJ2ZXJEYXRlKCkpLnJlY2lwaWVudChuKS5tZXRob2QobWV0aG9kKS5jbGFzc05hbWUoJ05vZGVfVHlwZScpLnNlbmRlcihzYWxlc25vdy5fbm9kZSkuY2FycmllcihzYWxlc25vdy5fbm9kZSkucGF5bG9hZChkYXRhKTsKCQkJaWYgKGV2ZW50KSB7CgkJCQlpZiAoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7CgkJCQlpZiAoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7CgkJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7CgkJCQlpZiAoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7CgkJCX0KCQkJcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOwoKCQkJaWYgKHR5cGVvZihyZXQpID09PSAic3RyaW5nIikgewoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChleCkge30KCQkJfQoJCQlyZXR1cm4gcmV0OwoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93Lk5vZGVfVHlwZShudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQocmV0KTsKCQkJCWJyZWFrOwoJCQl9CgkJCWNhc2UgImZpbmRBbGwiOiB7CgkJCQlpZiAocmV0ICYmICFBcnJheS5pc0FycmF5KHJldCkpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTm90IGFuIEFycmF5IGluIEZpbmRBbGwiLCByZXQpOwoJCQkJCXJldCA9IFtyZXRdOwoJCQkJfQoJCQkJaWYgKCFiUmF3ICYmIHJldC5tYXApIHJldCA9IHJldC5tYXAocCA9PiBuZXcgc2FsZXNub3cuTm9kZV9UeXBlKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChwKSk7CgkJCQlicmVhazsKCQkJfQoKCQkJZGVmYXVsdDoge30KCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZShtZXRob2QsIGJvZHksIHF1ZXJ5LCBhdXRoT2JqKSB7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBtZXRob2QsIHF1ZXJ5LCBib2R5KTsKCgkJaWYgKHR5cGVvZihib2R5KSA9PT0gJ3N0cmluZycgfHwgKHR5cGVvZihCdWZmZXIpICE9PSAndW5kZWZpbmVkJyAmJiBCdWZmZXIuaXNCdWZmZXIoYm9keSkpKSB7CgkJCXRyeSB7CgkJCQlib2R5ID0gSlNPTi5wYXJzZShib2R5LnRvU3RyaW5nKCkpOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCAiQm9keSBpcyBub3QgYSB2YWxpZCBKU09OIiwgYm9keSk7CgkJCQlyZXR1cm47CgkJCX0KCQl9CgoJCWxldCBfcGFyYW1zID0gcXVlcnkgPyBPYmplY3QuYXNzaWduKHF1ZXJ5LCBib2R5KSA6IGJvZHk7CgkJaWYgKHR5cGVvZihfcGFyYW1zKSA9PT0gJ3N0cmluZycpIF9wYXJhbXMgPSBKU09OLnBhcnNlKF9wYXJhbXMpOwoKCQlpZiAoX3BhcmFtcykgewoJCQlfcGFyYW1zID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zKTsKCQl9IGVsc2UgewoJCQlfcGFyYW1zID0ge307CgkJfQoKCQlpZiAodHlwZW9mKEZsYXR0ZWQpICE9PSAidW5kZWZpbmVkIiAmJiBfcGFyYW1zLl9fZmxhdHRlZCkgX3BhcmFtcyA9IEZsYXR0ZWQucGFyc2UoX3BhcmFtcy5fX2ZsYXR0ZWQpOwoKCQlpZiAoX3BhcmFtcy5fX25vZGUpIHsKCQkJLy8gcHJvYmFibHkgc2hvdWxkIG5vdCBiZSBwcm9jZXNzZWQgaGVyZSwgYnV0IHJhdGhlciBjb25zdW1lZCBhcyBwYXJ0IG9mIHRoZSBleGVjdXRlKCkgbG9naWMsIHB1c2hpbmcgX19ub2RlIHRvIHRoZSBsaXN0IG9mIG15IG5vZGVzIHRvIGRlbGVnYXRlIHRvIT8KCQkJbGV0IHRuID0gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF9wYXJhbXMuX19ub2RlKS5fZGVSZWZlcmVuY2UoKTsKCQkJZGVsZXRlIF9wYXJhbXMuX19ub2RlOwoJCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93Lk5vZGVfVHlwZSgpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOwoJCX0KCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgTm9kZV9UeXBlLl9pbnZva2U6IG9iaiBpcyB1bmRlZmluZWRgCgkJCQl9CgkJCX07CgkJfSBlbHNlIGlmICghb2JqW21ldGhvZF0pIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTInOiBgTm9kZV9UeXBlLl9pbnZva2U6IG1ldGhvZCAke29iai5jb25zdHJ1Y3Rvci5uYW1lfSgke21ldGhvZH0pIGlzIG5vdCBmb3VuZGAsCgkJCQkJJ29iaic6IG9iagoJCQkJfQoJCQl9OwoJCX0gZWxzZSB7CgkJCXJldCA9IGF3YWl0IG9ialttZXRob2RdKC4uLmFyQXJncyk7CgkJfQoKCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQlpZiAoZmFsc2UgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQpIHsKCQkJCXJldCA9IHsKCQkJCQlfX2V4Y2VwdGlvbjogewoJCQkJCQknLTQnOiAiVW5jb21taXR0ZWQgdHJhbnNhY3Rpb25zOiAiICsgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5zcWxzLmxlbmd0aCwKCQkJCQkJJ29iaic6IG9iagoJCQkJCX0KCQkJCX0KCQkJfQoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCX0KCgkJaWYgKHJldCAmJiAhcmV0Ll9fZXhjZXB0aW9uKSB7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UgPSB7fTsKCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgewoJCQkJcmV0ID0gcmV0Lm1hcChyID0+IHsKCQkJCQlpZiAociAmJiByLl90b0RvY3VtZW50KSB7CgkJCQkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfVHlwZS5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5Ob2RlX1R5cGUuJyArIG1ldGhvZCl9YCk7CgkJcmV0dXJuIHJldDsKCX0KCglfcGFyc2VDb2RlU3RhdGUodCkgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyc2VDb2RlU3RhdGUodCk7CgoJfQoKCWFzeW5jIF9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2xvYWRUb29scyhiU3RvcmUsIHNvdXJjZSB8fCAiTm9kZSBUeXBlIik7CgoJfQoKCV9wYXJhbWV0cml6ZShzdHIsIGZ1biwgcHJlZml4ID0gJ3t7JywgcG9zdGZpeCA9ICd9fScpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXgsIHBvc3RmaXgpOwoKCX0KCglfX3N5bmNfb24oZCkgewoJCXRoaXMuX19fc3luY19vbiA9IHRoaXMuX19fc3luY19vbiB8fCB7fTsKCgkJaWYgKGQpIHsKCQkJdGhpcy5fX19zeW5jX29uW3RoaXMuVG9vbC5uYW1lXSA9IGQ7CgoJCQkvLyB0aGlzLnR5cGVfTm9kZV9UeXBlcygpLmZvckVhY2godCA9PiB0Ll9fc3luY19vbihkKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93Lk5vZGVfVHlwZSh0aGlzLklkKQoKCQkJLmR5bmFtaWModGhpcy5keW5hbWljKCksIHRoaXMuX2R5bmFtaWNfY29vcCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLmNvZGUodGhpcy5jb2RlKCksIHRoaXMuX2NvZGVfY29vcCkKCgkJCS5vcmRlcih0aGlzLm9yZGVyKCksIHRoaXMuX29yZGVyX2Nvb3ApCgoJCQkuZGF0ZSh0aGlzLmRhdGUoKSwgdGhpcy5fZGF0ZV9jb29wKQoKCQkJLm5hbWUodGhpcy5uYW1lKCksIHRoaXMuX25hbWVfY29vcCkKCgkJCS5yZW1hcmsodGhpcy5yZW1hcmsoKSwgdGhpcy5fcmVtYXJrX2Nvb3ApCgoJCQkudHlwZV9Ob2Rlcyh0aGlzLnR5cGVfTm9kZXMoKSwgdGhpcy5fdHlwZV9Ob2Rlc19jb29wKQoKCX0KCglfbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSkgewoJCWNvbnRleHQgPSBjb250ZXh0IHx8ICdFbnRpdHlBdHRyaWJ1dGUnOwoJCS8vb2JqRnJvbSA9IG9iakZyb20gfHwgdGhpcy5fdG9Eb2N1bWVudCgpOwoJCS8vb2JqVG8gPSBvYmpUbyB8fCB7fTsKCQljbGFzc05hbWUgPSBjbGFzc05hbWUgfHwgJ05vZGVfVHlwZSc7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoJCWNvZGVUeXBlID0gY29kZVR5cGUgfHwgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZTMwPWApLCAoa2V5LCB2YWx1ZSkgPT4gewoJCQlpZiAodHlwZW9mKHZhbHVlKSA9PT0gInN0cmluZyIgJiYgdmFsdWUuaW5kZXhPZigiPT4iKSA+IDApIHJldHVybiBldmFsKCIoIiArIHZhbHVlICsgIikiKTsKCQkJcmV0dXJuIHZhbHVlOwoJCX0pW2NvZGVdOwoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fbWFwKGNvZGUsIGJSZXZlcnNlLCBjb250ZXh0LCBvYmpGcm9tLCBvYmpUbywgY2xhc3NOYW1lLCB0b29sLCBjb2RlVHlwZSk7CgoJfQoKCV9uQ29kZShjb2RlLCBvQ29kZSkgewoJCXRyeSB7CgkJCWxldCBjb250ZXh0ID0gJ0VudGl0eUF0dHJpYnV0ZSc7CgkJCWlmICghY29kZSAmJiAhb0NvZGUpIHsKCQkJCWNvbnRleHQgPSAnRW50aXR5Q2xhc3MnOwoJCQkJY29kZSA9ICJOb2RlX1R5cGUiOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19jb25maWcobiwgbnVsbFZhbHVlLCBPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zIHx8IHt9LCB7CgkJCV9jbGFzczogJ05vZGVfVHlwZScKCQl9KSk7CgoJfQoKCWFzeW5jIF9yZXN0KHROYW1lID0gdGhpcy5fbkNvZGUoKSwgcGFyYW1zLCBkYXRhLCBtZXRob2QsIG9wdGlvbnMgPSB7fSkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIodW5kZWZpbmVkLCB0aGlzLlRvb2wpLl9yZXN0KHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zKTsKCgl9CgoJX3RvU1FMVGFibGUoKSB7CgkJbGV0IHJldCA9IHsKCQkJc3FsOiBgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoCiAgICAgICAgJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gQ0hBUigyNSkgUFJJTUFSWSBLRVkKICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkeW5hbWljJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRGF0ZSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgYAoJCX07CgkJcmV0LnNxbCArPSAnLypOb2RlX1R5cGUqLyk7XG4nOwoKCQlyZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiB0cnVlLAoJCQlOdWxsOiB0cnVlLAoJCQkvL0lkOiAob2JqLCB2KSA9PiBvYmouc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWWAsCgoJCQkiZHluYW1pYyI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkeW5hbWljJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2R5bmFtaWMnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiQm9vbCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiY29kZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkludCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkiZGF0ZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkRhdGUiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJIm5hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJInJlbWFyayI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCXR5cGVfTm9kZXM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlX05vZGVfVHlwZXMnLCB1bmRlZmluZWQpKSA9PiBvYmouc3FsID0gdi5tYXAoX3YgPT4gX3YuX3RvU1FMVGFibGUoKSkgKyBvYmouc3FsLAoKCQl9LCAiX3RvU1FMVGFibGUiKTsKCgkJLy8gcmV0LnNxbCArPSAnLypOb2RlX1R5cGUqLyk7XG4nOwoKCQlyZXQuc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChyZXQuc3FsKSA6IHJldC5zcWw7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NRTFRhYmxlJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldC5zcWwpOwoJCXJldHVybiByZXQuc3FsOwoJfQoKCV9mcm9tU1FMVGFibGUodGFibGUsIGZpZWxkcykgewoJCS8vIHRhYmxlIGlzIGEganNvbiBhcnJheQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZHluYW1pYyIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuZHluYW1pYyh0YWJsZVsiZHluYW1pYyJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJhY3RpdmUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmFjdGl2ZSh0YWJsZVsiYWN0aXZlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImVuYWJsZWQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmVuYWJsZWQodGFibGVbImVuYWJsZWQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29kZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuY29kZSh0YWJsZVsiY29kZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvcmRlciIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMub3JkZXIodGFibGVbIm9yZGVyIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmRhdGUodGFibGVbImRhdGUiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMubmFtZSh0YWJsZVsibmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnJlbWFyayh0YWJsZVsicmVtYXJrIl0pOwoJCX0KCgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgX3NxbChzcWwsIHNvdXJjZSA9IHRoaXMpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX3NxbChzcWwsIHRoaXMpOwoKCX0KCglhc3luYyBfZ2l0aHViKGZpbGUsIGNvbnRlbnQpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2dpdGh1YihmaWxlLCBjb250ZW50KTsKCgl9CgoJX3RvU0ZRdWVyeShmaWVsZHMsIG9ianMsIGJTdHJpbmcpIHsKCQlsZXQgcmV0ID0gdGhpcy5fX2V4cG9ydCh7CgkJCVt0aGlzLl9uQ29kZSgpXTogewoJCQkJcGFyYW1zOiB7CgkJCQkJd2hlcmU6IHsKCQkJCQkJYW5kOiBbXSwKCQkJCQkJb3I6IFtdCgkJCQkJfQoJCQkJfSwKCQkJCWVkZ2VzOiB7CgkJCQkJbm9kZToge30KCQkJCX0KCQkJfQoJCX0sIHsKCQkJLy9PUEVSQVRPUlM6IHRydWUsCgkJCUlkOiAob2JqLCB2KSA9PiBvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKHsKCQkJCUlkOiB7CgkJCQkJZXE6IHYKCQkJCX0KCQkJfSksCgoJCQlkeW5hbWljOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZHluYW1pYycsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlkYXRlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCSh2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbCkKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQluYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlyZW1hcms6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQl9LCAiX3RvU0ZRdWVyeSIpOwoKCQkvL09iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlpZiAoYlN0cmluZykgewoJCQlyZXQgPSB7CgkJCQlxdWVyeTogewoJCQkJCVt0aGlzLl9uQ29kZSgpICsgJ1F1ZXJ5J106IHsKCQkJCQkJdWlhcGk6IHJldAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJcmV0ID0gSlNPTi5zdHJpbmdpZnkocmV0LCBudWxsLCA0KTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NGUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqLnN5c19pZCA9IHYsCgoJCQlkeW5hbWljOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZHluYW1pYycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCWxldCBkID0gYCR7di5nZXRGdWxsWWVhcigpfS0keygnMCcrKHYuZ2V0TW9udGgoKSsxKSkuc2xpY2UoLTIpfS0ke3YuZ2V0RGF0ZSgpfWA7CgkJCQlsZXQgdCA9IGAke3YuZ2V0SG91cnMoKX06JHt2LmdldE1pbnV0ZXMoKX06JHt2LmdldFNlY29uZHMoKX1gOwoJCQkJaWYgKCh2LmdldEhvdXJzKCkgPT0gMCAmJiB2LmdldE1pbnV0ZXMoKSA9PSAwICYmIHYuZ2V0U2Vjb25kcygpID09IDApIHx8IHRoaXMuX2RhdGVfY29vcCA9PSAnPScgfHwgIXRoaXMuX2RhdGVfY29vcCkgewoJCQkJCW9ialtlYUNvZGVdID0gYE9OJHtkfUBqYXZhc2NyaXB0OmdzLmRhdGVHZW5lcmF0ZSgnJHtkfScsJ3N0YXJ0JylAamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCdlbmQnKWA7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX2RhdGVfY29vcCAhPT0gJ0JFVFdFRU4nKSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpYDsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqW2VhQ29kZV0gPSBgamF2YXNjcmlwdDpncy5kYXRlR2VuZXJhdGUoJyR7ZH0nLCAnJHt0fScpQGphdmFzY3JpcHQ6Z3MuZGF0ZUdlbmVyYXRlKCcke2R9JywgJyR7dH0nKWA7CgkJCQl9CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQl9LCAiX3RvU05RdWVyeSIpOwoKCQlPYmplY3Qua2V5cyhyZXQuT1BFUkFUT1JTIHx8IHt9KS5maWx0ZXIoayA9PiB0eXBlb2YocmV0W2tdKSAhPT0gJ3VuZGVmaW5lZCcpLmZvckVhY2goayA9PiByZXRba10gPSByZXQuT1BFUkFUT1JTW2tdICsgcmV0W2tdKTsKCgkJZGVsZXRlIHJldC5PUEVSQVRPUlM7CgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhU3RyaW5nKHJldFtrXSkubGVuZ3RoKS5mb3JFYWNoKGsgPT4gZGVsZXRlIHJldFtrXSk7CgoJCXJldCA9IERvdE9iamVjdC5kb3QocmV0KTsKCgkJLy8gYXZvaWQgc2VuZGluZyB3aXRoIG5vIGNvbXBhcmlzb24gb3BlcmF0b3JzCgkJT2JqZWN0LmtleXMocmV0KS5maWx0ZXIoayA9PiAhWyc+JywgJzwnLCAnQkVUV0VFTicsICdPTicsICchJywgJz0nLCAnU1RBUlRTV0lUSCcsICdMSUtFJ10uc29tZShzID0+IFN0cmluZyhyZXRba10pLnN0YXJ0c1dpdGgocykpKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gKHRoaXNbYF8ke2t9X2Nvb3BgXSB8fCAnU1RBUlRTV0lUSCcpICsgcmV0W2tdKTsKCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU05RdWVyeScsICdFbnRpdHlPYmplY3QnLCAwLCBPYmplY3QuZW50cmllcyhyZXQgfHwge30pLm1hcChwID0+IGAke3BbMF19JHtwWzFdfWApLmpvaW4oIl4iKSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV9fZXhwb3J0KG9iaiwgb3B0aW9ucywgZnVuLCAuLi5mQXJncykgewoJCWlmICghb2JqKSByZXR1cm4gdGhpczsKCgkJbGV0IF9vcHRpb25zID0gKGZpZWxkLCBvYmosIGVhT2JqKSA9PiB7CgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCQlpZiAodHlwZW9mKG9wdGlvbnNbZmllbGRdKSAhPT0gImZ1bmN0aW9uIikgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDAsIGAke2Z1bn0ub3B0aW9ucy4ke2ZpZWxkfSBpcyBub3QgYSBmdW5jdGlvbmApOwoJCQkJCXJldHVybjsKCQkJCX0KCQkJCWlmICghb3B0aW9ucy5OdWxsKSB7CgkJCQkJaWYgKGZpZWxkICE9ICdJZCcgJiYgIXRoaXNbJ18nICsgZmllbGQgKyAnX3NldCddKSByZXR1cm47CgkJCQkJaWYgKEFycmF5LmlzQXJyYXkoZWFPYmopICYmIHR5cGVvZihlYU9iai5sZW5ndGgpICE9PSAndW5kZWZpbmVkJyAmJiAhZWFPYmoubGVuZ3RoKSByZXR1cm47CgkJCQl9CgkJCQlpZiAob3B0aW9ucy5PUEVSQVRPUlMgJiYgdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddKSBvYmouT1BFUkFUT1JTID0gT2JqZWN0LmFzc2lnbihvYmouT1BFUkFUT1JTIHx8IHt9LCB7CgkJCQkJW2ZpZWxkXTogdGhpc1snXycgKyBmaWVsZCArICdfY29vcCddCgkJCQl9KTsKCgkJCQlsZXQgX3JldCA9IG9wdGlvbnNbZmllbGRdKG9iaiwgZWFPYmopOwoKCQkJCWlmIChvcHRpb25zLl9tYXApIHRoaXMuX21hcChmaWVsZCwgZmFsc2UsIGZ1biwgZWFPYmosIG9iaik7CgkJCQlyZXR1cm4gX3JldDsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCWlmICghZXgudG9TdHJpbmcoKS5pbmRleE9mKCdSYW5nZUVycm9yOiAnKSkgewoJCQkJCXNhbGVzbm93Ll9fZXhwb3J0QWJvcnQgPSB0cnVlOwoJCQkJfQoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yIGluICR7ZnVufS5fb3B0aW9ucy4ke2ZpZWxkfTogJHtleH1gLCBleCk7CgkJCX0KCQl9OwoKCQlpZiAob3B0aW9ucy5GdWxsIHx8IHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSBfb3B0aW9ucygiSWQiLCBvYmosIHRoaXMuSWQpOwoKCQlfb3B0aW9ucygiZHluYW1pYyIsIG9iaiwgdGhpcy5keW5hbWljKCkpOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqLCB0aGlzLmFjdGl2ZSgpKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmosIHRoaXMuZW5hYmxlZCgpKTsKCgkJX29wdGlvbnMoImNvZGUiLCBvYmosIHRoaXMuY29kZSgpKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqLCB0aGlzLm9yZGVyKCkpOwoKCQlfb3B0aW9ucygiZGF0ZSIsIG9iaiwgdGhpcy5kYXRlKCkpOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaiwgdGhpcy5uYW1lKCkpOwoKCQlfb3B0aW9ucygicmVtYXJrIiwgb2JqLCB0aGlzLnJlbWFyaygpKTsKCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZihvYmopID09PSAndW5kZWZpbmVkJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDEsICJOdWxsIGlucHV0Iiwgb2JqLCBmdW4sIGZBcmdzKTsKCQkJCXJldHVybiBvYmo7CgkJCX0gZWxzZSBpZiAodHlwZW9mKG9iaikgPT09ICdzdHJpbmcnKSB7CgkJCQlfaWQgPSB0aGlzLmhhc2hDb2RlKG9iaik7CgkJCX0gZWxzZSB7CgkJCQlfaWQgPSBvYmouX2lkIHx8IG9iai5pZCB8fCBvYmouSUQ7CgkJCX0KCgkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJaWYgKG9iai5JZCAmJiBvYmouSWQgPT0gb2JqLklkKSB7CgkJCQkJX2lkID0gb2JqLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmIChvYmouRW50aXR5Q2xhc3MpIHsKCQkJCQlfaWQgPSBvYmouRW50aXR5Q2xhc3MuSWQgfHwgb2JqLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjFiYWZhYTdjLTdkMjEtNDUwYS05Y2M0LThjOTZjMjIwZDFlNCIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGUgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfVHlwZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGVbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfVHlwZVtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfSBlbHNlIGlmICgodi5kYXRlIC0gdGhpc1NldE9uLmdldFRpbWUoKSkgPj0gMCkgewoJCQkJCXYucmV1c2VkKys7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTZWxlY3RlZCBoYXNoIiwgX2lkLCBfaGFzaCwgZnVuLCBvYmosIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaik7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCV9vcHRpb25zKCJ0eXBlX05vZGVzIiwgb2JqLCB0aGlzLnR5cGVfTm9kZXMoKSk7CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2R5bmFtaWMnLCAnYWN0aXZlJywgJ2VuYWJsZWQnLCAnY29kZScsICdvcmRlcicsICdkYXRlJywgJ25hbWUnLCAncmVtYXJrJ10pLmNvbmNhdChbJ3R5cGVfTm9kZXMnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIHRydWUsIGZ1biwgb2JqLCBvYmopOwoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiZHluYW1pYyIsIG9iaik7CgoJCV9vcHRpb25zKCJhY3RpdmUiLCBvYmopOwoKCQlfb3B0aW9ucygiZW5hYmxlZCIsIG9iaik7CgoJCV9vcHRpb25zKCJjb2RlIiwgb2JqKTsKCgkJX29wdGlvbnMoIm9yZGVyIiwgb2JqKTsKCgkJX29wdGlvbnMoImRhdGUiLCBvYmopOwoKCQlfb3B0aW9ucygibmFtZSIsIG9iaik7CgoJCV9vcHRpb25zKCJyZW1hcmsiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjFiYWZhYTdjLTdkMjEtNDUwYS05Y2M0LThjOTZjMjIwZDFlNCIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGUgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfVHlwZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5Ob2RlX1R5cGVbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW2Z1bl0gfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk5vZGVfVHlwZVtmdW5dW19pZF1bX2hhc2hdOwoJCQlpZiAodiAmJiBNYXRoLmFicyhuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHYuZGF0ZSkgPCAoMTAwMCAqIDAuMikpIHsKCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YoZnVuKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQlpZiAodGhpc1NldE9uID49IHYuZGF0ZSkgewoJCQkJCS8vIGEgbmV3ZXIgY29weSBpcyBjcmVhdGVkIEFGVEVSL0RVUklORyB0aGUgcmVjdXJzaXZlIGNhbGwhIQoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gZnVuIiwgX2lkLCBfaGFzaCwgZnVuLCB0aGlzLCB2KTsKCQkJCX0gZWxzZSBpZiAoKHYuZGF0ZSAtIHRoaXNTZXRPbi5nZXRUaW1lKCkpID49IDApIHsKCQkJCQl2LnJldXNlZCsrOwoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcyk7CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTm9kZV9UeXBlW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogdGhpcywKCQkJCXJldXNlZDogMCwKCQkJfTsKCQl9IGNhdGNoICh1blJlY0V4KSB7CgkJCWlmICghdW5SZWNFeC50b1N0cmluZygpLmluZGV4T2YoJ1JhbmdlRXJyb3I6ICcpKSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dID0gdHJ1ZTsKCQkJfQoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMiwgdGhpcywgZnVuLCBmQXJncywgdW5SZWNFeC50b1N0cmluZygpKTsKCgkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJX2lkOiB2Lm9iai5faWQKCQkJfSA6IHYub2JqOwoJCQlyZXR1cm4gdi5vYmo7CgoJCX0KCgkJX29wdGlvbnMoInR5cGVfTm9kZXMiLCBvYmopOwoKCQlPYmplY3Qua2V5cyhvcHRpb25zKS5maWx0ZXIoayA9PiB0eXBlb2Yob3B0aW9uc1trXSkgPT09ICdmdW5jdGlvbicgJiYgIVsnSWQnLCAnX1RISVMnXS5jb25jYXQoWydkeW5hbWljJywgJ2FjdGl2ZScsICdlbmFibGVkJywgJ2NvZGUnLCAnb3JkZXInLCAnZGF0ZScsICduYW1lJywgJ3JlbWFyayddKS5jb25jYXQoWyd0eXBlX05vZGVzJ10pLmluY2x1ZGVzKGspKS5mb3JFYWNoKGsgPT4gX29wdGlvbnMoaywgb2JqKSk7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RCT2JqZWN0KGZpZWxkcywgYk5vUmVmKSB7CgkJaWYgKCF0aGlzLklkKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDIsICJJbnZhbGlkIElEIiwgdGhpcy5FbnRpdHlDbGFzcy5OYW1lLCB0aGlzLlRvb2wpOwoJCX0KCQlsZXQgcmV0ID0gewoJCQlbdGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyldOiAiJyIgKyB0aGlzLklkICsgIiciCgkJfTsKCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJkeW5hbWljIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2R5bmFtaWNfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuZHluYW1pYygpOwoKCQkJZlZhbHVlID0gdiA/IDEgOiAwOwoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSBmVmFsdWUgPSBmVmFsdWUgPyAnVHJ1ZScgOiAnRmFsc2UnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdkeW5hbWljJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2FjdGl2ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hY3RpdmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9lbmFibGVkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvZGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY29kZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5jb2RlKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigib3JkZXIiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fb3JkZXJfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMub3JkZXIoKTsKCgkJCWZWYWx1ZSA9IHYgfHwgJzAnOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImRhdGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fZGF0ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5kYXRlKCk7CgoJCQl0cnkgewoJCQkJZlZhbHVlID0gIiciICsgKHYgPyB2LnRvSVNPU3RyaW5nKCkgOiAiMTk3MC0xLTEiKSArICInIjsKCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ215c3FsJykgewoJCQkJCWZWYWx1ZSA9IGBTVFJfVE9fREFURSgke2ZWYWx1ZX0sICclWS0lbS0lZFQlVC4lZlonKWA7CgkJCQl9CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoJCQl9CgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICdOZW80aicpIGZWYWx1ZSA9ICdkYXRldGltZSgnICsgZlZhbHVlICsgJyknOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigibmFtZSIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9uYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm5hbWUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJyZW1hcmsiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fcmVtYXJrX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnJlbWFyaygpOwoKCQkJZlZhbHVlID0gIiciICsgKCh2ICYmIHYucmVwbGFjZSkgPyB2LnJlcGxhY2UoL1wnL2csICJcJ1wnIikgOiB2KSArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmIChbJ1NhbGVzRm9yY2UnXS5pbmRleE9mKHRoaXMuVG9vbC50eXBlLm5hbWUpID09IDApIHsKCQkJX28gPSBfcSA9ICIiOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXRoaXMuX19RID0gdGhpcy5fX1EgPT0gX28gPyBfcSA6IF9vOwoJCXJldHVybiB0aGlzLl9fUTsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpLCB0aGlzLl9uQ29kZSgnZHluYW1pYycsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnbmFtZScsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdyZW1hcmsnLCB1bmRlZmluZWQpXTsKCQlmaWVsZHMgPSBBcnJheS5pc0FycmF5KGZpZWxkcykgPyBmaWVsZHMgOiBbZmllbGRzXTsKCgkJaWYgKHRoaXMuX19maWVsZEdyb3VwcykgewoJCQkvLyB7ZmllbGQ6IG9yZGVyfQoJCQlmaWVsZHMgPSBbXTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZHluYW1pYykgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2R5bmFtaWMnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmNvZGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpfWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0sCgoJCQkJZHluYW1pYzogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2R5bmFtaWMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5keW5hbWljKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29kZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb2RlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZGF0ZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2RhdGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5kYXRlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJbmFtZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5uYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMucmVtYXJrKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlOdWxsOiB0cnVlLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5keW5hbWljKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5keW5hbWljfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkeW5hbWljJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuYWN0aXZlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZW5hYmxlZH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jb2RlfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5vcmRlcn0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZSkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuZGF0ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5uYW1lfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJfQoKCQlzcWwgKz0gYCBmcm9tICR7dFByZWZ9IGA7CgoJCU9iamVjdC5rZXlzKGhlYWRlci5qb2lucykuZm9yRWFjaChrID0+IHNxbCArPSBgbGVmdCBqb2luICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfSR7dGhpcy5fUSgpfSBhcyAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfSBvbiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2t9aWQke3RoaXMuX1EoKX09JHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9XyR7a30ke3RoaXMuX1EoKX0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX0gYCk7CgoJCXNxbCArPSBgIHdoZXJlIDE9MWA7CgoJCXNxbCA9IHRoaXMuX19leHBvcnQoewoJCQlzcWw6IHNxbAoJCX0sIHsKCQkJX2ZpZWxkczogKHRoaXMuX19zeW5jX29uKCkgfHwgdGhpcy5JZCA9PSB0aGlzLklkKSA/IFsnSWQnXSA6IHVuZGVmaW5lZCwKCQkJTnVsbDogdHJ1ZSwKCQkJX1RISVM6IG9iaiA9PiB7CgkJCQlpZiAoIXRoaXMuX1RISVMgfHwgIXRoaXMuX1RISVMubGVuZ3RoKSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX1RISVNfY29vcCB8fCAiSU4iKSArICIgKCIgKyB0aGlzLl9USElTLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKHQuX19jb25maWcoJ2lkRmllbGQnKSB8fCAnX19pZCcpKS5qb2luKCcgVU5JT04gQUxMICcpICsgIikiOwoJCQl9LAoJCQlJZDogb2JqID0+IG9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKX0ke3RoaXMuX1EoKX09JyR7dGhpcy5JZH0nYCwKCgkJCWR5bmFtaWM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkeW5hbWljJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9keW5hbWljX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWFjdGl2ZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fYWN0aXZlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9lbmFibGVkX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAiPSIgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gImJvb2xlYW4iKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAodiA/ICIxIiA6ICIwIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWNvZGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jb2RlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fY29kZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gInN0cmluZyIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICgodGhpcy5fY29kZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29kZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX2NvZGVfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX2NvZGVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX29yZGVyX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fb3JkZXJfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9kYXRlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fZGF0ZV9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi50b0lTT1N0cmluZykgewoJCQkJCWlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbGl0ZScpIHsKCQkJCQkJb2JqLnNxbCArPSAic3RyZnRpbWUoJyVzJywgJyIgKyB2LnRvSVNPU3RyaW5nKCkgKyAiJykiOwoJCQkJCX0gZWxzZSB7CgkJCQkJCW9iai5zcWwgKz0gIiciICsgdi50b0lTT1N0cmluZygpICsgIiciOwoJCQkJCX0KCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9uYW1lX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9uYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9uYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fbmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fbmFtZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJcmVtYXJrOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9yZW1hcmtfc2V0KSByZXR1cm47CgoJCQkJcmV0dXJuOwoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXR5cGVfTm9kZXM6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0eXBlX05vZGVfVHlwZXMnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3R5cGVfTm9kZXNfc2V0KSByZXR1cm47CgoJCQkJbGV0IHNxdWVyaWVzID0gKHYgfHwgW10pLmZpbHRlcih0ID0+IHQpLm1hcCh0ID0+IHQuX3RvU2VsZWN0U1FMKCJ0eXBlLmlkIikpOwoKCQkJCWxldCBqT1AgPSAnVU5JT04gQUxMJzsKCQkJCWxldCBpbk9QID0gJ0lOJzsKCgkJCQlvYmouc3FsICs9IGBgOwoKCQkJCWlmICh0aGlzLl90eXBlX05vZGVzX2Nvb3AgPT0gJyE9JyB8fCB0aGlzLl90eXBlX05vZGVzX2Nvb3AgPT0gJ05PVCBJTicpIHsKCQkJCQlpbk9QID0gJ05PVCBJTic7CgkJCQl9IGVsc2UgaWYgKHRoaXMuX3R5cGVfTm9kZXNfY29vcCA9PSAnPScgfHwgdGhpcy5fdHlwZV9Ob2Rlc19jb29wID09ICdJTicpIHt9IGVsc2UgaWYgKHRoaXMuX3R5cGVfTm9kZXNfY29vcCA9PSAnPT0nKSB7CgkJCQkJak9QID0gJ0lOVEVSU0VDVCc7CgkJCQl9CgoJCQkJb2JqLnNxbCArPSBgYW5kIC8qdHlwZV9Ob2RlcyovICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9ICR7aW5PUH0gKGAgKyBzcXVlcmllcy5qb2luKGAgJHtqT1B9LypNMk0qLyBgKSArICcpJzsKCQkJfSwKCgkJfSwgIl90b1NlbGVjdFNRTCIsIGZpZWxkcykuc3FsOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCWlmIChPYmplY3Qua2V5cyh0aGlzLl9fZmllbGRHcm91cHMpLmxlbmd0aCkgc3FsICs9ICIgZ3JvdXAgYnkgIjsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuZHluYW1pYykgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdkeW5hbWljJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuZHluYW1pY31gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWR9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29kZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb2RlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuY29kZX1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcmRlcikgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmRhdGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMubmFtZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMubmFtZX1gOwoKCQl9CgoJCWlmIChzcWwuZW5kc1dpdGgoIndoZXJlIDE9MSIpKSB7CgkJCS8vIHNxbCA9IHNxbC5yZXBsYWNlKCJ3aGVyZSAxPTEiLCAid2hlcmUgMT0wIik7CgkJfSBlbHNlIHsKCQkJc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSBhbmQgIiwgIndoZXJlICIpOwoJCX0KCgkJc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChzcWwpIDogc3FsOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoKCQlyZXR1cm4gc3FsOwoJfQoKCV90b1BhdGhzKCkgewoJCWxldCByZXQgPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCV9USElTOiBvYmogPT4ge30sCgoJCQl0eXBlX05vZGVzOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZV9Ob2RlX1R5cGVzJywgdW5kZWZpbmVkKSkgPT4gb2JqLnR5cGVfTm9kZXMgPSB2Lm1hcChfdiA9PiBfdi5fdG9QYXRocygpKSwKCgkJfSwgIl90b1BhdGhzIik7CgkJLy8gcmV0dXJuIHJldDsKCQlyZXR1cm4gT2JqZWN0LmtleXMocmV0KS5tYXAoayA9PiAoewoJCQlba106IHJldFtrXQoJCX0pKTsKCX0KCglfdG9VcGRhdGVTUUwoZmllbGRzKSB7CgkJbGV0IHJldEZpZWxkcyA9IHRoaXMuX3RvRmllbGRzU1FMKGZpZWxkcykubWFwKGYgPT4gdGhpcy5fUSgpICsgZi5yZXBsYWNlKC9cLi9nLCAnJykgKyB0aGlzLl9RKCkpLmpvaW4oJywgJyk7CgkJbGV0IHNxbCA9IGB1cGRhdGUgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSBzZXQgYCArIE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvREJPYmplY3QoZmllbGRzKSkubWFwKHYgPT4gdGhpcy5fUSgpICsgdlswXSArIHRoaXMuX1EoKSArICI9IiArIHZbMV0pICsgYCB3aGVyZSAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgOyAvL2AgcmV0dXJuaW5nICR7cmV0RmllbGRzfWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvVXBkYXRlU1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfdG9JbnNlcnRTUUwoZmllbGRzKSB7CgkJbGV0IG9iaiA9IHRoaXMuX3RvREJPYmplY3QoZmllbGRzKTsKCQlsZXQgc3FsID0gYGluc2VydCBpbnRvICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKGAgKyBPYmplY3Qua2V5cyhvYmopLm1hcChrID0+IHRoaXMuX1EoKSArIGsgKyB0aGlzLl9RKCkpICsgIikgdmFsdWVzICgiICsgT2JqZWN0LnZhbHVlcyhvYmopICsgYClgOwoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0luc2VydFNRTCcsICdFbnRpdHlPYmplY3QnLCAwLCBzcWwpOwoJCXJldHVybiBzcWw7Cgl9CgoJX2NvcHlGcm9tKG9iaikgewoJCWlmICghb2JqKSByZXR1cm4gbnVsbDsKCQlyZXR1cm4gdGhpcy5fcmV2ZXJ0KG9iaik7Cgl9CgoJYXN5bmMgX3N0b3JlRW50aXR5Q2xhc3MoZGVwdGgpIHsKCQl0cnkgewoJCQlpZiAodHlwZW9mKGRlcHRoKSA9PT0gInVuZGVmaW5lZCIpIGRlcHRoID0gdGhpcy5fX2NvbmZpZygiY3JlYXRlIik7CgkJCWlmICghZGVwdGgpIHJldHVybjsKCgkJCXNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzID0gc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgfHwge307CgkJCWlmIChzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcy5Ob2RlX1R5cGUpIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTm9kZV9UeXBlID0gdHJ1ZTsKCgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIGBzdG9yaW5nICcke3RoaXMuVG9vbC50eXBlLm5hbWV9JyBtb2RlbCB3aXRoIGRlcHRoICR7ZGVwdGh9YCk7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJbGV0IHNxbCA9IG5ldyBzYWxlc25vdy5Ob2RlX1R5cGUoKQoKCQkJCQkudHlwZV9Ob2RlcyhuZXcgc2FsZXNub3cuTm9kZSgpKQoKCQkJCQkuX3RvU1FMVGFibGUoZGVwdGgpOwoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3N0b3JlRW50aXR5Q2xhc3MnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQkJCWF3YWl0IHRoaXMuX3NxbChzcWwpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQl9CgoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9CgkJcmV0dXJuIHRoaXM7Cgl9CgoJYXN5bmMgRFNDb25uZWN0KHRvb2wgPSB0aGlzLlRvb2wpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuRFNDb25uZWN0KHRvb2wpOwoKCX0KCS8qIEVuZDogVXRpbCBmdW5jdGlvbnMgKi8KCglfbWF0Y2hlcyhxdWVyeSkgewoJCXRyeSB7CgkJCWlmICghcXVlcnkgfHwgIXF1ZXJ5LkVudGl0eUNsYXNzIHx8IHF1ZXJ5LkVudGl0eUNsYXNzLk5hbWUgIT0gIk5vZGUgVHlwZSIpIHJldHVybiBmYWxzZTsKCgkJCWxldCBvTWF0Y2ggPSB0aGlzLl9fZXhwb3J0KHt9LCB7CgkJCQlGdWxsOiB0cnVlLAoJCQkJTnVsbDogdHJ1ZSwKCQkJCUlkOiAob2JqLCB2KSA9PiBvYmouX2lkID0gdGhpcy5JZCA9PSBxdWVyeS5JZCwKCgkJCQlkeW5hbWljOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5keW5hbWljID0gdiA9PSBxdWVyeS5keW5hbWljKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2R5bmFtaWNfc2V0ICYmICFxdWVyeS5fZHluYW1pY19zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZHluYW1pYyA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9keW5hbWljX3NldCAmJiBxdWVyeS5fZHluYW1pY19zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmR5bmFtaWMgPSBmYWxzZTsKCQkJCX0sCgoJCQkJYWN0aXZlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5hY3RpdmUgPSB2ID09IHF1ZXJ5LmFjdGl2ZSgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9hY3RpdmVfc2V0ICYmICFxdWVyeS5fYWN0aXZlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5hY3RpdmUgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fYWN0aXZlX3NldCAmJiBxdWVyeS5fYWN0aXZlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gZmFsc2U7CgkJCQl9LAoKCQkJCWVuYWJsZWQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB2ID09IHF1ZXJ5LmVuYWJsZWQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZW5hYmxlZF9zZXQgJiYgIXF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5lbmFibGVkID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2VuYWJsZWRfc2V0ICYmIHF1ZXJ5Ll9lbmFibGVkX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IGZhbHNlOwoJCQkJfSwKCgkJCQljb2RlOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5jb2RlID0gdiA9PSBxdWVyeS5jb2RlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2NvZGVfc2V0ICYmICFxdWVyeS5fY29kZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY29kZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9jb2RlX3NldCAmJiBxdWVyeS5fY29kZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvZGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWRhdGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLmRhdGUgPSB2ID09IHF1ZXJ5LmRhdGUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fZGF0ZV9zZXQgJiYgIXF1ZXJ5Ll9kYXRlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5kYXRlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2RhdGVfc2V0ICYmIHF1ZXJ5Ll9kYXRlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZGF0ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQluYW1lOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5uYW1lID0gdiA9PSBxdWVyeS5uYW1lKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX25hbWVfc2V0ICYmICFxdWVyeS5fbmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoubmFtZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9uYW1lX3NldCAmJiBxdWVyeS5fbmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm5hbWUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJcmVtYXJrOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5yZW1hcmsgPSB2ID09IHF1ZXJ5LnJlbWFyaygpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9yZW1hcmtfc2V0ICYmICFxdWVyeS5fcmVtYXJrX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5yZW1hcmsgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fcmVtYXJrX3NldCAmJiBxdWVyeS5fcmVtYXJrX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoucmVtYXJrID0gZmFsc2U7CgkJCQl9LAoKCQkJCXR5cGVfTm9kZXM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoudHlwZV9Ob2RlcyA9IHYubWFwKF92ID0+IHF1ZXJ5LnR5cGVfTm9kZXMoKS5hbnkocSA9PiBfdi5fbWF0Y2hlcyhxKSkpOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXR5cGVfTm9kZXM6IChvYmosIHYpID0+IHsKCQkJCQlvYmoudHlwZV9Ob2RlcyA9IHYubWFwKF92ID0+IF92Ll9tYXRjaGluZyhxdWVyeSkpLmZsYXQoKTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fZHluYW1pY19zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9hY3RpdmVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fZW5hYmxlZF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9jb2RlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX29yZGVyX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2RhdGVfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fbmFtZV9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9yZW1hcmtfc2V0ID8gZmFsc2UgOiB0cnVlKTsKCgkJCWlmIChyb290ICE9IHRoaXMgJiYgaXNRdWVyeSkgewoJCQkJbGV0IG15TWF0Y2hlcyA9IHJvb3QuX21hdGNoaW5nKHRoaXMpOwoJCQkJaWYgKCFteU1hdGNoZXMubGVuZ3RoKSByZXR1cm4gdGhpczsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19kZVJlZmVyZW5jZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUXVlcnkiLCBteU1hdGNoZXMubGVndGgpOwoJCQkJcmV0dXJuIG15TWF0Y2hlc1swXTsKCQkJfQoKCQkJdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXR5cGVfTm9kZXM6IChvYmosIHYpID0+IHsKCQkJCQl2LmZpbHRlcih0YSA9PiB0YSkuZm9yRWFjaCgodGEsIGkpID0+IHsKCQkJCQkJbGV0IHJldCA9IHRhLl9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB0YSkgdGhpcy50eXBlX05vZGVzKClbaV0gPSByZXQ7CgkJCQkJfSk7CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlkeW5hbWljOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZHluYW1pYycsIHVuZGVmaW5lZCkgOiAiZHluYW1pYyIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9keW5hbWljX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5keW5hbWljKHJlZik7CgoJCQl9LAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fYWN0aXZlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5hY3RpdmUocmVmKTsKCgkJCX0sCgoJCQllbmFibGVkOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9lbmFibGVkX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5lbmFibGVkKHJlZik7CgoJCQl9LAoKCQkJY29kZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvZGUnLCB1bmRlZmluZWQpIDogImNvZGUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fY29kZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMuY29kZShyZWYpOwoKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX29yZGVyX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vcmRlcihyZWYpOwoKCQkJfSwKCgkJCWRhdGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkYXRlJywgdW5kZWZpbmVkKSA6ICJkYXRlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2RhdGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgkJCQkJaWYgKHR5cGVvZihtb21lbnQpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5Ub29sLnN5c19wcm9wZXJ0aWVzKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJCQkJcmVmID0gbW9tZW50LnBhcnNlWm9uZShyZWYsIHRoaXMuVG9vbC5zeXNfcHJvcGVydGllc1siZ2xpZGUuc3lzLmRhdGVfZm9ybWF0Il0gKyAiICIgKyB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy50aW1lX2Zvcm1hdCJdLCB0aGlzLlRvb2wuc3lzX3Byb3BlcnRpZXNbImdsaWRlLnN5cy5kZWZhdWx0LnR6Il0pLnRvRGF0ZSgpOwoJCQkJCX0gZWxzZSB7CgkJCQkJCXJlZiA9IG5ldyBEYXRlKHJlZik7CgkJCQkJfQoJCQkJfSBlbHNlIHsKCQkJCQlyZWYgPSBuZXcgRGF0ZShEYXRlLnBhcnNlKHJlZiArICIgR01UIikpOwoJCQkJfQoJCQkJdGhpcy5kYXRlKHJlZik7CgoJCQl9LAoKCQkJbmFtZTogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ25hbWUnLCB1bmRlZmluZWQpIDogIm5hbWUiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fbmFtZV9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMubmFtZShyZWYpOwoKCQkJfSwKCgkJCXJlbWFyazogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3JlbWFyaycsIHVuZGVmaW5lZCkgOiAicmVtYXJrIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3JlbWFya19jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMucmVtYXJrKHJlZik7CgoJCQl9LAoKCQkJdHlwZV9Ob2RlczogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3R5cGVfTm9kZV9UeXBlcycsIHVuZGVmaW5lZCkgOiAidHlwZV9Ob2RlcyIpKSA9PiB0aGlzLnR5cGVfTm9kZXMob2JqW2VhQ29kZV0gPyBvYmpbZWFDb2RlXS5tYXAoX3YgPT4gbmV3IHNhbGVzbm93Lk5vZGUoKS5fZnJvbURvY3VtZW50KF92LCBiVG9vbCkpIDogdW5kZWZpbmVkLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SU1tlYUNvZGVdIDogdW5kZWZpbmVkKSwKCgkJfSwgIl9mcm9tRG9jdW1lbnQiKTsKCgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRG9jdW1lbnQoYlRvb2wsIGJGdWxsLCBiTnVsbCkgewoJCWxldCByZXQgPSB7fTsKCgkJaWYgKCFiVG9vbCkgewoJCQlyZXQuX19nZW5lcmF0ZWQgPSBuZXcgRGF0ZSgpOwoJCQlpZiAodGhpcy5Ub29sLm5hbWUpIHsKCQkJCXJldC5fX3Rvb2wgPSB7CgkJCQkJbmFtZTogdGhpcy5Ub29sLm5hbWUsCgkJCQkJdHlwZTogewoJCQkJCQluYW1lOiB0aGlzLlRvb2wudHlwZS5uYW1lLAoJCQkJCX0KCQkJCX07CgkJCX0KCQkJaWYgKHNhbGVzbm93Ll9ub2RlKSB7CgkJCQlyZXQuX19ub2RlID0gewoJCQkJCWNvZGU6IHNhbGVzbm93Ll9ub2RlLmNvZGUoKQoJCQkJfTsKCQkJfQoJCX0KCgkJcmV0dXJuIHRoaXMuX19leHBvcnQocmV0LCB7CgkJCUZ1bGw6IGJGdWxsLAoJCQlOdWxsOiBiTnVsbCwKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiAob2JqLCB2KSA9PiB7CgkJCQlpZiAoYlRvb2wpIHJldHVybjsKCQkJCW9iai5USElTID0gdGhpcy5fVEhJUy5tYXAodCA9PiB0Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpKTsKCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJb2JqLk9QRVJBVE9SUy5USElTID0gdGhpcy5fVEhJU19jb29wOwoJCQl9LAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXSA9IHYsCgoJCQkiZHluYW1pYyI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdkeW5hbWljJywgdW5kZWZpbmVkKSA6ICJkeW5hbWljIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX2R5bmFtaWNfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2R5bmFtaWNfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJhY3RpdmUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSA6ICJhY3RpdmUiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fYWN0aXZlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9hY3RpdmVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJlbmFibGVkIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpIDogImVuYWJsZWQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fZW5hYmxlZF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNvZGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnY29kZScsIHVuZGVmaW5lZCkgOiAiY29kZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jb2RlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9jb2RlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImRhdGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZGF0ZScsIHVuZGVmaW5lZCkgOiAiZGF0ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi50b0lTT1N0cmluZygpIDogbnVsbDsKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93Iikgb2JqW2VhQ29kZV0gPSBvYmpbZWFDb2RlXS5yZXBsYWNlKC9cLlswLTldKlovZywgJycpOwoKCQkJCWlmICh0aGlzLl9kYXRlX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9kYXRlX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkibmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCduYW1lJywgdW5kZWZpbmVkKSA6ICJuYW1lIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX25hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX25hbWVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJyZW1hcmsiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgncmVtYXJrJywgdW5kZWZpbmVkKSA6ICJyZW1hcmsiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fcmVtYXJrX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9yZW1hcmtfY29vcDsKCQkJCX0KCQkJfSwKCgkJCXR5cGVfTm9kZXM6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0eXBlX05vZGVfVHlwZXMnLCB1bmRlZmluZWQpIDogInR5cGVfTm9kZXMiKSkgPT4gewoJCQkJb2JqW2VhQ29kZV0gPSB2Lm1hcChfdiA9PiBfdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlpZiAodGhpcy5fdHlwZV9Ob2Rlc19jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fdHlwZV9Ob2Rlc19jb29wOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvRG9jdW1lbnQiLCBiVG9vbCwgYkZ1bGwsIGJOdWxsKTsKCX0KCglhc3luYyBnZXQobmFtZSkgewoJCWlmICghdGhpcy5JZCkgcmV0dXJuIG51bGw7CgkJdmFyIHQgPSBudWxsOwoJCSQuZWFjaChuYW1lLnNwbGl0KCcuJyksIChfLCBmKSA9PiB7CgkJCXQgPSB7CgkJCQlFbnRpdHlPYmplY3Q6IHQgPyB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCVZhbHVlRW50aXRpZXM6IFt0XQoJCQkJfSA6IHsKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJSWQ6IHRoaXMuSWQKCQkJCX0sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBmLAoJCQkJCU9QRVJBVE9SUzogewoJCQkJCQlOYW1lOiAiPSIKCQkJCQl9CgkJCQl9CgkJCX07CgkJfSk7CgkJcmV0dXJuICQud2hlbih0aGlzLnNyKCkuXygiRW50ZXJwcmlzZU1hbmFnZXIuZW1zRW50aXR5VmFsdWVGaW5kIiwgbnVsbCwgdCkpLnRoZW4oZXYgPT4gewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQnLCAnRW50aXR5T2JqZWN0JywgMCwgZXYpOwoJCQlpZiAoZXYgPT09IG51bGwpIHJldHVybiBudWxsOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSByZXR1cm4gZXYuU3RyaW5nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNGbG9hdCkgcmV0dXJuIGV2LkZsb2F0VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNJbnQpIHJldHVybiBldi5JbnRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0xvbmcpIHJldHVybiBldi5Mb25nVmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0KSByZXR1cm4gZXYuVGV4dFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzQm9vbCkgcmV0dXJuIGV2LkJvb2xWYWx1ZTsKCgkJCWlmICghZXYuT2JqZWN0VmFsdWUpIHJldHVybiBudWxsOwoKCQkJcmV0dXJuIG5ldyBzYWxlc25vd1skLmdyZXAoc2FsZXNub3cuRW50aXR5Q2xhc3NlcywgYyA9PiBjLklkID09IGV2LkVudGl0eUF0dHJpYnV0ZS5FbnRpdHlUeXBlaWQpWzBdLk5hbWUucmVwbGFjZSgvIC9nLCAnXycpXShldi5PYmplY3RWYWx1ZS5JZCk7CgkJfSk7Cgl9CgoJLyogU1RBUlQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuXygpICovCglfKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuXyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl8oLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLl8oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuYnVpbGRVUkwoKSAqLwoJYnVpbGRVUkwoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmJ1aWxkVVJMKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5idWlsZFVSTCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci4kX1JFUVVFU1QoKSAqLwoJJF9SRVFVRVNUKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuJF9SRVFVRVNUKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci4kX1JFUVVFU1QoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucGFyYW0oKSAqLwoJcGFyYW0oLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wYXJhbSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnBhcmFtKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wYXJhbSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5fdG9YTUwoKSAqLwoJX3RvWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3RvWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fdG9YTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY29vcCgpICovCgljb29wKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY29vcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNvb3AoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmNvb3AoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuT1IoKSAqLwoJT1IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5PUiguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLk9SKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5PUigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5teVJlcGxhY2UoKSAqLwoJbXlSZXBsYWNlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkubXlSZXBsYWNlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5teVJlcGxhY2UoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3Iuc2VuZFhNTCgpICovCglzZW5kWE1MKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3Iuc2VuZFhNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnNlbmRYTUwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCXByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnByb2Nlc3NSZXNwb25zZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3BvbnNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXN1bHQoKSAqLwoJcHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlcnZlckRhdGUoKSAqLwoJc2VydmVyRGF0ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlcnZlckRhdGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCWFkZE1TZWNvbmRzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5hZGRNU2Vjb25kcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYWRkTVNlY29uZHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IucnVuU2NyaXB0KCkgKi8KCXJ1blNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJ1blNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCXJ1blNSU2NyaXB0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TUlNjcmlwdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucnVuU1JTY3JpcHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaGFzaENvZGUoKSAqLwoJaGFzaENvZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmhhc2hDb2RlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5oYXNoQ29kZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ncm91cEJ5KCkgKi8KCWdyb3VwQnkoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ncm91cEJ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuZ3JvdXBCeSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RGVidWcoKSAqLwoJU2hvd0RlYnVnKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0RlYnVnKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RGVidWcoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuY2FjaGVSZXN1bHQoKSAqLwoJY2FjaGVSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmNhY2hlUmVzdWx0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jYWNoZVJlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci50b0hleCgpICovCgl0b0hleCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnRvSGV4KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkudG9IZXgoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnRvSGV4KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLlNob3dFcnJvcigpICovCglTaG93RXJyb3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5TaG93RXJyb3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLlNob3dFcnJvcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5FcXVhbHMoKSAqLwoJRXF1YWxzKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuRXF1YWxzKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5FcXVhbHMoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuaXBBZGRyZXNzKCkgKi8KCWlwQWRkcmVzcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmlwQWRkcmVzcyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaXBBZGRyZXNzKCkgKi8KCgkvKiBFTkQ6IHNyIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIFNUQVJUOiBfRnJFTUQgZnVuY3Rpb24gY29waWVzICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0dHIoKSAqLwoJX2F0dHIoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdHRyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0dHIoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXR0cigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX3VuaXF1ZSgpICovCglfdW5pcXVlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdW5pcXVlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91bmlxdWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9mbGlwKCkgKi8KCV9mbGlwKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fZmxpcCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9mbGlwKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2ZsaXAoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCV9yZWZyZXNoQVBJKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9yZWZyZXNoQVBJKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3JlZnJlc2hBUEkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9fc2NvcGUoKSAqLwoJX19zY29wZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX19zY29wZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3Njb3BlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5zcigpICovCglzciguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuc3IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zciguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELnNyKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYXRvYigpICovCglfYXRvYiguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2F0b2IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYXRvYiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9hdG9iKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYnRvYSgpICovCglfYnRvYSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2J0b2EoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYnRvYSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9idG9hKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3RpbWUoKSAqLwoJX190aW1lKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3RpbWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fX3RpbWUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl93YWl0KCkgKi8KCV93YWl0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fd2FpdCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl93YWl0KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3dhaXQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCV9zcWxUeXBlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWxUeXBlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3NxbFR5cGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91dWlkKCkgKi8KCV91dWlkKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fdXVpZCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91dWlkKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX3V1aWQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELnJlcXVpcmUoKSAqLwoJcmVxdWlyZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQucmVxdWlyZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5yZXF1aXJlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5faW5jbHVkZSgpICovCglfaW5jbHVkZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5faW5jbHVkZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9pbmNsdWRlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoJX2JlYXV0aWZ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fYmVhdXRpZnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYmVhdXRpZnkoKSAqLwoKCS8qIEVORDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCWkxOG4oZXYsIHYpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgPT09ICJ1bmRlZmluZWQiIHx8IHR5cGVvZih3aW5kb3cuaTE4bl9zdG9yZSkgPT09ICJ1bmRlZmluZWQiKSByZXR1cm4gdjsKCgkJaWYgKCFldi5FbnRpdHlBdHRyaWJ1dGUuSXNUZXh0ICYmICFldi5FbnRpdHlBdHRyaWJ1dGUuSXNTdHJpbmcpIHsKCQkJcmV0dXJuIHY7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildID0gd2luZG93LmkxOG5fc3RvcmVbdGhpcy5oYXNoQ29kZSh2KV0gfHwgdjsKCQl9Cgl9CgoJdG9TdHJpbmcoKSB7CgoJCXJldHVybiB0aGlzLl9uYW1lOwoKCX0KCglFbnRpdHlWYWx1ZShhTmFtZSkgewoJCWxldCByZXQgPSBbXS5jb25jYXQodGhpcy5FbnRpdHlWYWx1ZXMsIHRoaXMuVmFsdWVFbnRpdGllcykuZmluZChldiA9PiBldi5FbnRpdHlBdHRyaWJ1dGUgJiYgZXYuRW50aXR5QXR0cmlidXRlLk5hbWUgPT0gYU5hbWUpOwoKCQlpZiAoIXJldCkgewoJCQkvLyBhbiBhdHRyaWJ1dGUgdGhhdCBoYXMgeWV0IG5vIGtub3duIGVudGl0eSB2YWx1ZQoJCQlyZXQgPSB7CgkJCQlBY3RpdmU6IHRydWUsCgkJCQlPUEVSQVRPUlM6IHt9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogYU5hbWUsCgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUVudGl0eUNsYXNzOiB7CgkJCQkJCUlkOiB0aGlzLkVudGl0eUNsYXNzLklkCgkJCQkJfQoJCQkJfQoJCQl9OwoJCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHJldCk7CgkJfQoKCQlyZXR1cm4gcmV0OwoJfQoKCWFzeW5jIGZpbmQoZGVwdGggPSAxKSB7CgkJcmV0dXJuIChhd2FpdCB0aGlzLmZpbmRBbGwoZGVwdGgpKVswXTsKCX0KCglfX2Fzc2VydFZhbGlkKGJTeW5jKSB7CgkJbGV0IGVycm9yID0ge307CgoJCWlmICgKCQkJLyoKCQkJKChvU2NvcGUpID0+IHsKCQkJICAgIGxldCByZXQgPSB0cnVlOwoJCQkgICAgaWYodHlwZW9mKHJldCk9PT0iZnVuY3Rpb24iKXsKCQkJICAgICAgICByZXQgPSByZXQob1Njb3BlKTsKCQkJICAgIH0KCQkJICAgIHJldHVybiByZXQ7CgkJCX0pKHNhbGVzbm93KQoJCQkgfHwgKi8KCQkJKChvU2NvcGUpID0+IHsKCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQl9CgkJCQlyZXR1cm4gcmV0OwoJCQl9KShzYWxlc25vdykKCQkpIHsKCQkJZXJyb3IubmFtZSA9IHt9OwoJCQlpZiAoIXRoaXMuX25hbWVfc2V0KSBlcnJvci5uYW1lWyIwMSJdID0gIk5vdCBTZXQiOwoKCQkJaWYgKCFPYmplY3Qua2V5cyhlcnJvci5uYW1lKS5sZW5ndGgpIGRlbGV0ZSBlcnJvci5uYW1lOwoJCX0KCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZV9UeXBlLnN0b3JlJyk7IC8vIG9yIGluc2lkZSBleGVjdXRlPwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCWxldCBiVXBkYXRlID0gZmFsc2U7CgkJCWxldCBiSW5zZXJ0ID0gZmFsc2U7CgoJCQlpZiAoIXRoaXMuX19zeW5jX29uKCkpIHsKCQkJCWxldCBfdGhpcyA9IG5ldyBzYWxlc25vdy5Ob2RlX1R5cGUobnVsbCwgdGhpcy5Ub29sKTsKCgkJCQlsZXQgYkZpbmQgPSBmYWxzZTsKCQkJCWlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQliRmluZCA9IHRydWU7CgkJCQkJX3RoaXMuSWQgPSB0aGlzLklkOwoJCQkJfQoKCQkJCWlmICgKCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJfQoJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCX0pKHNhbGVzbm93KQoJCQkJKSB7CgkJCQkJYkZpbmQgPSB0cnVlOwoJCQkJCV90aGlzLm5hbWUodGhpcy5uYW1lKCksICc9Jyk7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCWlmICh0eXBlb2Yoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgPT09ICJ1bmRlZmluZWQiIHx8IHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQkJCWF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsKCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiA9IHsKCQkJCQkJCU93bmVyOiB0aGlzLAoJCQkJCQkJc3FsczogW10sCgkJCQkJCQlzdGFydDogbmV3IERhdGUoKSwKCQkJCQkJCWVuZDogbnVsbAoJCQkJCQl9OwoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2FjdGl2ZV9zZXQpIHsKCQkJCQl0aGlzLmFjdGl2ZSgKCQkJCQkJKChvU2NvcGUpID0+IHsKCQkJCQkJCWxldCByZXQgPSB0cnVlOwoJCQkJCQkJaWYgKHR5cGVvZihyZXQpID09PSAiZnVuY3Rpb24iKSB7CgkJCQkJCQkJcmV0ID0gcmV0KG9TY29wZSk7CgkJCQkJCQl9CgkJCQkJCQlyZXR1cm4gcmV0OwoJCQkJCQl9KShzYWxlc25vdykKCQkJCQkpOwoJCQkJfQoKCQkJCWlmICghdGhpcy5fZW5hYmxlZF9zZXQpIHsKCQkJCQl0aGlzLmVuYWJsZWQoCgkJCQkJCSgob1Njb3BlKSA9PiB7CgkJCQkJCQlsZXQgcmV0ID0gdHJ1ZTsKCQkJCQkJCWlmICh0eXBlb2YocmV0KSA9PT0gImZ1bmN0aW9uIikgewoJCQkJCQkJCXJldCA9IHJldChvU2NvcGUpOwoJCQkJCQkJfQoJCQkJCQkJcmV0dXJuIHJldDsKCQkJCQkJfSkoc2FsZXNub3cpCgkJCQkJKTsKCQkJCX0KCgkJCQlpZiAoIXRoaXMuX2RhdGVfc2V0KSB7CgkJCQkJdGhpcy5kYXRlKAoJCQkJCQkoKG9TY29wZSkgPT4gewoJCQkJCQkJbGV0IHJldCA9IG5ldyBEYXRlKCk7CgkJCQkJCQlpZiAodHlwZW9mKHJldCkgPT09ICJmdW5jdGlvbiIpIHsKCQkJCQkJCQlyZXQgPSByZXQob1Njb3BlKTsKCQkJCQkJCX0KCQkJCQkJCXJldHVybiByZXQ7CgkJCQkJCX0pKHNhbGVzbm93KQoJCQkJCSk7CgkJCQl9CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNFbnRpdHlBdHRyaWJ1dGVzIikpIHsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBGaW5pc2hlZCBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0gSWQ9WyR7dGhpcy5JZH1dYCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fdHlwZV9Ob2Rlc19zZXQpIHsKCQkJCQkJZm9yIGF3YWl0IChjb25zdCB0YSBvZiB0aGlzLnR5cGVfTm9kZXMoKSkgewoJCQkJCQkJYXdhaXQgdGEuc3RvcmUoKTsKCQkJCQkJfQoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKGJVcGRhdGUgfHwgYkluc2VydCkgewoKCQkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCQlpZiAoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiAmJiAhc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgJiYgc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5Pd25lciA9PSB0aGlzKSB7CgkJCQkJCQlhd2FpdCB0aGlzLl9zcWwoYENPTU1JVCR7dGhpcy5fX2NvbmZpZygndHlwZScpPT0nc3FsaXRlJz8nIFRSQU5TQUNUSU9OJzonJ31gKTsKCQkJCQkJCXNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kID0gbmV3IERhdGUoKTsKCQkJCQkJfQoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCQl9CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJCX0KCgkJCQl9CgkJCX0KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBpbnNlcnQoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAiaW5zZXJ0IiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJpbnNlcnQiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgaW5zZXJ0KCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZV9UeXBlLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl0aGlzLl9mcm9tRG9jdW1lbnQoYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlsZXQgb2JqID0ge307CgoJCQkJaWYgKHRoaXMuX2R5bmFtaWNfc2V0KSB7CgoJCQkJCW9iai5keW5hbWljID0gdGhpcy5keW5hbWljKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9hY3RpdmVfc2V0KSB7CgoJCQkJCW9iai5hY3RpdmUgPSB0aGlzLmFjdGl2ZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZW5hYmxlZF9zZXQpIHsKCgkJCQkJb2JqLmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2NvZGVfc2V0KSB7CgoJCQkJCW9iai5jb2RlID0gdGhpcy5jb2RlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9vcmRlcl9zZXQpIHsKCgkJCQkJb2JqLm9yZGVyID0gdGhpcy5vcmRlcigpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fZGF0ZV9zZXQpIHsKCgkJCQkJb2JqLmRhdGUgPSB0aGlzLmRhdGUoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX25hbWVfc2V0KSB7CgoJCQkJCW9iai5uYW1lID0gdGhpcy5uYW1lKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9yZW1hcmtfc2V0KSB7CgoJCQkJCW9iai5yZW1hcmsgPSB0aGlzLnJlbWFyaygpOwoKCQkJCX0KCgkJCQlsb2coIlNlbmRpbmcgdG8gU0YiLCBvYmopOwoKCQkJCWxldCByZXMgPSBhd2FpdCB0aGlzLlRvb2wuZGIuc29iamVjdCgiTm9kZV9UeXBlIikuY3JlYXRlKG9iaik7CgkJCQl0aGlzLklkID0gcmVzLmlkOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5fX3N5bmNfb24obmV3IERhdGUoKSk7CgoJCQlyZXR1cm4gdGhpczsKCQl9LCB7CgkJCV9fYmVmb3JlUnVsZXM6IFtdLAoJCQlfX2FmdGVyUnVsZXM6IFtdCgkJfSk7CgoJCXJldHVybiAocmVzdWx0cy5maW5kKHIgPT4gci5yZXQpIHx8IHsKCQkJcmV0OiBudWxsCgkJfSkucmV0OyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyB1cGRhdGUoKSB7CgkJbGV0IHJlc3VsdHMgPSBhd2FpdCB0aGlzLl9leGVjdXRlKHNhbGVzbm93LCAidXBkYXRlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInVwZGF0ZSIsIF9ub2RlKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiKSA9PiB7CgkJCS8qKiogU1RBUlQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZV9UeXBlLnVwZGF0ZScpOwoKCQkJbGV0IHJldCA9IG51bGw7CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvVXBkYXRlU1FMKCkpOwoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fc3FsKHRoaXMuX3RvU2VsZWN0U1FMKCkpOwoJCQkJaWYgKEFycmF5LmlzQXJyYXkocmV0KSkgcmV0ID0gcmV0WzBdOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2AsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndXBkYXRlJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXN1bHQiLCByZXQpOwoJCQl0aGlzLl9fc3luY19vbihuZXcgRGF0ZSgpKTsKCQkJdGhpcy5fZnJvbURvY3VtZW50KHJldCwgdHJ1ZSk7CgoJCQlyZXR1cm4gcmV0OwoKCQkJLyoqKiBFTkQgTE9DQUwgdXBkYXRlKCkgKioqLwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGZpbmRBbGwoZGVwdGggPSAxLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJmaW5kQWxsIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImZpbmRBbGwiLCBfbm9kZSwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIGRlcHRoLCBvYmpzLCBzdGFydCwgZW5kLCBmaWVsZHMpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTm9kZV9UeXBlLmZpbmRBbGwnKTsKCgkJCS8vIGF2b2lkcyBjeWNsaWMgcXVlcmllcwoJCQlvYmpzID0gKG9ianMgfHwgW10pLm1hcChvID0+IG8uX2Nsb25lKCkpOwoKCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLz8/CgoJCQlsZXQgcmV0ID0gW107IC8vIGEganNvbiBhcnJheQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTChmaWVsZHMsIG9ianMpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgewoJCQkJCXN5c3Bhcm1fcXVlcnk6IE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvU05RdWVyeShmaWVsZHMsIG9ianMpKS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCB0cnVlKSwgbnVsbCwgewoJCQkJCXVybDogJ3Jlc3QudXJsLmdxbCcKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2ApOwoJCQkJcmV0ID0gcmV0LmNvbnRlbnQgPyBbSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSldIDogW107CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5tYXAociA9PiBuZXcgc2FsZXNub3cuTm9kZV9UeXBlKG51bGwsIHRoaXMuVG9vbCkuX2Zyb21Eb2N1bWVudChyLCB0cnVlLCB0cnVlKS5fX3N5bmNfb24obmV3IERhdGUoKSkpOwoKCQkJYXdhaXQgdGhpcy5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ2ZpbmRBbGwnLCAnRW50aXR5T2JqZWN0JywgMCwgIk91dHB1dCIsIHJldCk7CgoJCQlkZWxldGUgc2FsZXNub3cuX3VuUmVjdXJzZTsKCgkJCXJldHVybiByZXQ7CgkJCS8qKiogRU5EIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJfSwgewoJCQlkZXB0aCwKCQkJb2JqcywKCQkJc3RhcnQsCgkJCWVuZCwKCQkJZmllbGRzLAoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogW10KCQl9KS5yZXQgfHwgW107IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIF9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9maW5kUmVmZXJlbmNlcyhyZXQsIG9ianMsIGRlcHRoKTsKCgl9Cgp9OwoKc2FsZXNub3cuTWFwcGluZyA9IGNsYXNzIE1hcHBpbmcgZXh0ZW5kcyBzYWxlc25vdy5HZW5lcmljU2VydmljZUFQSSB7Cgljb25zdHJ1Y3RvcihpZCwgdG9vbCkgewoJCXN1cGVyKGlkLCB0b29sKTsKCgkJdGhpcy5TY29wZSA9ICJzYWxlc25vdyI7CgkJdGhpcy5EZWJ1ZyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYGV5SmpjbWwwYVdOaGJDSTZJaW9pTENKbGNuSnZjaUk2SWlvaUxDSjNZWEp1SWpvaUtpSXNJbWx1Wm04aU9pSXFMbWx1YVhRc0tpNWZjbVZ6ZEN3cUxsOXNiMkZrVkc5dmJITWlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5Db25maWcgPSBKU09OLnBhcnNlKCgodHlwZW9mKHRoaXMpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2YodGhpcy5fYXRvYikgIT09ICJ1bmRlZmluZWQiKSA/IHRoaXMuX2F0b2IgOiAodHlwZW9mKF9GckVNRCkgIT09ICJ1bmRlZmluZWQiID8gX0ZyRU1ELl9hdG9iIDogYXRvYikpKGBleUpPYjJSbElqcDdJbTV2UkdWMFpXTjBJanAwY25WbExDSnBibWwwTG1WdVpITWlPaklzSW1sdWFYUXViRzl2Y0NJNk1DNDFMQ0owYjI5c2N5NXpkRzl5WlNJNlptRnNjMlVzSW1SbGRHVmpkRkJoY21WdWRDNUpVQ0k2SWpFNE1pNHhOamd1TnpBdU9ESWlMQ0prWlhSbFkzUlFZWEpsYm5RdVkyOWtaU0k2SW1VNFpHVXdObVV6WldSak5EUXpZV1U1WkdabE1XUmxOV1ZqTlRKaE5HSm1JaXdpYzJWamNtVjBJam9pYjFOTGQyZGFNbk5MUms5VVNVcGpZa0ZtVlVsUk5FTnFPWEZ6U0RRNGJtd2lMQ0p3YkdGNVozSnZkVzVrSWpwMGNuVmxMQ0puVWxCRElqcDBjblZsTENKemRHOXlaUzV6Wlc1emFYUnBkbWwwZVNJNk1Td2lZMjl0Y0dGdWVTSTZJbkpsYzNWdFpTSjlMQ0pGZG1WdWRDSTZleUowY21sbloyVnlMblJwYldWdmRYUWlPakV3TURBd0xDSnpaV055WlhRaU9pSnZVMHQzWjFveWMwdEdUMVJKU21OaVFXWlZTVkUwUTJvNWNYTklORGh1YkNJc0luQnNZWGxuY205MWJtUWlPblJ5ZFdVc0ltZFNVRU1pT25SeWRXVXNJbk4wYjNKbExuTmxibk5wZEdsMmFYUjVJam94TENKamIyMXdZVzU1SWpvaWNtVnpkVzFsSW4wc0lsUnZiMndpT25zaVoybDBhSFZpTG5SdmIyeHpJam9pYUhSMGNITTZMeTl5WVhjdVoybDBhSFZpZFhObGNtTnZiblJsYm5RdVkyOXRMMlpoWkdsdUwyWmhaR2x1TG1kcGRHaDFZaTVwYnk5dFlYTjBaWEl2SWl3aWMyVmpjbVYwSWpvaWIxTkxkMmRhTW5OTFJrOVVTVXBqWWtGbVZVbFJORU5xT1hGelNEUTRibXdpTENKd2JHRjVaM0p2ZFc1a0lqcDBjblZsTENKblVsQkRJanAwY25WbExDSnpkRzl5WlM1elpXNXphWFJwZG1sMGVTSTZNU3dpWTI5dGNHRnVlU0k2SW5KbGMzVnRaU0o5TENKelpXTnlaWFFpT2lKdlUwdDNaMW95YzB0R1QxUkpTbU5pUVdaVlNWRTBRMm81Y1hOSU5EaHViQ0lzSW5Cc1lYbG5jbTkxYm1RaU9uUnlkV1VzSW1kU1VFTWlPblJ5ZFdVc0luTjBiM0psTG5ObGJuTnBkR2wyYVhSNUlqb3hMQ0pqYjIxd1lXNTVJam9pY21WemRXMWxJbjA9YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5UZXN0ID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKVmMyVnlJanA3SWw5aGRYUm9iM0pwZW1VdWRYTmxjbTVoYldVaU9pSm1ZV1JwSWl3aVgyRjFkR2h2Y21sNlpTNXdZWE56ZDI5eVpDSTZJakV5TXlJc0lsOWhkWFJvYjNKcGVtVXVkR1Z6ZEZWelpYSWlPbnNpWVdOMGFYWmxJanAwY25WbExDSmxibUZpYkdWa0lqcDBjblZsTENKblpXNWtaWElpT25zaVkyOWtaU0k2SWswaUxDSnVZVzFsSWpvaVRXRnNaU0o5TENKamIyUmxJam9pWm1Ga2FTSXNJbTVoYldVaU9pSkdZV1JwSW4xOWZRPT1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCQl0aGlzLlRvb2xzID0gSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgV3lKVGNXeEVRaUlzZXlKdVlXMWxJam9pVTA1UFYwOVBRaUlzSW5SNWNHVWlPbnNpYm1GdFpTSTZJbE5sY25acFkyVk9iM2NpZlgwc0lsTmhiR1Z6Um05eVkyVWlMQ0pIYVhSSWRXSWlYUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSk7CgkJdGhpcy5NYXBwaW5ncyA9IEpTT04ucGFyc2UoKCh0eXBlb2YodGhpcykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih0aGlzLl9hdG9iKSAhPT0gInVuZGVmaW5lZCIpID8gdGhpcy5fYXRvYiA6ICh0eXBlb2YoX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIgPyBfRnJFTUQuX2F0b2IgOiBhdG9iKSkoYFcxMD1gKSwgKGtleSwgdmFsdWUpID0+IHsKCQkJaWYgKHR5cGVvZih2YWx1ZSkgPT09ICJzdHJpbmciICYmIHZhbHVlLmluZGV4T2YoIj0+IikgPiAwKSByZXR1cm4gZXZhbCgiKCIgKyB2YWx1ZSArICIpIik7CgkJCXJldHVybiB2YWx1ZTsKCQl9KTsKCgkJLy8gYXZvaWQgc3VwZXIsIGtlZXAgdGhpcyBoZXJlCgkJdGhpcy5fX0lEID0gdGhpcy5fX0lEIHx8IHt9OwoJCXRoaXMuVG9vbCA9IHRvb2w7CgkJdGhpcy5JZCA9IGlkOwoKCQl0aGlzLlZhbHVlRW50aXRpZXMgPSBbXTsKCgkJdGhpcy5EYXRlID0gbnVsbDsKCgkJdGhpcy5jbGVhcl9USElTKCk7CgkJdGhpcy5FbnRpdHlWYWx1ZXMgPSBbXTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJhY3RpdmUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2FjdGl2ZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImVuYWJsZWQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2VuYWJsZWQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJvcmRlciIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfb3JkZXIoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJjbGFzc05hbWUiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NsYXNzTmFtZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInNjb3BlIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9zY29wZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogImNvbnRleHQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2NvbnRleHQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJzb3VyY2UiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX3NvdXJjZSgpOwoKCQl0aGlzLkVudGl0eVZhbHVlcy5wdXNoKHsKCQkJRW50aXR5QXR0cmlidXRlOiB7CgoJCQkJTmFtZTogInRhcmdldCIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfdGFyZ2V0KCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3BlcmF0b3IiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX29wZXJhdG9yKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAiaW5TY3JpcHQiLAoJCQkJT1BFUkFUT1JTOiB7CgkJCQkJTmFtZTogIj0iCgkJCQl9LAoJCQkJRW50aXR5Q2xhc3M6IHRoaXMuRW50aXR5Q2xhc3MsCgkJCX0sCgkJCU9QRVJBVE9SUzoge30KCQl9KTsKCQl0aGlzLmNsZWFyX2luU2NyaXB0KCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAib3V0U2NyaXB0IiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl9vdXRTY3JpcHQoKTsKCgkJdGhpcy5FbnRpdHlWYWx1ZXMucHVzaCh7CgkJCUVudGl0eUF0dHJpYnV0ZTogewoKCQkJCU5hbWU6ICJ0b29sIiwKCQkJCU9QRVJBVE9SUzogewoJCQkJCU5hbWU6ICI9IgoJCQkJfSwKCQkJCUVudGl0eUNsYXNzOiB0aGlzLkVudGl0eUNsYXNzLAoJCQl9LAoJCQlPUEVSQVRPUlM6IHt9CgkJfSk7CgkJdGhpcy5jbGVhcl90b29sKCk7CgoJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2goewoJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCgkJCQlOYW1lOiAidHlwZSIsCgkJCQlPUEVSQVRPUlM6IHsKCQkJCQlOYW1lOiAiPSIKCQkJCX0sCgkJCQlFbnRpdHlDbGFzczogdGhpcy5FbnRpdHlDbGFzcywKCQkJfSwKCQkJT1BFUkFUT1JTOiB7fQoJCX0pOwoJCXRoaXMuY2xlYXJfdHlwZSgpOwoKCX0KCglnZXQgRW50aXR5Q2xhc3MoKSB7CgkJbGV0IGVjID0gewoKCQkJTmFtZTogIk1hcHBpbmciLAoJCQlPUEVSQVRPUlM6IHsKCQkJCU5hbWU6ICI9IgoJCQl9LAoJCX07CgoJCS8vIHRoYXQncyB3aHkgd2UgbmVlZCBpdCBhcyBhIGdldHRlcgoJCWlmICghTnVtYmVyKGVjLklkKSAmJiBzYWxlc25vdy5FbnRpdHlDbGFzc2VzKSB7CgkJCWxldCBjaWQgPSBzYWxlc25vdy5FbnRpdHlDbGFzc2VzLmZpbmQoYyA9PiBOdW1iZXIoYy5JZCkgJiYgYy5OYW1lID09IGVjLk5hbWUpOwoJCQlpZiAoY2lkKSBlYy5JZCA9IGNpZC5JZDsKCQl9CgkJcmV0dXJuIGVjOwoJfQoKCWdldCBJZCgpIHsKCQlyZXR1cm4gdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCB0aGlzLl91dWlkKCk7Cgl9CgoJc2V0IElkKGlkKSB7CgkJaWYgKCF0aGlzLlRvb2wpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc2V0IElkJywgJ0VudGl0eU9iamVjdCcsIDAsICJFbXB0eSBUb29sIiwgdGhpcy5Ub29scy5sZW5ndGgsIHNhbGVzbm93LlRvb2xzLmxlbmd0aCk7CgkJCXJldHVybjsKCQl9CgkJdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSA9IGlkOwoJfQoKCWdldCBUb29sKCkgewoJCWlmICh0eXBlb2YodGhpcy5fX1Rvb2wpICE9PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX19Ub29sOwoJCWxldCBub1Rvb2wgPSB7CgkJCW5hbWU6ICcnLAoJCQl0eXBlOiB7CgkJCQluYW1lOiAnJwoJCQl9LAoJCX07CgkJaWYgKHR5cGVvZihzYWxlc25vdy5Ub29scykgIT09ICJ1bmRlZmluZWQiICYmICFBcnJheS5pc0FycmF5KHNhbGVzbm93LlRvb2xzKSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdnZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAyLCAic2FsZXNub3cuVG9vbHMgaXMgbm90IGFuIGFycmF5OiAiLCBzYWxlc25vdy5Ub29scyk7CgkJCXJldHVybiBub1Rvb2w7CgkJfQoJCWxldCByZXQgPSB0aGlzLlRvb2xzLmZpbmQodCA9PiAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbmQoX3QgPT4gdCA9PSBfdC5uYW1lIHx8IHQubmFtZSA9PSBfdC5uYW1lKSk7CgkJaWYgKHR5cGVvZihyZXQpICE9PSAndW5kZWZpbmVkJykgcmV0ID0gKHNhbGVzbm93LlRvb2xzIHx8IFtdKS5maW5kKHQgPT4gdC5uYW1lID09IHJldCB8fCB0Lm5hbWUgPT0gcmV0Lm5hbWUpOwoJCWlmICh0eXBlb2YocmV0KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiBub1Rvb2w7CgkJcmV0dXJuIHJldDsKCX0KCglzZXQgVG9vbCh0b29sKSB7CgkJaWYgKHR5cGVvZih0b29sKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQlpZiAodHlwZW9mKHRvb2wpID09PSAic3RyaW5nIikgewoJCQl0b29sID0gewoJCQkJbmFtZTogdG9vbAoJCQl9OwoJCX0KCQlpZiAodG9vbC5FbnRpdHlDbGFzcykgewoJCQl0b29sID0gdG9vbC5fdG9Eb2N1bWVudCgpOwoJCX0KCQlpZiAodHlwZW9mKHRvb2wubmFtZSkgPT09ICd1bmRlZmluZWQnICYmIHR5cGVvZih0b29sLnR5cGUubmFtZSkgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJdG9vbC50eXBlID0gdG9vbC50eXBlIHx8IHsKCQkJbmFtZTogdG9vbC5uYW1lCgkJfTsKCgkJaWYgKCF0b29sLnR5cGUgJiYgIXRvb2wubmFtZSkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdzZXQgVG9vbCcsICdFbnRpdHlPYmplY3QnLCAxLCAiRW1wdHkgVG9vbCBvYmplY3QiKTsKCQkJcmV0dXJuOwoJCX0KCgkJbGV0IHQgPSAoc2FsZXNub3cuVG9vbHMgfHwgW10pLmZpbHRlcih0ID0+IHQubmFtZSAmJiB0LnR5cGUpLmZpbmQodCA9PiAodC5uYW1lID09IHRvb2wubmFtZSkgfHwgKHQudHlwZS5uYW1lID09IHRvb2wudHlwZS5uYW1lKSk7CgkJaWYgKCF0KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3NldCBUb29sJywgJ0VudGl0eU9iamVjdCcsIDAsICJubyBtYXRjaGluZyB0b29sIiwgdG9vbCwgc2FsZXNub3cuVG9vbHMpOwoJCQlyZXR1cm47CgkJfQoKCQl0aGlzLl9fVG9vbCA9IHQ7CgoJCS8vIGlmKHRoaXMuX3Rvb2xfc2V0ICYmIHRoaXMuX3Rvb2wpIHRoaXMuX3Rvb2wuVG9vbCA9IHRvb2w7CgoJCS8vIGlmKHRoaXMuX3R5cGVfc2V0ICYmIHRoaXMuX3R5cGUpIHRoaXMuX3R5cGUuVG9vbCA9IHRvb2w7CgoJCXJldHVybiB0aGlzOwoJfQoKCVRISVModiwgY28pIHsKCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHRoaXMuX1RISVM7CgkJaWYgKCF2KSByZXR1cm4gdGhpczsKCQl2ID0gQXJyYXkuaXNBcnJheSh2KSA/IHYgOiBbdl07CgkJdGhpcy5fVEhJUyA9IHYuZmlsdGVyKF92ID0+IHR5cGVvZihfdikgPT09ICdvYmplY3QnICYmIF92LkVudGl0eUNsYXNzICYmIF92LkVudGl0eUNsYXNzLk5hbWUgPT0gdGhpcy5FbnRpdHlDbGFzcy5OYW1lICYmIF92LlNjb3BlID09IHRoaXMuU2NvcGUpOwoJCWlmIChjbykgdGhpcy5fVEhJU19jb29wID0gY287CgkJcmV0dXJuIHRoaXM7Cgl9CgoJY2xlYXJfVEhJUygpIHsKCQl0aGlzLl9USElTID0gW107CgkJdGhpcy5fVEhJU19jb29wID0gJyc7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBhY3RpdmUgKiovCglhY3RpdmUodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9hY3RpdmVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJhY3RpdmUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlfdiA9IFsidHJ1ZSIsICIxIiwgInllcyIsIHRydWUsIDFdLmluY2x1ZGVzKF92KTsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkJvb2xWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl9hY3RpdmUgIT0gdikgewoJCQkJdGhpcy5fYWN0aXZlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9hY3RpdmUgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5Cb29sVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2FjdGl2ZSk7CgkJfQoJfQoKCWNsZWFyX2FjdGl2ZSgpIHsKCQl0aGlzLl9hY3RpdmVfc2V0ID0gbnVsbDsKCQl0aGlzLl9hY3RpdmUgPSBudWxsOwoJCXRoaXMuX2FjdGl2ZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgYWN0aXZlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgZW5hYmxlZCAqKi8KCWVuYWJsZWQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9lbmFibGVkX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiZW5hYmxlZCIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCV92ID0gWyJ0cnVlIiwgIjEiLCAieWVzIiwgdHJ1ZSwgMV0uaW5jbHVkZXMoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuQm9vbFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2VuYWJsZWQgIT0gdikgewoJCQkJdGhpcy5fZW5hYmxlZF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fZW5hYmxlZCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkJvb2xWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fZW5hYmxlZCk7CgkJfQoJfQoKCWNsZWFyX2VuYWJsZWQoKSB7CgkJdGhpcy5fZW5hYmxlZF9zZXQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWQgPSBudWxsOwoJCXRoaXMuX2VuYWJsZWRfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGVuYWJsZWQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCW9yZGVyKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3JkZXJfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcmRlciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCWlmIChpc05hTihfdikpIF92ID0gMDsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LkludFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX29yZGVyICE9IHYpIHsKCQkJCXRoaXMuX29yZGVyX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9vcmRlciA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLkludFZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9vcmRlcik7CgkJfQoJfQoKCWNsZWFyX29yZGVyKCkgewoJCXRoaXMuX29yZGVyX3NldCA9IG51bGw7CgkJdGhpcy5fb3JkZXIgPSBudWxsOwoJCXRoaXMuX29yZGVyX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcmRlciAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNsYXNzTmFtZSAqKi8KCWNsYXNzTmFtZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2NsYXNzTmFtZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNsYXNzTmFtZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fY2xhc3NOYW1lICE9IHYpIHsKCQkJCXRoaXMuX2NsYXNzTmFtZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY2xhc3NOYW1lID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX2NsYXNzTmFtZSk7CgkJfQoJfQoKCWNsZWFyX2NsYXNzTmFtZSgpIHsKCQl0aGlzLl9jbGFzc05hbWVfc2V0ID0gbnVsbDsKCQl0aGlzLl9jbGFzc05hbWUgPSBudWxsOwoJCXRoaXMuX2NsYXNzTmFtZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY2xhc3NOYW1lICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc2NvcGUgKiovCglzY29wZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3Njb3BlX2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgic2NvcGUiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3Njb3BlICE9IHYpIHsKCQkJCXRoaXMuX3Njb3BlX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9zY29wZSA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9zY29wZSk7CgkJfQoJfQoKCWNsZWFyX3Njb3BlKCkgewoJCXRoaXMuX3Njb3BlX3NldCA9IG51bGw7CgkJdGhpcy5fc2NvcGUgPSBudWxsOwoJCXRoaXMuX3Njb3BlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBzY29wZSAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIGNvbnRleHQgKiovCgljb250ZXh0KHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fY29udGV4dF9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoImNvbnRleHQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlyZXR1cm4gX3Y7CgoJCQl9KSh2KTsKCgkJCWV2LlN0cmluZ1ZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2NvbnRleHQgIT0gdikgewoJCQkJdGhpcy5fY29udGV4dF9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fY29udGV4dCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlN0cmluZ1ZhbHVlID0gY287CgoJCQlyZXR1cm4gdGhpczsKCQl9IGVsc2UgewoJCQlyZXR1cm4gdGhpcy5pMThuKGV2LCB0aGlzLl9jb250ZXh0KTsKCQl9Cgl9CgoJY2xlYXJfY29udGV4dCgpIHsKCQl0aGlzLl9jb250ZXh0X3NldCA9IG51bGw7CgkJdGhpcy5fY29udGV4dCA9IG51bGw7CgkJdGhpcy5fY29udGV4dF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgY29udGV4dCAqKi8KCgkvKiogc3RhcnQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHNvdXJjZSAqKi8KCXNvdXJjZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3NvdXJjZV9jb29wID0gY287CgoJCXZhciBldiA9IHRoaXMuRW50aXR5VmFsdWUoInNvdXJjZSIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fc291cmNlICE9IHYpIHsKCQkJCXRoaXMuX3NvdXJjZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJfQoKCQkJdGhpcy5fc291cmNlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3NvdXJjZSk7CgkJfQoJfQoKCWNsZWFyX3NvdXJjZSgpIHsKCQl0aGlzLl9zb3VyY2Vfc2V0ID0gbnVsbDsKCQl0aGlzLl9zb3VyY2UgPSBudWxsOwoJCXRoaXMuX3NvdXJjZV9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3Igc291cmNlICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgdGFyZ2V0ICoqLwoJdGFyZ2V0KHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fdGFyZ2V0X2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgidGFyZ2V0Iik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlldi5TdHJpbmdWYWx1ZSA9IHY7CgoJCQlpZiAodHJ1ZSB8fCB0aGlzLl90YXJnZXQgIT0gdikgewoJCQkJdGhpcy5fdGFyZ2V0X3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl90YXJnZXQgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5TdHJpbmdWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fdGFyZ2V0KTsKCQl9Cgl9CgoJY2xlYXJfdGFyZ2V0KCkgewoJCXRoaXMuX3RhcmdldF9zZXQgPSBudWxsOwoJCXRoaXMuX3RhcmdldCA9IG51bGw7CgkJdGhpcy5fdGFyZ2V0X2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0YXJnZXQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvcGVyYXRvciAqKi8KCW9wZXJhdG9yKHYsIGNvLCBpZCkgewoJCWlmIChjbykgdGhpcy5fb3BlcmF0b3JfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvcGVyYXRvciIpOwoJCWlmICghZXYpIHsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlpZiAoaWQpIGV2LklkID0gaWQ7CgoJCWlmICh0eXBlb2YodikgIT09ICd1bmRlZmluZWQnKSB7CgkJCS8vIHZhbHVlcyB3ZXJlIGdpdmVuLCB0aGVyZWZvcmUgYSBzZXR0ZXIKCgkJCXYgPSAoX3YgPT4gewoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuU3RyaW5nVmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fb3BlcmF0b3IgIT0gdikgewoJCQkJdGhpcy5fb3BlcmF0b3Jfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX29wZXJhdG9yID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuU3RyaW5nVmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX29wZXJhdG9yKTsKCQl9Cgl9CgoJY2xlYXJfb3BlcmF0b3IoKSB7CgkJdGhpcy5fb3BlcmF0b3Jfc2V0ID0gbnVsbDsKCQl0aGlzLl9vcGVyYXRvciA9IG51bGw7CgkJdGhpcy5fb3BlcmF0b3JfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIG9wZXJhdG9yICoqLwoKCS8qKiBzdGFydDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgaW5TY3JpcHQgKiovCglpblNjcmlwdCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX2luU2NyaXB0X2Nvb3AgPSBjbzsKCgkJdmFyIGV2ID0gdGhpcy5FbnRpdHlWYWx1ZSgiaW5TY3JpcHQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX2luU2NyaXB0ICE9IHYpIHsKCQkJCXRoaXMuX2luU2NyaXB0X3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQl9CgoJCQl0aGlzLl9pblNjcmlwdCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5faW5TY3JpcHQpOwoJCX0KCX0KCgljbGVhcl9pblNjcmlwdCgpIHsKCQl0aGlzLl9pblNjcmlwdF9zZXQgPSBudWxsOwoJCXRoaXMuX2luU2NyaXB0ID0gbnVsbDsKCQl0aGlzLl9pblNjcmlwdF9jb29wID0gIiI7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJLyoqIGVuZDogc2V0dGVycyBhbmQgZ2V0dGVycyBmb3IgaW5TY3JpcHQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvdXRTY3JpcHQgKiovCglvdXRTY3JpcHQodiwgY28sIGlkKSB7CgkJaWYgKGNvKSB0aGlzLl9vdXRTY3JpcHRfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJvdXRTY3JpcHQiKTsKCQlpZiAoIWV2KSB7CgkJCXJldHVybiB0aGlzOwoJCX0KCgkJaWYgKGlkKSBldi5JZCA9IGlkOwoKCQlpZiAodHlwZW9mKHYpICE9PSAndW5kZWZpbmVkJykgewoJCQkvLyB2YWx1ZXMgd2VyZSBnaXZlbiwgdGhlcmVmb3JlIGEgc2V0dGVyCgoJCQl2ID0gKF92ID0+IHsKCgkJCQlpZiAodHlwZW9mKF92KSA9PT0gJ29iamVjdCcpIF92ID0gSlNPTi5zdHJpbmdpZnkoX3YpOwoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZXYuVGV4dFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX291dFNjcmlwdCAhPSB2KSB7CgkJCQl0aGlzLl9vdXRTY3JpcHRfc2V0ID0gbmV3IERhdGUoKTsgLy8gYSBjaGFuZ2UgaW4gdmFsdWUKCgkJCX0KCgkJCXRoaXMuX291dFNjcmlwdCA9IHY7CgkJCWlmIChjbykgZXYuT1BFUkFUT1JTLlRleHRWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fb3V0U2NyaXB0KTsKCQl9Cgl9CgoJY2xlYXJfb3V0U2NyaXB0KCkgewoJCXRoaXMuX291dFNjcmlwdF9zZXQgPSBudWxsOwoJCXRoaXMuX291dFNjcmlwdCA9IG51bGw7CgkJdGhpcy5fb3V0U2NyaXB0X2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciBvdXRTY3JpcHQgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0b29sICoqLwoJdG9vbCh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3Rvb2xfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJ0b29sIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnNzM5YmM4NWEtOGQwZC00MmQyLTk1ZDctMmY4NDc1ODU2YTg5JyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnVG9vbCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd0b29sJywgJ0VudGl0eU9iamVjdCcsIDEsICJHT1QgSEVSRSIsIF92LCAiNzM5YmM4NWEtOGQwZC00MmQyLTk1ZDctMmY4NDc1ODU2YTg5IiwgX3YuRW50aXR5Q2xhc3MuTmFtZSwgIlRvb2wiKTsKCQkJCX0gZWxzZSB7CgkJCQkJX3YgPSAoKF92ICYmICF0aGlzLklkICYmIF92LnRvRW50aXR5T2JqZWN0KSA/IF92LnRvRW50aXR5T2JqZWN0KCkgOiBfdik7CgkJCQl9CgoJCQkJcmV0dXJuIF92OwoKCQkJfSkodik7CgoJCQlkZWxldGUgZXYuT2JqZWN0VmFsdWVpZDsKCQkJZXYuT2JqZWN0VmFsdWUgPSB2OwoKCQkJaWYgKHRydWUgfHwgdGhpcy5fdG9vbCAhPSB2KSB7CgkJCQl0aGlzLl90b29sX3NldCA9IG5ldyBEYXRlKCk7IC8vIGEgY2hhbmdlIGluIHZhbHVlCgoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAndG9vbCcsICdFbnRpdHlPYmplY3QnLCAwLCAiU2V0IGFmdGVyIiwgdGhpcy5fdG9vbCA/IHRoaXMuX3Rvb2wuU2V0X09uIDogbnVsbCwgdiA/IHYuU2V0X09uIDogbnVsbCk7CgkJCQkvKmlmKHYpIHRoaXMuX3Rvb2xfc2V0ID0gdi5TZXRfT247Ki8KCgkJCX0KCgkJCXRoaXMuX3Rvb2wgPSB2OwoJCQlpZiAoY28pIGV2Lk9QRVJBVE9SUy5FbnRpdHlWYWx1ZSA9IGNvOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIHRoaXMuaTE4bihldiwgdGhpcy5fdG9vbCk7CgkJfQoJfQoKCWNsZWFyX3Rvb2woKSB7CgkJdGhpcy5fdG9vbF9zZXQgPSBudWxsOwoJCXRoaXMuX3Rvb2wgPSBudWxsOwoJCXRoaXMuX3Rvb2xfY29vcCA9ICIiOwoJCXJldHVybiB0aGlzOwoJfQoKCS8qKiBlbmQ6IHNldHRlcnMgYW5kIGdldHRlcnMgZm9yIHRvb2wgKiovCgoJLyoqIHN0YXJ0OiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0eXBlICoqLwoJdHlwZSh2LCBjbywgaWQpIHsKCQlpZiAoY28pIHRoaXMuX3R5cGVfY29vcCA9IGNvOwoKCQl2YXIgZXYgPSB0aGlzLkVudGl0eVZhbHVlKCJ0eXBlIik7CgkJaWYgKCFldikgewoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCWlmIChpZCkgZXYuSWQgPSBpZDsKCgkJaWYgKHR5cGVvZih2KSAhPT0gJ3VuZGVmaW5lZCcpIHsKCQkJLy8gdmFsdWVzIHdlcmUgZ2l2ZW4sIHRoZXJlZm9yZSBhIHNldHRlcgoKCQkJdiA9IChfdiA9PiB7CgoJCQkJaWYgKF92ICYmIF92LnRvRW50aXR5T2JqZWN0ICYmIF92LkVudGl0eUNsYXNzLklkICE9PSAnNDY4ZTYxNjEtM2RmOC00ZmRmLWFlNTAtMGRiMjkzNmU2NTA0JyAmJiBfdi5FbnRpdHlDbGFzcy5OYW1lICE9PSAnVG9vbCBUeXBlJykgewoJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3R5cGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIkdPVCBIRVJFIiwgX3YsICI0NjhlNjE2MS0zZGY4LTRmZGYtYWU1MC0wZGIyOTM2ZTY1MDQiLCBfdi5FbnRpdHlDbGFzcy5OYW1lLCAiVG9vbCBUeXBlIik7CgkJCQl9IGVsc2UgewoJCQkJCV92ID0gKChfdiAmJiAhdGhpcy5JZCAmJiBfdi50b0VudGl0eU9iamVjdCkgPyBfdi50b0VudGl0eU9iamVjdCgpIDogX3YpOwoJCQkJfQoKCQkJCXJldHVybiBfdjsKCgkJCX0pKHYpOwoKCQkJZGVsZXRlIGV2Lk9iamVjdFZhbHVlaWQ7CgkJCWV2Lk9iamVjdFZhbHVlID0gdjsKCgkJCWlmICh0cnVlIHx8IHRoaXMuX3R5cGUgIT0gdikgewoJCQkJdGhpcy5fdHlwZV9zZXQgPSBuZXcgRGF0ZSgpOyAvLyBhIGNoYW5nZSBpbiB2YWx1ZQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3R5cGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNldCBhZnRlciIsIHRoaXMuX3R5cGUgPyB0aGlzLl90eXBlLlNldF9PbiA6IG51bGwsIHYgPyB2LlNldF9PbiA6IG51bGwpOwoJCQkJLyppZih2KSB0aGlzLl90eXBlX3NldCA9IHYuU2V0X09uOyovCgoJCQl9CgoJCQl0aGlzLl90eXBlID0gdjsKCQkJaWYgKGNvKSBldi5PUEVSQVRPUlMuRW50aXR5VmFsdWUgPSBjbzsKCgkJCXJldHVybiB0aGlzOwoJCX0gZWxzZSB7CgkJCXJldHVybiB0aGlzLmkxOG4oZXYsIHRoaXMuX3R5cGUpOwoJCX0KCX0KCgljbGVhcl90eXBlKCkgewoJCXRoaXMuX3R5cGVfc2V0ID0gbnVsbDsKCQl0aGlzLl90eXBlID0gbnVsbDsKCQl0aGlzLl90eXBlX2Nvb3AgPSAiIjsKCQlyZXR1cm4gdGhpczsKCX0KCgkvKiogZW5kOiBzZXR0ZXJzIGFuZCBnZXR0ZXJzIGZvciB0eXBlICoqLwoKCWdldCBTZXRfT24oKSB7CgkJbGV0IHJldCA9IG5ldyBEYXRlKE1hdGgubWF4KAoKCQkJdGhpcy5fYWN0aXZlX3NldCwKCgkJCXRoaXMuX2VuYWJsZWRfc2V0LAoKCQkJdGhpcy5fb3JkZXJfc2V0LAoKCQkJdGhpcy5fY2xhc3NOYW1lX3NldCwKCgkJCXRoaXMuX3Njb3BlX3NldCwKCgkJCXRoaXMuX2NvbnRleHRfc2V0LAoKCQkJdGhpcy5fc291cmNlX3NldCwKCgkJCXRoaXMuX3RhcmdldF9zZXQsCgoJCQl0aGlzLl9vcGVyYXRvcl9zZXQsCgoJCQl0aGlzLl9pblNjcmlwdF9zZXQsCgoJCQl0aGlzLl9vdXRTY3JpcHRfc2V0LAoKCQkJdGhpcy5fdG9vbF9zZXQsCgoJCQl0aGlzLl90eXBlX3NldCwKCgkJKSk7CgoJCWlmICghcmV0IHx8ICEocmV0IGluc3RhbmNlb2YgRGF0ZSAmJiAhaXNOYU4ocmV0KSkpIHJldHVybiB1bmRlZmluZWQ7CgkJcmV0dXJuIHJldDsKCX0KCglfZmxhdHRlbihkZXB0aCkgewoJCWxldCByZXQgPSB7fTsKCQlpZiAoIWRlcHRoKSByZXR1cm4gcmV0OwoKCQlyZXQuX2FjdGl2ZV9zZXQgPSB0aGlzLl9hY3RpdmVfc2V0OwoJCXJldC5fYWN0aXZlX2Nvb3AgPSB0aGlzLl9hY3RpdmVfY29vcDsKCQlyZXQuYWN0aXZlID0gdGhpcy5hY3RpdmUoKSA/IHRoaXMuYWN0aXZlKCkgOiB0aGlzLmFjdGl2ZSgpOwoKCQlyZXQuX2VuYWJsZWRfc2V0ID0gdGhpcy5fZW5hYmxlZF9zZXQ7CgkJcmV0Ll9lbmFibGVkX2Nvb3AgPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJcmV0LmVuYWJsZWQgPSB0aGlzLmVuYWJsZWQoKSA/IHRoaXMuZW5hYmxlZCgpIDogdGhpcy5lbmFibGVkKCk7CgoJCXJldC5fb3JkZXJfc2V0ID0gdGhpcy5fb3JkZXJfc2V0OwoJCXJldC5fb3JkZXJfY29vcCA9IHRoaXMuX29yZGVyX2Nvb3A7CgkJcmV0Lm9yZGVyID0gdGhpcy5vcmRlcigpID8gdGhpcy5vcmRlcigpIDogdGhpcy5vcmRlcigpOwoKCQlyZXQuX2NsYXNzTmFtZV9zZXQgPSB0aGlzLl9jbGFzc05hbWVfc2V0OwoJCXJldC5fY2xhc3NOYW1lX2Nvb3AgPSB0aGlzLl9jbGFzc05hbWVfY29vcDsKCQlyZXQuY2xhc3NOYW1lID0gdGhpcy5jbGFzc05hbWUoKSA/IHRoaXMuY2xhc3NOYW1lKCkgOiB0aGlzLmNsYXNzTmFtZSgpOwoKCQlyZXQuX3Njb3BlX3NldCA9IHRoaXMuX3Njb3BlX3NldDsKCQlyZXQuX3Njb3BlX2Nvb3AgPSB0aGlzLl9zY29wZV9jb29wOwoJCXJldC5zY29wZSA9IHRoaXMuc2NvcGUoKSA/IHRoaXMuc2NvcGUoKSA6IHRoaXMuc2NvcGUoKTsKCgkJcmV0Ll9jb250ZXh0X3NldCA9IHRoaXMuX2NvbnRleHRfc2V0OwoJCXJldC5fY29udGV4dF9jb29wID0gdGhpcy5fY29udGV4dF9jb29wOwoJCXJldC5jb250ZXh0ID0gdGhpcy5jb250ZXh0KCkgPyB0aGlzLmNvbnRleHQoKSA6IHRoaXMuY29udGV4dCgpOwoKCQlyZXQuX3NvdXJjZV9zZXQgPSB0aGlzLl9zb3VyY2Vfc2V0OwoJCXJldC5fc291cmNlX2Nvb3AgPSB0aGlzLl9zb3VyY2VfY29vcDsKCQlyZXQuc291cmNlID0gdGhpcy5zb3VyY2UoKSA/IHRoaXMuc291cmNlKCkgOiB0aGlzLnNvdXJjZSgpOwoKCQlyZXQuX3RhcmdldF9zZXQgPSB0aGlzLl90YXJnZXRfc2V0OwoJCXJldC5fdGFyZ2V0X2Nvb3AgPSB0aGlzLl90YXJnZXRfY29vcDsKCQlyZXQudGFyZ2V0ID0gdGhpcy50YXJnZXQoKSA/IHRoaXMudGFyZ2V0KCkgOiB0aGlzLnRhcmdldCgpOwoKCQlyZXQuX29wZXJhdG9yX3NldCA9IHRoaXMuX29wZXJhdG9yX3NldDsKCQlyZXQuX29wZXJhdG9yX2Nvb3AgPSB0aGlzLl9vcGVyYXRvcl9jb29wOwoJCXJldC5vcGVyYXRvciA9IHRoaXMub3BlcmF0b3IoKSA/IHRoaXMub3BlcmF0b3IoKSA6IHRoaXMub3BlcmF0b3IoKTsKCgkJcmV0Ll9pblNjcmlwdF9zZXQgPSB0aGlzLl9pblNjcmlwdF9zZXQ7CgkJcmV0Ll9pblNjcmlwdF9jb29wID0gdGhpcy5faW5TY3JpcHRfY29vcDsKCQlyZXQuaW5TY3JpcHQgPSB0aGlzLmluU2NyaXB0KCkgPyB0aGlzLmluU2NyaXB0KCkgOiB0aGlzLmluU2NyaXB0KCk7CgoJCXJldC5fb3V0U2NyaXB0X3NldCA9IHRoaXMuX291dFNjcmlwdF9zZXQ7CgkJcmV0Ll9vdXRTY3JpcHRfY29vcCA9IHRoaXMuX291dFNjcmlwdF9jb29wOwoJCXJldC5vdXRTY3JpcHQgPSB0aGlzLm91dFNjcmlwdCgpID8gdGhpcy5vdXRTY3JpcHQoKSA6IHRoaXMub3V0U2NyaXB0KCk7CgoJCXJldC5fdG9vbF9zZXQgPSB0aGlzLl90b29sX3NldDsKCQlyZXQuX3Rvb2xfY29vcCA9IHRoaXMuX3Rvb2xfY29vcDsKCQlyZXQudG9vbCA9IHRoaXMudG9vbCgpID8gdGhpcy50b29sKCkuX2ZsYXR0ZW4oZGVwdGggLSAxKSA6IHRoaXMudG9vbCgpOwoKCQlyZXQuX3R5cGVfc2V0ID0gdGhpcy5fdHlwZV9zZXQ7CgkJcmV0Ll90eXBlX2Nvb3AgPSB0aGlzLl90eXBlX2Nvb3A7CgkJcmV0LnR5cGUgPSB0aGlzLnR5cGUoKSA/IHRoaXMudHlwZSgpLl9mbGF0dGVuKGRlcHRoIC0gMSkgOiB0aGlzLnR5cGUoKTsKCgkJcmV0dXJuIHJldDsKCX0KCglfdG9IYXNoKGFyZ3MsIG9wdGlvbnMpIHsKCQlvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCQlvcHRpb25zLmNhY2hlTGltaXQgPSBvcHRpb25zLmNhY2hlTGltaXQgfHwgNTsKCgkJbGV0IG9IYXNoID0gewoJCQlhcmdzOiBhcmdzLAoJCQlfdGhpczoge30gLy8gdGhpcy5fcHJ1bmUodGhpcykgZG9lcyBub3Qgd29yayBiZWNhdXNlIElkIGlzIG5vdCBleGNsdWRlZCBmb3IgcXVlcmllczsgdGhpcy5fcHJ1bmUodGhpcy5fdG9Eb2N1bWVudCgpKSBjcmVhdGVzIGNpcmN1bGFycwoJCX07CgoJCWlmICh0cnVlIHx8IG9wdGlvbnMuZGVwdGgpIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9mbGF0dGVuKG9wdGlvbnMuZGVwdGggfHwgMyk7CgkJfSBlbHNlIHsKCQkJb0hhc2guX3RoaXMgPSB0aGlzLl9fZXhwb3J0KG9IYXNoLl90aGlzLCB7CgkJCQlPUEVSQVRPUlM6IHRydWUsCgkJCQlJZDogKG9iaiwgdikgPT4gb2JqLklkID0gdiwKCgkJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJIm9yZGVyIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY2xhc3NOYW1lIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NsYXNzTmFtZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInNjb3BlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Njb3BlJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkiY29udGV4dCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250ZXh0JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkic291cmNlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3NvdXJjZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInRhcmdldCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0YXJnZXQnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQl9LAoKCQkJCSJvcGVyYXRvciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcGVyYXRvcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJImluU2NyaXB0IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2luU2NyaXB0JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJfSwKCgkJCQkib3V0U2NyaXB0IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ291dFNjcmlwdCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCX0sCgoJCQkJInRvb2wiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndG9vbCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQkJInR5cGUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IGggPSBvcHRpb25zLmNhY2hlID8gb3B0aW9ucy5jYWNoZS5maW5kKF9oID0+IF9oLm9iaiA9PSB2KSA6IG51bGw7CgkJCQkJCW9ialtlYUNvZGVdID0gaCA/IGguaGFzaCA6ICgob3B0aW9ucy5jYWNoZSAmJiBvcHRpb25zLmNhY2hlLmxlbmd0aCA8IG9wdGlvbnMuY2FjaGVMaW1pdCkgPyB2Ll90b0hhc2gobnVsbCwgb3B0aW9ucykgOiBudWxsKTsKCQkJCQkJaWYgKG9wdGlvbnMuY2FjaGUgJiYgIWgpIG9wdGlvbnMuY2FjaGUucHVzaCh7CgkJCQkJCQlvYmo6IHYsCgkJCQkJCQloYXNoOiBvYmpbZWFDb2RlXQoJCQkJCQl9KTsKCQkJCQl9IGVsc2UgewoJCQkJCQlvYmpbZWFDb2RlXSA9IHY7CgkJCQkJfQoKCQkJCX0sCgoJCQl9LCAiX3RvSGFzaCIpOwoJCX0KCgkJcmV0dXJuIG9wdGlvbnMuTm9Db2RlID8gb0hhc2ggOiB0aGlzLmhhc2hDb2RlKEpTT04uc3RyaW5naWZ5KG9IYXNoKSk7Cgl9CgoJYXN5bmMgX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F1dGhvcml6ZSh1c2VybmFtZSwgcGFzc3dvcmQsIGJTZXJ2ZXIpOwoKCX0KCglfcWxTZWxlY3Rpb25zKHNTZXQpIHsKCQlsZXQgcmV0ID0gW107CgkJaWYgKCFzU2V0IHx8ICFzU2V0LnNlbGVjdGlvbnMpIHJldHVybiByZXQ7CgoJCXNTZXQuc2VsZWN0aW9ucy5maWx0ZXIocyA9PiBzLnNlbGVjdGlvblNldCkuZm9yRWFjaChzID0+IHsKCgkJCWlmIChzLm5hbWUudmFsdWUgPT0gInRvb2wiKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfcWxTZWxlY3Rpb25zJywgJ0VudGl0eU9iamVjdCcsIDAsICdSZWZlcmVuY2UgZm9yIHRvb2wnLCBzKTsKCQkJCWxldCBzT2JqID0gbmV3IHNhbGVzbm93LlRvb2woKS50b29sX01hcHBpbmdzKHRoaXMpOwoJCQkJcmV0LnB1c2goc09iaik7CgkJCQlyZXQucHVzaCguLi5zT2JqLl9xbFNlbGVjdGlvbnMocy5zZWxlY3Rpb25TZXQpKTsKCQkJfQoKCQkJaWYgKHMubmFtZS52YWx1ZSA9PSAidHlwZSIpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19xbFNlbGVjdGlvbnMnLCAnRW50aXR5T2JqZWN0JywgMCwgJ1JlZmVyZW5jZSBmb3IgdHlwZScsIHMpOwoJCQkJbGV0IHNPYmogPSBuZXcgc2FsZXNub3cuVG9vbF9UeXBlKCkudHlwZV9NYXBwaW5ncyh0aGlzKTsKCQkJCXJldC5wdXNoKHNPYmopOwoJCQkJcmV0LnB1c2goLi4uc09iai5fcWxTZWxlY3Rpb25zKHMuc2VsZWN0aW9uU2V0KSk7CgkJCX0KCgkJfSk7CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgX2ludm9rZU5vZGUobiwgbWV0aG9kLCBkYXRhLCBldmVudCwgYlJhdykgewoJCS8vIGlmKCFuKSByZXR1cm4gbnVsbDsKCgkJaWYgKHR5cGVvZihzYWxlc25vdy5fbm9kZSkgPT09ICd1bmRlZmluZWQnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDEsICJzYWxlc25vdy5fbm9kZSBub3QgZGVmaW5lZCIpOwoJCQlyZXR1cm4gbnVsbDsKCQl9CgoJCWlmIChldmVudCkgewoKCQkJaWYgKGV2ZW50Ll9jbGFzc05hbWVfc2V0ICYmIGV2ZW50LmNsYXNzTmFtZSgpICYmIGV2ZW50LmNsYXNzTmFtZSgpICE9ICdNYXBwaW5nJykgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkRlbGVnYXRpbmcgaW52b2thdGlvbiB0byAiICsgZXZlbnQuY2xhc3NOYW1lKCkpOwoJCQkJcmV0dXJuIG5ldyBzYWxlc25vd1tldmVudC5jbGFzc05hbWUoKV0oKS5faW52b2tlTm9kZShuLCBtZXRob2QsIGRhdGEsIGV2ZW50LCBiUmF3KTsKCQkJfQoKCQl9CgoJCWxldCByZXQgPSBudWxsOwoKCQlkYXRhID0gZGF0YSB8fCB7fTsKCgkJaWYgKHR5cGVvZihkYXRhKSA9PT0gIm9iamVjdCIpIHsKCQkJZGF0YS5fX3RoaXMgPSBkYXRhLl9fdGhpcyB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJCXN3aXRjaCAobWV0aG9kKSB7CgoJCQl9CgkJfQoKCQlpZiAoIW4gfHwgc2FsZXNub3cuX25vZGUuX3NhbWVOb2RlKG4pKSB7CgkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDAsICJDYWxsYmFjayIpOwoJCQlyZXQgPSBhd2FpdCB0aGlzLl9pbnZva2UobWV0aG9kLCBkYXRhKTsKCQl9IGVsc2UgaWYgKG4uYWRkcmVzcygpICYmIG4uX3NhbWVOb2RlKG4pIC8qYWN0dWFsIG5vZGUqLyApIHsKCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgbi5fYWRkcmVzcywgbi5fcG9ydCwgbWV0aG9kKTsKCQkJdHJ5IHsKCQkJCWxldCBjb25maWcgPSB7CgkJCQkJaGVhZGVyczoge30sCgkJCQl9OwoJCQkJaWYgKHNhbGVzbm93Ll9fdG9rZW4pIGNvbmZpZy5oZWFkZXJzLkF1dGhvcml6YXRpb24gPSBgJHtzYWxlc25vdy5fX3Rva2VuLnRva2VuX3R5cGV9ICR7c2FsZXNub3cuX190b2tlbi5hY2Nlc3NfdG9rZW59YDsKCQkJCXJldCA9IGF3YWl0IGF4aW9zLnBvc3QoYGh0dHAke24uc2VjdXJlKCk/J3MnOicnfTovLyR7bi5hZGRyZXNzKCl9OiR7bi5wb3J0KCkgfHwgMzAwMH0vbWV0aG9kL01hcHBpbmcvJHttZXRob2R9YCwgZGF0YSwgY29uZmlnKTsKCQkJfSBjYXRjaCAoZXgpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJfQoJCX0gZWxzZSB7CgoJCQlpZiAodHlwZW9mKGRhdGEpID09PSAib2JqZWN0IikgewoJCQkJZGVsZXRlIGRhdGEuX190aGlzLl9fZ2VuZXJhdGVkOwoJCQkJZGVsZXRlIGRhdGEuX190aGlzLm9ubGluZTsKCgkJCX0KCgkJCS8vd2h5IGRvIHdlIG5lZWQgdGhpcz8/PwoKCQkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJCXRyeSB7CgkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydCA9IHNhbGVzbm93LnVuUmVjdXJzZUFib3J0IHx8IHt9OwoJCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W21ldGhvZF0pIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7bWV0aG9kfWApOwoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCWxldCBfaWQgPSBudWxsOwoJCQkJaWYgKHR5cGVvZihkYXRhKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZS51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMSwgIk51bGwgaW5wdXQiLCBkYXRhLCBtZXRob2QsIHt9KTsKCQkJCQlyZXR1cm4gZGF0YTsKCQkJCX0gZWxzZSBpZiAodHlwZW9mKGRhdGEpID09PSAnc3RyaW5nJykgewoJCQkJCV9pZCA9IHRoaXMuaGFzaENvZGUoZGF0YSk7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IGRhdGEuX190aGlzLmNvZGUgfHwgZGF0YS5pZCB8fCBkYXRhLklEOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YoX2lkKSA9PT0gJ3VuZGVmaW5lZCcgfHwgIV9pZCkgewoJCQkJCWlmIChkYXRhLklkICYmIGRhdGEuSWQgPT0gZGF0YS5JZCkgewoJCQkJCQlfaWQgPSBkYXRhLklkOwoJCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJCV9pZCA9IHRoaXMuSWQ7CgkJCQkJfSBlbHNlIGlmIChkYXRhLkVudGl0eUNsYXNzKSB7CgkJCQkJCV9pZCA9IGRhdGEuRW50aXR5Q2xhc3MuSWQgfHwgZGF0YS5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJCX0gZWxzZSB7CgkJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjlhYmE1ODgzLWI2NmItNDc5NC04OTdkLTNmZDg1OTRmYTAxMiIgfHwgIk5VTEwiOwoJCQkJCX0KCQkJCX0KCgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZyA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZyB8fCB7fTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZ1ttZXRob2RdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nW21ldGhvZF0gfHwge307CgkJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk1hcHBpbmdbbWV0aG9kXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nW21ldGhvZF1bX2lkXSB8fCB7fTsKCgkJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goe30sIHsKCQkJCQlkZXB0aDogKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IDMgOiB1bmRlZmluZWQsCgkJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKG1ldGhvZCkgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQkJfSk7CgoJCQkJdiA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZ1ttZXRob2RdW19pZF1bX2hhc2hdOwoJCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiA1KSkgewoJCQkJCWxldCB0aGlzU2V0T24gPSAoKFsiX3RvSGFzaCJdLmluZGV4T2YobWV0aG9kKSA+PSAwKSA/IG5ldyBEYXRlKDApIDogKHRoaXMuU2V0X09uIHx8IG5ldyBEYXRlKDApKSk7CgkJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU3Bhd25pbmcgaW4gbWV0aG9kIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhLCB2KTsKCQkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJCXYucmV1c2VkKys7CgkJCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiU2VsZWN0ZWQgaGFzaCIsIF9pZCwgX2hhc2gsIG1ldGhvZCwgZGF0YSwgdik7CgkJCQkJfQoKCQkJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJCX0gOiB2Lm9iajsKCQkJCQlyZXR1cm4gdi5vYmo7CgoJCQkJfQoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAwLCAiUHVzaGluZyBoYXNoIiwgX2lkLCBfaGFzaCwgbWV0aG9kLCBkYXRhKTsKCQkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZ1ttZXRob2RdW19pZF1bX2hhc2hdID0gewoJCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KHt9KSwKCQkJCQlvYmo6IGRhdGEsCgkJCQkJcmV1c2VkOiAwLAoJCQkJfTsKCQkJfSBjYXRjaCAodW5SZWNFeCkgewoJCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy51blJlY3Vyc2VBYm9ydFttZXRob2RdID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19pbnZva2VOb2RlLnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBkYXRhLCBtZXRob2QsIHt9LCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMCwgYFRyaWdnZXJyaW5nICR7bWV0aG9kfSB0byAke24uY29kZSgpfSAke0pTT04uc3RyaW5naWZ5KGRhdGEsbnVsbCw0KX1gKTsKCgkJCWxldCBldiA9IG5ldyBzYWxlc25vdy5FdmVudCgpLmFjdGl2ZSh0cnVlKS5lbmFibGVkKHRydWUpLmNvZGUodGhpcy5fdXVpZCgpKS5uYW1lKHRoaXMuX19jb25maWcoJ2V2ZW50JykgfHwgJ3NhbGVzbm93LkV2ZW50JykuZGF0ZSh0aGlzLnNlcnZlckRhdGUoKSkucmVjaXBpZW50KG4pLm1ldGhvZChtZXRob2QpLmNsYXNzTmFtZSgnTWFwcGluZycpLnNlbmRlcihzYWxlc25vdy5fbm9kZSkuY2FycmllcihzYWxlc25vdy5fbm9kZSkucGF5bG9hZChkYXRhKTsKCQkJaWYgKGV2ZW50KSB7CgkJCQlpZiAoZXZlbnQuX3Jlc3BvbnNlVG9fc2V0KSBldi5yZXNwb25zZVRvKGV2ZW50LnJlc3BvbnNlVG8oKSk7CgkJCQlpZiAoZXZlbnQuX3NlbmRlcl9zZXQpIGV2LnNlbmRlcihldmVudC5zZW5kZXIoKSk7CgkJCQlpZiAoZXZlbnQuX2NsYXNzTmFtZV9zZXQpIGV2LmNsYXNzTmFtZShldmVudC5jbGFzc05hbWUoKSk7CgkJCQlpZiAoZXZlbnQuX2NhcnJpZXJfc2V0IHx8IGV2ZW50Ll9zZW5kZXJfc2V0KSBldi5jYXJyaWVyKGV2ZW50LmNhcnJpZXIoKSB8fCBldmVudC5zZW5kZXIoKSk7CgkJCX0KCQkJcmV0ID0gYXdhaXQgZXYudHJpZ2dlcigpOwoKCQkJaWYgKHR5cGVvZihyZXQpID09PSAic3RyaW5nIikgewoJCQkJdHJ5IHsKCQkJCQlyZXQgPSBKU09OLnBhcnNlKHJldCk7CgkJCQl9IGNhdGNoIChleCkge30KCQkJfQoJCQlyZXR1cm4gcmV0OwoKCQl9CgoJCWlmICghcmV0KSByZXR1cm4gbnVsbDsKCQlyZXQgPSByZXQuZGF0YSB8fCByZXQ7CgkJaWYgKHR5cGVvZihGbGF0dGVkKSAhPT0gInVuZGVmaW5lZCIgJiYgcmV0Ll9fZmxhdHRlZCkgcmV0ID0gRmxhdHRlZC5wYXJzZShyZXQuX19mbGF0dGVkKTsKCgkJaWYgKHJldC5fX2V4Y2VwdGlvbikgewoJCQkvLyBhbiBleGNlcHRpb24gb2NjdXJyZWQgYXQgdGhlIHNlcnZlcgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlTm9kZScsICdFbnRpdHlPYmplY3QnLCAyLCBgRXhjZXB0aW9uIGF0ICR7bi5fYWRkcmVzc31gLCByZXQuX19leGNlcHRpb24pOwoJCQlyZXR1cm4gcmV0OwoJCX0KCgkJc3dpdGNoIChtZXRob2QpIHsKCgkJCWNhc2UgImluc2VydCI6CgkJCWNhc2UgInVwZGF0ZSI6CgkJCWNhc2UgInN0b3JlIjoKCQkJY2FzZSAiZGVsZXRlIjoKCQkJY2FzZSAiZmluZCI6IHsKCQkJCWlmICghYlJhdykgcmV0ID0gbmV3IHNhbGVzbm93Lk1hcHBpbmcobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHJldCk7CgkJCQlicmVhazsKCQkJfQoJCQljYXNlICJmaW5kQWxsIjogewoJCQkJaWYgKHJldCAmJiAhQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZU5vZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgIk5vdCBhbiBBcnJheSBpbiBGaW5kQWxsIiwgcmV0KTsKCQkJCQlyZXQgPSBbcmV0XTsKCQkJCX0KCQkJCWlmICghYlJhdyAmJiByZXQubWFwKSByZXQgPSByZXQubWFwKHAgPT4gbmV3IHNhbGVzbm93Lk1hcHBpbmcobnVsbCwgdGhpcy5Ub29sKS5fZnJvbURvY3VtZW50KHApKTsKCQkJCWJyZWFrOwoJCQl9CgoJCQlkZWZhdWx0OiB7fQoJCX0KCgkJcmV0dXJuIHJldDsKCX0KCglhc3luYyBfaW52b2tlKG1ldGhvZCwgYm9keSwgcXVlcnksIGF1dGhPYmopIHsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsIG1ldGhvZCwgcXVlcnksIGJvZHkpOwoKCQlpZiAodHlwZW9mKGJvZHkpID09PSAnc3RyaW5nJyB8fCAodHlwZW9mKEJ1ZmZlcikgIT09ICd1bmRlZmluZWQnICYmIEJ1ZmZlci5pc0J1ZmZlcihib2R5KSkpIHsKCQkJdHJ5IHsKCQkJCWJvZHkgPSBKU09OLnBhcnNlKGJvZHkudG9TdHJpbmcoKSk7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJCb2R5IGlzIG5vdCBhIHZhbGlkIEpTT04iLCBib2R5KTsKCQkJCXJldHVybjsKCQkJfQoJCX0KCgkJbGV0IF9wYXJhbXMgPSBxdWVyeSA/IE9iamVjdC5hc3NpZ24ocXVlcnksIGJvZHkpIDogYm9keTsKCQlpZiAodHlwZW9mKF9wYXJhbXMpID09PSAnc3RyaW5nJykgX3BhcmFtcyA9IEpTT04ucGFyc2UoX3BhcmFtcyk7CgoJCWlmIChfcGFyYW1zKSB7CgkJCV9wYXJhbXMgPSBEb3RPYmplY3Qub2JqZWN0KF9wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCV9wYXJhbXMgPSB7fTsKCQl9CgoJCWlmICh0eXBlb2YoRmxhdHRlZCkgIT09ICJ1bmRlZmluZWQiICYmIF9wYXJhbXMuX19mbGF0dGVkKSBfcGFyYW1zID0gRmxhdHRlZC5wYXJzZShfcGFyYW1zLl9fZmxhdHRlZCk7CgoJCWlmIChfcGFyYW1zLl9fbm9kZSkgewoJCQkvLyBwcm9iYWJseSBzaG91bGQgbm90IGJlIHByb2Nlc3NlZCBoZXJlLCBidXQgcmF0aGVyIGNvbnN1bWVkIGFzIHBhcnQgb2YgdGhlIGV4ZWN1dGUoKSBsb2dpYywgcHVzaGluZyBfX25vZGUgdG8gdGhlIGxpc3Qgb2YgbXkgbm9kZXMgdG8gZGVsZWdhdGUgdG8hPwoJCQlsZXQgdG4gPSBuZXcgc2FsZXNub3cuTm9kZSgpLl9mcm9tRG9jdW1lbnQoX3BhcmFtcy5fX25vZGUpLl9kZVJlZmVyZW5jZSgpOwoJCQlkZWxldGUgX3BhcmFtcy5fX25vZGU7CgkJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuTWFwcGluZygpLl9pbnZva2VOb2RlKHRuLCBtZXRob2QsIF9wYXJhbXMpOwoJCX0KCgkJaWYgKF9wYXJhbXMuX190aGlzKSB7CgkJCV9wYXJhbXMuX190aGlzID0gRG90T2JqZWN0Lm9iamVjdChfcGFyYW1zLl9fdGhpcyk7CgkJCXRoaXMuX2Zyb21Eb2N1bWVudChfcGFyYW1zLl9fdGhpcykuX2RlUmVmZXJlbmNlKCk7CgkJfQoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfaW52b2tlJywgJ0VudGl0eU9iamVjdCcsIDAsICJfcGFyYW1zIiwgX3BhcmFtcyk7CgoJCWxldCBhckFyZ3MgPSBbXTsKCQlzd2l0Y2ggKG1ldGhvZCkgewoKCQkJY2FzZSAiZmluZEFsbCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5vYmpzKTsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuc3RhcnQpOwoJCQkJYXJBcmdzLnB1c2goX3BhcmFtcy5lbmQpOwoJCQkJYnJlYWs7CgkJCX0KCQkJY2FzZSAiZmluZCI6IHsKCQkJCWFyQXJncy5wdXNoKF9wYXJhbXMuZGVwdGgpOwoJCQkJYnJlYWs7CgkJCX0KCgkJCWRlZmF1bHQ6IHsKCQkJCWJyZWFrOwoJCQl9CgkJfQoKCQlsZXQgb2JqID0gdGhpczsKCgkJbGV0IHJldCA9IG51bGw7CgkJaWYgKCFvYmopIHsKCQkJcmV0ID0gewoJCQkJX19leGNlcHRpb246IHsKCQkJCQknLTEnOiBgTWFwcGluZy5faW52b2tlOiBvYmogaXMgdW5kZWZpbmVkYAoJCQkJfQoJCQl9OwoJCX0gZWxzZSBpZiAoIW9ialttZXRob2RdKSB7CgkJCXJldCA9IHsKCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJJy0yJzogYE1hcHBpbmcuX2ludm9rZTogbWV0aG9kICR7b2JqLmNvbnN0cnVjdG9yLm5hbWV9KCR7bWV0aG9kfSkgaXMgbm90IGZvdW5kYCwKCQkJCQknb2JqJzogb2JqCgkJCQl9CgkJCX07CgkJfSBlbHNlIHsKCQkJcmV0ID0gYXdhaXQgb2JqW21ldGhvZF0oLi4uYXJBcmdzKTsKCQl9CgoJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCWlmIChmYWxzZSAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCkgewoJCQkJcmV0ID0gewoJCQkJCV9fZXhjZXB0aW9uOiB7CgkJCQkJCSctNCc6ICJVbmNvbW1pdHRlZCB0cmFuc2FjdGlvbnM6ICIgKyBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLnNxbHMubGVuZ3RoLAoJCQkJCQknb2JqJzogb2JqCgkJCQkJfQoJCQkJfQoJCQl9CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCX0KCgkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJfQoKCQlpZiAocmV0ICYmICFyZXQuX19leGNlcHRpb24pIHsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHt9OwoJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSB7CgkJCQlyZXQgPSByZXQubWFwKHIgPT4gewoJCQkJCWlmIChyICYmIHIuX3RvRG9jdW1lbnQpIHsKCQkJCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZy5fdG9Eb2N1bWVudDsKCQkJCQkJcmV0dXJuIHIuX3RvRG9jdW1lbnQoZmFsc2UsIHRydWUpOwoJCQkJCX0gZWxzZSByZXR1cm4gcjsKCQkJCX0pOwoJCQl9IGVsc2UgewoJCQkJcmV0ID0gKHJldCAmJiByZXQuX3RvRG9jdW1lbnQpID8gcmV0Ll90b0RvY3VtZW50KGZhbHNlLCB0cnVlKSA6IHJldDsKCQkJfQoJCX0KCgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2ludm9rZScsICdFbnRpdHlPYmplY3QnLCAwLCBgJHttZXRob2R9OiAke3RoaXMuX190aW1lKCdzYWxlc25vdy5NYXBwaW5nLicgKyBtZXRob2QpfWApOwoJCXJldHVybiByZXQ7Cgl9CgoJX3BhcnNlQ29kZVN0YXRlKHQpIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX3BhcnNlQ29kZVN0YXRlKHQpOwoKCX0KCglhc3luYyBfbG9hZFRvb2xzKGJTdG9yZSwgc291cmNlKSB7CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9sb2FkVG9vbHMoYlN0b3JlLCBzb3VyY2UgfHwgIk1hcHBpbmciKTsKCgl9CgoJX3BhcmFtZXRyaXplKHN0ciwgZnVuLCBwcmVmaXggPSAne3snLCBwb3N0Zml4ID0gJ319JykgewoKCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcGFyYW1ldHJpemUoc3RyLCBmdW4sIHByZWZpeCwgcG9zdGZpeCk7CgoJfQoKCV9fc3luY19vbihkKSB7CgkJdGhpcy5fX19zeW5jX29uID0gdGhpcy5fX19zeW5jX29uIHx8IHt9OwoKCQlpZiAoZCkgewoJCQl0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdID0gZDsKCgkJCWlmICh0aGlzLl90b29sX3NldCAmJiB0aGlzLnRvb2woKSkgdGhpcy50b29sKCkuX19zeW5jX29uKGQpOwoKCQkJaWYgKHRoaXMuX3R5cGVfc2V0ICYmIHRoaXMudHlwZSgpKSB0aGlzLnR5cGUoKS5fX3N5bmNfb24oZCk7CgoJCQlyZXR1cm4gdGhpczsKCQl9CgoJCXJldHVybiB0aGlzLl9fX3N5bmNfb25bdGhpcy5Ub29sLm5hbWVdOwoJfQoKCV9jbG9uZSgpIHsKCQlyZXR1cm4gbmV3IHNhbGVzbm93Lk1hcHBpbmcodGhpcy5JZCkKCgkJCS5hY3RpdmUodGhpcy5hY3RpdmUoKSwgdGhpcy5fYWN0aXZlX2Nvb3ApCgoJCQkuZW5hYmxlZCh0aGlzLmVuYWJsZWQoKSwgdGhpcy5fZW5hYmxlZF9jb29wKQoKCQkJLm9yZGVyKHRoaXMub3JkZXIoKSwgdGhpcy5fb3JkZXJfY29vcCkKCgkJCS5jbGFzc05hbWUodGhpcy5jbGFzc05hbWUoKSwgdGhpcy5fY2xhc3NOYW1lX2Nvb3ApCgoJCQkuc2NvcGUodGhpcy5zY29wZSgpLCB0aGlzLl9zY29wZV9jb29wKQoKCQkJLmNvbnRleHQodGhpcy5jb250ZXh0KCksIHRoaXMuX2NvbnRleHRfY29vcCkKCgkJCS5zb3VyY2UodGhpcy5zb3VyY2UoKSwgdGhpcy5fc291cmNlX2Nvb3ApCgoJCQkudGFyZ2V0KHRoaXMudGFyZ2V0KCksIHRoaXMuX3RhcmdldF9jb29wKQoKCQkJLm9wZXJhdG9yKHRoaXMub3BlcmF0b3IoKSwgdGhpcy5fb3BlcmF0b3JfY29vcCkKCgkJCS5pblNjcmlwdCh0aGlzLmluU2NyaXB0KCksIHRoaXMuX2luU2NyaXB0X2Nvb3ApCgoJCQkub3V0U2NyaXB0KHRoaXMub3V0U2NyaXB0KCksIHRoaXMuX291dFNjcmlwdF9jb29wKQoKCQkJLnRvb2wodGhpcy50b29sKCksIHRoaXMuX3Rvb2xfY29vcCkKCgkJCS50eXBlKHRoaXMudHlwZSgpLCB0aGlzLl90eXBlX2Nvb3ApCgoJfQoKCV9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKSB7CgkJY29udGV4dCA9IGNvbnRleHQgfHwgJ0VudGl0eUF0dHJpYnV0ZSc7CgkJLy9vYmpGcm9tID0gb2JqRnJvbSB8fCB0aGlzLl90b0RvY3VtZW50KCk7CgkJLy9vYmpUbyA9IG9ialRvIHx8IHt9OwoJCWNsYXNzTmFtZSA9IGNsYXNzTmFtZSB8fCAnTWFwcGluZyc7CgkJdG9vbCA9IHRvb2wgfHwgdGhpcy5Ub29sOwoJCWNvZGVUeXBlID0gY29kZVR5cGUgfHwgSlNPTi5wYXJzZSgoKHR5cGVvZih0aGlzKSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHRoaXMuX2F0b2IpICE9PSAidW5kZWZpbmVkIikgPyB0aGlzLl9hdG9iIDogKHR5cGVvZihfRnJFTUQpICE9PSAidW5kZWZpbmVkIiA/IF9GckVNRC5fYXRvYiA6IGF0b2IpKShgZXlKMGIyOXNJam9pVkc5dmJDSXNJblI1Y0dVaU9pSlViMjlzWDFSNWNHVWlmUT09YCksIChrZXksIHZhbHVlKSA9PiB7CgkJCWlmICh0eXBlb2YodmFsdWUpID09PSAic3RyaW5nIiAmJiB2YWx1ZS5pbmRleE9mKCI9PiIpID4gMCkgcmV0dXJuIGV2YWwoIigiICsgdmFsdWUgKyAiKSIpOwoJCQlyZXR1cm4gdmFsdWU7CgkJfSlbY29kZV07CgoJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9tYXAoY29kZSwgYlJldmVyc2UsIGNvbnRleHQsIG9iakZyb20sIG9ialRvLCBjbGFzc05hbWUsIHRvb2wsIGNvZGVUeXBlKTsKCgl9CgoJX25Db2RlKGNvZGUsIG9Db2RlKSB7CgkJdHJ5IHsKCQkJbGV0IGNvbnRleHQgPSAnRW50aXR5QXR0cmlidXRlJzsKCQkJaWYgKCFjb2RlICYmICFvQ29kZSkgewoJCQkJY29udGV4dCA9ICdFbnRpdHlDbGFzcyc7CgkJCQljb2RlID0gIk1hcHBpbmciOwoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciICYmIHRoaXMuX19jb25maWcoJ3Njb3BlJykpIHsKCQkJCQljb2RlID0gdGhpcy5fX2NvbmZpZygnc2NvcGUnKSArICJfc3RfIiArIGNvZGU7CgkJCQl9CgkJCQlvQ29kZSA9IHVuZGVmaW5lZDsKCQkJfQoJCQlsZXQgcmV0ID0gY29kZTsKCQkJaWYgKG9Db2RlICYmIHR5cGVvZihvQ29kZSkgPT09ICdvYmplY3QnKSB7CgkJCQlyZXQgPSBvQ29kZVt0aGlzLlRvb2wubmFtZV0gfHwgcmV0OwoJCQl9CgoJCQlyZXQgPSB0aGlzLl9tYXAoY29kZSwgZmFsc2UsIGNvbnRleHQpIHx8IHJldDsKCQkJcmV0dXJuIHJldDsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbkNvZGUnLCAnRW50aXR5T2JqZWN0JywgMSwgZXgpOwoJCQlyZXR1cm4gY29kZTsKCQl9Cgl9CgoJX19jb25maWcobiwgbnVsbFZhbHVlLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX19jb25maWcobiwgbnVsbFZhbHVlLCBPYmplY3QuYXNzaWduKHt9LCBvcHRpb25zIHx8IHt9LCB7CgkJCV9jbGFzczogJ01hcHBpbmcnCgkJfSkpOwoKCX0KCglhc3luYyBfcmVzdCh0TmFtZSA9IHRoaXMuX25Db2RlKCksIHBhcmFtcywgZGF0YSwgbWV0aG9kLCBvcHRpb25zID0ge30pIHsKCgkJcmV0dXJuIGF3YWl0IG5ldyBzYWxlc25vdy5Vc2VyKHVuZGVmaW5lZCwgdGhpcy5Ub29sKS5fcmVzdCh0aGlzLl9uQ29kZSgpLCBwYXJhbXMsIGRhdGEsIG1ldGhvZCwgb3B0aW9ucyk7CgoJfQoKCV90b1NRTFRhYmxlKCkgewoJCWxldCByZXQgPSB7CgkJCXNxbDogYENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTICR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoKX0ke3RoaXMuX1EoKX0gKAogICAgICAgICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IENIQVIoMjUpIFBSSU1BUlkgS0VZCiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjbGFzc05hbWUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc2NvcGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29udGV4dCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdzb3VyY2UnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlN0cmluZyIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndGFyZ2V0JywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ29wZXJhdG9yJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJTdHJpbmciLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2luU2NyaXB0JywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJUZXh0IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvdXRTY3JpcHQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfQogICAgCiAgICAgICAgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpfWlkJHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiRW50aXR5IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX0KICAgIAogICAgICAgICwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9CiAgICAKICAgICAgICBgCgkJfTsKCQlyZXQuc3FsICs9ICcvKk1hcHBpbmcqLyk7XG4nOwoKCQlyZXQgPSB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiB0cnVlLAoJCQlOdWxsOiB0cnVlLAoJCQkvL0lkOiAob2JqLCB2KSA9PiBvYmouc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBDSEFSKDI1KSBQUklNQVJZIEtFWWAsCgoJCQkiYWN0aXZlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2FjdGl2ZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkJvb2wiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJCb29sIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJvcmRlciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiSW50IiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJjbGFzc05hbWUiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2NsYXNzTmFtZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJzY29wZSI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzY29wZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdzY29wZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJjb250ZXh0IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRleHQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29udGV4dCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJzb3VyY2UiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc291cmNlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3NvdXJjZScsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJ0YXJnZXQiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndGFyZ2V0JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJLy8gb2JqLnNxbCArPSBgLCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3RhcmdldCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJvcGVyYXRvciI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcGVyYXRvcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcGVyYXRvcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiU3RyaW5nIiwgdGhpcy5fX2NvbmZpZygndHlwZScpKX1gOwoKCQkJfSwKCgkJCSJpblNjcmlwdCI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdpblNjcmlwdCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdpblNjcmlwdCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fc3FsVHlwZSgiVGV4dCIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCX0sCgoJCQkib3V0U2NyaXB0IjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ291dFNjcmlwdCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvdXRTY3JpcHQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIlRleHQiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQl9LAoKCQkJInRvb2wiOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndG9vbCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCS8vIG9iai5zcWwgKz0gYCwke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKX1pZCR7dGhpcy5fUSgpfSAke3RoaXMuX3NxbFR5cGUoIkVudGl0eSIsIHRoaXMuX19jb25maWcoJ3R5cGUnKSl9YDsKCgkJCQlvYmouc3FsID0gKHYgPyB2Ll90b1NRTFRhYmxlKCkgOiAnJykgKyBvYmouc3FsOwoKCQkJfSwKCgkJCSJ0eXBlIjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkvLyBvYmouc3FsICs9IGAsJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCl9aWQke3RoaXMuX1EoKX0gJHt0aGlzLl9zcWxUeXBlKCJFbnRpdHkiLCB0aGlzLl9fY29uZmlnKCd0eXBlJykpfWA7CgoJCQkJb2JqLnNxbCA9ICh2ID8gdi5fdG9TUUxUYWJsZSgpIDogJycpICsgb2JqLnNxbDsKCgkJCX0sCgoJCX0sICJfdG9TUUxUYWJsZSIpOwoKCQkvLyByZXQuc3FsICs9ICcvKk1hcHBpbmcqLyk7XG4nOwoKCQlyZXQuc3FsID0gdHlwZW9mKHNxbEZvcm1hdHRlcikgIT09ICd1bmRlZmluZWQnID8gc3FsRm9ybWF0dGVyLmZvcm1hdChyZXQuc3FsKSA6IHJldC5zcWw7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NRTFRhYmxlJywgJ0VudGl0eU9iamVjdCcsIDAsIHJldC5zcWwpOwoJCXJldHVybiByZXQuc3FsOwoJfQoKCV9mcm9tU1FMVGFibGUodGFibGUsIGZpZWxkcykgewoJCS8vIHRhYmxlIGlzIGEganNvbiBhcnJheQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5hY3RpdmUodGFibGVbImFjdGl2ZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJlbmFibGVkIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5lbmFibGVkKHRhYmxlWyJlbmFibGVkIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5vcmRlcih0YWJsZVsib3JkZXIiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY2xhc3NOYW1lIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5jbGFzc05hbWUodGFibGVbImNsYXNzTmFtZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJzY29wZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMuc2NvcGUodGFibGVbInNjb3BlIl0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImNvbnRleHQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmNvbnRleHQodGFibGVbImNvbnRleHQiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigic291cmNlIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5zb3VyY2UodGFibGVbInNvdXJjZSJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJ0YXJnZXQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnRhcmdldCh0YWJsZVsidGFyZ2V0Il0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9wZXJhdG9yIikpIHx8ICFmaWVsZHMpIHsKCQkJdGhpcy5vcGVyYXRvcih0YWJsZVsib3BlcmF0b3IiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiaW5TY3JpcHQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLmluU2NyaXB0KHRhYmxlWyJpblNjcmlwdCJdKTsKCQl9CgoJCWlmICgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJvdXRTY3JpcHQiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLm91dFNjcmlwdCh0YWJsZVsib3V0U2NyaXB0Il0pOwoJCX0KCgkJaWYgKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInRvb2wiKSkgfHwgIWZpZWxkcykgewoJCQl0aGlzLnRvb2wodGFibGVbInRvb2wiXSk7CgkJfQoKCQlpZiAoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigidHlwZSIpKSB8fCAhZmllbGRzKSB7CgkJCXRoaXMudHlwZSh0YWJsZVsidHlwZSJdKTsKCQl9CgoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIF9zcWwoc3FsLCBzb3VyY2UgPSB0aGlzKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9zcWwoc3FsLCB0aGlzKTsKCgl9CgoJYXN5bmMgX2dpdGh1YihmaWxlLCBjb250ZW50KSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLl9naXRodWIoZmlsZSwgY29udGVudCk7CgoJfQoKCV90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCBiU3RyaW5nKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoewoJCQlbdGhpcy5fbkNvZGUoKV06IHsKCQkJCXBhcmFtczogewoJCQkJCXdoZXJlOiB7CgkJCQkJCWFuZDogW10sCgkJCQkJCW9yOiBbXQoJCQkJCX0KCQkJCX0sCgkJCQllZGdlczogewoJCQkJCW5vZGU6IHt9CgkJCQl9CgkJCX0KCQl9LCB7CgkJCS8vT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaCh7CgkJCQlJZDogewoJCQkJCWVxOiB2CgkJCQl9CgkJCX0pLAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCW9yZGVyOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY2xhc3NOYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCXNjb3BlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc2NvcGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJY29udGV4dDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRleHQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJc291cmNlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc291cmNlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCXRhcmdldDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3RhcmdldCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWxldCBvcCA9ICdlcSc7CgkJCQlsZXQgY29uZCA9IHsKCQkJCQlbZWFDb2RlXTogewoJCQkJCQlbb3BdOgoKCQkJCQkJCXYKCgkJCQkJfQoJCQkJfTsKCQkJCW9ialt0aGlzLl9uQ29kZSgpXS5wYXJhbXMud2hlcmUuYW5kLnB1c2goY29uZCk7CgkJCX0sCgoJCQlvcGVyYXRvcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29wZXJhdG9yJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCWluU2NyaXB0OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnaW5TY3JpcHQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCQl2CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJb3V0U2NyaXB0OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3V0U2NyaXB0JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQkJdgoKCQkJCQl9CgkJCQl9OwoJCQkJb2JqW3RoaXMuX25Db2RlKCldLnBhcmFtcy53aGVyZS5hbmQucHVzaChjb25kKTsKCQkJfSwKCgkJCXRvb2w6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJbGV0IG9wID0gJ2VxJzsKCQkJCWxldCBjb25kID0gewoJCQkJCVtlYUNvZGVdOiB7CgkJCQkJCVtvcF06CgoJCQkJCQl7CgkJCQkJCQlpbnE6IHsKCQkJCQkJCQlBcGlOYW1lOiAnSWQnLAoJCQkJCQkJCVt0aGlzLl9uQ29kZSgnVG9vbCcsIHVuZGVmaW5lZCldOiB2ID8gdi5fdG9TRlF1ZXJ5KClbdGhpcy5fbkNvZGUoJ1Rvb2wnLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQkJdHlwZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlsZXQgb3AgPSAnZXEnOwoJCQkJbGV0IGNvbmQgPSB7CgkJCQkJW2VhQ29kZV06IHsKCQkJCQkJW29wXToKCgkJCQkJCXsKCQkJCQkJCWlucTogewoJCQkJCQkJCUFwaU5hbWU6ICdJZCcsCgkJCQkJCQkJW3RoaXMuX25Db2RlKCdUb29sX1R5cGUnLCB1bmRlZmluZWQpXTogdiA/IHYuX3RvU0ZRdWVyeSgpW3RoaXMuX25Db2RlKCdUb29sX1R5cGUnLCB1bmRlZmluZWQpXS5wYXJhbXMud2hlcmUuYW5kIDogW10sCgkJCQkJCQl9LAoJCQkJCQl9CgoJCQkJCX0KCQkJCX07CgkJCQlvYmpbdGhpcy5fbkNvZGUoKV0ucGFyYW1zLndoZXJlLmFuZC5wdXNoKGNvbmQpOwoJCQl9LAoKCQl9LCAiX3RvU0ZRdWVyeSIpOwoKCQkvL09iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlpZiAoYlN0cmluZykgewoJCQlyZXQgPSB7CgkJCQlxdWVyeTogewoJCQkJCVt0aGlzLl9uQ29kZSgpICsgJ1F1ZXJ5J106IHsKCQkJCQkJdWlhcGk6IHJldAoJCQkJCX0KCQkJCX0KCQkJfTsKCQkJcmV0ID0gSlNPTi5zdHJpbmdpZnkocmV0LCBudWxsLCA0KTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NGUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgcmV0KTsKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NOUXVlcnkoZmllbGRzLCBvYmpzKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJT1BFUkFUT1JTOiB0cnVlLAoJCQlJZDogKG9iaiwgdikgPT4gb2JqLnN5c19pZCA9IHYsCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQljbGFzc05hbWU6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjbGFzc05hbWUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCXNjb3BlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc2NvcGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCWNvbnRleHQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdjb250ZXh0JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQlzb3VyY2U6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzb3VyY2UnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJfSwKCgkJCXRhcmdldDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3RhcmdldCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJb3BlcmF0b3I6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcGVyYXRvcicsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJaW5TY3JpcHQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdpblNjcmlwdCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQl9LAoKCQkJb3V0U2NyaXB0OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3V0U2NyaXB0JywgdW5kZWZpbmVkKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCX0sCgoJCQl0b29sOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndG9vbCcsIHVuZGVmaW5lZCkpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b1NOUXVlcnkoKSA6IG51bGw7CgoJCQl9LAoKCQkJdHlwZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9TTlF1ZXJ5KCkgOiBudWxsOwoKCQkJfSwKCgkJfSwgIl90b1NOUXVlcnkiKTsKCgkJT2JqZWN0LmtleXMocmV0Lk9QRVJBVE9SUyB8fCB7fSkuZmlsdGVyKGsgPT4gdHlwZW9mKHJldFtrXSkgIT09ICd1bmRlZmluZWQnKS5mb3JFYWNoKGsgPT4gcmV0W2tdID0gcmV0Lk9QRVJBVE9SU1trXSArIHJldFtrXSk7CgoJCWRlbGV0ZSByZXQuT1BFUkFUT1JTOwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVN0cmluZyhyZXRba10pLmxlbmd0aCkuZm9yRWFjaChrID0+IGRlbGV0ZSByZXRba10pOwoKCQlyZXQgPSBEb3RPYmplY3QuZG90KHJldCk7CgoJCS8vIGF2b2lkIHNlbmRpbmcgd2l0aCBubyBjb21wYXJpc29uIG9wZXJhdG9ycwoJCU9iamVjdC5rZXlzKHJldCkuZmlsdGVyKGsgPT4gIVsnPicsICc8JywgJ0JFVFdFRU4nLCAnT04nLCAnIScsICc9JywgJ1NUQVJUU1dJVEgnLCAnTElLRSddLnNvbWUocyA9PiBTdHJpbmcocmV0W2tdKS5zdGFydHNXaXRoKHMpKSkuZm9yRWFjaChrID0+IHJldFtrXSA9ICh0aGlzW2BfJHtrfV9jb29wYF0gfHwgJ1NUQVJUU1dJVEgnKSArIHJldFtrXSk7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NOUXVlcnknLCAnRW50aXR5T2JqZWN0JywgMCwgT2JqZWN0LmVudHJpZXMocmV0IHx8IHt9KS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikpOwoKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9TTlF1ZXJ5JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfX2V4cG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQlpZiAoIW9iaikgcmV0dXJuIHRoaXM7CgoJCWxldCBfb3B0aW9ucyA9IChmaWVsZCwgb2JqLCBlYU9iaikgPT4gewoJCQl0cnkgewoJCQkJaWYgKG9wdGlvbnMuX2ZpZWxkcyAmJiAhb3B0aW9ucy5fZmllbGRzLmluY2x1ZGVzKGZpZWxkKSkgcmV0dXJuOwoJCQkJaWYgKHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgIT09ICJmdW5jdGlvbiIpIHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAwLCBgJHtmdW59Lm9wdGlvbnMuJHtmaWVsZH0gaXMgbm90IGEgZnVuY3Rpb25gKTsKCQkJCQlyZXR1cm47CgkJCQl9CgkJCQlpZiAoIW9wdGlvbnMuTnVsbCkgewoJCQkJCWlmIChmaWVsZCAhPSAnSWQnICYmICF0aGlzWydfJyArIGZpZWxkICsgJ19zZXQnXSkgcmV0dXJuOwoJCQkJCWlmIChBcnJheS5pc0FycmF5KGVhT2JqKSAmJiB0eXBlb2YoZWFPYmoubGVuZ3RoKSAhPT0gJ3VuZGVmaW5lZCcgJiYgIWVhT2JqLmxlbmd0aCkgcmV0dXJuOwoJCQkJfQoJCQkJaWYgKG9wdGlvbnMuT1BFUkFUT1JTICYmIHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXSkgb2JqLk9QRVJBVE9SUyA9IE9iamVjdC5hc3NpZ24ob2JqLk9QRVJBVE9SUyB8fCB7fSwgewoJCQkJCVtmaWVsZF06IHRoaXNbJ18nICsgZmllbGQgKyAnX2Nvb3AnXQoJCQkJfSk7CgoJCQkJbGV0IF9yZXQgPSBvcHRpb25zW2ZpZWxkXShvYmosIGVhT2JqKTsKCgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIGZhbHNlLCBmdW4sIGVhT2JqLCBvYmopOwoJCQkJcmV0dXJuIF9yZXQ7CgkJCX0gY2F0Y2ggKGV4KSB7CgkJCQlpZiAoIWV4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCQlzYWxlc25vdy5fX2V4cG9ydEFib3J0ID0gdHJ1ZTsKCQkJCX0KCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBFcnJvciBpbiAke2Z1bn0uX29wdGlvbnMuJHtmaWVsZH06ICR7ZXh9YCwgZXgpOwoJCQl9CgkJfTsKCgkJaWYgKG9wdGlvbnMuRnVsbCB8fCB0aGlzLl9fc3luY19vbigpIHx8IHRoaXMuSWQgPT0gdGhpcy5JZCkgX29wdGlvbnMoIklkIiwgb2JqLCB0aGlzLklkKTsKCgkJX29wdGlvbnMoImFjdGl2ZSIsIG9iaiwgdGhpcy5hY3RpdmUoKSk7CgoJCV9vcHRpb25zKCJlbmFibGVkIiwgb2JqLCB0aGlzLmVuYWJsZWQoKSk7CgoJCV9vcHRpb25zKCJvcmRlciIsIG9iaiwgdGhpcy5vcmRlcigpKTsKCgkJX29wdGlvbnMoImNsYXNzTmFtZSIsIG9iaiwgdGhpcy5jbGFzc05hbWUoKSk7CgoJCV9vcHRpb25zKCJzY29wZSIsIG9iaiwgdGhpcy5zY29wZSgpKTsKCgkJX29wdGlvbnMoImNvbnRleHQiLCBvYmosIHRoaXMuY29udGV4dCgpKTsKCgkJX29wdGlvbnMoInNvdXJjZSIsIG9iaiwgdGhpcy5zb3VyY2UoKSk7CgoJCV9vcHRpb25zKCJ0YXJnZXQiLCBvYmosIHRoaXMudGFyZ2V0KCkpOwoKCQlfb3B0aW9ucygib3BlcmF0b3IiLCBvYmosIHRoaXMub3BlcmF0b3IoKSk7CgoJCV9vcHRpb25zKCJpblNjcmlwdCIsIG9iaiwgdGhpcy5pblNjcmlwdCgpKTsKCgkJX29wdGlvbnMoIm91dFNjcmlwdCIsIG9iaiwgdGhpcy5vdXRTY3JpcHQoKSk7CgoJCWxldCB2ID0gdW5kZWZpbmVkOwoJCXRyeSB7CgkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0ID0gc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgfHwge307CgkJCWlmIChzYWxlc25vdy51blJlY3Vyc2VBYm9ydFtmdW5dKSB7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydCcsICdFbnRpdHlPYmplY3QnLCAxLCBgQWJvcnRpbmcgYXMgcGVyIHNhbGVzbm93LnVuUmVjdXJzZUFib3J0LiR7ZnVufWApOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJbGV0IF9pZCA9IG51bGw7CgkJCWlmICh0eXBlb2Yob2JqKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIG9iaiwgZnVuLCBmQXJncyk7CgkJCQlyZXR1cm4gb2JqOwoJCQl9IGVsc2UgaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZShvYmopOwoJCQl9IGVsc2UgewoJCQkJX2lkID0gb2JqLl9pZCB8fCBvYmouaWQgfHwgb2JqLklEOwoJCQl9CgoJCQlpZiAodHlwZW9mKF9pZCkgPT09ICd1bmRlZmluZWQnIHx8ICFfaWQpIHsKCQkJCWlmIChvYmouSWQgJiYgb2JqLklkID09IG9iai5JZCkgewoJCQkJCV9pZCA9IG9iai5JZDsKCQkJCX0gZWxzZSBpZiAodGhpcy5JZCA9PSB0aGlzLklkKSB7CgkJCQkJX2lkID0gdGhpcy5JZDsKCQkJCX0gZWxzZSBpZiAob2JqLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gb2JqLkVudGl0eUNsYXNzLklkIHx8IG9iai5FbnRpdHlDbGFzcy5OYW1lOwoJCQkJfSBlbHNlIHsKCQkJCQlfaWQgPSB0aGlzLkVudGl0eUNsYXNzLklkIHx8ICI5YWJhNTg4My1iNjZiLTQ3OTQtODk3ZC0zZmQ4NTk0ZmEwMTIiIHx8ICJOVUxMIjsKCQkJCX0KCQkJfQoKCQkJc2FsZXNub3cuX3VuUmVjdXJzZSA9IHNhbGVzbm93Ll91blJlY3Vyc2UgfHwge307CgkJCXNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZyA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZyB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nW2Z1bl0gPSBzYWxlc25vdy5fdW5SZWN1cnNlLk1hcHBpbmdbZnVuXSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nW2Z1bl1bX2lkXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZ1tmdW5dW19pZF0gfHwge307CgoJCQlsZXQgX2hhc2ggPSB0aGlzLl90b0hhc2goZkFyZ3MsIHsKCQkJCWRlcHRoOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gMyA6IHVuZGVmaW5lZCwKCQkJCWNhY2hlOiAoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gW10gOiB1bmRlZmluZWQKCQkJfSk7CgoJCQl2ID0gc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nW2Z1bl1bX2lkXVtfaGFzaF07CgkJCWlmICh2ICYmIE1hdGguYWJzKG5ldyBEYXRlKCkuZ2V0VGltZSgpIC0gdi5kYXRlKSA8ICgxMDAwICogMC4yKSkgewoJCQkJbGV0IHRoaXNTZXRPbiA9ICgoWyJfdG9IYXNoIl0uaW5kZXhPZihmdW4pID49IDApID8gbmV3IERhdGUoMCkgOiAodGhpcy5TZXRfT24gfHwgbmV3IERhdGUoMCkpKTsKCQkJCWlmICh0aGlzU2V0T24gPj0gdi5kYXRlKSB7CgkJCQkJLy8gYSBuZXdlciBjb3B5IGlzIGNyZWF0ZWQgQUZURVIvRFVSSU5HIHRoZSByZWN1cnNpdmUgY2FsbCEhCgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19leHBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJTcGF3bmluZyBpbiBmdW4iLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIG9iaiwgdik7CgkJCQl9CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2V4cG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlB1c2hpbmcgaGFzaCIsIF9pZCwgX2hhc2gsIGZ1biwgb2JqKTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nW2Z1bl1bX2lkXVtfaGFzaF0gPSB7CgkJCQlkYXRlOiBuZXcgRGF0ZSgpLmdldFRpbWUoKSwKCQkJCWFyZ3M6IEpTT04uc3RyaW5naWZ5KGZBcmdzKSwKCQkJCW9iajogb2JqLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fZXhwb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCBvYmosIGZ1biwgZkFyZ3MsIHVuUmVjRXgudG9TdHJpbmcoKSk7CgoJCQlpZiAodHlwZW9mKHYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuIHY7CgkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCV9pZDogdi5vYmouX2lkCgkJCX0gOiB2Lm9iajsKCQkJcmV0dXJuIHYub2JqOwoKCQl9CgoJCV9vcHRpb25zKCJfVEhJUyIsIG9iaiwgdGhpcy5fVEhJUyk7CgoJCWlmICghdGhpcy50b29sKCkgfHwgKHRoaXMudG9vbCgpCgoJCQkJJiYKCQkJCSF0aGlzLnRvb2woKS50b29sX0NvbmZpZ3MoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMudG9vbCgpLnRvb2xfTWFwcGluZ3MoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoInRvb2wiLCBvYmosIHRoaXMudG9vbCgpKTsKCQl9CgoJCWlmICghdGhpcy50eXBlKCkgfHwgKHRoaXMudHlwZSgpCgoJCQkJJiYKCQkJCSF0aGlzLnR5cGUoKS50eXBlX0NvbmZpZ3MoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMudHlwZSgpLnR5cGVfVG9vbHMoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCQkmJgoJCQkJIXRoaXMudHlwZSgpLnR5cGVfTWFwcGluZ3MoKS5maW5kKF9vID0+IHRoaXMgPT09IF9vIHx8IHRoaXMuRXF1YWxzKF9vKSkKCgkJCSkpIHsKCQkJX29wdGlvbnMoInR5cGUiLCBvYmosIHRoaXMudHlwZSgpKTsKCQl9CgoJCU9iamVjdC5rZXlzKG9wdGlvbnMpLmZpbHRlcihrID0+IHR5cGVvZihvcHRpb25zW2tdKSA9PT0gJ2Z1bmN0aW9uJyAmJiAhWydJZCcsICdfVEhJUyddLmNvbmNhdChbJ2FjdGl2ZScsICdlbmFibGVkJywgJ29yZGVyJywgJ2NsYXNzTmFtZScsICdzY29wZScsICdjb250ZXh0JywgJ3NvdXJjZScsICd0YXJnZXQnLCAnb3BlcmF0b3InLCAnaW5TY3JpcHQnLCAnb3V0U2NyaXB0JywgJ3Rvb2wnLCAndHlwZSddKS5jb25jYXQoWycnXSkuaW5jbHVkZXMoaykpLmZvckVhY2goayA9PiBfb3B0aW9ucyhrLCBvYmosIHRydWUpKTsKCgkJcmV0dXJuIG9iajsKCX0KCglfX2ltcG9ydChvYmosIG9wdGlvbnMsIGZ1biwgLi4uZkFyZ3MpIHsKCQkvLyBpZighb2JqKSByZXR1cm4gdGhpczsKCQlpZiAodHlwZW9mKG9iaikgIT09ICdvYmplY3QnKSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGAke2Z1bn06IE5vdCBhbiBvYmplY3Q6ICR7dHlwZW9mKG9iail9YCwgb2JqKTsKCQkJcmV0dXJuIHRoaXM7CgkJfQoKCQlsZXQgX29wdGlvbnMgPSAoZmllbGQsIG9iaikgPT4gewoJCQlpZiAob3B0aW9ucy5fZmllbGRzICYmICFvcHRpb25zLl9maWVsZHMuaW5jbHVkZXMoZmllbGQpKSByZXR1cm47CgkJCWlmICghb2JqKSByZXR1cm47CgkJCWlmIChBcnJheS5pc0FycmF5KG9iaikgJiYgIW9iai5sZW5ndGgpIHJldHVybjsKCgkJCXRyeSB7CgkJCQlpZiAob3B0aW9ucy5fbWFwKSB0aGlzLl9tYXAoZmllbGQsIHRydWUsIGZ1biwgb2JqLCBvYmopOwoJCQkJaWYgKG9wdGlvbnNbZmllbGRdICYmIHR5cGVvZihvcHRpb25zW2ZpZWxkXSkgPT09ICJmdW5jdGlvbiIpIHJldHVybiBvcHRpb25zW2ZpZWxkXShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQnLCAnRW50aXR5T2JqZWN0JywgMSwgYEVycm9yICR7ZXh9IGluICR7ZnVufS5vcHRpb25zLiR7ZmllbGR9YCwgZXgpOwoJCQl9CgkJfTsKCgkJX29wdGlvbnMoIl9USElTIiwgb2JqKTsKCQlfb3B0aW9ucygiSWQiLCBvYmopOwoKCQlfb3B0aW9ucygiYWN0aXZlIiwgb2JqKTsKCgkJX29wdGlvbnMoImVuYWJsZWQiLCBvYmopOwoKCQlfb3B0aW9ucygib3JkZXIiLCBvYmopOwoKCQlfb3B0aW9ucygiY2xhc3NOYW1lIiwgb2JqKTsKCgkJX29wdGlvbnMoInNjb3BlIiwgb2JqKTsKCgkJX29wdGlvbnMoImNvbnRleHQiLCBvYmopOwoKCQlfb3B0aW9ucygic291cmNlIiwgb2JqKTsKCgkJX29wdGlvbnMoInRhcmdldCIsIG9iaik7CgoJCV9vcHRpb25zKCJvcGVyYXRvciIsIG9iaik7CgoJCV9vcHRpb25zKCJpblNjcmlwdCIsIG9iaik7CgoJCV9vcHRpb25zKCJvdXRTY3JpcHQiLCBvYmopOwoKCQkvLyBjYW4gd2UgZG8gZGVSZWZlcmVuY2UgaGVyZT8KCgkJbGV0IHYgPSB1bmRlZmluZWQ7CgkJdHJ5IHsKCQkJc2FsZXNub3cudW5SZWN1cnNlQWJvcnQgPSBzYWxlc25vdy51blJlY3Vyc2VBYm9ydCB8fCB7fTsKCQkJaWYgKHNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0pIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0JywgJ0VudGl0eU9iamVjdCcsIDEsIGBBYm9ydGluZyBhcyBwZXIgc2FsZXNub3cudW5SZWN1cnNlQWJvcnQuJHtmdW59YCk7CgoJCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQkJcmV0dXJuICh2Lm9iaiAmJiB2Lm9iai5faWQpID8gewoJCQkJCV9pZDogdi5vYmouX2lkCgkJCQl9IDogdi5vYmo7CgkJCQlyZXR1cm4gdi5vYmo7CgoJCQl9CgoJCQlsZXQgX2lkID0gbnVsbDsKCQkJaWYgKHR5cGVvZih0aGlzKSA9PT0gJ3VuZGVmaW5lZCcpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAxLCAiTnVsbCBpbnB1dCIsIHRoaXMsIGZ1biwgZkFyZ3MpOwoJCQkJcmV0dXJuIHRoaXM7CgkJCX0gZWxzZSBpZiAodHlwZW9mKHRoaXMpID09PSAnc3RyaW5nJykgewoJCQkJX2lkID0gdGhpcy5oYXNoQ29kZSh0aGlzKTsKCQkJfSBlbHNlIHsKCQkJCV9pZCA9IHRoaXMuX2lkIHx8IHRoaXMuaWQgfHwgdGhpcy5JRDsKCQkJfQoKCQkJaWYgKHR5cGVvZihfaWQpID09PSAndW5kZWZpbmVkJyB8fCAhX2lkKSB7CgkJCQlpZiAodGhpcy5JZCAmJiB0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLklkID09IHRoaXMuSWQpIHsKCQkJCQlfaWQgPSB0aGlzLklkOwoJCQkJfSBlbHNlIGlmICh0aGlzLkVudGl0eUNsYXNzKSB7CgkJCQkJX2lkID0gdGhpcy5FbnRpdHlDbGFzcy5JZCB8fCB0aGlzLkVudGl0eUNsYXNzLk5hbWU7CgkJCQl9IGVsc2UgewoJCQkJCV9pZCA9IHRoaXMuRW50aXR5Q2xhc3MuSWQgfHwgIjlhYmE1ODgzLWI2NmItNDc5NC04OTdkLTNmZDg1OTRmYTAxMiIgfHwgIk5VTEwiOwoJCQkJfQoJCQl9CgoJCQlzYWxlc25vdy5fdW5SZWN1cnNlID0gc2FsZXNub3cuX3VuUmVjdXJzZSB8fCB7fTsKCQkJc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nID0gc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk1hcHBpbmdbZnVuXSA9IHNhbGVzbm93Ll91blJlY3Vyc2UuTWFwcGluZ1tmdW5dIHx8IHt9OwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk1hcHBpbmdbZnVuXVtfaWRdID0gc2FsZXNub3cuX3VuUmVjdXJzZS5NYXBwaW5nW2Z1bl1bX2lkXSB8fCB7fTsKCgkJCWxldCBfaGFzaCA9IHRoaXMuX3RvSGFzaChmQXJncywgewoJCQkJZGVwdGg6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyAzIDogdW5kZWZpbmVkLAoJCQkJY2FjaGU6IChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBbXSA6IHVuZGVmaW5lZAoJCQl9KTsKCgkJCXYgPSBzYWxlc25vdy5fdW5SZWN1cnNlLk1hcHBpbmdbZnVuXVtfaWRdW19oYXNoXTsKCQkJaWYgKHYgJiYgTWF0aC5hYnMobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB2LmRhdGUpIDwgKDEwMDAgKiAwLjIpKSB7CgkJCQlsZXQgdGhpc1NldE9uID0gKChbIl90b0hhc2giXS5pbmRleE9mKGZ1bikgPj0gMCkgPyBuZXcgRGF0ZSgwKSA6ICh0aGlzLlNldF9PbiB8fCBuZXcgRGF0ZSgwKSkpOwoJCQkJaWYgKHRoaXNTZXRPbiA+PSB2LmRhdGUpIHsKCQkJCQkvLyBhIG5ld2VyIGNvcHkgaXMgY3JlYXRlZCBBRlRFUi9EVVJJTkcgdGhlIHJlY3Vyc2l2ZSBjYWxsISEKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNwYXduaW5nIGluIGZ1biIsIF9pZCwgX2hhc2gsIGZ1biwgdGhpcywgdik7CgkJCQl9IGVsc2UgaWYgKCh2LmRhdGUgLSB0aGlzU2V0T24uZ2V0VGltZSgpKSA+PSAwKSB7CgkJCQkJdi5yZXVzZWQrKzsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfX2ltcG9ydC51blJlY3Vyc2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlNlbGVjdGVkIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMsIHYpOwoJCQkJfQoKCQkJCWlmICh0eXBlb2YodikgPT09ICd1bmRlZmluZWQnKSByZXR1cm4gdjsKCQkJCXJldHVybiAodi5vYmogJiYgdi5vYmouX2lkKSA/IHsKCQkJCQlfaWQ6IHYub2JqLl9pZAoJCQkJfSA6IHYub2JqOwoJCQkJcmV0dXJuIHYub2JqOwoKCQkJfQoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX19pbXBvcnQudW5SZWN1cnNlJywgJ0VudGl0eU9iamVjdCcsIDAsICJQdXNoaW5nIGhhc2giLCBfaWQsIF9oYXNoLCBmdW4sIHRoaXMpOwoJCQlzYWxlc25vdy5fdW5SZWN1cnNlLk1hcHBpbmdbZnVuXVtfaWRdW19oYXNoXSA9IHsKCQkJCWRhdGU6IG5ldyBEYXRlKCkuZ2V0VGltZSgpLAoJCQkJYXJnczogSlNPTi5zdHJpbmdpZnkoZkFyZ3MpLAoJCQkJb2JqOiB0aGlzLAoJCQkJcmV1c2VkOiAwLAoJCQl9OwoJCX0gY2F0Y2ggKHVuUmVjRXgpIHsKCQkJaWYgKCF1blJlY0V4LnRvU3RyaW5nKCkuaW5kZXhPZignUmFuZ2VFcnJvcjogJykpIHsKCQkJCXNhbGVzbm93LnVuUmVjdXJzZUFib3J0W2Z1bl0gPSB0cnVlOwoJCQl9CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19faW1wb3J0LnVuUmVjdXJzZScsICdFbnRpdHlPYmplY3QnLCAyLCB0aGlzLCBmdW4sIGZBcmdzLCB1blJlY0V4LnRvU3RyaW5nKCkpOwoKCQkJaWYgKHR5cGVvZih2KSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybiB2OwoJCQlyZXR1cm4gKHYub2JqICYmIHYub2JqLl9pZCkgPyB7CgkJCQlfaWQ6IHYub2JqLl9pZAoJCQl9IDogdi5vYmo7CgkJCXJldHVybiB2Lm9iajsKCgkJfQoKCQlfb3B0aW9ucygidG9vbCIsIG9iaik7CgoJCV9vcHRpb25zKCJ0eXBlIiwgb2JqKTsKCgkJT2JqZWN0LmtleXMob3B0aW9ucykuZmlsdGVyKGsgPT4gdHlwZW9mKG9wdGlvbnNba10pID09PSAnZnVuY3Rpb24nICYmICFbJ0lkJywgJ19USElTJ10uY29uY2F0KFsnYWN0aXZlJywgJ2VuYWJsZWQnLCAnb3JkZXInLCAnY2xhc3NOYW1lJywgJ3Njb3BlJywgJ2NvbnRleHQnLCAnc291cmNlJywgJ3RhcmdldCcsICdvcGVyYXRvcicsICdpblNjcmlwdCcsICdvdXRTY3JpcHQnLCAndG9vbCcsICd0eXBlJ10pLmNvbmNhdChbJyddKS5pbmNsdWRlcyhrKSkuZm9yRWFjaChrID0+IF9vcHRpb25zKGssIG9iaikpOwoKCQlyZXR1cm4gdGhpczsKCX0KCglfdG9EQk9iamVjdChmaWVsZHMsIGJOb1JlZikgewoJCWlmICghdGhpcy5JZCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9EQk9iamVjdCcsICdFbnRpdHlPYmplY3QnLCAyLCAiSW52YWxpZCBJRCIsIHRoaXMuRW50aXR5Q2xhc3MuTmFtZSwgdGhpcy5Ub29sKTsKCQl9CgkJbGV0IHJldCA9IHsKCQkJW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXTogIiciICsgdGhpcy5JZCArICInIgoJCX07CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiYWN0aXZlIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2FjdGl2ZV9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy5hY3RpdmUoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiZW5hYmxlZCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9lbmFibGVkX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmVuYWJsZWQoKTsKCgkJCWZWYWx1ZSA9IHYgPyAxIDogMDsKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gJ05lbzRqJykgZlZhbHVlID0gZlZhbHVlID8gJ1RydWUnIDogJ0ZhbHNlJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9yZGVyIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29yZGVyX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9yZGVyKCk7CgoJCQlmVmFsdWUgPSB2IHx8ICcwJzsKCgkJCXJldFt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJjbGFzc05hbWUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fY2xhc3NOYW1lX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNsYXNzTmFtZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigic2NvcGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fc2NvcGVfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMuc2NvcGUoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3Njb3BlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigiY29udGV4dCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9jb250ZXh0X3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmNvbnRleHQoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ2NvbnRleHQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJzb3VyY2UiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fc291cmNlX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnNvdXJjZSgpOwoKCQkJZlZhbHVlID0gIiciICsgdiArICInIjsKCgkJCXJldFt0aGlzLl9uQ29kZSgnc291cmNlJywgdW5kZWZpbmVkKSArICIiXSA9IGZWYWx1ZTsKCQl9CgoJCWlmICgoKGZpZWxkcyAmJiBmaWVsZHMuaW5kZXhPZigidGFyZ2V0IikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3RhcmdldF9zZXQgJiYgKCFiTm9SZWYgfHwgdHJ1ZSkpIHsKCQkJbGV0IGZWYWx1ZSA9IG51bGw7CgkJCWxldCB2ID0gdGhpcy50YXJnZXQoKTsKCgkJCWZWYWx1ZSA9ICInIiArIHYgKyAiJyI7CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3RhcmdldCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm9wZXJhdG9yIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX29wZXJhdG9yX3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLm9wZXJhdG9yKCk7CgoJCQlmVmFsdWUgPSAiJyIgKyB2ICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvcGVyYXRvcicsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoImluU2NyaXB0IikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX2luU2NyaXB0X3NldCAmJiAoIWJOb1JlZiB8fCB0cnVlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLmluU2NyaXB0KCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdpblNjcmlwdCcsIHVuZGVmaW5lZCkgKyAiIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoIm91dFNjcmlwdCIpKSB8fCAhZmllbGRzKSAmJiB0aGlzLl9vdXRTY3JpcHRfc2V0ICYmICghYk5vUmVmIHx8IHRydWUpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMub3V0U2NyaXB0KCk7CgoJCQlmVmFsdWUgPSAiJyIgKyAoKHYgJiYgdi5yZXBsYWNlKSA/IHYucmVwbGFjZSgvXCcvZywgIlwnXCciKSA6IHYpICsgIiciOwoKCQkJcmV0W3RoaXMuX25Db2RlKCdvdXRTY3JpcHQnLCB1bmRlZmluZWQpICsgIiJdID0gZlZhbHVlOwoJCX0KCgkJaWYgKCgoZmllbGRzICYmIGZpZWxkcy5pbmRleE9mKCJ0b29sIikpIHx8ICFmaWVsZHMpICYmIHRoaXMuX3Rvb2xfc2V0ICYmICghYk5vUmVmIHx8IGZhbHNlKSkgewoJCQlsZXQgZlZhbHVlID0gbnVsbDsKCQkJbGV0IHYgPSB0aGlzLnRvb2woKTsKCgkJCWlmICh2ICYmICh2Ll9fc3luY19vbigpIHx8IHYuSWQgPT0gdi5JZCkpIHsKCQkJCWZWYWx1ZSA9ICInIiArIHYuSWQgKyAiJyI7CgkJCX0gZWxzZSB7CgkJCQlmVmFsdWUgPSAwOwoJCQl9CgoJCQlyZXRbdGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpICsgImlkIl0gPSBmVmFsdWU7CgkJfQoKCQlpZiAoKChmaWVsZHMgJiYgZmllbGRzLmluZGV4T2YoInR5cGUiKSkgfHwgIWZpZWxkcykgJiYgdGhpcy5fdHlwZV9zZXQgJiYgKCFiTm9SZWYgfHwgZmFsc2UpKSB7CgkJCWxldCBmVmFsdWUgPSBudWxsOwoJCQlsZXQgdiA9IHRoaXMudHlwZSgpOwoKCQkJaWYgKHYgJiYgKHYuX19zeW5jX29uKCkgfHwgdi5JZCA9PSB2LklkKSkgewoJCQkJZlZhbHVlID0gIiciICsgdi5JZCArICInIjsKCQkJfSBlbHNlIHsKCQkJCWZWYWx1ZSA9IDA7CgkJCX0KCgkJCXJldFt0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkgKyAiaWQiXSA9IGZWYWx1ZTsKCQl9CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b0RCT2JqZWN0JywgJ0VudGl0eU9iamVjdCcsIDAsIHJldCk7CgkJcmV0dXJuIHJldDsKCX0KCglfUSgpIHsKCQlsZXQgX28gPSAnIic7CgkJbGV0IF9xID0gX287CgoJCWlmIChbJ1NhbGVzRm9yY2UnXS5pbmRleE9mKHRoaXMuVG9vbC50eXBlLm5hbWUpID09IDApIHsKCQkJX28gPSBfcSA9ICIiOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygndHlwZScpID09ICdteXNxbCcgfHwgdGhpcy5Ub29sLnR5cGUubmFtZSA9PSAnTmVvNGonKSB7CgkJCV9vID0gX3EgPSAnYCc7CgkJfSBlbHNlIGlmICh0aGlzLl9fY29uZmlnKCd0eXBlJykgPT0gJ3NxbHNlcnZlcicpIHsKCQkJX28gPSAnWyc7CgkJCV9xID0gJ10nOwoJCX0gZWxzZSBpZiAodGhpcy5fX2NvbmZpZygnYXBpS2V5JykgPT0gJ2FpcnRhYmxlJykgewoJCQlfbyA9ICd7JzsKCQkJX3EgPSAnfSc7CgkJfQoJCXRoaXMuX19RID0gdGhpcy5fX1EgPT0gX28gPyBfcSA6IF9vOwoJCXJldHVybiB0aGlzLl9fUTsKCX0KCglfZmllbGRHcm91cHMoZmdzID0ge30pIHsKCQl0aGlzLl9fZmllbGRHcm91cHMgPSBmZ3M7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX2ZpZWxkQWdncmVnYXRlcyhmYXMgPSB7fSkgewoJCXRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMgPSBmYXM7CgkJcmV0dXJuIHRoaXM7Cgl9CgoJX3RvRmllbGRzU1FMKGZpZWxkcykgewoKCQlmaWVsZHMgPSBmaWVsZHMgfHwgW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpLCB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3Njb3BlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ2NvbnRleHQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgnc291cmNlJywgdW5kZWZpbmVkKSwgdGhpcy5fbkNvZGUoJ3RhcmdldCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvcGVyYXRvcicsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdpblNjcmlwdCcsIHVuZGVmaW5lZCksIHRoaXMuX25Db2RlKCdvdXRTY3JpcHQnLCB1bmRlZmluZWQpLCB0aGlzLl9uQ29kZSgndG9vbCcsIHVuZGVmaW5lZCkgKyAiLmlkIiwgdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpICsgIi5pZCJdOwoJCWZpZWxkcyA9IEFycmF5LmlzQXJyYXkoZmllbGRzKSA/IGZpZWxkcyA6IFtmaWVsZHNdOwoKCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzKSB7CgkJCS8vIHtmaWVsZDogb3JkZXJ9CgkJCWZpZWxkcyA9IFtdOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5lbmFibGVkKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLm9yZGVyKSBmaWVsZHMucHVzaChgJHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jbGFzc05hbWUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdjbGFzc05hbWUnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5zY29wZSkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ3Njb3BlJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29udGV4dCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ2NvbnRleHQnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5zb3VyY2UpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCdzb3VyY2UnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy50YXJnZXQpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCd0YXJnZXQnLCB1bmRlZmluZWQpfWApOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5vcGVyYXRvcikgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ29wZXJhdG9yJywgdW5kZWZpbmVkKX1gKTsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMudG9vbCkgZmllbGRzLnB1c2goYCR7dGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpKyJpZCJ9YCk7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnR5cGUpIGZpZWxkcy5wdXNoKGAke3RoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSsiaWQifWApOwoKCQl9CgkJcmV0dXJuIGZpZWxkczsKCX0KCglfZnJvbURCT2JqZWN0KHIgPSB7fSkgewoJCXRyeSB7CgkJCXJldHVybiB0aGlzLl9faW1wb3J0KHIsIHsKCQkJCUlkOiBvYmogPT4gdGhpcy5JZCA9IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0sCgoJCQkJYWN0aXZlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuYWN0aXZlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJZW5hYmxlZDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5lbmFibGVkKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9yZGVyKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY2xhc3NOYW1lOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuY2xhc3NOYW1lKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJc2NvcGU6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdzY29wZScsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLnNjb3BlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJY29udGV4dDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRleHQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy5jb250ZXh0KG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJc291cmNlOiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc291cmNlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMuc291cmNlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJdGFyZ2V0OiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndGFyZ2V0JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMudGFyZ2V0KG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3BlcmF0b3I6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcGVyYXRvcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLm9wZXJhdG9yKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJaW5TY3JpcHQ6IChvYmosIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdpblNjcmlwdCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCQl0aGlzLmluU2NyaXB0KG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJb3V0U2NyaXB0OiAob2JqLCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnb3V0U2NyaXB0JywgdW5kZWZpbmVkKSkgPT4gewoJCQkJCXRoaXMub3V0U2NyaXB0KG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJdG9vbDogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy50b29sKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQkJdHlwZTogKG9iaiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQkJdGhpcy50eXBlKG9ialtlYUNvZGVdKTsKCQkJCX0sCgoJCQl9LCAiX2Zyb21EQk9iamVjdCIpOwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tREJPYmplY3QnLCAnRW50aXR5T2JqZWN0JywgMiwgZXgpOwoJCX0KCX0KCglfdG9TZWxlY3RIZWFkZXIoZmllbGRzKSB7CgkJbGV0IHJldCA9IHsKCQkJdGFibGU6IHRoaXMuX25Db2RlKCksCgkJCWZpZWxkczogRG90T2JqZWN0Lm9iamVjdChPYmplY3QuZnJvbUVudHJpZXModGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkubWFwKGYgPT4gW2YsIGZdKSkpLAoJCQlqb2luczoge30sCgkJfTsKCgkJaWYgKGZpZWxkcykgcmV0dXJuIHJldDsKCgkJcmV0LmpvaW5zID0gdGhpcy5fX2V4cG9ydCh7fSwgewoJCQlOdWxsOiB0cnVlLAoKCQkJdG9vbDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpKSA9PiBvYmpbZWFDb2RlXSA9IG5ldyBzYWxlc25vdy5Ub29sKG51bGwsIHRoaXMuVG9vbCkuX3RvU2VsZWN0SGVhZGVyKCksCgoJCQl0eXBlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IG9ialtlYUNvZGVdID0gbmV3IHNhbGVzbm93LlRvb2xfVHlwZShudWxsLCB0aGlzLlRvb2wpLl90b1NlbGVjdEhlYWRlcigpLAoKCQl9LCAiX3RvU2VsZWN0SGVhZGVyIik7CgoJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ190b1NlbGVjdEhlYWRlcicsICdFbnRpdHlPYmplY3QnLCAwLCByZXQpOwoKCQlyZXR1cm4gcmV0OwoJfQoKCV90b1NlbGVjdFNRTChmaWVsZHMpIHsKCQlsZXQgc3FsID0gInNlbGVjdCAiOwoKCQlsZXQgdFByZWYgPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfWA7CgoJCWxldCBoZWFkZXIgPSB0aGlzLl90b1NlbGVjdEhlYWRlcihmaWVsZHMpOwoKCQlzcWwgKz0gT2JqZWN0LnZhbHVlcyhoZWFkZXIuZmllbGRzKS5tYXAoZiA9PiBgJHt0UHJlZn0uJHtmfWApLmpvaW4oJywgJyk7CgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9ICIsICIgKyBPYmplY3QudmFsdWVzKGhlYWRlci5qb2luc1trXS5maWVsZHMpLm1hcChmID0+IGAke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke2Z9IGFzICR7dGhpcy5fUSgpfSR7a30uJHtmLnJlcGxhY2UodGhpcy5fUSgpLCAnJyl9YCkuam9pbignLCAnKSk7CgoJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzKSB7CgkJCS8vIHtmaWVsZDogZnVuY3Rpb259CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5hY3RpdmUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmFjdGl2ZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWQpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmVuYWJsZWR9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3JkZXIpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9yZGVyfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5jbGFzc05hbWUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLmNsYXNzTmFtZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnNjb3BlKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5zY29wZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc2NvcGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29udGV4dCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMuY29udGV4dH0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY29udGV4dCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy5zb3VyY2UpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnNvdXJjZX0oJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc291cmNlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnRhcmdldCkgc3FsICs9IGAke3NxbD09KCdzZWxlY3QgJyk/Jyc6JywnfSAke3RoaXMuX19maWVsZEFnZ3JlZ2F0ZXMudGFyZ2V0fSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd0YXJnZXQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQkJaWYgKHRoaXMuX19maWVsZEFnZ3JlZ2F0ZXMub3BlcmF0b3IpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLm9wZXJhdG9yfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdvcGVyYXRvcicsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9KWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkQWdncmVnYXRlcy50b29sKSBzcWwgKz0gYCR7c3FsPT0oJ3NlbGVjdCAnKT8nJzonLCd9ICR7dGhpcy5fX2ZpZWxkQWdncmVnYXRlcy50b29sfSgke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0pYDsKCgkJCWlmICh0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnR5cGUpIHNxbCArPSBgJHtzcWw9PSgnc2VsZWN0ICcpPycnOicsJ30gJHt0aGlzLl9fZmllbGRBZ2dyZWdhdGVzLnR5cGV9KCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSlgOwoKCQl9CgoJCXNxbCArPSBgIGZyb20gJHt0UHJlZn0gYDsKCgkJT2JqZWN0LmtleXMoaGVhZGVyLmpvaW5zKS5mb3JFYWNoKGsgPT4gc3FsICs9IGBsZWZ0IGpvaW4gJHt0aGlzLl9RKCl9JHtoZWFkZXIuam9pbnNba10udGFibGV9JHt0aGlzLl9RKCl9IGFzICR7dGhpcy5fUSgpfSR7aGVhZGVyLmpvaW5zW2tdLnRhYmxlfV8ke2t9JHt0aGlzLl9RKCl9IG9uICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7a31pZCR7dGhpcy5fUSgpfT0ke3RoaXMuX1EoKX0ke2hlYWRlci5qb2luc1trXS50YWJsZX1fJHtrfSR7dGhpcy5fUSgpfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfSBgKTsKCgkJc3FsICs9IGAgd2hlcmUgMT0xYDsKCgkJc3FsID0gdGhpcy5fX2V4cG9ydCh7CgkJCXNxbDogc3FsCgkJfSwgewoJCQlfZmllbGRzOiAodGhpcy5fX3N5bmNfb24oKSB8fCB0aGlzLklkID09IHRoaXMuSWQpID8gWydJZCddIDogdW5kZWZpbmVkLAoJCQlOdWxsOiB0cnVlLAoJCQlfVEhJUzogb2JqID0+IHsKCQkJCWlmICghdGhpcy5fVEhJUyB8fCAhdGhpcy5fVEhJUy5sZW5ndGgpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fVEhJU19jb29wIHx8ICJJTiIpICsgIiAoIiArIHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9TZWxlY3RTUUwodC5fX2NvbmZpZygnaWRGaWVsZCcpIHx8ICdfX2lkJykpLmpvaW4oJyBVTklPTiBBTEwgJykgKyAiKSI7CgkJCX0sCgkJCUlkOiBvYmogPT4gb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpfSR7dGhpcy5fUSgpfT0nJHt0aGlzLklkfSdgLAoKCQkJYWN0aXZlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9hY3RpdmVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJZW5hYmxlZDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2VuYWJsZWQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2VuYWJsZWRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICI9IiArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAiYm9vbGVhbiIpIHsKCQkJCQlvYmouc3FsICs9ICInIiArICh2ID8gIjEiIDogIjAiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJb3JkZXI6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvcmRlcicsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fb3JkZXJfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9vcmRlcl9jb29wIHx8ICJMSUtFIikgKyAiICI7CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY2xhc3NOYW1lOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9jbGFzc05hbWVfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jbGFzc05hbWVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX2NsYXNzTmFtZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY2xhc3NOYW1lX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY2xhc3NOYW1lX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jbGFzc05hbWVfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXNjb3BlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc2NvcGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3Njb3BlX3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fc2NvcGVfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX3Njb3BlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9zY29wZV9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX3Njb3BlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9zY29wZV9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJY29udGV4dDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ2NvbnRleHQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2NvbnRleHRfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9jb250ZXh0X2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9jb250ZXh0X2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9jb250ZXh0X2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fY29udGV4dF9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fY29udGV4dF9jb29wKSA/ICIlIiA6ICIiKSArICInIjsKCQkJCQlyZXR1cm47CgkJCQl9CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJc291cmNlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnc291cmNlJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9zb3VyY2Vfc2V0KSByZXR1cm47CgoJCQkJb2JqLnNxbCArPSBgIGFuZCAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX0ke3RoaXMuX1EoKX0gYCArICh0aGlzLl9zb3VyY2VfY29vcCB8fCAiTElLRSIpICsgIiAiOwoKCQkJCWlmICh0eXBlb2YodikgPT09ICJzdHJpbmciKSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyAoKHRoaXMuX3NvdXJjZV9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fc291cmNlX2Nvb3ApID8gIiUiIDogIiIpICsgdiArICgodGhpcy5fc291cmNlX2Nvb3AgPT0gIkxJS0UiIHx8ICF0aGlzLl9zb3VyY2VfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCXRhcmdldDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3RhcmdldCcsIHVuZGVmaW5lZCkpID0+IHsKCQkJCWlmICghdGhpcy5fdGFyZ2V0X3NldCkgcmV0dXJuOwoKCQkJCW9iai5zcWwgKz0gYCBhbmQgJHt0UHJlZn0uJHt0aGlzLl9RKCl9JHtlYUNvZGV9JHt0aGlzLl9RKCl9IGAgKyAodGhpcy5fdGFyZ2V0X2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl90YXJnZXRfY29vcCA9PSAiTElLRSIgfHwgIXRoaXMuX3RhcmdldF9jb29wKSA/ICIlIiA6ICIiKSArIHYgKyAoKHRoaXMuX3RhcmdldF9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fdGFyZ2V0X2Nvb3ApID8gIiUiIDogIiIpICsgIiciOwoJCQkJCXJldHVybjsKCQkJCX0KCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvcGVyYXRvcjogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ29wZXJhdG9yJywgdW5kZWZpbmVkKSkgPT4gewoJCQkJaWYgKCF0aGlzLl9vcGVyYXRvcl9zZXQpIHJldHVybjsKCgkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfSR7dGhpcy5fUSgpfSBgICsgKHRoaXMuX29wZXJhdG9yX2Nvb3AgfHwgIkxJS0UiKSArICIgIjsKCgkJCQlpZiAodHlwZW9mKHYpID09PSAic3RyaW5nIikgewoJCQkJCW9iai5zcWwgKz0gIiciICsgKCh0aGlzLl9vcGVyYXRvcl9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fb3BlcmF0b3JfY29vcCkgPyAiJSIgOiAiIikgKyB2ICsgKCh0aGlzLl9vcGVyYXRvcl9jb29wID09ICJMSUtFIiB8fCAhdGhpcy5fb3BlcmF0b3JfY29vcCkgPyAiJSIgOiAiIikgKyAiJyI7CgkJCQkJcmV0dXJuOwoJCQkJfQoKCQkJCWlmICh2ICYmIHYuRW50aXR5Q2xhc3MpIHsKCQkJCQlvYmouc3FsICs9ICIoIiArIHYuX3RvU2VsZWN0U1FMKCkgKyAiKSI7CgkJCQl9IGVsc2UgewoJCQkJCW9iai5zcWwgKz0gIiciICsgdiArICInIjsKCQkJCX0KCQkJfSwKCgkJCWluU2NyaXB0OiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgnaW5TY3JpcHQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX2luU2NyaXB0X3NldCkgcmV0dXJuOwoKCQkJCXJldHVybjsKCgkJCQlpZiAodiAmJiB2LkVudGl0eUNsYXNzKSB7CgkJCQkJb2JqLnNxbCArPSAiKCIgKyB2Ll90b1NlbGVjdFNRTCgpICsgIikiOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9ICInIiArIHYgKyAiJyI7CgkJCQl9CgkJCX0sCgoJCQlvdXRTY3JpcHQ6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCdvdXRTY3JpcHQnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX291dFNjcmlwdF9zZXQpIHJldHVybjsKCgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJdG9vbDogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3Rvb2xfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl90b29sX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQkJdHlwZTogKG9iaiwgdiwgZWFDb2RlID0gdGhpcy5fbkNvZGUoJ3R5cGUnLCB1bmRlZmluZWQpKSA9PiB7CgkJCQlpZiAoIXRoaXMuX3R5cGVfc2V0KSByZXR1cm47CgoJCQkJbGV0IGNvb3AgPSB0aGlzLl90eXBlX2Nvb3A7CgkJCQlzd2l0Y2ggKGNvb3ApIHsKCQkJCQljYXNlICIhPSI6CgkJCQkJCWNvb3AgPSAiTk9UIElOIjsKCQkJCQljYXNlICI9IjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQkJY2FzZSAiIjoKCQkJCQkJY29vcCA9ICJJTiI7CgkJCQl9CgoJCQkJaWYgKHYpIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICR7dFByZWZ9LiR7dGhpcy5fUSgpfSR7ZWFDb2RlfWlkJHt0aGlzLl9RKCl9ICR7Y29vcH0gKCR7di5fdG9TZWxlY3RTUUwodi5fX2NvbmZpZygnaWRGaWVsZCcpfHwnX19pZCcpfSlgOwoJCQkJfSBlbHNlIHsKCQkJCQlvYmouc3FsICs9IGAgYW5kICgke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSAke2Nvb3B9ICgwKSBPUiAke3RQcmVmfS4ke3RoaXMuX1EoKX0ke2VhQ29kZX1pZCR7dGhpcy5fUSgpfSBJUyBOVUxMKWA7CgkJCQl9CgkJCQlyZXR1cm47CgoJCQkJaWYgKHYgJiYgdi5FbnRpdHlDbGFzcykgewoJCQkJCW9iai5zcWwgKz0gIigiICsgdi5fdG9TZWxlY3RTUUwoKSArICIpIjsKCQkJCX0gZWxzZSB7CgkJCQkJb2JqLnNxbCArPSAiJyIgKyB2ICsgIiciOwoJCQkJfQoJCQl9LAoKCQl9LCAiX3RvU2VsZWN0U1FMIiwgZmllbGRzKS5zcWw7CgoJCWlmICh0aGlzLl9fZmllbGRHcm91cHMpIHsKCQkJaWYgKE9iamVjdC5rZXlzKHRoaXMuX19maWVsZEdyb3VwcykubGVuZ3RoKSBzcWwgKz0gIiBncm91cCBieSAiOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5hY3RpdmUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnYWN0aXZlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuYWN0aXZlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWQpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCl9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLmVuYWJsZWR9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3JkZXIpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcmRlcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5jbGFzc05hbWUpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnY2xhc3NOYW1lJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuY2xhc3NOYW1lfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnNjb3BlKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3Njb3BlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuc2NvcGV9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMuY29udGV4dCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCdjb250ZXh0JywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuY29udGV4dH1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy5zb3VyY2UpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnc291cmNlJywgdW5kZWZpbmVkKX0ke3RoaXMuX1EoKX0gJHt0aGlzLl9fZmllbGRHcm91cHMuc291cmNlfWA7CgoJCQlpZiAodGhpcy5fX2ZpZWxkR3JvdXBzLnRhcmdldCkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd0YXJnZXQnLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy50YXJnZXR9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMub3BlcmF0b3IpIHNxbCArPSBgJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgnb3BlcmF0b3InLCB1bmRlZmluZWQpfSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy5vcGVyYXRvcn1gOwoKCQkJaWYgKHRoaXMuX19maWVsZEdyb3Vwcy50b29sKSBzcWwgKz0gYCR7dGhpcy5fUSgpfSR7dGhpcy5fbkNvZGUoJ3Rvb2wnLCB1bmRlZmluZWQpKyJpZCJ9JHt0aGlzLl9RKCl9ICR7dGhpcy5fX2ZpZWxkR3JvdXBzLnRvb2x9YDsKCgkJCWlmICh0aGlzLl9fZmllbGRHcm91cHMudHlwZSkgc3FsICs9IGAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSsiaWQifSR7dGhpcy5fUSgpfSAke3RoaXMuX19maWVsZEdyb3Vwcy50eXBlfWA7CgoJCX0KCgkJaWYgKHNxbC5lbmRzV2l0aCgid2hlcmUgMT0xIikpIHsKCQkJLy8gc3FsID0gc3FsLnJlcGxhY2UoIndoZXJlIDE9MSIsICJ3aGVyZSAxPTAiKTsKCQl9IGVsc2UgewoJCQlzcWwgPSBzcWwucmVwbGFjZSgid2hlcmUgMT0xIGFuZCAiLCAid2hlcmUgIik7CgkJfQoKCQlzcWwgPSB0eXBlb2Yoc3FsRm9ybWF0dGVyKSAhPT0gJ3VuZGVmaW5lZCcgPyBzcWxGb3JtYXR0ZXIuZm9ybWF0KHNxbCkgOiBzcWw7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvU2VsZWN0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgoJCXJldHVybiBzcWw7Cgl9CgoJX3RvUGF0aHMoKSB7CgkJbGV0IHJldCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJX1RISVM6IG9iaiA9PiB7fSwKCgkJCXRvb2w6IChvYmosIHYsIGVhQ29kZSA9IHRoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKSkgPT4gb2JqLnRvb2wgPSB2Ll90b1BhdGhzKCksCgoJCQl0eXBlOiAob2JqLCB2LCBlYUNvZGUgPSB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkpID0+IG9iai50eXBlID0gdi5fdG9QYXRocygpLAoKCQl9LCAiX3RvUGF0aHMiKTsKCQkvLyByZXR1cm4gcmV0OwoJCXJldHVybiBPYmplY3Qua2V5cyhyZXQpLm1hcChrID0+ICh7CgkJCVtrXTogcmV0W2tdCgkJfSkpOwoJfQoKCV90b1VwZGF0ZVNRTChmaWVsZHMpIHsKCQlsZXQgcmV0RmllbGRzID0gdGhpcy5fdG9GaWVsZHNTUUwoZmllbGRzKS5tYXAoZiA9PiB0aGlzLl9RKCkgKyBmLnJlcGxhY2UoL1wuL2csICcnKSArIHRoaXMuX1EoKSkuam9pbignLCAnKTsKCQlsZXQgc3FsID0gYHVwZGF0ZSAke3RoaXMuX1EoKX0ke3RoaXMuX25Db2RlKCl9JHt0aGlzLl9RKCl9IHNldCBgICsgT2JqZWN0LmVudHJpZXModGhpcy5fdG9EQk9iamVjdChmaWVsZHMpKS5tYXAodiA9PiB0aGlzLl9RKCkgKyB2WzBdICsgdGhpcy5fUSgpICsgIj0iICsgdlsxXSkgKyBgIHdoZXJlICR7dGhpcy5fUSgpfSR7dGhpcy5fX2NvbmZpZygnaWRGaWVsZCcsICdfX2lkJyl9JHt0aGlzLl9RKCl9PScke3RoaXMuSWR9J2A7IC8vYCByZXR1cm5pbmcgJHtyZXRGaWVsZHN9YDsKCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfdG9VcGRhdGVTUUwnLCAnRW50aXR5T2JqZWN0JywgMCwgc3FsKTsKCQlyZXR1cm4gc3FsOwoJfQoKCV90b0luc2VydFNRTChmaWVsZHMpIHsKCQlsZXQgb2JqID0gdGhpcy5fdG9EQk9iamVjdChmaWVsZHMpOwoJCWxldCBzcWwgPSBgaW5zZXJ0IGludG8gJHt0aGlzLl9RKCl9JHt0aGlzLl9uQ29kZSgpfSR7dGhpcy5fUSgpfSAoYCArIE9iamVjdC5rZXlzKG9iaikubWFwKGsgPT4gdGhpcy5fUSgpICsgayArIHRoaXMuX1EoKSkgKyAiKSB2YWx1ZXMgKCIgKyBPYmplY3QudmFsdWVzKG9iaikgKyBgKWA7CgkJdGhpcy5sb2codW5kZWZpbmVkLCAnX3RvSW5zZXJ0U1FMJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJcmV0dXJuIHNxbDsKCX0KCglfY29weUZyb20ob2JqKSB7CgkJaWYgKCFvYmopIHJldHVybiBudWxsOwoJCXJldHVybiB0aGlzLl9yZXZlcnQob2JqKTsKCX0KCglhc3luYyBfc3RvcmVFbnRpdHlDbGFzcyhkZXB0aCkgewoJCXRyeSB7CgkJCWlmICh0eXBlb2YoZGVwdGgpID09PSAidW5kZWZpbmVkIikgZGVwdGggPSB0aGlzLl9fY29uZmlnKCJjcmVhdGUiKTsKCQkJaWYgKCFkZXB0aCkgcmV0dXJuOwoKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MgPSBzYWxlc25vdy5fc3RvcmVFbnRpdHlDbGFzcyB8fCB7fTsKCQkJaWYgKHNhbGVzbm93Ll9zdG9yZUVudGl0eUNsYXNzLk1hcHBpbmcpIHJldHVybjsKCQkJc2FsZXNub3cuX3N0b3JlRW50aXR5Q2xhc3MuTWFwcGluZyA9IHRydWU7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAwLCBgc3RvcmluZyAnJHt0aGlzLlRvb2wudHlwZS5uYW1lfScgbW9kZWwgd2l0aCBkZXB0aCAke2RlcHRofWApOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCBzcWwgPSBuZXcgc2FsZXNub3cuTWFwcGluZygpCgoJCQkJCS50b29sKG5ldyBzYWxlc25vdy5Ub29sKCkpCgoJCQkJCS50eXBlKG5ldyBzYWxlc25vdy5Ub29sX1R5cGUoKSkKCgkJCQkJLl90b1NRTFRhYmxlKGRlcHRoKTsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19zdG9yZUVudGl0eUNsYXNzJywgJ0VudGl0eU9iamVjdCcsIDAsIHNxbCk7CgkJCQlhd2FpdCB0aGlzLl9zcWwoc3FsKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJfQoKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfc3RvcmVFbnRpdHlDbGFzcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJCXJldHVybiB0aGlzOwoJfQoKCWFzeW5jIERTQ29ubmVjdCh0b29sID0gdGhpcy5Ub29sKSB7CgoJCXJldHVybiBhd2FpdCBuZXcgc2FsZXNub3cuVXNlcigpLkRTQ29ubmVjdCh0b29sKTsKCgl9CgkvKiBFbmQ6IFV0aWwgZnVuY3Rpb25zICovCgoJX21hdGNoZXMocXVlcnkpIHsKCQl0cnkgewoJCQlpZiAoIXF1ZXJ5IHx8ICFxdWVyeS5FbnRpdHlDbGFzcyB8fCBxdWVyeS5FbnRpdHlDbGFzcy5OYW1lICE9ICJNYXBwaW5nIikgcmV0dXJuIGZhbHNlOwoKCQkJbGV0IG9NYXRjaCA9IHRoaXMuX19leHBvcnQoe30sIHsKCQkJCUZ1bGw6IHRydWUsCgkJCQlOdWxsOiB0cnVlLAoJCQkJSWQ6IChvYmosIHYpID0+IG9iai5faWQgPSB0aGlzLklkID09IHF1ZXJ5LklkLAoKCQkJCWFjdGl2ZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouYWN0aXZlID0gdiA9PSBxdWVyeS5hY3RpdmUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fYWN0aXZlX3NldCAmJiAhcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouYWN0aXZlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2FjdGl2ZV9zZXQgJiYgcXVlcnkuX2FjdGl2ZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmFjdGl2ZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQllbmFibGVkOiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5lbmFibGVkID0gdiA9PSBxdWVyeS5lbmFibGVkKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ICYmICFxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouZW5hYmxlZCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9lbmFibGVkX3NldCAmJiBxdWVyeS5fZW5hYmxlZF9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmVuYWJsZWQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3JkZXI6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9yZGVyID0gdiA9PSBxdWVyeS5vcmRlcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcmRlcl9zZXQgJiYgIXF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3JkZXIgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3JkZXJfc2V0ICYmIHF1ZXJ5Ll9vcmRlcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9yZGVyID0gZmFsc2U7CgkJCQl9LAoKCQkJCWNsYXNzTmFtZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY2xhc3NOYW1lID0gdiA9PSBxdWVyeS5jbGFzc05hbWUoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fY2xhc3NOYW1lX3NldCAmJiAhcXVlcnkuX2NsYXNzTmFtZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouY2xhc3NOYW1lID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2NsYXNzTmFtZV9zZXQgJiYgcXVlcnkuX2NsYXNzTmFtZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNsYXNzTmFtZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQlzY29wZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouc2NvcGUgPSB2ID09IHF1ZXJ5LnNjb3BlKCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3Njb3BlX3NldCAmJiAhcXVlcnkuX3Njb3BlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5zY29wZSA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9zY29wZV9zZXQgJiYgcXVlcnkuX3Njb3BlX3NldCkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouc2NvcGUgPSBmYWxzZTsKCQkJCX0sCgoJCQkJY29udGV4dDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouY29udGV4dCA9IHYgPT0gcXVlcnkuY29udGV4dCgpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9jb250ZXh0X3NldCAmJiAhcXVlcnkuX2NvbnRleHRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmNvbnRleHQgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fY29udGV4dF9zZXQgJiYgcXVlcnkuX2NvbnRleHRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5jb250ZXh0ID0gZmFsc2U7CgkJCQl9LAoKCQkJCXNvdXJjZTogKG9iaiwgdikgPT4gewoKCQkJCQlvYmouc291cmNlID0gdiA9PSBxdWVyeS5zb3VyY2UoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fc291cmNlX3NldCAmJiAhcXVlcnkuX3NvdXJjZV9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmouc291cmNlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3NvdXJjZV9zZXQgJiYgcXVlcnkuX3NvdXJjZV9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnNvdXJjZSA9IGZhbHNlOwoJCQkJfSwKCgkJCQl0YXJnZXQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnRhcmdldCA9IHYgPT0gcXVlcnkudGFyZ2V0KCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX3RhcmdldF9zZXQgJiYgIXF1ZXJ5Ll90YXJnZXRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnRhcmdldCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl90YXJnZXRfc2V0ICYmIHF1ZXJ5Ll90YXJnZXRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai50YXJnZXQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJb3BlcmF0b3I6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm9wZXJhdG9yID0gdiA9PSBxdWVyeS5vcGVyYXRvcigpOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl9vcGVyYXRvcl9zZXQgJiYgIXF1ZXJ5Ll9vcGVyYXRvcl9zZXQpIHx8CgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoub3BlcmF0b3IgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fb3BlcmF0b3Jfc2V0ICYmIHF1ZXJ5Ll9vcGVyYXRvcl9zZXQpIHx8CgoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm9wZXJhdG9yID0gZmFsc2U7CgkJCQl9LAoKCQkJCWluU2NyaXB0OiAob2JqLCB2KSA9PiB7CgoJCQkJCW9iai5pblNjcmlwdCA9IHYgPT0gcXVlcnkuaW5TY3JpcHQoKTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5faW5TY3JpcHRfc2V0ICYmICFxdWVyeS5faW5TY3JpcHRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLmluU2NyaXB0ID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX2luU2NyaXB0X3NldCAmJiBxdWVyeS5faW5TY3JpcHRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5pblNjcmlwdCA9IGZhbHNlOwoJCQkJfSwKCgkJCQlvdXRTY3JpcHQ6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLm91dFNjcmlwdCA9IHYgPT0gcXVlcnkub3V0U2NyaXB0KCk7CgoJCQkJCWlmICgKCQkJCQkJKHRoaXMuX291dFNjcmlwdF9zZXQgJiYgIXF1ZXJ5Ll9vdXRTY3JpcHRfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLm91dFNjcmlwdCA9IHRydWU7CgoJCQkJCWlmICgKCQkJCQkJKCF0aGlzLl9vdXRTY3JpcHRfc2V0ICYmIHF1ZXJ5Ll9vdXRTY3JpcHRfc2V0KSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai5vdXRTY3JpcHQgPSBmYWxzZTsKCQkJCX0sCgoJCQkJdG9vbDogKG9iaiwgdikgPT4gewoKCQkJCQlvYmoudG9vbCA9IHYgPyB2Ll9tYXRjaGVzKHF1ZXJ5ID8gcXVlcnkudG9vbCgpIDogbnVsbCkgOiB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSh0aGlzLl90b29sX3NldCAmJiAhcXVlcnkuX3Rvb2xfc2V0KSB8fAoJCQkJCQlmYWxzZQoJCQkJCSkgb2JqLnRvb2wgPSB0cnVlOwoKCQkJCQlpZiAoCgkJCQkJCSghdGhpcy5fdG9vbF9zZXQgJiYgcXVlcnkuX3Rvb2xfc2V0KSB8fAoKCQkJCQkJKHRoaXMudG9vbCgpICYmICF0aGlzLnRvb2woKS5fbWF0Y2hlcyhxdWVyeS50b29sKCkpKSB8fAoKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai50b29sID0gZmFsc2U7CgkJCQl9LAoKCQkJCXR5cGU6IChvYmosIHYpID0+IHsKCgkJCQkJb2JqLnR5cGUgPSB2ID8gdi5fbWF0Y2hlcyhxdWVyeSA/IHF1ZXJ5LnR5cGUoKSA6IG51bGwpIDogdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkodGhpcy5fdHlwZV9zZXQgJiYgIXF1ZXJ5Ll90eXBlX3NldCkgfHwKCQkJCQkJZmFsc2UKCQkJCQkpIG9iai50eXBlID0gdHJ1ZTsKCgkJCQkJaWYgKAoJCQkJCQkoIXRoaXMuX3R5cGVfc2V0ICYmIHF1ZXJ5Ll90eXBlX3NldCkgfHwKCgkJCQkJCSh0aGlzLnR5cGUoKSAmJiAhdGhpcy50eXBlKCkuX21hdGNoZXMocXVlcnkudHlwZSgpKSkgfHwKCgkJCQkJCWZhbHNlCgkJCQkJKSBvYmoudHlwZSA9IGZhbHNlOwoJCQkJfSwKCgkJCX0sICJfbWF0Y2hlcyIpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoZXMnLCAnRW50aXR5T2JqZWN0JywgMCwgb01hdGNoKTsKCgkJCXJldHVybiBPYmplY3Qua2V5cyhvTWF0Y2gpLmV2ZXJ5KGsgPT4gb01hdGNoW2tdKTsKCQl9IGNhdGNoIChleCkgewoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hlcycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9tYXRjaGluZyhxdWVyeSkgewoJCXRyeSB7CgkJCWxldCByZXQgPSBbXTsKCgkJCWxldCBtYXRjaGVzID0gdGhpcy5fX2V4cG9ydCh7fSwgewoKCQkJCXRvb2w6IChvYmosIHYpID0+IHsKCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIkZvciB0b29sIik7CgkJCQkJb2JqLnRvb2wgPSB2ID8gW3YuX21hdGNoaW5nKHF1ZXJ5KSA/IHYgOiBudWxsXS5jb25jYXQodi5fbWF0Y2hpbmcocXVlcnkpKS5maWx0ZXIobSA9PiBtKSA6IFtdOwoJCQkJfSwKCgkJCQl0eXBlOiAob2JqLCB2KSA9PiB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJGb3IgdHlwZSIpOwoJCQkJCW9iai50eXBlID0gdiA/IFt2Ll9tYXRjaGluZyhxdWVyeSkgPyB2IDogbnVsbF0uY29uY2F0KHYuX21hdGNoaW5nKHF1ZXJ5KSkuZmlsdGVyKG0gPT4gbSkgOiBbXTsKCQkJCX0sCgoJCQl9LCAiX21hdGNoaW5nIik7CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfbWF0Y2hpbmcnLCAnRW50aXR5T2JqZWN0JywgMCwgIm1hdGNoZXMiLCBtYXRjaGVzKTsKCgkJCXJldCA9IFsuLi5uZXcgU2V0KE9iamVjdC5rZXlzKG1hdGNoZXMpLm1hcChrID0+IG1hdGNoZXNba10pLmZsYXQoKSldLmZpbHRlcihtID0+IG0gIT0gcXVlcnkpOwoKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX21hdGNoaW5nJywgJ0VudGl0eU9iamVjdCcsIDAsICJyZXQiLCByZXQpOwoJCQlyZXR1cm4gcmV0OwoJCX0gY2F0Y2ggKGV4KSB7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19tYXRjaGluZycsICdFbnRpdHlPYmplY3QnLCAyLCBleCk7CgkJfQoJfQoKCV9kZVJlZmVyZW5jZShyb290KSB7CgkJdHJ5IHsKCQkJaWYgKCFyb290KSByb290ID0gdGhpczsKCgkJCWxldCBpc1F1ZXJ5ID0gdHJ1ZQoKCQkJCSYmCgkJCQkodGhpcy5fYWN0aXZlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2VuYWJsZWRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fb3JkZXJfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fY2xhc3NOYW1lX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3Njb3BlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX2NvbnRleHRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fc291cmNlX3NldCA/IGZhbHNlIDogdHJ1ZSkKCgkJCQkmJgoJCQkJKHRoaXMuX3RhcmdldF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vcGVyYXRvcl9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9pblNjcmlwdF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl9vdXRTY3JpcHRfc2V0ID8gZmFsc2UgOiB0cnVlKQoKCQkJCSYmCgkJCQkodGhpcy5fdG9vbF9zZXQgPyBmYWxzZSA6IHRydWUpCgoJCQkJJiYKCQkJCSh0aGlzLl90eXBlX3NldCA/IGZhbHNlIDogdHJ1ZSk7CgoJCQlpZiAocm9vdCAhPSB0aGlzICYmIGlzUXVlcnkpIHsKCQkJCWxldCBteU1hdGNoZXMgPSByb290Ll9tYXRjaGluZyh0aGlzKTsKCQkJCWlmICghbXlNYXRjaGVzLmxlbmd0aCkgcmV0dXJuIHRoaXM7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZGVSZWZlcmVuY2UnLCAnRW50aXR5T2JqZWN0JywgMCwgIlF1ZXJ5IiwgbXlNYXRjaGVzLmxlZ3RoKTsKCQkJCXJldHVybiBteU1hdGNoZXNbMF07CgkJCX0KCgkJCXRoaXMuX19leHBvcnQoe30sIHsKCgkJCQl0b29sOiAob2JqLCB2KSA9PiB7CgkJCQkJaWYgKHYpIHsKCQkJCQkJbGV0IHJldCA9IHYuX2RlUmVmZXJlbmNlKHJvb3QpOwoJCQkJCQlpZiAocmV0ICE9IHYpIHRoaXMudG9vbChyZXQpOwoJCQkJCX0KCQkJCX0sCgoJCQkJdHlwZTogKG9iaiwgdikgPT4gewoJCQkJCWlmICh2KSB7CgkJCQkJCWxldCByZXQgPSB2Ll9kZVJlZmVyZW5jZShyb290KTsKCQkJCQkJaWYgKHJldCAhPSB2KSB0aGlzLnR5cGUocmV0KTsKCQkJCQl9CgkJCQl9LAoKCQkJfSwgIl9kZVJlZmVyZW5jZSIpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSBjYXRjaCAoZXgpIHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2RlUmVmZXJlbmNlJywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQl9Cgl9CgoJX2Zyb21Eb2N1bWVudChvYmosIGJUb29sLCBiTm9OdWxsKSB7CgkJaWYgKCFvYmopIHJldHVybiB0aGlzOwoJCWlmIChvYmouX2Zyb21Eb2N1bWVudCkgcmV0dXJuIG9iajsKCgkJaWYgKHR5cGVvZihvYmopID09PSAnc3RyaW5nJykgewoJCQl0cnkgewoJCQkJb2JqID0gSlNPTi5wYXJzZShvYmopOwoJCQl9IGNhdGNoIChleCkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAxLCAiSW52YWxpZCBKU09OIiwgb2JqKTsKCQkJfQoJCX0KCgkJdGhpcy5fX2ltcG9ydChvYmosIHsKCQkJX21hcDogYlRvb2wsCgkJCV9USElTOiBvYmogPT4gdGhpcy5USElTKG9iai5USElTLCBvYmouT1BFUkFUT1JTID8gb2JqLk9QRVJBVE9SUy5USElTIDogdW5kZWZpbmVkKSwKCQkJSWQ6IG9iaiA9PiB7CgkJCQl0aGlzLklkID0gb2JqW3RoaXMuX19jb25maWcoJ2lkRmllbGQnLCAnX19pZCcpXTsKCQkJCWlmIChvYmouX190b29sKSB7CgkJCQkJdHJ5IHsKCQkJCQkJdGhpcy5Ub29sID0gb2JqLl9fdG9vbDsKCQkJCQl9IGNhdGNoIChleCkgewoJCQkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdfZnJvbURvY3VtZW50JywgJ0VudGl0eU9iamVjdCcsIDIsIGV4KTsKCQkJCQl9CgkJCQl9CgkJCX0sCgoJCQlhY3RpdmU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9hY3RpdmVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmFjdGl2ZShyZWYpOwoKCQkJfSwKCgkJCWVuYWJsZWQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdlbmFibGVkJywgdW5kZWZpbmVkKSA6ICJlbmFibGVkIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2VuYWJsZWRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmVuYWJsZWQocmVmKTsKCgkJCX0sCgoJCQlvcmRlcjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29yZGVyJywgdW5kZWZpbmVkKSA6ICJvcmRlciIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9vcmRlcl9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMub3JkZXIocmVmKTsKCgkJCX0sCgoJCQljbGFzc05hbWU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjbGFzc05hbWUnLCB1bmRlZmluZWQpIDogImNsYXNzTmFtZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9jbGFzc05hbWVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNsYXNzTmFtZShyZWYpOwoKCQkJfSwKCgkJCXNjb3BlOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnc2NvcGUnLCB1bmRlZmluZWQpIDogInNjb3BlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3Njb3BlX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5zY29wZShyZWYpOwoKCQkJfSwKCgkJCWNvbnRleHQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjb250ZXh0JywgdW5kZWZpbmVkKSA6ICJjb250ZXh0IikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX2NvbnRleHRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmNvbnRleHQocmVmKTsKCgkJCX0sCgoJCQlzb3VyY2U6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzb3VyY2UnLCB1bmRlZmluZWQpIDogInNvdXJjZSIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl9zb3VyY2VfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLnNvdXJjZShyZWYpOwoKCQkJfSwKCgkJCXRhcmdldDogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3RhcmdldCcsIHVuZGVmaW5lZCkgOiAidGFyZ2V0IikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3RhcmdldF9jb29wID0gb2JqLk9QRVJBVE9SU1tlYUNvZGVdOwoJCQkJfQoKCQkJCWxldCByZWYgPSBvYmpbZWFDb2RlXTsKCQkJCWlmICh0eXBlb2YocmVmKSA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjsKCQkJCWlmIChiTm9OdWxsICYmIHJlZiA9PT0gbnVsbCkgcmV0dXJuOwoKCQkJCXRoaXMudGFyZ2V0KHJlZik7CgoJCQl9LAoKCQkJb3BlcmF0b3I6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdvcGVyYXRvcicsIHVuZGVmaW5lZCkgOiAib3BlcmF0b3IiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3BlcmF0b3JfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLm9wZXJhdG9yKHJlZik7CgoJCQl9LAoKCQkJaW5TY3JpcHQ6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdpblNjcmlwdCcsIHVuZGVmaW5lZCkgOiAiaW5TY3JpcHQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5faW5TY3JpcHRfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQl0aGlzLmluU2NyaXB0KHJlZik7CgoJCQl9LAoKCQkJb3V0U2NyaXB0OiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3V0U2NyaXB0JywgdW5kZWZpbmVkKSA6ICJvdXRTY3JpcHQiKSkgPT4gewoJCQkJaWYgKG9iai5PUEVSQVRPUlMgJiYgb2JqLk9QRVJBVE9SU1tlYUNvZGVdKSB7CgkJCQkJdGhpcy5fb3V0U2NyaXB0X2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJdGhpcy5vdXRTY3JpcHQocmVmKTsKCgkJCX0sCgoJCQl0b29sOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndG9vbCcsIHVuZGVmaW5lZCkgOiAidG9vbCIpKSA9PiB7CgkJCQlpZiAob2JqLk9QRVJBVE9SUyAmJiBvYmouT1BFUkFUT1JTW2VhQ29kZV0pIHsKCQkJCQl0aGlzLl90b29sX2Nvb3AgPSBvYmouT1BFUkFUT1JTW2VhQ29kZV07CgkJCQl9CgoJCQkJbGV0IHJlZiA9IG9ialtlYUNvZGVdOwoJCQkJaWYgKHR5cGVvZihyZWYpID09PSAndW5kZWZpbmVkJykgcmV0dXJuOwoJCQkJaWYgKGJOb051bGwgJiYgcmVmID09PSBudWxsKSByZXR1cm47CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlJlc3REQklPIikgcmVmID0gcmVmWzBdOwoJCQkJaWYgKCFyZWYpIHJldHVybjsKCgkJCQlsZXQgb1JlZiA9ICh0aGlzLnRvb2woKSB8fCBuZXcgc2FsZXNub3cuVG9vbCgpKS5fZnJvbURvY3VtZW50KHJlZiwgYlRvb2wpOwoKCQkJCWlmICghYlRvb2wgfHwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSB8fCAhdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSkgewoJCQkJCXRoaXMudG9vbChvUmVmKTsKCQkJCX0gZWxzZSB7CgkJCQkJLy8gdGhpcy5sb2codW5kZWZpbmVkLCAnX2Zyb21Eb2N1bWVudCcsICdFbnRpdHlPYmplY3QnLCAwLCAiRW1wdHkgUmVmZXJlbmNlIHRvb2wiLCBvUmVmLl9fSURbdGhpcy5Ub29sLm5hbWVdLCB0aGlzLl9fSURbdGhpcy5Ub29sLm5hbWVdLCByZWYpOwoJCQkJfQoKCQkJfSwKCgkJCXR5cGU6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0eXBlJywgdW5kZWZpbmVkKSA6ICJ0eXBlIikpID0+IHsKCQkJCWlmIChvYmouT1BFUkFUT1JTICYmIG9iai5PUEVSQVRPUlNbZWFDb2RlXSkgewoJCQkJCXRoaXMuX3R5cGVfY29vcCA9IG9iai5PUEVSQVRPUlNbZWFDb2RlXTsKCQkJCX0KCgkJCQlsZXQgcmVmID0gb2JqW2VhQ29kZV07CgkJCQlpZiAodHlwZW9mKHJlZikgPT09ICd1bmRlZmluZWQnKSByZXR1cm47CgkJCQlpZiAoYk5vTnVsbCAmJiByZWYgPT09IG51bGwpIHJldHVybjsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiUmVzdERCSU8iKSByZWYgPSByZWZbMF07CgkJCQlpZiAoIXJlZikgcmV0dXJuOwoKCQkJCWxldCBvUmVmID0gKHRoaXMudHlwZSgpIHx8IG5ldyBzYWxlc25vdy5Ub29sX1R5cGUoKSkuX2Zyb21Eb2N1bWVudChyZWYsIGJUb29sKTsKCgkJCQlpZiAoIWJUb29sIHx8IG9SZWYuX19JRFt0aGlzLlRvb2wubmFtZV0gfHwgIXRoaXMuX19JRFt0aGlzLlRvb2wubmFtZV0pIHsKCQkJCQl0aGlzLnR5cGUob1JlZik7CgkJCQl9IGVsc2UgewoJCQkJCS8vIHRoaXMubG9nKHVuZGVmaW5lZCwgJ19mcm9tRG9jdW1lbnQnLCAnRW50aXR5T2JqZWN0JywgMCwgIkVtcHR5IFJlZmVyZW5jZSB0eXBlIiwgb1JlZi5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgdGhpcy5fX0lEW3RoaXMuVG9vbC5uYW1lXSwgcmVmKTsKCQkJCX0KCgkJCX0sCgoJCX0sICJfZnJvbURvY3VtZW50Iik7CgoJCXJldHVybiB0aGlzOwoJfQoKCV90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIHsKCQlsZXQgcmV0ID0ge307CgoJCWlmICghYlRvb2wpIHsKCQkJcmV0Ll9fZ2VuZXJhdGVkID0gbmV3IERhdGUoKTsKCQkJaWYgKHRoaXMuVG9vbC5uYW1lKSB7CgkJCQlyZXQuX190b29sID0gewoJCQkJCW5hbWU6IHRoaXMuVG9vbC5uYW1lLAoJCQkJCXR5cGU6IHsKCQkJCQkJbmFtZTogdGhpcy5Ub29sLnR5cGUubmFtZSwKCQkJCQl9CgkJCQl9OwoJCQl9CgkJCWlmIChzYWxlc25vdy5fbm9kZSkgewoJCQkJcmV0Ll9fbm9kZSA9IHsKCQkJCQljb2RlOiBzYWxlc25vdy5fbm9kZS5jb2RlKCkKCQkJCX07CgkJCX0KCQl9CgoJCXJldHVybiB0aGlzLl9fZXhwb3J0KHJldCwgewoJCQlGdWxsOiBiRnVsbCwKCQkJTnVsbDogYk51bGwsCgkJCV9tYXA6IGJUb29sLAoJCQlfVEhJUzogKG9iaiwgdikgPT4gewoJCQkJaWYgKGJUb29sKSByZXR1cm47CgkJCQlvYmouVEhJUyA9IHRoaXMuX1RISVMubWFwKHQgPT4gdC5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSk7CgkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCW9iai5PUEVSQVRPUlMuVEhJUyA9IHRoaXMuX1RISVNfY29vcDsKCQkJfSwKCQkJSWQ6IChvYmosIHYpID0+IG9ialt0aGlzLl9fY29uZmlnKCdpZEZpZWxkJywgJ19faWQnKV0gPSB2LAoKCQkJImFjdGl2ZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdhY3RpdmUnLCB1bmRlZmluZWQpIDogImFjdGl2ZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9hY3RpdmVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2FjdGl2ZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImVuYWJsZWQiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnZW5hYmxlZCcsIHVuZGVmaW5lZCkgOiAiZW5hYmxlZCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9lbmFibGVkX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9lbmFibGVkX2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3JkZXIiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgnb3JkZXInLCB1bmRlZmluZWQpIDogIm9yZGVyIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX29yZGVyX2Nvb3ApIHsKCQkJCQlvYmouT1BFUkFUT1JTID0gb2JqLk9QRVJBVE9SUyB8fCB7fTsKCQkJCQlvYmouT1BFUkFUT1JTW2VhQ29kZV0gPSB0aGlzLl9vcmRlcl9jb29wOwoJCQkJfQoJCQl9LAoKCQkJImNsYXNzTmFtZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdjbGFzc05hbWUnLCB1bmRlZmluZWQpIDogImNsYXNzTmFtZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9jbGFzc05hbWVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2NsYXNzTmFtZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInNjb3BlIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ3Njb3BlJywgdW5kZWZpbmVkKSA6ICJzY29wZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9zY29wZV9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fc2NvcGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJjb250ZXh0IjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ2NvbnRleHQnLCB1bmRlZmluZWQpIDogImNvbnRleHQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5fY29udGV4dF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fY29udGV4dF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInNvdXJjZSI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdzb3VyY2UnLCB1bmRlZmluZWQpIDogInNvdXJjZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9zb3VyY2VfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3NvdXJjZV9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInRhcmdldCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0YXJnZXQnLCB1bmRlZmluZWQpIDogInRhcmdldCIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl90YXJnZXRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3RhcmdldF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJIm9wZXJhdG9yIjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ29wZXJhdG9yJywgdW5kZWZpbmVkKSA6ICJvcGVyYXRvciIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2OwoKCQkJCWlmICh0aGlzLl9vcGVyYXRvcl9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3BlcmF0b3JfY29vcDsKCQkJCX0KCQkJfSwKCgkJCSJpblNjcmlwdCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCdpblNjcmlwdCcsIHVuZGVmaW5lZCkgOiAiaW5TY3JpcHQiKSkgPT4gewoKCQkJCW9ialtlYUNvZGVdID0gdjsKCgkJCQlpZiAodGhpcy5faW5TY3JpcHRfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX2luU2NyaXB0X2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkib3V0U2NyaXB0IjogKG9iaiwgdiwgZWFDb2RlID0gKGJUb29sID8gdGhpcy5fbkNvZGUoJ291dFNjcmlwdCcsIHVuZGVmaW5lZCkgOiAib3V0U2NyaXB0IikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHY7CgoJCQkJaWYgKHRoaXMuX291dFNjcmlwdF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fb3V0U2NyaXB0X2Nvb3A7CgkJCQl9CgkJCX0sCgoJCQkidG9vbCI6IChvYmosIHYsIGVhQ29kZSA9IChiVG9vbCA/IHRoaXMuX25Db2RlKCd0b29sJywgdW5kZWZpbmVkKSA6ICJ0b29sIikpID0+IHsKCgkJCQlvYmpbZWFDb2RlXSA9IHYgPyB2Ll90b0RvY3VtZW50KGJUb29sLCBiRnVsbCwgYk51bGwpIDogbnVsbDsKCgkJCQlpZiAodGhpcy5fdG9vbF9jb29wKSB7CgkJCQkJb2JqLk9QRVJBVE9SUyA9IG9iai5PUEVSQVRPUlMgfHwge307CgkJCQkJb2JqLk9QRVJBVE9SU1tlYUNvZGVdID0gdGhpcy5fdG9vbF9jb29wOwoJCQkJfQoJCQl9LAoKCQkJInR5cGUiOiAob2JqLCB2LCBlYUNvZGUgPSAoYlRvb2wgPyB0aGlzLl9uQ29kZSgndHlwZScsIHVuZGVmaW5lZCkgOiAidHlwZSIpKSA9PiB7CgoJCQkJb2JqW2VhQ29kZV0gPSB2ID8gdi5fdG9Eb2N1bWVudChiVG9vbCwgYkZ1bGwsIGJOdWxsKSA6IG51bGw7CgoJCQkJaWYgKHRoaXMuX3R5cGVfY29vcCkgewoJCQkJCW9iai5PUEVSQVRPUlMgPSBvYmouT1BFUkFUT1JTIHx8IHt9OwoJCQkJCW9iai5PUEVSQVRPUlNbZWFDb2RlXSA9IHRoaXMuX3R5cGVfY29vcDsKCQkJCX0KCQkJfSwKCgkJfSwgIl90b0RvY3VtZW50IiwgYlRvb2wsIGJGdWxsLCBiTnVsbCk7Cgl9CgoJYXN5bmMgZ2V0KG5hbWUpIHsKCQlpZiAoIXRoaXMuSWQpIHJldHVybiBudWxsOwoJCXZhciB0ID0gbnVsbDsKCQkkLmVhY2gobmFtZS5zcGxpdCgnLicpLCAoXywgZikgPT4gewoJCQl0ID0gewoJCQkJRW50aXR5T2JqZWN0OiB0ID8gewoJCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCQlWYWx1ZUVudGl0aWVzOiBbdF0KCQkJCX0gOiB7CgkJCQkJQWN0aXZlOiB0cnVlLAoJCQkJCUlkOiB0aGlzLklkCgkJCQl9LAoJCQkJRW50aXR5QXR0cmlidXRlOiB7CgkJCQkJTmFtZTogZiwKCQkJCQlPUEVSQVRPUlM6IHsKCQkJCQkJTmFtZTogIj0iCgkJCQkJfQoJCQkJfQoJCQl9OwoJCX0pOwoJCXJldHVybiAkLndoZW4odGhpcy5zcigpLl8oIkVudGVycHJpc2VNYW5hZ2VyLmVtc0VudGl0eVZhbHVlRmluZCIsIG51bGwsIHQpKS50aGVuKGV2ID0+IHsKCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnZ2V0JywgJ0VudGl0eU9iamVjdCcsIDAsIGV2KTsKCQkJaWYgKGV2ID09PSBudWxsKSByZXR1cm4gbnVsbDsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc1N0cmluZykgcmV0dXJuIGV2LlN0cmluZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzRmxvYXQpIHJldHVybiBldi5GbG9hdFZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzSW50KSByZXR1cm4gZXYuSW50VmFsdWU7CgkJCWlmIChldi5FbnRpdHlBdHRyaWJ1dGUuSXNMb25nKSByZXR1cm4gZXYuTG9uZ1ZhbHVlOwoJCQlpZiAoZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCkgcmV0dXJuIGV2LlRleHRWYWx1ZTsKCQkJaWYgKGV2LkVudGl0eUF0dHJpYnV0ZS5Jc0Jvb2wpIHJldHVybiBldi5Cb29sVmFsdWU7CgoJCQlpZiAoIWV2Lk9iamVjdFZhbHVlKSByZXR1cm4gbnVsbDsKCgkJCXJldHVybiBuZXcgc2FsZXNub3dbJC5ncmVwKHNhbGVzbm93LkVudGl0eUNsYXNzZXMsIGMgPT4gYy5JZCA9PSBldi5FbnRpdHlBdHRyaWJ1dGUuRW50aXR5VHlwZWlkKVswXS5OYW1lLnJlcGxhY2UoLyAvZywgJ18nKV0oZXYuT2JqZWN0VmFsdWUuSWQpOwoJCX0pOwoJfQoKCS8qIFNUQVJUOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLl8oKSAqLwoJXyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl8oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5fKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmJ1aWxkVVJMKCkgKi8KCWJ1aWxkVVJMKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuYnVpbGRVUkwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5idWlsZFVSTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuYnVpbGRVUkwoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuJF9SRVFVRVNUKCkgKi8KCSRfUkVRVUVTVCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLiRfUkVRVUVTVCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuJF9SRVFVRVNUKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnBhcmFtKCkgKi8KCXBhcmFtKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IucGFyYW0oLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wYXJhbSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucGFyYW0oKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuX3RvWE1MKCkgKi8KCV90b1hNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLl90b1hNTCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl90b1hNTCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuX3RvWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNvb3AoKSAqLwoJY29vcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmNvb3AoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jb29wKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5jb29wKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLk9SKCkgKi8KCU9SKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuT1IoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5PUiguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuT1IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IubXlSZXBsYWNlKCkgKi8KCW15UmVwbGFjZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLm15UmVwbGFjZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IubXlSZXBsYWNlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnNlbmRYTUwoKSAqLwoJc2VuZFhNTCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnNlbmRYTUwoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5zZW5kWE1MKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5zZW5kWE1MKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCglwcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5wcm9jZXNzUmVzcG9uc2UoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnByb2Nlc3NSZXNwb25zZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5wcm9jZXNzUmVzdWx0KCkgKi8KCXByb2Nlc3NSZXN1bHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5wcm9jZXNzUmVzdWx0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucHJvY2Vzc1Jlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IucHJvY2Vzc1Jlc3VsdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5zZXJ2ZXJEYXRlKCkgKi8KCXNlcnZlckRhdGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5zZXJ2ZXJEYXRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc2VydmVyRGF0ZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3Iuc2VydmVyRGF0ZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5hZGRNU2Vjb25kcygpICovCglhZGRNU2Vjb25kcyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLmFkZE1TZWNvbmRzKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuYWRkTVNlY29uZHMoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmFkZE1TZWNvbmRzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLnJ1blNjcmlwdCgpICovCglydW5TY3JpcHQoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5ydW5TY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNjcmlwdCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5ydW5TUlNjcmlwdCgpICovCglydW5TUlNjcmlwdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLnJ1blNSU2NyaXB0KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkucnVuU1JTY3JpcHQoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLnJ1blNSU2NyaXB0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmhhc2hDb2RlKCkgKi8KCWhhc2hDb2RlKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuaGFzaENvZGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5oYXNoQ29kZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuaGFzaENvZGUoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuZ3JvdXBCeSgpICovCglncm91cEJ5KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuZ3JvdXBCeSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLmdyb3VwQnkoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmdyb3VwQnkoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuU2hvd0RlYnVnKCkgKi8KCVNob3dEZWJ1ZyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLlNob3dEZWJ1ZyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuU2hvd0RlYnVnKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmNhY2hlUmVzdWx0KCkgKi8KCWNhY2hlUmVzdWx0KC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuY2FjaGVSZXN1bHQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5jYWNoZVJlc3VsdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuY2FjaGVSZXN1bHQoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IudG9IZXgoKSAqLwoJdG9IZXgoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci50b0hleCguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLnRvSGV4KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci50b0hleCgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBzci5TaG93RXJyb3IoKSAqLwoJU2hvd0Vycm9yKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5zcikgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuc3IuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuU2hvd0Vycm9yKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBzci5TaG93RXJyb3IoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogc3IuRXF1YWxzKCkgKi8KCUVxdWFscyguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuc3IpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93LnNyLkVxdWFscyguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLkVxdWFscyguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogc3IuRXF1YWxzKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IHNyLmlwQWRkcmVzcygpICovCglpcEFkZHJlc3MoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93LnNyKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5zci5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5pcEFkZHJlc3MoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IHNyLmlwQWRkcmVzcygpICovCgoJLyogRU5EOiBzciBmdW5jdGlvbiBjb3BpZXMgKi8KCgkvKiBTVEFSVDogX0ZyRU1EIGZ1bmN0aW9uIGNvcGllcyAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl9hdHRyKCkgKi8KCV9hdHRyKC4uLnBhcmFtcykgewoJCWlmICh0eXBlb2Yod2luZG93KSAhPT0gInVuZGVmaW5lZCIgJiYgdHlwZW9mKHdpbmRvdy5fRnJFTUQpICE9PSAidW5kZWZpbmVkIikgewoJCQlyZXR1cm4gd2luZG93Ll9GckVNRC5fYXR0ciguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl9hdHRyKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2F0dHIoKSAqLwoKCS8qIENMT05FOjpTVEFSVDogX0ZyRU1ELl91bmlxdWUoKSAqLwoJX3VuaXF1ZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3VuaXF1ZSguLi5wYXJhbXMpOwoJCX0gZWxzZSB7CgkJCXJldHVybiBuZXcgc2FsZXNub3cuVXNlcigpLl91bmlxdWUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fdW5pcXVlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fZmxpcCgpICovCglfZmxpcCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2ZsaXAoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fZmxpcCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9mbGlwKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fcmVmcmVzaEFQSSgpICovCglfcmVmcmVzaEFQSSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3JlZnJlc2hBUEkoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fcmVmcmVzaEFQSSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9yZWZyZXNoQVBJKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fX3Njb3BlKCkgKi8KCV9fc2NvcGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9fc2NvcGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fX3Njb3BlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX19zY29wZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuc3IoKSAqLwoJc3IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnNyKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuc3IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5zcigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2F0b2IoKSAqLwoJX2F0b2IoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9hdG9iKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2F0b2IoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYXRvYigpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2J0b2EoKSAqLwoJX2J0b2EoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9idG9hKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2J0b2EoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5fYnRvYSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX190aW1lKCkgKi8KCV9fdGltZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX190aW1lKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX190aW1lKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX190aW1lKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fd2FpdCgpICovCglfd2FpdCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3dhaXQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fd2FpdCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl93YWl0KCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fc3FsVHlwZSgpICovCglfc3FsVHlwZSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3NxbFR5cGUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fc3FsVHlwZSguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl9zcWxUeXBlKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5fdXVpZCgpICovCglfdXVpZCguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX3V1aWQoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5fdXVpZCguLi5wYXJhbXMpOwoJCX0KCX0KCS8qIENMT05FOjpFTkQgIDogX0ZyRU1ELl91dWlkKCkgKi8KCgkvKiBDTE9ORTo6U1RBUlQ6IF9GckVNRC5yZXF1aXJlKCkgKi8KCXJlcXVpcmUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELnJlcXVpcmUoLi4ucGFyYW1zKTsKCQl9IGVsc2UgewoJCQlyZXR1cm4gbmV3IHNhbGVzbm93LlVzZXIoKS5yZXF1aXJlKC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQucmVxdWlyZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2luY2x1ZGUoKSAqLwoJX2luY2x1ZGUoLi4ucGFyYW1zKSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpICE9PSAidW5kZWZpbmVkIiAmJiB0eXBlb2Yod2luZG93Ll9GckVNRCkgIT09ICJ1bmRlZmluZWQiKSB7CgkJCXJldHVybiB3aW5kb3cuX0ZyRU1ELl9pbmNsdWRlKC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2luY2x1ZGUoLi4ucGFyYW1zKTsKCQl9Cgl9CgkvKiBDTE9ORTo6RU5EICA6IF9GckVNRC5faW5jbHVkZSgpICovCgoJLyogQ0xPTkU6OlNUQVJUOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCV9iZWF1dGlmeSguLi5wYXJhbXMpIHsKCQlpZiAodHlwZW9mKHdpbmRvdykgIT09ICJ1bmRlZmluZWQiICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKSAhPT0gInVuZGVmaW5lZCIpIHsKCQkJcmV0dXJuIHdpbmRvdy5fRnJFTUQuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfSBlbHNlIHsKCQkJcmV0dXJuIG5ldyBzYWxlc25vdy5Vc2VyKCkuX2JlYXV0aWZ5KC4uLnBhcmFtcyk7CgkJfQoJfQoJLyogQ0xPTkU6OkVORCAgOiBfRnJFTUQuX2JlYXV0aWZ5KCkgKi8KCgkvKiBFTkQ6IF9GckVNRCBmdW5jdGlvbiBjb3BpZXMgKi8KCglpMThuKGV2LCB2KSB7CgkJaWYgKHR5cGVvZih3aW5kb3cpID09PSAidW5kZWZpbmVkIiB8fCB0eXBlb2Yod2luZG93LmkxOG5fc3RvcmUpID09PSAidW5kZWZpbmVkIikgcmV0dXJuIHY7CgoJCWlmICghZXYuRW50aXR5QXR0cmlidXRlLklzVGV4dCAmJiAhZXYuRW50aXR5QXR0cmlidXRlLklzU3RyaW5nKSB7CgkJCXJldHVybiB2OwoJCX0gZWxzZSB7CgkJCXJldHVybiB3aW5kb3cuaTE4bl9zdG9yZVt0aGlzLmhhc2hDb2RlKHYpXSA9IHdpbmRvdy5pMThuX3N0b3JlW3RoaXMuaGFzaENvZGUodildIHx8IHY7CgkJfQoJfQoKCWJ5VG9vbChhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfdG9vbCJdICYmIChhWyJfdG9vbCJdLkVxdWFscyA/IGFbIl90b29sIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl90b29sIl0sIHIpKSkgewoJCQkJCXIuX3Rvb2xfTWFwcGluZ3MucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCglieVRvb2xfVHlwZShhcikgewoJCXZhciByZXQgPSBbXTsKCQlhci5mb3JFYWNoKGEgPT4gewoJCQlyZXQuZm9yRWFjaChyID0+IHsKCQkJCWlmIChhWyJfdHlwZSJdICYmIChhWyJfdHlwZSJdLkVxdWFscyA/IGFbIl90eXBlIl0uRXF1YWxzKHIpIDogc3IuRXF1YWxzKGFbIl90eXBlIl0sIHIpKSkgewoJCQkJCXIuX3R5cGVfTWFwcGluZ3MucHVzaChhKTsKCQkJCX0KCQkJfSk7CgkJfSk7CgkJcmV0dXJuIHJldDsKCX0KCgl0b1N0cmluZygpIHsKCgkJcmV0dXJuIHRoaXMuSWQ7CgoJfQoKCUVudGl0eVZhbHVlKGFOYW1lKSB7CgkJbGV0IHJldCA9IFtdLmNvbmNhdCh0aGlzLkVudGl0eVZhbHVlcywgdGhpcy5WYWx1ZUVudGl0aWVzKS5maW5kKGV2ID0+IGV2LkVudGl0eUF0dHJpYnV0ZSAmJiBldi5FbnRpdHlBdHRyaWJ1dGUuTmFtZSA9PSBhTmFtZSk7CgoJCWlmICghcmV0KSB7CgkJCS8vIGFuIGF0dHJpYnV0ZSB0aGF0IGhhcyB5ZXQgbm8ga25vd24gZW50aXR5IHZhbHVlCgkJCXJldCA9IHsKCQkJCUFjdGl2ZTogdHJ1ZSwKCQkJCU9QRVJBVE9SUzoge30sCgkJCQlFbnRpdHlBdHRyaWJ1dGU6IHsKCQkJCQlOYW1lOiBhTmFtZSwKCQkJCQlBY3RpdmU6IHRydWUsCgkJCQkJRW50aXR5Q2xhc3M6IHsKCQkJCQkJSWQ6IHRoaXMuRW50aXR5Q2xhc3MuSWQKCQkJCQl9CgkJCQl9CgkJCX07CgkJCXRoaXMuRW50aXR5VmFsdWVzLnB1c2gocmV0KTsKCQl9CgoJCXJldHVybiByZXQ7Cgl9CgoJYXN5bmMgZmluZChkZXB0aCA9IDEpIHsKCQlyZXR1cm4gKGF3YWl0IHRoaXMuZmluZEFsbChkZXB0aCkpWzBdOwoJfQoKCV9fYXNzZXJ0VmFsaWQoYlN5bmMpIHsKCQlsZXQgZXJyb3IgPSB7fTsKCgkJaWYgKE9iamVjdC5rZXlzKGVycm9yKS5sZW5ndGgpIHsKCQkJdGhpcy5fX2Fzc2VydEVycm9yID0gZXJyb3I7CgkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ19fYXNzZXJ0VmFsaWQnLCAnRW50aXR5T2JqZWN0JywgMiwgSlNPTi5zdHJpbmdpZnkoZXJyb3IsIG51bGwsIDQpLCB0aGlzLl90b0RvY3VtZW50KCkpOwoJCQlyZXR1cm4gZmFsc2U7CgkJfSBlbHNlIHsKCQkJZGVsZXRlIHRoaXMuX19hc3NlcnRFcnJvcjsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoKCWFzeW5jIHN0b3JlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInN0b3JlIiwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gInN0b3JlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHN0b3JlKCkgKioqLwoJCQl0aGlzLl9fdGltZSgnc2FsZXNub3cuTWFwcGluZy5zdG9yZScpOyAvLyBvciBpbnNpZGUgZXhlY3V0ZT8KCgkJCWRlbGV0ZSBzYWxlc25vdy5fdW5SZWN1cnNlOwoJCQlsZXQgYlVwZGF0ZSA9IGZhbHNlOwoJCQlsZXQgYkluc2VydCA9IGZhbHNlOwoKCQkJaWYgKCF0aGlzLl9fc3luY19vbigpKSB7CgkJCQlsZXQgX3RoaXMgPSBuZXcgc2FsZXNub3cuTWFwcGluZyhudWxsLCB0aGlzLlRvb2wpOwoKCQkJCWxldCBiRmluZCA9IGZhbHNlOwoJCQkJaWYgKHRoaXMuSWQgPT0gdGhpcy5JZCkgewoJCQkJCWJGaW5kID0gdHJ1ZTsKCQkJCQlfdGhpcy5JZCA9IHRoaXMuSWQ7CgkJCQl9CgoJCQkJaWYgKGJGaW5kKSB7CgkJCQkJX3RoaXMgPSBhd2FpdCBfdGhpcy5maW5kKCk7CgkJCQl9IGVsc2UgX3RoaXMgPSBudWxsOwoJCQkJaWYgKF90aGlzKSB7CgkJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIl90aGlzLklkIiwgX3RoaXMuSWQsIF90aGlzLlRvb2wubmFtZSwgdGhpcy5Ub29sLm5hbWUpOwoJCQkJCXRoaXMuSWQgPSBfdGhpcy5JZDsKCQkJCQliVXBkYXRlID0gdHJ1ZTsKCQkJCX0gZWxzZSB7CgkJCQkJdGhpcy5JZCA9IHRoaXMuSWQ7IC8vIHRvIGVuZm9yY2UgdGhlIElkIGFuZCBub3QgZ2V0IGEgbmV3IG9uZSBldmVyeSB0aW1lCgkJCQkJYkluc2VydCA9IHRydWU7CgkJCQl9CgkJCX0gZWxzZSBpZiAoTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApIDwgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSkgewoJCQkJdGhpcy5sb2codW5kZWZpbmVkLCAnc3RvcmUnLCAnRW50aXR5T2JqZWN0JywgMCwgIkFscmVhZHkgc3RvcmVkIiwgTWF0aC5hYnMoKHRoaXMuU2V0X09uLmdldFRpbWUoKSAtIHRoaXMuX19zeW5jX29uKCkuZ2V0VGltZSgpKSAvIDEwMDApICsgIjwiICsgdGhpcy5fX2NvbmZpZygnc3RvcmUuc2Vuc2l0aXZpdHknLCA1KSk7CgkJCX0gZWxzZSB7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJHb2luZyB0byB1cGRhdGUgWyIgKyB0aGlzLklkICsgIl0iKTsKCQkJCWJVcGRhdGUgPSB0cnVlOwoJCQl9CgoJCQlpZiAoIWJVcGRhdGUgJiYgIWJJbnNlcnQpIHsKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsICJObyBkYXRhIGNoYW5nZXMiKTsKCQkJfSBlbHNlIHsKCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU3FsREIiKSB7CgoJCQkJCWlmICh0eXBlb2Yoc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbikgPT09ICJ1bmRlZmluZWQiIHx8IHNhbGVzbm93Ll9fc3FsVHJhbnNhY3Rpb24uZW5kKSB7CgkJCQkJCWF3YWl0IHRoaXMuX3NxbChgJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPydCRUdJTic6J1NUQVJUJ30gVFJBTlNBQ1RJT05gKTsKCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbiA9IHsKCQkJCQkJCU93bmVyOiB0aGlzLAoJCQkJCQkJc3FsczogW10sCgkJCQkJCQlzdGFydDogbmV3IERhdGUoKSwKCQkJCQkJCWVuZDogbnVsbAoJCQkJCQl9OwoJCQkJCX0KCgkJCQl9CgoJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJfQoKCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTYWxlc0ZvcmNlIikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCX0KCgkJCQlpZiAodGhpcy5fX2NvbmZpZygiU3luY0VudGl0eUF0dHJpYnV0ZXMiKSkgewoKCQkJCQlpZiAodGhpcy5fdG9vbF9zZXQgJiYgdGhpcy50b29sKCkgJiYgIShhd2FpdCB0aGlzLnRvb2woKS5zdG9yZSgpKSkgdGhpcy5jbGVhcl90b29sKCk7CgoJCQkJCWlmICh0aGlzLl90eXBlX3NldCAmJiB0aGlzLnR5cGUoKSAmJiAhKGF3YWl0IHRoaXMudHlwZSgpLnN0b3JlKCkpKSB0aGlzLmNsZWFyX3R5cGUoKTsKCgkJCQl9CgoJCQkJaWYgKCF0aGlzLl9fYXNzZXJ0VmFsaWQodHJ1ZSkpIHJldHVybiBudWxsOwoKCQkJCS8vYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLyBpbiBjYXNlIFRvb2wgY2hhbmdlcwoKCQkJCXRoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBBYm91dCB0byBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX1gKTsKCQkJCWlmIChiVXBkYXRlKSBhd2FpdCB0aGlzLnVwZGF0ZSgpOwoJCQkJaWYgKGJJbnNlcnQpIGF3YWl0IHRoaXMuaW5zZXJ0KCk7CgkJCQkvL3RoaXMubG9nKHVuZGVmaW5lZCwgJ3N0b3JlJywgJ0VudGl0eU9iamVjdCcsIDAsIGBGaW5pc2hlZCBJbnNlcnQ6JHtiSW5zZXJ0fSwgVXBkYXRlOiR7YlVwZGF0ZX0gSWQ9WyR7dGhpcy5JZH1dYCk7CgoJCQkJaWYgKHRoaXMuX19jb25maWcoIlN5bmNUeXBlZEF0dHJpYnV0ZXMiKSkgewoKCQkJCX0KCgkJCQlpZiAoYlVwZGF0ZSB8fCBiSW5zZXJ0KSB7CgoJCQkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQkJCWlmIChzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uICYmICFzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLmVuZCAmJiBzYWxlc25vdy5fX3NxbFRyYW5zYWN0aW9uLk93bmVyID09IHRoaXMpIHsKCQkJCQkJCWF3YWl0IHRoaXMuX3NxbChgQ09NTUlUJHt0aGlzLl9fY29uZmlnKCd0eXBlJyk9PSdzcWxpdGUnPycgVFJBTlNBQ1RJT04nOicnfWApOwoJCQkJCQkJc2FsZXNub3cuX19zcWxUcmFuc2FjdGlvbi5lbmQgPSBuZXcgRGF0ZSgpOwoJCQkJCQl9CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNlcnZpY2VOb3ciKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJCX0KCgkJCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQkJfQoKCQkJCX0KCQkJfQoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgkJCXJldHVybiB0aGlzOwoJCX0sIHsKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IG51bGwKCQl9KS5yZXQ7IC8vIGZpcnN0IG9uZSB0byBleGVjdXRlIGNvcnJlY3RseQoJfQoKCWFzeW5jIGluc2VydCgpIHsKCQlsZXQgcmVzdWx0cyA9IGF3YWl0IHRoaXMuX2V4ZWN1dGUoc2FsZXNub3csICJpbnNlcnQiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiaW5zZXJ0IiwgX25vZGUpID0+IHsKCQkJcmV0dXJuIG9TY29wZS5fbm9kZS5fc2FtZU5vZGUoX25vZGUpCgkJfSwgYXN5bmMgKGxvZywgd2FybiwgZXJyb3IsIG9TY29wZSwgbWV0aG9kID0gImluc2VydCIpID0+IHsKCQkJLyoqKiBTVEFSVCBMT0NBTCBpbnNlcnQoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5NYXBwaW5nLmluc2VydCcpOwoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCWxldCByZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9JbnNlcnRTUUwoKSk7CgkJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdpbnNlcnQnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQl0aGlzLl9mcm9tRG9jdW1lbnQoYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKSk7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2FsZXNGb3JjZSIpIHsKCgkJCQlsZXQgb2JqID0ge307CgoJCQkJaWYgKHRoaXMuX2FjdGl2ZV9zZXQpIHsKCgkJCQkJb2JqLmFjdGl2ZSA9IHRoaXMuYWN0aXZlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9lbmFibGVkX3NldCkgewoKCQkJCQlvYmouZW5hYmxlZCA9IHRoaXMuZW5hYmxlZCgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fb3JkZXJfc2V0KSB7CgoJCQkJCW9iai5vcmRlciA9IHRoaXMub3JkZXIoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2NsYXNzTmFtZV9zZXQpIHsKCgkJCQkJb2JqLmNsYXNzTmFtZSA9IHRoaXMuY2xhc3NOYW1lKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9zY29wZV9zZXQpIHsKCgkJCQkJb2JqLnNjb3BlID0gdGhpcy5zY29wZSgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fY29udGV4dF9zZXQpIHsKCgkJCQkJb2JqLmNvbnRleHQgPSB0aGlzLmNvbnRleHQoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX3NvdXJjZV9zZXQpIHsKCgkJCQkJb2JqLnNvdXJjZSA9IHRoaXMuc291cmNlKCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl90YXJnZXRfc2V0KSB7CgoJCQkJCW9iai50YXJnZXQgPSB0aGlzLnRhcmdldCgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fb3BlcmF0b3Jfc2V0KSB7CgoJCQkJCW9iai5vcGVyYXRvciA9IHRoaXMub3BlcmF0b3IoKTsKCgkJCQl9CgoJCQkJaWYgKHRoaXMuX2luU2NyaXB0X3NldCkgewoKCQkJCQlvYmouaW5TY3JpcHQgPSB0aGlzLmluU2NyaXB0KCk7CgoJCQkJfQoKCQkJCWlmICh0aGlzLl9vdXRTY3JpcHRfc2V0KSB7CgoJCQkJCW9iai5vdXRTY3JpcHQgPSB0aGlzLm91dFNjcmlwdCgpOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fdG9vbF9zZXQpIHsKCgkJCQkJb2JqLnRvb2wgPSB0aGlzLl90b29sLklkOwoKCQkJCX0KCgkJCQlpZiAodGhpcy5fdHlwZV9zZXQpIHsKCgkJCQkJb2JqLnR5cGUgPSB0aGlzLl90eXBlLklkOwoKCQkJCX0KCgkJCQlsb2coIlNlbmRpbmcgdG8gU0YiLCBvYmopOwoKCQkJCWxldCByZXMgPSBhd2FpdCB0aGlzLlRvb2wuZGIuc29iamVjdCgiTWFwcGluZyIpLmNyZWF0ZShvYmopOwoJCQkJdGhpcy5JZCA9IHJlcy5pZDsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJHaXRIdWIiKSB7CgoJCQkJYXdhaXQgdGhpcy5fZ2l0aHViKGBzYWxlc25vdy8ke3RoaXMuX25Db2RlKCl9LyR7dGhpcy5JZH0uanNgLCB0aGlzLl90b0RvY3VtZW50KHRydWUpKTsKCgkJCX0KCgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoKCQkJcmV0dXJuIHRoaXM7CgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgdXBkYXRlKCkgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgInVwZGF0ZSIsIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJ1cGRhdGUiLCBfbm9kZSkgPT4gewoJCQlyZXR1cm4gb1Njb3BlLl9ub2RlLl9zYW1lTm9kZShfbm9kZSkKCQl9LCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAidXBkYXRlIikgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIHVwZGF0ZSgpICoqKi8KCQkJdGhpcy5fX3RpbWUoJ3NhbGVzbm93Lk1hcHBpbmcudXBkYXRlJyk7CgoJCQlsZXQgcmV0ID0gbnVsbDsKCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTcWxEQiIpIHsKCgkJCQlhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9VcGRhdGVTUUwoKSk7CgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9zcWwodGhpcy5fdG9TZWxlY3RTUUwoKSk7CgkJCQlpZiAoQXJyYXkuaXNBcnJheShyZXQpKSByZXQgPSByZXRbMF07CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiU2VydmljZU5vdyIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9yZXN0KG51bGwsIG51bGwsIHRoaXMuX3RvRG9jdW1lbnQodHJ1ZSkpOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQl9CgoJCQlpZiAodGhpcy5Ub29sLnR5cGUubmFtZSA9PSAiR2l0SHViIikgewoKCQkJCWF3YWl0IHRoaXMuX2dpdGh1Yihgc2FsZXNub3cvJHt0aGlzLl9uQ29kZSgpfS8ke3RoaXMuSWR9LmpzYCwgdGhpcy5fdG9Eb2N1bWVudCh0cnVlKSk7CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICd1cGRhdGUnLCAnRW50aXR5T2JqZWN0JywgMCwgInJlc3VsdCIsIHJldCk7CgkJCXRoaXMuX19zeW5jX29uKG5ldyBEYXRlKCkpOwoJCQl0aGlzLl9mcm9tRG9jdW1lbnQocmV0LCB0cnVlKTsKCgkJCXJldHVybiByZXQ7CgoJCQkvKioqIEVORCBMT0NBTCB1cGRhdGUoKSAqKiovCgkJfSwgewoJCQlfX2JlZm9yZVJ1bGVzOiBbXSwKCQkJX19hZnRlclJ1bGVzOiBbXQoJCX0pOwoKCQlyZXR1cm4gKHJlc3VsdHMuZmluZChyID0+IHIucmV0KSB8fCB7CgkJCXJldDogbnVsbAoJCX0pLnJldDsgLy8gZmlyc3Qgb25lIHRvIGV4ZWN1dGUgY29ycmVjdGx5Cgl9CgoJYXN5bmMgZmluZEFsbChkZXB0aCA9IDEsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgewoJCWxldCByZXN1bHRzID0gYXdhaXQgdGhpcy5fZXhlY3V0ZShzYWxlc25vdywgImZpbmRBbGwiLCBhc3luYyAobG9nLCB3YXJuLCBlcnJvciwgb1Njb3BlLCBtZXRob2QgPSAiZmluZEFsbCIsIF9ub2RlLCBkZXB0aCwgb2Jqcywgc3RhcnQsIGVuZCwgZmllbGRzKSA9PiB7CgkJCXJldHVybiBvU2NvcGUuX25vZGUuX3NhbWVOb2RlKF9ub2RlKQoJCX0sIGFzeW5jIChsb2csIHdhcm4sIGVycm9yLCBvU2NvcGUsIG1ldGhvZCA9ICJmaW5kQWxsIiwgZGVwdGgsIG9ianMsIHN0YXJ0LCBlbmQsIGZpZWxkcykgPT4gewoJCQkvKioqIFNUQVJUIExPQ0FMIGZpbmRBbGwoKSAqKiovCgkJCXRoaXMuX190aW1lKCdzYWxlc25vdy5NYXBwaW5nLmZpbmRBbGwnKTsKCgkJCS8vIGF2b2lkcyBjeWNsaWMgcXVlcmllcwoJCQlvYmpzID0gKG9ianMgfHwgW10pLm1hcChvID0+IG8uX2Nsb25lKCkpOwoKCQkJYXdhaXQgdGhpcy5fc3RvcmVFbnRpdHlDbGFzcygpOyAvLz8/CgoJCQlsZXQgcmV0ID0gW107IC8vIGEganNvbiBhcnJheQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNxbERCIikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3NxbCh0aGlzLl90b1NlbGVjdFNRTChmaWVsZHMsIG9ianMpKTsKCgkJCX0KCgkJCWlmICh0aGlzLlRvb2wudHlwZS5uYW1lID09ICJTZXJ2aWNlTm93IikgewoKCQkJCXJldCA9IGF3YWl0IHRoaXMuX3Jlc3QobnVsbCwgewoJCQkJCXN5c3Bhcm1fcXVlcnk6IE9iamVjdC5lbnRyaWVzKHRoaXMuX3RvU05RdWVyeShmaWVsZHMsIG9ianMpKS5tYXAocCA9PiBgJHtwWzBdfSR7cFsxXX1gKS5qb2luKCJeIikKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIlNhbGVzRm9yY2UiKSB7CgoJCQkJcmV0ID0gYXdhaXQgdGhpcy5fcmVzdChudWxsLCBudWxsLCB0aGlzLl90b1NGUXVlcnkoZmllbGRzLCBvYmpzLCB0cnVlKSwgbnVsbCwgewoJCQkJCXVybDogJ3Jlc3QudXJsLmdxbCcKCQkJCX0pOwoKCQkJfQoKCQkJaWYgKHRoaXMuVG9vbC50eXBlLm5hbWUgPT0gIkdpdEh1YiIpIHsKCgkJCQlyZXQgPSBhd2FpdCB0aGlzLl9naXRodWIoYHNhbGVzbm93LyR7dGhpcy5fbkNvZGUoKX0vJHt0aGlzLklkfS5qc2ApOwoJCQkJcmV0ID0gcmV0LmNvbnRlbnQgPyBbSlNPTi5wYXJzZSh0aGlzLl9hdG9iKHJldC5jb250ZW50KSldIDogW107CgoJCQl9CgoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJCZWZvcmUgX2Zyb21Eb2N1bWVudCgpIiwgcmV0KTsKCgkJCXJldCA9IHJldC5tYXAociA9PiBuZXcgc2FsZXNub3cuTWFwcGluZyhudWxsLCB0aGlzLlRvb2wpLl9mcm9tRG9jdW1lbnQociwgdHJ1ZSwgdHJ1ZSkuX19zeW5jX29uKG5ldyBEYXRlKCkpKTsKCgkJCWF3YWl0IHRoaXMuX2ZpbmRSZWZlcmVuY2VzKHJldCwgb2JqcywgZGVwdGgpOwoJCQl0aGlzLmxvZyh1bmRlZmluZWQsICdmaW5kQWxsJywgJ0VudGl0eU9iamVjdCcsIDAsICJPdXRwdXQiLCByZXQpOwoKCQkJZGVsZXRlIHNhbGVzbm93Ll91blJlY3Vyc2U7CgoJCQlyZXR1cm4gcmV0OwoJCQkvKioqIEVORCBMT0NBTCBmaW5kQWxsKCkgKioqLwoJCX0sIHsKCQkJZGVwdGgsCgkJCW9ianMsCgkJCXN0YXJ0LAoJCQllbmQsCgkJCWZpZWxkcywKCQkJX19iZWZvcmVSdWxlczogW10sCgkJCV9fYWZ0ZXJSdWxlczogW10KCQl9KTsKCgkJcmV0dXJuIChyZXN1bHRzLmZpbmQociA9PiByLnJldCkgfHwgewoJCQlyZXQ6IFtdCgkJfSkucmV0IHx8IFtdOyAvLyBmaXJzdCBvbmUgdG8gZXhlY3V0ZSBjb3JyZWN0bHkKCX0KCglhc3luYyBfZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCkgewoKCQlyZXR1cm4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fZmluZFJlZmVyZW5jZXMocmV0LCBvYmpzLCBkZXB0aCk7CgoJfQoKfTsKCgppZih0eXBlb2YobW9kdWxlKSE9PSJ1bmRlZmluZWQiKSBtb2R1bGUuZXhwb3J0cy5zYWxlc25vdyA9IHNhbGVzbm93OwoKLy9pZih0eXBlb2Yod2luZG93KSE9PSd1bmRlZmluZWQnICYmIHR5cGVvZih3aW5kb3cuX0ZyRU1EKT09PSd1bmRlZmluZWQnKQooYXN5bmMgKCkgPT4gYXdhaXQgbmV3IHNhbGVzbm93LlVzZXIoKS5fc2VydmVyKHtpbml0Tm9kZTogdHJ1ZSwgaW5pdFNlbGY6IHRydWUsIGxvYWRUb29sczogdHJ1ZX0pKSgpOw=="></script></head><body><ul id="LogHTML">HTML Node Testing...</div></body></html>
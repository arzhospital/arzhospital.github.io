{
	"Id": "31cb61381a6fca5f8fd10e9512328eb15180b1c8",
	"active": "true",
	"enabled": "true",
	"code": "micropython",
	"date": "2024-10-19T06:06:16.752Z",
	"name": "MicroPython",
	"remark": "I0FQSSBTZXJ2ZXIgU3R1YiBmb3IgKE1pY3JvKVB5dGhvbgojVkVSU0lPTjogMjAyNC0xMC0xOVQwNjowNjoxNS45NTRaCiNTWVNURU06IGFwaXNlcnZlci9lc3B0ZXN0CgoKCiNMaW51eCBDb21tYW5kIExJbmU6CiMgd2dldCAtcU8tICJodHRwczovL2Fyemhvc3BpdGFsLmdpdGh1Yi5pby9lc3B0ZXN0L05vZGVfVHlwZS9NaWNyb1B5dGhvbi5qc29uIiB8IGpxIC1yICcucmVtYXJrIHwgQGJhc2U2NGQnIHwgLi9taWNyb3B5dGhvbgoKCiNpbXBvcnQgdXJsbGliMywganNvbiwgYmFzZTY0OwojZXhlYyhiYXNlNjQuYjY0ZGVjb2RlKGpzb24ubG9hZHModXJsbGliMy5Qb29sTWFuYWdlcigpLnJlcXVlc3QoJ0dFVCcsICJodHRwczovL2Fyemhvc3BpdGFsLmdpdGh1Yi5pby9lc3B0ZXN0L05vZGVfVHlwZS9NaWNyb1B5dGhvbi5qc29uIikuZGF0YS5kZWNvZGUoJ3V0Zi04JykpWyJyZW1hcmsiXSkpOwoKI2ltcG9ydCByZXF1ZXN0cywgdWJpbmFzY2lpLCB1anNvbjsKI2V4ZWModWJpbmFzY2lpLmEyYl9iYXNlNjQodWpzb24ubG9hZHMocmVxdWVzdHMuZ2V0KCJodHRwczovL2Fyemhvc3BpdGFsLmdpdGh1Yi5pby9lc3B0ZXN0L05vZGVfVHlwZS9NaWNyb1B5dGhvbi5qc29uIikudGV4dClbInJlbWFyayJdKSk7CgppbXBvcnQgdW1xdHQuc2ltcGxlLG5ldHdvcmssdWJpbmFzY2lpLHVqc29uLG1hY2hpbmUsZGVmbGF0ZSx0aW1lLGdjLGlvLHJlLG9zLHN5czsKCgpjbGFzcyBVc2VyKCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgSWQ9Tm9uZSwgYWN0aXZlPU5vbmUsIGVuYWJsZWQ9Tm9uZSwgY29kZT1Ob25lLCBvcmRlcj1Ob25lLCBkYXRlPU5vbmUsIG5hbWU9Tm9uZSwgcmVtYXJrPU5vbmUsIHVzZXJuYW1lPU5vbmUsIHBhc3N3b3JkPU5vbmUpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKTsKCiAgICAgICAgI3ByaW50KCdVc2VyOjpfX2luaXRfXygpJyk7CiAgICAgICAgaWYgSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHNlbGYuSWQgPSBJZDsKCiAgICAgICAgCiAgICAgICAgc2VsZi5hY3RpdmUoYWN0aXZlKTsKICAgICAgICBzZWxmLmVuYWJsZWQoZW5hYmxlZCk7CiAgICAgICAgc2VsZi5jb2RlKGNvZGUpOwogICAgICAgIHNlbGYub3JkZXIob3JkZXIpOwogICAgICAgIHNlbGYuZGF0ZShkYXRlKTsKICAgICAgICBzZWxmLm5hbWUobmFtZSk7CiAgICAgICAgc2VsZi5yZW1hcmsocmVtYXJrKTsKICAgICAgICBzZWxmLnVzZXJuYW1lKHVzZXJuYW1lKTsKICAgICAgICBzZWxmLnBhc3N3b3JkKHBhc3N3b3JkKTsKICAgICAgICAKICAgIElkID0gTm9uZTsKICAgIAogICAgCiAgICAjIGFjdGl2ZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2FjdGl2ZSA9IE5vbmU7CiAgICBkZWYgYWN0aXZlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9hY3RpdmUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9hY3RpdmU7CiAgICAKICAgICMgZW5hYmxlZDogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2VuYWJsZWQgPSBOb25lOwogICAgZGVmIGVuYWJsZWQoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2VuYWJsZWQgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9lbmFibGVkOwogICAgCiAgICAjIGNvZGU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9jb2RlID0gTm9uZTsKICAgIGRlZiBjb2RlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9jb2RlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fY29kZTsKICAgIAogICAgIyBvcmRlcjogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX29yZGVyID0gTm9uZTsKICAgIGRlZiBvcmRlcihzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fb3JkZXIgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9vcmRlcjsKICAgIAogICAgIyBkYXRlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfZGF0ZSA9IE5vbmU7CiAgICBkZWYgZGF0ZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fZGF0ZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgaWYgc2VsZi5fZGF0ZT09J3t7bm93fX0nOgogICAgICAgICAgICAgICAgc2VsZi5fZGF0ZSA9IHRpbWUudGlja3NfbXMoKTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZGF0ZTsKICAgIAogICAgIyBuYW1lOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfbmFtZSA9IE5vbmU7CiAgICBkZWYgbmFtZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fbmFtZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX25hbWU7CiAgICAKICAgICMgcmVtYXJrOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfcmVtYXJrID0gTm9uZTsKICAgIGRlZiByZW1hcmsoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX3JlbWFyayA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3JlbWFyazsKICAgIAogICAgIyB1c2VybmFtZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3VzZXJuYW1lID0gTm9uZTsKICAgIGRlZiB1c2VybmFtZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fdXNlcm5hbWUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl91c2VybmFtZTsKICAgIAogICAgIyBwYXNzd29yZDogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3Bhc3N3b3JkID0gTm9uZTsKICAgIGRlZiBwYXNzd29yZChzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fcGFzc3dvcmQgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9wYXNzd29yZDsKICAgIAogICAgCiAgICAKICAgIAogICAgZGVmIF91bmlxdWUoc2VsZik6CiAgICAgICAgX190b1N0cmluZyA9ICdVc2VyOjpfdW5pcXVlKCk6ICc7CiAgICAgICAgCiAgICAgICAgcmV0ID0gVXNlcigpOwogICAgICAgIGlmIHNlbGYuSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldC5JZCA9IHNlbGYuSWQ7CiAgICAKICAgICAgICBpZiBzZWxmLmNvZGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0LmNvZGUoc2VsZi5jb2RlKCkpOwogICAgCiAgICAgICAgaWYgc2VsZi51c2VybmFtZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXQudXNlcm5hbWUoc2VsZi51c2VybmFtZSgpKTsKICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gcmV0OwogICAgCiAgICBkZWYgX2Zyb21Eb2N1bWVudChzZWxmLCBvYmopOgogICAgICAgIF9fdG9TdHJpbmcgPSAnVXNlcjo6X2Zyb21Eb2N1bWVudCgpOiAnOwogICAgICAgIAogICAgICAgIGlmIG9iaiBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gc2VsZjsKCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIGJ5dGVzKToKICAgICAgICAgICAgb2JqID0gc3RyKG9iaiwgInV0Zi04Iik7CgogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBzdHIpIG9yIHR5cGUob2JqKSBpcyBzdHI6CiAgICAgICAgICAgIGlmIHJlLm1hdGNoKHIiKCgoW0EtWmEtel17Myw5fTooPzpcL1wvKT8pKD86Wy07OiY9XCtcJCxcd10rQCk/W0EtWmEtejAtOS4tXSt8KD86d3d3LnxbLTs6Jj1cK1wkLFx3XStAKVtBLVphLXowLTkuLV0rKSgoPzpcL1tcK34lXC8uXHdcLV9dKik/XD8/KD86Wy1cKz0mOyVALlx3X10qKSM/KD86W1x3XSopKT8pIiwgb2JqKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBvYmogPSB1anNvbi5sb2Fkcyh1cmxsaWIzLlBvb2xNYW5hZ2VyKCkucmVxdWVzdCgnR0VUJywgb2JqKS5kYXRhLmRlY29kZSgndXRmLTgnKSk7CiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgb2JqID0ge307CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBvYmogPSB1anNvbi5sb2FkcyhvYmopOwogICAgICAgIAogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBsaXN0KToKICAgICAgICAgICAgcmV0dXJuIFtVc2VyKCkuX2Zyb21Eb2N1bWVudChvKSBmb3IgbyBpbiBvYmpdOwogICAgICAgICAgICAKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShvYmosIChzdHIsIGJ5dGVzLCBkaWN0KSk6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAndW5oYW5kbGVkIHR5cGU6ICcgKyBzdHIodHlwZShvYmopKSk7CiAgICAgICAgICAgIHJldHVybiBvYmo7CgogICAgICAgIGlmICdJZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLklkID0gb2JqWydJZCddOwoKICAgIAogICAgICAgIGlmICdhY3RpdmUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5hY3RpdmUob2JqWydhY3RpdmUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZW5hYmxlZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmVuYWJsZWQob2JqWydlbmFibGVkJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2NvZGUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5jb2RlKG9ialsnY29kZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdvcmRlcicgaW4gb2JqOgogICAgICAgICAgICBzZWxmLm9yZGVyKG9ialsnb3JkZXInXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZGF0ZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmRhdGUob2JqWydkYXRlJ10pOwogICAgICAgIAogICAgICAgICAgICBzZWxmLmRhdGUoZGF0ZXRpbWUuZGF0ZXRpbWUuZnJvbWlzb2Zvcm1hdChzZWxmLmRhdGUoKSkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ25hbWUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5uYW1lKG9ialsnbmFtZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdyZW1hcmsnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5yZW1hcmsob2JqWydyZW1hcmsnXSk7CiAgICAgICAgCiAgICAgICAgICAgIHNlbGYucmVtYXJrKCB1YmluYXNjaWkuYTJiX2Jhc2U2NChzZWxmLnJlbWFyaygpKSApOwogICAgICAgICAgICBpZiBzZWxmLnJlbWFyaygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVtYXJrKHNlbGYucmVtYXJrKCkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCkpOwogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVtYXJrKCk7CiAgICAgICAgICAgICAgICAgICAgI3ByaW50KF9fdG9TdHJpbmcgKyAicmVtYXJrIGV4Y2VwdGlvbiIsIHNlbGYucmVtYXJrKCkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ3VzZXJuYW1lJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYudXNlcm5hbWUob2JqWyd1c2VybmFtZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdwYXNzd29yZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLnBhc3N3b3JkKG9ialsncGFzc3dvcmQnXSk7CiAgICAgICAgCiAgICAKCiAgICAKCiAgICAgICAgZ2MuY29sbGVjdCgpOwogICAgICAgIHJldHVybiBzZWxmOwogICAgCiAgICBkZWYgX3RvRG9jdW1lbnQoc2VsZiwgYkpTT049Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdVc2VyOjpfdG9Eb2N1bWVudCgpOiAnOwoKICAgICAgICByZXQgPSB7fTsKICAgICAgICBpZiBzZWxmLklkIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIklkIl0gPSBzZWxmLklkOwoKICAgIAogICAgICAgIGlmIHNlbGYuYWN0aXZlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiYWN0aXZlIl0gPSBzZWxmLmFjdGl2ZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5lbmFibGVkKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZW5hYmxlZCJdID0gc2VsZi5lbmFibGVkKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmNvZGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJjb2RlIl0gPSBzZWxmLmNvZGUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYub3JkZXIoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJvcmRlciJdID0gc2VsZi5vcmRlcigpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5kYXRlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZGF0ZSJdID0gc2VsZi5kYXRlKCk7CiAgICAgICAgCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmV0WyJkYXRlIl0sIGRhdGV0aW1lLmRhdGV0aW1lKToKICAgICAgICAgICAgICAgIHJldFsiZGF0ZSJdID0gcmV0WyJkYXRlIl0uaXNvZm9ybWF0KCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLm5hbWUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJuYW1lIl0gPSBzZWxmLm5hbWUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYucmVtYXJrKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsicmVtYXJrIl0gPSBzZWxmLnJlbWFyaygpOwogICAgICAgIAogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHJldFsicmVtYXJrIl0sIGRpY3QpOgogICAgICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9IHVqc29uLmR1bXBzKHJldFsicmVtYXJrIl0pLmVuY29kZSgndXRmLTgnKTsKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJldFsicmVtYXJrIl0gPSAgdWJpbmFzY2lpLmIyYV9iYXNlNjQocmV0WyJyZW1hcmsiXSkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCk7CiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhjZXB0aW9uIHdpdGggcmVtYXJrOiAiICsgcmV0WyJyZW1hcmsiXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLnVzZXJuYW1lKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsidXNlcm5hbWUiXSA9IHNlbGYudXNlcm5hbWUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYucGFzc3dvcmQoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJwYXNzd29yZCJdID0gc2VsZi5wYXNzd29yZCgpOwogICAgICAgIAogICAgCiAgICAgICAgCiAgICAKCiAgICAgICAgaWYgYkpTT04gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICNwcmludChfX3RvU3RyaW5nICsgIkdPVCBIRVJFIiwgdHlwZShyZXQpLCByZXQpOwogICAgICAgICAgICByZXQgPSB1anNvbi5kdW1wcyhyZXQpOwogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gcmV0OwoKICAgIAogICAgZGVmIHN0b3JlKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdVc2VyOjpzdG9yZSgpOiAnOwogICAgICAgIAogICAgICAgIGFuc3dlciA9IE5vbmU7CgogICAgICAgIF9fcmVzcG9uc2UgPSBFdmVudCgpLmNvZGUoJ1snK25vZGUuY29kZSgpKydAJytzdHIodGltZS50aWNrc19tcygpKSsnXS5Vc2VyLnN0b3JlKCknKS5tZXRob2QoJ3N0b3JlJykuY2xhc3NOYW1lKCdVc2VyJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gVXNlcigpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiBmaW5kQWxsKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdVc2VyOjpmaW5kQWxsKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLlVzZXIuZmluZEFsbCgpJykubWV0aG9kKCdmaW5kQWxsJykuY2xhc3NOYW1lKCdVc2VyJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gVXNlcigpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiBmaW5kKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdVc2VyOjpmaW5kKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLlVzZXIuZmluZCgpJykubWV0aG9kKCdmaW5kJykuY2xhc3NOYW1lKCdVc2VyJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gVXNlcigpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiBpbml0KHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdVc2VyOjppbml0KCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLlVzZXIuaW5pdCgpJykubWV0aG9kKCdpbml0JykuY2xhc3NOYW1lKCdVc2VyJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gZXZKU09OOwogICAgICAgIAoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4ZWN1dGluZyBsb2NhbGx5Iik7CgoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmUgb3IgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgaWYgYW5zd2VyIGlzIG5vdCBOb25lOgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZChzdHIoYW5zd2VyKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKHsiX190aGlzIjogc2VsZi5fdG9Eb2N1bWVudCgpfSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS50cmlnZ2VyKCk7CiAgICAgICAgICAgIAoKICAgICAgICByZXR1cm4gYW5zd2VyOwoKICAgIAoKCmNsYXNzIE1ldHJpYygpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIElkPU5vbmUsIGFjdGl2ZT1Ob25lLCBlbmFibGVkPU5vbmUsIGNvZGU9Tm9uZSwgb3JkZXI9Tm9uZSwgZGF0ZT1Ob25lLCBuYW1lPU5vbmUsIHJlbWFyaz1Ob25lLCBzY3JpcHQ9Tm9uZSwgdHlwZT1Ob25lLCBkZXZpY2VUeXBlPU5vbmUpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKTsKCiAgICAgICAgI3ByaW50KCdNZXRyaWM6Ol9faW5pdF9fKCknKTsKICAgICAgICBpZiBJZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgc2VsZi5JZCA9IElkOwoKICAgICAgICAKICAgICAgICBzZWxmLmFjdGl2ZShhY3RpdmUpOwogICAgICAgIHNlbGYuZW5hYmxlZChlbmFibGVkKTsKICAgICAgICBzZWxmLmNvZGUoY29kZSk7CiAgICAgICAgc2VsZi5vcmRlcihvcmRlcik7CiAgICAgICAgc2VsZi5kYXRlKGRhdGUpOwogICAgICAgIHNlbGYubmFtZShuYW1lKTsKICAgICAgICBzZWxmLnJlbWFyayhyZW1hcmspOwogICAgICAgIHNlbGYuc2NyaXB0KHNjcmlwdCk7CiAgICAgICAgc2VsZi50eXBlKHR5cGUpOwogICAgICAgIHNlbGYuZGV2aWNlVHlwZShkZXZpY2VUeXBlKTsKICAgICAgICAKICAgIElkID0gTm9uZTsKICAgIAogICAgCiAgICAjIGFjdGl2ZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2FjdGl2ZSA9IE5vbmU7CiAgICBkZWYgYWN0aXZlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9hY3RpdmUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9hY3RpdmU7CiAgICAKICAgICMgZW5hYmxlZDogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2VuYWJsZWQgPSBOb25lOwogICAgZGVmIGVuYWJsZWQoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2VuYWJsZWQgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9lbmFibGVkOwogICAgCiAgICAjIGNvZGU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9jb2RlID0gTm9uZTsKICAgIGRlZiBjb2RlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9jb2RlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fY29kZTsKICAgIAogICAgIyBvcmRlcjogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX29yZGVyID0gTm9uZTsKICAgIGRlZiBvcmRlcihzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fb3JkZXIgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9vcmRlcjsKICAgIAogICAgIyBkYXRlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfZGF0ZSA9IE5vbmU7CiAgICBkZWYgZGF0ZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fZGF0ZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgaWYgc2VsZi5fZGF0ZT09J3t7bm93fX0nOgogICAgICAgICAgICAgICAgc2VsZi5fZGF0ZSA9IHRpbWUudGlja3NfbXMoKTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZGF0ZTsKICAgIAogICAgIyBuYW1lOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfbmFtZSA9IE5vbmU7CiAgICBkZWYgbmFtZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fbmFtZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX25hbWU7CiAgICAKICAgICMgcmVtYXJrOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfcmVtYXJrID0gTm9uZTsKICAgIGRlZiByZW1hcmsoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX3JlbWFyayA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3JlbWFyazsKICAgIAogICAgIyBzY3JpcHQ6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9zY3JpcHQgPSBOb25lOwogICAgZGVmIHNjcmlwdChzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fc2NyaXB0ID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fc2NyaXB0OwogICAgCiAgICAjIHR5cGU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF90eXBlID0gTm9uZTsKICAgIGRlZiB0eXBlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl90eXBlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fdHlwZTsKICAgIAogICAgIyBkZXZpY2VUeXBlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfZGV2aWNlVHlwZSA9IE5vbmU7CiAgICBkZWYgZGV2aWNlVHlwZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fZGV2aWNlVHlwZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2RldmljZVR5cGU7CiAgICAKICAgIAogICAgCiAgICAjIG1ldHJpY19NZXRyaWNfVmFsdWVzOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfbWV0cmljX01ldHJpY19WYWx1ZXMgPSBOb25lOwogICAgZGVmIG1ldHJpY19NZXRyaWNfVmFsdWVzKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9tZXRyaWNfTWV0cmljX1ZhbHVlcyA9IGFyZ3NbMF07CiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9tZXRyaWNfTWV0cmljX1ZhbHVlczsKICAgIAogICAgCiAgICBkZWYgX3VuaXF1ZShzZWxmKToKICAgICAgICBfX3RvU3RyaW5nID0gJ01ldHJpYzo6X3VuaXF1ZSgpOiAnOwogICAgICAgIAogICAgICAgIHJldCA9IE1ldHJpYygpOwogICAgICAgIGlmIHNlbGYuSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldC5JZCA9IHNlbGYuSWQ7CiAgICAKICAgICAgICBpZiBzZWxmLmNvZGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0LmNvZGUoc2VsZi5jb2RlKCkpOwogICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwogICAgICAgIHJldHVybiByZXQ7CiAgICAKICAgIGRlZiBfZnJvbURvY3VtZW50KHNlbGYsIG9iaik6CiAgICAgICAgX190b1N0cmluZyA9ICdNZXRyaWM6Ol9mcm9tRG9jdW1lbnQoKTogJzsKICAgICAgICAKICAgICAgICBpZiBvYmogaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CgogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBieXRlcyk6CiAgICAgICAgICAgIG9iaiA9IHN0cihvYmosICJ1dGYtOCIpOwoKICAgICAgICBpZiBpc2luc3RhbmNlKG9iaiwgc3RyKSBvciB0eXBlKG9iaikgaXMgc3RyOgogICAgICAgICAgICBpZiByZS5tYXRjaChyIigoKFtBLVphLXpdezMsOX06KD86XC9cLyk/KSg/OlstOzomPVwrXCQsXHddK0ApP1tBLVphLXowLTkuLV0rfCg/Ond3dy58Wy07OiY9XCtcJCxcd10rQClbQS1aYS16MC05Li1dKykoKD86XC9bXCt+JVwvLlx3XC1fXSopP1w/Pyg/OlstXCs9JjslQC5cd19dKikjPyg/Oltcd10qKSk/KSIsIG9iaik6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgb2JqID0gdWpzb24ubG9hZHModXJsbGliMy5Qb29sTWFuYWdlcigpLnJlcXVlc3QoJ0dFVCcsIG9iaikuZGF0YS5kZWNvZGUoJ3V0Zi04JykpOwogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIG9iaiA9IHt9OwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgb2JqID0gdWpzb24ubG9hZHMob2JqKTsKICAgICAgICAKICAgICAgICBpZiBpc2luc3RhbmNlKG9iaiwgbGlzdCk6CiAgICAgICAgICAgIHJldHVybiBbTWV0cmljKCkuX2Zyb21Eb2N1bWVudChvKSBmb3IgbyBpbiBvYmpdOwogICAgICAgICAgICAKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShvYmosIChzdHIsIGJ5dGVzLCBkaWN0KSk6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAndW5oYW5kbGVkIHR5cGU6ICcgKyBzdHIodHlwZShvYmopKSk7CiAgICAgICAgICAgIHJldHVybiBvYmo7CgogICAgICAgIGlmICdJZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLklkID0gb2JqWydJZCddOwoKICAgIAogICAgICAgIGlmICdhY3RpdmUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5hY3RpdmUob2JqWydhY3RpdmUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZW5hYmxlZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmVuYWJsZWQob2JqWydlbmFibGVkJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2NvZGUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5jb2RlKG9ialsnY29kZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdvcmRlcicgaW4gb2JqOgogICAgICAgICAgICBzZWxmLm9yZGVyKG9ialsnb3JkZXInXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZGF0ZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmRhdGUob2JqWydkYXRlJ10pOwogICAgICAgIAogICAgICAgICAgICBzZWxmLmRhdGUoZGF0ZXRpbWUuZGF0ZXRpbWUuZnJvbWlzb2Zvcm1hdChzZWxmLmRhdGUoKSkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ25hbWUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5uYW1lKG9ialsnbmFtZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdyZW1hcmsnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5yZW1hcmsob2JqWydyZW1hcmsnXSk7CiAgICAgICAgCiAgICAgICAgICAgIHNlbGYucmVtYXJrKCB1YmluYXNjaWkuYTJiX2Jhc2U2NChzZWxmLnJlbWFyaygpKSApOwogICAgICAgICAgICBpZiBzZWxmLnJlbWFyaygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVtYXJrKHNlbGYucmVtYXJrKCkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCkpOwogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVtYXJrKCk7CiAgICAgICAgICAgICAgICAgICAgI3ByaW50KF9fdG9TdHJpbmcgKyAicmVtYXJrIGV4Y2VwdGlvbiIsIHNlbGYucmVtYXJrKCkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ3NjcmlwdCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLnNjcmlwdChvYmpbJ3NjcmlwdCddKTsKICAgICAgICAKICAgICAgICAgICAgc2VsZi5zY3JpcHQoIHViaW5hc2NpaS5hMmJfYmFzZTY0KHNlbGYuc2NyaXB0KCkpICk7CiAgICAgICAgICAgIGlmIHNlbGYuc2NyaXB0KCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zY3JpcHQoc2VsZi5zY3JpcHQoKS5kZWNvZGUoJ3V0Zi04Jykuc3RyaXAoKSk7CiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zY3JpcHQoKTsKICAgICAgICAgICAgICAgICAgICAjcHJpbnQoX190b1N0cmluZyArICJzY3JpcHQgZXhjZXB0aW9uIiwgc2VsZi5zY3JpcHQoKSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAndHlwZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLnR5cGUoTWV0cmljX1R5cGUoKS5fZnJvbURvY3VtZW50KG9ialsndHlwZSddKSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZGV2aWNlVHlwZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmRldmljZVR5cGUoRGV2aWNlX1R5cGUoKS5fZnJvbURvY3VtZW50KG9ialsnZGV2aWNlVHlwZSddKSk7CiAgICAgICAgCiAgICAKCiAgICAKICAgICAgICBpZiAnbWV0cmljX01ldHJpY19WYWx1ZXMnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5tZXRyaWNfTWV0cmljX1ZhbHVlcyhNZXRyaWNfVmFsdWUoKS5fZnJvbURvY3VtZW50KG9ialsnbWV0cmljX01ldHJpY19WYWx1ZXMnXSkpOwogICAgCgogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gc2VsZjsKICAgIAogICAgZGVmIF90b0RvY3VtZW50KHNlbGYsIGJKU09OPU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnTWV0cmljOjpfdG9Eb2N1bWVudCgpOiAnOwoKICAgICAgICByZXQgPSB7fTsKICAgICAgICBpZiBzZWxmLklkIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIklkIl0gPSBzZWxmLklkOwoKICAgIAogICAgICAgIGlmIHNlbGYuYWN0aXZlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiYWN0aXZlIl0gPSBzZWxmLmFjdGl2ZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5lbmFibGVkKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZW5hYmxlZCJdID0gc2VsZi5lbmFibGVkKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmNvZGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJjb2RlIl0gPSBzZWxmLmNvZGUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYub3JkZXIoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJvcmRlciJdID0gc2VsZi5vcmRlcigpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5kYXRlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZGF0ZSJdID0gc2VsZi5kYXRlKCk7CiAgICAgICAgCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmV0WyJkYXRlIl0sIGRhdGV0aW1lLmRhdGV0aW1lKToKICAgICAgICAgICAgICAgIHJldFsiZGF0ZSJdID0gcmV0WyJkYXRlIl0uaXNvZm9ybWF0KCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLm5hbWUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJuYW1lIl0gPSBzZWxmLm5hbWUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYucmVtYXJrKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsicmVtYXJrIl0gPSBzZWxmLnJlbWFyaygpOwogICAgICAgIAogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHJldFsicmVtYXJrIl0sIGRpY3QpOgogICAgICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9IHVqc29uLmR1bXBzKHJldFsicmVtYXJrIl0pLmVuY29kZSgndXRmLTgnKTsKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJldFsicmVtYXJrIl0gPSAgdWJpbmFzY2lpLmIyYV9iYXNlNjQocmV0WyJyZW1hcmsiXSkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCk7CiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhjZXB0aW9uIHdpdGggcmVtYXJrOiAiICsgcmV0WyJyZW1hcmsiXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLnNjcmlwdCgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbInNjcmlwdCJdID0gc2VsZi5zY3JpcHQoKTsKICAgICAgICAKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXRbInNjcmlwdCJdLCBkaWN0KToKICAgICAgICAgICAgICAgIHJldFsic2NyaXB0Il0gPSB1anNvbi5kdW1wcyhyZXRbInNjcmlwdCJdKS5lbmNvZGUoJ3V0Zi04Jyk7CgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXRbInNjcmlwdCJdID0gIHViaW5hc2NpaS5iMmFfYmFzZTY0KHJldFsic2NyaXB0Il0pLmRlY29kZSgndXRmLTgnKS5zdHJpcCgpOwogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4Y2VwdGlvbiB3aXRoIHNjcmlwdDogIiArIHJldFsic2NyaXB0Il0pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi50eXBlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsidHlwZSJdID0gc2VsZi50eXBlKCkuX3RvRG9jdW1lbnQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuZGV2aWNlVHlwZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImRldmljZVR5cGUiXSA9IHNlbGYuZGV2aWNlVHlwZSgpLl90b0RvY3VtZW50KCk7CiAgICAgICAgCiAgICAKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYubWV0cmljX01ldHJpY19WYWx1ZXMoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJtZXRyaWNfTWV0cmljX1ZhbHVlcyJdID0gW3RhLl90b0RvY3VtZW50KCkgZm9yIHRhIGluIHNlbGYubWV0cmljX01ldHJpY19WYWx1ZXMoKV07CiAgICAKCiAgICAgICAgaWYgYkpTT04gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICNwcmludChfX3RvU3RyaW5nICsgIkdPVCBIRVJFIiwgdHlwZShyZXQpLCByZXQpOwogICAgICAgICAgICByZXQgPSB1anNvbi5kdW1wcyhyZXQpOwogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gcmV0OwoKICAgIAogICAgZGVmIHN0b3JlKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdNZXRyaWM6OnN0b3JlKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLk1ldHJpYy5zdG9yZSgpJykubWV0aG9kKCdzdG9yZScpLmNsYXNzTmFtZSgnTWV0cmljJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gTWV0cmljKCkuX2Zyb21Eb2N1bWVudChldkpTT04pOwogICAgICAgIAoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4ZWN1dGluZyBsb2NhbGx5Iik7CgoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmUgb3IgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgaWYgYW5zd2VyIGlzIG5vdCBOb25lOgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZChhbnN3ZXIuX3RvRG9jdW1lbnQoKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKHsiX190aGlzIjogc2VsZi5fdG9Eb2N1bWVudCgpfSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS50cmlnZ2VyKCk7CiAgICAgICAgICAgIAoKICAgICAgICByZXR1cm4gYW5zd2VyOwoKICAgIAogICAgZGVmIGZpbmRBbGwoc2VsZiwgX19ldmVudD1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ01ldHJpYzo6ZmluZEFsbCgpOiAnOwogICAgICAgIAogICAgICAgIGFuc3dlciA9IE5vbmU7CgogICAgICAgIF9fcmVzcG9uc2UgPSBFdmVudCgpLmNvZGUoJ1snK25vZGUuY29kZSgpKydAJytzdHIodGltZS50aWNrc19tcygpKSsnXS5NZXRyaWMuZmluZEFsbCgpJykubWV0aG9kKCdmaW5kQWxsJykuY2xhc3NOYW1lKCdNZXRyaWMnKS5jYXJyaWVyKG5vZGUpLnNlbmRlcihub2RlKS5yZWNpcGllbnQobm9kZS5wYXJlbnQoKSk7CgogICAgICAgIGV2SlNPTiA9IE5vbmU7CiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgZXZKU09OID0gdWpzb24ubG9hZHMoX19ldmVudC5wYXlsb2FkKCkpOwogICAgICAgICAgICBpZiAnX190aGlzJyBpbiBldkpTT046CiAgICAgICAgICAgICAgICBzZWxmLl9mcm9tRG9jdW1lbnQoZXZKU09OWydfX3RoaXMnXSk7CiAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UucmVzcG9uc2VUbyhfX2V2ZW50Ll91bmlxdWUoKSk7CiAgICAgICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgIiBoYW5kbGluZyBldmVudFsiK19fZXZlbnQuY29kZSgpKyJdIik7CgogICAgICAgIAogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImEgcmVzcG9uc2UgdG8gbXkgZXZlbnQoIitfX2V2ZW50LnJlc3BvbnNlVG8oKS5jb2RlKCkrIikgWyIgKyBfX2V2ZW50LmNsYXNzTmFtZSgpICsgIigpLiIgKyBfX2V2ZW50Lm1ldGhvZCgpICsgIigpXSIpOwogICAgICAgIAogICAgICAgICAgICBhbnN3ZXIgPSBNZXRyaWMoKS5fZnJvbURvY3VtZW50KGV2SlNPTik7CiAgICAgICAgCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhlY3V0aW5nIGxvY2FsbHkiKTsKCgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZSBvciBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBpZiBhbnN3ZXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKGFuc3dlci5fdG9Eb2N1bWVudCgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoeyJfX3RoaXMiOiBzZWxmLl90b0RvY3VtZW50KCl9KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnRyaWdnZXIoKTsKICAgICAgICAgICAgCgogICAgICAgIHJldHVybiBhbnN3ZXI7CgogICAgCiAgICBkZWYgZmluZChzZWxmLCBfX2V2ZW50PU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnTWV0cmljOjpmaW5kKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLk1ldHJpYy5maW5kKCknKS5tZXRob2QoJ2ZpbmQnKS5jbGFzc05hbWUoJ01ldHJpYycpLmNhcnJpZXIobm9kZSkuc2VuZGVyKG5vZGUpLnJlY2lwaWVudChub2RlLnBhcmVudCgpKTsKCiAgICAgICAgZXZKU09OID0gTm9uZTsKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBldkpTT04gPSB1anNvbi5sb2FkcyhfX2V2ZW50LnBheWxvYWQoKSk7CiAgICAgICAgICAgIGlmICdfX3RoaXMnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIHNlbGYuX2Zyb21Eb2N1bWVudChldkpTT05bJ19fdGhpcyddKTsKICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS5yZXNwb25zZVRvKF9fZXZlbnQuX3VuaXF1ZSgpKTsKICAgICAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiIGhhbmRsaW5nIGV2ZW50WyIrX19ldmVudC5jb2RlKCkrIl0iKTsKCiAgICAgICAgCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiYSByZXNwb25zZSB0byBteSBldmVudCgiK19fZXZlbnQucmVzcG9uc2VUbygpLmNvZGUoKSsiKSBbIiArIF9fZXZlbnQuY2xhc3NOYW1lKCkgKyAiKCkuIiArIF9fZXZlbnQubWV0aG9kKCkgKyAiKCldIik7CiAgICAgICAgCiAgICAgICAgICAgIGFuc3dlciA9IE1ldHJpYygpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKCgpjbGFzcyBNZXRyaWNfVmFsdWUoKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBJZD1Ob25lLCBhY3RpdmU9Tm9uZSwgZW5hYmxlZD1Ob25lLCBjb2RlPU5vbmUsIG9yZGVyPU5vbmUsIGRhdGU9Tm9uZSwgbmFtZT1Ob25lLCByZW1hcms9Tm9uZSwgdmFsdWU9Tm9uZSwgbWVhc3VyZWQ9Tm9uZSwgbWV0cmljPU5vbmUsIGRldmljZT1Ob25lKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCk7CgogICAgICAgICNwcmludCgnTWV0cmljX1ZhbHVlOjpfX2luaXRfXygpJyk7CiAgICAgICAgaWYgSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHNlbGYuSWQgPSBJZDsKCiAgICAgICAgCiAgICAgICAgc2VsZi5hY3RpdmUoYWN0aXZlKTsKICAgICAgICBzZWxmLmVuYWJsZWQoZW5hYmxlZCk7CiAgICAgICAgc2VsZi5jb2RlKGNvZGUpOwogICAgICAgIHNlbGYub3JkZXIob3JkZXIpOwogICAgICAgIHNlbGYuZGF0ZShkYXRlKTsKICAgICAgICBzZWxmLm5hbWUobmFtZSk7CiAgICAgICAgc2VsZi5yZW1hcmsocmVtYXJrKTsKICAgICAgICBzZWxmLnZhbHVlKHZhbHVlKTsKICAgICAgICBzZWxmLm1lYXN1cmVkKG1lYXN1cmVkKTsKICAgICAgICBzZWxmLm1ldHJpYyhtZXRyaWMpOwogICAgICAgIHNlbGYuZGV2aWNlKGRldmljZSk7CiAgICAgICAgCiAgICBJZCA9IE5vbmU7CiAgICAKICAgIAogICAgIyBhY3RpdmU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9hY3RpdmUgPSBOb25lOwogICAgZGVmIGFjdGl2ZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fYWN0aXZlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fYWN0aXZlOwogICAgCiAgICAjIGVuYWJsZWQ6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9lbmFibGVkID0gTm9uZTsKICAgIGRlZiBlbmFibGVkKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9lbmFibGVkID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZW5hYmxlZDsKICAgIAogICAgIyBjb2RlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfY29kZSA9IE5vbmU7CiAgICBkZWYgY29kZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fY29kZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NvZGU7CiAgICAKICAgICMgb3JkZXI6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9vcmRlciA9IE5vbmU7CiAgICBkZWYgb3JkZXIoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX29yZGVyID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fb3JkZXI7CiAgICAKICAgICMgZGF0ZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2RhdGUgPSBOb25lOwogICAgZGVmIGRhdGUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2RhdGUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIGlmIHNlbGYuX2RhdGU9PSd7e25vd319JzoKICAgICAgICAgICAgICAgIHNlbGYuX2RhdGUgPSB0aW1lLnRpY2tzX21zKCk7CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2RhdGU7CiAgICAKICAgICMgbmFtZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX25hbWUgPSBOb25lOwogICAgZGVmIG5hbWUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX25hbWUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9uYW1lOwogICAgCiAgICAjIHJlbWFyazogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3JlbWFyayA9IE5vbmU7CiAgICBkZWYgcmVtYXJrKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9yZW1hcmsgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9yZW1hcms7CiAgICAKICAgICMgdmFsdWU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF92YWx1ZSA9IE5vbmU7CiAgICBkZWYgdmFsdWUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX3ZhbHVlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fdmFsdWU7CiAgICAKICAgICMgbWVhc3VyZWQ6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9tZWFzdXJlZCA9IE5vbmU7CiAgICBkZWYgbWVhc3VyZWQoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX21lYXN1cmVkID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICBpZiBzZWxmLl9tZWFzdXJlZD09J3t7bm93fX0nOgogICAgICAgICAgICAgICAgc2VsZi5fbWVhc3VyZWQgPSB0aW1lLnRpY2tzX21zKCk7CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX21lYXN1cmVkOwogICAgCiAgICAjIG1ldHJpYzogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX21ldHJpYyA9IE5vbmU7CiAgICBkZWYgbWV0cmljKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9tZXRyaWMgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9tZXRyaWM7CiAgICAKICAgICMgZGV2aWNlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfZGV2aWNlID0gTm9uZTsKICAgIGRlZiBkZXZpY2Uoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2RldmljZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2RldmljZTsKICAgIAogICAgCiAgICAKICAgIAogICAgZGVmIF91bmlxdWUoc2VsZik6CiAgICAgICAgX190b1N0cmluZyA9ICdNZXRyaWNfVmFsdWU6Ol91bmlxdWUoKTogJzsKICAgICAgICAKICAgICAgICByZXQgPSBNZXRyaWNfVmFsdWUoKTsKICAgICAgICBpZiBzZWxmLklkIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXQuSWQgPSBzZWxmLklkOwogICAgCiAgICAgICAgaWYgc2VsZi5tZXRyaWMoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0Lm1ldHJpYyhzZWxmLm1ldHJpYygpLl91bmlxdWUoKSk7CiAgICAKICAgICAgICBpZiBzZWxmLmRldmljZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXQuZGV2aWNlKHNlbGYuZGV2aWNlKCkuX3VuaXF1ZSgpKTsKICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gcmV0OwogICAgCiAgICBkZWYgX2Zyb21Eb2N1bWVudChzZWxmLCBvYmopOgogICAgICAgIF9fdG9TdHJpbmcgPSAnTWV0cmljX1ZhbHVlOjpfZnJvbURvY3VtZW50KCk6ICc7CiAgICAgICAgCiAgICAgICAgaWYgb2JqIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBzZWxmOwoKICAgICAgICBpZiBpc2luc3RhbmNlKG9iaiwgYnl0ZXMpOgogICAgICAgICAgICBvYmogPSBzdHIob2JqLCAidXRmLTgiKTsKCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIHN0cikgb3IgdHlwZShvYmopIGlzIHN0cjoKICAgICAgICAgICAgaWYgcmUubWF0Y2gociIoKChbQS1aYS16XXszLDl9Oig/OlwvXC8pPykoPzpbLTs6Jj1cK1wkLFx3XStAKT9bQS1aYS16MC05Li1dK3woPzp3d3cufFstOzomPVwrXCQsXHddK0ApW0EtWmEtejAtOS4tXSspKCg/OlwvW1wrfiVcLy5cd1wtX10qKT9cPz8oPzpbLVwrPSY7JUAuXHdfXSopIz8oPzpbXHddKikpPykiLCBvYmopOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIG9iaiA9IHVqc29uLmxvYWRzKHVybGxpYjMuUG9vbE1hbmFnZXIoKS5yZXF1ZXN0KCdHRVQnLCBvYmopLmRhdGEuZGVjb2RlKCd1dGYtOCcpKTsKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBvYmogPSB7fTsKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG9iaiA9IHVqc29uLmxvYWRzKG9iaik7CiAgICAgICAgCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIGxpc3QpOgogICAgICAgICAgICByZXR1cm4gW01ldHJpY19WYWx1ZSgpLl9mcm9tRG9jdW1lbnQobykgZm9yIG8gaW4gb2JqXTsKICAgICAgICAgICAgCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2Uob2JqLCAoc3RyLCBieXRlcywgZGljdCkpOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgJ3VuaGFuZGxlZCB0eXBlOiAnICsgc3RyKHR5cGUob2JqKSkpOwogICAgICAgICAgICByZXR1cm4gb2JqOwoKICAgICAgICBpZiAnSWQnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5JZCA9IG9ialsnSWQnXTsKCiAgICAKICAgICAgICBpZiAnYWN0aXZlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuYWN0aXZlKG9ialsnYWN0aXZlJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2VuYWJsZWQnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5lbmFibGVkKG9ialsnZW5hYmxlZCddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdjb2RlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuY29kZShvYmpbJ2NvZGUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnb3JkZXInIGluIG9iajoKICAgICAgICAgICAgc2VsZi5vcmRlcihvYmpbJ29yZGVyJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2RhdGUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5kYXRlKG9ialsnZGF0ZSddKTsKICAgICAgICAKICAgICAgICAgICAgc2VsZi5kYXRlKGRhdGV0aW1lLmRhdGV0aW1lLmZyb21pc29mb3JtYXQoc2VsZi5kYXRlKCkpKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICduYW1lJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYubmFtZShvYmpbJ25hbWUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAncmVtYXJrJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYucmVtYXJrKG9ialsncmVtYXJrJ10pOwogICAgICAgIAogICAgICAgICAgICBzZWxmLnJlbWFyayggdWJpbmFzY2lpLmEyYl9iYXNlNjQoc2VsZi5yZW1hcmsoKSkgKTsKICAgICAgICAgICAgaWYgc2VsZi5yZW1hcmsoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbWFyayhzZWxmLnJlbWFyaygpLmRlY29kZSgndXRmLTgnKS5zdHJpcCgpKTsKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbWFyaygpOwogICAgICAgICAgICAgICAgICAgICNwcmludChfX3RvU3RyaW5nICsgInJlbWFyayBleGNlcHRpb24iLCBzZWxmLnJlbWFyaygpKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICd2YWx1ZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLnZhbHVlKG9ialsndmFsdWUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnbWVhc3VyZWQnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5tZWFzdXJlZChvYmpbJ21lYXN1cmVkJ10pOwogICAgICAgIAogICAgICAgICAgICBzZWxmLm1lYXN1cmVkKGRhdGV0aW1lLmRhdGV0aW1lLmZyb21pc29mb3JtYXQoc2VsZi5tZWFzdXJlZCgpKSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnbWV0cmljJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYubWV0cmljKE1ldHJpYygpLl9mcm9tRG9jdW1lbnQob2JqWydtZXRyaWMnXSkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2RldmljZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmRldmljZShEZXZpY2UoKS5fZnJvbURvY3VtZW50KG9ialsnZGV2aWNlJ10pKTsKICAgICAgICAKICAgIAoKICAgIAoKICAgICAgICBnYy5jb2xsZWN0KCk7CiAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAKICAgIGRlZiBfdG9Eb2N1bWVudChzZWxmLCBiSlNPTj1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ01ldHJpY19WYWx1ZTo6X3RvRG9jdW1lbnQoKTogJzsKCiAgICAgICAgcmV0ID0ge307CiAgICAgICAgaWYgc2VsZi5JZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJJZCJdID0gc2VsZi5JZDsKCiAgICAKICAgICAgICBpZiBzZWxmLmFjdGl2ZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImFjdGl2ZSJdID0gc2VsZi5hY3RpdmUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuZW5hYmxlZCgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImVuYWJsZWQiXSA9IHNlbGYuZW5hYmxlZCgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5jb2RlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiY29kZSJdID0gc2VsZi5jb2RlKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLm9yZGVyKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsib3JkZXIiXSA9IHNlbGYub3JkZXIoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuZGF0ZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImRhdGUiXSA9IHNlbGYuZGF0ZSgpOwogICAgICAgIAogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHJldFsiZGF0ZSJdLCBkYXRldGltZS5kYXRldGltZSk6CiAgICAgICAgICAgICAgICByZXRbImRhdGUiXSA9IHJldFsiZGF0ZSJdLmlzb2Zvcm1hdCgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5uYW1lKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsibmFtZSJdID0gc2VsZi5uYW1lKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLnJlbWFyaygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbInJlbWFyayJdID0gc2VsZi5yZW1hcmsoKTsKICAgICAgICAKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXRbInJlbWFyayJdLCBkaWN0KToKICAgICAgICAgICAgICAgIHJldFsicmVtYXJrIl0gPSB1anNvbi5kdW1wcyhyZXRbInJlbWFyayJdKS5lbmNvZGUoJ3V0Zi04Jyk7CgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXRbInJlbWFyayJdID0gIHViaW5hc2NpaS5iMmFfYmFzZTY0KHJldFsicmVtYXJrIl0pLmRlY29kZSgndXRmLTgnKS5zdHJpcCgpOwogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4Y2VwdGlvbiB3aXRoIHJlbWFyazogIiArIHJldFsicmVtYXJrIl0pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi52YWx1ZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbInZhbHVlIl0gPSBzZWxmLnZhbHVlKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLm1lYXN1cmVkKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsibWVhc3VyZWQiXSA9IHNlbGYubWVhc3VyZWQoKTsKICAgICAgICAKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXRbIm1lYXN1cmVkIl0sIGRhdGV0aW1lLmRhdGV0aW1lKToKICAgICAgICAgICAgICAgIHJldFsibWVhc3VyZWQiXSA9IHJldFsibWVhc3VyZWQiXS5pc29mb3JtYXQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYubWV0cmljKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsibWV0cmljIl0gPSBzZWxmLm1ldHJpYygpLl90b0RvY3VtZW50KCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmRldmljZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImRldmljZSJdID0gc2VsZi5kZXZpY2UoKS5fdG9Eb2N1bWVudCgpOwogICAgICAgIAogICAgCiAgICAgICAgCiAgICAKCiAgICAgICAgaWYgYkpTT04gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICNwcmludChfX3RvU3RyaW5nICsgIkdPVCBIRVJFIiwgdHlwZShyZXQpLCByZXQpOwogICAgICAgICAgICByZXQgPSB1anNvbi5kdW1wcyhyZXQpOwogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gcmV0OwoKICAgIAogICAgZGVmIHN0b3JlKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdNZXRyaWNfVmFsdWU6OnN0b3JlKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLk1ldHJpY19WYWx1ZS5zdG9yZSgpJykubWV0aG9kKCdzdG9yZScpLmNsYXNzTmFtZSgnTWV0cmljX1ZhbHVlJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAgICAgaWYgc2VsZi5tZWFzdXJlZCgpIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgInJlYWRpbmcgIiArIHNlbGYubWV0cmljKCkuY29kZSgpICsgIi4uLiIpOwogICAgICAgICAgICAgICAgZXhlYygiZGVmICIgKyBzZWxmLm1ldHJpYygpLmNvZGUoKSArICIoc2VsZiwgIiArICIsICIuam9pbihbZGEuYXR0cmlidXRlKCkuY29kZSgpIGZvciBkYSBpbiBzZWxmLmRldmljZSgpLmRldmljZV9EZXZpY2VfQXR0cmlidXRlcygpXSkgKyAiKToiICsgcmUuc3ViKCJcbiIsICJcbiAgICAiLCByZS5zdWIoIlxyIiwgIiIsICJcbiIrc2VsZi5tZXRyaWMoKS5zY3JpcHQoKSkpICsgIlxuXG5zZXRhdHRyKE1ldHJpYywgJ18iK3NlbGYubWV0cmljKCkuY29kZSgpKyInLCAiICsgc2VsZi5tZXRyaWMoKS5jb2RlKCkgKyAiKTsiKTsKICAgICAgICAgICAgICAgIG12UmV0ID0gc2VsZi5fdW5pcXVlKCkubWVhc3VyZWQoJ3t7bm93fX0nKTsKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBtdlJldC52YWx1ZShldmFsKCJzdHIoc2VsZi5tZXRyaWMoKS5fIiArIHNlbGYubWV0cmljKCkuY29kZSgpICsgJygiJyArICciLCAiJy5qb2luKFtkdGEudmFsdWUoKSBmb3IgZHRhIGluIHNlbGYuZGV2aWNlKCkuZGV2aWNlX0RldmljZV9BdHRyaWJ1dGVzKCldKSArICciKSkuc3RyaXAoKScpKTsKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZXg6CiAgICAgICAgICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJFeGNlcHRpb246ICIgKyBzdHIoZXgpKTsKICAgICAgICAgICAgICAgICAgICBtdlJldC52YWx1ZSgiLS1leGNlcHRpb24tLSIpOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgIm15IHZhbHVlIGlzICIgKyBtdlJldC52YWx1ZSgpKTsKICAgICAgICAgICAgICAgIHJldHVybiBtdlJldC5zdG9yZSgpOwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJ3cml0aW5nLi4uLCBwcm9iYWJseSBuZXZlciBuZWVkZWQgYW55d2F5ISIpOwogICAgICAgIAogICAgICAgIAogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImEgcmVzcG9uc2UgdG8gbXkgZXZlbnQoIitfX2V2ZW50LnJlc3BvbnNlVG8oKS5jb2RlKCkrIikgWyIgKyBfX2V2ZW50LmNsYXNzTmFtZSgpICsgIigpLiIgKyBfX2V2ZW50Lm1ldGhvZCgpICsgIigpXSIpOwogICAgICAgIAogICAgICAgICAgICBhbnN3ZXIgPSBNZXRyaWNfVmFsdWUoKS5fZnJvbURvY3VtZW50KGV2SlNPTik7CiAgICAgICAgCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhlY3V0aW5nIGxvY2FsbHkiKTsKCgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZSBvciBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBpZiBhbnN3ZXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKGFuc3dlci5fdG9Eb2N1bWVudCgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoeyJfX3RoaXMiOiBzZWxmLl90b0RvY3VtZW50KCl9KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnRyaWdnZXIoKTsKICAgICAgICAgICAgCgogICAgICAgIHJldHVybiBhbnN3ZXI7CgogICAgCiAgICBkZWYgZmluZEFsbChzZWxmLCBfX2V2ZW50PU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnTWV0cmljX1ZhbHVlOjpmaW5kQWxsKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLk1ldHJpY19WYWx1ZS5maW5kQWxsKCknKS5tZXRob2QoJ2ZpbmRBbGwnKS5jbGFzc05hbWUoJ01ldHJpY19WYWx1ZScpLmNhcnJpZXIobm9kZSkuc2VuZGVyKG5vZGUpLnJlY2lwaWVudChub2RlLnBhcmVudCgpKTsKCiAgICAgICAgZXZKU09OID0gTm9uZTsKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBldkpTT04gPSB1anNvbi5sb2FkcyhfX2V2ZW50LnBheWxvYWQoKSk7CiAgICAgICAgICAgIGlmICdfX3RoaXMnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIHNlbGYuX2Zyb21Eb2N1bWVudChldkpTT05bJ19fdGhpcyddKTsKICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS5yZXNwb25zZVRvKF9fZXZlbnQuX3VuaXF1ZSgpKTsKICAgICAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiIGhhbmRsaW5nIGV2ZW50WyIrX19ldmVudC5jb2RlKCkrIl0iKTsKCiAgICAgICAgCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiYSByZXNwb25zZSB0byBteSBldmVudCgiK19fZXZlbnQucmVzcG9uc2VUbygpLmNvZGUoKSsiKSBbIiArIF9fZXZlbnQuY2xhc3NOYW1lKCkgKyAiKCkuIiArIF9fZXZlbnQubWV0aG9kKCkgKyAiKCldIik7CiAgICAgICAgCiAgICAgICAgICAgIGFuc3dlciA9IE1ldHJpY19WYWx1ZSgpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiBmaW5kKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdNZXRyaWNfVmFsdWU6OmZpbmQoKTogJzsKICAgICAgICAKICAgICAgICBhbnN3ZXIgPSBOb25lOwoKICAgICAgICBfX3Jlc3BvbnNlID0gRXZlbnQoKS5jb2RlKCdbJytub2RlLmNvZGUoKSsnQCcrc3RyKHRpbWUudGlja3NfbXMoKSkrJ10uTWV0cmljX1ZhbHVlLmZpbmQoKScpLm1ldGhvZCgnZmluZCcpLmNsYXNzTmFtZSgnTWV0cmljX1ZhbHVlJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gTWV0cmljX1ZhbHVlKCkuX2Zyb21Eb2N1bWVudChldkpTT04pOwogICAgICAgIAoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4ZWN1dGluZyBsb2NhbGx5Iik7CgoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmUgb3IgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgaWYgYW5zd2VyIGlzIG5vdCBOb25lOgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZChhbnN3ZXIuX3RvRG9jdW1lbnQoKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKHsiX190aGlzIjogc2VsZi5fdG9Eb2N1bWVudCgpfSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS50cmlnZ2VyKCk7CiAgICAgICAgICAgIAoKICAgICAgICByZXR1cm4gYW5zd2VyOwoKICAgIAoKCmNsYXNzIERldmljZSgpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIElkPU5vbmUsIGFjdGl2ZT1Ob25lLCBlbmFibGVkPU5vbmUsIGNvZGU9Tm9uZSwgb3JkZXI9Tm9uZSwgZGF0ZT1Ob25lLCBuYW1lPU5vbmUsIHJlbWFyaz1Ob25lLCB0eXBlPU5vbmUsIGNvbnRyb2xsZXI9Tm9uZSk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygpOwoKICAgICAgICAjcHJpbnQoJ0RldmljZTo6X19pbml0X18oKScpOwogICAgICAgIGlmIElkIGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLklkID0gSWQ7CgogICAgICAgIAogICAgICAgIHNlbGYuYWN0aXZlKGFjdGl2ZSk7CiAgICAgICAgc2VsZi5lbmFibGVkKGVuYWJsZWQpOwogICAgICAgIHNlbGYuY29kZShjb2RlKTsKICAgICAgICBzZWxmLm9yZGVyKG9yZGVyKTsKICAgICAgICBzZWxmLmRhdGUoZGF0ZSk7CiAgICAgICAgc2VsZi5uYW1lKG5hbWUpOwogICAgICAgIHNlbGYucmVtYXJrKHJlbWFyayk7CiAgICAgICAgc2VsZi50eXBlKHR5cGUpOwogICAgICAgIHNlbGYuY29udHJvbGxlcihjb250cm9sbGVyKTsKICAgICAgICAKICAgIElkID0gTm9uZTsKICAgIAogICAgCiAgICAjIGFjdGl2ZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2FjdGl2ZSA9IE5vbmU7CiAgICBkZWYgYWN0aXZlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9hY3RpdmUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9hY3RpdmU7CiAgICAKICAgICMgZW5hYmxlZDogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2VuYWJsZWQgPSBOb25lOwogICAgZGVmIGVuYWJsZWQoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2VuYWJsZWQgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9lbmFibGVkOwogICAgCiAgICAjIGNvZGU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9jb2RlID0gTm9uZTsKICAgIGRlZiBjb2RlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9jb2RlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fY29kZTsKICAgIAogICAgIyBvcmRlcjogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX29yZGVyID0gTm9uZTsKICAgIGRlZiBvcmRlcihzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fb3JkZXIgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9vcmRlcjsKICAgIAogICAgIyBkYXRlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfZGF0ZSA9IE5vbmU7CiAgICBkZWYgZGF0ZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fZGF0ZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgaWYgc2VsZi5fZGF0ZT09J3t7bm93fX0nOgogICAgICAgICAgICAgICAgc2VsZi5fZGF0ZSA9IHRpbWUudGlja3NfbXMoKTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZGF0ZTsKICAgIAogICAgIyBuYW1lOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfbmFtZSA9IE5vbmU7CiAgICBkZWYgbmFtZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fbmFtZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX25hbWU7CiAgICAKICAgICMgcmVtYXJrOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfcmVtYXJrID0gTm9uZTsKICAgIGRlZiByZW1hcmsoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX3JlbWFyayA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3JlbWFyazsKICAgIAogICAgIyB0eXBlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfdHlwZSA9IE5vbmU7CiAgICBkZWYgdHlwZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fdHlwZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3R5cGU7CiAgICAKICAgICMgY29udHJvbGxlcjogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2NvbnRyb2xsZXIgPSBOb25lOwogICAgZGVmIGNvbnRyb2xsZXIoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2NvbnRyb2xsZXIgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jb250cm9sbGVyOwogICAgCiAgICAKICAgIAogICAgIyBkZXZpY2VfTWV0cmljX1ZhbHVlczogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2RldmljZV9NZXRyaWNfVmFsdWVzID0gTm9uZTsKICAgIGRlZiBkZXZpY2VfTWV0cmljX1ZhbHVlcyhzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fZGV2aWNlX01ldHJpY19WYWx1ZXMgPSBhcmdzWzBdOwogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZGV2aWNlX01ldHJpY19WYWx1ZXM7CiAgICAKICAgICMgZGV2aWNlX0RldmljZV9BdHRyaWJ1dGVzOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfZGV2aWNlX0RldmljZV9BdHRyaWJ1dGVzID0gTm9uZTsKICAgIGRlZiBkZXZpY2VfRGV2aWNlX0F0dHJpYnV0ZXMoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2RldmljZV9EZXZpY2VfQXR0cmlidXRlcyA9IGFyZ3NbMF07CiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9kZXZpY2VfRGV2aWNlX0F0dHJpYnV0ZXM7CiAgICAKICAgIAogICAgZGVmIF91bmlxdWUoc2VsZik6CiAgICAgICAgX190b1N0cmluZyA9ICdEZXZpY2U6Ol91bmlxdWUoKTogJzsKICAgICAgICAKICAgICAgICByZXQgPSBEZXZpY2UoKTsKICAgICAgICBpZiBzZWxmLklkIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXQuSWQgPSBzZWxmLklkOwogICAgCiAgICAgICAgaWYgc2VsZi5jb2RlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldC5jb2RlKHNlbGYuY29kZSgpKTsKICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gcmV0OwogICAgCiAgICBkZWYgX2Zyb21Eb2N1bWVudChzZWxmLCBvYmopOgogICAgICAgIF9fdG9TdHJpbmcgPSAnRGV2aWNlOjpfZnJvbURvY3VtZW50KCk6ICc7CiAgICAgICAgCiAgICAgICAgaWYgb2JqIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBzZWxmOwoKICAgICAgICBpZiBpc2luc3RhbmNlKG9iaiwgYnl0ZXMpOgogICAgICAgICAgICBvYmogPSBzdHIob2JqLCAidXRmLTgiKTsKCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIHN0cikgb3IgdHlwZShvYmopIGlzIHN0cjoKICAgICAgICAgICAgaWYgcmUubWF0Y2gociIoKChbQS1aYS16XXszLDl9Oig/OlwvXC8pPykoPzpbLTs6Jj1cK1wkLFx3XStAKT9bQS1aYS16MC05Li1dK3woPzp3d3cufFstOzomPVwrXCQsXHddK0ApW0EtWmEtejAtOS4tXSspKCg/OlwvW1wrfiVcLy5cd1wtX10qKT9cPz8oPzpbLVwrPSY7JUAuXHdfXSopIz8oPzpbXHddKikpPykiLCBvYmopOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIG9iaiA9IHVqc29uLmxvYWRzKHVybGxpYjMuUG9vbE1hbmFnZXIoKS5yZXF1ZXN0KCdHRVQnLCBvYmopLmRhdGEuZGVjb2RlKCd1dGYtOCcpKTsKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBvYmogPSB7fTsKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG9iaiA9IHVqc29uLmxvYWRzKG9iaik7CiAgICAgICAgCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIGxpc3QpOgogICAgICAgICAgICByZXR1cm4gW0RldmljZSgpLl9mcm9tRG9jdW1lbnQobykgZm9yIG8gaW4gb2JqXTsKICAgICAgICAgICAgCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2Uob2JqLCAoc3RyLCBieXRlcywgZGljdCkpOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgJ3VuaGFuZGxlZCB0eXBlOiAnICsgc3RyKHR5cGUob2JqKSkpOwogICAgICAgICAgICByZXR1cm4gb2JqOwoKICAgICAgICBpZiAnSWQnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5JZCA9IG9ialsnSWQnXTsKCiAgICAKICAgICAgICBpZiAnYWN0aXZlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuYWN0aXZlKG9ialsnYWN0aXZlJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2VuYWJsZWQnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5lbmFibGVkKG9ialsnZW5hYmxlZCddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdjb2RlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuY29kZShvYmpbJ2NvZGUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnb3JkZXInIGluIG9iajoKICAgICAgICAgICAgc2VsZi5vcmRlcihvYmpbJ29yZGVyJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2RhdGUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5kYXRlKG9ialsnZGF0ZSddKTsKICAgICAgICAKICAgICAgICAgICAgc2VsZi5kYXRlKGRhdGV0aW1lLmRhdGV0aW1lLmZyb21pc29mb3JtYXQoc2VsZi5kYXRlKCkpKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICduYW1lJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYubmFtZShvYmpbJ25hbWUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAncmVtYXJrJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYucmVtYXJrKG9ialsncmVtYXJrJ10pOwogICAgICAgIAogICAgICAgICAgICBzZWxmLnJlbWFyayggdWJpbmFzY2lpLmEyYl9iYXNlNjQoc2VsZi5yZW1hcmsoKSkgKTsKICAgICAgICAgICAgaWYgc2VsZi5yZW1hcmsoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbWFyayhzZWxmLnJlbWFyaygpLmRlY29kZSgndXRmLTgnKS5zdHJpcCgpKTsKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbWFyaygpOwogICAgICAgICAgICAgICAgICAgICNwcmludChfX3RvU3RyaW5nICsgInJlbWFyayBleGNlcHRpb24iLCBzZWxmLnJlbWFyaygpKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICd0eXBlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYudHlwZShEZXZpY2VfVHlwZSgpLl9mcm9tRG9jdW1lbnQob2JqWyd0eXBlJ10pKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdjb250cm9sbGVyJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuY29udHJvbGxlcihOb2RlKCkuX2Zyb21Eb2N1bWVudChvYmpbJ2NvbnRyb2xsZXInXSkpOwogICAgICAgIAogICAgCgogICAgCiAgICAgICAgaWYgJ2RldmljZV9NZXRyaWNfVmFsdWVzJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuZGV2aWNlX01ldHJpY19WYWx1ZXMoTWV0cmljX1ZhbHVlKCkuX2Zyb21Eb2N1bWVudChvYmpbJ2RldmljZV9NZXRyaWNfVmFsdWVzJ10pKTsKICAgIAogICAgICAgIGlmICdkZXZpY2VfRGV2aWNlX0F0dHJpYnV0ZXMnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5kZXZpY2VfRGV2aWNlX0F0dHJpYnV0ZXMoRGV2aWNlX0F0dHJpYnV0ZSgpLl9mcm9tRG9jdW1lbnQob2JqWydkZXZpY2VfRGV2aWNlX0F0dHJpYnV0ZXMnXSkpOwogICAgCgogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gc2VsZjsKICAgIAogICAgZGVmIF90b0RvY3VtZW50KHNlbGYsIGJKU09OPU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnRGV2aWNlOjpfdG9Eb2N1bWVudCgpOiAnOwoKICAgICAgICByZXQgPSB7fTsKICAgICAgICBpZiBzZWxmLklkIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIklkIl0gPSBzZWxmLklkOwoKICAgIAogICAgICAgIGlmIHNlbGYuYWN0aXZlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiYWN0aXZlIl0gPSBzZWxmLmFjdGl2ZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5lbmFibGVkKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZW5hYmxlZCJdID0gc2VsZi5lbmFibGVkKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmNvZGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJjb2RlIl0gPSBzZWxmLmNvZGUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYub3JkZXIoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJvcmRlciJdID0gc2VsZi5vcmRlcigpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5kYXRlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZGF0ZSJdID0gc2VsZi5kYXRlKCk7CiAgICAgICAgCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmV0WyJkYXRlIl0sIGRhdGV0aW1lLmRhdGV0aW1lKToKICAgICAgICAgICAgICAgIHJldFsiZGF0ZSJdID0gcmV0WyJkYXRlIl0uaXNvZm9ybWF0KCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLm5hbWUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJuYW1lIl0gPSBzZWxmLm5hbWUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYucmVtYXJrKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsicmVtYXJrIl0gPSBzZWxmLnJlbWFyaygpOwogICAgICAgIAogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHJldFsicmVtYXJrIl0sIGRpY3QpOgogICAgICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9IHVqc29uLmR1bXBzKHJldFsicmVtYXJrIl0pLmVuY29kZSgndXRmLTgnKTsKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJldFsicmVtYXJrIl0gPSAgdWJpbmFzY2lpLmIyYV9iYXNlNjQocmV0WyJyZW1hcmsiXSkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCk7CiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhjZXB0aW9uIHdpdGggcmVtYXJrOiAiICsgcmV0WyJyZW1hcmsiXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLnR5cGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJ0eXBlIl0gPSBzZWxmLnR5cGUoKS5fdG9Eb2N1bWVudCgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5jb250cm9sbGVyKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiY29udHJvbGxlciJdID0gc2VsZi5jb250cm9sbGVyKCkuX3RvRG9jdW1lbnQoKTsKICAgICAgICAKICAgIAogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5kZXZpY2VfTWV0cmljX1ZhbHVlcygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImRldmljZV9NZXRyaWNfVmFsdWVzIl0gPSBbdGEuX3RvRG9jdW1lbnQoKSBmb3IgdGEgaW4gc2VsZi5kZXZpY2VfTWV0cmljX1ZhbHVlcygpXTsKICAgIAogICAgICAgIGlmIHNlbGYuZGV2aWNlX0RldmljZV9BdHRyaWJ1dGVzKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZGV2aWNlX0RldmljZV9BdHRyaWJ1dGVzIl0gPSBbdGEuX3RvRG9jdW1lbnQoKSBmb3IgdGEgaW4gc2VsZi5kZXZpY2VfRGV2aWNlX0F0dHJpYnV0ZXMoKV07CiAgICAKCiAgICAgICAgaWYgYkpTT04gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICNwcmludChfX3RvU3RyaW5nICsgIkdPVCBIRVJFIiwgdHlwZShyZXQpLCByZXQpOwogICAgICAgICAgICByZXQgPSB1anNvbi5kdW1wcyhyZXQpOwogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gcmV0OwoKICAgIAogICAgZGVmIHN0b3JlKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdEZXZpY2U6OnN0b3JlKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLkRldmljZS5zdG9yZSgpJykubWV0aG9kKCdzdG9yZScpLmNsYXNzTmFtZSgnRGV2aWNlJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gRGV2aWNlKCkuX2Zyb21Eb2N1bWVudChldkpTT04pOwogICAgICAgIAoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4ZWN1dGluZyBsb2NhbGx5Iik7CgoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmUgb3IgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgaWYgYW5zd2VyIGlzIG5vdCBOb25lOgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZChhbnN3ZXIuX3RvRG9jdW1lbnQoKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKHsiX190aGlzIjogc2VsZi5fdG9Eb2N1bWVudCgpfSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS50cmlnZ2VyKCk7CiAgICAgICAgICAgIAoKICAgICAgICByZXR1cm4gYW5zd2VyOwoKICAgIAogICAgZGVmIGZpbmRBbGwoc2VsZiwgX19ldmVudD1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ0RldmljZTo6ZmluZEFsbCgpOiAnOwogICAgICAgIAogICAgICAgIGFuc3dlciA9IE5vbmU7CgogICAgICAgIF9fcmVzcG9uc2UgPSBFdmVudCgpLmNvZGUoJ1snK25vZGUuY29kZSgpKydAJytzdHIodGltZS50aWNrc19tcygpKSsnXS5EZXZpY2UuZmluZEFsbCgpJykubWV0aG9kKCdmaW5kQWxsJykuY2xhc3NOYW1lKCdEZXZpY2UnKS5jYXJyaWVyKG5vZGUpLnNlbmRlcihub2RlKS5yZWNpcGllbnQobm9kZS5wYXJlbnQoKSk7CgogICAgICAgIGV2SlNPTiA9IE5vbmU7CiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgZXZKU09OID0gdWpzb24ubG9hZHMoX19ldmVudC5wYXlsb2FkKCkpOwogICAgICAgICAgICBpZiAnX190aGlzJyBpbiBldkpTT046CiAgICAgICAgICAgICAgICBzZWxmLl9mcm9tRG9jdW1lbnQoZXZKU09OWydfX3RoaXMnXSk7CiAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UucmVzcG9uc2VUbyhfX2V2ZW50Ll91bmlxdWUoKSk7CiAgICAgICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgIiBoYW5kbGluZyBldmVudFsiK19fZXZlbnQuY29kZSgpKyJdIik7CgogICAgICAgIAogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImEgcmVzcG9uc2UgdG8gbXkgZXZlbnQoIitfX2V2ZW50LnJlc3BvbnNlVG8oKS5jb2RlKCkrIikgWyIgKyBfX2V2ZW50LmNsYXNzTmFtZSgpICsgIigpLiIgKyBfX2V2ZW50Lm1ldGhvZCgpICsgIigpXSIpOwogICAgICAgIAogICAgICAgICAgICBhbnN3ZXIgPSBEZXZpY2UoKS5fZnJvbURvY3VtZW50KGV2SlNPTik7CiAgICAgICAgCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhlY3V0aW5nIGxvY2FsbHkiKTsKCgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZSBvciBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBpZiBhbnN3ZXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKGFuc3dlci5fdG9Eb2N1bWVudCgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoeyJfX3RoaXMiOiBzZWxmLl90b0RvY3VtZW50KCl9KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnRyaWdnZXIoKTsKICAgICAgICAgICAgCgogICAgICAgIHJldHVybiBhbnN3ZXI7CgogICAgCiAgICBkZWYgZmluZChzZWxmLCBfX2V2ZW50PU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnRGV2aWNlOjpmaW5kKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLkRldmljZS5maW5kKCknKS5tZXRob2QoJ2ZpbmQnKS5jbGFzc05hbWUoJ0RldmljZScpLmNhcnJpZXIobm9kZSkuc2VuZGVyKG5vZGUpLnJlY2lwaWVudChub2RlLnBhcmVudCgpKTsKCiAgICAgICAgZXZKU09OID0gTm9uZTsKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBldkpTT04gPSB1anNvbi5sb2FkcyhfX2V2ZW50LnBheWxvYWQoKSk7CiAgICAgICAgICAgIGlmICdfX3RoaXMnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIHNlbGYuX2Zyb21Eb2N1bWVudChldkpTT05bJ19fdGhpcyddKTsKICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS5yZXNwb25zZVRvKF9fZXZlbnQuX3VuaXF1ZSgpKTsKICAgICAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiIGhhbmRsaW5nIGV2ZW50WyIrX19ldmVudC5jb2RlKCkrIl0iKTsKCiAgICAgICAgCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiYSByZXNwb25zZSB0byBteSBldmVudCgiK19fZXZlbnQucmVzcG9uc2VUbygpLmNvZGUoKSsiKSBbIiArIF9fZXZlbnQuY2xhc3NOYW1lKCkgKyAiKCkuIiArIF9fZXZlbnQubWV0aG9kKCkgKyAiKCldIik7CiAgICAgICAgCiAgICAgICAgICAgIGFuc3dlciA9IERldmljZSgpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKCgpjbGFzcyBEZXZpY2VfQXR0cmlidXRlKCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgSWQ9Tm9uZSwgYWN0aXZlPU5vbmUsIGVuYWJsZWQ9Tm9uZSwgY29kZT1Ob25lLCBvcmRlcj1Ob25lLCBkYXRlPU5vbmUsIG5hbWU9Tm9uZSwgcmVtYXJrPU5vbmUsIHZhbHVlPU5vbmUsIGRldmljZT1Ob25lLCBhdHRyaWJ1dGU9Tm9uZSk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygpOwoKICAgICAgICAjcHJpbnQoJ0RldmljZV9BdHRyaWJ1dGU6Ol9faW5pdF9fKCknKTsKICAgICAgICBpZiBJZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgc2VsZi5JZCA9IElkOwoKICAgICAgICAKICAgICAgICBzZWxmLmFjdGl2ZShhY3RpdmUpOwogICAgICAgIHNlbGYuZW5hYmxlZChlbmFibGVkKTsKICAgICAgICBzZWxmLmNvZGUoY29kZSk7CiAgICAgICAgc2VsZi5vcmRlcihvcmRlcik7CiAgICAgICAgc2VsZi5kYXRlKGRhdGUpOwogICAgICAgIHNlbGYubmFtZShuYW1lKTsKICAgICAgICBzZWxmLnJlbWFyayhyZW1hcmspOwogICAgICAgIHNlbGYudmFsdWUodmFsdWUpOwogICAgICAgIHNlbGYuZGV2aWNlKGRldmljZSk7CiAgICAgICAgc2VsZi5hdHRyaWJ1dGUoYXR0cmlidXRlKTsKICAgICAgICAKICAgIElkID0gTm9uZTsKICAgIAogICAgCiAgICAjIGFjdGl2ZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2FjdGl2ZSA9IE5vbmU7CiAgICBkZWYgYWN0aXZlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9hY3RpdmUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9hY3RpdmU7CiAgICAKICAgICMgZW5hYmxlZDogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2VuYWJsZWQgPSBOb25lOwogICAgZGVmIGVuYWJsZWQoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2VuYWJsZWQgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9lbmFibGVkOwogICAgCiAgICAjIGNvZGU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9jb2RlID0gTm9uZTsKICAgIGRlZiBjb2RlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9jb2RlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fY29kZTsKICAgIAogICAgIyBvcmRlcjogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX29yZGVyID0gTm9uZTsKICAgIGRlZiBvcmRlcihzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fb3JkZXIgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9vcmRlcjsKICAgIAogICAgIyBkYXRlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfZGF0ZSA9IE5vbmU7CiAgICBkZWYgZGF0ZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fZGF0ZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgaWYgc2VsZi5fZGF0ZT09J3t7bm93fX0nOgogICAgICAgICAgICAgICAgc2VsZi5fZGF0ZSA9IHRpbWUudGlja3NfbXMoKTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZGF0ZTsKICAgIAogICAgIyBuYW1lOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfbmFtZSA9IE5vbmU7CiAgICBkZWYgbmFtZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fbmFtZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX25hbWU7CiAgICAKICAgICMgcmVtYXJrOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfcmVtYXJrID0gTm9uZTsKICAgIGRlZiByZW1hcmsoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX3JlbWFyayA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3JlbWFyazsKICAgIAogICAgIyB2YWx1ZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3ZhbHVlID0gTm9uZTsKICAgIGRlZiB2YWx1ZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fdmFsdWUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl92YWx1ZTsKICAgIAogICAgIyBkZXZpY2U6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9kZXZpY2UgPSBOb25lOwogICAgZGVmIGRldmljZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fZGV2aWNlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZGV2aWNlOwogICAgCiAgICAjIGF0dHJpYnV0ZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2F0dHJpYnV0ZSA9IE5vbmU7CiAgICBkZWYgYXR0cmlidXRlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9hdHRyaWJ1dGUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9hdHRyaWJ1dGU7CiAgICAKICAgIAogICAgCiAgICAKICAgIGRlZiBfdW5pcXVlKHNlbGYpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnRGV2aWNlX0F0dHJpYnV0ZTo6X3VuaXF1ZSgpOiAnOwogICAgICAgIAogICAgICAgIHJldCA9IERldmljZV9BdHRyaWJ1dGUoKTsKICAgICAgICBpZiBzZWxmLklkIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXQuSWQgPSBzZWxmLklkOwogICAgCiAgICAgICAgaWYgc2VsZi5kZXZpY2UoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0LmRldmljZShzZWxmLmRldmljZSgpLl91bmlxdWUoKSk7CiAgICAKICAgICAgICBpZiBzZWxmLmF0dHJpYnV0ZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXQuYXR0cmlidXRlKHNlbGYuYXR0cmlidXRlKCkuX3VuaXF1ZSgpKTsKICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gcmV0OwogICAgCiAgICBkZWYgX2Zyb21Eb2N1bWVudChzZWxmLCBvYmopOgogICAgICAgIF9fdG9TdHJpbmcgPSAnRGV2aWNlX0F0dHJpYnV0ZTo6X2Zyb21Eb2N1bWVudCgpOiAnOwogICAgICAgIAogICAgICAgIGlmIG9iaiBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gc2VsZjsKCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIGJ5dGVzKToKICAgICAgICAgICAgb2JqID0gc3RyKG9iaiwgInV0Zi04Iik7CgogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBzdHIpIG9yIHR5cGUob2JqKSBpcyBzdHI6CiAgICAgICAgICAgIGlmIHJlLm1hdGNoKHIiKCgoW0EtWmEtel17Myw5fTooPzpcL1wvKT8pKD86Wy07OiY9XCtcJCxcd10rQCk/W0EtWmEtejAtOS4tXSt8KD86d3d3LnxbLTs6Jj1cK1wkLFx3XStAKVtBLVphLXowLTkuLV0rKSgoPzpcL1tcK34lXC8uXHdcLV9dKik/XD8/KD86Wy1cKz0mOyVALlx3X10qKSM/KD86W1x3XSopKT8pIiwgb2JqKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBvYmogPSB1anNvbi5sb2Fkcyh1cmxsaWIzLlBvb2xNYW5hZ2VyKCkucmVxdWVzdCgnR0VUJywgb2JqKS5kYXRhLmRlY29kZSgndXRmLTgnKSk7CiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgb2JqID0ge307CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBvYmogPSB1anNvbi5sb2FkcyhvYmopOwogICAgICAgIAogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBsaXN0KToKICAgICAgICAgICAgcmV0dXJuIFtEZXZpY2VfQXR0cmlidXRlKCkuX2Zyb21Eb2N1bWVudChvKSBmb3IgbyBpbiBvYmpdOwogICAgICAgICAgICAKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShvYmosIChzdHIsIGJ5dGVzLCBkaWN0KSk6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAndW5oYW5kbGVkIHR5cGU6ICcgKyBzdHIodHlwZShvYmopKSk7CiAgICAgICAgICAgIHJldHVybiBvYmo7CgogICAgICAgIGlmICdJZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLklkID0gb2JqWydJZCddOwoKICAgIAogICAgICAgIGlmICdhY3RpdmUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5hY3RpdmUob2JqWydhY3RpdmUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZW5hYmxlZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmVuYWJsZWQob2JqWydlbmFibGVkJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2NvZGUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5jb2RlKG9ialsnY29kZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdvcmRlcicgaW4gb2JqOgogICAgICAgICAgICBzZWxmLm9yZGVyKG9ialsnb3JkZXInXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZGF0ZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmRhdGUob2JqWydkYXRlJ10pOwogICAgICAgIAogICAgICAgICAgICBzZWxmLmRhdGUoZGF0ZXRpbWUuZGF0ZXRpbWUuZnJvbWlzb2Zvcm1hdChzZWxmLmRhdGUoKSkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ25hbWUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5uYW1lKG9ialsnbmFtZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdyZW1hcmsnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5yZW1hcmsob2JqWydyZW1hcmsnXSk7CiAgICAgICAgCiAgICAgICAgICAgIHNlbGYucmVtYXJrKCB1YmluYXNjaWkuYTJiX2Jhc2U2NChzZWxmLnJlbWFyaygpKSApOwogICAgICAgICAgICBpZiBzZWxmLnJlbWFyaygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVtYXJrKHNlbGYucmVtYXJrKCkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCkpOwogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVtYXJrKCk7CiAgICAgICAgICAgICAgICAgICAgI3ByaW50KF9fdG9TdHJpbmcgKyAicmVtYXJrIGV4Y2VwdGlvbiIsIHNlbGYucmVtYXJrKCkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ3ZhbHVlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYudmFsdWUob2JqWyd2YWx1ZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdkZXZpY2UnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5kZXZpY2UoRGV2aWNlKCkuX2Zyb21Eb2N1bWVudChvYmpbJ2RldmljZSddKSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnYXR0cmlidXRlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuYXR0cmlidXRlKFR5cGVfQXR0cmlidXRlKCkuX2Zyb21Eb2N1bWVudChvYmpbJ2F0dHJpYnV0ZSddKSk7CiAgICAgICAgCiAgICAKCiAgICAKCiAgICAgICAgZ2MuY29sbGVjdCgpOwogICAgICAgIHJldHVybiBzZWxmOwogICAgCiAgICBkZWYgX3RvRG9jdW1lbnQoc2VsZiwgYkpTT049Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdEZXZpY2VfQXR0cmlidXRlOjpfdG9Eb2N1bWVudCgpOiAnOwoKICAgICAgICByZXQgPSB7fTsKICAgICAgICBpZiBzZWxmLklkIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIklkIl0gPSBzZWxmLklkOwoKICAgIAogICAgICAgIGlmIHNlbGYuYWN0aXZlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiYWN0aXZlIl0gPSBzZWxmLmFjdGl2ZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5lbmFibGVkKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZW5hYmxlZCJdID0gc2VsZi5lbmFibGVkKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmNvZGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJjb2RlIl0gPSBzZWxmLmNvZGUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYub3JkZXIoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJvcmRlciJdID0gc2VsZi5vcmRlcigpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5kYXRlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZGF0ZSJdID0gc2VsZi5kYXRlKCk7CiAgICAgICAgCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmV0WyJkYXRlIl0sIGRhdGV0aW1lLmRhdGV0aW1lKToKICAgICAgICAgICAgICAgIHJldFsiZGF0ZSJdID0gcmV0WyJkYXRlIl0uaXNvZm9ybWF0KCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLm5hbWUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJuYW1lIl0gPSBzZWxmLm5hbWUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYucmVtYXJrKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsicmVtYXJrIl0gPSBzZWxmLnJlbWFyaygpOwogICAgICAgIAogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHJldFsicmVtYXJrIl0sIGRpY3QpOgogICAgICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9IHVqc29uLmR1bXBzKHJldFsicmVtYXJrIl0pLmVuY29kZSgndXRmLTgnKTsKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJldFsicmVtYXJrIl0gPSAgdWJpbmFzY2lpLmIyYV9iYXNlNjQocmV0WyJyZW1hcmsiXSkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCk7CiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhjZXB0aW9uIHdpdGggcmVtYXJrOiAiICsgcmV0WyJyZW1hcmsiXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLnZhbHVlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsidmFsdWUiXSA9IHNlbGYudmFsdWUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuZGV2aWNlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZGV2aWNlIl0gPSBzZWxmLmRldmljZSgpLl90b0RvY3VtZW50KCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmF0dHJpYnV0ZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImF0dHJpYnV0ZSJdID0gc2VsZi5hdHRyaWJ1dGUoKS5fdG9Eb2N1bWVudCgpOwogICAgICAgIAogICAgCiAgICAgICAgCiAgICAKCiAgICAgICAgaWYgYkpTT04gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICNwcmludChfX3RvU3RyaW5nICsgIkdPVCBIRVJFIiwgdHlwZShyZXQpLCByZXQpOwogICAgICAgICAgICByZXQgPSB1anNvbi5kdW1wcyhyZXQpOwogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gcmV0OwoKICAgIAogICAgZGVmIHN0b3JlKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdEZXZpY2VfQXR0cmlidXRlOjpzdG9yZSgpOiAnOwogICAgICAgIAogICAgICAgIGFuc3dlciA9IE5vbmU7CgogICAgICAgIF9fcmVzcG9uc2UgPSBFdmVudCgpLmNvZGUoJ1snK25vZGUuY29kZSgpKydAJytzdHIodGltZS50aWNrc19tcygpKSsnXS5EZXZpY2VfQXR0cmlidXRlLnN0b3JlKCknKS5tZXRob2QoJ3N0b3JlJykuY2xhc3NOYW1lKCdEZXZpY2VfQXR0cmlidXRlJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gRGV2aWNlX0F0dHJpYnV0ZSgpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiBmaW5kQWxsKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdEZXZpY2VfQXR0cmlidXRlOjpmaW5kQWxsKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLkRldmljZV9BdHRyaWJ1dGUuZmluZEFsbCgpJykubWV0aG9kKCdmaW5kQWxsJykuY2xhc3NOYW1lKCdEZXZpY2VfQXR0cmlidXRlJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gRGV2aWNlX0F0dHJpYnV0ZSgpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiBmaW5kKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdEZXZpY2VfQXR0cmlidXRlOjpmaW5kKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLkRldmljZV9BdHRyaWJ1dGUuZmluZCgpJykubWV0aG9kKCdmaW5kJykuY2xhc3NOYW1lKCdEZXZpY2VfQXR0cmlidXRlJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gRGV2aWNlX0F0dHJpYnV0ZSgpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKCgpjbGFzcyBUeXBlX0F0dHJpYnV0ZSgpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIElkPU5vbmUsIGFjdGl2ZT1Ob25lLCBlbmFibGVkPU5vbmUsIGNvZGU9Tm9uZSwgb3JkZXI9Tm9uZSwgZGF0ZT1Ob25lLCBuYW1lPU5vbmUsIHJlbWFyaz1Ob25lLCBkZXZpY2VUeXBlPU5vbmUpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKTsKCiAgICAgICAgI3ByaW50KCdUeXBlX0F0dHJpYnV0ZTo6X19pbml0X18oKScpOwogICAgICAgIGlmIElkIGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLklkID0gSWQ7CgogICAgICAgIAogICAgICAgIHNlbGYuYWN0aXZlKGFjdGl2ZSk7CiAgICAgICAgc2VsZi5lbmFibGVkKGVuYWJsZWQpOwogICAgICAgIHNlbGYuY29kZShjb2RlKTsKICAgICAgICBzZWxmLm9yZGVyKG9yZGVyKTsKICAgICAgICBzZWxmLmRhdGUoZGF0ZSk7CiAgICAgICAgc2VsZi5uYW1lKG5hbWUpOwogICAgICAgIHNlbGYucmVtYXJrKHJlbWFyayk7CiAgICAgICAgc2VsZi5kZXZpY2VUeXBlKGRldmljZVR5cGUpOwogICAgICAgIAogICAgSWQgPSBOb25lOwogICAgCiAgICAKICAgICMgYWN0aXZlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfYWN0aXZlID0gTm9uZTsKICAgIGRlZiBhY3RpdmUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2FjdGl2ZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2FjdGl2ZTsKICAgIAogICAgIyBlbmFibGVkOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfZW5hYmxlZCA9IE5vbmU7CiAgICBkZWYgZW5hYmxlZChzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fZW5hYmxlZCA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2VuYWJsZWQ7CiAgICAKICAgICMgY29kZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2NvZGUgPSBOb25lOwogICAgZGVmIGNvZGUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2NvZGUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jb2RlOwogICAgCiAgICAjIG9yZGVyOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfb3JkZXIgPSBOb25lOwogICAgZGVmIG9yZGVyKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9vcmRlciA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX29yZGVyOwogICAgCiAgICAjIGRhdGU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9kYXRlID0gTm9uZTsKICAgIGRlZiBkYXRlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9kYXRlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICBpZiBzZWxmLl9kYXRlPT0ne3tub3d9fSc6CiAgICAgICAgICAgICAgICBzZWxmLl9kYXRlID0gdGltZS50aWNrc19tcygpOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9kYXRlOwogICAgCiAgICAjIG5hbWU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9uYW1lID0gTm9uZTsKICAgIGRlZiBuYW1lKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9uYW1lID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fbmFtZTsKICAgIAogICAgIyByZW1hcms6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9yZW1hcmsgPSBOb25lOwogICAgZGVmIHJlbWFyayhzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fcmVtYXJrID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fcmVtYXJrOwogICAgCiAgICAjIGRldmljZVR5cGU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9kZXZpY2VUeXBlID0gTm9uZTsKICAgIGRlZiBkZXZpY2VUeXBlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9kZXZpY2VUeXBlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZGV2aWNlVHlwZTsKICAgIAogICAgCiAgICAKICAgICMgYXR0cmlidXRlX0RldmljZV9BdHRyaWJ1dGVzOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfYXR0cmlidXRlX0RldmljZV9BdHRyaWJ1dGVzID0gTm9uZTsKICAgIGRlZiBhdHRyaWJ1dGVfRGV2aWNlX0F0dHJpYnV0ZXMoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2F0dHJpYnV0ZV9EZXZpY2VfQXR0cmlidXRlcyA9IGFyZ3NbMF07CiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9hdHRyaWJ1dGVfRGV2aWNlX0F0dHJpYnV0ZXM7CiAgICAKICAgIAogICAgZGVmIF91bmlxdWUoc2VsZik6CiAgICAgICAgX190b1N0cmluZyA9ICdUeXBlX0F0dHJpYnV0ZTo6X3VuaXF1ZSgpOiAnOwogICAgICAgIAogICAgICAgIHJldCA9IFR5cGVfQXR0cmlidXRlKCk7CiAgICAgICAgaWYgc2VsZi5JZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0LklkID0gc2VsZi5JZDsKICAgIAogICAgICAgIGlmIHNlbGYuY29kZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXQuY29kZShzZWxmLmNvZGUoKSk7CiAgICAKICAgICAgICBpZiBzZWxmLmRldmljZVR5cGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0LmRldmljZVR5cGUoc2VsZi5kZXZpY2VUeXBlKCkuX3VuaXF1ZSgpKTsKICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gcmV0OwogICAgCiAgICBkZWYgX2Zyb21Eb2N1bWVudChzZWxmLCBvYmopOgogICAgICAgIF9fdG9TdHJpbmcgPSAnVHlwZV9BdHRyaWJ1dGU6Ol9mcm9tRG9jdW1lbnQoKTogJzsKICAgICAgICAKICAgICAgICBpZiBvYmogaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CgogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBieXRlcyk6CiAgICAgICAgICAgIG9iaiA9IHN0cihvYmosICJ1dGYtOCIpOwoKICAgICAgICBpZiBpc2luc3RhbmNlKG9iaiwgc3RyKSBvciB0eXBlKG9iaikgaXMgc3RyOgogICAgICAgICAgICBpZiByZS5tYXRjaChyIigoKFtBLVphLXpdezMsOX06KD86XC9cLyk/KSg/OlstOzomPVwrXCQsXHddK0ApP1tBLVphLXowLTkuLV0rfCg/Ond3dy58Wy07OiY9XCtcJCxcd10rQClbQS1aYS16MC05Li1dKykoKD86XC9bXCt+JVwvLlx3XC1fXSopP1w/Pyg/OlstXCs9JjslQC5cd19dKikjPyg/Oltcd10qKSk/KSIsIG9iaik6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgb2JqID0gdWpzb24ubG9hZHModXJsbGliMy5Qb29sTWFuYWdlcigpLnJlcXVlc3QoJ0dFVCcsIG9iaikuZGF0YS5kZWNvZGUoJ3V0Zi04JykpOwogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIG9iaiA9IHt9OwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgb2JqID0gdWpzb24ubG9hZHMob2JqKTsKICAgICAgICAKICAgICAgICBpZiBpc2luc3RhbmNlKG9iaiwgbGlzdCk6CiAgICAgICAgICAgIHJldHVybiBbVHlwZV9BdHRyaWJ1dGUoKS5fZnJvbURvY3VtZW50KG8pIGZvciBvIGluIG9ial07CiAgICAgICAgICAgIAogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKG9iaiwgKHN0ciwgYnl0ZXMsIGRpY3QpKToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICd1bmhhbmRsZWQgdHlwZTogJyArIHN0cih0eXBlKG9iaikpKTsKICAgICAgICAgICAgcmV0dXJuIG9iajsKCiAgICAgICAgaWYgJ0lkJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuSWQgPSBvYmpbJ0lkJ107CgogICAgCiAgICAgICAgaWYgJ2FjdGl2ZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmFjdGl2ZShvYmpbJ2FjdGl2ZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdlbmFibGVkJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuZW5hYmxlZChvYmpbJ2VuYWJsZWQnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnY29kZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmNvZGUob2JqWydjb2RlJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ29yZGVyJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYub3JkZXIob2JqWydvcmRlciddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdkYXRlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuZGF0ZShvYmpbJ2RhdGUnXSk7CiAgICAgICAgCiAgICAgICAgICAgIHNlbGYuZGF0ZShkYXRldGltZS5kYXRldGltZS5mcm9taXNvZm9ybWF0KHNlbGYuZGF0ZSgpKSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnbmFtZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLm5hbWUob2JqWyduYW1lJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ3JlbWFyaycgaW4gb2JqOgogICAgICAgICAgICBzZWxmLnJlbWFyayhvYmpbJ3JlbWFyayddKTsKICAgICAgICAKICAgICAgICAgICAgc2VsZi5yZW1hcmsoIHViaW5hc2NpaS5hMmJfYmFzZTY0KHNlbGYucmVtYXJrKCkpICk7CiAgICAgICAgICAgIGlmIHNlbGYucmVtYXJrKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5yZW1hcmsoc2VsZi5yZW1hcmsoKS5kZWNvZGUoJ3V0Zi04Jykuc3RyaXAoKSk7CiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5yZW1hcmsoKTsKICAgICAgICAgICAgICAgICAgICAjcHJpbnQoX190b1N0cmluZyArICJyZW1hcmsgZXhjZXB0aW9uIiwgc2VsZi5yZW1hcmsoKSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZGV2aWNlVHlwZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmRldmljZVR5cGUoRGV2aWNlX1R5cGUoKS5fZnJvbURvY3VtZW50KG9ialsnZGV2aWNlVHlwZSddKSk7CiAgICAgICAgCiAgICAKCiAgICAKICAgICAgICBpZiAnYXR0cmlidXRlX0RldmljZV9BdHRyaWJ1dGVzJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuYXR0cmlidXRlX0RldmljZV9BdHRyaWJ1dGVzKERldmljZV9BdHRyaWJ1dGUoKS5fZnJvbURvY3VtZW50KG9ialsnYXR0cmlidXRlX0RldmljZV9BdHRyaWJ1dGVzJ10pKTsKICAgIAoKICAgICAgICBnYy5jb2xsZWN0KCk7CiAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAKICAgIGRlZiBfdG9Eb2N1bWVudChzZWxmLCBiSlNPTj1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ1R5cGVfQXR0cmlidXRlOjpfdG9Eb2N1bWVudCgpOiAnOwoKICAgICAgICByZXQgPSB7fTsKICAgICAgICBpZiBzZWxmLklkIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIklkIl0gPSBzZWxmLklkOwoKICAgIAogICAgICAgIGlmIHNlbGYuYWN0aXZlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiYWN0aXZlIl0gPSBzZWxmLmFjdGl2ZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5lbmFibGVkKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZW5hYmxlZCJdID0gc2VsZi5lbmFibGVkKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmNvZGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJjb2RlIl0gPSBzZWxmLmNvZGUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYub3JkZXIoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJvcmRlciJdID0gc2VsZi5vcmRlcigpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5kYXRlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZGF0ZSJdID0gc2VsZi5kYXRlKCk7CiAgICAgICAgCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmV0WyJkYXRlIl0sIGRhdGV0aW1lLmRhdGV0aW1lKToKICAgICAgICAgICAgICAgIHJldFsiZGF0ZSJdID0gcmV0WyJkYXRlIl0uaXNvZm9ybWF0KCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLm5hbWUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJuYW1lIl0gPSBzZWxmLm5hbWUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYucmVtYXJrKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsicmVtYXJrIl0gPSBzZWxmLnJlbWFyaygpOwogICAgICAgIAogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHJldFsicmVtYXJrIl0sIGRpY3QpOgogICAgICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9IHVqc29uLmR1bXBzKHJldFsicmVtYXJrIl0pLmVuY29kZSgndXRmLTgnKTsKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJldFsicmVtYXJrIl0gPSAgdWJpbmFzY2lpLmIyYV9iYXNlNjQocmV0WyJyZW1hcmsiXSkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCk7CiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhjZXB0aW9uIHdpdGggcmVtYXJrOiAiICsgcmV0WyJyZW1hcmsiXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmRldmljZVR5cGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJkZXZpY2VUeXBlIl0gPSBzZWxmLmRldmljZVR5cGUoKS5fdG9Eb2N1bWVudCgpOwogICAgICAgIAogICAgCiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmF0dHJpYnV0ZV9EZXZpY2VfQXR0cmlidXRlcygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImF0dHJpYnV0ZV9EZXZpY2VfQXR0cmlidXRlcyJdID0gW3RhLl90b0RvY3VtZW50KCkgZm9yIHRhIGluIHNlbGYuYXR0cmlidXRlX0RldmljZV9BdHRyaWJ1dGVzKCldOwogICAgCgogICAgICAgIGlmIGJKU09OIGlzIG5vdCBOb25lOgogICAgICAgICAgICAjcHJpbnQoX190b1N0cmluZyArICJHT1QgSEVSRSIsIHR5cGUocmV0KSwgcmV0KTsKICAgICAgICAgICAgcmV0ID0gdWpzb24uZHVtcHMocmV0KTsKICAgICAgICBnYy5jb2xsZWN0KCk7CiAgICAgICAgcmV0dXJuIHJldDsKCiAgICAKICAgIGRlZiBzdG9yZShzZWxmLCBfX2V2ZW50PU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnVHlwZV9BdHRyaWJ1dGU6OnN0b3JlKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLlR5cGVfQXR0cmlidXRlLnN0b3JlKCknKS5tZXRob2QoJ3N0b3JlJykuY2xhc3NOYW1lKCdUeXBlX0F0dHJpYnV0ZScpLmNhcnJpZXIobm9kZSkuc2VuZGVyKG5vZGUpLnJlY2lwaWVudChub2RlLnBhcmVudCgpKTsKCiAgICAgICAgZXZKU09OID0gTm9uZTsKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBldkpTT04gPSB1anNvbi5sb2FkcyhfX2V2ZW50LnBheWxvYWQoKSk7CiAgICAgICAgICAgIGlmICdfX3RoaXMnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIHNlbGYuX2Zyb21Eb2N1bWVudChldkpTT05bJ19fdGhpcyddKTsKICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS5yZXNwb25zZVRvKF9fZXZlbnQuX3VuaXF1ZSgpKTsKICAgICAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiIGhhbmRsaW5nIGV2ZW50WyIrX19ldmVudC5jb2RlKCkrIl0iKTsKCiAgICAgICAgCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiYSByZXNwb25zZSB0byBteSBldmVudCgiK19fZXZlbnQucmVzcG9uc2VUbygpLmNvZGUoKSsiKSBbIiArIF9fZXZlbnQuY2xhc3NOYW1lKCkgKyAiKCkuIiArIF9fZXZlbnQubWV0aG9kKCkgKyAiKCldIik7CiAgICAgICAgCiAgICAgICAgICAgIGFuc3dlciA9IFR5cGVfQXR0cmlidXRlKCkuX2Zyb21Eb2N1bWVudChldkpTT04pOwogICAgICAgIAoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4ZWN1dGluZyBsb2NhbGx5Iik7CgoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmUgb3IgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgaWYgYW5zd2VyIGlzIG5vdCBOb25lOgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZChhbnN3ZXIuX3RvRG9jdW1lbnQoKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKHsiX190aGlzIjogc2VsZi5fdG9Eb2N1bWVudCgpfSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS50cmlnZ2VyKCk7CiAgICAgICAgICAgIAoKICAgICAgICByZXR1cm4gYW5zd2VyOwoKICAgIAogICAgZGVmIGZpbmRBbGwoc2VsZiwgX19ldmVudD1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ1R5cGVfQXR0cmlidXRlOjpmaW5kQWxsKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLlR5cGVfQXR0cmlidXRlLmZpbmRBbGwoKScpLm1ldGhvZCgnZmluZEFsbCcpLmNsYXNzTmFtZSgnVHlwZV9BdHRyaWJ1dGUnKS5jYXJyaWVyKG5vZGUpLnNlbmRlcihub2RlKS5yZWNpcGllbnQobm9kZS5wYXJlbnQoKSk7CgogICAgICAgIGV2SlNPTiA9IE5vbmU7CiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgZXZKU09OID0gdWpzb24ubG9hZHMoX19ldmVudC5wYXlsb2FkKCkpOwogICAgICAgICAgICBpZiAnX190aGlzJyBpbiBldkpTT046CiAgICAgICAgICAgICAgICBzZWxmLl9mcm9tRG9jdW1lbnQoZXZKU09OWydfX3RoaXMnXSk7CiAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UucmVzcG9uc2VUbyhfX2V2ZW50Ll91bmlxdWUoKSk7CiAgICAgICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgIiBoYW5kbGluZyBldmVudFsiK19fZXZlbnQuY29kZSgpKyJdIik7CgogICAgICAgIAogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImEgcmVzcG9uc2UgdG8gbXkgZXZlbnQoIitfX2V2ZW50LnJlc3BvbnNlVG8oKS5jb2RlKCkrIikgWyIgKyBfX2V2ZW50LmNsYXNzTmFtZSgpICsgIigpLiIgKyBfX2V2ZW50Lm1ldGhvZCgpICsgIigpXSIpOwogICAgICAgIAogICAgICAgICAgICBhbnN3ZXIgPSBUeXBlX0F0dHJpYnV0ZSgpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiBmaW5kKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdUeXBlX0F0dHJpYnV0ZTo6ZmluZCgpOiAnOwogICAgICAgIAogICAgICAgIGFuc3dlciA9IE5vbmU7CgogICAgICAgIF9fcmVzcG9uc2UgPSBFdmVudCgpLmNvZGUoJ1snK25vZGUuY29kZSgpKydAJytzdHIodGltZS50aWNrc19tcygpKSsnXS5UeXBlX0F0dHJpYnV0ZS5maW5kKCknKS5tZXRob2QoJ2ZpbmQnKS5jbGFzc05hbWUoJ1R5cGVfQXR0cmlidXRlJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gVHlwZV9BdHRyaWJ1dGUoKS5fZnJvbURvY3VtZW50KGV2SlNPTik7CiAgICAgICAgCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhlY3V0aW5nIGxvY2FsbHkiKTsKCgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZSBvciBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBpZiBhbnN3ZXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKGFuc3dlci5fdG9Eb2N1bWVudCgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoeyJfX3RoaXMiOiBzZWxmLl90b0RvY3VtZW50KCl9KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnRyaWdnZXIoKTsKICAgICAgICAgICAgCgogICAgICAgIHJldHVybiBhbnN3ZXI7CgogICAgCgoKY2xhc3MgRGV2aWNlX0NhdGVnb3J5KCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgSWQ9Tm9uZSwgYWN0aXZlPU5vbmUsIGVuYWJsZWQ9Tm9uZSwgY29kZT1Ob25lLCBvcmRlcj1Ob25lLCBkYXRlPU5vbmUsIG5hbWU9Tm9uZSwgcmVtYXJrPU5vbmUsIHBhcmVudD1Ob25lKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCk7CgogICAgICAgICNwcmludCgnRGV2aWNlX0NhdGVnb3J5OjpfX2luaXRfXygpJyk7CiAgICAgICAgaWYgSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHNlbGYuSWQgPSBJZDsKCiAgICAgICAgCiAgICAgICAgc2VsZi5hY3RpdmUoYWN0aXZlKTsKICAgICAgICBzZWxmLmVuYWJsZWQoZW5hYmxlZCk7CiAgICAgICAgc2VsZi5jb2RlKGNvZGUpOwogICAgICAgIHNlbGYub3JkZXIob3JkZXIpOwogICAgICAgIHNlbGYuZGF0ZShkYXRlKTsKICAgICAgICBzZWxmLm5hbWUobmFtZSk7CiAgICAgICAgc2VsZi5yZW1hcmsocmVtYXJrKTsKICAgICAgICBzZWxmLnBhcmVudChwYXJlbnQpOwogICAgICAgIAogICAgSWQgPSBOb25lOwogICAgCiAgICAKICAgICMgYWN0aXZlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfYWN0aXZlID0gTm9uZTsKICAgIGRlZiBhY3RpdmUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2FjdGl2ZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2FjdGl2ZTsKICAgIAogICAgIyBlbmFibGVkOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfZW5hYmxlZCA9IE5vbmU7CiAgICBkZWYgZW5hYmxlZChzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fZW5hYmxlZCA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2VuYWJsZWQ7CiAgICAKICAgICMgY29kZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2NvZGUgPSBOb25lOwogICAgZGVmIGNvZGUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2NvZGUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jb2RlOwogICAgCiAgICAjIG9yZGVyOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfb3JkZXIgPSBOb25lOwogICAgZGVmIG9yZGVyKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9vcmRlciA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX29yZGVyOwogICAgCiAgICAjIGRhdGU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9kYXRlID0gTm9uZTsKICAgIGRlZiBkYXRlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9kYXRlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICBpZiBzZWxmLl9kYXRlPT0ne3tub3d9fSc6CiAgICAgICAgICAgICAgICBzZWxmLl9kYXRlID0gdGltZS50aWNrc19tcygpOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9kYXRlOwogICAgCiAgICAjIG5hbWU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9uYW1lID0gTm9uZTsKICAgIGRlZiBuYW1lKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9uYW1lID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fbmFtZTsKICAgIAogICAgIyByZW1hcms6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9yZW1hcmsgPSBOb25lOwogICAgZGVmIHJlbWFyayhzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fcmVtYXJrID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fcmVtYXJrOwogICAgCiAgICAjIHBhcmVudDogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3BhcmVudCA9IE5vbmU7CiAgICBkZWYgcGFyZW50KHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9wYXJlbnQgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9wYXJlbnQ7CiAgICAKICAgIAogICAgCiAgICAjIHBhcmVudF9EZXZpY2VfQ2F0ZWdvcnlzOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfcGFyZW50X0RldmljZV9DYXRlZ29yeXMgPSBOb25lOwogICAgZGVmIHBhcmVudF9EZXZpY2VfQ2F0ZWdvcnlzKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9wYXJlbnRfRGV2aWNlX0NhdGVnb3J5cyA9IGFyZ3NbMF07CiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9wYXJlbnRfRGV2aWNlX0NhdGVnb3J5czsKICAgIAogICAgIyBjYXRlZ29yeV9EZXZpY2VfVHlwZXM6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9jYXRlZ29yeV9EZXZpY2VfVHlwZXMgPSBOb25lOwogICAgZGVmIGNhdGVnb3J5X0RldmljZV9UeXBlcyhzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fY2F0ZWdvcnlfRGV2aWNlX1R5cGVzID0gYXJnc1swXTsKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NhdGVnb3J5X0RldmljZV9UeXBlczsKICAgIAogICAgCiAgICBkZWYgX3VuaXF1ZShzZWxmKToKICAgICAgICBfX3RvU3RyaW5nID0gJ0RldmljZV9DYXRlZ29yeTo6X3VuaXF1ZSgpOiAnOwogICAgICAgIAogICAgICAgIHJldCA9IERldmljZV9DYXRlZ29yeSgpOwogICAgICAgIGlmIHNlbGYuSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldC5JZCA9IHNlbGYuSWQ7CiAgICAKICAgICAgICBpZiBzZWxmLmNvZGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0LmNvZGUoc2VsZi5jb2RlKCkpOwogICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwogICAgICAgIHJldHVybiByZXQ7CiAgICAKICAgIGRlZiBfZnJvbURvY3VtZW50KHNlbGYsIG9iaik6CiAgICAgICAgX190b1N0cmluZyA9ICdEZXZpY2VfQ2F0ZWdvcnk6Ol9mcm9tRG9jdW1lbnQoKTogJzsKICAgICAgICAKICAgICAgICBpZiBvYmogaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CgogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBieXRlcyk6CiAgICAgICAgICAgIG9iaiA9IHN0cihvYmosICJ1dGYtOCIpOwoKICAgICAgICBpZiBpc2luc3RhbmNlKG9iaiwgc3RyKSBvciB0eXBlKG9iaikgaXMgc3RyOgogICAgICAgICAgICBpZiByZS5tYXRjaChyIigoKFtBLVphLXpdezMsOX06KD86XC9cLyk/KSg/OlstOzomPVwrXCQsXHddK0ApP1tBLVphLXowLTkuLV0rfCg/Ond3dy58Wy07OiY9XCtcJCxcd10rQClbQS1aYS16MC05Li1dKykoKD86XC9bXCt+JVwvLlx3XC1fXSopP1w/Pyg/OlstXCs9JjslQC5cd19dKikjPyg/Oltcd10qKSk/KSIsIG9iaik6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgb2JqID0gdWpzb24ubG9hZHModXJsbGliMy5Qb29sTWFuYWdlcigpLnJlcXVlc3QoJ0dFVCcsIG9iaikuZGF0YS5kZWNvZGUoJ3V0Zi04JykpOwogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIG9iaiA9IHt9OwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgb2JqID0gdWpzb24ubG9hZHMob2JqKTsKICAgICAgICAKICAgICAgICBpZiBpc2luc3RhbmNlKG9iaiwgbGlzdCk6CiAgICAgICAgICAgIHJldHVybiBbRGV2aWNlX0NhdGVnb3J5KCkuX2Zyb21Eb2N1bWVudChvKSBmb3IgbyBpbiBvYmpdOwogICAgICAgICAgICAKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShvYmosIChzdHIsIGJ5dGVzLCBkaWN0KSk6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAndW5oYW5kbGVkIHR5cGU6ICcgKyBzdHIodHlwZShvYmopKSk7CiAgICAgICAgICAgIHJldHVybiBvYmo7CgogICAgICAgIGlmICdJZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLklkID0gb2JqWydJZCddOwoKICAgIAogICAgICAgIGlmICdhY3RpdmUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5hY3RpdmUob2JqWydhY3RpdmUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZW5hYmxlZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmVuYWJsZWQob2JqWydlbmFibGVkJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2NvZGUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5jb2RlKG9ialsnY29kZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdvcmRlcicgaW4gb2JqOgogICAgICAgICAgICBzZWxmLm9yZGVyKG9ialsnb3JkZXInXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZGF0ZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmRhdGUob2JqWydkYXRlJ10pOwogICAgICAgIAogICAgICAgICAgICBzZWxmLmRhdGUoZGF0ZXRpbWUuZGF0ZXRpbWUuZnJvbWlzb2Zvcm1hdChzZWxmLmRhdGUoKSkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ25hbWUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5uYW1lKG9ialsnbmFtZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdyZW1hcmsnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5yZW1hcmsob2JqWydyZW1hcmsnXSk7CiAgICAgICAgCiAgICAgICAgICAgIHNlbGYucmVtYXJrKCB1YmluYXNjaWkuYTJiX2Jhc2U2NChzZWxmLnJlbWFyaygpKSApOwogICAgICAgICAgICBpZiBzZWxmLnJlbWFyaygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVtYXJrKHNlbGYucmVtYXJrKCkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCkpOwogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVtYXJrKCk7CiAgICAgICAgICAgICAgICAgICAgI3ByaW50KF9fdG9TdHJpbmcgKyAicmVtYXJrIGV4Y2VwdGlvbiIsIHNlbGYucmVtYXJrKCkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ3BhcmVudCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLnBhcmVudChEZXZpY2VfQ2F0ZWdvcnkoKS5fZnJvbURvY3VtZW50KG9ialsncGFyZW50J10pKTsKICAgICAgICAKICAgIAoKICAgIAogICAgICAgIGlmICdwYXJlbnRfRGV2aWNlX0NhdGVnb3J5cycgaW4gb2JqOgogICAgICAgICAgICBzZWxmLnBhcmVudF9EZXZpY2VfQ2F0ZWdvcnlzKERldmljZV9DYXRlZ29yeSgpLl9mcm9tRG9jdW1lbnQob2JqWydwYXJlbnRfRGV2aWNlX0NhdGVnb3J5cyddKSk7CiAgICAKICAgICAgICBpZiAnY2F0ZWdvcnlfRGV2aWNlX1R5cGVzJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuY2F0ZWdvcnlfRGV2aWNlX1R5cGVzKERldmljZV9UeXBlKCkuX2Zyb21Eb2N1bWVudChvYmpbJ2NhdGVnb3J5X0RldmljZV9UeXBlcyddKSk7CiAgICAKCiAgICAgICAgZ2MuY29sbGVjdCgpOwogICAgICAgIHJldHVybiBzZWxmOwogICAgCiAgICBkZWYgX3RvRG9jdW1lbnQoc2VsZiwgYkpTT049Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdEZXZpY2VfQ2F0ZWdvcnk6Ol90b0RvY3VtZW50KCk6ICc7CgogICAgICAgIHJldCA9IHt9OwogICAgICAgIGlmIHNlbGYuSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiSWQiXSA9IHNlbGYuSWQ7CgogICAgCiAgICAgICAgaWYgc2VsZi5hY3RpdmUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJhY3RpdmUiXSA9IHNlbGYuYWN0aXZlKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmVuYWJsZWQoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJlbmFibGVkIl0gPSBzZWxmLmVuYWJsZWQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuY29kZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImNvZGUiXSA9IHNlbGYuY29kZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5vcmRlcigpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIm9yZGVyIl0gPSBzZWxmLm9yZGVyKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmRhdGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJkYXRlIl0gPSBzZWxmLmRhdGUoKTsKICAgICAgICAKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXRbImRhdGUiXSwgZGF0ZXRpbWUuZGF0ZXRpbWUpOgogICAgICAgICAgICAgICAgcmV0WyJkYXRlIl0gPSByZXRbImRhdGUiXS5pc29mb3JtYXQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYubmFtZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIm5hbWUiXSA9IHNlbGYubmFtZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5yZW1hcmsoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9IHNlbGYucmVtYXJrKCk7CiAgICAgICAgCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmV0WyJyZW1hcmsiXSwgZGljdCk6CiAgICAgICAgICAgICAgICByZXRbInJlbWFyayJdID0gdWpzb24uZHVtcHMocmV0WyJyZW1hcmsiXSkuZW5jb2RlKCd1dGYtOCcpOwoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9ICB1YmluYXNjaWkuYjJhX2Jhc2U2NChyZXRbInJlbWFyayJdKS5kZWNvZGUoJ3V0Zi04Jykuc3RyaXAoKTsKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGNlcHRpb24gd2l0aCByZW1hcms6ICIgKyByZXRbInJlbWFyayJdKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYucGFyZW50KCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsicGFyZW50Il0gPSBzZWxmLnBhcmVudCgpLl90b0RvY3VtZW50KCk7CiAgICAgICAgCiAgICAKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYucGFyZW50X0RldmljZV9DYXRlZ29yeXMoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJwYXJlbnRfRGV2aWNlX0NhdGVnb3J5cyJdID0gW3RhLl90b0RvY3VtZW50KCkgZm9yIHRhIGluIHNlbGYucGFyZW50X0RldmljZV9DYXRlZ29yeXMoKV07CiAgICAKICAgICAgICBpZiBzZWxmLmNhdGVnb3J5X0RldmljZV9UeXBlcygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImNhdGVnb3J5X0RldmljZV9UeXBlcyJdID0gW3RhLl90b0RvY3VtZW50KCkgZm9yIHRhIGluIHNlbGYuY2F0ZWdvcnlfRGV2aWNlX1R5cGVzKCldOwogICAgCgogICAgICAgIGlmIGJKU09OIGlzIG5vdCBOb25lOgogICAgICAgICAgICAjcHJpbnQoX190b1N0cmluZyArICJHT1QgSEVSRSIsIHR5cGUocmV0KSwgcmV0KTsKICAgICAgICAgICAgcmV0ID0gdWpzb24uZHVtcHMocmV0KTsKICAgICAgICBnYy5jb2xsZWN0KCk7CiAgICAgICAgcmV0dXJuIHJldDsKCiAgICAKICAgIGRlZiBzdG9yZShzZWxmLCBfX2V2ZW50PU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnRGV2aWNlX0NhdGVnb3J5OjpzdG9yZSgpOiAnOwogICAgICAgIAogICAgICAgIGFuc3dlciA9IE5vbmU7CgogICAgICAgIF9fcmVzcG9uc2UgPSBFdmVudCgpLmNvZGUoJ1snK25vZGUuY29kZSgpKydAJytzdHIodGltZS50aWNrc19tcygpKSsnXS5EZXZpY2VfQ2F0ZWdvcnkuc3RvcmUoKScpLm1ldGhvZCgnc3RvcmUnKS5jbGFzc05hbWUoJ0RldmljZV9DYXRlZ29yeScpLmNhcnJpZXIobm9kZSkuc2VuZGVyKG5vZGUpLnJlY2lwaWVudChub2RlLnBhcmVudCgpKTsKCiAgICAgICAgZXZKU09OID0gTm9uZTsKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBldkpTT04gPSB1anNvbi5sb2FkcyhfX2V2ZW50LnBheWxvYWQoKSk7CiAgICAgICAgICAgIGlmICdfX3RoaXMnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIHNlbGYuX2Zyb21Eb2N1bWVudChldkpTT05bJ19fdGhpcyddKTsKICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS5yZXNwb25zZVRvKF9fZXZlbnQuX3VuaXF1ZSgpKTsKICAgICAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiIGhhbmRsaW5nIGV2ZW50WyIrX19ldmVudC5jb2RlKCkrIl0iKTsKCiAgICAgICAgCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiYSByZXNwb25zZSB0byBteSBldmVudCgiK19fZXZlbnQucmVzcG9uc2VUbygpLmNvZGUoKSsiKSBbIiArIF9fZXZlbnQuY2xhc3NOYW1lKCkgKyAiKCkuIiArIF9fZXZlbnQubWV0aG9kKCkgKyAiKCldIik7CiAgICAgICAgCiAgICAgICAgICAgIGFuc3dlciA9IERldmljZV9DYXRlZ29yeSgpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiBmaW5kQWxsKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdEZXZpY2VfQ2F0ZWdvcnk6OmZpbmRBbGwoKTogJzsKICAgICAgICAKICAgICAgICBhbnN3ZXIgPSBOb25lOwoKICAgICAgICBfX3Jlc3BvbnNlID0gRXZlbnQoKS5jb2RlKCdbJytub2RlLmNvZGUoKSsnQCcrc3RyKHRpbWUudGlja3NfbXMoKSkrJ10uRGV2aWNlX0NhdGVnb3J5LmZpbmRBbGwoKScpLm1ldGhvZCgnZmluZEFsbCcpLmNsYXNzTmFtZSgnRGV2aWNlX0NhdGVnb3J5JykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gRGV2aWNlX0NhdGVnb3J5KCkuX2Zyb21Eb2N1bWVudChldkpTT04pOwogICAgICAgIAoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4ZWN1dGluZyBsb2NhbGx5Iik7CgoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmUgb3IgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgaWYgYW5zd2VyIGlzIG5vdCBOb25lOgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZChhbnN3ZXIuX3RvRG9jdW1lbnQoKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKHsiX190aGlzIjogc2VsZi5fdG9Eb2N1bWVudCgpfSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS50cmlnZ2VyKCk7CiAgICAgICAgICAgIAoKICAgICAgICByZXR1cm4gYW5zd2VyOwoKICAgIAogICAgZGVmIGZpbmQoc2VsZiwgX19ldmVudD1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ0RldmljZV9DYXRlZ29yeTo6ZmluZCgpOiAnOwogICAgICAgIAogICAgICAgIGFuc3dlciA9IE5vbmU7CgogICAgICAgIF9fcmVzcG9uc2UgPSBFdmVudCgpLmNvZGUoJ1snK25vZGUuY29kZSgpKydAJytzdHIodGltZS50aWNrc19tcygpKSsnXS5EZXZpY2VfQ2F0ZWdvcnkuZmluZCgpJykubWV0aG9kKCdmaW5kJykuY2xhc3NOYW1lKCdEZXZpY2VfQ2F0ZWdvcnknKS5jYXJyaWVyKG5vZGUpLnNlbmRlcihub2RlKS5yZWNpcGllbnQobm9kZS5wYXJlbnQoKSk7CgogICAgICAgIGV2SlNPTiA9IE5vbmU7CiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgZXZKU09OID0gdWpzb24ubG9hZHMoX19ldmVudC5wYXlsb2FkKCkpOwogICAgICAgICAgICBpZiAnX190aGlzJyBpbiBldkpTT046CiAgICAgICAgICAgICAgICBzZWxmLl9mcm9tRG9jdW1lbnQoZXZKU09OWydfX3RoaXMnXSk7CiAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UucmVzcG9uc2VUbyhfX2V2ZW50Ll91bmlxdWUoKSk7CiAgICAgICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgIiBoYW5kbGluZyBldmVudFsiK19fZXZlbnQuY29kZSgpKyJdIik7CgogICAgICAgIAogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImEgcmVzcG9uc2UgdG8gbXkgZXZlbnQoIitfX2V2ZW50LnJlc3BvbnNlVG8oKS5jb2RlKCkrIikgWyIgKyBfX2V2ZW50LmNsYXNzTmFtZSgpICsgIigpLiIgKyBfX2V2ZW50Lm1ldGhvZCgpICsgIigpXSIpOwogICAgICAgIAogICAgICAgICAgICBhbnN3ZXIgPSBEZXZpY2VfQ2F0ZWdvcnkoKS5fZnJvbURvY3VtZW50KGV2SlNPTik7CiAgICAgICAgCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhlY3V0aW5nIGxvY2FsbHkiKTsKCgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZSBvciBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBpZiBhbnN3ZXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKGFuc3dlci5fdG9Eb2N1bWVudCgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoeyJfX3RoaXMiOiBzZWxmLl90b0RvY3VtZW50KCl9KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnRyaWdnZXIoKTsKICAgICAgICAgICAgCgogICAgICAgIHJldHVybiBhbnN3ZXI7CgogICAgCgoKY2xhc3MgRGV2aWNlX1R5cGUoKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBJZD1Ob25lLCBhY3RpdmU9Tm9uZSwgZW5hYmxlZD1Ob25lLCBjb2RlPU5vbmUsIG9yZGVyPU5vbmUsIGRhdGU9Tm9uZSwgbmFtZT1Ob25lLCByZW1hcms9Tm9uZSwgY2F0ZWdvcnk9Tm9uZSk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygpOwoKICAgICAgICAjcHJpbnQoJ0RldmljZV9UeXBlOjpfX2luaXRfXygpJyk7CiAgICAgICAgaWYgSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHNlbGYuSWQgPSBJZDsKCiAgICAgICAgCiAgICAgICAgc2VsZi5hY3RpdmUoYWN0aXZlKTsKICAgICAgICBzZWxmLmVuYWJsZWQoZW5hYmxlZCk7CiAgICAgICAgc2VsZi5jb2RlKGNvZGUpOwogICAgICAgIHNlbGYub3JkZXIob3JkZXIpOwogICAgICAgIHNlbGYuZGF0ZShkYXRlKTsKICAgICAgICBzZWxmLm5hbWUobmFtZSk7CiAgICAgICAgc2VsZi5yZW1hcmsocmVtYXJrKTsKICAgICAgICBzZWxmLmNhdGVnb3J5KGNhdGVnb3J5KTsKICAgICAgICAKICAgIElkID0gTm9uZTsKICAgIAogICAgCiAgICAjIGFjdGl2ZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2FjdGl2ZSA9IE5vbmU7CiAgICBkZWYgYWN0aXZlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9hY3RpdmUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9hY3RpdmU7CiAgICAKICAgICMgZW5hYmxlZDogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2VuYWJsZWQgPSBOb25lOwogICAgZGVmIGVuYWJsZWQoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2VuYWJsZWQgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9lbmFibGVkOwogICAgCiAgICAjIGNvZGU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9jb2RlID0gTm9uZTsKICAgIGRlZiBjb2RlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9jb2RlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fY29kZTsKICAgIAogICAgIyBvcmRlcjogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX29yZGVyID0gTm9uZTsKICAgIGRlZiBvcmRlcihzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fb3JkZXIgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9vcmRlcjsKICAgIAogICAgIyBkYXRlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfZGF0ZSA9IE5vbmU7CiAgICBkZWYgZGF0ZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fZGF0ZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgaWYgc2VsZi5fZGF0ZT09J3t7bm93fX0nOgogICAgICAgICAgICAgICAgc2VsZi5fZGF0ZSA9IHRpbWUudGlja3NfbXMoKTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZGF0ZTsKICAgIAogICAgIyBuYW1lOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfbmFtZSA9IE5vbmU7CiAgICBkZWYgbmFtZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fbmFtZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX25hbWU7CiAgICAKICAgICMgcmVtYXJrOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfcmVtYXJrID0gTm9uZTsKICAgIGRlZiByZW1hcmsoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX3JlbWFyayA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3JlbWFyazsKICAgIAogICAgIyBjYXRlZ29yeTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2NhdGVnb3J5ID0gTm9uZTsKICAgIGRlZiBjYXRlZ29yeShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fY2F0ZWdvcnkgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jYXRlZ29yeTsKICAgIAogICAgCiAgICAKICAgICMgZGV2aWNlVHlwZV9NZXRyaWNzOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfZGV2aWNlVHlwZV9NZXRyaWNzID0gTm9uZTsKICAgIGRlZiBkZXZpY2VUeXBlX01ldHJpY3Moc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2RldmljZVR5cGVfTWV0cmljcyA9IGFyZ3NbMF07CiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9kZXZpY2VUeXBlX01ldHJpY3M7CiAgICAKICAgICMgdHlwZV9EZXZpY2VzOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfdHlwZV9EZXZpY2VzID0gTm9uZTsKICAgIGRlZiB0eXBlX0RldmljZXMoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX3R5cGVfRGV2aWNlcyA9IGFyZ3NbMF07CiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl90eXBlX0RldmljZXM7CiAgICAKICAgICMgZGV2aWNlVHlwZV9UeXBlX0F0dHJpYnV0ZXM6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9kZXZpY2VUeXBlX1R5cGVfQXR0cmlidXRlcyA9IE5vbmU7CiAgICBkZWYgZGV2aWNlVHlwZV9UeXBlX0F0dHJpYnV0ZXMoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2RldmljZVR5cGVfVHlwZV9BdHRyaWJ1dGVzID0gYXJnc1swXTsKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2RldmljZVR5cGVfVHlwZV9BdHRyaWJ1dGVzOwogICAgCiAgICAKICAgIGRlZiBfdW5pcXVlKHNlbGYpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnRGV2aWNlX1R5cGU6Ol91bmlxdWUoKTogJzsKICAgICAgICAKICAgICAgICByZXQgPSBEZXZpY2VfVHlwZSgpOwogICAgICAgIGlmIHNlbGYuSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldC5JZCA9IHNlbGYuSWQ7CiAgICAKICAgICAgICBpZiBzZWxmLmNvZGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0LmNvZGUoc2VsZi5jb2RlKCkpOwogICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwogICAgICAgIHJldHVybiByZXQ7CiAgICAKICAgIGRlZiBfZnJvbURvY3VtZW50KHNlbGYsIG9iaik6CiAgICAgICAgX190b1N0cmluZyA9ICdEZXZpY2VfVHlwZTo6X2Zyb21Eb2N1bWVudCgpOiAnOwogICAgICAgIAogICAgICAgIGlmIG9iaiBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gc2VsZjsKCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIGJ5dGVzKToKICAgICAgICAgICAgb2JqID0gc3RyKG9iaiwgInV0Zi04Iik7CgogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBzdHIpIG9yIHR5cGUob2JqKSBpcyBzdHI6CiAgICAgICAgICAgIGlmIHJlLm1hdGNoKHIiKCgoW0EtWmEtel17Myw5fTooPzpcL1wvKT8pKD86Wy07OiY9XCtcJCxcd10rQCk/W0EtWmEtejAtOS4tXSt8KD86d3d3LnxbLTs6Jj1cK1wkLFx3XStAKVtBLVphLXowLTkuLV0rKSgoPzpcL1tcK34lXC8uXHdcLV9dKik/XD8/KD86Wy1cKz0mOyVALlx3X10qKSM/KD86W1x3XSopKT8pIiwgb2JqKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBvYmogPSB1anNvbi5sb2Fkcyh1cmxsaWIzLlBvb2xNYW5hZ2VyKCkucmVxdWVzdCgnR0VUJywgb2JqKS5kYXRhLmRlY29kZSgndXRmLTgnKSk7CiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgb2JqID0ge307CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBvYmogPSB1anNvbi5sb2FkcyhvYmopOwogICAgICAgIAogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBsaXN0KToKICAgICAgICAgICAgcmV0dXJuIFtEZXZpY2VfVHlwZSgpLl9mcm9tRG9jdW1lbnQobykgZm9yIG8gaW4gb2JqXTsKICAgICAgICAgICAgCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2Uob2JqLCAoc3RyLCBieXRlcywgZGljdCkpOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgJ3VuaGFuZGxlZCB0eXBlOiAnICsgc3RyKHR5cGUob2JqKSkpOwogICAgICAgICAgICByZXR1cm4gb2JqOwoKICAgICAgICBpZiAnSWQnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5JZCA9IG9ialsnSWQnXTsKCiAgICAKICAgICAgICBpZiAnYWN0aXZlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuYWN0aXZlKG9ialsnYWN0aXZlJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2VuYWJsZWQnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5lbmFibGVkKG9ialsnZW5hYmxlZCddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdjb2RlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuY29kZShvYmpbJ2NvZGUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnb3JkZXInIGluIG9iajoKICAgICAgICAgICAgc2VsZi5vcmRlcihvYmpbJ29yZGVyJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2RhdGUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5kYXRlKG9ialsnZGF0ZSddKTsKICAgICAgICAKICAgICAgICAgICAgc2VsZi5kYXRlKGRhdGV0aW1lLmRhdGV0aW1lLmZyb21pc29mb3JtYXQoc2VsZi5kYXRlKCkpKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICduYW1lJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYubmFtZShvYmpbJ25hbWUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAncmVtYXJrJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYucmVtYXJrKG9ialsncmVtYXJrJ10pOwogICAgICAgIAogICAgICAgICAgICBzZWxmLnJlbWFyayggdWJpbmFzY2lpLmEyYl9iYXNlNjQoc2VsZi5yZW1hcmsoKSkgKTsKICAgICAgICAgICAgaWYgc2VsZi5yZW1hcmsoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbWFyayhzZWxmLnJlbWFyaygpLmRlY29kZSgndXRmLTgnKS5zdHJpcCgpKTsKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbWFyaygpOwogICAgICAgICAgICAgICAgICAgICNwcmludChfX3RvU3RyaW5nICsgInJlbWFyayBleGNlcHRpb24iLCBzZWxmLnJlbWFyaygpKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdjYXRlZ29yeScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmNhdGVnb3J5KERldmljZV9DYXRlZ29yeSgpLl9mcm9tRG9jdW1lbnQob2JqWydjYXRlZ29yeSddKSk7CiAgICAgICAgCiAgICAKCiAgICAKICAgICAgICBpZiAnZGV2aWNlVHlwZV9NZXRyaWNzJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuZGV2aWNlVHlwZV9NZXRyaWNzKE1ldHJpYygpLl9mcm9tRG9jdW1lbnQob2JqWydkZXZpY2VUeXBlX01ldHJpY3MnXSkpOwogICAgCiAgICAgICAgaWYgJ3R5cGVfRGV2aWNlcycgaW4gb2JqOgogICAgICAgICAgICBzZWxmLnR5cGVfRGV2aWNlcyhEZXZpY2UoKS5fZnJvbURvY3VtZW50KG9ialsndHlwZV9EZXZpY2VzJ10pKTsKICAgIAogICAgICAgIGlmICdkZXZpY2VUeXBlX1R5cGVfQXR0cmlidXRlcycgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmRldmljZVR5cGVfVHlwZV9BdHRyaWJ1dGVzKFR5cGVfQXR0cmlidXRlKCkuX2Zyb21Eb2N1bWVudChvYmpbJ2RldmljZVR5cGVfVHlwZV9BdHRyaWJ1dGVzJ10pKTsKICAgIAoKICAgICAgICBnYy5jb2xsZWN0KCk7CiAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAKICAgIGRlZiBfdG9Eb2N1bWVudChzZWxmLCBiSlNPTj1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ0RldmljZV9UeXBlOjpfdG9Eb2N1bWVudCgpOiAnOwoKICAgICAgICByZXQgPSB7fTsKICAgICAgICBpZiBzZWxmLklkIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIklkIl0gPSBzZWxmLklkOwoKICAgIAogICAgICAgIGlmIHNlbGYuYWN0aXZlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiYWN0aXZlIl0gPSBzZWxmLmFjdGl2ZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5lbmFibGVkKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZW5hYmxlZCJdID0gc2VsZi5lbmFibGVkKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmNvZGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJjb2RlIl0gPSBzZWxmLmNvZGUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYub3JkZXIoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJvcmRlciJdID0gc2VsZi5vcmRlcigpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5kYXRlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZGF0ZSJdID0gc2VsZi5kYXRlKCk7CiAgICAgICAgCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmV0WyJkYXRlIl0sIGRhdGV0aW1lLmRhdGV0aW1lKToKICAgICAgICAgICAgICAgIHJldFsiZGF0ZSJdID0gcmV0WyJkYXRlIl0uaXNvZm9ybWF0KCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLm5hbWUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJuYW1lIl0gPSBzZWxmLm5hbWUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYucmVtYXJrKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsicmVtYXJrIl0gPSBzZWxmLnJlbWFyaygpOwogICAgICAgIAogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHJldFsicmVtYXJrIl0sIGRpY3QpOgogICAgICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9IHVqc29uLmR1bXBzKHJldFsicmVtYXJrIl0pLmVuY29kZSgndXRmLTgnKTsKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJldFsicmVtYXJrIl0gPSAgdWJpbmFzY2lpLmIyYV9iYXNlNjQocmV0WyJyZW1hcmsiXSkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCk7CiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhjZXB0aW9uIHdpdGggcmVtYXJrOiAiICsgcmV0WyJyZW1hcmsiXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmNhdGVnb3J5KCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiY2F0ZWdvcnkiXSA9IHNlbGYuY2F0ZWdvcnkoKS5fdG9Eb2N1bWVudCgpOwogICAgICAgIAogICAgCiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmRldmljZVR5cGVfTWV0cmljcygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImRldmljZVR5cGVfTWV0cmljcyJdID0gW3RhLl90b0RvY3VtZW50KCkgZm9yIHRhIGluIHNlbGYuZGV2aWNlVHlwZV9NZXRyaWNzKCldOwogICAgCiAgICAgICAgaWYgc2VsZi50eXBlX0RldmljZXMoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJ0eXBlX0RldmljZXMiXSA9IFt0YS5fdG9Eb2N1bWVudCgpIGZvciB0YSBpbiBzZWxmLnR5cGVfRGV2aWNlcygpXTsKICAgIAogICAgICAgIGlmIHNlbGYuZGV2aWNlVHlwZV9UeXBlX0F0dHJpYnV0ZXMoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJkZXZpY2VUeXBlX1R5cGVfQXR0cmlidXRlcyJdID0gW3RhLl90b0RvY3VtZW50KCkgZm9yIHRhIGluIHNlbGYuZGV2aWNlVHlwZV9UeXBlX0F0dHJpYnV0ZXMoKV07CiAgICAKCiAgICAgICAgaWYgYkpTT04gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICNwcmludChfX3RvU3RyaW5nICsgIkdPVCBIRVJFIiwgdHlwZShyZXQpLCByZXQpOwogICAgICAgICAgICByZXQgPSB1anNvbi5kdW1wcyhyZXQpOwogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gcmV0OwoKICAgIAogICAgZGVmIHN0b3JlKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdEZXZpY2VfVHlwZTo6c3RvcmUoKTogJzsKICAgICAgICAKICAgICAgICBhbnN3ZXIgPSBOb25lOwoKICAgICAgICBfX3Jlc3BvbnNlID0gRXZlbnQoKS5jb2RlKCdbJytub2RlLmNvZGUoKSsnQCcrc3RyKHRpbWUudGlja3NfbXMoKSkrJ10uRGV2aWNlX1R5cGUuc3RvcmUoKScpLm1ldGhvZCgnc3RvcmUnKS5jbGFzc05hbWUoJ0RldmljZV9UeXBlJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gRGV2aWNlX1R5cGUoKS5fZnJvbURvY3VtZW50KGV2SlNPTik7CiAgICAgICAgCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhlY3V0aW5nIGxvY2FsbHkiKTsKCgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZSBvciBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBpZiBhbnN3ZXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKGFuc3dlci5fdG9Eb2N1bWVudCgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoeyJfX3RoaXMiOiBzZWxmLl90b0RvY3VtZW50KCl9KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnRyaWdnZXIoKTsKICAgICAgICAgICAgCgogICAgICAgIHJldHVybiBhbnN3ZXI7CgogICAgCiAgICBkZWYgZmluZEFsbChzZWxmLCBfX2V2ZW50PU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnRGV2aWNlX1R5cGU6OmZpbmRBbGwoKTogJzsKICAgICAgICAKICAgICAgICBhbnN3ZXIgPSBOb25lOwoKICAgICAgICBfX3Jlc3BvbnNlID0gRXZlbnQoKS5jb2RlKCdbJytub2RlLmNvZGUoKSsnQCcrc3RyKHRpbWUudGlja3NfbXMoKSkrJ10uRGV2aWNlX1R5cGUuZmluZEFsbCgpJykubWV0aG9kKCdmaW5kQWxsJykuY2xhc3NOYW1lKCdEZXZpY2VfVHlwZScpLmNhcnJpZXIobm9kZSkuc2VuZGVyKG5vZGUpLnJlY2lwaWVudChub2RlLnBhcmVudCgpKTsKCiAgICAgICAgZXZKU09OID0gTm9uZTsKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBldkpTT04gPSB1anNvbi5sb2FkcyhfX2V2ZW50LnBheWxvYWQoKSk7CiAgICAgICAgICAgIGlmICdfX3RoaXMnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIHNlbGYuX2Zyb21Eb2N1bWVudChldkpTT05bJ19fdGhpcyddKTsKICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS5yZXNwb25zZVRvKF9fZXZlbnQuX3VuaXF1ZSgpKTsKICAgICAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiIGhhbmRsaW5nIGV2ZW50WyIrX19ldmVudC5jb2RlKCkrIl0iKTsKCiAgICAgICAgCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiYSByZXNwb25zZSB0byBteSBldmVudCgiK19fZXZlbnQucmVzcG9uc2VUbygpLmNvZGUoKSsiKSBbIiArIF9fZXZlbnQuY2xhc3NOYW1lKCkgKyAiKCkuIiArIF9fZXZlbnQubWV0aG9kKCkgKyAiKCldIik7CiAgICAgICAgCiAgICAgICAgICAgIGFuc3dlciA9IERldmljZV9UeXBlKCkuX2Zyb21Eb2N1bWVudChldkpTT04pOwogICAgICAgIAoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4ZWN1dGluZyBsb2NhbGx5Iik7CgoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmUgb3IgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgaWYgYW5zd2VyIGlzIG5vdCBOb25lOgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZChhbnN3ZXIuX3RvRG9jdW1lbnQoKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKHsiX190aGlzIjogc2VsZi5fdG9Eb2N1bWVudCgpfSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS50cmlnZ2VyKCk7CiAgICAgICAgICAgIAoKICAgICAgICByZXR1cm4gYW5zd2VyOwoKICAgIAogICAgZGVmIGZpbmQoc2VsZiwgX19ldmVudD1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ0RldmljZV9UeXBlOjpmaW5kKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLkRldmljZV9UeXBlLmZpbmQoKScpLm1ldGhvZCgnZmluZCcpLmNsYXNzTmFtZSgnRGV2aWNlX1R5cGUnKS5jYXJyaWVyKG5vZGUpLnNlbmRlcihub2RlKS5yZWNpcGllbnQobm9kZS5wYXJlbnQoKSk7CgogICAgICAgIGV2SlNPTiA9IE5vbmU7CiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgZXZKU09OID0gdWpzb24ubG9hZHMoX19ldmVudC5wYXlsb2FkKCkpOwogICAgICAgICAgICBpZiAnX190aGlzJyBpbiBldkpTT046CiAgICAgICAgICAgICAgICBzZWxmLl9mcm9tRG9jdW1lbnQoZXZKU09OWydfX3RoaXMnXSk7CiAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UucmVzcG9uc2VUbyhfX2V2ZW50Ll91bmlxdWUoKSk7CiAgICAgICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgIiBoYW5kbGluZyBldmVudFsiK19fZXZlbnQuY29kZSgpKyJdIik7CgogICAgICAgIAogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImEgcmVzcG9uc2UgdG8gbXkgZXZlbnQoIitfX2V2ZW50LnJlc3BvbnNlVG8oKS5jb2RlKCkrIikgWyIgKyBfX2V2ZW50LmNsYXNzTmFtZSgpICsgIigpLiIgKyBfX2V2ZW50Lm1ldGhvZCgpICsgIigpXSIpOwogICAgICAgIAogICAgICAgICAgICBhbnN3ZXIgPSBEZXZpY2VfVHlwZSgpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKCgpjbGFzcyBNZXRyaWNfR3JvdXAoKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBJZD1Ob25lLCBhY3RpdmU9Tm9uZSwgZW5hYmxlZD1Ob25lLCBjb2RlPU5vbmUsIG9yZGVyPU5vbmUsIGRhdGU9Tm9uZSwgbmFtZT1Ob25lLCByZW1hcms9Tm9uZSk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygpOwoKICAgICAgICAjcHJpbnQoJ01ldHJpY19Hcm91cDo6X19pbml0X18oKScpOwogICAgICAgIGlmIElkIGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLklkID0gSWQ7CgogICAgICAgIAogICAgICAgIHNlbGYuYWN0aXZlKGFjdGl2ZSk7CiAgICAgICAgc2VsZi5lbmFibGVkKGVuYWJsZWQpOwogICAgICAgIHNlbGYuY29kZShjb2RlKTsKICAgICAgICBzZWxmLm9yZGVyKG9yZGVyKTsKICAgICAgICBzZWxmLmRhdGUoZGF0ZSk7CiAgICAgICAgc2VsZi5uYW1lKG5hbWUpOwogICAgICAgIHNlbGYucmVtYXJrKHJlbWFyayk7CiAgICAgICAgCiAgICBJZCA9IE5vbmU7CiAgICAKICAgIAogICAgIyBhY3RpdmU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9hY3RpdmUgPSBOb25lOwogICAgZGVmIGFjdGl2ZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fYWN0aXZlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fYWN0aXZlOwogICAgCiAgICAjIGVuYWJsZWQ6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9lbmFibGVkID0gTm9uZTsKICAgIGRlZiBlbmFibGVkKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9lbmFibGVkID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZW5hYmxlZDsKICAgIAogICAgIyBjb2RlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfY29kZSA9IE5vbmU7CiAgICBkZWYgY29kZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fY29kZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NvZGU7CiAgICAKICAgICMgb3JkZXI6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9vcmRlciA9IE5vbmU7CiAgICBkZWYgb3JkZXIoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX29yZGVyID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fb3JkZXI7CiAgICAKICAgICMgZGF0ZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2RhdGUgPSBOb25lOwogICAgZGVmIGRhdGUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2RhdGUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIGlmIHNlbGYuX2RhdGU9PSd7e25vd319JzoKICAgICAgICAgICAgICAgIHNlbGYuX2RhdGUgPSB0aW1lLnRpY2tzX21zKCk7CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2RhdGU7CiAgICAKICAgICMgbmFtZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX25hbWUgPSBOb25lOwogICAgZGVmIG5hbWUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX25hbWUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9uYW1lOwogICAgCiAgICAjIHJlbWFyazogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3JlbWFyayA9IE5vbmU7CiAgICBkZWYgcmVtYXJrKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9yZW1hcmsgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9yZW1hcms7CiAgICAKICAgIAogICAgCiAgICAjIGdyb3VwX01ldHJpY19UeXBlczogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2dyb3VwX01ldHJpY19UeXBlcyA9IE5vbmU7CiAgICBkZWYgZ3JvdXBfTWV0cmljX1R5cGVzKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9ncm91cF9NZXRyaWNfVHlwZXMgPSBhcmdzWzBdOwogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZ3JvdXBfTWV0cmljX1R5cGVzOwogICAgCiAgICAKICAgIGRlZiBfdW5pcXVlKHNlbGYpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnTWV0cmljX0dyb3VwOjpfdW5pcXVlKCk6ICc7CiAgICAgICAgCiAgICAgICAgcmV0ID0gTWV0cmljX0dyb3VwKCk7CiAgICAgICAgaWYgc2VsZi5JZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0LklkID0gc2VsZi5JZDsKICAgIAogICAgICAgIGlmIHNlbGYuY29kZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXQuY29kZShzZWxmLmNvZGUoKSk7CiAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CiAgICAgICAgcmV0dXJuIHJldDsKICAgIAogICAgZGVmIF9mcm9tRG9jdW1lbnQoc2VsZiwgb2JqKToKICAgICAgICBfX3RvU3RyaW5nID0gJ01ldHJpY19Hcm91cDo6X2Zyb21Eb2N1bWVudCgpOiAnOwogICAgICAgIAogICAgICAgIGlmIG9iaiBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gc2VsZjsKCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIGJ5dGVzKToKICAgICAgICAgICAgb2JqID0gc3RyKG9iaiwgInV0Zi04Iik7CgogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBzdHIpIG9yIHR5cGUob2JqKSBpcyBzdHI6CiAgICAgICAgICAgIGlmIHJlLm1hdGNoKHIiKCgoW0EtWmEtel17Myw5fTooPzpcL1wvKT8pKD86Wy07OiY9XCtcJCxcd10rQCk/W0EtWmEtejAtOS4tXSt8KD86d3d3LnxbLTs6Jj1cK1wkLFx3XStAKVtBLVphLXowLTkuLV0rKSgoPzpcL1tcK34lXC8uXHdcLV9dKik/XD8/KD86Wy1cKz0mOyVALlx3X10qKSM/KD86W1x3XSopKT8pIiwgb2JqKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBvYmogPSB1anNvbi5sb2Fkcyh1cmxsaWIzLlBvb2xNYW5hZ2VyKCkucmVxdWVzdCgnR0VUJywgb2JqKS5kYXRhLmRlY29kZSgndXRmLTgnKSk7CiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgb2JqID0ge307CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBvYmogPSB1anNvbi5sb2FkcyhvYmopOwogICAgICAgIAogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBsaXN0KToKICAgICAgICAgICAgcmV0dXJuIFtNZXRyaWNfR3JvdXAoKS5fZnJvbURvY3VtZW50KG8pIGZvciBvIGluIG9ial07CiAgICAgICAgICAgIAogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKG9iaiwgKHN0ciwgYnl0ZXMsIGRpY3QpKToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICd1bmhhbmRsZWQgdHlwZTogJyArIHN0cih0eXBlKG9iaikpKTsKICAgICAgICAgICAgcmV0dXJuIG9iajsKCiAgICAgICAgaWYgJ0lkJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuSWQgPSBvYmpbJ0lkJ107CgogICAgCiAgICAgICAgaWYgJ2FjdGl2ZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmFjdGl2ZShvYmpbJ2FjdGl2ZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdlbmFibGVkJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuZW5hYmxlZChvYmpbJ2VuYWJsZWQnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnY29kZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmNvZGUob2JqWydjb2RlJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ29yZGVyJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYub3JkZXIob2JqWydvcmRlciddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdkYXRlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuZGF0ZShvYmpbJ2RhdGUnXSk7CiAgICAgICAgCiAgICAgICAgICAgIHNlbGYuZGF0ZShkYXRldGltZS5kYXRldGltZS5mcm9taXNvZm9ybWF0KHNlbGYuZGF0ZSgpKSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnbmFtZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLm5hbWUob2JqWyduYW1lJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ3JlbWFyaycgaW4gb2JqOgogICAgICAgICAgICBzZWxmLnJlbWFyayhvYmpbJ3JlbWFyayddKTsKICAgICAgICAKICAgICAgICAgICAgc2VsZi5yZW1hcmsoIHViaW5hc2NpaS5hMmJfYmFzZTY0KHNlbGYucmVtYXJrKCkpICk7CiAgICAgICAgICAgIGlmIHNlbGYucmVtYXJrKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5yZW1hcmsoc2VsZi5yZW1hcmsoKS5kZWNvZGUoJ3V0Zi04Jykuc3RyaXAoKSk7CiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5yZW1hcmsoKTsKICAgICAgICAgICAgICAgICAgICAjcHJpbnQoX190b1N0cmluZyArICJyZW1hcmsgZXhjZXB0aW9uIiwgc2VsZi5yZW1hcmsoKSk7CiAgICAgICAgCiAgICAKCiAgICAKICAgICAgICBpZiAnZ3JvdXBfTWV0cmljX1R5cGVzJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuZ3JvdXBfTWV0cmljX1R5cGVzKE1ldHJpY19UeXBlKCkuX2Zyb21Eb2N1bWVudChvYmpbJ2dyb3VwX01ldHJpY19UeXBlcyddKSk7CiAgICAKCiAgICAgICAgZ2MuY29sbGVjdCgpOwogICAgICAgIHJldHVybiBzZWxmOwogICAgCiAgICBkZWYgX3RvRG9jdW1lbnQoc2VsZiwgYkpTT049Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdNZXRyaWNfR3JvdXA6Ol90b0RvY3VtZW50KCk6ICc7CgogICAgICAgIHJldCA9IHt9OwogICAgICAgIGlmIHNlbGYuSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiSWQiXSA9IHNlbGYuSWQ7CgogICAgCiAgICAgICAgaWYgc2VsZi5hY3RpdmUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJhY3RpdmUiXSA9IHNlbGYuYWN0aXZlKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmVuYWJsZWQoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJlbmFibGVkIl0gPSBzZWxmLmVuYWJsZWQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuY29kZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImNvZGUiXSA9IHNlbGYuY29kZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5vcmRlcigpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIm9yZGVyIl0gPSBzZWxmLm9yZGVyKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmRhdGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJkYXRlIl0gPSBzZWxmLmRhdGUoKTsKICAgICAgICAKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXRbImRhdGUiXSwgZGF0ZXRpbWUuZGF0ZXRpbWUpOgogICAgICAgICAgICAgICAgcmV0WyJkYXRlIl0gPSByZXRbImRhdGUiXS5pc29mb3JtYXQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYubmFtZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIm5hbWUiXSA9IHNlbGYubmFtZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5yZW1hcmsoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9IHNlbGYucmVtYXJrKCk7CiAgICAgICAgCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmV0WyJyZW1hcmsiXSwgZGljdCk6CiAgICAgICAgICAgICAgICByZXRbInJlbWFyayJdID0gdWpzb24uZHVtcHMocmV0WyJyZW1hcmsiXSkuZW5jb2RlKCd1dGYtOCcpOwoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9ICB1YmluYXNjaWkuYjJhX2Jhc2U2NChyZXRbInJlbWFyayJdKS5kZWNvZGUoJ3V0Zi04Jykuc3RyaXAoKTsKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGNlcHRpb24gd2l0aCByZW1hcms6ICIgKyByZXRbInJlbWFyayJdKTsKICAgICAgICAKICAgIAogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5ncm91cF9NZXRyaWNfVHlwZXMoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJncm91cF9NZXRyaWNfVHlwZXMiXSA9IFt0YS5fdG9Eb2N1bWVudCgpIGZvciB0YSBpbiBzZWxmLmdyb3VwX01ldHJpY19UeXBlcygpXTsKICAgIAoKICAgICAgICBpZiBiSlNPTiBpcyBub3QgTm9uZToKICAgICAgICAgICAgI3ByaW50KF9fdG9TdHJpbmcgKyAiR09UIEhFUkUiLCB0eXBlKHJldCksIHJldCk7CiAgICAgICAgICAgIHJldCA9IHVqc29uLmR1bXBzKHJldCk7CiAgICAgICAgZ2MuY29sbGVjdCgpOwogICAgICAgIHJldHVybiByZXQ7CgogICAgCiAgICBkZWYgc3RvcmUoc2VsZiwgX19ldmVudD1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ01ldHJpY19Hcm91cDo6c3RvcmUoKTogJzsKICAgICAgICAKICAgICAgICBhbnN3ZXIgPSBOb25lOwoKICAgICAgICBfX3Jlc3BvbnNlID0gRXZlbnQoKS5jb2RlKCdbJytub2RlLmNvZGUoKSsnQCcrc3RyKHRpbWUudGlja3NfbXMoKSkrJ10uTWV0cmljX0dyb3VwLnN0b3JlKCknKS5tZXRob2QoJ3N0b3JlJykuY2xhc3NOYW1lKCdNZXRyaWNfR3JvdXAnKS5jYXJyaWVyKG5vZGUpLnNlbmRlcihub2RlKS5yZWNpcGllbnQobm9kZS5wYXJlbnQoKSk7CgogICAgICAgIGV2SlNPTiA9IE5vbmU7CiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgZXZKU09OID0gdWpzb24ubG9hZHMoX19ldmVudC5wYXlsb2FkKCkpOwogICAgICAgICAgICBpZiAnX190aGlzJyBpbiBldkpTT046CiAgICAgICAgICAgICAgICBzZWxmLl9mcm9tRG9jdW1lbnQoZXZKU09OWydfX3RoaXMnXSk7CiAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UucmVzcG9uc2VUbyhfX2V2ZW50Ll91bmlxdWUoKSk7CiAgICAgICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgIiBoYW5kbGluZyBldmVudFsiK19fZXZlbnQuY29kZSgpKyJdIik7CgogICAgICAgIAogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImEgcmVzcG9uc2UgdG8gbXkgZXZlbnQoIitfX2V2ZW50LnJlc3BvbnNlVG8oKS5jb2RlKCkrIikgWyIgKyBfX2V2ZW50LmNsYXNzTmFtZSgpICsgIigpLiIgKyBfX2V2ZW50Lm1ldGhvZCgpICsgIigpXSIpOwogICAgICAgIAogICAgICAgICAgICBhbnN3ZXIgPSBNZXRyaWNfR3JvdXAoKS5fZnJvbURvY3VtZW50KGV2SlNPTik7CiAgICAgICAgCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhlY3V0aW5nIGxvY2FsbHkiKTsKCgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZSBvciBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBpZiBhbnN3ZXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKGFuc3dlci5fdG9Eb2N1bWVudCgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoeyJfX3RoaXMiOiBzZWxmLl90b0RvY3VtZW50KCl9KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnRyaWdnZXIoKTsKICAgICAgICAgICAgCgogICAgICAgIHJldHVybiBhbnN3ZXI7CgogICAgCiAgICBkZWYgZmluZEFsbChzZWxmLCBfX2V2ZW50PU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnTWV0cmljX0dyb3VwOjpmaW5kQWxsKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLk1ldHJpY19Hcm91cC5maW5kQWxsKCknKS5tZXRob2QoJ2ZpbmRBbGwnKS5jbGFzc05hbWUoJ01ldHJpY19Hcm91cCcpLmNhcnJpZXIobm9kZSkuc2VuZGVyKG5vZGUpLnJlY2lwaWVudChub2RlLnBhcmVudCgpKTsKCiAgICAgICAgZXZKU09OID0gTm9uZTsKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBldkpTT04gPSB1anNvbi5sb2FkcyhfX2V2ZW50LnBheWxvYWQoKSk7CiAgICAgICAgICAgIGlmICdfX3RoaXMnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIHNlbGYuX2Zyb21Eb2N1bWVudChldkpTT05bJ19fdGhpcyddKTsKICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS5yZXNwb25zZVRvKF9fZXZlbnQuX3VuaXF1ZSgpKTsKICAgICAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiIGhhbmRsaW5nIGV2ZW50WyIrX19ldmVudC5jb2RlKCkrIl0iKTsKCiAgICAgICAgCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiYSByZXNwb25zZSB0byBteSBldmVudCgiK19fZXZlbnQucmVzcG9uc2VUbygpLmNvZGUoKSsiKSBbIiArIF9fZXZlbnQuY2xhc3NOYW1lKCkgKyAiKCkuIiArIF9fZXZlbnQubWV0aG9kKCkgKyAiKCldIik7CiAgICAgICAgCiAgICAgICAgICAgIGFuc3dlciA9IE1ldHJpY19Hcm91cCgpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiBmaW5kKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdNZXRyaWNfR3JvdXA6OmZpbmQoKTogJzsKICAgICAgICAKICAgICAgICBhbnN3ZXIgPSBOb25lOwoKICAgICAgICBfX3Jlc3BvbnNlID0gRXZlbnQoKS5jb2RlKCdbJytub2RlLmNvZGUoKSsnQCcrc3RyKHRpbWUudGlja3NfbXMoKSkrJ10uTWV0cmljX0dyb3VwLmZpbmQoKScpLm1ldGhvZCgnZmluZCcpLmNsYXNzTmFtZSgnTWV0cmljX0dyb3VwJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gTWV0cmljX0dyb3VwKCkuX2Zyb21Eb2N1bWVudChldkpTT04pOwogICAgICAgIAoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4ZWN1dGluZyBsb2NhbGx5Iik7CgoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmUgb3IgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgaWYgYW5zd2VyIGlzIG5vdCBOb25lOgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZChhbnN3ZXIuX3RvRG9jdW1lbnQoKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKHsiX190aGlzIjogc2VsZi5fdG9Eb2N1bWVudCgpfSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS50cmlnZ2VyKCk7CiAgICAgICAgICAgIAoKICAgICAgICByZXR1cm4gYW5zd2VyOwoKICAgIAoKCmNsYXNzIE1ldHJpY19UeXBlKCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgSWQ9Tm9uZSwgYWN0aXZlPU5vbmUsIGVuYWJsZWQ9Tm9uZSwgY29kZT1Ob25lLCBvcmRlcj1Ob25lLCBkYXRlPU5vbmUsIG5hbWU9Tm9uZSwgcmVtYXJrPU5vbmUsIGdyb3VwPU5vbmUpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKTsKCiAgICAgICAgI3ByaW50KCdNZXRyaWNfVHlwZTo6X19pbml0X18oKScpOwogICAgICAgIGlmIElkIGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLklkID0gSWQ7CgogICAgICAgIAogICAgICAgIHNlbGYuYWN0aXZlKGFjdGl2ZSk7CiAgICAgICAgc2VsZi5lbmFibGVkKGVuYWJsZWQpOwogICAgICAgIHNlbGYuY29kZShjb2RlKTsKICAgICAgICBzZWxmLm9yZGVyKG9yZGVyKTsKICAgICAgICBzZWxmLmRhdGUoZGF0ZSk7CiAgICAgICAgc2VsZi5uYW1lKG5hbWUpOwogICAgICAgIHNlbGYucmVtYXJrKHJlbWFyayk7CiAgICAgICAgc2VsZi5ncm91cChncm91cCk7CiAgICAgICAgCiAgICBJZCA9IE5vbmU7CiAgICAKICAgIAogICAgIyBhY3RpdmU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9hY3RpdmUgPSBOb25lOwogICAgZGVmIGFjdGl2ZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fYWN0aXZlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fYWN0aXZlOwogICAgCiAgICAjIGVuYWJsZWQ6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9lbmFibGVkID0gTm9uZTsKICAgIGRlZiBlbmFibGVkKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9lbmFibGVkID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZW5hYmxlZDsKICAgIAogICAgIyBjb2RlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfY29kZSA9IE5vbmU7CiAgICBkZWYgY29kZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fY29kZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NvZGU7CiAgICAKICAgICMgb3JkZXI6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9vcmRlciA9IE5vbmU7CiAgICBkZWYgb3JkZXIoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX29yZGVyID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fb3JkZXI7CiAgICAKICAgICMgZGF0ZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2RhdGUgPSBOb25lOwogICAgZGVmIGRhdGUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2RhdGUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIGlmIHNlbGYuX2RhdGU9PSd7e25vd319JzoKICAgICAgICAgICAgICAgIHNlbGYuX2RhdGUgPSB0aW1lLnRpY2tzX21zKCk7CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2RhdGU7CiAgICAKICAgICMgbmFtZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX25hbWUgPSBOb25lOwogICAgZGVmIG5hbWUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX25hbWUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9uYW1lOwogICAgCiAgICAjIHJlbWFyazogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3JlbWFyayA9IE5vbmU7CiAgICBkZWYgcmVtYXJrKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9yZW1hcmsgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9yZW1hcms7CiAgICAKICAgICMgZ3JvdXA6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9ncm91cCA9IE5vbmU7CiAgICBkZWYgZ3JvdXAoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2dyb3VwID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZ3JvdXA7CiAgICAKICAgIAogICAgCiAgICAjIHR5cGVfTWV0cmljczogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3R5cGVfTWV0cmljcyA9IE5vbmU7CiAgICBkZWYgdHlwZV9NZXRyaWNzKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl90eXBlX01ldHJpY3MgPSBhcmdzWzBdOwogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fdHlwZV9NZXRyaWNzOwogICAgCiAgICAKICAgIGRlZiBfdW5pcXVlKHNlbGYpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnTWV0cmljX1R5cGU6Ol91bmlxdWUoKTogJzsKICAgICAgICAKICAgICAgICByZXQgPSBNZXRyaWNfVHlwZSgpOwogICAgICAgIGlmIHNlbGYuSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldC5JZCA9IHNlbGYuSWQ7CiAgICAKICAgICAgICBpZiBzZWxmLmNvZGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0LmNvZGUoc2VsZi5jb2RlKCkpOwogICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwogICAgICAgIHJldHVybiByZXQ7CiAgICAKICAgIGRlZiBfZnJvbURvY3VtZW50KHNlbGYsIG9iaik6CiAgICAgICAgX190b1N0cmluZyA9ICdNZXRyaWNfVHlwZTo6X2Zyb21Eb2N1bWVudCgpOiAnOwogICAgICAgIAogICAgICAgIGlmIG9iaiBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gc2VsZjsKCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIGJ5dGVzKToKICAgICAgICAgICAgb2JqID0gc3RyKG9iaiwgInV0Zi04Iik7CgogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBzdHIpIG9yIHR5cGUob2JqKSBpcyBzdHI6CiAgICAgICAgICAgIGlmIHJlLm1hdGNoKHIiKCgoW0EtWmEtel17Myw5fTooPzpcL1wvKT8pKD86Wy07OiY9XCtcJCxcd10rQCk/W0EtWmEtejAtOS4tXSt8KD86d3d3LnxbLTs6Jj1cK1wkLFx3XStAKVtBLVphLXowLTkuLV0rKSgoPzpcL1tcK34lXC8uXHdcLV9dKik/XD8/KD86Wy1cKz0mOyVALlx3X10qKSM/KD86W1x3XSopKT8pIiwgb2JqKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBvYmogPSB1anNvbi5sb2Fkcyh1cmxsaWIzLlBvb2xNYW5hZ2VyKCkucmVxdWVzdCgnR0VUJywgb2JqKS5kYXRhLmRlY29kZSgndXRmLTgnKSk7CiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgb2JqID0ge307CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBvYmogPSB1anNvbi5sb2FkcyhvYmopOwogICAgICAgIAogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBsaXN0KToKICAgICAgICAgICAgcmV0dXJuIFtNZXRyaWNfVHlwZSgpLl9mcm9tRG9jdW1lbnQobykgZm9yIG8gaW4gb2JqXTsKICAgICAgICAgICAgCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2Uob2JqLCAoc3RyLCBieXRlcywgZGljdCkpOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgJ3VuaGFuZGxlZCB0eXBlOiAnICsgc3RyKHR5cGUob2JqKSkpOwogICAgICAgICAgICByZXR1cm4gb2JqOwoKICAgICAgICBpZiAnSWQnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5JZCA9IG9ialsnSWQnXTsKCiAgICAKICAgICAgICBpZiAnYWN0aXZlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuYWN0aXZlKG9ialsnYWN0aXZlJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2VuYWJsZWQnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5lbmFibGVkKG9ialsnZW5hYmxlZCddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdjb2RlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuY29kZShvYmpbJ2NvZGUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnb3JkZXInIGluIG9iajoKICAgICAgICAgICAgc2VsZi5vcmRlcihvYmpbJ29yZGVyJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2RhdGUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5kYXRlKG9ialsnZGF0ZSddKTsKICAgICAgICAKICAgICAgICAgICAgc2VsZi5kYXRlKGRhdGV0aW1lLmRhdGV0aW1lLmZyb21pc29mb3JtYXQoc2VsZi5kYXRlKCkpKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICduYW1lJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYubmFtZShvYmpbJ25hbWUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAncmVtYXJrJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYucmVtYXJrKG9ialsncmVtYXJrJ10pOwogICAgICAgIAogICAgICAgICAgICBzZWxmLnJlbWFyayggdWJpbmFzY2lpLmEyYl9iYXNlNjQoc2VsZi5yZW1hcmsoKSkgKTsKICAgICAgICAgICAgaWYgc2VsZi5yZW1hcmsoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbWFyayhzZWxmLnJlbWFyaygpLmRlY29kZSgndXRmLTgnKS5zdHJpcCgpKTsKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbWFyaygpOwogICAgICAgICAgICAgICAgICAgICNwcmludChfX3RvU3RyaW5nICsgInJlbWFyayBleGNlcHRpb24iLCBzZWxmLnJlbWFyaygpKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdncm91cCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmdyb3VwKE1ldHJpY19Hcm91cCgpLl9mcm9tRG9jdW1lbnQob2JqWydncm91cCddKSk7CiAgICAgICAgCiAgICAKCiAgICAKICAgICAgICBpZiAndHlwZV9NZXRyaWNzJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYudHlwZV9NZXRyaWNzKE1ldHJpYygpLl9mcm9tRG9jdW1lbnQob2JqWyd0eXBlX01ldHJpY3MnXSkpOwogICAgCgogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gc2VsZjsKICAgIAogICAgZGVmIF90b0RvY3VtZW50KHNlbGYsIGJKU09OPU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnTWV0cmljX1R5cGU6Ol90b0RvY3VtZW50KCk6ICc7CgogICAgICAgIHJldCA9IHt9OwogICAgICAgIGlmIHNlbGYuSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiSWQiXSA9IHNlbGYuSWQ7CgogICAgCiAgICAgICAgaWYgc2VsZi5hY3RpdmUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJhY3RpdmUiXSA9IHNlbGYuYWN0aXZlKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmVuYWJsZWQoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJlbmFibGVkIl0gPSBzZWxmLmVuYWJsZWQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuY29kZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImNvZGUiXSA9IHNlbGYuY29kZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5vcmRlcigpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIm9yZGVyIl0gPSBzZWxmLm9yZGVyKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmRhdGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJkYXRlIl0gPSBzZWxmLmRhdGUoKTsKICAgICAgICAKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXRbImRhdGUiXSwgZGF0ZXRpbWUuZGF0ZXRpbWUpOgogICAgICAgICAgICAgICAgcmV0WyJkYXRlIl0gPSByZXRbImRhdGUiXS5pc29mb3JtYXQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYubmFtZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIm5hbWUiXSA9IHNlbGYubmFtZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5yZW1hcmsoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9IHNlbGYucmVtYXJrKCk7CiAgICAgICAgCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmV0WyJyZW1hcmsiXSwgZGljdCk6CiAgICAgICAgICAgICAgICByZXRbInJlbWFyayJdID0gdWpzb24uZHVtcHMocmV0WyJyZW1hcmsiXSkuZW5jb2RlKCd1dGYtOCcpOwoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9ICB1YmluYXNjaWkuYjJhX2Jhc2U2NChyZXRbInJlbWFyayJdKS5kZWNvZGUoJ3V0Zi04Jykuc3RyaXAoKTsKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGNlcHRpb24gd2l0aCByZW1hcms6ICIgKyByZXRbInJlbWFyayJdKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuZ3JvdXAoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJncm91cCJdID0gc2VsZi5ncm91cCgpLl90b0RvY3VtZW50KCk7CiAgICAgICAgCiAgICAKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYudHlwZV9NZXRyaWNzKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsidHlwZV9NZXRyaWNzIl0gPSBbdGEuX3RvRG9jdW1lbnQoKSBmb3IgdGEgaW4gc2VsZi50eXBlX01ldHJpY3MoKV07CiAgICAKCiAgICAgICAgaWYgYkpTT04gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICNwcmludChfX3RvU3RyaW5nICsgIkdPVCBIRVJFIiwgdHlwZShyZXQpLCByZXQpOwogICAgICAgICAgICByZXQgPSB1anNvbi5kdW1wcyhyZXQpOwogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gcmV0OwoKICAgIAogICAgZGVmIHN0b3JlKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdNZXRyaWNfVHlwZTo6c3RvcmUoKTogJzsKICAgICAgICAKICAgICAgICBhbnN3ZXIgPSBOb25lOwoKICAgICAgICBfX3Jlc3BvbnNlID0gRXZlbnQoKS5jb2RlKCdbJytub2RlLmNvZGUoKSsnQCcrc3RyKHRpbWUudGlja3NfbXMoKSkrJ10uTWV0cmljX1R5cGUuc3RvcmUoKScpLm1ldGhvZCgnc3RvcmUnKS5jbGFzc05hbWUoJ01ldHJpY19UeXBlJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gTWV0cmljX1R5cGUoKS5fZnJvbURvY3VtZW50KGV2SlNPTik7CiAgICAgICAgCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhlY3V0aW5nIGxvY2FsbHkiKTsKCgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZSBvciBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBpZiBhbnN3ZXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKGFuc3dlci5fdG9Eb2N1bWVudCgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoeyJfX3RoaXMiOiBzZWxmLl90b0RvY3VtZW50KCl9KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnRyaWdnZXIoKTsKICAgICAgICAgICAgCgogICAgICAgIHJldHVybiBhbnN3ZXI7CgogICAgCiAgICBkZWYgZmluZEFsbChzZWxmLCBfX2V2ZW50PU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnTWV0cmljX1R5cGU6OmZpbmRBbGwoKTogJzsKICAgICAgICAKICAgICAgICBhbnN3ZXIgPSBOb25lOwoKICAgICAgICBfX3Jlc3BvbnNlID0gRXZlbnQoKS5jb2RlKCdbJytub2RlLmNvZGUoKSsnQCcrc3RyKHRpbWUudGlja3NfbXMoKSkrJ10uTWV0cmljX1R5cGUuZmluZEFsbCgpJykubWV0aG9kKCdmaW5kQWxsJykuY2xhc3NOYW1lKCdNZXRyaWNfVHlwZScpLmNhcnJpZXIobm9kZSkuc2VuZGVyKG5vZGUpLnJlY2lwaWVudChub2RlLnBhcmVudCgpKTsKCiAgICAgICAgZXZKU09OID0gTm9uZTsKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBldkpTT04gPSB1anNvbi5sb2FkcyhfX2V2ZW50LnBheWxvYWQoKSk7CiAgICAgICAgICAgIGlmICdfX3RoaXMnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIHNlbGYuX2Zyb21Eb2N1bWVudChldkpTT05bJ19fdGhpcyddKTsKICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS5yZXNwb25zZVRvKF9fZXZlbnQuX3VuaXF1ZSgpKTsKICAgICAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiIGhhbmRsaW5nIGV2ZW50WyIrX19ldmVudC5jb2RlKCkrIl0iKTsKCiAgICAgICAgCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiYSByZXNwb25zZSB0byBteSBldmVudCgiK19fZXZlbnQucmVzcG9uc2VUbygpLmNvZGUoKSsiKSBbIiArIF9fZXZlbnQuY2xhc3NOYW1lKCkgKyAiKCkuIiArIF9fZXZlbnQubWV0aG9kKCkgKyAiKCldIik7CiAgICAgICAgCiAgICAgICAgICAgIGFuc3dlciA9IE1ldHJpY19UeXBlKCkuX2Zyb21Eb2N1bWVudChldkpTT04pOwogICAgICAgIAoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4ZWN1dGluZyBsb2NhbGx5Iik7CgoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmUgb3IgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgaWYgYW5zd2VyIGlzIG5vdCBOb25lOgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZChhbnN3ZXIuX3RvRG9jdW1lbnQoKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKHsiX190aGlzIjogc2VsZi5fdG9Eb2N1bWVudCgpfSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS50cmlnZ2VyKCk7CiAgICAgICAgICAgIAoKICAgICAgICByZXR1cm4gYW5zd2VyOwoKICAgIAogICAgZGVmIGZpbmQoc2VsZiwgX19ldmVudD1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ01ldHJpY19UeXBlOjpmaW5kKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLk1ldHJpY19UeXBlLmZpbmQoKScpLm1ldGhvZCgnZmluZCcpLmNsYXNzTmFtZSgnTWV0cmljX1R5cGUnKS5jYXJyaWVyKG5vZGUpLnNlbmRlcihub2RlKS5yZWNpcGllbnQobm9kZS5wYXJlbnQoKSk7CgogICAgICAgIGV2SlNPTiA9IE5vbmU7CiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgZXZKU09OID0gdWpzb24ubG9hZHMoX19ldmVudC5wYXlsb2FkKCkpOwogICAgICAgICAgICBpZiAnX190aGlzJyBpbiBldkpTT046CiAgICAgICAgICAgICAgICBzZWxmLl9mcm9tRG9jdW1lbnQoZXZKU09OWydfX3RoaXMnXSk7CiAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UucmVzcG9uc2VUbyhfX2V2ZW50Ll91bmlxdWUoKSk7CiAgICAgICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgIiBoYW5kbGluZyBldmVudFsiK19fZXZlbnQuY29kZSgpKyJdIik7CgogICAgICAgIAogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImEgcmVzcG9uc2UgdG8gbXkgZXZlbnQoIitfX2V2ZW50LnJlc3BvbnNlVG8oKS5jb2RlKCkrIikgWyIgKyBfX2V2ZW50LmNsYXNzTmFtZSgpICsgIigpLiIgKyBfX2V2ZW50Lm1ldGhvZCgpICsgIigpXSIpOwogICAgICAgIAogICAgICAgICAgICBhbnN3ZXIgPSBNZXRyaWNfVHlwZSgpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKCgpjbGFzcyBDb25maWcoKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBJZD1Ob25lLCBhY3RpdmU9Tm9uZSwgZW5hYmxlZD1Ob25lLCBjb2RlPU5vbmUsIG9yZGVyPU5vbmUsIGRhdGU9Tm9uZSwgbmFtZT1Ob25lLCByZW1hcms9Tm9uZSwgdmFsdWU9Tm9uZSwgc2NyaXB0PU5vbmUsIHRvb2w9Tm9uZSwgZ3JvdXA9Tm9uZSwgdHlwZT1Ob25lLCBub2RlPU5vbmUpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKTsKCiAgICAgICAgI3ByaW50KCdDb25maWc6Ol9faW5pdF9fKCknKTsKICAgICAgICBpZiBJZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgc2VsZi5JZCA9IElkOwoKICAgICAgICAKICAgICAgICBzZWxmLmFjdGl2ZShhY3RpdmUpOwogICAgICAgIHNlbGYuZW5hYmxlZChlbmFibGVkKTsKICAgICAgICBzZWxmLmNvZGUoY29kZSk7CiAgICAgICAgc2VsZi5vcmRlcihvcmRlcik7CiAgICAgICAgc2VsZi5kYXRlKGRhdGUpOwogICAgICAgIHNlbGYubmFtZShuYW1lKTsKICAgICAgICBzZWxmLnJlbWFyayhyZW1hcmspOwogICAgICAgIHNlbGYudmFsdWUodmFsdWUpOwogICAgICAgIHNlbGYuc2NyaXB0KHNjcmlwdCk7CiAgICAgICAgc2VsZi50b29sKHRvb2wpOwogICAgICAgIHNlbGYuZ3JvdXAoZ3JvdXApOwogICAgICAgIHNlbGYudHlwZSh0eXBlKTsKICAgICAgICBzZWxmLm5vZGUobm9kZSk7CiAgICAgICAgCiAgICBJZCA9IE5vbmU7CiAgICAKICAgIAogICAgIyBhY3RpdmU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9hY3RpdmUgPSBOb25lOwogICAgZGVmIGFjdGl2ZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fYWN0aXZlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fYWN0aXZlOwogICAgCiAgICAjIGVuYWJsZWQ6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9lbmFibGVkID0gTm9uZTsKICAgIGRlZiBlbmFibGVkKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9lbmFibGVkID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZW5hYmxlZDsKICAgIAogICAgIyBjb2RlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfY29kZSA9IE5vbmU7CiAgICBkZWYgY29kZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fY29kZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NvZGU7CiAgICAKICAgICMgb3JkZXI6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9vcmRlciA9IE5vbmU7CiAgICBkZWYgb3JkZXIoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX29yZGVyID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fb3JkZXI7CiAgICAKICAgICMgZGF0ZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2RhdGUgPSBOb25lOwogICAgZGVmIGRhdGUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2RhdGUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIGlmIHNlbGYuX2RhdGU9PSd7e25vd319JzoKICAgICAgICAgICAgICAgIHNlbGYuX2RhdGUgPSB0aW1lLnRpY2tzX21zKCk7CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2RhdGU7CiAgICAKICAgICMgbmFtZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX25hbWUgPSBOb25lOwogICAgZGVmIG5hbWUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX25hbWUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9uYW1lOwogICAgCiAgICAjIHJlbWFyazogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3JlbWFyayA9IE5vbmU7CiAgICBkZWYgcmVtYXJrKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9yZW1hcmsgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9yZW1hcms7CiAgICAKICAgICMgdmFsdWU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF92YWx1ZSA9IE5vbmU7CiAgICBkZWYgdmFsdWUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX3ZhbHVlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fdmFsdWU7CiAgICAKICAgICMgc2NyaXB0OiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfc2NyaXB0ID0gTm9uZTsKICAgIGRlZiBzY3JpcHQoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX3NjcmlwdCA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3NjcmlwdDsKICAgIAogICAgIyB0b29sOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfdG9vbCA9IE5vbmU7CiAgICBkZWYgdG9vbChzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fdG9vbCA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3Rvb2w7CiAgICAKICAgICMgZ3JvdXA6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9ncm91cCA9IE5vbmU7CiAgICBkZWYgZ3JvdXAoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2dyb3VwID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZ3JvdXA7CiAgICAKICAgICMgdHlwZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3R5cGUgPSBOb25lOwogICAgZGVmIHR5cGUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX3R5cGUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl90eXBlOwogICAgCiAgICAjIG5vZGU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9ub2RlID0gTm9uZTsKICAgIGRlZiBub2RlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9ub2RlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fbm9kZTsKICAgIAogICAgCiAgICAKICAgIAogICAgZGVmIF91bmlxdWUoc2VsZik6CiAgICAgICAgX190b1N0cmluZyA9ICdDb25maWc6Ol91bmlxdWUoKTogJzsKICAgICAgICAKICAgICAgICByZXQgPSBDb25maWcoKTsKICAgICAgICBpZiBzZWxmLklkIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXQuSWQgPSBzZWxmLklkOwogICAgCiAgICAgICAgaWYgc2VsZi5uYW1lKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldC5uYW1lKHNlbGYubmFtZSgpKTsKICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gcmV0OwogICAgCiAgICBkZWYgX2Zyb21Eb2N1bWVudChzZWxmLCBvYmopOgogICAgICAgIF9fdG9TdHJpbmcgPSAnQ29uZmlnOjpfZnJvbURvY3VtZW50KCk6ICc7CiAgICAgICAgCiAgICAgICAgaWYgb2JqIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBzZWxmOwoKICAgICAgICBpZiBpc2luc3RhbmNlKG9iaiwgYnl0ZXMpOgogICAgICAgICAgICBvYmogPSBzdHIob2JqLCAidXRmLTgiKTsKCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIHN0cikgb3IgdHlwZShvYmopIGlzIHN0cjoKICAgICAgICAgICAgaWYgcmUubWF0Y2gociIoKChbQS1aYS16XXszLDl9Oig/OlwvXC8pPykoPzpbLTs6Jj1cK1wkLFx3XStAKT9bQS1aYS16MC05Li1dK3woPzp3d3cufFstOzomPVwrXCQsXHddK0ApW0EtWmEtejAtOS4tXSspKCg/OlwvW1wrfiVcLy5cd1wtX10qKT9cPz8oPzpbLVwrPSY7JUAuXHdfXSopIz8oPzpbXHddKikpPykiLCBvYmopOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIG9iaiA9IHVqc29uLmxvYWRzKHVybGxpYjMuUG9vbE1hbmFnZXIoKS5yZXF1ZXN0KCdHRVQnLCBvYmopLmRhdGEuZGVjb2RlKCd1dGYtOCcpKTsKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBvYmogPSB7fTsKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG9iaiA9IHVqc29uLmxvYWRzKG9iaik7CiAgICAgICAgCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIGxpc3QpOgogICAgICAgICAgICByZXR1cm4gW0NvbmZpZygpLl9mcm9tRG9jdW1lbnQobykgZm9yIG8gaW4gb2JqXTsKICAgICAgICAgICAgCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2Uob2JqLCAoc3RyLCBieXRlcywgZGljdCkpOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgJ3VuaGFuZGxlZCB0eXBlOiAnICsgc3RyKHR5cGUob2JqKSkpOwogICAgICAgICAgICByZXR1cm4gb2JqOwoKICAgICAgICBpZiAnSWQnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5JZCA9IG9ialsnSWQnXTsKCiAgICAKICAgICAgICBpZiAnYWN0aXZlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuYWN0aXZlKG9ialsnYWN0aXZlJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2VuYWJsZWQnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5lbmFibGVkKG9ialsnZW5hYmxlZCddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdjb2RlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuY29kZShvYmpbJ2NvZGUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnb3JkZXInIGluIG9iajoKICAgICAgICAgICAgc2VsZi5vcmRlcihvYmpbJ29yZGVyJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2RhdGUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5kYXRlKG9ialsnZGF0ZSddKTsKICAgICAgICAKICAgICAgICAgICAgc2VsZi5kYXRlKGRhdGV0aW1lLmRhdGV0aW1lLmZyb21pc29mb3JtYXQoc2VsZi5kYXRlKCkpKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICduYW1lJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYubmFtZShvYmpbJ25hbWUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAncmVtYXJrJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYucmVtYXJrKG9ialsncmVtYXJrJ10pOwogICAgICAgIAogICAgICAgICAgICBzZWxmLnJlbWFyayggdWJpbmFzY2lpLmEyYl9iYXNlNjQoc2VsZi5yZW1hcmsoKSkgKTsKICAgICAgICAgICAgaWYgc2VsZi5yZW1hcmsoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbWFyayhzZWxmLnJlbWFyaygpLmRlY29kZSgndXRmLTgnKS5zdHJpcCgpKTsKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbWFyaygpOwogICAgICAgICAgICAgICAgICAgICNwcmludChfX3RvU3RyaW5nICsgInJlbWFyayBleGNlcHRpb24iLCBzZWxmLnJlbWFyaygpKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICd2YWx1ZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLnZhbHVlKG9ialsndmFsdWUnXSk7CiAgICAgICAgCiAgICAgICAgICAgIHNlbGYudmFsdWUoIHViaW5hc2NpaS5hMmJfYmFzZTY0KHNlbGYudmFsdWUoKSkgKTsKICAgICAgICAgICAgaWYgc2VsZi52YWx1ZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYudmFsdWUoc2VsZi52YWx1ZSgpLmRlY29kZSgndXRmLTgnKS5zdHJpcCgpKTsKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBzZWxmLnZhbHVlKCk7CiAgICAgICAgICAgICAgICAgICAgI3ByaW50KF9fdG9TdHJpbmcgKyAidmFsdWUgZXhjZXB0aW9uIiwgc2VsZi52YWx1ZSgpKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdzY3JpcHQnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5zY3JpcHQob2JqWydzY3JpcHQnXSk7CiAgICAgICAgCiAgICAgICAgICAgIHNlbGYuc2NyaXB0KCB1YmluYXNjaWkuYTJiX2Jhc2U2NChzZWxmLnNjcmlwdCgpKSApOwogICAgICAgICAgICBpZiBzZWxmLnNjcmlwdCgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYuc2NyaXB0KHNlbGYuc2NyaXB0KCkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCkpOwogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHNlbGYuc2NyaXB0KCk7CiAgICAgICAgICAgICAgICAgICAgI3ByaW50KF9fdG9TdHJpbmcgKyAic2NyaXB0IGV4Y2VwdGlvbiIsIHNlbGYuc2NyaXB0KCkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ3Rvb2wnIGluIG9iajoKICAgICAgICAgICAgc2VsZi50b29sKFRvb2woKS5fZnJvbURvY3VtZW50KG9ialsndG9vbCddKSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZ3JvdXAnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5ncm91cChDb25maWdfR3JvdXAoKS5fZnJvbURvY3VtZW50KG9ialsnZ3JvdXAnXSkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ3R5cGUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi50eXBlKFRvb2xfVHlwZSgpLl9mcm9tRG9jdW1lbnQob2JqWyd0eXBlJ10pKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdub2RlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYubm9kZShOb2RlKCkuX2Zyb21Eb2N1bWVudChvYmpbJ25vZGUnXSkpOwogICAgICAgIAogICAgCgogICAgCgogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gc2VsZjsKICAgIAogICAgZGVmIF90b0RvY3VtZW50KHNlbGYsIGJKU09OPU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnQ29uZmlnOjpfdG9Eb2N1bWVudCgpOiAnOwoKICAgICAgICByZXQgPSB7fTsKICAgICAgICBpZiBzZWxmLklkIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIklkIl0gPSBzZWxmLklkOwoKICAgIAogICAgICAgIGlmIHNlbGYuYWN0aXZlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiYWN0aXZlIl0gPSBzZWxmLmFjdGl2ZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5lbmFibGVkKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZW5hYmxlZCJdID0gc2VsZi5lbmFibGVkKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmNvZGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJjb2RlIl0gPSBzZWxmLmNvZGUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYub3JkZXIoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJvcmRlciJdID0gc2VsZi5vcmRlcigpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5kYXRlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZGF0ZSJdID0gc2VsZi5kYXRlKCk7CiAgICAgICAgCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmV0WyJkYXRlIl0sIGRhdGV0aW1lLmRhdGV0aW1lKToKICAgICAgICAgICAgICAgIHJldFsiZGF0ZSJdID0gcmV0WyJkYXRlIl0uaXNvZm9ybWF0KCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLm5hbWUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJuYW1lIl0gPSBzZWxmLm5hbWUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYucmVtYXJrKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsicmVtYXJrIl0gPSBzZWxmLnJlbWFyaygpOwogICAgICAgIAogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHJldFsicmVtYXJrIl0sIGRpY3QpOgogICAgICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9IHVqc29uLmR1bXBzKHJldFsicmVtYXJrIl0pLmVuY29kZSgndXRmLTgnKTsKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJldFsicmVtYXJrIl0gPSAgdWJpbmFzY2lpLmIyYV9iYXNlNjQocmV0WyJyZW1hcmsiXSkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCk7CiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhjZXB0aW9uIHdpdGggcmVtYXJrOiAiICsgcmV0WyJyZW1hcmsiXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLnZhbHVlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsidmFsdWUiXSA9IHNlbGYudmFsdWUoKTsKICAgICAgICAKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXRbInZhbHVlIl0sIGRpY3QpOgogICAgICAgICAgICAgICAgcmV0WyJ2YWx1ZSJdID0gdWpzb24uZHVtcHMocmV0WyJ2YWx1ZSJdKS5lbmNvZGUoJ3V0Zi04Jyk7CgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXRbInZhbHVlIl0gPSAgdWJpbmFzY2lpLmIyYV9iYXNlNjQocmV0WyJ2YWx1ZSJdKS5kZWNvZGUoJ3V0Zi04Jykuc3RyaXAoKTsKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGNlcHRpb24gd2l0aCB2YWx1ZTogIiArIHJldFsidmFsdWUiXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLnNjcmlwdCgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbInNjcmlwdCJdID0gc2VsZi5zY3JpcHQoKTsKICAgICAgICAKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXRbInNjcmlwdCJdLCBkaWN0KToKICAgICAgICAgICAgICAgIHJldFsic2NyaXB0Il0gPSB1anNvbi5kdW1wcyhyZXRbInNjcmlwdCJdKS5lbmNvZGUoJ3V0Zi04Jyk7CgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXRbInNjcmlwdCJdID0gIHViaW5hc2NpaS5iMmFfYmFzZTY0KHJldFsic2NyaXB0Il0pLmRlY29kZSgndXRmLTgnKS5zdHJpcCgpOwogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4Y2VwdGlvbiB3aXRoIHNjcmlwdDogIiArIHJldFsic2NyaXB0Il0pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi50b29sKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsidG9vbCJdID0gc2VsZi50b29sKCkuX3RvRG9jdW1lbnQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuZ3JvdXAoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJncm91cCJdID0gc2VsZi5ncm91cCgpLl90b0RvY3VtZW50KCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLnR5cGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJ0eXBlIl0gPSBzZWxmLnR5cGUoKS5fdG9Eb2N1bWVudCgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5ub2RlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsibm9kZSJdID0gc2VsZi5ub2RlKCkuX3RvRG9jdW1lbnQoKTsKICAgICAgICAKICAgIAogICAgICAgIAogICAgCgogICAgICAgIGlmIGJKU09OIGlzIG5vdCBOb25lOgogICAgICAgICAgICAjcHJpbnQoX190b1N0cmluZyArICJHT1QgSEVSRSIsIHR5cGUocmV0KSwgcmV0KTsKICAgICAgICAgICAgcmV0ID0gdWpzb24uZHVtcHMocmV0KTsKICAgICAgICBnYy5jb2xsZWN0KCk7CiAgICAgICAgcmV0dXJuIHJldDsKCiAgICAKICAgIGRlZiBzdG9yZShzZWxmLCBfX2V2ZW50PU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnQ29uZmlnOjpzdG9yZSgpOiAnOwogICAgICAgIAogICAgICAgIGFuc3dlciA9IE5vbmU7CgogICAgICAgIF9fcmVzcG9uc2UgPSBFdmVudCgpLmNvZGUoJ1snK25vZGUuY29kZSgpKydAJytzdHIodGltZS50aWNrc19tcygpKSsnXS5Db25maWcuc3RvcmUoKScpLm1ldGhvZCgnc3RvcmUnKS5jbGFzc05hbWUoJ0NvbmZpZycpLmNhcnJpZXIobm9kZSkuc2VuZGVyKG5vZGUpLnJlY2lwaWVudChub2RlLnBhcmVudCgpKTsKCiAgICAgICAgZXZKU09OID0gTm9uZTsKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBldkpTT04gPSB1anNvbi5sb2FkcyhfX2V2ZW50LnBheWxvYWQoKSk7CiAgICAgICAgICAgIGlmICdfX3RoaXMnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIHNlbGYuX2Zyb21Eb2N1bWVudChldkpTT05bJ19fdGhpcyddKTsKICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS5yZXNwb25zZVRvKF9fZXZlbnQuX3VuaXF1ZSgpKTsKICAgICAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiIGhhbmRsaW5nIGV2ZW50WyIrX19ldmVudC5jb2RlKCkrIl0iKTsKCiAgICAgICAgCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiYSByZXNwb25zZSB0byBteSBldmVudCgiK19fZXZlbnQucmVzcG9uc2VUbygpLmNvZGUoKSsiKSBbIiArIF9fZXZlbnQuY2xhc3NOYW1lKCkgKyAiKCkuIiArIF9fZXZlbnQubWV0aG9kKCkgKyAiKCldIik7CiAgICAgICAgCiAgICAgICAgICAgIGFuc3dlciA9IENvbmZpZygpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiBmaW5kQWxsKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdDb25maWc6OmZpbmRBbGwoKTogJzsKICAgICAgICAKICAgICAgICBhbnN3ZXIgPSBOb25lOwoKICAgICAgICBfX3Jlc3BvbnNlID0gRXZlbnQoKS5jb2RlKCdbJytub2RlLmNvZGUoKSsnQCcrc3RyKHRpbWUudGlja3NfbXMoKSkrJ10uQ29uZmlnLmZpbmRBbGwoKScpLm1ldGhvZCgnZmluZEFsbCcpLmNsYXNzTmFtZSgnQ29uZmlnJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gQ29uZmlnKCkuX2Zyb21Eb2N1bWVudChldkpTT04pOwogICAgICAgIAoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4ZWN1dGluZyBsb2NhbGx5Iik7CgoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmUgb3IgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgaWYgYW5zd2VyIGlzIG5vdCBOb25lOgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZChhbnN3ZXIuX3RvRG9jdW1lbnQoKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKHsiX190aGlzIjogc2VsZi5fdG9Eb2N1bWVudCgpfSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS50cmlnZ2VyKCk7CiAgICAgICAgICAgIAoKICAgICAgICByZXR1cm4gYW5zd2VyOwoKICAgIAogICAgZGVmIGZpbmQoc2VsZiwgX19ldmVudD1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ0NvbmZpZzo6ZmluZCgpOiAnOwogICAgICAgIAogICAgICAgIGFuc3dlciA9IE5vbmU7CgogICAgICAgIF9fcmVzcG9uc2UgPSBFdmVudCgpLmNvZGUoJ1snK25vZGUuY29kZSgpKydAJytzdHIodGltZS50aWNrc19tcygpKSsnXS5Db25maWcuZmluZCgpJykubWV0aG9kKCdmaW5kJykuY2xhc3NOYW1lKCdDb25maWcnKS5jYXJyaWVyKG5vZGUpLnNlbmRlcihub2RlKS5yZWNpcGllbnQobm9kZS5wYXJlbnQoKSk7CgogICAgICAgIGV2SlNPTiA9IE5vbmU7CiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgZXZKU09OID0gdWpzb24ubG9hZHMoX19ldmVudC5wYXlsb2FkKCkpOwogICAgICAgICAgICBpZiAnX190aGlzJyBpbiBldkpTT046CiAgICAgICAgICAgICAgICBzZWxmLl9mcm9tRG9jdW1lbnQoZXZKU09OWydfX3RoaXMnXSk7CiAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UucmVzcG9uc2VUbyhfX2V2ZW50Ll91bmlxdWUoKSk7CiAgICAgICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgIiBoYW5kbGluZyBldmVudFsiK19fZXZlbnQuY29kZSgpKyJdIik7CgogICAgICAgIAogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImEgcmVzcG9uc2UgdG8gbXkgZXZlbnQoIitfX2V2ZW50LnJlc3BvbnNlVG8oKS5jb2RlKCkrIikgWyIgKyBfX2V2ZW50LmNsYXNzTmFtZSgpICsgIigpLiIgKyBfX2V2ZW50Lm1ldGhvZCgpICsgIigpXSIpOwogICAgICAgIAogICAgICAgICAgICBhbnN3ZXIgPSBDb25maWcoKS5fZnJvbURvY3VtZW50KGV2SlNPTik7CiAgICAgICAgCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhlY3V0aW5nIGxvY2FsbHkiKTsKCgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZSBvciBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBpZiBhbnN3ZXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKGFuc3dlci5fdG9Eb2N1bWVudCgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoeyJfX3RoaXMiOiBzZWxmLl90b0RvY3VtZW50KCl9KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnRyaWdnZXIoKTsKICAgICAgICAgICAgCgogICAgICAgIHJldHVybiBhbnN3ZXI7CgogICAgCgoKY2xhc3MgVG9vbCgpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIElkPU5vbmUsIGFjdGl2ZT1Ob25lLCBlbmFibGVkPU5vbmUsIGNvZGU9Tm9uZSwgb3JkZXI9Tm9uZSwgZGF0ZT1Ob25lLCBuYW1lPU5vbmUsIHJlbWFyaz1Ob25lLCB0eXBlPU5vbmUpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKTsKCiAgICAgICAgI3ByaW50KCdUb29sOjpfX2luaXRfXygpJyk7CiAgICAgICAgaWYgSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHNlbGYuSWQgPSBJZDsKCiAgICAgICAgCiAgICAgICAgc2VsZi5hY3RpdmUoYWN0aXZlKTsKICAgICAgICBzZWxmLmVuYWJsZWQoZW5hYmxlZCk7CiAgICAgICAgc2VsZi5jb2RlKGNvZGUpOwogICAgICAgIHNlbGYub3JkZXIob3JkZXIpOwogICAgICAgIHNlbGYuZGF0ZShkYXRlKTsKICAgICAgICBzZWxmLm5hbWUobmFtZSk7CiAgICAgICAgc2VsZi5yZW1hcmsocmVtYXJrKTsKICAgICAgICBzZWxmLnR5cGUodHlwZSk7CiAgICAgICAgCiAgICBJZCA9IE5vbmU7CiAgICAKICAgIAogICAgIyBhY3RpdmU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9hY3RpdmUgPSBOb25lOwogICAgZGVmIGFjdGl2ZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fYWN0aXZlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fYWN0aXZlOwogICAgCiAgICAjIGVuYWJsZWQ6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9lbmFibGVkID0gTm9uZTsKICAgIGRlZiBlbmFibGVkKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9lbmFibGVkID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZW5hYmxlZDsKICAgIAogICAgIyBjb2RlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfY29kZSA9IE5vbmU7CiAgICBkZWYgY29kZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fY29kZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NvZGU7CiAgICAKICAgICMgb3JkZXI6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9vcmRlciA9IE5vbmU7CiAgICBkZWYgb3JkZXIoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX29yZGVyID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fb3JkZXI7CiAgICAKICAgICMgZGF0ZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2RhdGUgPSBOb25lOwogICAgZGVmIGRhdGUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2RhdGUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIGlmIHNlbGYuX2RhdGU9PSd7e25vd319JzoKICAgICAgICAgICAgICAgIHNlbGYuX2RhdGUgPSB0aW1lLnRpY2tzX21zKCk7CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2RhdGU7CiAgICAKICAgICMgbmFtZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX25hbWUgPSBOb25lOwogICAgZGVmIG5hbWUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX25hbWUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9uYW1lOwogICAgCiAgICAjIHJlbWFyazogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3JlbWFyayA9IE5vbmU7CiAgICBkZWYgcmVtYXJrKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9yZW1hcmsgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9yZW1hcms7CiAgICAKICAgICMgdHlwZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3R5cGUgPSBOb25lOwogICAgZGVmIHR5cGUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX3R5cGUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl90eXBlOwogICAgCiAgICAKICAgIAogICAgIyB0b29sX0NvbmZpZ3M6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF90b29sX0NvbmZpZ3MgPSBOb25lOwogICAgZGVmIHRvb2xfQ29uZmlncyhzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fdG9vbF9Db25maWdzID0gYXJnc1swXTsKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3Rvb2xfQ29uZmlnczsKICAgIAogICAgIyB0b29sX01hcHBpbmdzOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfdG9vbF9NYXBwaW5ncyA9IE5vbmU7CiAgICBkZWYgdG9vbF9NYXBwaW5ncyhzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fdG9vbF9NYXBwaW5ncyA9IGFyZ3NbMF07CiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl90b29sX01hcHBpbmdzOwogICAgCiAgICAKICAgIGRlZiBfdW5pcXVlKHNlbGYpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnVG9vbDo6X3VuaXF1ZSgpOiAnOwogICAgICAgIAogICAgICAgIHJldCA9IFRvb2woKTsKICAgICAgICBpZiBzZWxmLklkIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXQuSWQgPSBzZWxmLklkOwogICAgCiAgICAgICAgaWYgc2VsZi5uYW1lKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldC5uYW1lKHNlbGYubmFtZSgpKTsKICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gcmV0OwogICAgCiAgICBkZWYgX2Zyb21Eb2N1bWVudChzZWxmLCBvYmopOgogICAgICAgIF9fdG9TdHJpbmcgPSAnVG9vbDo6X2Zyb21Eb2N1bWVudCgpOiAnOwogICAgICAgIAogICAgICAgIGlmIG9iaiBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gc2VsZjsKCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIGJ5dGVzKToKICAgICAgICAgICAgb2JqID0gc3RyKG9iaiwgInV0Zi04Iik7CgogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBzdHIpIG9yIHR5cGUob2JqKSBpcyBzdHI6CiAgICAgICAgICAgIGlmIHJlLm1hdGNoKHIiKCgoW0EtWmEtel17Myw5fTooPzpcL1wvKT8pKD86Wy07OiY9XCtcJCxcd10rQCk/W0EtWmEtejAtOS4tXSt8KD86d3d3LnxbLTs6Jj1cK1wkLFx3XStAKVtBLVphLXowLTkuLV0rKSgoPzpcL1tcK34lXC8uXHdcLV9dKik/XD8/KD86Wy1cKz0mOyVALlx3X10qKSM/KD86W1x3XSopKT8pIiwgb2JqKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBvYmogPSB1anNvbi5sb2Fkcyh1cmxsaWIzLlBvb2xNYW5hZ2VyKCkucmVxdWVzdCgnR0VUJywgb2JqKS5kYXRhLmRlY29kZSgndXRmLTgnKSk7CiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgb2JqID0ge307CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBvYmogPSB1anNvbi5sb2FkcyhvYmopOwogICAgICAgIAogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBsaXN0KToKICAgICAgICAgICAgcmV0dXJuIFtUb29sKCkuX2Zyb21Eb2N1bWVudChvKSBmb3IgbyBpbiBvYmpdOwogICAgICAgICAgICAKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShvYmosIChzdHIsIGJ5dGVzLCBkaWN0KSk6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAndW5oYW5kbGVkIHR5cGU6ICcgKyBzdHIodHlwZShvYmopKSk7CiAgICAgICAgICAgIHJldHVybiBvYmo7CgogICAgICAgIGlmICdJZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLklkID0gb2JqWydJZCddOwoKICAgIAogICAgICAgIGlmICdhY3RpdmUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5hY3RpdmUob2JqWydhY3RpdmUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZW5hYmxlZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmVuYWJsZWQob2JqWydlbmFibGVkJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2NvZGUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5jb2RlKG9ialsnY29kZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdvcmRlcicgaW4gb2JqOgogICAgICAgICAgICBzZWxmLm9yZGVyKG9ialsnb3JkZXInXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZGF0ZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmRhdGUob2JqWydkYXRlJ10pOwogICAgICAgIAogICAgICAgICAgICBzZWxmLmRhdGUoZGF0ZXRpbWUuZGF0ZXRpbWUuZnJvbWlzb2Zvcm1hdChzZWxmLmRhdGUoKSkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ25hbWUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5uYW1lKG9ialsnbmFtZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdyZW1hcmsnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5yZW1hcmsob2JqWydyZW1hcmsnXSk7CiAgICAgICAgCiAgICAgICAgICAgIHNlbGYucmVtYXJrKCB1YmluYXNjaWkuYTJiX2Jhc2U2NChzZWxmLnJlbWFyaygpKSApOwogICAgICAgICAgICBpZiBzZWxmLnJlbWFyaygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVtYXJrKHNlbGYucmVtYXJrKCkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCkpOwogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVtYXJrKCk7CiAgICAgICAgICAgICAgICAgICAgI3ByaW50KF9fdG9TdHJpbmcgKyAicmVtYXJrIGV4Y2VwdGlvbiIsIHNlbGYucmVtYXJrKCkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ3R5cGUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi50eXBlKFRvb2xfVHlwZSgpLl9mcm9tRG9jdW1lbnQob2JqWyd0eXBlJ10pKTsKICAgICAgICAKICAgIAoKICAgIAogICAgICAgIGlmICd0b29sX0NvbmZpZ3MnIGluIG9iajoKICAgICAgICAgICAgc2VsZi50b29sX0NvbmZpZ3MoQ29uZmlnKCkuX2Zyb21Eb2N1bWVudChvYmpbJ3Rvb2xfQ29uZmlncyddKSk7CiAgICAKICAgICAgICBpZiAndG9vbF9NYXBwaW5ncycgaW4gb2JqOgogICAgICAgICAgICBzZWxmLnRvb2xfTWFwcGluZ3MoTWFwcGluZygpLl9mcm9tRG9jdW1lbnQob2JqWyd0b29sX01hcHBpbmdzJ10pKTsKICAgIAoKICAgICAgICBnYy5jb2xsZWN0KCk7CiAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAKICAgIGRlZiBfdG9Eb2N1bWVudChzZWxmLCBiSlNPTj1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ1Rvb2w6Ol90b0RvY3VtZW50KCk6ICc7CgogICAgICAgIHJldCA9IHt9OwogICAgICAgIGlmIHNlbGYuSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiSWQiXSA9IHNlbGYuSWQ7CgogICAgCiAgICAgICAgaWYgc2VsZi5hY3RpdmUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJhY3RpdmUiXSA9IHNlbGYuYWN0aXZlKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmVuYWJsZWQoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJlbmFibGVkIl0gPSBzZWxmLmVuYWJsZWQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuY29kZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImNvZGUiXSA9IHNlbGYuY29kZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5vcmRlcigpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIm9yZGVyIl0gPSBzZWxmLm9yZGVyKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmRhdGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJkYXRlIl0gPSBzZWxmLmRhdGUoKTsKICAgICAgICAKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXRbImRhdGUiXSwgZGF0ZXRpbWUuZGF0ZXRpbWUpOgogICAgICAgICAgICAgICAgcmV0WyJkYXRlIl0gPSByZXRbImRhdGUiXS5pc29mb3JtYXQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYubmFtZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIm5hbWUiXSA9IHNlbGYubmFtZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5yZW1hcmsoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9IHNlbGYucmVtYXJrKCk7CiAgICAgICAgCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmV0WyJyZW1hcmsiXSwgZGljdCk6CiAgICAgICAgICAgICAgICByZXRbInJlbWFyayJdID0gdWpzb24uZHVtcHMocmV0WyJyZW1hcmsiXSkuZW5jb2RlKCd1dGYtOCcpOwoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9ICB1YmluYXNjaWkuYjJhX2Jhc2U2NChyZXRbInJlbWFyayJdKS5kZWNvZGUoJ3V0Zi04Jykuc3RyaXAoKTsKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGNlcHRpb24gd2l0aCByZW1hcms6ICIgKyByZXRbInJlbWFyayJdKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYudHlwZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbInR5cGUiXSA9IHNlbGYudHlwZSgpLl90b0RvY3VtZW50KCk7CiAgICAgICAgCiAgICAKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYudG9vbF9Db25maWdzKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsidG9vbF9Db25maWdzIl0gPSBbdGEuX3RvRG9jdW1lbnQoKSBmb3IgdGEgaW4gc2VsZi50b29sX0NvbmZpZ3MoKV07CiAgICAKICAgICAgICBpZiBzZWxmLnRvb2xfTWFwcGluZ3MoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJ0b29sX01hcHBpbmdzIl0gPSBbdGEuX3RvRG9jdW1lbnQoKSBmb3IgdGEgaW4gc2VsZi50b29sX01hcHBpbmdzKCldOwogICAgCgogICAgICAgIGlmIGJKU09OIGlzIG5vdCBOb25lOgogICAgICAgICAgICAjcHJpbnQoX190b1N0cmluZyArICJHT1QgSEVSRSIsIHR5cGUocmV0KSwgcmV0KTsKICAgICAgICAgICAgcmV0ID0gdWpzb24uZHVtcHMocmV0KTsKICAgICAgICBnYy5jb2xsZWN0KCk7CiAgICAgICAgcmV0dXJuIHJldDsKCiAgICAKICAgIGRlZiBzdG9yZShzZWxmLCBfX2V2ZW50PU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnVG9vbDo6c3RvcmUoKTogJzsKICAgICAgICAKICAgICAgICBhbnN3ZXIgPSBOb25lOwoKICAgICAgICBfX3Jlc3BvbnNlID0gRXZlbnQoKS5jb2RlKCdbJytub2RlLmNvZGUoKSsnQCcrc3RyKHRpbWUudGlja3NfbXMoKSkrJ10uVG9vbC5zdG9yZSgpJykubWV0aG9kKCdzdG9yZScpLmNsYXNzTmFtZSgnVG9vbCcpLmNhcnJpZXIobm9kZSkuc2VuZGVyKG5vZGUpLnJlY2lwaWVudChub2RlLnBhcmVudCgpKTsKCiAgICAgICAgZXZKU09OID0gTm9uZTsKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBldkpTT04gPSB1anNvbi5sb2FkcyhfX2V2ZW50LnBheWxvYWQoKSk7CiAgICAgICAgICAgIGlmICdfX3RoaXMnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIHNlbGYuX2Zyb21Eb2N1bWVudChldkpTT05bJ19fdGhpcyddKTsKICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS5yZXNwb25zZVRvKF9fZXZlbnQuX3VuaXF1ZSgpKTsKICAgICAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiIGhhbmRsaW5nIGV2ZW50WyIrX19ldmVudC5jb2RlKCkrIl0iKTsKCiAgICAgICAgCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiYSByZXNwb25zZSB0byBteSBldmVudCgiK19fZXZlbnQucmVzcG9uc2VUbygpLmNvZGUoKSsiKSBbIiArIF9fZXZlbnQuY2xhc3NOYW1lKCkgKyAiKCkuIiArIF9fZXZlbnQubWV0aG9kKCkgKyAiKCldIik7CiAgICAgICAgCiAgICAgICAgICAgIGFuc3dlciA9IFRvb2woKS5fZnJvbURvY3VtZW50KGV2SlNPTik7CiAgICAgICAgCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhlY3V0aW5nIGxvY2FsbHkiKTsKCgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZSBvciBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBpZiBhbnN3ZXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKGFuc3dlci5fdG9Eb2N1bWVudCgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoeyJfX3RoaXMiOiBzZWxmLl90b0RvY3VtZW50KCl9KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnRyaWdnZXIoKTsKICAgICAgICAgICAgCgogICAgICAgIHJldHVybiBhbnN3ZXI7CgogICAgCiAgICBkZWYgZmluZEFsbChzZWxmLCBfX2V2ZW50PU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnVG9vbDo6ZmluZEFsbCgpOiAnOwogICAgICAgIAogICAgICAgIGFuc3dlciA9IE5vbmU7CgogICAgICAgIF9fcmVzcG9uc2UgPSBFdmVudCgpLmNvZGUoJ1snK25vZGUuY29kZSgpKydAJytzdHIodGltZS50aWNrc19tcygpKSsnXS5Ub29sLmZpbmRBbGwoKScpLm1ldGhvZCgnZmluZEFsbCcpLmNsYXNzTmFtZSgnVG9vbCcpLmNhcnJpZXIobm9kZSkuc2VuZGVyKG5vZGUpLnJlY2lwaWVudChub2RlLnBhcmVudCgpKTsKCiAgICAgICAgZXZKU09OID0gTm9uZTsKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBldkpTT04gPSB1anNvbi5sb2FkcyhfX2V2ZW50LnBheWxvYWQoKSk7CiAgICAgICAgICAgIGlmICdfX3RoaXMnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIHNlbGYuX2Zyb21Eb2N1bWVudChldkpTT05bJ19fdGhpcyddKTsKICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS5yZXNwb25zZVRvKF9fZXZlbnQuX3VuaXF1ZSgpKTsKICAgICAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiIGhhbmRsaW5nIGV2ZW50WyIrX19ldmVudC5jb2RlKCkrIl0iKTsKCiAgICAgICAgCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiYSByZXNwb25zZSB0byBteSBldmVudCgiK19fZXZlbnQucmVzcG9uc2VUbygpLmNvZGUoKSsiKSBbIiArIF9fZXZlbnQuY2xhc3NOYW1lKCkgKyAiKCkuIiArIF9fZXZlbnQubWV0aG9kKCkgKyAiKCldIik7CiAgICAgICAgCiAgICAgICAgICAgIGFuc3dlciA9IFRvb2woKS5fZnJvbURvY3VtZW50KGV2SlNPTik7CiAgICAgICAgCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhlY3V0aW5nIGxvY2FsbHkiKTsKCgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZSBvciBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBpZiBhbnN3ZXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKGFuc3dlci5fdG9Eb2N1bWVudCgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoeyJfX3RoaXMiOiBzZWxmLl90b0RvY3VtZW50KCl9KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnRyaWdnZXIoKTsKICAgICAgICAgICAgCgogICAgICAgIHJldHVybiBhbnN3ZXI7CgogICAgCiAgICBkZWYgZmluZChzZWxmLCBfX2V2ZW50PU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnVG9vbDo6ZmluZCgpOiAnOwogICAgICAgIAogICAgICAgIGFuc3dlciA9IE5vbmU7CgogICAgICAgIF9fcmVzcG9uc2UgPSBFdmVudCgpLmNvZGUoJ1snK25vZGUuY29kZSgpKydAJytzdHIodGltZS50aWNrc19tcygpKSsnXS5Ub29sLmZpbmQoKScpLm1ldGhvZCgnZmluZCcpLmNsYXNzTmFtZSgnVG9vbCcpLmNhcnJpZXIobm9kZSkuc2VuZGVyKG5vZGUpLnJlY2lwaWVudChub2RlLnBhcmVudCgpKTsKCiAgICAgICAgZXZKU09OID0gTm9uZTsKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBldkpTT04gPSB1anNvbi5sb2FkcyhfX2V2ZW50LnBheWxvYWQoKSk7CiAgICAgICAgICAgIGlmICdfX3RoaXMnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIHNlbGYuX2Zyb21Eb2N1bWVudChldkpTT05bJ19fdGhpcyddKTsKICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS5yZXNwb25zZVRvKF9fZXZlbnQuX3VuaXF1ZSgpKTsKICAgICAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiIGhhbmRsaW5nIGV2ZW50WyIrX19ldmVudC5jb2RlKCkrIl0iKTsKCiAgICAgICAgCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiYSByZXNwb25zZSB0byBteSBldmVudCgiK19fZXZlbnQucmVzcG9uc2VUbygpLmNvZGUoKSsiKSBbIiArIF9fZXZlbnQuY2xhc3NOYW1lKCkgKyAiKCkuIiArIF9fZXZlbnQubWV0aG9kKCkgKyAiKCldIik7CiAgICAgICAgCiAgICAgICAgICAgIGFuc3dlciA9IFRvb2woKS5fZnJvbURvY3VtZW50KGV2SlNPTik7CiAgICAgICAgCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhlY3V0aW5nIGxvY2FsbHkiKTsKCgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZSBvciBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBpZiBhbnN3ZXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKGFuc3dlci5fdG9Eb2N1bWVudCgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoeyJfX3RoaXMiOiBzZWxmLl90b0RvY3VtZW50KCl9KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnRyaWdnZXIoKTsKICAgICAgICAgICAgCgogICAgICAgIHJldHVybiBhbnN3ZXI7CgogICAgCgoKY2xhc3MgQ29uZmlnX0dyb3VwKCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgSWQ9Tm9uZSwgYWN0aXZlPU5vbmUsIGVuYWJsZWQ9Tm9uZSwgY29kZT1Ob25lLCBvcmRlcj1Ob25lLCBkYXRlPU5vbmUsIG5hbWU9Tm9uZSwgcmVtYXJrPU5vbmUpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKTsKCiAgICAgICAgI3ByaW50KCdDb25maWdfR3JvdXA6Ol9faW5pdF9fKCknKTsKICAgICAgICBpZiBJZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgc2VsZi5JZCA9IElkOwoKICAgICAgICAKICAgICAgICBzZWxmLmFjdGl2ZShhY3RpdmUpOwogICAgICAgIHNlbGYuZW5hYmxlZChlbmFibGVkKTsKICAgICAgICBzZWxmLmNvZGUoY29kZSk7CiAgICAgICAgc2VsZi5vcmRlcihvcmRlcik7CiAgICAgICAgc2VsZi5kYXRlKGRhdGUpOwogICAgICAgIHNlbGYubmFtZShuYW1lKTsKICAgICAgICBzZWxmLnJlbWFyayhyZW1hcmspOwogICAgICAgIAogICAgSWQgPSBOb25lOwogICAgCiAgICAKICAgICMgYWN0aXZlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfYWN0aXZlID0gTm9uZTsKICAgIGRlZiBhY3RpdmUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2FjdGl2ZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2FjdGl2ZTsKICAgIAogICAgIyBlbmFibGVkOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfZW5hYmxlZCA9IE5vbmU7CiAgICBkZWYgZW5hYmxlZChzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fZW5hYmxlZCA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2VuYWJsZWQ7CiAgICAKICAgICMgY29kZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2NvZGUgPSBOb25lOwogICAgZGVmIGNvZGUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2NvZGUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jb2RlOwogICAgCiAgICAjIG9yZGVyOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfb3JkZXIgPSBOb25lOwogICAgZGVmIG9yZGVyKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9vcmRlciA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX29yZGVyOwogICAgCiAgICAjIGRhdGU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9kYXRlID0gTm9uZTsKICAgIGRlZiBkYXRlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9kYXRlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICBpZiBzZWxmLl9kYXRlPT0ne3tub3d9fSc6CiAgICAgICAgICAgICAgICBzZWxmLl9kYXRlID0gdGltZS50aWNrc19tcygpOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9kYXRlOwogICAgCiAgICAjIG5hbWU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9uYW1lID0gTm9uZTsKICAgIGRlZiBuYW1lKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9uYW1lID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fbmFtZTsKICAgIAogICAgIyByZW1hcms6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9yZW1hcmsgPSBOb25lOwogICAgZGVmIHJlbWFyayhzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fcmVtYXJrID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fcmVtYXJrOwogICAgCiAgICAKICAgIAogICAgIyBncm91cF9Db25maWdzOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfZ3JvdXBfQ29uZmlncyA9IE5vbmU7CiAgICBkZWYgZ3JvdXBfQ29uZmlncyhzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fZ3JvdXBfQ29uZmlncyA9IGFyZ3NbMF07CiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9ncm91cF9Db25maWdzOwogICAgCiAgICAjIGdyb3VwX01hcHBpbmdzOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfZ3JvdXBfTWFwcGluZ3MgPSBOb25lOwogICAgZGVmIGdyb3VwX01hcHBpbmdzKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9ncm91cF9NYXBwaW5ncyA9IGFyZ3NbMF07CiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9ncm91cF9NYXBwaW5nczsKICAgIAogICAgCiAgICBkZWYgX3VuaXF1ZShzZWxmKToKICAgICAgICBfX3RvU3RyaW5nID0gJ0NvbmZpZ19Hcm91cDo6X3VuaXF1ZSgpOiAnOwogICAgICAgIAogICAgICAgIHJldCA9IENvbmZpZ19Hcm91cCgpOwogICAgICAgIGlmIHNlbGYuSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldC5JZCA9IHNlbGYuSWQ7CiAgICAKICAgICAgICBpZiBzZWxmLmNvZGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0LmNvZGUoc2VsZi5jb2RlKCkpOwogICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwogICAgICAgIHJldHVybiByZXQ7CiAgICAKICAgIGRlZiBfZnJvbURvY3VtZW50KHNlbGYsIG9iaik6CiAgICAgICAgX190b1N0cmluZyA9ICdDb25maWdfR3JvdXA6Ol9mcm9tRG9jdW1lbnQoKTogJzsKICAgICAgICAKICAgICAgICBpZiBvYmogaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CgogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBieXRlcyk6CiAgICAgICAgICAgIG9iaiA9IHN0cihvYmosICJ1dGYtOCIpOwoKICAgICAgICBpZiBpc2luc3RhbmNlKG9iaiwgc3RyKSBvciB0eXBlKG9iaikgaXMgc3RyOgogICAgICAgICAgICBpZiByZS5tYXRjaChyIigoKFtBLVphLXpdezMsOX06KD86XC9cLyk/KSg/OlstOzomPVwrXCQsXHddK0ApP1tBLVphLXowLTkuLV0rfCg/Ond3dy58Wy07OiY9XCtcJCxcd10rQClbQS1aYS16MC05Li1dKykoKD86XC9bXCt+JVwvLlx3XC1fXSopP1w/Pyg/OlstXCs9JjslQC5cd19dKikjPyg/Oltcd10qKSk/KSIsIG9iaik6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgb2JqID0gdWpzb24ubG9hZHModXJsbGliMy5Qb29sTWFuYWdlcigpLnJlcXVlc3QoJ0dFVCcsIG9iaikuZGF0YS5kZWNvZGUoJ3V0Zi04JykpOwogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIG9iaiA9IHt9OwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgb2JqID0gdWpzb24ubG9hZHMob2JqKTsKICAgICAgICAKICAgICAgICBpZiBpc2luc3RhbmNlKG9iaiwgbGlzdCk6CiAgICAgICAgICAgIHJldHVybiBbQ29uZmlnX0dyb3VwKCkuX2Zyb21Eb2N1bWVudChvKSBmb3IgbyBpbiBvYmpdOwogICAgICAgICAgICAKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShvYmosIChzdHIsIGJ5dGVzLCBkaWN0KSk6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAndW5oYW5kbGVkIHR5cGU6ICcgKyBzdHIodHlwZShvYmopKSk7CiAgICAgICAgICAgIHJldHVybiBvYmo7CgogICAgICAgIGlmICdJZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLklkID0gb2JqWydJZCddOwoKICAgIAogICAgICAgIGlmICdhY3RpdmUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5hY3RpdmUob2JqWydhY3RpdmUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZW5hYmxlZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmVuYWJsZWQob2JqWydlbmFibGVkJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2NvZGUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5jb2RlKG9ialsnY29kZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdvcmRlcicgaW4gb2JqOgogICAgICAgICAgICBzZWxmLm9yZGVyKG9ialsnb3JkZXInXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZGF0ZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmRhdGUob2JqWydkYXRlJ10pOwogICAgICAgIAogICAgICAgICAgICBzZWxmLmRhdGUoZGF0ZXRpbWUuZGF0ZXRpbWUuZnJvbWlzb2Zvcm1hdChzZWxmLmRhdGUoKSkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ25hbWUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5uYW1lKG9ialsnbmFtZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdyZW1hcmsnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5yZW1hcmsob2JqWydyZW1hcmsnXSk7CiAgICAgICAgCiAgICAgICAgICAgIHNlbGYucmVtYXJrKCB1YmluYXNjaWkuYTJiX2Jhc2U2NChzZWxmLnJlbWFyaygpKSApOwogICAgICAgICAgICBpZiBzZWxmLnJlbWFyaygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVtYXJrKHNlbGYucmVtYXJrKCkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCkpOwogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVtYXJrKCk7CiAgICAgICAgICAgICAgICAgICAgI3ByaW50KF9fdG9TdHJpbmcgKyAicmVtYXJrIGV4Y2VwdGlvbiIsIHNlbGYucmVtYXJrKCkpOwogICAgICAgIAogICAgCgogICAgCiAgICAgICAgaWYgJ2dyb3VwX0NvbmZpZ3MnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5ncm91cF9Db25maWdzKENvbmZpZygpLl9mcm9tRG9jdW1lbnQob2JqWydncm91cF9Db25maWdzJ10pKTsKICAgIAogICAgICAgIGlmICdncm91cF9NYXBwaW5ncycgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmdyb3VwX01hcHBpbmdzKE1hcHBpbmcoKS5fZnJvbURvY3VtZW50KG9ialsnZ3JvdXBfTWFwcGluZ3MnXSkpOwogICAgCgogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gc2VsZjsKICAgIAogICAgZGVmIF90b0RvY3VtZW50KHNlbGYsIGJKU09OPU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnQ29uZmlnX0dyb3VwOjpfdG9Eb2N1bWVudCgpOiAnOwoKICAgICAgICByZXQgPSB7fTsKICAgICAgICBpZiBzZWxmLklkIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIklkIl0gPSBzZWxmLklkOwoKICAgIAogICAgICAgIGlmIHNlbGYuYWN0aXZlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiYWN0aXZlIl0gPSBzZWxmLmFjdGl2ZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5lbmFibGVkKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZW5hYmxlZCJdID0gc2VsZi5lbmFibGVkKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmNvZGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJjb2RlIl0gPSBzZWxmLmNvZGUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYub3JkZXIoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJvcmRlciJdID0gc2VsZi5vcmRlcigpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5kYXRlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZGF0ZSJdID0gc2VsZi5kYXRlKCk7CiAgICAgICAgCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmV0WyJkYXRlIl0sIGRhdGV0aW1lLmRhdGV0aW1lKToKICAgICAgICAgICAgICAgIHJldFsiZGF0ZSJdID0gcmV0WyJkYXRlIl0uaXNvZm9ybWF0KCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLm5hbWUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJuYW1lIl0gPSBzZWxmLm5hbWUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYucmVtYXJrKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsicmVtYXJrIl0gPSBzZWxmLnJlbWFyaygpOwogICAgICAgIAogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHJldFsicmVtYXJrIl0sIGRpY3QpOgogICAgICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9IHVqc29uLmR1bXBzKHJldFsicmVtYXJrIl0pLmVuY29kZSgndXRmLTgnKTsKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJldFsicmVtYXJrIl0gPSAgdWJpbmFzY2lpLmIyYV9iYXNlNjQocmV0WyJyZW1hcmsiXSkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCk7CiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhjZXB0aW9uIHdpdGggcmVtYXJrOiAiICsgcmV0WyJyZW1hcmsiXSk7CiAgICAgICAgCiAgICAKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuZ3JvdXBfQ29uZmlncygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImdyb3VwX0NvbmZpZ3MiXSA9IFt0YS5fdG9Eb2N1bWVudCgpIGZvciB0YSBpbiBzZWxmLmdyb3VwX0NvbmZpZ3MoKV07CiAgICAKICAgICAgICBpZiBzZWxmLmdyb3VwX01hcHBpbmdzKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZ3JvdXBfTWFwcGluZ3MiXSA9IFt0YS5fdG9Eb2N1bWVudCgpIGZvciB0YSBpbiBzZWxmLmdyb3VwX01hcHBpbmdzKCldOwogICAgCgogICAgICAgIGlmIGJKU09OIGlzIG5vdCBOb25lOgogICAgICAgICAgICAjcHJpbnQoX190b1N0cmluZyArICJHT1QgSEVSRSIsIHR5cGUocmV0KSwgcmV0KTsKICAgICAgICAgICAgcmV0ID0gdWpzb24uZHVtcHMocmV0KTsKICAgICAgICBnYy5jb2xsZWN0KCk7CiAgICAgICAgcmV0dXJuIHJldDsKCiAgICAKICAgIGRlZiBzdG9yZShzZWxmLCBfX2V2ZW50PU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnQ29uZmlnX0dyb3VwOjpzdG9yZSgpOiAnOwogICAgICAgIAogICAgICAgIGFuc3dlciA9IE5vbmU7CgogICAgICAgIF9fcmVzcG9uc2UgPSBFdmVudCgpLmNvZGUoJ1snK25vZGUuY29kZSgpKydAJytzdHIodGltZS50aWNrc19tcygpKSsnXS5Db25maWdfR3JvdXAuc3RvcmUoKScpLm1ldGhvZCgnc3RvcmUnKS5jbGFzc05hbWUoJ0NvbmZpZ19Hcm91cCcpLmNhcnJpZXIobm9kZSkuc2VuZGVyKG5vZGUpLnJlY2lwaWVudChub2RlLnBhcmVudCgpKTsKCiAgICAgICAgZXZKU09OID0gTm9uZTsKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBldkpTT04gPSB1anNvbi5sb2FkcyhfX2V2ZW50LnBheWxvYWQoKSk7CiAgICAgICAgICAgIGlmICdfX3RoaXMnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIHNlbGYuX2Zyb21Eb2N1bWVudChldkpTT05bJ19fdGhpcyddKTsKICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS5yZXNwb25zZVRvKF9fZXZlbnQuX3VuaXF1ZSgpKTsKICAgICAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiIGhhbmRsaW5nIGV2ZW50WyIrX19ldmVudC5jb2RlKCkrIl0iKTsKCiAgICAgICAgCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiYSByZXNwb25zZSB0byBteSBldmVudCgiK19fZXZlbnQucmVzcG9uc2VUbygpLmNvZGUoKSsiKSBbIiArIF9fZXZlbnQuY2xhc3NOYW1lKCkgKyAiKCkuIiArIF9fZXZlbnQubWV0aG9kKCkgKyAiKCldIik7CiAgICAgICAgCiAgICAgICAgICAgIGFuc3dlciA9IENvbmZpZ19Hcm91cCgpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiBmaW5kQWxsKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdDb25maWdfR3JvdXA6OmZpbmRBbGwoKTogJzsKICAgICAgICAKICAgICAgICBhbnN3ZXIgPSBOb25lOwoKICAgICAgICBfX3Jlc3BvbnNlID0gRXZlbnQoKS5jb2RlKCdbJytub2RlLmNvZGUoKSsnQCcrc3RyKHRpbWUudGlja3NfbXMoKSkrJ10uQ29uZmlnX0dyb3VwLmZpbmRBbGwoKScpLm1ldGhvZCgnZmluZEFsbCcpLmNsYXNzTmFtZSgnQ29uZmlnX0dyb3VwJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gQ29uZmlnX0dyb3VwKCkuX2Zyb21Eb2N1bWVudChldkpTT04pOwogICAgICAgIAoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4ZWN1dGluZyBsb2NhbGx5Iik7CgoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmUgb3IgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgaWYgYW5zd2VyIGlzIG5vdCBOb25lOgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZChhbnN3ZXIuX3RvRG9jdW1lbnQoKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKHsiX190aGlzIjogc2VsZi5fdG9Eb2N1bWVudCgpfSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS50cmlnZ2VyKCk7CiAgICAgICAgICAgIAoKICAgICAgICByZXR1cm4gYW5zd2VyOwoKICAgIAogICAgZGVmIGZpbmQoc2VsZiwgX19ldmVudD1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ0NvbmZpZ19Hcm91cDo6ZmluZCgpOiAnOwogICAgICAgIAogICAgICAgIGFuc3dlciA9IE5vbmU7CgogICAgICAgIF9fcmVzcG9uc2UgPSBFdmVudCgpLmNvZGUoJ1snK25vZGUuY29kZSgpKydAJytzdHIodGltZS50aWNrc19tcygpKSsnXS5Db25maWdfR3JvdXAuZmluZCgpJykubWV0aG9kKCdmaW5kJykuY2xhc3NOYW1lKCdDb25maWdfR3JvdXAnKS5jYXJyaWVyKG5vZGUpLnNlbmRlcihub2RlKS5yZWNpcGllbnQobm9kZS5wYXJlbnQoKSk7CgogICAgICAgIGV2SlNPTiA9IE5vbmU7CiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgZXZKU09OID0gdWpzb24ubG9hZHMoX19ldmVudC5wYXlsb2FkKCkpOwogICAgICAgICAgICBpZiAnX190aGlzJyBpbiBldkpTT046CiAgICAgICAgICAgICAgICBzZWxmLl9mcm9tRG9jdW1lbnQoZXZKU09OWydfX3RoaXMnXSk7CiAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UucmVzcG9uc2VUbyhfX2V2ZW50Ll91bmlxdWUoKSk7CiAgICAgICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgIiBoYW5kbGluZyBldmVudFsiK19fZXZlbnQuY29kZSgpKyJdIik7CgogICAgICAgIAogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImEgcmVzcG9uc2UgdG8gbXkgZXZlbnQoIitfX2V2ZW50LnJlc3BvbnNlVG8oKS5jb2RlKCkrIikgWyIgKyBfX2V2ZW50LmNsYXNzTmFtZSgpICsgIigpLiIgKyBfX2V2ZW50Lm1ldGhvZCgpICsgIigpXSIpOwogICAgICAgIAogICAgICAgICAgICBhbnN3ZXIgPSBDb25maWdfR3JvdXAoKS5fZnJvbURvY3VtZW50KGV2SlNPTik7CiAgICAgICAgCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhlY3V0aW5nIGxvY2FsbHkiKTsKCgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZSBvciBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBpZiBhbnN3ZXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKGFuc3dlci5fdG9Eb2N1bWVudCgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoeyJfX3RoaXMiOiBzZWxmLl90b0RvY3VtZW50KCl9KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnRyaWdnZXIoKTsKICAgICAgICAgICAgCgogICAgICAgIHJldHVybiBhbnN3ZXI7CgogICAgCgoKY2xhc3MgTWFwcGluZ19Hcm91cCgpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIElkPU5vbmUsIGFjdGl2ZT1Ob25lLCBlbmFibGVkPU5vbmUsIGNvZGU9Tm9uZSwgb3JkZXI9Tm9uZSwgZGF0ZT1Ob25lLCBuYW1lPU5vbmUsIHJlbWFyaz1Ob25lKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCk7CgogICAgICAgICNwcmludCgnTWFwcGluZ19Hcm91cDo6X19pbml0X18oKScpOwogICAgICAgIGlmIElkIGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLklkID0gSWQ7CgogICAgICAgIAogICAgICAgIHNlbGYuYWN0aXZlKGFjdGl2ZSk7CiAgICAgICAgc2VsZi5lbmFibGVkKGVuYWJsZWQpOwogICAgICAgIHNlbGYuY29kZShjb2RlKTsKICAgICAgICBzZWxmLm9yZGVyKG9yZGVyKTsKICAgICAgICBzZWxmLmRhdGUoZGF0ZSk7CiAgICAgICAgc2VsZi5uYW1lKG5hbWUpOwogICAgICAgIHNlbGYucmVtYXJrKHJlbWFyayk7CiAgICAgICAgCiAgICBJZCA9IE5vbmU7CiAgICAKICAgIAogICAgIyBhY3RpdmU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9hY3RpdmUgPSBOb25lOwogICAgZGVmIGFjdGl2ZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fYWN0aXZlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fYWN0aXZlOwogICAgCiAgICAjIGVuYWJsZWQ6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9lbmFibGVkID0gTm9uZTsKICAgIGRlZiBlbmFibGVkKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9lbmFibGVkID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZW5hYmxlZDsKICAgIAogICAgIyBjb2RlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfY29kZSA9IE5vbmU7CiAgICBkZWYgY29kZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fY29kZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NvZGU7CiAgICAKICAgICMgb3JkZXI6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9vcmRlciA9IE5vbmU7CiAgICBkZWYgb3JkZXIoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX29yZGVyID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fb3JkZXI7CiAgICAKICAgICMgZGF0ZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2RhdGUgPSBOb25lOwogICAgZGVmIGRhdGUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2RhdGUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIGlmIHNlbGYuX2RhdGU9PSd7e25vd319JzoKICAgICAgICAgICAgICAgIHNlbGYuX2RhdGUgPSB0aW1lLnRpY2tzX21zKCk7CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2RhdGU7CiAgICAKICAgICMgbmFtZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX25hbWUgPSBOb25lOwogICAgZGVmIG5hbWUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX25hbWUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9uYW1lOwogICAgCiAgICAjIHJlbWFyazogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3JlbWFyayA9IE5vbmU7CiAgICBkZWYgcmVtYXJrKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9yZW1hcmsgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9yZW1hcms7CiAgICAKICAgIAogICAgCiAgICAKICAgIGRlZiBfdW5pcXVlKHNlbGYpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnTWFwcGluZ19Hcm91cDo6X3VuaXF1ZSgpOiAnOwogICAgICAgIAogICAgICAgIHJldCA9IE1hcHBpbmdfR3JvdXAoKTsKICAgICAgICBpZiBzZWxmLklkIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXQuSWQgPSBzZWxmLklkOwogICAgCiAgICAgICAgaWYgc2VsZi5jb2RlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldC5jb2RlKHNlbGYuY29kZSgpKTsKICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gcmV0OwogICAgCiAgICBkZWYgX2Zyb21Eb2N1bWVudChzZWxmLCBvYmopOgogICAgICAgIF9fdG9TdHJpbmcgPSAnTWFwcGluZ19Hcm91cDo6X2Zyb21Eb2N1bWVudCgpOiAnOwogICAgICAgIAogICAgICAgIGlmIG9iaiBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gc2VsZjsKCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIGJ5dGVzKToKICAgICAgICAgICAgb2JqID0gc3RyKG9iaiwgInV0Zi04Iik7CgogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBzdHIpIG9yIHR5cGUob2JqKSBpcyBzdHI6CiAgICAgICAgICAgIGlmIHJlLm1hdGNoKHIiKCgoW0EtWmEtel17Myw5fTooPzpcL1wvKT8pKD86Wy07OiY9XCtcJCxcd10rQCk/W0EtWmEtejAtOS4tXSt8KD86d3d3LnxbLTs6Jj1cK1wkLFx3XStAKVtBLVphLXowLTkuLV0rKSgoPzpcL1tcK34lXC8uXHdcLV9dKik/XD8/KD86Wy1cKz0mOyVALlx3X10qKSM/KD86W1x3XSopKT8pIiwgb2JqKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBvYmogPSB1anNvbi5sb2Fkcyh1cmxsaWIzLlBvb2xNYW5hZ2VyKCkucmVxdWVzdCgnR0VUJywgb2JqKS5kYXRhLmRlY29kZSgndXRmLTgnKSk7CiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgb2JqID0ge307CiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBvYmogPSB1anNvbi5sb2FkcyhvYmopOwogICAgICAgIAogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBsaXN0KToKICAgICAgICAgICAgcmV0dXJuIFtNYXBwaW5nX0dyb3VwKCkuX2Zyb21Eb2N1bWVudChvKSBmb3IgbyBpbiBvYmpdOwogICAgICAgICAgICAKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShvYmosIChzdHIsIGJ5dGVzLCBkaWN0KSk6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAndW5oYW5kbGVkIHR5cGU6ICcgKyBzdHIodHlwZShvYmopKSk7CiAgICAgICAgICAgIHJldHVybiBvYmo7CgogICAgICAgIGlmICdJZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLklkID0gb2JqWydJZCddOwoKICAgIAogICAgICAgIGlmICdhY3RpdmUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5hY3RpdmUob2JqWydhY3RpdmUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZW5hYmxlZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmVuYWJsZWQob2JqWydlbmFibGVkJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2NvZGUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5jb2RlKG9ialsnY29kZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdvcmRlcicgaW4gb2JqOgogICAgICAgICAgICBzZWxmLm9yZGVyKG9ialsnb3JkZXInXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZGF0ZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmRhdGUob2JqWydkYXRlJ10pOwogICAgICAgIAogICAgICAgICAgICBzZWxmLmRhdGUoZGF0ZXRpbWUuZGF0ZXRpbWUuZnJvbWlzb2Zvcm1hdChzZWxmLmRhdGUoKSkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ25hbWUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5uYW1lKG9ialsnbmFtZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdyZW1hcmsnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5yZW1hcmsob2JqWydyZW1hcmsnXSk7CiAgICAgICAgCiAgICAgICAgICAgIHNlbGYucmVtYXJrKCB1YmluYXNjaWkuYTJiX2Jhc2U2NChzZWxmLnJlbWFyaygpKSApOwogICAgICAgICAgICBpZiBzZWxmLnJlbWFyaygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVtYXJrKHNlbGYucmVtYXJrKCkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCkpOwogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVtYXJrKCk7CiAgICAgICAgICAgICAgICAgICAgI3ByaW50KF9fdG9TdHJpbmcgKyAicmVtYXJrIGV4Y2VwdGlvbiIsIHNlbGYucmVtYXJrKCkpOwogICAgICAgIAogICAgCgogICAgCgogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gc2VsZjsKICAgIAogICAgZGVmIF90b0RvY3VtZW50KHNlbGYsIGJKU09OPU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnTWFwcGluZ19Hcm91cDo6X3RvRG9jdW1lbnQoKTogJzsKCiAgICAgICAgcmV0ID0ge307CiAgICAgICAgaWYgc2VsZi5JZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJJZCJdID0gc2VsZi5JZDsKCiAgICAKICAgICAgICBpZiBzZWxmLmFjdGl2ZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImFjdGl2ZSJdID0gc2VsZi5hY3RpdmUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuZW5hYmxlZCgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImVuYWJsZWQiXSA9IHNlbGYuZW5hYmxlZCgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5jb2RlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiY29kZSJdID0gc2VsZi5jb2RlKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLm9yZGVyKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsib3JkZXIiXSA9IHNlbGYub3JkZXIoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuZGF0ZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImRhdGUiXSA9IHNlbGYuZGF0ZSgpOwogICAgICAgIAogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHJldFsiZGF0ZSJdLCBkYXRldGltZS5kYXRldGltZSk6CiAgICAgICAgICAgICAgICByZXRbImRhdGUiXSA9IHJldFsiZGF0ZSJdLmlzb2Zvcm1hdCgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5uYW1lKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsibmFtZSJdID0gc2VsZi5uYW1lKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLnJlbWFyaygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbInJlbWFyayJdID0gc2VsZi5yZW1hcmsoKTsKICAgICAgICAKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXRbInJlbWFyayJdLCBkaWN0KToKICAgICAgICAgICAgICAgIHJldFsicmVtYXJrIl0gPSB1anNvbi5kdW1wcyhyZXRbInJlbWFyayJdKS5lbmNvZGUoJ3V0Zi04Jyk7CgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXRbInJlbWFyayJdID0gIHViaW5hc2NpaS5iMmFfYmFzZTY0KHJldFsicmVtYXJrIl0pLmRlY29kZSgndXRmLTgnKS5zdHJpcCgpOwogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4Y2VwdGlvbiB3aXRoIHJlbWFyazogIiArIHJldFsicmVtYXJrIl0pOwogICAgICAgIAogICAgCiAgICAgICAgCiAgICAKCiAgICAgICAgaWYgYkpTT04gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICNwcmludChfX3RvU3RyaW5nICsgIkdPVCBIRVJFIiwgdHlwZShyZXQpLCByZXQpOwogICAgICAgICAgICByZXQgPSB1anNvbi5kdW1wcyhyZXQpOwogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gcmV0OwoKICAgIAogICAgZGVmIHN0b3JlKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdNYXBwaW5nX0dyb3VwOjpzdG9yZSgpOiAnOwogICAgICAgIAogICAgICAgIGFuc3dlciA9IE5vbmU7CgogICAgICAgIF9fcmVzcG9uc2UgPSBFdmVudCgpLmNvZGUoJ1snK25vZGUuY29kZSgpKydAJytzdHIodGltZS50aWNrc19tcygpKSsnXS5NYXBwaW5nX0dyb3VwLnN0b3JlKCknKS5tZXRob2QoJ3N0b3JlJykuY2xhc3NOYW1lKCdNYXBwaW5nX0dyb3VwJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gTWFwcGluZ19Hcm91cCgpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiBmaW5kQWxsKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdNYXBwaW5nX0dyb3VwOjpmaW5kQWxsKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLk1hcHBpbmdfR3JvdXAuZmluZEFsbCgpJykubWV0aG9kKCdmaW5kQWxsJykuY2xhc3NOYW1lKCdNYXBwaW5nX0dyb3VwJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gTWFwcGluZ19Hcm91cCgpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiBmaW5kKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdNYXBwaW5nX0dyb3VwOjpmaW5kKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLk1hcHBpbmdfR3JvdXAuZmluZCgpJykubWV0aG9kKCdmaW5kJykuY2xhc3NOYW1lKCdNYXBwaW5nX0dyb3VwJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gTWFwcGluZ19Hcm91cCgpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKCgpjbGFzcyBUb29sX1R5cGUoKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBJZD1Ob25lLCBhY3RpdmU9Tm9uZSwgZW5hYmxlZD1Ob25lLCBjb2RlPU5vbmUsIG9yZGVyPU5vbmUsIGRhdGU9Tm9uZSwgbmFtZT1Ob25lLCByZW1hcms9Tm9uZSk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygpOwoKICAgICAgICAjcHJpbnQoJ1Rvb2xfVHlwZTo6X19pbml0X18oKScpOwogICAgICAgIGlmIElkIGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLklkID0gSWQ7CgogICAgICAgIAogICAgICAgIHNlbGYuYWN0aXZlKGFjdGl2ZSk7CiAgICAgICAgc2VsZi5lbmFibGVkKGVuYWJsZWQpOwogICAgICAgIHNlbGYuY29kZShjb2RlKTsKICAgICAgICBzZWxmLm9yZGVyKG9yZGVyKTsKICAgICAgICBzZWxmLmRhdGUoZGF0ZSk7CiAgICAgICAgc2VsZi5uYW1lKG5hbWUpOwogICAgICAgIHNlbGYucmVtYXJrKHJlbWFyayk7CiAgICAgICAgCiAgICBJZCA9IE5vbmU7CiAgICAKICAgIAogICAgIyBhY3RpdmU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9hY3RpdmUgPSBOb25lOwogICAgZGVmIGFjdGl2ZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fYWN0aXZlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fYWN0aXZlOwogICAgCiAgICAjIGVuYWJsZWQ6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9lbmFibGVkID0gTm9uZTsKICAgIGRlZiBlbmFibGVkKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9lbmFibGVkID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZW5hYmxlZDsKICAgIAogICAgIyBjb2RlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfY29kZSA9IE5vbmU7CiAgICBkZWYgY29kZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fY29kZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NvZGU7CiAgICAKICAgICMgb3JkZXI6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9vcmRlciA9IE5vbmU7CiAgICBkZWYgb3JkZXIoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX29yZGVyID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fb3JkZXI7CiAgICAKICAgICMgZGF0ZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2RhdGUgPSBOb25lOwogICAgZGVmIGRhdGUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2RhdGUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIGlmIHNlbGYuX2RhdGU9PSd7e25vd319JzoKICAgICAgICAgICAgICAgIHNlbGYuX2RhdGUgPSB0aW1lLnRpY2tzX21zKCk7CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2RhdGU7CiAgICAKICAgICMgbmFtZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX25hbWUgPSBOb25lOwogICAgZGVmIG5hbWUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX25hbWUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9uYW1lOwogICAgCiAgICAjIHJlbWFyazogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3JlbWFyayA9IE5vbmU7CiAgICBkZWYgcmVtYXJrKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9yZW1hcmsgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9yZW1hcms7CiAgICAKICAgIAogICAgCiAgICAjIHR5cGVfQ29uZmlnczogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3R5cGVfQ29uZmlncyA9IE5vbmU7CiAgICBkZWYgdHlwZV9Db25maWdzKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl90eXBlX0NvbmZpZ3MgPSBhcmdzWzBdOwogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fdHlwZV9Db25maWdzOwogICAgCiAgICAjIHR5cGVfVG9vbHM6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF90eXBlX1Rvb2xzID0gTm9uZTsKICAgIGRlZiB0eXBlX1Rvb2xzKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl90eXBlX1Rvb2xzID0gYXJnc1swXTsKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3R5cGVfVG9vbHM7CiAgICAKICAgICMgdHlwZV9NYXBwaW5nczogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3R5cGVfTWFwcGluZ3MgPSBOb25lOwogICAgZGVmIHR5cGVfTWFwcGluZ3Moc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX3R5cGVfTWFwcGluZ3MgPSBhcmdzWzBdOwogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fdHlwZV9NYXBwaW5nczsKICAgIAogICAgCiAgICBkZWYgX3VuaXF1ZShzZWxmKToKICAgICAgICBfX3RvU3RyaW5nID0gJ1Rvb2xfVHlwZTo6X3VuaXF1ZSgpOiAnOwogICAgICAgIAogICAgICAgIHJldCA9IFRvb2xfVHlwZSgpOwogICAgICAgIGlmIHNlbGYuSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldC5JZCA9IHNlbGYuSWQ7CiAgICAKICAgICAgICBpZiBzZWxmLm5hbWUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0Lm5hbWUoc2VsZi5uYW1lKCkpOwogICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwogICAgICAgIHJldHVybiByZXQ7CiAgICAKICAgIGRlZiBfZnJvbURvY3VtZW50KHNlbGYsIG9iaik6CiAgICAgICAgX190b1N0cmluZyA9ICdUb29sX1R5cGU6Ol9mcm9tRG9jdW1lbnQoKTogJzsKICAgICAgICAKICAgICAgICBpZiBvYmogaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CgogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBieXRlcyk6CiAgICAgICAgICAgIG9iaiA9IHN0cihvYmosICJ1dGYtOCIpOwoKICAgICAgICBpZiBpc2luc3RhbmNlKG9iaiwgc3RyKSBvciB0eXBlKG9iaikgaXMgc3RyOgogICAgICAgICAgICBpZiByZS5tYXRjaChyIigoKFtBLVphLXpdezMsOX06KD86XC9cLyk/KSg/OlstOzomPVwrXCQsXHddK0ApP1tBLVphLXowLTkuLV0rfCg/Ond3dy58Wy07OiY9XCtcJCxcd10rQClbQS1aYS16MC05Li1dKykoKD86XC9bXCt+JVwvLlx3XC1fXSopP1w/Pyg/OlstXCs9JjslQC5cd19dKikjPyg/Oltcd10qKSk/KSIsIG9iaik6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgb2JqID0gdWpzb24ubG9hZHModXJsbGliMy5Qb29sTWFuYWdlcigpLnJlcXVlc3QoJ0dFVCcsIG9iaikuZGF0YS5kZWNvZGUoJ3V0Zi04JykpOwogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIG9iaiA9IHt9OwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgb2JqID0gdWpzb24ubG9hZHMob2JqKTsKICAgICAgICAKICAgICAgICBpZiBpc2luc3RhbmNlKG9iaiwgbGlzdCk6CiAgICAgICAgICAgIHJldHVybiBbVG9vbF9UeXBlKCkuX2Zyb21Eb2N1bWVudChvKSBmb3IgbyBpbiBvYmpdOwogICAgICAgICAgICAKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShvYmosIChzdHIsIGJ5dGVzLCBkaWN0KSk6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAndW5oYW5kbGVkIHR5cGU6ICcgKyBzdHIodHlwZShvYmopKSk7CiAgICAgICAgICAgIHJldHVybiBvYmo7CgogICAgICAgIGlmICdJZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLklkID0gb2JqWydJZCddOwoKICAgIAogICAgICAgIGlmICdhY3RpdmUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5hY3RpdmUob2JqWydhY3RpdmUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZW5hYmxlZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmVuYWJsZWQob2JqWydlbmFibGVkJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2NvZGUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5jb2RlKG9ialsnY29kZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdvcmRlcicgaW4gb2JqOgogICAgICAgICAgICBzZWxmLm9yZGVyKG9ialsnb3JkZXInXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZGF0ZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmRhdGUob2JqWydkYXRlJ10pOwogICAgICAgIAogICAgICAgICAgICBzZWxmLmRhdGUoZGF0ZXRpbWUuZGF0ZXRpbWUuZnJvbWlzb2Zvcm1hdChzZWxmLmRhdGUoKSkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ25hbWUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5uYW1lKG9ialsnbmFtZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdyZW1hcmsnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5yZW1hcmsob2JqWydyZW1hcmsnXSk7CiAgICAgICAgCiAgICAgICAgICAgIHNlbGYucmVtYXJrKCB1YmluYXNjaWkuYTJiX2Jhc2U2NChzZWxmLnJlbWFyaygpKSApOwogICAgICAgICAgICBpZiBzZWxmLnJlbWFyaygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVtYXJrKHNlbGYucmVtYXJrKCkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCkpOwogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVtYXJrKCk7CiAgICAgICAgICAgICAgICAgICAgI3ByaW50KF9fdG9TdHJpbmcgKyAicmVtYXJrIGV4Y2VwdGlvbiIsIHNlbGYucmVtYXJrKCkpOwogICAgICAgIAogICAgCgogICAgCiAgICAgICAgaWYgJ3R5cGVfQ29uZmlncycgaW4gb2JqOgogICAgICAgICAgICBzZWxmLnR5cGVfQ29uZmlncyhDb25maWcoKS5fZnJvbURvY3VtZW50KG9ialsndHlwZV9Db25maWdzJ10pKTsKICAgIAogICAgICAgIGlmICd0eXBlX1Rvb2xzJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYudHlwZV9Ub29scyhUb29sKCkuX2Zyb21Eb2N1bWVudChvYmpbJ3R5cGVfVG9vbHMnXSkpOwogICAgCiAgICAgICAgaWYgJ3R5cGVfTWFwcGluZ3MnIGluIG9iajoKICAgICAgICAgICAgc2VsZi50eXBlX01hcHBpbmdzKE1hcHBpbmcoKS5fZnJvbURvY3VtZW50KG9ialsndHlwZV9NYXBwaW5ncyddKSk7CiAgICAKCiAgICAgICAgZ2MuY29sbGVjdCgpOwogICAgICAgIHJldHVybiBzZWxmOwogICAgCiAgICBkZWYgX3RvRG9jdW1lbnQoc2VsZiwgYkpTT049Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdUb29sX1R5cGU6Ol90b0RvY3VtZW50KCk6ICc7CgogICAgICAgIHJldCA9IHt9OwogICAgICAgIGlmIHNlbGYuSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiSWQiXSA9IHNlbGYuSWQ7CgogICAgCiAgICAgICAgaWYgc2VsZi5hY3RpdmUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJhY3RpdmUiXSA9IHNlbGYuYWN0aXZlKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmVuYWJsZWQoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJlbmFibGVkIl0gPSBzZWxmLmVuYWJsZWQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuY29kZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImNvZGUiXSA9IHNlbGYuY29kZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5vcmRlcigpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIm9yZGVyIl0gPSBzZWxmLm9yZGVyKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmRhdGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJkYXRlIl0gPSBzZWxmLmRhdGUoKTsKICAgICAgICAKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXRbImRhdGUiXSwgZGF0ZXRpbWUuZGF0ZXRpbWUpOgogICAgICAgICAgICAgICAgcmV0WyJkYXRlIl0gPSByZXRbImRhdGUiXS5pc29mb3JtYXQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYubmFtZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIm5hbWUiXSA9IHNlbGYubmFtZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5yZW1hcmsoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9IHNlbGYucmVtYXJrKCk7CiAgICAgICAgCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmV0WyJyZW1hcmsiXSwgZGljdCk6CiAgICAgICAgICAgICAgICByZXRbInJlbWFyayJdID0gdWpzb24uZHVtcHMocmV0WyJyZW1hcmsiXSkuZW5jb2RlKCd1dGYtOCcpOwoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9ICB1YmluYXNjaWkuYjJhX2Jhc2U2NChyZXRbInJlbWFyayJdKS5kZWNvZGUoJ3V0Zi04Jykuc3RyaXAoKTsKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGNlcHRpb24gd2l0aCByZW1hcms6ICIgKyByZXRbInJlbWFyayJdKTsKICAgICAgICAKICAgIAogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi50eXBlX0NvbmZpZ3MoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJ0eXBlX0NvbmZpZ3MiXSA9IFt0YS5fdG9Eb2N1bWVudCgpIGZvciB0YSBpbiBzZWxmLnR5cGVfQ29uZmlncygpXTsKICAgIAogICAgICAgIGlmIHNlbGYudHlwZV9Ub29scygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbInR5cGVfVG9vbHMiXSA9IFt0YS5fdG9Eb2N1bWVudCgpIGZvciB0YSBpbiBzZWxmLnR5cGVfVG9vbHMoKV07CiAgICAKICAgICAgICBpZiBzZWxmLnR5cGVfTWFwcGluZ3MoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJ0eXBlX01hcHBpbmdzIl0gPSBbdGEuX3RvRG9jdW1lbnQoKSBmb3IgdGEgaW4gc2VsZi50eXBlX01hcHBpbmdzKCldOwogICAgCgogICAgICAgIGlmIGJKU09OIGlzIG5vdCBOb25lOgogICAgICAgICAgICAjcHJpbnQoX190b1N0cmluZyArICJHT1QgSEVSRSIsIHR5cGUocmV0KSwgcmV0KTsKICAgICAgICAgICAgcmV0ID0gdWpzb24uZHVtcHMocmV0KTsKICAgICAgICBnYy5jb2xsZWN0KCk7CiAgICAgICAgcmV0dXJuIHJldDsKCiAgICAKICAgIGRlZiBzdG9yZShzZWxmLCBfX2V2ZW50PU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnVG9vbF9UeXBlOjpzdG9yZSgpOiAnOwogICAgICAgIAogICAgICAgIGFuc3dlciA9IE5vbmU7CgogICAgICAgIF9fcmVzcG9uc2UgPSBFdmVudCgpLmNvZGUoJ1snK25vZGUuY29kZSgpKydAJytzdHIodGltZS50aWNrc19tcygpKSsnXS5Ub29sX1R5cGUuc3RvcmUoKScpLm1ldGhvZCgnc3RvcmUnKS5jbGFzc05hbWUoJ1Rvb2xfVHlwZScpLmNhcnJpZXIobm9kZSkuc2VuZGVyKG5vZGUpLnJlY2lwaWVudChub2RlLnBhcmVudCgpKTsKCiAgICAgICAgZXZKU09OID0gTm9uZTsKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBldkpTT04gPSB1anNvbi5sb2FkcyhfX2V2ZW50LnBheWxvYWQoKSk7CiAgICAgICAgICAgIGlmICdfX3RoaXMnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIHNlbGYuX2Zyb21Eb2N1bWVudChldkpTT05bJ19fdGhpcyddKTsKICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS5yZXNwb25zZVRvKF9fZXZlbnQuX3VuaXF1ZSgpKTsKICAgICAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiIGhhbmRsaW5nIGV2ZW50WyIrX19ldmVudC5jb2RlKCkrIl0iKTsKCiAgICAgICAgCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiYSByZXNwb25zZSB0byBteSBldmVudCgiK19fZXZlbnQucmVzcG9uc2VUbygpLmNvZGUoKSsiKSBbIiArIF9fZXZlbnQuY2xhc3NOYW1lKCkgKyAiKCkuIiArIF9fZXZlbnQubWV0aG9kKCkgKyAiKCldIik7CiAgICAgICAgCiAgICAgICAgICAgIGFuc3dlciA9IFRvb2xfVHlwZSgpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiBmaW5kQWxsKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdUb29sX1R5cGU6OmZpbmRBbGwoKTogJzsKICAgICAgICAKICAgICAgICBhbnN3ZXIgPSBOb25lOwoKICAgICAgICBfX3Jlc3BvbnNlID0gRXZlbnQoKS5jb2RlKCdbJytub2RlLmNvZGUoKSsnQCcrc3RyKHRpbWUudGlja3NfbXMoKSkrJ10uVG9vbF9UeXBlLmZpbmRBbGwoKScpLm1ldGhvZCgnZmluZEFsbCcpLmNsYXNzTmFtZSgnVG9vbF9UeXBlJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gVG9vbF9UeXBlKCkuX2Zyb21Eb2N1bWVudChldkpTT04pOwogICAgICAgIAoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4ZWN1dGluZyBsb2NhbGx5Iik7CgoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmUgb3IgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgaWYgYW5zd2VyIGlzIG5vdCBOb25lOgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZChhbnN3ZXIuX3RvRG9jdW1lbnQoKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKHsiX190aGlzIjogc2VsZi5fdG9Eb2N1bWVudCgpfSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS50cmlnZ2VyKCk7CiAgICAgICAgICAgIAoKICAgICAgICByZXR1cm4gYW5zd2VyOwoKICAgIAogICAgZGVmIGZpbmQoc2VsZiwgX19ldmVudD1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ1Rvb2xfVHlwZTo6ZmluZCgpOiAnOwogICAgICAgIAogICAgICAgIGFuc3dlciA9IE5vbmU7CgogICAgICAgIF9fcmVzcG9uc2UgPSBFdmVudCgpLmNvZGUoJ1snK25vZGUuY29kZSgpKydAJytzdHIodGltZS50aWNrc19tcygpKSsnXS5Ub29sX1R5cGUuZmluZCgpJykubWV0aG9kKCdmaW5kJykuY2xhc3NOYW1lKCdUb29sX1R5cGUnKS5jYXJyaWVyKG5vZGUpLnNlbmRlcihub2RlKS5yZWNpcGllbnQobm9kZS5wYXJlbnQoKSk7CgogICAgICAgIGV2SlNPTiA9IE5vbmU7CiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgZXZKU09OID0gdWpzb24ubG9hZHMoX19ldmVudC5wYXlsb2FkKCkpOwogICAgICAgICAgICBpZiAnX190aGlzJyBpbiBldkpTT046CiAgICAgICAgICAgICAgICBzZWxmLl9mcm9tRG9jdW1lbnQoZXZKU09OWydfX3RoaXMnXSk7CiAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UucmVzcG9uc2VUbyhfX2V2ZW50Ll91bmlxdWUoKSk7CiAgICAgICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgIiBoYW5kbGluZyBldmVudFsiK19fZXZlbnQuY29kZSgpKyJdIik7CgogICAgICAgIAogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImEgcmVzcG9uc2UgdG8gbXkgZXZlbnQoIitfX2V2ZW50LnJlc3BvbnNlVG8oKS5jb2RlKCkrIikgWyIgKyBfX2V2ZW50LmNsYXNzTmFtZSgpICsgIigpLiIgKyBfX2V2ZW50Lm1ldGhvZCgpICsgIigpXSIpOwogICAgICAgIAogICAgICAgICAgICBhbnN3ZXIgPSBUb29sX1R5cGUoKS5fZnJvbURvY3VtZW50KGV2SlNPTik7CiAgICAgICAgCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhlY3V0aW5nIGxvY2FsbHkiKTsKCgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZSBvciBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBpZiBhbnN3ZXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKGFuc3dlci5fdG9Eb2N1bWVudCgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoeyJfX3RoaXMiOiBzZWxmLl90b0RvY3VtZW50KCl9KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnRyaWdnZXIoKTsKICAgICAgICAgICAgCgogICAgICAgIHJldHVybiBhbnN3ZXI7CgogICAgCgoKY2xhc3MgRXZlbnQoKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBJZD1Ob25lLCBhY3RpdmU9Tm9uZSwgZW5hYmxlZD1Ob25lLCBjb2RlPU5vbmUsIG9yZGVyPU5vbmUsIGRhdGU9Tm9uZSwgbmFtZT1Ob25lLCByZW1hcms9Tm9uZSwgY2xhc3NOYW1lPU5vbmUsIG1ldGhvZD1Ob25lLCBwYXlsb2FkPU5vbmUsIGNhcnJpZXI9Tm9uZSwgc2VuZGVyPU5vbmUsIHJlY2lwaWVudD1Ob25lLCByZXNwb25zZVRvPU5vbmUpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKTsKCiAgICAgICAgI3ByaW50KCdFdmVudDo6X19pbml0X18oKScpOwogICAgICAgIGlmIElkIGlzIG5vdCBOb25lOgogICAgICAgICAgICBzZWxmLklkID0gSWQ7CgogICAgICAgIAogICAgICAgIHNlbGYuYWN0aXZlKGFjdGl2ZSk7CiAgICAgICAgc2VsZi5lbmFibGVkKGVuYWJsZWQpOwogICAgICAgIHNlbGYuY29kZShjb2RlKTsKICAgICAgICBzZWxmLm9yZGVyKG9yZGVyKTsKICAgICAgICBzZWxmLmRhdGUoZGF0ZSk7CiAgICAgICAgc2VsZi5uYW1lKG5hbWUpOwogICAgICAgIHNlbGYucmVtYXJrKHJlbWFyayk7CiAgICAgICAgc2VsZi5jbGFzc05hbWUoY2xhc3NOYW1lKTsKICAgICAgICBzZWxmLm1ldGhvZChtZXRob2QpOwogICAgICAgIHNlbGYucGF5bG9hZChwYXlsb2FkKTsKICAgICAgICBzZWxmLmNhcnJpZXIoY2Fycmllcik7CiAgICAgICAgc2VsZi5zZW5kZXIoc2VuZGVyKTsKICAgICAgICBzZWxmLnJlY2lwaWVudChyZWNpcGllbnQpOwogICAgICAgIHNlbGYucmVzcG9uc2VUbyhyZXNwb25zZVRvKTsKICAgICAgICAKICAgIElkID0gTm9uZTsKICAgIAogICAgCiAgICAjIGFjdGl2ZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2FjdGl2ZSA9IE5vbmU7CiAgICBkZWYgYWN0aXZlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9hY3RpdmUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9hY3RpdmU7CiAgICAKICAgICMgZW5hYmxlZDogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2VuYWJsZWQgPSBOb25lOwogICAgZGVmIGVuYWJsZWQoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2VuYWJsZWQgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9lbmFibGVkOwogICAgCiAgICAjIGNvZGU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9jb2RlID0gTm9uZTsKICAgIGRlZiBjb2RlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9jb2RlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fY29kZTsKICAgIAogICAgIyBvcmRlcjogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX29yZGVyID0gTm9uZTsKICAgIGRlZiBvcmRlcihzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fb3JkZXIgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9vcmRlcjsKICAgIAogICAgIyBkYXRlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfZGF0ZSA9IE5vbmU7CiAgICBkZWYgZGF0ZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fZGF0ZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgaWYgc2VsZi5fZGF0ZT09J3t7bm93fX0nOgogICAgICAgICAgICAgICAgc2VsZi5fZGF0ZSA9IHRpbWUudGlja3NfbXMoKTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZGF0ZTsKICAgIAogICAgIyBuYW1lOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfbmFtZSA9IE5vbmU7CiAgICBkZWYgbmFtZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fbmFtZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX25hbWU7CiAgICAKICAgICMgcmVtYXJrOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfcmVtYXJrID0gTm9uZTsKICAgIGRlZiByZW1hcmsoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX3JlbWFyayA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3JlbWFyazsKICAgIAogICAgIyBjbGFzc05hbWU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9jbGFzc05hbWUgPSBOb25lOwogICAgZGVmIGNsYXNzTmFtZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fY2xhc3NOYW1lID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fY2xhc3NOYW1lOwogICAgCiAgICAjIG1ldGhvZDogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX21ldGhvZCA9IE5vbmU7CiAgICBkZWYgbWV0aG9kKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9tZXRob2QgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9tZXRob2Q7CiAgICAKICAgICMgcGF5bG9hZDogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3BheWxvYWQgPSBOb25lOwogICAgZGVmIHBheWxvYWQoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX3BheWxvYWQgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9wYXlsb2FkOwogICAgCiAgICAjIGNhcnJpZXI6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9jYXJyaWVyID0gTm9uZTsKICAgIGRlZiBjYXJyaWVyKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9jYXJyaWVyID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fY2FycmllcjsKICAgIAogICAgIyBzZW5kZXI6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9zZW5kZXIgPSBOb25lOwogICAgZGVmIHNlbmRlcihzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fc2VuZGVyID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fc2VuZGVyOwogICAgCiAgICAjIHJlY2lwaWVudDogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3JlY2lwaWVudCA9IE5vbmU7CiAgICBkZWYgcmVjaXBpZW50KHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9yZWNpcGllbnQgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9yZWNpcGllbnQ7CiAgICAKICAgICMgcmVzcG9uc2VUbzogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3Jlc3BvbnNlVG8gPSBOb25lOwogICAgZGVmIHJlc3BvbnNlVG8oc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX3Jlc3BvbnNlVG8gPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9yZXNwb25zZVRvOwogICAgCiAgICAKICAgIAogICAgIyByZXNwb25zZVRvX0V2ZW50czogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3Jlc3BvbnNlVG9fRXZlbnRzID0gTm9uZTsKICAgIGRlZiByZXNwb25zZVRvX0V2ZW50cyhzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fcmVzcG9uc2VUb19FdmVudHMgPSBhcmdzWzBdOwogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fcmVzcG9uc2VUb19FdmVudHM7CiAgICAKICAgIAogICAgZGVmIF91bmlxdWUoc2VsZik6CiAgICAgICAgX190b1N0cmluZyA9ICdFdmVudDo6X3VuaXF1ZSgpOiAnOwogICAgICAgIAogICAgICAgIHJldCA9IEV2ZW50KCk7CiAgICAgICAgaWYgc2VsZi5JZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0LklkID0gc2VsZi5JZDsKICAgIAogICAgICAgIGlmIHNlbGYuY29kZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXQuY29kZShzZWxmLmNvZGUoKSk7CiAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CiAgICAgICAgcmV0dXJuIHJldDsKICAgIAogICAgZGVmIF9mcm9tRG9jdW1lbnQoc2VsZiwgb2JqKToKICAgICAgICBfX3RvU3RyaW5nID0gJ0V2ZW50OjpfZnJvbURvY3VtZW50KCk6ICc7CiAgICAgICAgCiAgICAgICAgaWYgb2JqIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBzZWxmOwoKICAgICAgICBpZiBpc2luc3RhbmNlKG9iaiwgYnl0ZXMpOgogICAgICAgICAgICBvYmogPSBzdHIob2JqLCAidXRmLTgiKTsKCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIHN0cikgb3IgdHlwZShvYmopIGlzIHN0cjoKICAgICAgICAgICAgaWYgcmUubWF0Y2gociIoKChbQS1aYS16XXszLDl9Oig/OlwvXC8pPykoPzpbLTs6Jj1cK1wkLFx3XStAKT9bQS1aYS16MC05Li1dK3woPzp3d3cufFstOzomPVwrXCQsXHddK0ApW0EtWmEtejAtOS4tXSspKCg/OlwvW1wrfiVcLy5cd1wtX10qKT9cPz8oPzpbLVwrPSY7JUAuXHdfXSopIz8oPzpbXHddKikpPykiLCBvYmopOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIG9iaiA9IHVqc29uLmxvYWRzKHVybGxpYjMuUG9vbE1hbmFnZXIoKS5yZXF1ZXN0KCdHRVQnLCBvYmopLmRhdGEuZGVjb2RlKCd1dGYtOCcpKTsKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBvYmogPSB7fTsKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG9iaiA9IHVqc29uLmxvYWRzKG9iaik7CiAgICAgICAgCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIGxpc3QpOgogICAgICAgICAgICByZXR1cm4gW0V2ZW50KCkuX2Zyb21Eb2N1bWVudChvKSBmb3IgbyBpbiBvYmpdOwogICAgICAgICAgICAKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShvYmosIChzdHIsIGJ5dGVzLCBkaWN0KSk6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAndW5oYW5kbGVkIHR5cGU6ICcgKyBzdHIodHlwZShvYmopKSk7CiAgICAgICAgICAgIHJldHVybiBvYmo7CgogICAgICAgIGlmICdJZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLklkID0gb2JqWydJZCddOwoKICAgIAogICAgICAgIGlmICdhY3RpdmUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5hY3RpdmUob2JqWydhY3RpdmUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZW5hYmxlZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmVuYWJsZWQob2JqWydlbmFibGVkJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2NvZGUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5jb2RlKG9ialsnY29kZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdvcmRlcicgaW4gb2JqOgogICAgICAgICAgICBzZWxmLm9yZGVyKG9ialsnb3JkZXInXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZGF0ZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmRhdGUob2JqWydkYXRlJ10pOwogICAgICAgIAogICAgICAgICAgICBzZWxmLmRhdGUoZGF0ZXRpbWUuZGF0ZXRpbWUuZnJvbWlzb2Zvcm1hdChzZWxmLmRhdGUoKSkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ25hbWUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5uYW1lKG9ialsnbmFtZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdyZW1hcmsnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5yZW1hcmsob2JqWydyZW1hcmsnXSk7CiAgICAgICAgCiAgICAgICAgICAgIHNlbGYucmVtYXJrKCB1YmluYXNjaWkuYTJiX2Jhc2U2NChzZWxmLnJlbWFyaygpKSApOwogICAgICAgICAgICBpZiBzZWxmLnJlbWFyaygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVtYXJrKHNlbGYucmVtYXJrKCkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCkpOwogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVtYXJrKCk7CiAgICAgICAgICAgICAgICAgICAgI3ByaW50KF9fdG9TdHJpbmcgKyAicmVtYXJrIGV4Y2VwdGlvbiIsIHNlbGYucmVtYXJrKCkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2NsYXNzTmFtZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmNsYXNzTmFtZShvYmpbJ2NsYXNzTmFtZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdtZXRob2QnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5tZXRob2Qob2JqWydtZXRob2QnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAncGF5bG9hZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLnBheWxvYWQob2JqWydwYXlsb2FkJ10pOwogICAgICAgIAogICAgICAgICAgICBzZWxmLnBheWxvYWQoIHViaW5hc2NpaS5hMmJfYmFzZTY0KHNlbGYucGF5bG9hZCgpKSApOwogICAgICAgICAgICBpZiBzZWxmLnBheWxvYWQoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLnBheWxvYWQoc2VsZi5wYXlsb2FkKCkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCkpOwogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHNlbGYucGF5bG9hZCgpOwogICAgICAgICAgICAgICAgICAgICNwcmludChfX3RvU3RyaW5nICsgInBheWxvYWQgZXhjZXB0aW9uIiwgc2VsZi5wYXlsb2FkKCkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2NhcnJpZXInIGluIG9iajoKICAgICAgICAgICAgc2VsZi5jYXJyaWVyKE5vZGUoKS5fZnJvbURvY3VtZW50KG9ialsnY2FycmllciddKSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnc2VuZGVyJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuc2VuZGVyKE5vZGUoKS5fZnJvbURvY3VtZW50KG9ialsnc2VuZGVyJ10pKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdyZWNpcGllbnQnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5yZWNpcGllbnQoTm9kZSgpLl9mcm9tRG9jdW1lbnQob2JqWydyZWNpcGllbnQnXSkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ3Jlc3BvbnNlVG8nIGluIG9iajoKICAgICAgICAgICAgc2VsZi5yZXNwb25zZVRvKEV2ZW50KCkuX2Zyb21Eb2N1bWVudChvYmpbJ3Jlc3BvbnNlVG8nXSkpOwogICAgICAgIAogICAgCgogICAgCiAgICAgICAgaWYgJ3Jlc3BvbnNlVG9fRXZlbnRzJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYucmVzcG9uc2VUb19FdmVudHMoRXZlbnQoKS5fZnJvbURvY3VtZW50KG9ialsncmVzcG9uc2VUb19FdmVudHMnXSkpOwogICAgCgogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gc2VsZjsKICAgIAogICAgZGVmIF90b0RvY3VtZW50KHNlbGYsIGJKU09OPU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnRXZlbnQ6Ol90b0RvY3VtZW50KCk6ICc7CgogICAgICAgIHJldCA9IHt9OwogICAgICAgIGlmIHNlbGYuSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiSWQiXSA9IHNlbGYuSWQ7CgogICAgCiAgICAgICAgaWYgc2VsZi5hY3RpdmUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJhY3RpdmUiXSA9IHNlbGYuYWN0aXZlKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmVuYWJsZWQoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJlbmFibGVkIl0gPSBzZWxmLmVuYWJsZWQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuY29kZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImNvZGUiXSA9IHNlbGYuY29kZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5vcmRlcigpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIm9yZGVyIl0gPSBzZWxmLm9yZGVyKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmRhdGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJkYXRlIl0gPSBzZWxmLmRhdGUoKTsKICAgICAgICAKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXRbImRhdGUiXSwgZGF0ZXRpbWUuZGF0ZXRpbWUpOgogICAgICAgICAgICAgICAgcmV0WyJkYXRlIl0gPSByZXRbImRhdGUiXS5pc29mb3JtYXQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYubmFtZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIm5hbWUiXSA9IHNlbGYubmFtZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5yZW1hcmsoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9IHNlbGYucmVtYXJrKCk7CiAgICAgICAgCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmV0WyJyZW1hcmsiXSwgZGljdCk6CiAgICAgICAgICAgICAgICByZXRbInJlbWFyayJdID0gdWpzb24uZHVtcHMocmV0WyJyZW1hcmsiXSkuZW5jb2RlKCd1dGYtOCcpOwoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9ICB1YmluYXNjaWkuYjJhX2Jhc2U2NChyZXRbInJlbWFyayJdKS5kZWNvZGUoJ3V0Zi04Jykuc3RyaXAoKTsKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGNlcHRpb24gd2l0aCByZW1hcms6ICIgKyByZXRbInJlbWFyayJdKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuY2xhc3NOYW1lKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiY2xhc3NOYW1lIl0gPSBzZWxmLmNsYXNzTmFtZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5tZXRob2QoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJtZXRob2QiXSA9IHNlbGYubWV0aG9kKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLnBheWxvYWQoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJwYXlsb2FkIl0gPSBzZWxmLnBheWxvYWQoKTsKICAgICAgICAKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXRbInBheWxvYWQiXSwgZGljdCk6CiAgICAgICAgICAgICAgICByZXRbInBheWxvYWQiXSA9IHVqc29uLmR1bXBzKHJldFsicGF5bG9hZCJdKS5lbmNvZGUoJ3V0Zi04Jyk7CgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXRbInBheWxvYWQiXSA9ICB1YmluYXNjaWkuYjJhX2Jhc2U2NChyZXRbInBheWxvYWQiXSkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCk7CiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhjZXB0aW9uIHdpdGggcGF5bG9hZDogIiArIHJldFsicGF5bG9hZCJdKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuY2FycmllcigpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImNhcnJpZXIiXSA9IHNlbGYuY2FycmllcigpLl90b0RvY3VtZW50KCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLnNlbmRlcigpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbInNlbmRlciJdID0gc2VsZi5zZW5kZXIoKS5fdG9Eb2N1bWVudCgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5yZWNpcGllbnQoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJyZWNpcGllbnQiXSA9IHNlbGYucmVjaXBpZW50KCkuX3RvRG9jdW1lbnQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYucmVzcG9uc2VUbygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbInJlc3BvbnNlVG8iXSA9IHNlbGYucmVzcG9uc2VUbygpLl90b0RvY3VtZW50KCk7CiAgICAgICAgCiAgICAKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYucmVzcG9uc2VUb19FdmVudHMoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJyZXNwb25zZVRvX0V2ZW50cyJdID0gW3RhLl90b0RvY3VtZW50KCkgZm9yIHRhIGluIHNlbGYucmVzcG9uc2VUb19FdmVudHMoKV07CiAgICAKCiAgICAgICAgaWYgYkpTT04gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICNwcmludChfX3RvU3RyaW5nICsgIkdPVCBIRVJFIiwgdHlwZShyZXQpLCByZXQpOwogICAgICAgICAgICByZXQgPSB1anNvbi5kdW1wcyhyZXQpOwogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gcmV0OwoKICAgIAogICAgZGVmIHN0b3JlKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdFdmVudDo6c3RvcmUoKTogJzsKICAgICAgICAKICAgICAgICBhbnN3ZXIgPSBOb25lOwoKICAgICAgICBfX3Jlc3BvbnNlID0gRXZlbnQoKS5jb2RlKCdbJytub2RlLmNvZGUoKSsnQCcrc3RyKHRpbWUudGlja3NfbXMoKSkrJ10uRXZlbnQuc3RvcmUoKScpLm1ldGhvZCgnc3RvcmUnKS5jbGFzc05hbWUoJ0V2ZW50JykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gRXZlbnQoKS5fZnJvbURvY3VtZW50KGV2SlNPTik7CiAgICAgICAgCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhlY3V0aW5nIGxvY2FsbHkiKTsKCgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZSBvciBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBpZiBhbnN3ZXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKGFuc3dlci5fdG9Eb2N1bWVudCgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoeyJfX3RoaXMiOiBzZWxmLl90b0RvY3VtZW50KCl9KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnRyaWdnZXIoKTsKICAgICAgICAgICAgCgogICAgICAgIHJldHVybiBhbnN3ZXI7CgogICAgCiAgICBkZWYgZmluZEFsbChzZWxmLCBfX2V2ZW50PU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnRXZlbnQ6OmZpbmRBbGwoKTogJzsKICAgICAgICAKICAgICAgICBhbnN3ZXIgPSBOb25lOwoKICAgICAgICBfX3Jlc3BvbnNlID0gRXZlbnQoKS5jb2RlKCdbJytub2RlLmNvZGUoKSsnQCcrc3RyKHRpbWUudGlja3NfbXMoKSkrJ10uRXZlbnQuZmluZEFsbCgpJykubWV0aG9kKCdmaW5kQWxsJykuY2xhc3NOYW1lKCdFdmVudCcpLmNhcnJpZXIobm9kZSkuc2VuZGVyKG5vZGUpLnJlY2lwaWVudChub2RlLnBhcmVudCgpKTsKCiAgICAgICAgZXZKU09OID0gTm9uZTsKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBldkpTT04gPSB1anNvbi5sb2FkcyhfX2V2ZW50LnBheWxvYWQoKSk7CiAgICAgICAgICAgIGlmICdfX3RoaXMnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIHNlbGYuX2Zyb21Eb2N1bWVudChldkpTT05bJ19fdGhpcyddKTsKICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS5yZXNwb25zZVRvKF9fZXZlbnQuX3VuaXF1ZSgpKTsKICAgICAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiIGhhbmRsaW5nIGV2ZW50WyIrX19ldmVudC5jb2RlKCkrIl0iKTsKCiAgICAgICAgCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiYSByZXNwb25zZSB0byBteSBldmVudCgiK19fZXZlbnQucmVzcG9uc2VUbygpLmNvZGUoKSsiKSBbIiArIF9fZXZlbnQuY2xhc3NOYW1lKCkgKyAiKCkuIiArIF9fZXZlbnQubWV0aG9kKCkgKyAiKCldIik7CiAgICAgICAgCiAgICAgICAgICAgIGFuc3dlciA9IEV2ZW50KCkuX2Zyb21Eb2N1bWVudChldkpTT04pOwogICAgICAgIAoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4ZWN1dGluZyBsb2NhbGx5Iik7CgoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmUgb3IgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgaWYgYW5zd2VyIGlzIG5vdCBOb25lOgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZChhbnN3ZXIuX3RvRG9jdW1lbnQoKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKHsiX190aGlzIjogc2VsZi5fdG9Eb2N1bWVudCgpfSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS50cmlnZ2VyKCk7CiAgICAgICAgICAgIAoKICAgICAgICByZXR1cm4gYW5zd2VyOwoKICAgIAogICAgZGVmIGZpbmQoc2VsZiwgX19ldmVudD1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ0V2ZW50OjpmaW5kKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLkV2ZW50LmZpbmQoKScpLm1ldGhvZCgnZmluZCcpLmNsYXNzTmFtZSgnRXZlbnQnKS5jYXJyaWVyKG5vZGUpLnNlbmRlcihub2RlKS5yZWNpcGllbnQobm9kZS5wYXJlbnQoKSk7CgogICAgICAgIGV2SlNPTiA9IE5vbmU7CiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgZXZKU09OID0gdWpzb24ubG9hZHMoX19ldmVudC5wYXlsb2FkKCkpOwogICAgICAgICAgICBpZiAnX190aGlzJyBpbiBldkpTT046CiAgICAgICAgICAgICAgICBzZWxmLl9mcm9tRG9jdW1lbnQoZXZKU09OWydfX3RoaXMnXSk7CiAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UucmVzcG9uc2VUbyhfX2V2ZW50Ll91bmlxdWUoKSk7CiAgICAgICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgIiBoYW5kbGluZyBldmVudFsiK19fZXZlbnQuY29kZSgpKyJdIik7CgogICAgICAgIAogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImEgcmVzcG9uc2UgdG8gbXkgZXZlbnQoIitfX2V2ZW50LnJlc3BvbnNlVG8oKS5jb2RlKCkrIikgWyIgKyBfX2V2ZW50LmNsYXNzTmFtZSgpICsgIigpLiIgKyBfX2V2ZW50Lm1ldGhvZCgpICsgIigpXSIpOwogICAgICAgIAogICAgICAgICAgICBhbnN3ZXIgPSBFdmVudCgpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiBsaXN0ZW4oc2VsZiwgX19ldmVudD1Ob25lLCBub2RlPU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnRXZlbnQ6Omxpc3RlbigpOiAnOwogICAgICAgIAogICAgICAgIGFuc3dlciA9IE5vbmU7CgogICAgICAgIF9fcmVzcG9uc2UgPSBFdmVudCgpLmNvZGUoJ1snK25vZGUuY29kZSgpKydAJytzdHIodGltZS50aWNrc19tcygpKSsnXS5FdmVudC5saXN0ZW4oKScpLm1ldGhvZCgnbGlzdGVuJykuY2xhc3NOYW1lKCdFdmVudCcpLmNhcnJpZXIobm9kZSkuc2VuZGVyKG5vZGUpLnJlY2lwaWVudChub2RlLnBhcmVudCgpKTsKCiAgICAgICAgZXZKU09OID0gTm9uZTsKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBldkpTT04gPSB1anNvbi5sb2FkcyhfX2V2ZW50LnBheWxvYWQoKSk7CiAgICAgICAgICAgIGlmICdfX3RoaXMnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIHNlbGYuX2Zyb21Eb2N1bWVudChldkpTT05bJ19fdGhpcyddKTsKICAgICAgICAKICAgICAgICAgICAgaWYgJ25vZGUnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIG5vZGUgPSBldkpTT05bJ25vZGUnXTsKICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS5yZXNwb25zZVRvKF9fZXZlbnQuX3VuaXF1ZSgpKTsKICAgICAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiIGhhbmRsaW5nIGV2ZW50WyIrX19ldmVudC5jb2RlKCkrIl0iKTsKCiAgICAgICAgCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiYSByZXNwb25zZSB0byBteSBldmVudCgiK19fZXZlbnQucmVzcG9uc2VUbygpLmNvZGUoKSsiKSBbIiArIF9fZXZlbnQuY2xhc3NOYW1lKCkgKyAiKCkuIiArIF9fZXZlbnQubWV0aG9kKCkgKyAiKCldIik7CiAgICAgICAgCiAgICAgICAgICAgIGFuc3dlciA9IGV2SlNPTjsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoc3RyKGFuc3dlcikpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiB0cmlnZ2VyKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdFdmVudDo6dHJpZ2dlcigpOiAnOwogICAgICAgIAogICAgICAgIGFuc3dlciA9IE5vbmU7CgogICAgICAgIF9fcmVzcG9uc2UgPSBFdmVudCgpLmNvZGUoJ1snK25vZGUuY29kZSgpKydAJytzdHIodGltZS50aWNrc19tcygpKSsnXS5FdmVudC50cmlnZ2VyKCknKS5tZXRob2QoJ3RyaWdnZXInKS5jbGFzc05hbWUoJ0V2ZW50JykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gZXZKU09OOwogICAgICAgIAoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4ZWN1dGluZyBsb2NhbGx5Iik7CgogICAgICAgICAgICByZXR1cm4gbXF0dF9jbGllbnQucHVibGlzaChtcXR0X3RvcGljLCBzZWxmLl90b0RvY3VtZW50KFRydWUpKTsKICAgICAgICAKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoc3RyKGFuc3dlcikpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCgogICAgICAgIHJldHVybiBhbnN3ZXI7CgogICAgCiAgICBkZWYgcHJvY2VzcyhzZWxmLCBfX2V2ZW50PU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnRXZlbnQ6OnByb2Nlc3MoKTogJzsKICAgICAgICAKICAgICAgICBhbnN3ZXIgPSBOb25lOwoKICAgICAgICBfX3Jlc3BvbnNlID0gRXZlbnQoKS5jb2RlKCdbJytub2RlLmNvZGUoKSsnQCcrc3RyKHRpbWUudGlja3NfbXMoKSkrJ10uRXZlbnQucHJvY2VzcygpJykubWV0aG9kKCdwcm9jZXNzJykuY2xhc3NOYW1lKCdFdmVudCcpLmNhcnJpZXIobm9kZSkuc2VuZGVyKG5vZGUpLnJlY2lwaWVudChub2RlLnBhcmVudCgpKTsKCiAgICAgICAgZXZKU09OID0gTm9uZTsKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBldkpTT04gPSB1anNvbi5sb2FkcyhfX2V2ZW50LnBheWxvYWQoKSk7CiAgICAgICAgICAgIGlmICdfX3RoaXMnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIHNlbGYuX2Zyb21Eb2N1bWVudChldkpTT05bJ19fdGhpcyddKTsKICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS5yZXNwb25zZVRvKF9fZXZlbnQuX3VuaXF1ZSgpKTsKICAgICAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiIGhhbmRsaW5nIGV2ZW50WyIrX19ldmVudC5jb2RlKCkrIl0iKTsKCiAgICAgICAgCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiYSByZXNwb25zZSB0byBteSBldmVudCgiK19fZXZlbnQucmVzcG9uc2VUbygpLmNvZGUoKSsiKSBbIiArIF9fZXZlbnQuY2xhc3NOYW1lKCkgKyAiKCkuIiArIF9fZXZlbnQubWV0aG9kKCkgKyAiKCldIik7CiAgICAgICAgCiAgICAgICAgICAgIGFuc3dlciA9IEV2ZW50KCkuX2Zyb21Eb2N1bWVudChldkpTT04pOwogICAgICAgIAoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4ZWN1dGluZyBsb2NhbGx5Iik7CgogICAgICAgICAgICBpZiBzZWxmLnNlbmRlcigpLmNvZGUoKT09bm9kZS5jb2RlKCk6CiAgICAgICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImlnbm9yaW5nIG15IGV2ZW50cyIpOwogICAgICAgICAgICAgICAgcmV0dXJuOwogICAgICAgICAgICBlbGlmIHNlbGYucmVjaXBpZW50KCkuY29kZSgpIT1ub2RlLmNvZGUoKToKICAgICAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAibm90IHNlbnQgdG8gbWUiKTsKICAgICAgICAgICAgICAgIHJldHVybjsKCiAgICAgICAgICAgIHJldHVybiBnZXRhdHRyKGdsb2JhbHMoKVtzZWxmLmNsYXNzTmFtZSgpXSgpLCBzZWxmLm1ldGhvZCgpKShzZWxmKTsKICAgICAgICAKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKCgpjbGFzcyBOb2RlKCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgSWQ9Tm9uZSwgYWN0aXZlPU5vbmUsIGVuYWJsZWQ9Tm9uZSwgY29kZT1Ob25lLCBvcmRlcj1Ob25lLCBkYXRlPU5vbmUsIG5hbWU9Tm9uZSwgcmVtYXJrPU5vbmUsIGFkZHJlc3M9Tm9uZSwgYmFja3VwPU5vbmUsIHBhcmVudD1Ob25lLCBncm91cD1Ob25lLCBjb250ZXh0PU5vbmUsIHBvcnQ9Tm9uZSwgb25saW5lPU5vbmUsIHNlY3VyZT1Ob25lLCB0eXBlPU5vbmUpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKTsKCiAgICAgICAgI3ByaW50KCdOb2RlOjpfX2luaXRfXygpJyk7CiAgICAgICAgaWYgSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHNlbGYuSWQgPSBJZDsKCiAgICAgICAgCiAgICAgICAgc2VsZi5hY3RpdmUoYWN0aXZlKTsKICAgICAgICBzZWxmLmVuYWJsZWQoZW5hYmxlZCk7CiAgICAgICAgc2VsZi5jb2RlKGNvZGUpOwogICAgICAgIHNlbGYub3JkZXIob3JkZXIpOwogICAgICAgIHNlbGYuZGF0ZShkYXRlKTsKICAgICAgICBzZWxmLm5hbWUobmFtZSk7CiAgICAgICAgc2VsZi5yZW1hcmsocmVtYXJrKTsKICAgICAgICBzZWxmLmFkZHJlc3MoYWRkcmVzcyk7CiAgICAgICAgc2VsZi5iYWNrdXAoYmFja3VwKTsKICAgICAgICBzZWxmLnBhcmVudChwYXJlbnQpOwogICAgICAgIHNlbGYuZ3JvdXAoZ3JvdXApOwogICAgICAgIHNlbGYuY29udGV4dChjb250ZXh0KTsKICAgICAgICBzZWxmLnBvcnQocG9ydCk7CiAgICAgICAgc2VsZi5vbmxpbmUob25saW5lKTsKICAgICAgICBzZWxmLnNlY3VyZShzZWN1cmUpOwogICAgICAgIHNlbGYudHlwZSh0eXBlKTsKICAgICAgICAKICAgIElkID0gTm9uZTsKICAgIAogICAgCiAgICAjIGFjdGl2ZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2FjdGl2ZSA9IE5vbmU7CiAgICBkZWYgYWN0aXZlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9hY3RpdmUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9hY3RpdmU7CiAgICAKICAgICMgZW5hYmxlZDogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2VuYWJsZWQgPSBOb25lOwogICAgZGVmIGVuYWJsZWQoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2VuYWJsZWQgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9lbmFibGVkOwogICAgCiAgICAjIGNvZGU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9jb2RlID0gTm9uZTsKICAgIGRlZiBjb2RlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9jb2RlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fY29kZTsKICAgIAogICAgIyBvcmRlcjogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX29yZGVyID0gTm9uZTsKICAgIGRlZiBvcmRlcihzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fb3JkZXIgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9vcmRlcjsKICAgIAogICAgIyBkYXRlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfZGF0ZSA9IE5vbmU7CiAgICBkZWYgZGF0ZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fZGF0ZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgaWYgc2VsZi5fZGF0ZT09J3t7bm93fX0nOgogICAgICAgICAgICAgICAgc2VsZi5fZGF0ZSA9IHRpbWUudGlja3NfbXMoKTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZGF0ZTsKICAgIAogICAgIyBuYW1lOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfbmFtZSA9IE5vbmU7CiAgICBkZWYgbmFtZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fbmFtZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX25hbWU7CiAgICAKICAgICMgcmVtYXJrOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfcmVtYXJrID0gTm9uZTsKICAgIGRlZiByZW1hcmsoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX3JlbWFyayA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3JlbWFyazsKICAgIAogICAgIyBhZGRyZXNzOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfYWRkcmVzcyA9IE5vbmU7CiAgICBkZWYgYWRkcmVzcyhzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fYWRkcmVzcyA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2FkZHJlc3M7CiAgICAKICAgICMgYmFja3VwOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfYmFja3VwID0gTm9uZTsKICAgIGRlZiBiYWNrdXAoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2JhY2t1cCA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2JhY2t1cDsKICAgIAogICAgIyBwYXJlbnQ6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9wYXJlbnQgPSBOb25lOwogICAgZGVmIHBhcmVudChzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fcGFyZW50ID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fcGFyZW50OwogICAgCiAgICAjIGdyb3VwOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfZ3JvdXAgPSBOb25lOwogICAgZGVmIGdyb3VwKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9ncm91cCA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2dyb3VwOwogICAgCiAgICAjIGNvbnRleHQ6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9jb250ZXh0ID0gTm9uZTsKICAgIGRlZiBjb250ZXh0KHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9jb250ZXh0ID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fY29udGV4dDsKICAgIAogICAgIyBwb3J0OiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfcG9ydCA9IE5vbmU7CiAgICBkZWYgcG9ydChzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fcG9ydCA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3BvcnQ7CiAgICAKICAgICMgb25saW5lOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfb25saW5lID0gTm9uZTsKICAgIGRlZiBvbmxpbmUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX29ubGluZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgaWYgc2VsZi5fb25saW5lPT0ne3tub3d9fSc6CiAgICAgICAgICAgICAgICBzZWxmLl9vbmxpbmUgPSB0aW1lLnRpY2tzX21zKCk7CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX29ubGluZTsKICAgIAogICAgIyBzZWN1cmU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9zZWN1cmUgPSBOb25lOwogICAgZGVmIHNlY3VyZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fc2VjdXJlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fc2VjdXJlOwogICAgCiAgICAjIHR5cGU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF90eXBlID0gTm9uZTsKICAgIGRlZiB0eXBlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl90eXBlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fdHlwZTsKICAgIAogICAgCiAgICAKICAgICMgY29udHJvbGxlcl9EZXZpY2VzOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfY29udHJvbGxlcl9EZXZpY2VzID0gTm9uZTsKICAgIGRlZiBjb250cm9sbGVyX0RldmljZXMoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2NvbnRyb2xsZXJfRGV2aWNlcyA9IGFyZ3NbMF07CiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jb250cm9sbGVyX0RldmljZXM7CiAgICAKICAgICMgbm9kZV9Db25maWdzOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfbm9kZV9Db25maWdzID0gTm9uZTsKICAgIGRlZiBub2RlX0NvbmZpZ3Moc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX25vZGVfQ29uZmlncyA9IGFyZ3NbMF07CiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9ub2RlX0NvbmZpZ3M7CiAgICAKICAgICMgY2Fycmllcl9FdmVudHM6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9jYXJyaWVyX0V2ZW50cyA9IE5vbmU7CiAgICBkZWYgY2Fycmllcl9FdmVudHMoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2NhcnJpZXJfRXZlbnRzID0gYXJnc1swXTsKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2NhcnJpZXJfRXZlbnRzOwogICAgCiAgICAjIHNlbmRlcl9FdmVudHM6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9zZW5kZXJfRXZlbnRzID0gTm9uZTsKICAgIGRlZiBzZW5kZXJfRXZlbnRzKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9zZW5kZXJfRXZlbnRzID0gYXJnc1swXTsKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3NlbmRlcl9FdmVudHM7CiAgICAKICAgICMgcmVjaXBpZW50X0V2ZW50czogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3JlY2lwaWVudF9FdmVudHMgPSBOb25lOwogICAgZGVmIHJlY2lwaWVudF9FdmVudHMoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX3JlY2lwaWVudF9FdmVudHMgPSBhcmdzWzBdOwogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fcmVjaXBpZW50X0V2ZW50czsKICAgIAogICAgIyBiYWNrdXBfTm9kZXM6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9iYWNrdXBfTm9kZXMgPSBOb25lOwogICAgZGVmIGJhY2t1cF9Ob2RlcyhzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fYmFja3VwX05vZGVzID0gYXJnc1swXTsKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2JhY2t1cF9Ob2RlczsKICAgIAogICAgIyBwYXJlbnRfTm9kZXM6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9wYXJlbnRfTm9kZXMgPSBOb25lOwogICAgZGVmIHBhcmVudF9Ob2RlcyhzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fcGFyZW50X05vZGVzID0gYXJnc1swXTsKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3BhcmVudF9Ob2RlczsKICAgIAogICAgCiAgICBkZWYgX3VuaXF1ZShzZWxmKToKICAgICAgICBfX3RvU3RyaW5nID0gJ05vZGU6Ol91bmlxdWUoKTogJzsKICAgICAgICAKICAgICAgICByZXQgPSBOb2RlKCk7CiAgICAgICAgaWYgc2VsZi5JZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0LklkID0gc2VsZi5JZDsKICAgIAogICAgICAgIGlmIHNlbGYuY29kZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXQuY29kZShzZWxmLmNvZGUoKSk7CiAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CiAgICAgICAgcmV0dXJuIHJldDsKICAgIAogICAgZGVmIF9mcm9tRG9jdW1lbnQoc2VsZiwgb2JqKToKICAgICAgICBfX3RvU3RyaW5nID0gJ05vZGU6Ol9mcm9tRG9jdW1lbnQoKTogJzsKICAgICAgICAKICAgICAgICBpZiBvYmogaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CgogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBieXRlcyk6CiAgICAgICAgICAgIG9iaiA9IHN0cihvYmosICJ1dGYtOCIpOwoKICAgICAgICBpZiBpc2luc3RhbmNlKG9iaiwgc3RyKSBvciB0eXBlKG9iaikgaXMgc3RyOgogICAgICAgICAgICBpZiByZS5tYXRjaChyIigoKFtBLVphLXpdezMsOX06KD86XC9cLyk/KSg/OlstOzomPVwrXCQsXHddK0ApP1tBLVphLXowLTkuLV0rfCg/Ond3dy58Wy07OiY9XCtcJCxcd10rQClbQS1aYS16MC05Li1dKykoKD86XC9bXCt+JVwvLlx3XC1fXSopP1w/Pyg/OlstXCs9JjslQC5cd19dKikjPyg/Oltcd10qKSk/KSIsIG9iaik6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgb2JqID0gdWpzb24ubG9hZHModXJsbGliMy5Qb29sTWFuYWdlcigpLnJlcXVlc3QoJ0dFVCcsIG9iaikuZGF0YS5kZWNvZGUoJ3V0Zi04JykpOwogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIG9iaiA9IHt9OwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgb2JqID0gdWpzb24ubG9hZHMob2JqKTsKICAgICAgICAKICAgICAgICBpZiBpc2luc3RhbmNlKG9iaiwgbGlzdCk6CiAgICAgICAgICAgIHJldHVybiBbTm9kZSgpLl9mcm9tRG9jdW1lbnQobykgZm9yIG8gaW4gb2JqXTsKICAgICAgICAgICAgCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2Uob2JqLCAoc3RyLCBieXRlcywgZGljdCkpOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgJ3VuaGFuZGxlZCB0eXBlOiAnICsgc3RyKHR5cGUob2JqKSkpOwogICAgICAgICAgICByZXR1cm4gb2JqOwoKICAgICAgICBpZiAnSWQnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5JZCA9IG9ialsnSWQnXTsKCiAgICAKICAgICAgICBpZiAnYWN0aXZlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuYWN0aXZlKG9ialsnYWN0aXZlJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2VuYWJsZWQnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5lbmFibGVkKG9ialsnZW5hYmxlZCddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdjb2RlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuY29kZShvYmpbJ2NvZGUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnb3JkZXInIGluIG9iajoKICAgICAgICAgICAgc2VsZi5vcmRlcihvYmpbJ29yZGVyJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2RhdGUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5kYXRlKG9ialsnZGF0ZSddKTsKICAgICAgICAKICAgICAgICAgICAgc2VsZi5kYXRlKGRhdGV0aW1lLmRhdGV0aW1lLmZyb21pc29mb3JtYXQoc2VsZi5kYXRlKCkpKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICduYW1lJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYubmFtZShvYmpbJ25hbWUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAncmVtYXJrJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYucmVtYXJrKG9ialsncmVtYXJrJ10pOwogICAgICAgIAogICAgICAgICAgICBzZWxmLnJlbWFyayggdWJpbmFzY2lpLmEyYl9iYXNlNjQoc2VsZi5yZW1hcmsoKSkgKTsKICAgICAgICAgICAgaWYgc2VsZi5yZW1hcmsoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbWFyayhzZWxmLnJlbWFyaygpLmRlY29kZSgndXRmLTgnKS5zdHJpcCgpKTsKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbWFyaygpOwogICAgICAgICAgICAgICAgICAgICNwcmludChfX3RvU3RyaW5nICsgInJlbWFyayBleGNlcHRpb24iLCBzZWxmLnJlbWFyaygpKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdhZGRyZXNzJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuYWRkcmVzcyhvYmpbJ2FkZHJlc3MnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnYmFja3VwJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuYmFja3VwKE5vZGUoKS5fZnJvbURvY3VtZW50KG9ialsnYmFja3VwJ10pKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdwYXJlbnQnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5wYXJlbnQoTm9kZSgpLl9mcm9tRG9jdW1lbnQob2JqWydwYXJlbnQnXSkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2dyb3VwJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuZ3JvdXAoTm9kZV9Hcm91cCgpLl9mcm9tRG9jdW1lbnQob2JqWydncm91cCddKSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnY29udGV4dCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmNvbnRleHQoTm9kZV9Db250ZXh0KCkuX2Zyb21Eb2N1bWVudChvYmpbJ2NvbnRleHQnXSkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ3BvcnQnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5wb3J0KG9ialsncG9ydCddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdvbmxpbmUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5vbmxpbmUob2JqWydvbmxpbmUnXSk7CiAgICAgICAgCiAgICAgICAgICAgIHNlbGYub25saW5lKGRhdGV0aW1lLmRhdGV0aW1lLmZyb21pc29mb3JtYXQoc2VsZi5vbmxpbmUoKSkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ3NlY3VyZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLnNlY3VyZShvYmpbJ3NlY3VyZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICd0eXBlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYudHlwZShOb2RlX1R5cGUoKS5fZnJvbURvY3VtZW50KG9ialsndHlwZSddKSk7CiAgICAgICAgCiAgICAKCiAgICAKICAgICAgICBpZiAnY29udHJvbGxlcl9EZXZpY2VzJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuY29udHJvbGxlcl9EZXZpY2VzKERldmljZSgpLl9mcm9tRG9jdW1lbnQob2JqWydjb250cm9sbGVyX0RldmljZXMnXSkpOwogICAgCiAgICAgICAgaWYgJ25vZGVfQ29uZmlncycgaW4gb2JqOgogICAgICAgICAgICBzZWxmLm5vZGVfQ29uZmlncyhDb25maWcoKS5fZnJvbURvY3VtZW50KG9ialsnbm9kZV9Db25maWdzJ10pKTsKICAgIAogICAgICAgIGlmICdjYXJyaWVyX0V2ZW50cycgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmNhcnJpZXJfRXZlbnRzKEV2ZW50KCkuX2Zyb21Eb2N1bWVudChvYmpbJ2NhcnJpZXJfRXZlbnRzJ10pKTsKICAgIAogICAgICAgIGlmICdzZW5kZXJfRXZlbnRzJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuc2VuZGVyX0V2ZW50cyhFdmVudCgpLl9mcm9tRG9jdW1lbnQob2JqWydzZW5kZXJfRXZlbnRzJ10pKTsKICAgIAogICAgICAgIGlmICdyZWNpcGllbnRfRXZlbnRzJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYucmVjaXBpZW50X0V2ZW50cyhFdmVudCgpLl9mcm9tRG9jdW1lbnQob2JqWydyZWNpcGllbnRfRXZlbnRzJ10pKTsKICAgIAogICAgICAgIGlmICdiYWNrdXBfTm9kZXMnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5iYWNrdXBfTm9kZXMoTm9kZSgpLl9mcm9tRG9jdW1lbnQob2JqWydiYWNrdXBfTm9kZXMnXSkpOwogICAgCiAgICAgICAgaWYgJ3BhcmVudF9Ob2RlcycgaW4gb2JqOgogICAgICAgICAgICBzZWxmLnBhcmVudF9Ob2RlcyhOb2RlKCkuX2Zyb21Eb2N1bWVudChvYmpbJ3BhcmVudF9Ob2RlcyddKSk7CiAgICAKCiAgICAgICAgZ2MuY29sbGVjdCgpOwogICAgICAgIHJldHVybiBzZWxmOwogICAgCiAgICBkZWYgX3RvRG9jdW1lbnQoc2VsZiwgYkpTT049Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdOb2RlOjpfdG9Eb2N1bWVudCgpOiAnOwoKICAgICAgICByZXQgPSB7fTsKICAgICAgICBpZiBzZWxmLklkIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIklkIl0gPSBzZWxmLklkOwoKICAgIAogICAgICAgIGlmIHNlbGYuYWN0aXZlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiYWN0aXZlIl0gPSBzZWxmLmFjdGl2ZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5lbmFibGVkKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZW5hYmxlZCJdID0gc2VsZi5lbmFibGVkKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmNvZGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJjb2RlIl0gPSBzZWxmLmNvZGUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYub3JkZXIoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJvcmRlciJdID0gc2VsZi5vcmRlcigpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5kYXRlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZGF0ZSJdID0gc2VsZi5kYXRlKCk7CiAgICAgICAgCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmV0WyJkYXRlIl0sIGRhdGV0aW1lLmRhdGV0aW1lKToKICAgICAgICAgICAgICAgIHJldFsiZGF0ZSJdID0gcmV0WyJkYXRlIl0uaXNvZm9ybWF0KCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLm5hbWUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJuYW1lIl0gPSBzZWxmLm5hbWUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYucmVtYXJrKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsicmVtYXJrIl0gPSBzZWxmLnJlbWFyaygpOwogICAgICAgIAogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHJldFsicmVtYXJrIl0sIGRpY3QpOgogICAgICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9IHVqc29uLmR1bXBzKHJldFsicmVtYXJrIl0pLmVuY29kZSgndXRmLTgnKTsKCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJldFsicmVtYXJrIl0gPSAgdWJpbmFzY2lpLmIyYV9iYXNlNjQocmV0WyJyZW1hcmsiXSkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCk7CiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhjZXB0aW9uIHdpdGggcmVtYXJrOiAiICsgcmV0WyJyZW1hcmsiXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmFkZHJlc3MoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJhZGRyZXNzIl0gPSBzZWxmLmFkZHJlc3MoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuYmFja3VwKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiYmFja3VwIl0gPSBzZWxmLmJhY2t1cCgpLl90b0RvY3VtZW50KCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLnBhcmVudCgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbInBhcmVudCJdID0gc2VsZi5wYXJlbnQoKS5fdG9Eb2N1bWVudCgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5ncm91cCgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImdyb3VwIl0gPSBzZWxmLmdyb3VwKCkuX3RvRG9jdW1lbnQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuY29udGV4dCgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImNvbnRleHQiXSA9IHNlbGYuY29udGV4dCgpLl90b0RvY3VtZW50KCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLnBvcnQoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJwb3J0Il0gPSBzZWxmLnBvcnQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYub25saW5lKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsib25saW5lIl0gPSBzZWxmLm9ubGluZSgpOwogICAgICAgIAogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHJldFsib25saW5lIl0sIGRhdGV0aW1lLmRhdGV0aW1lKToKICAgICAgICAgICAgICAgIHJldFsib25saW5lIl0gPSByZXRbIm9ubGluZSJdLmlzb2Zvcm1hdCgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5zZWN1cmUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJzZWN1cmUiXSA9IHNlbGYuc2VjdXJlKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLnR5cGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJ0eXBlIl0gPSBzZWxmLnR5cGUoKS5fdG9Eb2N1bWVudCgpOwogICAgICAgIAogICAgCiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmNvbnRyb2xsZXJfRGV2aWNlcygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImNvbnRyb2xsZXJfRGV2aWNlcyJdID0gW3RhLl90b0RvY3VtZW50KCkgZm9yIHRhIGluIHNlbGYuY29udHJvbGxlcl9EZXZpY2VzKCldOwogICAgCiAgICAgICAgaWYgc2VsZi5ub2RlX0NvbmZpZ3MoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJub2RlX0NvbmZpZ3MiXSA9IFt0YS5fdG9Eb2N1bWVudCgpIGZvciB0YSBpbiBzZWxmLm5vZGVfQ29uZmlncygpXTsKICAgIAogICAgICAgIGlmIHNlbGYuY2Fycmllcl9FdmVudHMoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJjYXJyaWVyX0V2ZW50cyJdID0gW3RhLl90b0RvY3VtZW50KCkgZm9yIHRhIGluIHNlbGYuY2Fycmllcl9FdmVudHMoKV07CiAgICAKICAgICAgICBpZiBzZWxmLnNlbmRlcl9FdmVudHMoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJzZW5kZXJfRXZlbnRzIl0gPSBbdGEuX3RvRG9jdW1lbnQoKSBmb3IgdGEgaW4gc2VsZi5zZW5kZXJfRXZlbnRzKCldOwogICAgCiAgICAgICAgaWYgc2VsZi5yZWNpcGllbnRfRXZlbnRzKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsicmVjaXBpZW50X0V2ZW50cyJdID0gW3RhLl90b0RvY3VtZW50KCkgZm9yIHRhIGluIHNlbGYucmVjaXBpZW50X0V2ZW50cygpXTsKICAgIAogICAgICAgIGlmIHNlbGYuYmFja3VwX05vZGVzKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiYmFja3VwX05vZGVzIl0gPSBbdGEuX3RvRG9jdW1lbnQoKSBmb3IgdGEgaW4gc2VsZi5iYWNrdXBfTm9kZXMoKV07CiAgICAKICAgICAgICBpZiBzZWxmLnBhcmVudF9Ob2RlcygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbInBhcmVudF9Ob2RlcyJdID0gW3RhLl90b0RvY3VtZW50KCkgZm9yIHRhIGluIHNlbGYucGFyZW50X05vZGVzKCldOwogICAgCgogICAgICAgIGlmIGJKU09OIGlzIG5vdCBOb25lOgogICAgICAgICAgICAjcHJpbnQoX190b1N0cmluZyArICJHT1QgSEVSRSIsIHR5cGUocmV0KSwgcmV0KTsKICAgICAgICAgICAgcmV0ID0gdWpzb24uZHVtcHMocmV0KTsKICAgICAgICBnYy5jb2xsZWN0KCk7CiAgICAgICAgcmV0dXJuIHJldDsKCiAgICAKICAgIGRlZiBzdG9yZShzZWxmLCBfX2V2ZW50PU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnTm9kZTo6c3RvcmUoKTogJzsKICAgICAgICAKICAgICAgICBhbnN3ZXIgPSBOb25lOwoKICAgICAgICBfX3Jlc3BvbnNlID0gRXZlbnQoKS5jb2RlKCdbJytub2RlLmNvZGUoKSsnQCcrc3RyKHRpbWUudGlja3NfbXMoKSkrJ10uTm9kZS5zdG9yZSgpJykubWV0aG9kKCdzdG9yZScpLmNsYXNzTmFtZSgnTm9kZScpLmNhcnJpZXIobm9kZSkuc2VuZGVyKG5vZGUpLnJlY2lwaWVudChub2RlLnBhcmVudCgpKTsKCiAgICAgICAgZXZKU09OID0gTm9uZTsKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBldkpTT04gPSB1anNvbi5sb2FkcyhfX2V2ZW50LnBheWxvYWQoKSk7CiAgICAgICAgICAgIGlmICdfX3RoaXMnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIHNlbGYuX2Zyb21Eb2N1bWVudChldkpTT05bJ19fdGhpcyddKTsKICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS5yZXNwb25zZVRvKF9fZXZlbnQuX3VuaXF1ZSgpKTsKICAgICAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CgoKICAgICAgICBpZiBzZWxmLm9ubGluZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICAjIGRpc2FibGUgb25saW5lIHVwZGF0ZQogICAgICAgICAgICByZXR1cm4gYW5zd2VyOwogICAgICAgICAgICAKICAgICAgICAgICAgdGltZS5zbGVlcCgzMCk7CiAgICAgICAgICAgIHNlbGYuX3VuaXF1ZSgpLm9ubGluZSgne3tub3d9fScpLnN0b3JlKCk7CgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gTm9kZSgpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiBmaW5kQWxsKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdOb2RlOjpmaW5kQWxsKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLk5vZGUuZmluZEFsbCgpJykubWV0aG9kKCdmaW5kQWxsJykuY2xhc3NOYW1lKCdOb2RlJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gTm9kZSgpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiBmaW5kKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdOb2RlOjpmaW5kKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLk5vZGUuZmluZCgpJykubWV0aG9kKCdmaW5kJykuY2xhc3NOYW1lKCdOb2RlJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gTm9kZSgpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiBhdXRoQ29kZShzZWxmLCBfX2V2ZW50PU5vbmUsIGNvZGU9Tm9uZSwgdG9vbD1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ05vZGU6OmF1dGhDb2RlKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLk5vZGUuYXV0aENvZGUoKScpLm1ldGhvZCgnYXV0aENvZGUnKS5jbGFzc05hbWUoJ05vZGUnKS5jYXJyaWVyKG5vZGUpLnNlbmRlcihub2RlKS5yZWNpcGllbnQobm9kZS5wYXJlbnQoKSk7CgogICAgICAgIGV2SlNPTiA9IE5vbmU7CiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgZXZKU09OID0gdWpzb24ubG9hZHMoX19ldmVudC5wYXlsb2FkKCkpOwogICAgICAgICAgICBpZiAnX190aGlzJyBpbiBldkpTT046CiAgICAgICAgICAgICAgICBzZWxmLl9mcm9tRG9jdW1lbnQoZXZKU09OWydfX3RoaXMnXSk7CiAgICAgICAgCiAgICAgICAgICAgIGlmICdjb2RlJyBpbiBldkpTT046CiAgICAgICAgICAgICAgICBjb2RlID0gZXZKU09OWydjb2RlJ107CiAgICAgICAgCiAgICAgICAgICAgIGlmICd0b29sJyBpbiBldkpTT046CiAgICAgICAgICAgICAgICB0b29sID0gZXZKU09OWyd0b29sJ107CiAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UucmVzcG9uc2VUbyhfX2V2ZW50Ll91bmlxdWUoKSk7CiAgICAgICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgIiBoYW5kbGluZyBldmVudFsiK19fZXZlbnQuY29kZSgpKyJdIik7CgogICAgICAgIAogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImEgcmVzcG9uc2UgdG8gbXkgZXZlbnQoIitfX2V2ZW50LnJlc3BvbnNlVG8oKS5jb2RlKCkrIikgWyIgKyBfX2V2ZW50LmNsYXNzTmFtZSgpICsgIigpLiIgKyBfX2V2ZW50Lm1ldGhvZCgpICsgIigpXSIpOwogICAgICAgIAogICAgICAgICAgICBhbnN3ZXIgPSBldkpTT047CiAgICAgICAgCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhlY3V0aW5nIGxvY2FsbHkiKTsKCgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZSBvciBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBpZiBhbnN3ZXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKHN0cihhbnN3ZXIpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoeyJfX3RoaXMiOiBzZWxmLl90b0RvY3VtZW50KCl9KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnRyaWdnZXIoKTsKICAgICAgICAgICAgCgogICAgICAgIHJldHVybiBhbnN3ZXI7CgogICAgCiAgICBkZWYgaW5pdChzZWxmLCBfX2V2ZW50PU5vbmUsIG9ubGluZT1Ob25lLCBjb2RlPU5vbmUsIHVpZD1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ05vZGU6OmluaXQoKTogJzsKICAgICAgICAKICAgICAgICBhbnN3ZXIgPSBOb25lOwoKICAgICAgICBfX3Jlc3BvbnNlID0gRXZlbnQoKS5jb2RlKCdbJytub2RlLmNvZGUoKSsnQCcrc3RyKHRpbWUudGlja3NfbXMoKSkrJ10uTm9kZS5pbml0KCknKS5tZXRob2QoJ2luaXQnKS5jbGFzc05hbWUoJ05vZGUnKS5jYXJyaWVyKG5vZGUpLnNlbmRlcihub2RlKS5yZWNpcGllbnQobm9kZS5wYXJlbnQoKSk7CgogICAgICAgIGV2SlNPTiA9IE5vbmU7CiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgZXZKU09OID0gdWpzb24ubG9hZHMoX19ldmVudC5wYXlsb2FkKCkpOwogICAgICAgICAgICBpZiAnX190aGlzJyBpbiBldkpTT046CiAgICAgICAgICAgICAgICBzZWxmLl9mcm9tRG9jdW1lbnQoZXZKU09OWydfX3RoaXMnXSk7CiAgICAgICAgCiAgICAgICAgICAgIGlmICdvbmxpbmUnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIG9ubGluZSA9IGV2SlNPTlsnb25saW5lJ107CiAgICAgICAgCiAgICAgICAgICAgIGlmICdjb2RlJyBpbiBldkpTT046CiAgICAgICAgICAgICAgICBjb2RlID0gZXZKU09OWydjb2RlJ107CiAgICAgICAgCiAgICAgICAgICAgIGlmICd1aWQnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIHVpZCA9IGV2SlNPTlsndWlkJ107CiAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UucmVzcG9uc2VUbyhfX2V2ZW50Ll91bmlxdWUoKSk7CiAgICAgICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgIiBoYW5kbGluZyBldmVudFsiK19fZXZlbnQuY29kZSgpKyJdIik7CgogICAgICAgIAogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImEgcmVzcG9uc2UgdG8gbXkgZXZlbnQoIitfX2V2ZW50LnJlc3BvbnNlVG8oKS5jb2RlKCkrIikgWyIgKyBfX2V2ZW50LmNsYXNzTmFtZSgpICsgIigpLiIgKyBfX2V2ZW50Lm1ldGhvZCgpICsgIigpXSIpOwogICAgICAgIAogICAgICAgICAgICBhbnN3ZXIgPSBOb2RlKCkuX2Zyb21Eb2N1bWVudChldkpTT04pOwogICAgICAgIAoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4ZWN1dGluZyBsb2NhbGx5Iik7CgoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmUgb3IgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgaWYgYW5zd2VyIGlzIG5vdCBOb25lOgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZChhbnN3ZXIuX3RvRG9jdW1lbnQoKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKHsiX190aGlzIjogc2VsZi5fdG9Eb2N1bWVudCgpfSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS50cmlnZ2VyKCk7CiAgICAgICAgICAgIAoKICAgICAgICByZXR1cm4gYW5zd2VyOwoKICAgIAoKCmNsYXNzIE5vZGVfQ29udGV4dCgpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIElkPU5vbmUsIGFjdGl2ZT1Ob25lLCBlbmFibGVkPU5vbmUsIGNvZGU9Tm9uZSwgb3JkZXI9Tm9uZSwgZGF0ZT1Ob25lLCBuYW1lPU5vbmUsIHJlbWFyaz1Ob25lKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCk7CgogICAgICAgICNwcmludCgnTm9kZV9Db250ZXh0OjpfX2luaXRfXygpJyk7CiAgICAgICAgaWYgSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHNlbGYuSWQgPSBJZDsKCiAgICAgICAgCiAgICAgICAgc2VsZi5hY3RpdmUoYWN0aXZlKTsKICAgICAgICBzZWxmLmVuYWJsZWQoZW5hYmxlZCk7CiAgICAgICAgc2VsZi5jb2RlKGNvZGUpOwogICAgICAgIHNlbGYub3JkZXIob3JkZXIpOwogICAgICAgIHNlbGYuZGF0ZShkYXRlKTsKICAgICAgICBzZWxmLm5hbWUobmFtZSk7CiAgICAgICAgc2VsZi5yZW1hcmsocmVtYXJrKTsKICAgICAgICAKICAgIElkID0gTm9uZTsKICAgIAogICAgCiAgICAjIGFjdGl2ZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2FjdGl2ZSA9IE5vbmU7CiAgICBkZWYgYWN0aXZlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9hY3RpdmUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9hY3RpdmU7CiAgICAKICAgICMgZW5hYmxlZDogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2VuYWJsZWQgPSBOb25lOwogICAgZGVmIGVuYWJsZWQoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2VuYWJsZWQgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9lbmFibGVkOwogICAgCiAgICAjIGNvZGU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9jb2RlID0gTm9uZTsKICAgIGRlZiBjb2RlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9jb2RlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fY29kZTsKICAgIAogICAgIyBvcmRlcjogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX29yZGVyID0gTm9uZTsKICAgIGRlZiBvcmRlcihzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fb3JkZXIgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9vcmRlcjsKICAgIAogICAgIyBkYXRlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfZGF0ZSA9IE5vbmU7CiAgICBkZWYgZGF0ZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fZGF0ZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgaWYgc2VsZi5fZGF0ZT09J3t7bm93fX0nOgogICAgICAgICAgICAgICAgc2VsZi5fZGF0ZSA9IHRpbWUudGlja3NfbXMoKTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZGF0ZTsKICAgIAogICAgIyBuYW1lOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfbmFtZSA9IE5vbmU7CiAgICBkZWYgbmFtZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fbmFtZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX25hbWU7CiAgICAKICAgICMgcmVtYXJrOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfcmVtYXJrID0gTm9uZTsKICAgIGRlZiByZW1hcmsoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX3JlbWFyayA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3JlbWFyazsKICAgIAogICAgCiAgICAKICAgICMgY29udGV4dF9Ob2RlczogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2NvbnRleHRfTm9kZXMgPSBOb25lOwogICAgZGVmIGNvbnRleHRfTm9kZXMoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2NvbnRleHRfTm9kZXMgPSBhcmdzWzBdOwogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fY29udGV4dF9Ob2RlczsKICAgIAogICAgCiAgICBkZWYgX3VuaXF1ZShzZWxmKToKICAgICAgICBfX3RvU3RyaW5nID0gJ05vZGVfQ29udGV4dDo6X3VuaXF1ZSgpOiAnOwogICAgICAgIAogICAgICAgIHJldCA9IE5vZGVfQ29udGV4dCgpOwogICAgICAgIGlmIHNlbGYuSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldC5JZCA9IHNlbGYuSWQ7CiAgICAKICAgICAgICBpZiBzZWxmLmNvZGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0LmNvZGUoc2VsZi5jb2RlKCkpOwogICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwogICAgICAgIHJldHVybiByZXQ7CiAgICAKICAgIGRlZiBfZnJvbURvY3VtZW50KHNlbGYsIG9iaik6CiAgICAgICAgX190b1N0cmluZyA9ICdOb2RlX0NvbnRleHQ6Ol9mcm9tRG9jdW1lbnQoKTogJzsKICAgICAgICAKICAgICAgICBpZiBvYmogaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CgogICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBieXRlcyk6CiAgICAgICAgICAgIG9iaiA9IHN0cihvYmosICJ1dGYtOCIpOwoKICAgICAgICBpZiBpc2luc3RhbmNlKG9iaiwgc3RyKSBvciB0eXBlKG9iaikgaXMgc3RyOgogICAgICAgICAgICBpZiByZS5tYXRjaChyIigoKFtBLVphLXpdezMsOX06KD86XC9cLyk/KSg/OlstOzomPVwrXCQsXHddK0ApP1tBLVphLXowLTkuLV0rfCg/Ond3dy58Wy07OiY9XCtcJCxcd10rQClbQS1aYS16MC05Li1dKykoKD86XC9bXCt+JVwvLlx3XC1fXSopP1w/Pyg/OlstXCs9JjslQC5cd19dKikjPyg/Oltcd10qKSk/KSIsIG9iaik6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgb2JqID0gdWpzb24ubG9hZHModXJsbGliMy5Qb29sTWFuYWdlcigpLnJlcXVlc3QoJ0dFVCcsIG9iaikuZGF0YS5kZWNvZGUoJ3V0Zi04JykpOwogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIG9iaiA9IHt9OwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgb2JqID0gdWpzb24ubG9hZHMob2JqKTsKICAgICAgICAKICAgICAgICBpZiBpc2luc3RhbmNlKG9iaiwgbGlzdCk6CiAgICAgICAgICAgIHJldHVybiBbTm9kZV9Db250ZXh0KCkuX2Zyb21Eb2N1bWVudChvKSBmb3IgbyBpbiBvYmpdOwogICAgICAgICAgICAKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShvYmosIChzdHIsIGJ5dGVzLCBkaWN0KSk6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAndW5oYW5kbGVkIHR5cGU6ICcgKyBzdHIodHlwZShvYmopKSk7CiAgICAgICAgICAgIHJldHVybiBvYmo7CgogICAgICAgIGlmICdJZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLklkID0gb2JqWydJZCddOwoKICAgIAogICAgICAgIGlmICdhY3RpdmUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5hY3RpdmUob2JqWydhY3RpdmUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZW5hYmxlZCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmVuYWJsZWQob2JqWydlbmFibGVkJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2NvZGUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5jb2RlKG9ialsnY29kZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdvcmRlcicgaW4gb2JqOgogICAgICAgICAgICBzZWxmLm9yZGVyKG9ialsnb3JkZXInXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnZGF0ZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmRhdGUob2JqWydkYXRlJ10pOwogICAgICAgIAogICAgICAgICAgICBzZWxmLmRhdGUoZGF0ZXRpbWUuZGF0ZXRpbWUuZnJvbWlzb2Zvcm1hdChzZWxmLmRhdGUoKSkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ25hbWUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5uYW1lKG9ialsnbmFtZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdyZW1hcmsnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5yZW1hcmsob2JqWydyZW1hcmsnXSk7CiAgICAgICAgCiAgICAgICAgICAgIHNlbGYucmVtYXJrKCB1YmluYXNjaWkuYTJiX2Jhc2U2NChzZWxmLnJlbWFyaygpKSApOwogICAgICAgICAgICBpZiBzZWxmLnJlbWFyaygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVtYXJrKHNlbGYucmVtYXJrKCkuZGVjb2RlKCd1dGYtOCcpLnN0cmlwKCkpOwogICAgICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVtYXJrKCk7CiAgICAgICAgICAgICAgICAgICAgI3ByaW50KF9fdG9TdHJpbmcgKyAicmVtYXJrIGV4Y2VwdGlvbiIsIHNlbGYucmVtYXJrKCkpOwogICAgICAgIAogICAgCgogICAgCiAgICAgICAgaWYgJ2NvbnRleHRfTm9kZXMnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5jb250ZXh0X05vZGVzKE5vZGUoKS5fZnJvbURvY3VtZW50KG9ialsnY29udGV4dF9Ob2RlcyddKSk7CiAgICAKCiAgICAgICAgZ2MuY29sbGVjdCgpOwogICAgICAgIHJldHVybiBzZWxmOwogICAgCiAgICBkZWYgX3RvRG9jdW1lbnQoc2VsZiwgYkpTT049Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdOb2RlX0NvbnRleHQ6Ol90b0RvY3VtZW50KCk6ICc7CgogICAgICAgIHJldCA9IHt9OwogICAgICAgIGlmIHNlbGYuSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiSWQiXSA9IHNlbGYuSWQ7CgogICAgCiAgICAgICAgaWYgc2VsZi5hY3RpdmUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJhY3RpdmUiXSA9IHNlbGYuYWN0aXZlKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmVuYWJsZWQoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJlbmFibGVkIl0gPSBzZWxmLmVuYWJsZWQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuY29kZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImNvZGUiXSA9IHNlbGYuY29kZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5vcmRlcigpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIm9yZGVyIl0gPSBzZWxmLm9yZGVyKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmRhdGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJkYXRlIl0gPSBzZWxmLmRhdGUoKTsKICAgICAgICAKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXRbImRhdGUiXSwgZGF0ZXRpbWUuZGF0ZXRpbWUpOgogICAgICAgICAgICAgICAgcmV0WyJkYXRlIl0gPSByZXRbImRhdGUiXS5pc29mb3JtYXQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYubmFtZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIm5hbWUiXSA9IHNlbGYubmFtZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5yZW1hcmsoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9IHNlbGYucmVtYXJrKCk7CiAgICAgICAgCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmV0WyJyZW1hcmsiXSwgZGljdCk6CiAgICAgICAgICAgICAgICByZXRbInJlbWFyayJdID0gdWpzb24uZHVtcHMocmV0WyJyZW1hcmsiXSkuZW5jb2RlKCd1dGYtOCcpOwoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9ICB1YmluYXNjaWkuYjJhX2Jhc2U2NChyZXRbInJlbWFyayJdKS5kZWNvZGUoJ3V0Zi04Jykuc3RyaXAoKTsKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGNlcHRpb24gd2l0aCByZW1hcms6ICIgKyByZXRbInJlbWFyayJdKTsKICAgICAgICAKICAgIAogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5jb250ZXh0X05vZGVzKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiY29udGV4dF9Ob2RlcyJdID0gW3RhLl90b0RvY3VtZW50KCkgZm9yIHRhIGluIHNlbGYuY29udGV4dF9Ob2RlcygpXTsKICAgIAoKICAgICAgICBpZiBiSlNPTiBpcyBub3QgTm9uZToKICAgICAgICAgICAgI3ByaW50KF9fdG9TdHJpbmcgKyAiR09UIEhFUkUiLCB0eXBlKHJldCksIHJldCk7CiAgICAgICAgICAgIHJldCA9IHVqc29uLmR1bXBzKHJldCk7CiAgICAgICAgZ2MuY29sbGVjdCgpOwogICAgICAgIHJldHVybiByZXQ7CgogICAgCiAgICBkZWYgc3RvcmUoc2VsZiwgX19ldmVudD1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ05vZGVfQ29udGV4dDo6c3RvcmUoKTogJzsKICAgICAgICAKICAgICAgICBhbnN3ZXIgPSBOb25lOwoKICAgICAgICBfX3Jlc3BvbnNlID0gRXZlbnQoKS5jb2RlKCdbJytub2RlLmNvZGUoKSsnQCcrc3RyKHRpbWUudGlja3NfbXMoKSkrJ10uTm9kZV9Db250ZXh0LnN0b3JlKCknKS5tZXRob2QoJ3N0b3JlJykuY2xhc3NOYW1lKCdOb2RlX0NvbnRleHQnKS5jYXJyaWVyKG5vZGUpLnNlbmRlcihub2RlKS5yZWNpcGllbnQobm9kZS5wYXJlbnQoKSk7CgogICAgICAgIGV2SlNPTiA9IE5vbmU7CiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgZXZKU09OID0gdWpzb24ubG9hZHMoX19ldmVudC5wYXlsb2FkKCkpOwogICAgICAgICAgICBpZiAnX190aGlzJyBpbiBldkpTT046CiAgICAgICAgICAgICAgICBzZWxmLl9mcm9tRG9jdW1lbnQoZXZKU09OWydfX3RoaXMnXSk7CiAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UucmVzcG9uc2VUbyhfX2V2ZW50Ll91bmlxdWUoKSk7CiAgICAgICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgIiBoYW5kbGluZyBldmVudFsiK19fZXZlbnQuY29kZSgpKyJdIik7CgogICAgICAgIAogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImEgcmVzcG9uc2UgdG8gbXkgZXZlbnQoIitfX2V2ZW50LnJlc3BvbnNlVG8oKS5jb2RlKCkrIikgWyIgKyBfX2V2ZW50LmNsYXNzTmFtZSgpICsgIigpLiIgKyBfX2V2ZW50Lm1ldGhvZCgpICsgIigpXSIpOwogICAgICAgIAogICAgICAgICAgICBhbnN3ZXIgPSBOb2RlX0NvbnRleHQoKS5fZnJvbURvY3VtZW50KGV2SlNPTik7CiAgICAgICAgCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhlY3V0aW5nIGxvY2FsbHkiKTsKCgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZSBvciBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBpZiBhbnN3ZXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKGFuc3dlci5fdG9Eb2N1bWVudCgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoeyJfX3RoaXMiOiBzZWxmLl90b0RvY3VtZW50KCl9KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnRyaWdnZXIoKTsKICAgICAgICAgICAgCgogICAgICAgIHJldHVybiBhbnN3ZXI7CgogICAgCiAgICBkZWYgZmluZEFsbChzZWxmLCBfX2V2ZW50PU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnTm9kZV9Db250ZXh0OjpmaW5kQWxsKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLk5vZGVfQ29udGV4dC5maW5kQWxsKCknKS5tZXRob2QoJ2ZpbmRBbGwnKS5jbGFzc05hbWUoJ05vZGVfQ29udGV4dCcpLmNhcnJpZXIobm9kZSkuc2VuZGVyKG5vZGUpLnJlY2lwaWVudChub2RlLnBhcmVudCgpKTsKCiAgICAgICAgZXZKU09OID0gTm9uZTsKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBldkpTT04gPSB1anNvbi5sb2FkcyhfX2V2ZW50LnBheWxvYWQoKSk7CiAgICAgICAgICAgIGlmICdfX3RoaXMnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIHNlbGYuX2Zyb21Eb2N1bWVudChldkpTT05bJ19fdGhpcyddKTsKICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS5yZXNwb25zZVRvKF9fZXZlbnQuX3VuaXF1ZSgpKTsKICAgICAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiIGhhbmRsaW5nIGV2ZW50WyIrX19ldmVudC5jb2RlKCkrIl0iKTsKCiAgICAgICAgCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiYSByZXNwb25zZSB0byBteSBldmVudCgiK19fZXZlbnQucmVzcG9uc2VUbygpLmNvZGUoKSsiKSBbIiArIF9fZXZlbnQuY2xhc3NOYW1lKCkgKyAiKCkuIiArIF9fZXZlbnQubWV0aG9kKCkgKyAiKCldIik7CiAgICAgICAgCiAgICAgICAgICAgIGFuc3dlciA9IE5vZGVfQ29udGV4dCgpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiBmaW5kKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdOb2RlX0NvbnRleHQ6OmZpbmQoKTogJzsKICAgICAgICAKICAgICAgICBhbnN3ZXIgPSBOb25lOwoKICAgICAgICBfX3Jlc3BvbnNlID0gRXZlbnQoKS5jb2RlKCdbJytub2RlLmNvZGUoKSsnQCcrc3RyKHRpbWUudGlja3NfbXMoKSkrJ10uTm9kZV9Db250ZXh0LmZpbmQoKScpLm1ldGhvZCgnZmluZCcpLmNsYXNzTmFtZSgnTm9kZV9Db250ZXh0JykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gTm9kZV9Db250ZXh0KCkuX2Zyb21Eb2N1bWVudChldkpTT04pOwogICAgICAgIAoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4ZWN1dGluZyBsb2NhbGx5Iik7CgoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmUgb3IgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgaWYgYW5zd2VyIGlzIG5vdCBOb25lOgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZChhbnN3ZXIuX3RvRG9jdW1lbnQoKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKHsiX190aGlzIjogc2VsZi5fdG9Eb2N1bWVudCgpfSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS50cmlnZ2VyKCk7CiAgICAgICAgICAgIAoKICAgICAgICByZXR1cm4gYW5zd2VyOwoKICAgIAoKCmNsYXNzIE5vZGVfR3JvdXAoKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBJZD1Ob25lLCBhY3RpdmU9Tm9uZSwgZW5hYmxlZD1Ob25lLCBjb2RlPU5vbmUsIG9yZGVyPU5vbmUsIGRhdGU9Tm9uZSwgbmFtZT1Ob25lLCByZW1hcms9Tm9uZSk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygpOwoKICAgICAgICAjcHJpbnQoJ05vZGVfR3JvdXA6Ol9faW5pdF9fKCknKTsKICAgICAgICBpZiBJZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgc2VsZi5JZCA9IElkOwoKICAgICAgICAKICAgICAgICBzZWxmLmFjdGl2ZShhY3RpdmUpOwogICAgICAgIHNlbGYuZW5hYmxlZChlbmFibGVkKTsKICAgICAgICBzZWxmLmNvZGUoY29kZSk7CiAgICAgICAgc2VsZi5vcmRlcihvcmRlcik7CiAgICAgICAgc2VsZi5kYXRlKGRhdGUpOwogICAgICAgIHNlbGYubmFtZShuYW1lKTsKICAgICAgICBzZWxmLnJlbWFyayhyZW1hcmspOwogICAgICAgIAogICAgSWQgPSBOb25lOwogICAgCiAgICAKICAgICMgYWN0aXZlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfYWN0aXZlID0gTm9uZTsKICAgIGRlZiBhY3RpdmUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2FjdGl2ZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2FjdGl2ZTsKICAgIAogICAgIyBlbmFibGVkOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfZW5hYmxlZCA9IE5vbmU7CiAgICBkZWYgZW5hYmxlZChzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fZW5hYmxlZCA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2VuYWJsZWQ7CiAgICAKICAgICMgY29kZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2NvZGUgPSBOb25lOwogICAgZGVmIGNvZGUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2NvZGUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jb2RlOwogICAgCiAgICAjIG9yZGVyOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfb3JkZXIgPSBOb25lOwogICAgZGVmIG9yZGVyKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9vcmRlciA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX29yZGVyOwogICAgCiAgICAjIGRhdGU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9kYXRlID0gTm9uZTsKICAgIGRlZiBkYXRlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9kYXRlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICBpZiBzZWxmLl9kYXRlPT0ne3tub3d9fSc6CiAgICAgICAgICAgICAgICBzZWxmLl9kYXRlID0gdGltZS50aWNrc19tcygpOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9kYXRlOwogICAgCiAgICAjIG5hbWU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9uYW1lID0gTm9uZTsKICAgIGRlZiBuYW1lKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9uYW1lID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fbmFtZTsKICAgIAogICAgIyByZW1hcms6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9yZW1hcmsgPSBOb25lOwogICAgZGVmIHJlbWFyayhzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fcmVtYXJrID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fcmVtYXJrOwogICAgCiAgICAKICAgIAogICAgIyBncm91cF9Ob2RlczogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2dyb3VwX05vZGVzID0gTm9uZTsKICAgIGRlZiBncm91cF9Ob2RlcyhzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fZ3JvdXBfTm9kZXMgPSBhcmdzWzBdOwogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZ3JvdXBfTm9kZXM7CiAgICAKICAgIAogICAgZGVmIF91bmlxdWUoc2VsZik6CiAgICAgICAgX190b1N0cmluZyA9ICdOb2RlX0dyb3VwOjpfdW5pcXVlKCk6ICc7CiAgICAgICAgCiAgICAgICAgcmV0ID0gTm9kZV9Hcm91cCgpOwogICAgICAgIGlmIHNlbGYuSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldC5JZCA9IHNlbGYuSWQ7CiAgICAKICAgICAgICBpZiBzZWxmLm5hbWUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0Lm5hbWUoc2VsZi5uYW1lKCkpOwogICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwogICAgICAgIHJldHVybiByZXQ7CiAgICAKICAgIGRlZiBfZnJvbURvY3VtZW50KHNlbGYsIG9iaik6CiAgICAgICAgX190b1N0cmluZyA9ICdOb2RlX0dyb3VwOjpfZnJvbURvY3VtZW50KCk6ICc7CiAgICAgICAgCiAgICAgICAgaWYgb2JqIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBzZWxmOwoKICAgICAgICBpZiBpc2luc3RhbmNlKG9iaiwgYnl0ZXMpOgogICAgICAgICAgICBvYmogPSBzdHIob2JqLCAidXRmLTgiKTsKCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIHN0cikgb3IgdHlwZShvYmopIGlzIHN0cjoKICAgICAgICAgICAgaWYgcmUubWF0Y2gociIoKChbQS1aYS16XXszLDl9Oig/OlwvXC8pPykoPzpbLTs6Jj1cK1wkLFx3XStAKT9bQS1aYS16MC05Li1dK3woPzp3d3cufFstOzomPVwrXCQsXHddK0ApW0EtWmEtejAtOS4tXSspKCg/OlwvW1wrfiVcLy5cd1wtX10qKT9cPz8oPzpbLVwrPSY7JUAuXHdfXSopIz8oPzpbXHddKikpPykiLCBvYmopOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIG9iaiA9IHVqc29uLmxvYWRzKHVybGxpYjMuUG9vbE1hbmFnZXIoKS5yZXF1ZXN0KCdHRVQnLCBvYmopLmRhdGEuZGVjb2RlKCd1dGYtOCcpKTsKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBvYmogPSB7fTsKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG9iaiA9IHVqc29uLmxvYWRzKG9iaik7CiAgICAgICAgCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIGxpc3QpOgogICAgICAgICAgICByZXR1cm4gW05vZGVfR3JvdXAoKS5fZnJvbURvY3VtZW50KG8pIGZvciBvIGluIG9ial07CiAgICAgICAgICAgIAogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKG9iaiwgKHN0ciwgYnl0ZXMsIGRpY3QpKToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICd1bmhhbmRsZWQgdHlwZTogJyArIHN0cih0eXBlKG9iaikpKTsKICAgICAgICAgICAgcmV0dXJuIG9iajsKCiAgICAgICAgaWYgJ0lkJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuSWQgPSBvYmpbJ0lkJ107CgogICAgCiAgICAgICAgaWYgJ2FjdGl2ZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmFjdGl2ZShvYmpbJ2FjdGl2ZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdlbmFibGVkJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuZW5hYmxlZChvYmpbJ2VuYWJsZWQnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnY29kZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmNvZGUob2JqWydjb2RlJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ29yZGVyJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYub3JkZXIob2JqWydvcmRlciddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdkYXRlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuZGF0ZShvYmpbJ2RhdGUnXSk7CiAgICAgICAgCiAgICAgICAgICAgIHNlbGYuZGF0ZShkYXRldGltZS5kYXRldGltZS5mcm9taXNvZm9ybWF0KHNlbGYuZGF0ZSgpKSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnbmFtZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLm5hbWUob2JqWyduYW1lJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ3JlbWFyaycgaW4gb2JqOgogICAgICAgICAgICBzZWxmLnJlbWFyayhvYmpbJ3JlbWFyayddKTsKICAgICAgICAKICAgICAgICAgICAgc2VsZi5yZW1hcmsoIHViaW5hc2NpaS5hMmJfYmFzZTY0KHNlbGYucmVtYXJrKCkpICk7CiAgICAgICAgICAgIGlmIHNlbGYucmVtYXJrKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5yZW1hcmsoc2VsZi5yZW1hcmsoKS5kZWNvZGUoJ3V0Zi04Jykuc3RyaXAoKSk7CiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5yZW1hcmsoKTsKICAgICAgICAgICAgICAgICAgICAjcHJpbnQoX190b1N0cmluZyArICJyZW1hcmsgZXhjZXB0aW9uIiwgc2VsZi5yZW1hcmsoKSk7CiAgICAgICAgCiAgICAKCiAgICAKICAgICAgICBpZiAnZ3JvdXBfTm9kZXMnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5ncm91cF9Ob2RlcyhOb2RlKCkuX2Zyb21Eb2N1bWVudChvYmpbJ2dyb3VwX05vZGVzJ10pKTsKICAgIAoKICAgICAgICBnYy5jb2xsZWN0KCk7CiAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAKICAgIGRlZiBfdG9Eb2N1bWVudChzZWxmLCBiSlNPTj1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ05vZGVfR3JvdXA6Ol90b0RvY3VtZW50KCk6ICc7CgogICAgICAgIHJldCA9IHt9OwogICAgICAgIGlmIHNlbGYuSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiSWQiXSA9IHNlbGYuSWQ7CgogICAgCiAgICAgICAgaWYgc2VsZi5hY3RpdmUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJhY3RpdmUiXSA9IHNlbGYuYWN0aXZlKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmVuYWJsZWQoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJlbmFibGVkIl0gPSBzZWxmLmVuYWJsZWQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuY29kZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImNvZGUiXSA9IHNlbGYuY29kZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5vcmRlcigpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIm9yZGVyIl0gPSBzZWxmLm9yZGVyKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmRhdGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJkYXRlIl0gPSBzZWxmLmRhdGUoKTsKICAgICAgICAKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXRbImRhdGUiXSwgZGF0ZXRpbWUuZGF0ZXRpbWUpOgogICAgICAgICAgICAgICAgcmV0WyJkYXRlIl0gPSByZXRbImRhdGUiXS5pc29mb3JtYXQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYubmFtZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIm5hbWUiXSA9IHNlbGYubmFtZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5yZW1hcmsoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9IHNlbGYucmVtYXJrKCk7CiAgICAgICAgCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocmV0WyJyZW1hcmsiXSwgZGljdCk6CiAgICAgICAgICAgICAgICByZXRbInJlbWFyayJdID0gdWpzb24uZHVtcHMocmV0WyJyZW1hcmsiXSkuZW5jb2RlKCd1dGYtOCcpOwoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcmV0WyJyZW1hcmsiXSA9ICB1YmluYXNjaWkuYjJhX2Jhc2U2NChyZXRbInJlbWFyayJdKS5kZWNvZGUoJ3V0Zi04Jykuc3RyaXAoKTsKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGNlcHRpb24gd2l0aCByZW1hcms6ICIgKyByZXRbInJlbWFyayJdKTsKICAgICAgICAKICAgIAogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5ncm91cF9Ob2RlcygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImdyb3VwX05vZGVzIl0gPSBbdGEuX3RvRG9jdW1lbnQoKSBmb3IgdGEgaW4gc2VsZi5ncm91cF9Ob2RlcygpXTsKICAgIAoKICAgICAgICBpZiBiSlNPTiBpcyBub3QgTm9uZToKICAgICAgICAgICAgI3ByaW50KF9fdG9TdHJpbmcgKyAiR09UIEhFUkUiLCB0eXBlKHJldCksIHJldCk7CiAgICAgICAgICAgIHJldCA9IHVqc29uLmR1bXBzKHJldCk7CiAgICAgICAgZ2MuY29sbGVjdCgpOwogICAgICAgIHJldHVybiByZXQ7CgogICAgCiAgICBkZWYgc3RvcmUoc2VsZiwgX19ldmVudD1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ05vZGVfR3JvdXA6OnN0b3JlKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLk5vZGVfR3JvdXAuc3RvcmUoKScpLm1ldGhvZCgnc3RvcmUnKS5jbGFzc05hbWUoJ05vZGVfR3JvdXAnKS5jYXJyaWVyKG5vZGUpLnNlbmRlcihub2RlKS5yZWNpcGllbnQobm9kZS5wYXJlbnQoKSk7CgogICAgICAgIGV2SlNPTiA9IE5vbmU7CiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgZXZKU09OID0gdWpzb24ubG9hZHMoX19ldmVudC5wYXlsb2FkKCkpOwogICAgICAgICAgICBpZiAnX190aGlzJyBpbiBldkpTT046CiAgICAgICAgICAgICAgICBzZWxmLl9mcm9tRG9jdW1lbnQoZXZKU09OWydfX3RoaXMnXSk7CiAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UucmVzcG9uc2VUbyhfX2V2ZW50Ll91bmlxdWUoKSk7CiAgICAgICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgIiBoYW5kbGluZyBldmVudFsiK19fZXZlbnQuY29kZSgpKyJdIik7CgogICAgICAgIAogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImEgcmVzcG9uc2UgdG8gbXkgZXZlbnQoIitfX2V2ZW50LnJlc3BvbnNlVG8oKS5jb2RlKCkrIikgWyIgKyBfX2V2ZW50LmNsYXNzTmFtZSgpICsgIigpLiIgKyBfX2V2ZW50Lm1ldGhvZCgpICsgIigpXSIpOwogICAgICAgIAogICAgICAgICAgICBhbnN3ZXIgPSBOb2RlX0dyb3VwKCkuX2Zyb21Eb2N1bWVudChldkpTT04pOwogICAgICAgIAoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4ZWN1dGluZyBsb2NhbGx5Iik7CgoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmUgb3IgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgaWYgYW5zd2VyIGlzIG5vdCBOb25lOgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZChhbnN3ZXIuX3RvRG9jdW1lbnQoKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKHsiX190aGlzIjogc2VsZi5fdG9Eb2N1bWVudCgpfSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS50cmlnZ2VyKCk7CiAgICAgICAgICAgIAoKICAgICAgICByZXR1cm4gYW5zd2VyOwoKICAgIAogICAgZGVmIGZpbmRBbGwoc2VsZiwgX19ldmVudD1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ05vZGVfR3JvdXA6OmZpbmRBbGwoKTogJzsKICAgICAgICAKICAgICAgICBhbnN3ZXIgPSBOb25lOwoKICAgICAgICBfX3Jlc3BvbnNlID0gRXZlbnQoKS5jb2RlKCdbJytub2RlLmNvZGUoKSsnQCcrc3RyKHRpbWUudGlja3NfbXMoKSkrJ10uTm9kZV9Hcm91cC5maW5kQWxsKCknKS5tZXRob2QoJ2ZpbmRBbGwnKS5jbGFzc05hbWUoJ05vZGVfR3JvdXAnKS5jYXJyaWVyKG5vZGUpLnNlbmRlcihub2RlKS5yZWNpcGllbnQobm9kZS5wYXJlbnQoKSk7CgogICAgICAgIGV2SlNPTiA9IE5vbmU7CiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgZXZKU09OID0gdWpzb24ubG9hZHMoX19ldmVudC5wYXlsb2FkKCkpOwogICAgICAgICAgICBpZiAnX190aGlzJyBpbiBldkpTT046CiAgICAgICAgICAgICAgICBzZWxmLl9mcm9tRG9jdW1lbnQoZXZKU09OWydfX3RoaXMnXSk7CiAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UucmVzcG9uc2VUbyhfX2V2ZW50Ll91bmlxdWUoKSk7CiAgICAgICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgIiBoYW5kbGluZyBldmVudFsiK19fZXZlbnQuY29kZSgpKyJdIik7CgogICAgICAgIAogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImEgcmVzcG9uc2UgdG8gbXkgZXZlbnQoIitfX2V2ZW50LnJlc3BvbnNlVG8oKS5jb2RlKCkrIikgWyIgKyBfX2V2ZW50LmNsYXNzTmFtZSgpICsgIigpLiIgKyBfX2V2ZW50Lm1ldGhvZCgpICsgIigpXSIpOwogICAgICAgIAogICAgICAgICAgICBhbnN3ZXIgPSBOb2RlX0dyb3VwKCkuX2Zyb21Eb2N1bWVudChldkpTT04pOwogICAgICAgIAoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4ZWN1dGluZyBsb2NhbGx5Iik7CgoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmUgb3IgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgaWYgYW5zd2VyIGlzIG5vdCBOb25lOgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZChhbnN3ZXIuX3RvRG9jdW1lbnQoKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKHsiX190aGlzIjogc2VsZi5fdG9Eb2N1bWVudCgpfSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS50cmlnZ2VyKCk7CiAgICAgICAgICAgIAoKICAgICAgICByZXR1cm4gYW5zd2VyOwoKICAgIAogICAgZGVmIGZpbmQoc2VsZiwgX19ldmVudD1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ05vZGVfR3JvdXA6OmZpbmQoKTogJzsKICAgICAgICAKICAgICAgICBhbnN3ZXIgPSBOb25lOwoKICAgICAgICBfX3Jlc3BvbnNlID0gRXZlbnQoKS5jb2RlKCdbJytub2RlLmNvZGUoKSsnQCcrc3RyKHRpbWUudGlja3NfbXMoKSkrJ10uTm9kZV9Hcm91cC5maW5kKCknKS5tZXRob2QoJ2ZpbmQnKS5jbGFzc05hbWUoJ05vZGVfR3JvdXAnKS5jYXJyaWVyKG5vZGUpLnNlbmRlcihub2RlKS5yZWNpcGllbnQobm9kZS5wYXJlbnQoKSk7CgogICAgICAgIGV2SlNPTiA9IE5vbmU7CiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgZXZKU09OID0gdWpzb24ubG9hZHMoX19ldmVudC5wYXlsb2FkKCkpOwogICAgICAgICAgICBpZiAnX190aGlzJyBpbiBldkpTT046CiAgICAgICAgICAgICAgICBzZWxmLl9mcm9tRG9jdW1lbnQoZXZKU09OWydfX3RoaXMnXSk7CiAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UucmVzcG9uc2VUbyhfX2V2ZW50Ll91bmlxdWUoKSk7CiAgICAgICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgIiBoYW5kbGluZyBldmVudFsiK19fZXZlbnQuY29kZSgpKyJdIik7CgogICAgICAgIAogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImEgcmVzcG9uc2UgdG8gbXkgZXZlbnQoIitfX2V2ZW50LnJlc3BvbnNlVG8oKS5jb2RlKCkrIikgWyIgKyBfX2V2ZW50LmNsYXNzTmFtZSgpICsgIigpLiIgKyBfX2V2ZW50Lm1ldGhvZCgpICsgIigpXSIpOwogICAgICAgIAogICAgICAgICAgICBhbnN3ZXIgPSBOb2RlX0dyb3VwKCkuX2Zyb21Eb2N1bWVudChldkpTT04pOwogICAgICAgIAoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4ZWN1dGluZyBsb2NhbGx5Iik7CgoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmUgb3IgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgaWYgYW5zd2VyIGlzIG5vdCBOb25lOgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZChhbnN3ZXIuX3RvRG9jdW1lbnQoKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKHsiX190aGlzIjogc2VsZi5fdG9Eb2N1bWVudCgpfSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS50cmlnZ2VyKCk7CiAgICAgICAgICAgIAoKICAgICAgICByZXR1cm4gYW5zd2VyOwoKICAgIAoKCmNsYXNzIE5vZGVfVHlwZSgpOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIElkPU5vbmUsIGFjdGl2ZT1Ob25lLCBlbmFibGVkPU5vbmUsIGNvZGU9Tm9uZSwgb3JkZXI9Tm9uZSwgZGF0ZT1Ob25lLCBuYW1lPU5vbmUsIHJlbWFyaz1Ob25lLCBkeW5hbWljPU5vbmUpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKTsKCiAgICAgICAgI3ByaW50KCdOb2RlX1R5cGU6Ol9faW5pdF9fKCknKTsKICAgICAgICBpZiBJZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgc2VsZi5JZCA9IElkOwoKICAgICAgICAKICAgICAgICBzZWxmLmFjdGl2ZShhY3RpdmUpOwogICAgICAgIHNlbGYuZW5hYmxlZChlbmFibGVkKTsKICAgICAgICBzZWxmLmNvZGUoY29kZSk7CiAgICAgICAgc2VsZi5vcmRlcihvcmRlcik7CiAgICAgICAgc2VsZi5kYXRlKGRhdGUpOwogICAgICAgIHNlbGYubmFtZShuYW1lKTsKICAgICAgICBzZWxmLnJlbWFyayhyZW1hcmspOwogICAgICAgIHNlbGYuZHluYW1pYyhkeW5hbWljKTsKICAgICAgICAKICAgIElkID0gTm9uZTsKICAgIAogICAgCiAgICAjIGFjdGl2ZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2FjdGl2ZSA9IE5vbmU7CiAgICBkZWYgYWN0aXZlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9hY3RpdmUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9hY3RpdmU7CiAgICAKICAgICMgZW5hYmxlZDogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2VuYWJsZWQgPSBOb25lOwogICAgZGVmIGVuYWJsZWQoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2VuYWJsZWQgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9lbmFibGVkOwogICAgCiAgICAjIGNvZGU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9jb2RlID0gTm9uZTsKICAgIGRlZiBjb2RlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9jb2RlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fY29kZTsKICAgIAogICAgIyBvcmRlcjogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX29yZGVyID0gTm9uZTsKICAgIGRlZiBvcmRlcihzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fb3JkZXIgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9vcmRlcjsKICAgIAogICAgIyBkYXRlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfZGF0ZSA9IE5vbmU7CiAgICBkZWYgZGF0ZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fZGF0ZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgaWYgc2VsZi5fZGF0ZT09J3t7bm93fX0nOgogICAgICAgICAgICAgICAgc2VsZi5fZGF0ZSA9IHRpbWUudGlja3NfbXMoKTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fZGF0ZTsKICAgIAogICAgIyBuYW1lOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfbmFtZSA9IE5vbmU7CiAgICBkZWYgbmFtZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fbmFtZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX25hbWU7CiAgICAKICAgICMgcmVtYXJrOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfcmVtYXJrID0gTm9uZTsKICAgIGRlZiByZW1hcmsoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX3JlbWFyayA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3JlbWFyazsKICAgIAogICAgIyBkeW5hbWljOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfZHluYW1pYyA9IE5vbmU7CiAgICBkZWYgZHluYW1pYyhzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fZHluYW1pYyA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX2R5bmFtaWM7CiAgICAKICAgIAogICAgCiAgICAjIHR5cGVfTm9kZXM6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF90eXBlX05vZGVzID0gTm9uZTsKICAgIGRlZiB0eXBlX05vZGVzKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl90eXBlX05vZGVzID0gYXJnc1swXTsKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3R5cGVfTm9kZXM7CiAgICAKICAgIAogICAgZGVmIF91bmlxdWUoc2VsZik6CiAgICAgICAgX190b1N0cmluZyA9ICdOb2RlX1R5cGU6Ol91bmlxdWUoKTogJzsKICAgICAgICAKICAgICAgICByZXQgPSBOb2RlX1R5cGUoKTsKICAgICAgICBpZiBzZWxmLklkIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXQuSWQgPSBzZWxmLklkOwogICAgCiAgICAgICAgaWYgc2VsZi5uYW1lKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldC5uYW1lKHNlbGYubmFtZSgpKTsKICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gcmV0OwogICAgCiAgICBkZWYgX2Zyb21Eb2N1bWVudChzZWxmLCBvYmopOgogICAgICAgIF9fdG9TdHJpbmcgPSAnTm9kZV9UeXBlOjpfZnJvbURvY3VtZW50KCk6ICc7CiAgICAgICAgCiAgICAgICAgaWYgb2JqIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBzZWxmOwoKICAgICAgICBpZiBpc2luc3RhbmNlKG9iaiwgYnl0ZXMpOgogICAgICAgICAgICBvYmogPSBzdHIob2JqLCAidXRmLTgiKTsKCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIHN0cikgb3IgdHlwZShvYmopIGlzIHN0cjoKICAgICAgICAgICAgaWYgcmUubWF0Y2gociIoKChbQS1aYS16XXszLDl9Oig/OlwvXC8pPykoPzpbLTs6Jj1cK1wkLFx3XStAKT9bQS1aYS16MC05Li1dK3woPzp3d3cufFstOzomPVwrXCQsXHddK0ApW0EtWmEtejAtOS4tXSspKCg/OlwvW1wrfiVcLy5cd1wtX10qKT9cPz8oPzpbLVwrPSY7JUAuXHdfXSopIz8oPzpbXHddKikpPykiLCBvYmopOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIG9iaiA9IHVqc29uLmxvYWRzKHVybGxpYjMuUG9vbE1hbmFnZXIoKS5yZXF1ZXN0KCdHRVQnLCBvYmopLmRhdGEuZGVjb2RlKCd1dGYtOCcpKTsKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBvYmogPSB7fTsKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG9iaiA9IHVqc29uLmxvYWRzKG9iaik7CiAgICAgICAgCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIGxpc3QpOgogICAgICAgICAgICByZXR1cm4gW05vZGVfVHlwZSgpLl9mcm9tRG9jdW1lbnQobykgZm9yIG8gaW4gb2JqXTsKICAgICAgICAgICAgCiAgICAgICAgaWYgbm90IGlzaW5zdGFuY2Uob2JqLCAoc3RyLCBieXRlcywgZGljdCkpOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgJ3VuaGFuZGxlZCB0eXBlOiAnICsgc3RyKHR5cGUob2JqKSkpOwogICAgICAgICAgICByZXR1cm4gb2JqOwoKICAgICAgICBpZiAnSWQnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5JZCA9IG9ialsnSWQnXTsKCiAgICAKICAgICAgICBpZiAnYWN0aXZlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuYWN0aXZlKG9ialsnYWN0aXZlJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2VuYWJsZWQnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5lbmFibGVkKG9ialsnZW5hYmxlZCddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdjb2RlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuY29kZShvYmpbJ2NvZGUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnb3JkZXInIGluIG9iajoKICAgICAgICAgICAgc2VsZi5vcmRlcihvYmpbJ29yZGVyJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2RhdGUnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5kYXRlKG9ialsnZGF0ZSddKTsKICAgICAgICAKICAgICAgICAgICAgc2VsZi5kYXRlKGRhdGV0aW1lLmRhdGV0aW1lLmZyb21pc29mb3JtYXQoc2VsZi5kYXRlKCkpKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICduYW1lJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYubmFtZShvYmpbJ25hbWUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAncmVtYXJrJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYucmVtYXJrKG9ialsncmVtYXJrJ10pOwogICAgICAgIAogICAgICAgICAgICBzZWxmLnJlbWFyayggdWJpbmFzY2lpLmEyYl9iYXNlNjQoc2VsZi5yZW1hcmsoKSkgKTsKICAgICAgICAgICAgaWYgc2VsZi5yZW1hcmsoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbWFyayhzZWxmLnJlbWFyaygpLmRlY29kZSgndXRmLTgnKS5zdHJpcCgpKTsKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlbWFyaygpOwogICAgICAgICAgICAgICAgICAgICNwcmludChfX3RvU3RyaW5nICsgInJlbWFyayBleGNlcHRpb24iLCBzZWxmLnJlbWFyaygpKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdkeW5hbWljJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuZHluYW1pYyhvYmpbJ2R5bmFtaWMnXSk7CiAgICAgICAgCiAgICAKCiAgICAKICAgICAgICBpZiAndHlwZV9Ob2RlcycgaW4gb2JqOgogICAgICAgICAgICBzZWxmLnR5cGVfTm9kZXMoTm9kZSgpLl9mcm9tRG9jdW1lbnQob2JqWyd0eXBlX05vZGVzJ10pKTsKICAgIAoKICAgICAgICBnYy5jb2xsZWN0KCk7CiAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAKICAgIGRlZiBfdG9Eb2N1bWVudChzZWxmLCBiSlNPTj1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ05vZGVfVHlwZTo6X3RvRG9jdW1lbnQoKTogJzsKCiAgICAgICAgcmV0ID0ge307CiAgICAgICAgaWYgc2VsZi5JZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJJZCJdID0gc2VsZi5JZDsKCiAgICAKICAgICAgICBpZiBzZWxmLmFjdGl2ZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImFjdGl2ZSJdID0gc2VsZi5hY3RpdmUoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuZW5hYmxlZCgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImVuYWJsZWQiXSA9IHNlbGYuZW5hYmxlZCgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5jb2RlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiY29kZSJdID0gc2VsZi5jb2RlKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLm9yZGVyKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsib3JkZXIiXSA9IHNlbGYub3JkZXIoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuZGF0ZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbImRhdGUiXSA9IHNlbGYuZGF0ZSgpOwogICAgICAgIAogICAgICAgICAgICBpZiBpc2luc3RhbmNlKHJldFsiZGF0ZSJdLCBkYXRldGltZS5kYXRldGltZSk6CiAgICAgICAgICAgICAgICByZXRbImRhdGUiXSA9IHJldFsiZGF0ZSJdLmlzb2Zvcm1hdCgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5uYW1lKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsibmFtZSJdID0gc2VsZi5uYW1lKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLnJlbWFyaygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbInJlbWFyayJdID0gc2VsZi5yZW1hcmsoKTsKICAgICAgICAKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXRbInJlbWFyayJdLCBkaWN0KToKICAgICAgICAgICAgICAgIHJldFsicmVtYXJrIl0gPSB1anNvbi5kdW1wcyhyZXRbInJlbWFyayJdKS5lbmNvZGUoJ3V0Zi04Jyk7CgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXRbInJlbWFyayJdID0gIHViaW5hc2NpaS5iMmFfYmFzZTY0KHJldFsicmVtYXJrIl0pLmRlY29kZSgndXRmLTgnKS5zdHJpcCgpOwogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4Y2VwdGlvbiB3aXRoIHJlbWFyazogIiArIHJldFsicmVtYXJrIl0pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5keW5hbWljKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZHluYW1pYyJdID0gc2VsZi5keW5hbWljKCk7CiAgICAgICAgCiAgICAKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYudHlwZV9Ob2RlcygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbInR5cGVfTm9kZXMiXSA9IFt0YS5fdG9Eb2N1bWVudCgpIGZvciB0YSBpbiBzZWxmLnR5cGVfTm9kZXMoKV07CiAgICAKCiAgICAgICAgaWYgYkpTT04gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICNwcmludChfX3RvU3RyaW5nICsgIkdPVCBIRVJFIiwgdHlwZShyZXQpLCByZXQpOwogICAgICAgICAgICByZXQgPSB1anNvbi5kdW1wcyhyZXQpOwogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gcmV0OwoKICAgIAogICAgZGVmIHN0b3JlKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdOb2RlX1R5cGU6OnN0b3JlKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLk5vZGVfVHlwZS5zdG9yZSgpJykubWV0aG9kKCdzdG9yZScpLmNsYXNzTmFtZSgnTm9kZV9UeXBlJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gTm9kZV9UeXBlKCkuX2Zyb21Eb2N1bWVudChldkpTT04pOwogICAgICAgIAoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4ZWN1dGluZyBsb2NhbGx5Iik7CgoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmUgb3IgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgaWYgYW5zd2VyIGlzIG5vdCBOb25lOgogICAgICAgICAgICAKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZChhbnN3ZXIuX3RvRG9jdW1lbnQoKSk7CiAgICAgICAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKHsiX190aGlzIjogc2VsZi5fdG9Eb2N1bWVudCgpfSk7CgogICAgICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS50cmlnZ2VyKCk7CiAgICAgICAgICAgIAoKICAgICAgICByZXR1cm4gYW5zd2VyOwoKICAgIAogICAgZGVmIGZpbmRBbGwoc2VsZiwgX19ldmVudD1Ob25lKToKICAgICAgICBfX3RvU3RyaW5nID0gJ05vZGVfVHlwZTo6ZmluZEFsbCgpOiAnOwogICAgICAgIAogICAgICAgIGFuc3dlciA9IE5vbmU7CgogICAgICAgIF9fcmVzcG9uc2UgPSBFdmVudCgpLmNvZGUoJ1snK25vZGUuY29kZSgpKydAJytzdHIodGltZS50aWNrc19tcygpKSsnXS5Ob2RlX1R5cGUuZmluZEFsbCgpJykubWV0aG9kKCdmaW5kQWxsJykuY2xhc3NOYW1lKCdOb2RlX1R5cGUnKS5jYXJyaWVyKG5vZGUpLnNlbmRlcihub2RlKS5yZWNpcGllbnQobm9kZS5wYXJlbnQoKSk7CgogICAgICAgIGV2SlNPTiA9IE5vbmU7CiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZToKICAgICAgICAgICAgZXZKU09OID0gdWpzb24ubG9hZHMoX19ldmVudC5wYXlsb2FkKCkpOwogICAgICAgICAgICBpZiAnX190aGlzJyBpbiBldkpTT046CiAgICAgICAgICAgICAgICBzZWxmLl9mcm9tRG9jdW1lbnQoZXZKU09OWydfX3RoaXMnXSk7CiAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UucmVzcG9uc2VUbyhfX2V2ZW50Ll91bmlxdWUoKSk7CiAgICAgICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwoKCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgIiBoYW5kbGluZyBldmVudFsiK19fZXZlbnQuY29kZSgpKyJdIik7CgogICAgICAgIAogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImEgcmVzcG9uc2UgdG8gbXkgZXZlbnQoIitfX2V2ZW50LnJlc3BvbnNlVG8oKS5jb2RlKCkrIikgWyIgKyBfX2V2ZW50LmNsYXNzTmFtZSgpICsgIigpLiIgKyBfX2V2ZW50Lm1ldGhvZCgpICsgIigpXSIpOwogICAgICAgIAogICAgICAgICAgICBhbnN3ZXIgPSBOb2RlX1R5cGUoKS5fZnJvbURvY3VtZW50KGV2SlNPTik7CiAgICAgICAgCgoKICAgICAgICBpZiBfX2V2ZW50IGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiZXhlY3V0aW5nIGxvY2FsbHkiKTsKCgoKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZSBvciBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBOb25lOgogICAgICAgICAgICBpZiBhbnN3ZXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIAogICAgICAgICAgICAgICAgX19yZXNwb25zZS5wYXlsb2FkKGFuc3dlci5fdG9Eb2N1bWVudCgpKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoeyJfX3RoaXMiOiBzZWxmLl90b0RvY3VtZW50KCl9KTsKCiAgICAgICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnRyaWdnZXIoKTsKICAgICAgICAgICAgCgogICAgICAgIHJldHVybiBhbnN3ZXI7CgogICAgCiAgICBkZWYgZmluZChzZWxmLCBfX2V2ZW50PU5vbmUpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnTm9kZV9UeXBlOjpmaW5kKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLk5vZGVfVHlwZS5maW5kKCknKS5tZXRob2QoJ2ZpbmQnKS5jbGFzc05hbWUoJ05vZGVfVHlwZScpLmNhcnJpZXIobm9kZSkuc2VuZGVyKG5vZGUpLnJlY2lwaWVudChub2RlLnBhcmVudCgpKTsKCiAgICAgICAgZXZKU09OID0gTm9uZTsKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lOgogICAgICAgICAgICBldkpTT04gPSB1anNvbi5sb2FkcyhfX2V2ZW50LnBheWxvYWQoKSk7CiAgICAgICAgICAgIGlmICdfX3RoaXMnIGluIGV2SlNPTjoKICAgICAgICAgICAgICAgIHNlbGYuX2Zyb21Eb2N1bWVudChldkpTT05bJ19fdGhpcyddKTsKICAgICAgICAKICAgICAgICAgICAgX19yZXNwb25zZS5yZXNwb25zZVRvKF9fZXZlbnQuX3VuaXF1ZSgpKTsKICAgICAgICAKICAgICAgICBnYy5jb2xsZWN0KCk7CgoKICAgICAgICBsYXN0VXBkYXRlID0gc2VsZi5kYXRlKCk7CiAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGJhc2VfdXJsKTsKCiAgICAgICAgaWYgc2VsZi5kYXRlKCk+bGFzdFVwZGF0ZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJuZXdlciB2ZXJzaW9uOiAiICsgc3RyKHNlbGYuZGF0ZSgpKSArICIsIHJlYm9vdGluZy4uLiIpOwogICAgICAgICAgICBvcy5leGVjbChzeXMuZXhlY3V0YWJsZSwgc3lzLmV4ZWN1dGFibGUsICpzeXMuYXJndik7CgogICAgICAgIHRpbWUuc2xlZXAoMzApOwogICAgICAgIHJldHVybiBzZWxmLmZpbmQoKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmUgYW5kIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiIGhhbmRsaW5nIGV2ZW50WyIrX19ldmVudC5jb2RlKCkrIl0iKTsKCiAgICAgICAgCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHByaW50KF9fdG9TdHJpbmcgKyAiYSByZXNwb25zZSB0byBteSBldmVudCgiK19fZXZlbnQucmVzcG9uc2VUbygpLmNvZGUoKSsiKSBbIiArIF9fZXZlbnQuY2xhc3NOYW1lKCkgKyAiKCkuIiArIF9fZXZlbnQubWV0aG9kKCkgKyAiKCldIik7CiAgICAgICAgCiAgICAgICAgICAgIGFuc3dlciA9IE5vZGVfVHlwZSgpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKCgpjbGFzcyBNYXBwaW5nKCk6CiAgICBkZWYgX19pbml0X18oc2VsZiwgSWQ9Tm9uZSwgYWN0aXZlPU5vbmUsIGVuYWJsZWQ9Tm9uZSwgb3JkZXI9Tm9uZSwgY2xhc3NOYW1lPU5vbmUsIHNjb3BlPU5vbmUsIGNvbnRleHQ9Tm9uZSwgc291cmNlPU5vbmUsIHRhcmdldD1Ob25lLCBpblNjcmlwdD1Ob25lLCBvdXRTY3JpcHQ9Tm9uZSwgdG9vbD1Ob25lLCBncm91cD1Ob25lLCB0eXBlPU5vbmUpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKTsKCiAgICAgICAgI3ByaW50KCdNYXBwaW5nOjpfX2luaXRfXygpJyk7CiAgICAgICAgaWYgSWQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHNlbGYuSWQgPSBJZDsKCiAgICAgICAgCiAgICAgICAgc2VsZi5hY3RpdmUoYWN0aXZlKTsKICAgICAgICBzZWxmLmVuYWJsZWQoZW5hYmxlZCk7CiAgICAgICAgc2VsZi5vcmRlcihvcmRlcik7CiAgICAgICAgc2VsZi5jbGFzc05hbWUoY2xhc3NOYW1lKTsKICAgICAgICBzZWxmLnNjb3BlKHNjb3BlKTsKICAgICAgICBzZWxmLmNvbnRleHQoY29udGV4dCk7CiAgICAgICAgc2VsZi5zb3VyY2Uoc291cmNlKTsKICAgICAgICBzZWxmLnRhcmdldCh0YXJnZXQpOwogICAgICAgIHNlbGYuaW5TY3JpcHQoaW5TY3JpcHQpOwogICAgICAgIHNlbGYub3V0U2NyaXB0KG91dFNjcmlwdCk7CiAgICAgICAgc2VsZi50b29sKHRvb2wpOwogICAgICAgIHNlbGYuZ3JvdXAoZ3JvdXApOwogICAgICAgIHNlbGYudHlwZSh0eXBlKTsKICAgICAgICAKICAgIElkID0gTm9uZTsKICAgIAogICAgCiAgICAjIGFjdGl2ZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2FjdGl2ZSA9IE5vbmU7CiAgICBkZWYgYWN0aXZlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9hY3RpdmUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9hY3RpdmU7CiAgICAKICAgICMgZW5hYmxlZDogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2VuYWJsZWQgPSBOb25lOwogICAgZGVmIGVuYWJsZWQoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2VuYWJsZWQgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9lbmFibGVkOwogICAgCiAgICAjIG9yZGVyOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfb3JkZXIgPSBOb25lOwogICAgZGVmIG9yZGVyKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9vcmRlciA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX29yZGVyOwogICAgCiAgICAjIGNsYXNzTmFtZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2NsYXNzTmFtZSA9IE5vbmU7CiAgICBkZWYgY2xhc3NOYW1lKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9jbGFzc05hbWUgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jbGFzc05hbWU7CiAgICAKICAgICMgc2NvcGU6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9zY29wZSA9IE5vbmU7CiAgICBkZWYgc2NvcGUoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX3Njb3BlID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fc2NvcGU7CiAgICAKICAgICMgY29udGV4dDogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2NvbnRleHQgPSBOb25lOwogICAgZGVmIGNvbnRleHQoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX2NvbnRleHQgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9jb250ZXh0OwogICAgCiAgICAjIHNvdXJjZTogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX3NvdXJjZSA9IE5vbmU7CiAgICBkZWYgc291cmNlKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl9zb3VyY2UgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9zb3VyY2U7CiAgICAKICAgICMgdGFyZ2V0OiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfdGFyZ2V0ID0gTm9uZTsKICAgIGRlZiB0YXJnZXQoc2VsZiwgKmFyZ3MpOgogICAgICAgIGlmIGFyZ3M6CiAgICAgICAgICAgIHNlbGYuX3RhcmdldCA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3RhcmdldDsKICAgIAogICAgIyBpblNjcmlwdDogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2luU2NyaXB0ID0gTm9uZTsKICAgIGRlZiBpblNjcmlwdChzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5faW5TY3JpcHQgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9pblNjcmlwdDsKICAgIAogICAgIyBvdXRTY3JpcHQ6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF9vdXRTY3JpcHQgPSBOb25lOwogICAgZGVmIG91dFNjcmlwdChzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fb3V0U2NyaXB0ID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fb3V0U2NyaXB0OwogICAgCiAgICAjIHRvb2w6IEdldHRlcnMgYW5kIFNldHRlcnMKICAgIF90b29sID0gTm9uZTsKICAgIGRlZiB0b29sKHNlbGYsICphcmdzKToKICAgICAgICBpZiBhcmdzOgogICAgICAgICAgICBzZWxmLl90b29sID0gYXJnc1swXTsKICAgIAogICAgICAgICAgICByZXR1cm4gc2VsZjsKICAgICAgICBlbHNlOgogICAgICAgICAgICByZXR1cm4gc2VsZi5fdG9vbDsKICAgIAogICAgIyBncm91cDogR2V0dGVycyBhbmQgU2V0dGVycwogICAgX2dyb3VwID0gTm9uZTsKICAgIGRlZiBncm91cChzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fZ3JvdXAgPSBhcmdzWzBdOwogICAgCiAgICAgICAgICAgIHJldHVybiBzZWxmOwogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJldHVybiBzZWxmLl9ncm91cDsKICAgIAogICAgIyB0eXBlOiBHZXR0ZXJzIGFuZCBTZXR0ZXJzCiAgICBfdHlwZSA9IE5vbmU7CiAgICBkZWYgdHlwZShzZWxmLCAqYXJncyk6CiAgICAgICAgaWYgYXJnczoKICAgICAgICAgICAgc2VsZi5fdHlwZSA9IGFyZ3NbMF07CiAgICAKICAgICAgICAgICAgcmV0dXJuIHNlbGY7CiAgICAgICAgZWxzZToKICAgICAgICAgICAgcmV0dXJuIHNlbGYuX3R5cGU7CiAgICAKICAgIAogICAgCiAgICAKICAgIGRlZiBfdW5pcXVlKHNlbGYpOgogICAgICAgIF9fdG9TdHJpbmcgPSAnTWFwcGluZzo6X3VuaXF1ZSgpOiAnOwogICAgICAgIAogICAgICAgIHJldCA9IE1hcHBpbmcoKTsKICAgICAgICBpZiBzZWxmLklkIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXQuSWQgPSBzZWxmLklkOwogICAgCiAgICAgICAgZ2MuY29sbGVjdCgpOwogICAgICAgIHJldHVybiByZXQ7CiAgICAKICAgIGRlZiBfZnJvbURvY3VtZW50KHNlbGYsIG9iaik6CiAgICAgICAgX190b1N0cmluZyA9ICdNYXBwaW5nOjpfZnJvbURvY3VtZW50KCk6ICc7CiAgICAgICAgCiAgICAgICAgaWYgb2JqIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybiBzZWxmOwoKICAgICAgICBpZiBpc2luc3RhbmNlKG9iaiwgYnl0ZXMpOgogICAgICAgICAgICBvYmogPSBzdHIob2JqLCAidXRmLTgiKTsKCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIHN0cikgb3IgdHlwZShvYmopIGlzIHN0cjoKICAgICAgICAgICAgaWYgcmUubWF0Y2gociIoKChbQS1aYS16XXszLDl9Oig/OlwvXC8pPykoPzpbLTs6Jj1cK1wkLFx3XStAKT9bQS1aYS16MC05Li1dK3woPzp3d3cufFstOzomPVwrXCQsXHddK0ApW0EtWmEtejAtOS4tXSspKCg/OlwvW1wrfiVcLy5cd1wtX10qKT9cPz8oPzpbLVwrPSY7JUAuXHdfXSopIz8oPzpbXHddKikpPykiLCBvYmopOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIG9iaiA9IHVqc29uLmxvYWRzKHVybGxpYjMuUG9vbE1hbmFnZXIoKS5yZXF1ZXN0KCdHRVQnLCBvYmopLmRhdGEuZGVjb2RlKCd1dGYtOCcpKTsKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBvYmogPSB7fTsKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIG9iaiA9IHVqc29uLmxvYWRzKG9iaik7CiAgICAgICAgCiAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIGxpc3QpOgogICAgICAgICAgICByZXR1cm4gW01hcHBpbmcoKS5fZnJvbURvY3VtZW50KG8pIGZvciBvIGluIG9ial07CiAgICAgICAgICAgIAogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKG9iaiwgKHN0ciwgYnl0ZXMsIGRpY3QpKToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICd1bmhhbmRsZWQgdHlwZTogJyArIHN0cih0eXBlKG9iaikpKTsKICAgICAgICAgICAgcmV0dXJuIG9iajsKCiAgICAgICAgaWYgJ0lkJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuSWQgPSBvYmpbJ0lkJ107CgogICAgCiAgICAgICAgaWYgJ2FjdGl2ZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmFjdGl2ZShvYmpbJ2FjdGl2ZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdlbmFibGVkJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuZW5hYmxlZChvYmpbJ2VuYWJsZWQnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnb3JkZXInIGluIG9iajoKICAgICAgICAgICAgc2VsZi5vcmRlcihvYmpbJ29yZGVyJ10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2NsYXNzTmFtZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmNsYXNzTmFtZShvYmpbJ2NsYXNzTmFtZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICdzY29wZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLnNjb3BlKG9ialsnc2NvcGUnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnY29udGV4dCcgaW4gb2JqOgogICAgICAgICAgICBzZWxmLmNvbnRleHQob2JqWydjb250ZXh0J10pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ3NvdXJjZScgaW4gb2JqOgogICAgICAgICAgICBzZWxmLnNvdXJjZShvYmpbJ3NvdXJjZSddKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICd0YXJnZXQnIGluIG9iajoKICAgICAgICAgICAgc2VsZi50YXJnZXQob2JqWyd0YXJnZXQnXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnaW5TY3JpcHQnIGluIG9iajoKICAgICAgICAgICAgc2VsZi5pblNjcmlwdChvYmpbJ2luU2NyaXB0J10pOwogICAgICAgIAogICAgICAgICAgICBzZWxmLmluU2NyaXB0KCB1YmluYXNjaWkuYTJiX2Jhc2U2NChzZWxmLmluU2NyaXB0KCkpICk7CiAgICAgICAgICAgIGlmIHNlbGYuaW5TY3JpcHQoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLmluU2NyaXB0KHNlbGYuaW5TY3JpcHQoKS5kZWNvZGUoJ3V0Zi04Jykuc3RyaXAoKSk7CiAgICAgICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5pblNjcmlwdCgpOwogICAgICAgICAgICAgICAgICAgICNwcmludChfX3RvU3RyaW5nICsgImluU2NyaXB0IGV4Y2VwdGlvbiIsIHNlbGYuaW5TY3JpcHQoKSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiAnb3V0U2NyaXB0JyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYub3V0U2NyaXB0KG9ialsnb3V0U2NyaXB0J10pOwogICAgICAgIAogICAgICAgICAgICBzZWxmLm91dFNjcmlwdCggdWJpbmFzY2lpLmEyYl9iYXNlNjQoc2VsZi5vdXRTY3JpcHQoKSkgKTsKICAgICAgICAgICAgaWYgc2VsZi5vdXRTY3JpcHQoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLm91dFNjcmlwdChzZWxmLm91dFNjcmlwdCgpLmRlY29kZSgndXRmLTgnKS5zdHJpcCgpKTsKICAgICAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgICAgICBzZWxmLm91dFNjcmlwdCgpOwogICAgICAgICAgICAgICAgICAgICNwcmludChfX3RvU3RyaW5nICsgIm91dFNjcmlwdCBleGNlcHRpb24iLCBzZWxmLm91dFNjcmlwdCgpKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICd0b29sJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYudG9vbChUb29sKCkuX2Zyb21Eb2N1bWVudChvYmpbJ3Rvb2wnXSkpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgJ2dyb3VwJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYuZ3JvdXAoQ29uZmlnX0dyb3VwKCkuX2Zyb21Eb2N1bWVudChvYmpbJ2dyb3VwJ10pKTsKICAgICAgICAKICAgIAogICAgICAgIGlmICd0eXBlJyBpbiBvYmo6CiAgICAgICAgICAgIHNlbGYudHlwZShUb29sX1R5cGUoKS5fZnJvbURvY3VtZW50KG9ialsndHlwZSddKSk7CiAgICAgICAgCiAgICAKCiAgICAKCiAgICAgICAgZ2MuY29sbGVjdCgpOwogICAgICAgIHJldHVybiBzZWxmOwogICAgCiAgICBkZWYgX3RvRG9jdW1lbnQoc2VsZiwgYkpTT049Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdNYXBwaW5nOjpfdG9Eb2N1bWVudCgpOiAnOwoKICAgICAgICByZXQgPSB7fTsKICAgICAgICBpZiBzZWxmLklkIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIklkIl0gPSBzZWxmLklkOwoKICAgIAogICAgICAgIGlmIHNlbGYuYWN0aXZlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiYWN0aXZlIl0gPSBzZWxmLmFjdGl2ZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5lbmFibGVkKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiZW5hYmxlZCJdID0gc2VsZi5lbmFibGVkKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLm9yZGVyKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsib3JkZXIiXSA9IHNlbGYub3JkZXIoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuY2xhc3NOYW1lKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiY2xhc3NOYW1lIl0gPSBzZWxmLmNsYXNzTmFtZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi5zY29wZSgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbInNjb3BlIl0gPSBzZWxmLnNjb3BlKCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmNvbnRleHQoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJjb250ZXh0Il0gPSBzZWxmLmNvbnRleHQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuc291cmNlKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsic291cmNlIl0gPSBzZWxmLnNvdXJjZSgpOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi50YXJnZXQoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJ0YXJnZXQiXSA9IHNlbGYudGFyZ2V0KCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLmluU2NyaXB0KCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsiaW5TY3JpcHQiXSA9IHNlbGYuaW5TY3JpcHQoKTsKICAgICAgICAKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXRbImluU2NyaXB0Il0sIGRpY3QpOgogICAgICAgICAgICAgICAgcmV0WyJpblNjcmlwdCJdID0gdWpzb24uZHVtcHMocmV0WyJpblNjcmlwdCJdKS5lbmNvZGUoJ3V0Zi04Jyk7CgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXRbImluU2NyaXB0Il0gPSAgdWJpbmFzY2lpLmIyYV9iYXNlNjQocmV0WyJpblNjcmlwdCJdKS5kZWNvZGUoJ3V0Zi04Jykuc3RyaXAoKTsKICAgICAgICAgICAgZXhjZXB0OgogICAgICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGNlcHRpb24gd2l0aCBpblNjcmlwdDogIiArIHJldFsiaW5TY3JpcHQiXSk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLm91dFNjcmlwdCgpIGlzIG5vdCBOb25lOgogICAgICAgICAgICByZXRbIm91dFNjcmlwdCJdID0gc2VsZi5vdXRTY3JpcHQoKTsKICAgICAgICAKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyZXRbIm91dFNjcmlwdCJdLCBkaWN0KToKICAgICAgICAgICAgICAgIHJldFsib3V0U2NyaXB0Il0gPSB1anNvbi5kdW1wcyhyZXRbIm91dFNjcmlwdCJdKS5lbmNvZGUoJ3V0Zi04Jyk7CgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByZXRbIm91dFNjcmlwdCJdID0gIHViaW5hc2NpaS5iMmFfYmFzZTY0KHJldFsib3V0U2NyaXB0Il0pLmRlY29kZSgndXRmLTgnKS5zdHJpcCgpOwogICAgICAgICAgICBleGNlcHQ6CiAgICAgICAgICAgICAgICBwcmludChfX3RvU3RyaW5nICsgImV4Y2VwdGlvbiB3aXRoIG91dFNjcmlwdDogIiArIHJldFsib3V0U2NyaXB0Il0pOwogICAgICAgIAogICAgCiAgICAgICAgaWYgc2VsZi50b29sKCkgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHJldFsidG9vbCJdID0gc2VsZi50b29sKCkuX3RvRG9jdW1lbnQoKTsKICAgICAgICAKICAgIAogICAgICAgIGlmIHNlbGYuZ3JvdXAoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJncm91cCJdID0gc2VsZi5ncm91cCgpLl90b0RvY3VtZW50KCk7CiAgICAgICAgCiAgICAKICAgICAgICBpZiBzZWxmLnR5cGUoKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcmV0WyJ0eXBlIl0gPSBzZWxmLnR5cGUoKS5fdG9Eb2N1bWVudCgpOwogICAgICAgIAogICAgCiAgICAgICAgCiAgICAKCiAgICAgICAgaWYgYkpTT04gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICNwcmludChfX3RvU3RyaW5nICsgIkdPVCBIRVJFIiwgdHlwZShyZXQpLCByZXQpOwogICAgICAgICAgICByZXQgPSB1anNvbi5kdW1wcyhyZXQpOwogICAgICAgIGdjLmNvbGxlY3QoKTsKICAgICAgICByZXR1cm4gcmV0OwoKICAgIAogICAgZGVmIHN0b3JlKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdNYXBwaW5nOjpzdG9yZSgpOiAnOwogICAgICAgIAogICAgICAgIGFuc3dlciA9IE5vbmU7CgogICAgICAgIF9fcmVzcG9uc2UgPSBFdmVudCgpLmNvZGUoJ1snK25vZGUuY29kZSgpKydAJytzdHIodGltZS50aWNrc19tcygpKSsnXS5NYXBwaW5nLnN0b3JlKCknKS5tZXRob2QoJ3N0b3JlJykuY2xhc3NOYW1lKCdNYXBwaW5nJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gTWFwcGluZygpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiBmaW5kQWxsKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdNYXBwaW5nOjpmaW5kQWxsKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLk1hcHBpbmcuZmluZEFsbCgpJykubWV0aG9kKCdmaW5kQWxsJykuY2xhc3NOYW1lKCdNYXBwaW5nJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gTWFwcGluZygpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKICAgIGRlZiBmaW5kKHNlbGYsIF9fZXZlbnQ9Tm9uZSk6CiAgICAgICAgX190b1N0cmluZyA9ICdNYXBwaW5nOjpmaW5kKCk6ICc7CiAgICAgICAgCiAgICAgICAgYW5zd2VyID0gTm9uZTsKCiAgICAgICAgX19yZXNwb25zZSA9IEV2ZW50KCkuY29kZSgnWycrbm9kZS5jb2RlKCkrJ0AnK3N0cih0aW1lLnRpY2tzX21zKCkpKyddLk1hcHBpbmcuZmluZCgpJykubWV0aG9kKCdmaW5kJykuY2xhc3NOYW1lKCdNYXBwaW5nJykuY2Fycmllcihub2RlKS5zZW5kZXIobm9kZSkucmVjaXBpZW50KG5vZGUucGFyZW50KCkpOwoKICAgICAgICBldkpTT04gPSBOb25lOwogICAgICAgIGlmIF9fZXZlbnQgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIGV2SlNPTiA9IHVqc29uLmxvYWRzKF9fZXZlbnQucGF5bG9hZCgpKTsKICAgICAgICAgICAgaWYgJ19fdGhpcycgaW4gZXZKU09OOgogICAgICAgICAgICAgICAgc2VsZi5fZnJvbURvY3VtZW50KGV2SlNPTlsnX190aGlzJ10pOwogICAgICAgIAogICAgICAgICAgICBfX3Jlc3BvbnNlLnJlc3BvbnNlVG8oX19ldmVudC5fdW5pcXVlKCkpOwogICAgICAgIAogICAgICAgIGdjLmNvbGxlY3QoKTsKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBub3QgTm9uZSBhbmQgX19ldmVudC5yZXNwb25zZVRvKCkgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICIgaGFuZGxpbmcgZXZlbnRbIitfX2V2ZW50LmNvZGUoKSsiXSIpOwoKICAgICAgICAKICAgICAgICBpZiBfX2V2ZW50IGlzIG5vdCBOb25lIGFuZCBfX2V2ZW50LnJlc3BvbnNlVG8oKSBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJhIHJlc3BvbnNlIHRvIG15IGV2ZW50KCIrX19ldmVudC5yZXNwb25zZVRvKCkuY29kZSgpKyIpIFsiICsgX19ldmVudC5jbGFzc05hbWUoKSArICIoKS4iICsgX19ldmVudC5tZXRob2QoKSArICIoKV0iKTsKICAgICAgICAKICAgICAgICAgICAgYW5zd2VyID0gTWFwcGluZygpLl9mcm9tRG9jdW1lbnQoZXZKU09OKTsKICAgICAgICAKCgogICAgICAgIGlmIF9fZXZlbnQgaXMgTm9uZToKICAgICAgICAgICAgcHJpbnQoX190b1N0cmluZyArICJleGVjdXRpbmcgbG9jYWxseSIpOwoKCgoKCiAgICAgICAgaWYgX19ldmVudCBpcyBOb25lIG9yIF9fZXZlbnQucmVzcG9uc2VUbygpIGlzIE5vbmU6CiAgICAgICAgICAgIGlmIGFuc3dlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBfX3Jlc3BvbnNlLnBheWxvYWQoYW5zd2VyLl90b0RvY3VtZW50KCkpOwogICAgICAgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIF9fcmVzcG9uc2UucGF5bG9hZCh7Il9fdGhpcyI6IHNlbGYuX3RvRG9jdW1lbnQoKX0pOwoKICAgICAgICAgICAgCiAgICAgICAgICAgIF9fcmVzcG9uc2UudHJpZ2dlcigpOwogICAgICAgICAgICAKCiAgICAgICAgcmV0dXJuIGFuc3dlcjsKCiAgICAKCgoKCgogICAgCiMjIyMjIyMjIyMjIFdJRkkgQ29ubmVjdGlvbiAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwpwcmludCgnbWFpbigpJywgIkNvbm5lY3RpbmcgdG8gV2lGaS4uLiIsIGVuZD0iIik7Cm5ldF9pZiA9IG5ldHdvcmsuV0xBTihuZXR3b3JrLlNUQV9JRik7Cm5ldF9pZi5hY3RpdmUoVHJ1ZSk7Cm5ldF9pZi5jb25uZWN0KCdXb2t3aS1HVUVTVCcsICcnKTsKd2hpbGUgbm90IG5ldF9pZi5pc2Nvbm5lY3RlZCgpOgogICAgdGltZS5zbGVlcCgwLjEpOwogICAgcHJpbnQoIi4iLCBlbmQ9IiIpOwoKbmNvZGUgPSB1YmluYXNjaWkuaGV4bGlmeShuZXRfaWYuY29uZmlnKCdtYWMnKSkuZGVjb2RlKCk7CnByaW50KCJEb25lIik7CiMjIyMjIyMjIyMjIFdJRkkgQ29ubmVjdGlvbiAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIwogICAgCgpub2RlID0gTm9kZShjb2RlPW5jb2RlLCBwYXJlbnQ9Tm9kZShjb2RlPSdhcGlzZXJ2ZXIvZXNwdGVzdC9tYXN0ZXInKSk7CgoKIyMjIyMjIyMjIyMgTVFUVCBDb25uZWN0aW9uICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCnByaW50KCdtYWluKCknLCAiQ29ubmVjdGluZyB0byBNUVRUIHNlcnZlciIsICIuLi4gIiwgZW5kPSIiKTsKbXF0dF90b3BpYyA9ICdhcGlzZXJ2ZXIvZXNwdGVzdCc7CgptcXR0X2NsaWVudCA9IHVtcXR0LnNpbXBsZS5NUVRUQ2xpZW50KG1xdHRfdG9waWMrJy8nK25vZGUuY29kZSgpLCAndGVzdC5tb3NxdWl0dG8ub3JnJywgdXNlcj0nJywgcGFzc3dvcmQ9JycpOwptcXR0X2NsaWVudC5zZXRfY2FsbGJhY2sobGFtYmRhIHRvcGljLCBtc2cgOiBFdmVudCgpLl9mcm9tRG9jdW1lbnQobXNnKS5wcm9jZXNzKCkpOwptcXR0X2NsaWVudC5jb25uZWN0KCk7CgoKbXF0dF9jbGllbnQuc3Vic2NyaWJlKG1xdHRfdG9waWMpOwpwcmludCgiQ29ubmVjdGVkISIpOwojIyMjIyMjIyMjIyBNUVRUIENvbm5lY3Rpb24gIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKCgoKIyMjIyMjIyMjIyBOT0RFIE9OTElORSAjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjCiMgZGlzYWJsZSB0aGlzIHVwZGF0ZSBpbiBFbnRpdHlSdWxlcwpub2RlLl91bmlxdWUoKS5vbmxpbmUoJ3t7bm93fX0nKS5zdG9yZSgpOwojIyMjIyMjIyMjIE5PREUgT05MSU5FICMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMKCnByaW50KCdtYWluKCknLCAnbG9vcGluZyBmb3IgbXF0dCBldmVudHMnKTsKCndoaWxlIFRydWU6CiAgICBtcXR0X2NsaWVudC53YWl0X21zZygpOwogICAgdGltZS5zbGVlcCgxKTsKCgo=",
	"__keys": ["name"],
	"__trMap": []
}